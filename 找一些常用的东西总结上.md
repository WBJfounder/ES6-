#ECMAScript 6 ç®€å•å…¥é—¨
##åŸºæœ¬ä¸€äº›è¯­æ³•
letï¼šè¿™ä¸ªå‘½ä»¤åªèƒ½ä½œç”¨äºä»£ç å—ï½›ï½ä¸­ å¤–éƒ¨è®¿é—®ä¸åˆ°
     {
            let a =10;
            var b =1;
            console.log(a)
        }
        try{
            console.log(a)
        }
        catch(e){
            throw('å¤–éƒ¨è°ƒç”¨ä¸åˆ°')
        }finally{
            console.log(b)
        }

 for:é€‚åˆlet  å°±æ˜¯æŠŠforå¾ªç¯é‡Œé¢çš„var æ¢æˆletäº†  å¾ªç¯é‡Œé¢çš„iå¤–éƒ¨è®¿é—®ä¸åˆ°
  for(let i = 0;i<10;i++){}
  console.logï¼ˆiï¼‰    
##letçš„æ³¨æ„äº‹é¡¹
1.letä¸åƒvaré‚£æ ·ä¼šå‘ç”Ÿâ€œå˜é‡æå‡â€ç°è±¡ã€‚æ‰€ä»¥ï¼Œå˜é‡ä¸€å®šè¦åœ¨å£°æ˜åä½¿ç”¨ï¼Œå¦åˆ™æŠ¥é”™ã€‚
2.letå®é™…ä¸Šä¸ºJavaScriptæ–°å¢äº†å—çº§ä½œç”¨åŸŸã€‚åªè¦å—çº§ä½œç”¨åŸŸå†…å­˜åœ¨letå‘½ä»¤ï¼Œå®ƒæ‰€å£°æ˜çš„å˜é‡å°±â€œç»‘å®šâ€ï¼ˆbindingï¼‰è¿™ä¸ªåŒºåŸŸï¼Œä¸å†å—å¤–éƒ¨çš„å½±å“ã€‚
3.letä¸å…è®¸åœ¨ç›¸åŒä½œç”¨åŸŸå†…ï¼Œé‡å¤å£°æ˜åŒä¸€ä¸ªå˜é‡ã€‚
// æŠ¥é”™
function () {
  let a = 10;
  var a = 1;
}

// æŠ¥é”™
function () {
  let a = 10;
  let a = 1;
} 

##constçš„æ³¨æ„äº‹é¡¹
1.constå£°æ˜ä¸€ä¸ªåªè¯»çš„å¸¸é‡ã€‚ä¸€æ—¦å£°æ˜ï¼Œå¸¸é‡çš„å€¼å°±ä¸èƒ½æ”¹å˜  
2.constå£°æ˜çš„å˜é‡ä¸å¾—æ”¹å˜å€¼ï¼Œè¿™æ„å‘³ç€ï¼Œconstä¸€æ—¦å£°æ˜å˜é‡ï¼Œå°±å¿…é¡»ç«‹å³åˆå§‹åŒ–ï¼Œä¸èƒ½ç•™åˆ°ä»¥åèµ‹å€¼ã€‚
3.constçš„ä½œç”¨åŸŸä¸letå‘½ä»¤ç›¸åŒï¼šåªåœ¨å£°æ˜æ‰€åœ¨çš„å—çº§ä½œç”¨åŸŸå†…æœ‰æ•ˆã€‚
4.constå‘½ä»¤å£°æ˜çš„å¸¸é‡ä¹Ÿæ˜¯ä¸æå‡ï¼ŒåŒæ ·å­˜åœ¨æš‚æ—¶æ€§æ­»åŒºï¼Œåªèƒ½åœ¨å£°æ˜çš„ä½ç½®åé¢ä½¿ç”¨ã€‚
5.constå£°æ˜çš„å¸¸é‡ï¼Œä¹Ÿä¸letä¸€æ ·ä¸å¯é‡å¤å£°æ˜ã€‚

##å˜é‡çš„è§£æ„èµ‹å€¼
1.æ•°ç»„çš„è§£æ„èµ‹å€¼
 //å¹³æ—¶ES5çš„å†™æ³•
 var a = 1;
 var b = 2;
 var c = 3;
 //ES6ä¸­æ˜¯è¿™æ ·çš„
 var [a,b,c] = [1,2,3]
//ä¹Ÿå¯ä»¥è¿™æ ·
 let [a,b,c] = [1,2,3]
æ³¨æ„ï¼šå¦‚æœå³è¾¹ä¸æ˜¯æ•°ç»„å°±ä¼šæŠ¥é”™
     è§£æ„èµ‹å€¼å…è®¸æŒ‡å®šé»˜è®¤å€¼ã€‚ 
     var [foo = true] = [];
        foo // true
[       x, y = 'b'] = ['a']; // x='a', y='b'
        [x, y = 'b'] = ['a', undefined]; // x='a', y='b'
æ³¨æ„ï¼ŒES6å†…éƒ¨ä½¿ç”¨ä¸¥æ ¼ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ===ï¼‰ï¼Œåˆ¤æ–­ä¸€ä¸ªä½ç½®æ˜¯å¦æœ‰å€¼ã€‚
æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„æˆå‘˜ä¸ä¸¥æ ¼ç­‰äºundefinedï¼Œé»˜è®¤å€¼æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚
var [x = 1] = [undefined];
x // 1
var [x = 1] = [null];
x // null  

2.å¯¹è±¡çš„è§£æ„èµ‹å€¼
è§£æ„ä¸ä»…å¯ä»¥ç”¨äºæ•°ç»„ï¼Œè¿˜å¯ä»¥ç”¨äºå¯¹è±¡ã€‚
var { foo, bar } = { foo: "aaa", bar: "bbb" };
foo // "aaa"
bar // "bbb"
å¯¹è±¡çš„è§£æ„ä¸æ•°ç»„æœ‰ä¸€ä¸ªé‡è¦çš„ä¸åŒã€‚
æ•°ç»„çš„å…ƒç´ æ˜¯æŒ‰æ¬¡åºæ’åˆ—çš„ï¼Œå˜é‡çš„å–å€¼ç”±å®ƒçš„ä½ç½®å†³å®šï¼›
è€Œå¯¹è±¡çš„å±æ€§æ²¡æœ‰æ¬¡åºï¼Œå˜é‡å¿…é¡»ä¸å±æ€§åŒåï¼Œæ‰èƒ½å–åˆ°æ­£ç¡®çš„å€¼ã€‚
var { bar, foo } = { foo: "aaa", bar: "bbb" };
foo // "aaa"
bar // "bbb"
var { baz } = { foo: "aaa", bar: "bbb" };
baz // undefined  
æ„ï¼Œé‡‡ç”¨è¿™ç§å†™æ³•æ—¶ï¼Œå˜é‡çš„å£°æ˜å’Œèµ‹å€¼æ˜¯ä¸€ä½“çš„ã€‚
å¯¹äºletå’Œconstæ¥è¯´ï¼Œå˜é‡ä¸èƒ½é‡æ–°å£°æ˜ï¼Œæ‰€ä»¥ä¸€æ—¦èµ‹å€¼çš„å˜é‡ä»¥å‰å£°æ˜è¿‡ï¼Œå°±ä¼šæŠ¥é”™ã€‚
let foo;
let {foo} = {foo: 1}; // SyntaxError: Duplicate declaration "foo"
let baz;
let {bar: baz} = {bar: 1}; // SyntaxError: Duplicate declaration "baz"    
ä¸Šé¢ä»£ç ä¸­ï¼Œè§£æ„èµ‹å€¼çš„å˜é‡éƒ½ä¼šé‡æ–°å£°æ˜ï¼Œæ‰€ä»¥æŠ¥é”™äº†ã€‚
ä¸è¿‡ï¼Œå› ä¸ºvarå‘½ä»¤å…è®¸é‡æ–°å£°æ˜ï¼Œæ‰€ä»¥è¿™ä¸ªé”™è¯¯åªä¼šåœ¨ä½¿ç”¨letå’Œconstå‘½ä»¤æ—¶å‡ºç°ã€‚
å¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ªletå‘½ä»¤ï¼Œä¸Šé¢çš„ä»£ç å°±ä¸ä¼šæŠ¥é”™ã€‚
let foo;
({foo} = {foo: 1}); // æˆåŠŸ
let baz;
({bar: baz} = {bar: 1}); // æˆåŠŸ
ä¸Šé¢ä»£ç ä¸­ï¼Œletå‘½ä»¤ä¸‹é¢ä¸€è¡Œçš„åœ†æ‹¬å·æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
å› ä¸ºè§£æå™¨ä¼šå°†èµ·é¦–çš„å¤§æ‹¬å·ï¼Œç†è§£æˆä¸€ä¸ªä»£ç å—ï¼Œè€Œä¸æ˜¯èµ‹å€¼è¯­å¥ã€‚

3.å­—ç¬¦ä¸²çš„è§£æ„èµ‹å€¼
å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥è§£æ„èµ‹å€¼ã€‚è¿™æ˜¯å› ä¸ºæ­¤æ—¶ï¼Œå­—ç¬¦ä¸²è¢«è½¬æ¢æˆäº†ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚
const [a, b, c, d, e] = 'hello';
a // "h"
b // "e"
c // "l"
d // "l"
e // "o"
ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªlengthå±æ€§ï¼Œå› æ­¤è¿˜å¯ä»¥å¯¹è¿™ä¸ªå±æ€§è§£æ„èµ‹å€¼ã€‚
let {length : len} = 'hello';
len // 5

4.æ•°å€¼å’Œå¸ƒå°”å€¼çš„è§£æ„èµ‹å€¼
è§£æ„èµ‹å€¼æ—¶ï¼Œå¦‚æœç­‰å·å³è¾¹æ˜¯æ•°å€¼å’Œå¸ƒå°”å€¼ï¼Œåˆ™ä¼šå…ˆè½¬ä¸ºå¯¹è±¡ã€‚
let {toString: s} = 123;
s === Number.prototype.toString // true
let {toString: s} = true;
s === Boolean.prototype.toString // true
è§£æ„èµ‹å€¼çš„è§„åˆ™æ˜¯ï¼Œåªè¦ç­‰å·å³è¾¹çš„å€¼ä¸æ˜¯å¯¹è±¡ï¼Œå°±å…ˆå°†å…¶è½¬ä¸ºå¯¹è±¡ã€‚
ç”±äºundefinedå’Œnullæ— æ³•è½¬ä¸ºå¯¹è±¡ï¼Œæ‰€ä»¥å¯¹å®ƒä»¬è¿›è¡Œè§£æ„èµ‹å€¼ï¼Œéƒ½ä¼šæŠ¥é”™ã€‚
let { prop: x } = undefined; // TypeError
let { prop: y } = null; // TypeError

5.å‡½æ•°å‚æ•°çš„è§£æ„èµ‹å€¼
å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨è§£æ„èµ‹å€¼ã€‚
function add([x, y]){
  return x + y;
}
add([1, 2]); // 3

##å­—ç¬¦ä¸²çš„å¸¸ç”¨æ‰©å±•
1ä¼ ç»Ÿä¸Šï¼ŒJavaScriptåªæœ‰indexOfæ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥ç¡®å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦åŒ…å«åœ¨å¦ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ã€‚
 ES6åˆæä¾›äº†ä¸‰ç§æ–°æ–¹æ³•ã€‚
 includes()ï¼šè¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æ‰¾åˆ°äº†å‚æ•°å­—ç¬¦ä¸²ã€‚
 startsWith()ï¼šè¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦åœ¨æºå­—ç¬¦ä¸²çš„å¤´éƒ¨ã€‚
 endsWith()ï¼šè¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦åœ¨æºå­—ç¬¦ä¸²çš„å°¾éƒ¨ã€‚
 var s = 'Hello world!';
 s.startsWith('Hello') // true
 s.endsWith('!') // true
 s.includes('o') // true
 è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ”¯æŒç¬¬äºŒä¸ªå‚æ•°ï¼Œè¡¨ç¤ºå¼€å§‹æœç´¢çš„ä½ç½®ã€‚
 var s = 'Hello world!';
 s.startsWith('world', 6) // true
 s.endsWith('Hello', 5) // true
 s.includes('Hello', 6) // false
 ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°næ—¶ï¼ŒendsWithçš„è¡Œä¸ºä¸å…¶ä»–ä¸¤ä¸ªæ–¹æ³•æœ‰æ‰€ä¸åŒã€‚
 å®ƒé’ˆå¯¹å‰nä¸ªå­—ç¬¦ï¼Œè€Œå…¶ä»–ä¸¤ä¸ªæ–¹æ³•é’ˆå¯¹ä»ç¬¬nä¸ªä½ç½®ç›´åˆ°å­—ç¬¦ä¸²ç»“æŸã€‚

##æ­£åˆ™çš„æ‰©å±•
 1.RegExpæ„é€ å‡½æ•°
 åœ¨ES5ä¸­ï¼ŒRegExpæ„é€ å‡½æ•°çš„å‚æ•°æœ‰ä¸¤ç§æƒ…å†µã€‚

ç¬¬ä¸€ç§æƒ…å†µæ˜¯ï¼Œå‚æ•°æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™æ—¶ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ­£åˆ™è¡¨è¾¾å¼çš„ä¿®é¥°ç¬¦ï¼ˆflagï¼‰ã€‚
var regex = new RegExp('xyz', 'i');
// ç­‰ä»·äº
var regex = /xyz/i;

ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨ç¤ºå¼ï¼Œè¿™æ—¶ä¼šè¿”å›ä¸€ä¸ªåŸæœ‰æ­£åˆ™è¡¨è¾¾å¼çš„æ‹·è´ã€‚
var regex = new RegExp(/xyz/i);
// ç­‰ä»·äº
var regex = /xyz/i;

ä½†æ˜¯ï¼ŒES5ä¸å…è®¸æ­¤æ—¶ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ·»åŠ ä¿®é¥°ç¬¦ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
var regex = new RegExp(/xyz/, 'i');
// Uncaught TypeError: Cannot supply flags when constructing one RegExp from another

ES6æ”¹å˜äº†è¿™ç§è¡Œä¸ºã€‚å¦‚æœRegExpæ„é€ å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ­£åˆ™å¯¹è±¡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¿®é¥°ç¬¦ã€‚
è€Œä¸”ï¼Œè¿”å›çš„æ­£åˆ™è¡¨è¾¾å¼ä¼šå¿½ç•¥åŸæœ‰çš„æ­£åˆ™è¡¨è¾¾å¼çš„ä¿®é¥°ç¬¦ï¼Œåªä½¿ç”¨æ–°æŒ‡å®šçš„ä¿®é¥°ç¬¦ã€‚
new RegExp(/abc/ig, 'i').flags
// "i"

2.å­—ç¬¦ä¸²çš„æ­£åˆ™æ–¹æ³•
å­—ç¬¦ä¸²å¯¹è±¡å…±æœ‰4ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼šmatch()ã€replace()ã€search()å’Œsplit()ã€‚
ES6å°†è¿™4ä¸ªæ–¹æ³•ï¼Œåœ¨è¯­è¨€å†…éƒ¨å…¨éƒ¨è°ƒç”¨RegExpçš„å®ä¾‹æ–¹æ³•ï¼Œä»è€Œåšåˆ°æ‰€æœ‰ä¸æ­£åˆ™ç›¸å…³çš„æ–¹æ³•ï¼Œå…¨éƒ½å®šä¹‰åœ¨RegExpå¯¹è±¡ä¸Šã€‚

String.prototype.match è°ƒç”¨ RegExp.prototype[Symbol.match]
String.prototype.replace è°ƒç”¨ RegExp.prototype[Symbol.replace]
String.prototype.search è°ƒç”¨ RegExp.prototype[Symbol.search]
String.prototype.split è°ƒç”¨ RegExp.prototype[Symbol.split]

3.uä¿®é¥°ç¬¦
ES6å¯¹æ­£åˆ™è¡¨è¾¾å¼æ·»åŠ äº†uä¿®é¥°ç¬¦ï¼Œå«ä¹‰ä¸ºâ€œUnicodeæ¨¡å¼â€ï¼Œç”¨æ¥æ­£ç¡®å¤„ç†å¤§äº\uFFFFçš„Unicodeå­—ç¬¦ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šæ­£ç¡®å¤„ç†å››ä¸ªå­—èŠ‚çš„UTF-16ç¼–ç ã€‚
/^\uD83D/u.test('\uD83D\uDC2A')
// false
/^\uD83D/.test('\uD83D\uDC2A')
// true
ä¸Šé¢ä»£ç ä¸­ï¼Œ\uD83D\uDC2Aæ˜¯ä¸€ä¸ªå››ä¸ªå­—èŠ‚çš„UTF-16ç¼–ç ï¼Œä»£è¡¨ä¸€ä¸ªå­—ç¬¦ã€‚ä½†æ˜¯ï¼ŒES5ä¸æ”¯æŒå››ä¸ªå­—èŠ‚çš„UTF-16ç¼–ç ï¼Œä¼šå°†å…¶è¯†åˆ«ä¸ºä¸¤ä¸ªå­—ç¬¦ï¼Œå¯¼è‡´ç¬¬äºŒè¡Œä»£ç ç»“æœä¸ºtrueã€‚
åŠ äº†uä¿®é¥°ç¬¦ä»¥åï¼ŒES6å°±ä¼šè¯†åˆ«å…¶ä¸ºä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œä»£ç ç»“æœä¸ºfalseã€‚

ï¼ˆ1ï¼‰ç‚¹å­—ç¬¦

ç‚¹ï¼ˆ.ï¼‰å­—ç¬¦åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œå«ä¹‰æ˜¯é™¤äº†æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å•ä¸ªå­—ç¬¦ã€‚å¯¹äºç ç‚¹å¤§äº0xFFFFçš„Unicodeå­—ç¬¦ï¼Œç‚¹å­—ç¬¦ä¸èƒ½è¯†åˆ«ï¼Œå¿…é¡»åŠ ä¸Šuä¿®é¥°ç¬¦ã€‚

var s = 'ğ ®·';

/^.$/.test(s) // false
/^.$/u.test(s) // true
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œå¦‚æœä¸æ·»åŠ uä¿®é¥°ç¬¦ï¼Œæ­£åˆ™è¡¨è¾¾å¼å°±ä¼šè®¤ä¸ºå­—ç¬¦ä¸²ä¸ºä¸¤ä¸ªå­—ç¬¦ï¼Œä»è€ŒåŒ¹é…å¤±è´¥ã€‚

ï¼ˆ2ï¼‰Unicodeå­—ç¬¦è¡¨ç¤ºæ³•

ES6æ–°å¢äº†ä½¿ç”¨å¤§æ‹¬å·è¡¨ç¤ºUnicodeå­—ç¬¦ï¼Œè¿™ç§è¡¨ç¤ºæ³•åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­å¿…é¡»åŠ ä¸Šuä¿®é¥°ç¬¦ï¼Œæ‰èƒ½è¯†åˆ«ã€‚

/\u{61}/.test('a') // false
/\u{61}/u.test('a') // true
/\u{20BB7}/u.test('ğ ®·') // true
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œå¦‚æœä¸åŠ uä¿®é¥°ç¬¦ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ— æ³•è¯†åˆ«\u{61}è¿™ç§è¡¨ç¤ºæ³•ï¼Œåªä¼šè®¤ä¸ºè¿™åŒ¹é…61ä¸ªè¿ç»­çš„uã€‚

ï¼ˆ3ï¼‰é‡è¯

ä½¿ç”¨uä¿®é¥°ç¬¦åï¼Œæ‰€æœ‰é‡è¯éƒ½ä¼šæ­£ç¡®è¯†åˆ«ç ç‚¹å¤§äº0xFFFFçš„Unicodeå­—ç¬¦ã€‚

/a{2}/.test('aa') // true
/a{2}/u.test('aa') // true
/ğ ®·{2}/.test('ğ ®·ğ ®·') // false
/ğ ®·{2}/u.test('ğ ®·ğ ®·') // true
å¦å¤–ï¼Œåªæœ‰åœ¨ä½¿ç”¨uä¿®é¥°ç¬¦çš„æƒ…å†µä¸‹ï¼ŒUnicodeè¡¨è¾¾å¼å½“ä¸­çš„å¤§æ‹¬å·æ‰ä¼šè¢«æ­£ç¡®è§£è¯»ï¼Œå¦åˆ™ä¼šè¢«è§£è¯»ä¸ºé‡è¯ã€‚

/^\u{3}$/.test('uuu') // true
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºæ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰uä¿®é¥°ç¬¦ï¼Œæ‰€ä»¥å¤§æ‹¬å·è¢«è§£è¯»ä¸ºé‡è¯ã€‚åŠ ä¸Šuä¿®é¥°ç¬¦ï¼Œå°±ä¼šè¢«è§£è¯»ä¸ºUnicodeè¡¨è¾¾å¼ã€‚

ï¼ˆ4ï¼‰é¢„å®šä¹‰æ¨¡å¼

uä¿®é¥°ç¬¦ä¹Ÿå½±å“åˆ°é¢„å®šä¹‰æ¨¡å¼ï¼Œèƒ½å¦æ­£ç¡®è¯†åˆ«ç ç‚¹å¤§äº0xFFFFçš„Unicodeå­—ç¬¦ã€‚

/^\S$/.test('ğ ®·') // false
/^\S$/u.test('ğ ®·') // true
ä¸Šé¢ä»£ç çš„\Sæ˜¯é¢„å®šä¹‰æ¨¡å¼ï¼ŒåŒ¹é…æ‰€æœ‰ä¸æ˜¯ç©ºæ ¼çš„å­—ç¬¦ã€‚åªæœ‰åŠ äº†uä¿®é¥°ç¬¦ï¼Œå®ƒæ‰èƒ½æ­£ç¡®åŒ¹é…ç ç‚¹å¤§äº0xFFFFçš„Unicodeå­—ç¬¦ã€‚

åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥å†™å‡ºä¸€ä¸ªæ­£ç¡®è¿”å›å­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•°ã€‚

function codePointLength(text) {
  var result = text.match(/[\s\S]/gu);
  return result ? result.length : 0;
}

var s = 'ğ ®·ğ ®·';

s.length // 4
codePointLength(s) // 2
ï¼ˆ5ï¼‰iä¿®é¥°ç¬¦

æœ‰äº›Unicodeå­—ç¬¦çš„ç¼–ç ä¸åŒï¼Œä½†æ˜¯å­—å‹å¾ˆç›¸è¿‘ï¼Œæ¯”å¦‚ï¼Œ\u004Bä¸\u212Aéƒ½æ˜¯å¤§å†™çš„Kã€‚

/[a-z]/i.test('\u212A') // false
/[a-z]/iu.test('\u212A') // true
ä¸Šé¢ä»£ç ä¸­ï¼Œä¸åŠ uä¿®é¥°ç¬¦ï¼Œå°±æ— æ³•è¯†åˆ«éè§„èŒƒçš„Kå­—ç¬¦ã€‚

4.y ä¿®é¥°ç¬¦
é™¤äº†uä¿®é¥°ç¬¦ï¼ŒES6è¿˜ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ·»åŠ äº†yä¿®é¥°ç¬¦ï¼Œå«åšâ€œç²˜è¿â€ï¼ˆstickyï¼‰ä¿®é¥°ç¬¦ã€‚

yä¿®é¥°ç¬¦çš„ä½œç”¨ä¸gä¿®é¥°ç¬¦ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å…¨å±€åŒ¹é…ï¼Œåä¸€æ¬¡åŒ¹é…éƒ½ä»ä¸Šä¸€æ¬¡åŒ¹é…æˆåŠŸçš„ä¸‹ä¸€ä¸ªä½ç½®å¼€å§‹ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œgä¿®é¥°ç¬¦åªè¦å‰©ä½™ä½ç½®ä¸­å­˜åœ¨åŒ¹é…å°±å¯ï¼Œè€Œyä¿®é¥°ç¬¦ç¡®ä¿åŒ¹é…å¿…é¡»ä»å‰©ä½™çš„ç¬¬ä¸€ä¸ªä½ç½®å¼€å§‹ï¼Œè¿™ä¹Ÿå°±æ˜¯â€œç²˜è¿â€çš„æ¶µä¹‰ã€‚

var s = 'aaa_aa_a';
var r1 = /a+/g;
var r2 = /a+/y;

r1.exec(s) // ["aaa"]
r2.exec(s) // ["aaa"]

r1.exec(s) // ["aa"]
r2.exec(s) // null
ä¸Šé¢ä»£ç æœ‰ä¸¤ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸€ä¸ªä½¿ç”¨gä¿®é¥°ç¬¦ï¼Œå¦ä¸€ä¸ªä½¿ç”¨yä¿®é¥°ç¬¦ã€‚è¿™ä¸¤ä¸ªæ­£åˆ™è¡¨è¾¾å¼å„æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸¤è€…è¡Œä¸ºç›¸åŒï¼Œå‰©ä½™å­—ç¬¦ä¸²éƒ½æ˜¯_aa_aã€‚ç”±äºgä¿®é¥°æ²¡æœ‰ä½ç½®è¦æ±‚ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡æ‰§è¡Œä¼šè¿”å›ç»“æœï¼Œè€Œyä¿®é¥°ç¬¦è¦æ±‚åŒ¹é…å¿…é¡»ä»å¤´éƒ¨å¼€å§‹ï¼Œæ‰€ä»¥è¿”å›nullã€‚

å¦‚æœæ”¹ä¸€ä¸‹æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¿è¯æ¯æ¬¡éƒ½èƒ½å¤´éƒ¨åŒ¹é…ï¼Œyä¿®é¥°ç¬¦å°±ä¼šè¿”å›ç»“æœäº†ã€‚

var s = 'aaa_aa_a';
var r = /a+_/y;

r.exec(s) // ["aaa_"]
r.exec(s) // ["aa_"]
ä¸Šé¢ä»£ç æ¯æ¬¡åŒ¹é…ï¼Œéƒ½æ˜¯ä»å‰©ä½™å­—ç¬¦ä¸²çš„å¤´éƒ¨å¼€å§‹ã€‚

ä½¿ç”¨lastIndexå±æ€§ï¼Œå¯ä»¥æ›´å¥½åœ°è¯´æ˜yä¿®é¥°ç¬¦ã€‚

const REGEX = /a/g;

// æŒ‡å®šä»2å·ä½ç½®ï¼ˆyï¼‰å¼€å§‹åŒ¹é…
REGEX.lastIndex = 2;

// åŒ¹é…æˆåŠŸ
const match = REGEX.exec('xaya');

// åœ¨3å·ä½ç½®åŒ¹é…æˆåŠŸ
match.index // 3

// ä¸‹ä¸€æ¬¡åŒ¹é…ä»4å·ä½å¼€å§‹
REGEX.lastIndex // 4

// 4å·ä½å¼€å§‹åŒ¹é…å¤±è´¥
REGEX.exec('xaxa') // null
ä¸Šé¢ä»£ç ä¸­ï¼ŒlastIndexå±æ€§æŒ‡å®šæ¯æ¬¡æœç´¢çš„å¼€å§‹ä½ç½®ï¼Œgä¿®é¥°ç¬¦ä»è¿™ä¸ªä½ç½®å¼€å§‹å‘åæœç´¢ï¼Œç›´åˆ°å‘ç°åŒ¹é…ä¸ºæ­¢ã€‚

yä¿®é¥°ç¬¦åŒæ ·éµå®ˆlastIndexå±æ€§ï¼Œä½†æ˜¯è¦æ±‚å¿…é¡»åœ¨lastIndexæŒ‡å®šçš„ä½ç½®å‘ç°åŒ¹é…ã€‚

const REGEX = /a/y;

// æŒ‡å®šä»2å·ä½ç½®å¼€å§‹åŒ¹é…
REGEX.lastIndex = 2;

// ä¸æ˜¯ç²˜è¿ï¼ŒåŒ¹é…å¤±è´¥
REGEX.exec('xaya') // null

// æŒ‡å®šä»3å·ä½ç½®å¼€å§‹åŒ¹é…
REGEX.lastIndex = 3;

// 3å·ä½ç½®æ˜¯ç²˜è¿ï¼ŒåŒ¹é…æˆåŠŸ
const match = REGEX.exec('xaxa');
match.index // 3
REGEX.lastIndex // 4
è¿›ä¸€æ­¥è¯´ï¼Œyä¿®é¥°ç¬¦å·éšå«äº†å¤´éƒ¨åŒ¹é…çš„æ ‡å¿—^ã€‚

/b/y.exec('aba')
// null
ä¸Šé¢ä»£ç ç”±äºä¸èƒ½ä¿è¯å¤´éƒ¨åŒ¹é…ï¼Œæ‰€ä»¥è¿”å›nullã€‚yä¿®é¥°ç¬¦çš„è®¾è®¡æœ¬æ„ï¼Œå°±æ˜¯è®©å¤´éƒ¨åŒ¹é…çš„æ ‡å¿—^åœ¨å…¨å±€åŒ¹é…ä¸­éƒ½æœ‰æ•ˆã€‚

åœ¨splitæ–¹æ³•ä¸­ä½¿ç”¨yä¿®é¥°ç¬¦ï¼ŒåŸå­—ç¬¦ä¸²å¿…é¡»ä»¥åˆ†éš”ç¬¦å¼€å¤´ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œåªè¦åŒ¹é…æˆåŠŸï¼Œæ•°ç»„çš„ç¬¬ä¸€ä¸ªæˆå‘˜è‚¯å®šæ˜¯ç©ºå­—ç¬¦ä¸²ã€‚

// æ²¡æœ‰æ‰¾åˆ°åŒ¹é…
'x##'.split(/#/y)
// [ 'x##' ]

// æ‰¾åˆ°ä¸¤ä¸ªåŒ¹é…
'##x'.split(/#/y)
// [ '', '', 'x' ]
åç»­çš„åˆ†éš”ç¬¦åªæœ‰ç´§è·Ÿå‰é¢çš„åˆ†éš”ç¬¦ï¼Œæ‰ä¼šè¢«è¯†åˆ«ã€‚

'#x#'.split(/#/y)
// [ '', 'x#' ]

'##'.split(/#/y)
// [ '', '', '' ]
ä¸‹é¢æ˜¯å­—ç¬¦ä¸²å¯¹è±¡çš„replaceæ–¹æ³•çš„ä¾‹å­ã€‚

const REGEX = /a/gy;
'aaxa'.replace(REGEX, '-') // '--xa'
ä¸Šé¢ä»£ç ä¸­ï¼Œæœ€åä¸€ä¸ªaå› ä¸ºä¸æ˜¯å‡ºç°ä¸‹ä¸€æ¬¡åŒ¹é…çš„å¤´éƒ¨ï¼Œæ‰€ä»¥ä¸ä¼šè¢«æ›¿æ¢ã€‚

å•å•ä¸€ä¸ªyä¿®é¥°ç¬¦å¯¹matchæ–¹æ³•ï¼Œåªèƒ½è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…ï¼Œå¿…é¡»ä¸gä¿®é¥°ç¬¦è”ç”¨ï¼Œæ‰èƒ½è¿”å›æ‰€æœ‰åŒ¹é…ã€‚

'a1a2a3'.match(/a\d/y) // ["a1"]
'a1a2a3'.match(/a\d/gy) // ["a1", "a2", "a3"]
yä¿®é¥°ç¬¦çš„ä¸€ä¸ªåº”ç”¨ï¼Œæ˜¯ä»å­—ç¬¦ä¸²æå–tokenï¼ˆè¯å…ƒï¼‰ï¼Œyä¿®é¥°ç¬¦ç¡®ä¿äº†åŒ¹é…ä¹‹é—´ä¸ä¼šæœ‰æ¼æ‰çš„å­—ç¬¦ã€‚

const TOKEN_Y = /\s*(\+|[0-9]+)\s*/y;
const TOKEN_G  = /\s*(\+|[0-9]+)\s*/g;

tokenize(TOKEN_Y, '3 + 4')
// [ '3', '+', '4' ]
tokenize(TOKEN_G, '3 + 4')
// [ '3', '+', '4' ]

function tokenize(TOKEN_REGEX, str) {
  let result = [];
  let match;
  while (match = TOKEN_REGEX.exec(str)) {
    result.push(match[1]);
  }
  return result;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœå­—ç¬¦ä¸²é‡Œé¢æ²¡æœ‰éæ³•å­—ç¬¦ï¼Œyä¿®é¥°ç¬¦ä¸gä¿®é¥°ç¬¦çš„æå–ç»“æœæ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦å‡ºç°éæ³•å­—ç¬¦ï¼Œä¸¤è€…çš„è¡Œä¸ºå°±ä¸ä¸€æ ·äº†ã€‚

tokenize(TOKEN_Y, '3x + 4')
// [ '3' ]
tokenize(TOKEN_G, '3x + 4')
// [ '3', '+', '4' ]
ä¸Šé¢ä»£ç ä¸­ï¼Œgä¿®é¥°ç¬¦ä¼šå¿½ç•¥éæ³•å­—ç¬¦ï¼Œè€Œyä¿®é¥°ç¬¦ä¸ä¼šï¼Œè¿™æ ·å°±å¾ˆå®¹æ˜“å‘ç°é”™è¯¯ã€‚

5.stickyå±æ€§
ä¸yä¿®é¥°ç¬¦ç›¸åŒ¹é…ï¼ŒES6çš„æ­£åˆ™å¯¹è±¡å¤šäº†stickyå±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦è®¾ç½®äº†yä¿®é¥°ç¬¦ã€‚

var r = /hello\d/y;
r.sticky // true
flagså±æ€§
ES6ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ–°å¢äº†flagså±æ€§ï¼Œä¼šè¿”å›æ­£åˆ™è¡¨è¾¾å¼çš„ä¿®é¥°ç¬¦ã€‚

// ES5çš„sourceå±æ€§
// è¿”å›æ­£åˆ™è¡¨è¾¾å¼çš„æ­£æ–‡
/abc/ig.source
// "abc"

// ES6çš„flagså±æ€§
// è¿”å›æ­£åˆ™è¡¨è¾¾å¼çš„ä¿®é¥°ç¬¦
/abc/ig.flags
// 'gi'
RegExp.escape()
å­—ç¬¦ä¸²å¿…é¡»è½¬ä¹‰ï¼Œæ‰èƒ½ä½œä¸ºæ­£åˆ™æ¨¡å¼ã€‚

function escapeRegExp(str) {
  return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, '\\$&');
}

let str = '/path/to/resource.html?search=query';
escapeRegExp(str)
// "\/path\/to\/resource\.html\?search=query"
ä¸Šé¢ä»£ç ä¸­ï¼Œstræ˜¯ä¸€ä¸ªæ­£å¸¸å­—ç¬¦ä¸²ï¼Œå¿…é¡»ä½¿ç”¨åæ–œæ å¯¹å…¶ä¸­çš„ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ï¼Œæ‰èƒ½ç”¨æ¥ä½œä¸ºä¸€ä¸ªæ­£åˆ™åŒ¹é…çš„æ¨¡å¼ã€‚

å·²ç»æœ‰æè®®å°†è¿™ä¸ªéœ€æ±‚æ ‡å‡†åŒ–ï¼Œä½œä¸ºRegExpå¯¹è±¡çš„é™æ€æ–¹æ³•RegExp.escape()ï¼Œæ”¾å…¥ES7ã€‚2015å¹´7æœˆ31æ—¥ï¼ŒTC39è®¤ä¸ºï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å®‰å…¨é£é™©ï¼Œåˆä¸æ„¿è¿™ä¸ªæ–¹æ³•å˜å¾—è¿‡äºå¤æ‚ï¼Œæ²¡æœ‰åŒæ„å°†å…¶åˆ—å…¥ES7ï¼Œä½†è¿™ä¸å¤±ä¸ºä¸€ä¸ªçœŸå®çš„éœ€æ±‚ã€‚

RegExp.escape('The Quick Brown Fox');
// "The Quick Brown Fox"

RegExp.escape('Buy it. use it. break it. fix it.');
// "Buy it\. use it\. break it\. fix it\."

RegExp.escape('(*.*)');
// "\(\*\.\*\)"
å­—ç¬¦ä¸²è½¬ä¹‰ä»¥åï¼Œå¯ä»¥ä½¿ç”¨RegExpæ„é€ å‡½æ•°ç”Ÿæˆæ­£åˆ™æ¨¡å¼ã€‚

var str = 'hello. how are you?';
var regex = new RegExp(RegExp.escape(str), 'g');
assert.equal(String(regex), '/hello\. how are you\?/g');
ç›®å‰ï¼Œè¯¥æ–¹æ³•å¯ä»¥ç”¨ä¸Šæ–‡çš„escapeRegExpå‡½æ•°æˆ–è€…å«ç‰‡æ¨¡å—regexp.escapeå®ç°ã€‚

var escape = require('regexp.escape');
escape('hi. how are you?');
// "hi\\. how are you\\?"
s ä¿®é¥°ç¬¦ï¼šdotAll æ¨¡å¼
æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œç‚¹ï¼ˆ.ï¼‰æ˜¯ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œä»£è¡¨ä»»æ„çš„å•ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯è¡Œç»ˆæ­¢ç¬¦ï¼ˆline terminator characterï¼‰é™¤å¤–ã€‚

ä»¥ä¸‹å››ä¸ªå­—ç¬¦å±äºâ€è¡Œç»ˆæ­¢ç¬¦â€œã€‚

U+000A æ¢è¡Œç¬¦ï¼ˆ\nï¼‰
U+000D å›è½¦ç¬¦ï¼ˆ\rï¼‰
U+2028 è¡Œåˆ†éš”ç¬¦ï¼ˆline separatorï¼‰
U+2029 æ®µåˆ†éš”ç¬¦ï¼ˆparagraph separatorï¼‰
/foo.bar/.test('foo\nbar')
// false
ä¸Šé¢ä»£ç ä¸­ï¼Œå› ä¸º.ä¸åŒ¹é…\nï¼Œæ‰€ä»¥æ­£åˆ™è¡¨è¾¾å¼è¿”å›falseã€‚

ä½†æ˜¯ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›åŒ¹é…çš„æ˜¯ä»»æ„å•ä¸ªå­—ç¬¦ï¼Œè¿™æ—¶æœ‰ä¸€ç§å˜é€šçš„å†™æ³•ã€‚

/foo[^]bar/.test('foo\nbar')
// true
è¿™ç§è§£å†³æ–¹æ¡ˆæ¯•ç«Ÿä¸å¤ªç¬¦åˆç›´è§‰ï¼Œæ‰€ä»¥ç°åœ¨æœ‰ä¸€ä¸ªææ¡ˆï¼Œå¼•å…¥/sä¿®é¥°ç¬¦ï¼Œä½¿å¾—.å¯ä»¥åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦ã€‚

/foo.bar/s.test('foo\nbar') // true
è¿™è¢«ç§°ä¸ºdotAllæ¨¡å¼ï¼Œå³ç‚¹ï¼ˆdotï¼‰ä»£è¡¨ä¸€åˆ‡å­—ç¬¦ã€‚æ‰€ä»¥ï¼Œæ­£åˆ™è¡¨è¾¾å¼è¿˜å¼•å…¥äº†ä¸€ä¸ªdotAllå±æ€§ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥æ­£åˆ™è¡¨è¾¾å¼æ˜¯å¦å¤„åœ¨dotAllæ¨¡å¼ã€‚

const re = /foo.bar/s;
// å¦ä¸€ç§å†™æ³•
// const re = new RegExp('foo.bar', 's');

re.test('foo\nbar') // true
re.dotAll // true
re.flags // 's'
/sä¿®é¥°ç¬¦å’Œå¤šè¡Œä¿®é¥°ç¬¦/mä¸å†²çªï¼Œä¸¤è€…ä¸€èµ·ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œ.åŒ¹é…æ‰€æœ‰å­—ç¬¦ï¼Œè€Œ^å’Œ$åŒ¹é…æ¯ä¸€è¡Œçš„è¡Œé¦–å’Œè¡Œå°¾ã€‚

åè¡Œæ–­è¨€
JavaScriptè¯­è¨€çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œåªæ”¯æŒå…ˆè¡Œæ–­è¨€ï¼ˆlookaheadï¼‰å’Œå…ˆè¡Œå¦å®šæ–­è¨€ï¼ˆnegative lookaheadï¼‰ï¼Œä¸æ”¯æŒåè¡Œæ–­è¨€ï¼ˆlookbehindï¼‰å’Œåè¡Œå¦å®šæ–­è¨€ï¼ˆnegative lookbehindï¼‰ã€‚

ç›®å‰ï¼Œæœ‰ä¸€ä¸ªææ¡ˆï¼Œåœ¨ES7åŠ å…¥åè¡Œæ–­è¨€ã€‚V8å¼•æ“4.9ç‰ˆå·²ç»æ”¯æŒï¼ŒChromeæµè§ˆå™¨49ç‰ˆæ‰“å¼€â€experimental JavaScript featuresâ€œå¼€å…³ï¼ˆåœ°å€æ é”®å…¥about:flagsï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™é¡¹åŠŸèƒ½ã€‚

â€å…ˆè¡Œæ–­è¨€â€œæŒ‡çš„æ˜¯ï¼Œxåªæœ‰åœ¨yå‰é¢æ‰åŒ¹é…ï¼Œå¿…é¡»å†™æˆ/x(?=y)/ã€‚æ¯”å¦‚ï¼ŒåªåŒ¹é…ç™¾åˆ†å·ä¹‹å‰çš„æ•°å­—ï¼Œè¦å†™æˆ/\d+(?=%)/ã€‚â€å…ˆè¡Œå¦å®šæ–­è¨€â€œæŒ‡çš„æ˜¯ï¼Œxåªæœ‰ä¸åœ¨yå‰é¢æ‰åŒ¹é…ï¼Œå¿…é¡»å†™æˆ/x(?!y)/ã€‚æ¯”å¦‚ï¼ŒåªåŒ¹é…ä¸åœ¨ç™¾åˆ†å·ä¹‹å‰çš„æ•°å­—ï¼Œè¦å†™æˆ/\d+(?!%)/ã€‚

/\d+(?=%)/.exec('100% of US presidents have been male')  // ["100"]
/\d+(?!%)/.exec('thatâ€™s all 44 of them')                 // ["44"]
ä¸Šé¢ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æœäº’æ¢æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°±ä¼šåŒ¹é…å¤±è´¥ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ï¼Œâ€å…ˆè¡Œæ–­è¨€â€œæ‹¬å·ä¹‹ä¸­çš„éƒ¨åˆ†ï¼ˆ(?=%)ï¼‰ï¼Œæ˜¯ä¸è®¡å…¥è¿”å›ç»“æœçš„ã€‚

"åè¡Œæ–­è¨€"æ­£å¥½ä¸"å…ˆè¡Œæ–­è¨€"ç›¸åï¼Œxåªæœ‰åœ¨yåé¢æ‰åŒ¹é…ï¼Œå¿…é¡»å†™æˆ/(?<=y)x/ã€‚æ¯”å¦‚ï¼ŒåªåŒ¹é…ç¾å…ƒç¬¦å·ä¹‹åçš„æ•°å­—ï¼Œè¦å†™æˆ/(?<=\$)\d+/ã€‚â€åè¡Œå¦å®šæ–­è¨€â€œåˆ™ä¸â€å…ˆè¡Œå¦å®šæ–­è¨€â€œç›¸åï¼Œxåªæœ‰ä¸åœ¨yåé¢æ‰åŒ¹é…ï¼Œå¿…é¡»å†™æˆ/(?<!y)x/ã€‚æ¯”å¦‚ï¼ŒåªåŒ¹é…ä¸åœ¨ç¾å…ƒç¬¦å·åé¢çš„æ•°å­—ï¼Œè¦å†™æˆ/(?<!\$)\d+/ã€‚

/(?<=\$)\d+/.exec('Benjamin Franklin is on the $100 bill')  // ["100"]
/(?<!\$)\d+/.exec('itâ€™s is worth about â‚¬90')                // ["90"]
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ"åè¡Œæ–­è¨€"çš„æ‹¬å·ä¹‹ä¸­çš„éƒ¨åˆ†ï¼ˆ(?<=\$)ï¼‰ï¼Œä¹Ÿæ˜¯ä¸è®¡å…¥è¿”å›ç»“æœã€‚

"åè¡Œæ–­è¨€"çš„å®ç°ï¼Œéœ€è¦å…ˆåŒ¹é…/(?<=y)x/çš„xï¼Œç„¶åå†å›åˆ°å·¦è¾¹ï¼ŒåŒ¹é…yçš„éƒ¨åˆ†ã€‚è¿™ç§"å…ˆå³åå·¦"çš„æ‰§è¡Œé¡ºåºï¼Œä¸æ‰€æœ‰å…¶ä»–æ­£åˆ™æ“ä½œç›¸åï¼Œå¯¼è‡´äº†ä¸€äº›ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºã€‚

é¦–å…ˆï¼Œâ€åè¡Œæ–­è¨€â€œçš„ç»„åŒ¹é…ï¼Œä¸æ­£å¸¸æƒ…å†µä¸‹ç»“æœæ˜¯ä¸ä¸€æ ·çš„ã€‚

/(?<=(\d+)(\d+))$/.exec('1053') // ["", "1", "053"]
/^(\d+)(\d+)$/.exec('1053') // ["1053", "105", "3"]
ä¸Šé¢ä»£ç ä¸­ï¼Œéœ€è¦æ•æ‰ä¸¤ä¸ªç»„åŒ¹é…ã€‚æ²¡æœ‰"åè¡Œæ–­è¨€"æ—¶ï¼Œç¬¬ä¸€ä¸ªæ‹¬å·æ˜¯è´ªå©ªæ¨¡å¼ï¼Œç¬¬äºŒä¸ªæ‹¬å·åªèƒ½æ•è·ä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ç»“æœæ˜¯105å’Œ3ã€‚è€Œ"åè¡Œæ–­è¨€"æ—¶ï¼Œç”±äºæ‰§è¡Œé¡ºåºæ˜¯ä»å³åˆ°å·¦ï¼Œç¬¬äºŒä¸ªæ‹¬å·æ˜¯è´ªå©ªæ¨¡å¼ï¼Œç¬¬ä¸€ä¸ªæ‹¬å·åªèƒ½æ•è·ä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ç»“æœæ˜¯1å’Œ053ã€‚

å…¶æ¬¡ï¼Œ"åè¡Œæ–­è¨€"çš„åæ–œæ å¼•ç”¨ï¼Œä¹Ÿä¸é€šå¸¸çš„é¡ºåºç›¸åï¼Œå¿…é¡»æ”¾åœ¨å¯¹åº”çš„é‚£ä¸ªæ‹¬å·ä¹‹å‰ã€‚

/(?<=(o)d\1)r/.exec('hodor')  // null
/(?<=\1d(o))r/.exec('hodor')  // ["r", "o"]
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœåè¡Œæ–­è¨€çš„åæ–œæ å¼•ç”¨ï¼ˆ\1ï¼‰æ”¾åœ¨æ‹¬å·çš„åé¢ï¼Œå°±ä¸ä¼šå¾—åˆ°åŒ¹é…ç»“æœï¼Œå¿…é¡»æ”¾åœ¨å‰é¢æ‰å¯ä»¥ã€‚

Unicodeå±æ€§ç±»
ç›®å‰ï¼Œæœ‰ä¸€ä¸ªææ¡ˆï¼Œå¼•å…¥äº†ä¸€ç§æ–°çš„ç±»çš„å†™æ³•\p{...}å’Œ\P{...}ï¼Œå…è®¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç¬¦åˆUnicodeæŸç§å±æ€§çš„æ‰€æœ‰å­—ç¬¦ã€‚

const regexGreekSymbol = /\p{Script=Greek}/u;
regexGreekSymbol.test('Ï€') // u
ä¸Šé¢ä»£ç ä¸­ï¼Œ\p{Script=Greek}æŒ‡å®šåŒ¹é…ä¸€ä¸ªå¸Œè…Šæ–‡å­—æ¯ï¼Œæ‰€ä»¥åŒ¹é…Ï€æˆåŠŸã€‚

Unicodeå±æ€§ç±»è¦æŒ‡å®šå±æ€§åå’Œå±æ€§å€¼ã€‚

\p{UnicodePropertyName=UnicodePropertyValue}
å¯¹äºæŸäº›å±æ€§ï¼Œå¯ä»¥åªå†™å±æ€§åã€‚

\p{UnicodePropertyName}
\P{â€¦}æ˜¯\p{â€¦}çš„åå‘åŒ¹é…ï¼Œå³åŒ¹é…ä¸æ»¡è¶³æ¡ä»¶çš„å­—ç¬¦ã€‚

æ³¨æ„ï¼Œè¿™ä¸¤ç§ç±»åªå¯¹Unicodeæœ‰æ•ˆï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦åŠ ä¸Šuä¿®é¥°ç¬¦ã€‚å¦‚æœä¸åŠ uä¿®é¥°ç¬¦ï¼Œæ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨\på’Œ\Pä¼šæŠ¥é”™ï¼ŒECMAScripté¢„ç•™äº†è¿™ä¸¤ä¸ªç±»ã€‚

ç”±äºUnicodeçš„å„ç§å±æ€§éå¸¸å¤šï¼Œæ‰€ä»¥è¿™ç§æ–°çš„ç±»çš„è¡¨è¾¾èƒ½åŠ›éå¸¸å¼ºã€‚

const regex = /^\p{Decimal_Number}+$/u;
regex.test('ğŸğŸğŸ‘ğŸœğŸğŸğŸ©ğŸªğŸ«ğŸ¬ğŸ­ğŸ®ğŸ¯ğŸºğŸ»ğŸ¼') // true
ä¸Šé¢ä»£ç ä¸­ï¼Œå±æ€§ç±»æŒ‡å®šåŒ¹é…æ‰€æœ‰åè¿›åˆ¶å­—ç¬¦ï¼Œå¯ä»¥çœ‹åˆ°å„ç§å­—å‹çš„åè¿›åˆ¶å­—ç¬¦éƒ½ä¼šåŒ¹é…æˆåŠŸã€‚

\p{Number}ç”šè‡³èƒ½åŒ¹é…ç½—é©¬æ•°å­—ã€‚

// åŒ¹é…æ‰€æœ‰æ•°å­—
const regex = /^\p{Number}+$/u;
regex.test('Â²Â³Â¹Â¼Â½Â¾') // true
regex.test('ã‰›ã‰œã‰') // true
regex.test('â… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©â…ªâ…«') // true
ä¸‹é¢æ˜¯å…¶ä»–ä¸€äº›ä¾‹å­ã€‚

// åŒ¹é…å„ç§æ–‡å­—çš„æ‰€æœ‰å­—æ¯ï¼Œç­‰åŒäºUnicodeç‰ˆçš„\w
[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Connector_Punctuation}\p{Join_Control}]

// åŒ¹é…å„ç§æ–‡å­—çš„æ‰€æœ‰éå­—æ¯çš„å­—ç¬¦ï¼Œç­‰åŒäºUnicodeç‰ˆçš„\W
[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Connector_Punctuation}\p{Join_Control}]

// åŒ¹é…æ‰€æœ‰çš„ç®­å¤´å­—ç¬¦
const regexArrows = /^\p{Block=Arrows}+$/u;
regexArrows.test('â†â†‘â†’â†“â†”â†•â†–â†—â†˜â†™â‡â‡â‡‘â‡’â‡“â‡”â‡•â‡–â‡—â‡˜â‡™â‡§â‡©') // true

##æ•°å€¼çš„æ‰©å±•
1.äºŒè¿›åˆ¶å’Œå…«è¿›åˆ¶è¡¨ç¤ºæ³•
ES6æä¾›äº†äºŒè¿›åˆ¶å’Œå…«è¿›åˆ¶æ•°å€¼çš„æ–°çš„å†™æ³•ï¼Œåˆ†åˆ«ç”¨å‰ç¼€0bï¼ˆæˆ–0Bï¼‰å’Œ0oï¼ˆæˆ–0Oï¼‰è¡¨ç¤ºã€‚

0b111110111 === 503 // true
0o767 === 503 // true
ä»ES5å¼€å§‹ï¼Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¹‹ä¸­ï¼Œå…«è¿›åˆ¶å°±ä¸å†å…è®¸ä½¿ç”¨å‰ç¼€0è¡¨ç¤ºï¼ŒES6è¿›ä¸€æ­¥æ˜ç¡®ï¼Œè¦ä½¿ç”¨å‰ç¼€0oè¡¨ç¤ºã€‚

// éä¸¥æ ¼æ¨¡å¼
(function(){
  console.log(0o11 === 011);
})() // true

// ä¸¥æ ¼æ¨¡å¼
(function(){
  'use strict';
  console.log(0o11 === 011);
})() // Uncaught SyntaxError: Octal literals are not allowed in strict mode.
å¦‚æœè¦å°†0bå’Œ0oå‰ç¼€çš„å­—ç¬¦ä¸²æ•°å€¼è½¬ä¸ºåè¿›åˆ¶ï¼Œè¦ä½¿ç”¨Numberæ–¹æ³•ã€‚

Number('0b111')  // 7
Number('0o10')  // 8
Number.isFinite(), Number.isNaN()
ES6åœ¨Numberå¯¹è±¡ä¸Šï¼Œæ–°æä¾›äº†Number.isFinite()å’ŒNumber.isNaN()ä¸¤ä¸ªæ–¹æ³•ã€‚

Number.isFinite()ç”¨æ¥æ£€æŸ¥ä¸€ä¸ªæ•°å€¼æ˜¯å¦ä¸ºæœ‰é™çš„ï¼ˆfiniteï¼‰ã€‚

Number.isFinite(15); // true
Number.isFinite(0.8); // true
Number.isFinite(NaN); // false
Number.isFinite(Infinity); // false
Number.isFinite(-Infinity); // false
Number.isFinite('foo'); // false
Number.isFinite('15'); // false
Number.isFinite(true); // false
ES5å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œéƒ¨ç½²Number.isFiniteæ–¹æ³•ã€‚

(function (global) {
  var global_isFinite = global.isFinite;

  Object.defineProperty(Number, 'isFinite', {
    value: function isFinite(value) {
      return typeof value === 'number' && global_isFinite(value);
    },
    configurable: true,
    enumerable: false,
    writable: true
  });
})(this);
Number.isNaN()ç”¨æ¥æ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦ä¸ºNaNã€‚

Number.isNaN(NaN) // true
Number.isNaN(15) // false
Number.isNaN('15') // false
Number.isNaN(true) // false
Number.isNaN(9/NaN) // true
Number.isNaN('true'/0) // true
Number.isNaN('true'/'true') // true
ES5é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œéƒ¨ç½²Number.isNaN()ã€‚

(function (global) {
  var global_isNaN = global.isNaN;

  Object.defineProperty(Number, 'isNaN', {
    value: function isNaN(value) {
      return typeof value === 'number' && global_isNaN(value);
    },
    configurable: true,
    enumerable: false,
    writable: true
  });
})(this);
å®ƒä»¬ä¸ä¼ ç»Ÿçš„å…¨å±€æ–¹æ³•isFinite()å’ŒisNaN()çš„åŒºåˆ«åœ¨äºï¼Œä¼ ç»Ÿæ–¹æ³•å…ˆè°ƒç”¨Number()å°†éæ•°å€¼çš„å€¼è½¬ä¸ºæ•°å€¼ï¼Œå†è¿›è¡Œåˆ¤æ–­ï¼Œè€Œè¿™ä¸¤ä¸ªæ–°æ–¹æ³•åªå¯¹æ•°å€¼æœ‰æ•ˆï¼Œéæ•°å€¼ä¸€å¾‹è¿”å›falseã€‚

isFinite(25) // true
isFinite("25") // true
Number.isFinite(25) // true
Number.isFinite("25") // false

isNaN(NaN) // true
isNaN("NaN") // true
Number.isNaN(NaN) // true
Number.isNaN("NaN") // false
Number.parseInt(), Number.parseFloat()
ES6å°†å…¨å±€æ–¹æ³•parseInt()å’ŒparseFloat()ï¼Œç§»æ¤åˆ°Numberå¯¹è±¡ä¸Šé¢ï¼Œè¡Œä¸ºå®Œå…¨ä¿æŒä¸å˜ã€‚

// ES5çš„å†™æ³•
parseInt('12.34') // 12
parseFloat('123.45#') // 123.45

// ES6çš„å†™æ³•
Number.parseInt('12.34') // 12
Number.parseFloat('123.45#') // 123.45
è¿™æ ·åšçš„ç›®çš„ï¼Œæ˜¯é€æ­¥å‡å°‘å…¨å±€æ€§æ–¹æ³•ï¼Œä½¿å¾—è¯­è¨€é€æ­¥æ¨¡å—åŒ–ã€‚

Number.parseInt === parseInt // true
Number.parseFloat === parseFloat // true
Number.isInteger()
Number.isInteger()ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸ºæ•´æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨JavaScriptå†…éƒ¨ï¼Œæ•´æ•°å’Œæµ®ç‚¹æ•°æ˜¯åŒæ ·çš„å‚¨å­˜æ–¹æ³•ï¼Œæ‰€ä»¥3å’Œ3.0è¢«è§†ä¸ºåŒä¸€ä¸ªå€¼ã€‚

Number.isInteger(25) // true
Number.isInteger(25.0) // true
Number.isInteger(25.1) // false
Number.isInteger("15") // false
Number.isInteger(true) // false
ES5å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œéƒ¨ç½²Number.isInteger()ã€‚

(function (global) {
  var floor = Math.floor,
    isFinite = global.isFinite;

  Object.defineProperty(Number, 'isInteger', {
    value: function isInteger(value) {
      return typeof value === 'number' && isFinite(value) &&
        value > -9007199254740992 && value < 9007199254740992 &&
        floor(value) === value;
    },
    configurable: true,
    enumerable: false,
    writable: true
  });
})(this);
Number.EPSILON
ES6åœ¨Numberå¯¹è±¡ä¸Šé¢ï¼Œæ–°å¢ä¸€ä¸ªæå°çš„å¸¸é‡Number.EPSILONã€‚

Number.EPSILON
// 2.220446049250313e-16
Number.EPSILON.toFixed(20)
// '0.00000000000000022204'
å¼•å…¥ä¸€ä¸ªè¿™ä¹ˆå°çš„é‡çš„ç›®çš„ï¼Œåœ¨äºä¸ºæµ®ç‚¹æ•°è®¡ç®—ï¼Œè®¾ç½®ä¸€ä¸ªè¯¯å·®èŒƒå›´ã€‚æˆ‘ä»¬çŸ¥é“æµ®ç‚¹æ•°è®¡ç®—æ˜¯ä¸ç²¾ç¡®çš„ã€‚

0.1 + 0.2
// 0.30000000000000004

0.1 + 0.2 - 0.3
// 5.551115123125783e-17

5.551115123125783e-17.toFixed(20)
// '0.00000000000000005551'
ä½†æ˜¯å¦‚æœè¿™ä¸ªè¯¯å·®èƒ½å¤Ÿå°äºNumber.EPSILONï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºå¾—åˆ°äº†æ­£ç¡®ç»“æœã€‚

5.551115123125783e-17 < Number.EPSILON
// true
å› æ­¤ï¼ŒNumber.EPSILONçš„å®è´¨æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„è¯¯å·®èŒƒå›´ã€‚

function withinErrorMargin (left, right) {
  return Math.abs(left - right) < Number.EPSILON;
}
withinErrorMargin(0.1 + 0.2, 0.3)
// true
withinErrorMargin(0.2 + 0.2, 0.3)
// false
ä¸Šé¢çš„ä»£ç ä¸ºæµ®ç‚¹æ•°è¿ç®—ï¼Œéƒ¨ç½²äº†ä¸€ä¸ªè¯¯å·®æ£€æŸ¥å‡½æ•°ã€‚

å®‰å…¨æ•´æ•°å’ŒNumber.isSafeInteger()
JavaScriptèƒ½å¤Ÿå‡†ç¡®è¡¨ç¤ºçš„æ•´æ•°èŒƒå›´åœ¨-2^53åˆ°2^53ä¹‹é—´ï¼ˆä¸å«ä¸¤ä¸ªç«¯ç‚¹ï¼‰ï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´ï¼Œæ— æ³•ç²¾ç¡®è¡¨ç¤ºè¿™ä¸ªå€¼ã€‚

Math.pow(2, 53) // 9007199254740992

9007199254740992  // 9007199254740992
9007199254740993  // 9007199254740992

Math.pow(2, 53) === Math.pow(2, 53) + 1
// true
ä¸Šé¢ä»£ç ä¸­ï¼Œè¶…å‡º2çš„53æ¬¡æ–¹ä¹‹åï¼Œä¸€ä¸ªæ•°å°±ä¸ç²¾ç¡®äº†ã€‚

ES6å¼•å…¥äº†Number.MAX_SAFE_INTEGERå’ŒNumber.MIN_SAFE_INTEGERè¿™ä¸¤ä¸ªå¸¸é‡ï¼Œç”¨æ¥è¡¨ç¤ºè¿™ä¸ªèŒƒå›´çš„ä¸Šä¸‹é™ã€‚

Number.MAX_SAFE_INTEGER === Math.pow(2, 53) - 1
// true
Number.MAX_SAFE_INTEGER === 9007199254740991
// true

Number.MIN_SAFE_INTEGER === -Number.MAX_SAFE_INTEGER
// true
Number.MIN_SAFE_INTEGER === -9007199254740991
// true
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°JavaScriptèƒ½å¤Ÿç²¾ç¡®è¡¨ç¤ºçš„æé™ã€‚

Number.isSafeInteger()åˆ™æ˜¯ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•´æ•°æ˜¯å¦è½åœ¨è¿™ä¸ªèŒƒå›´ä¹‹å†…ã€‚

Number.isSafeInteger('a') // false
Number.isSafeInteger(null) // false
Number.isSafeInteger(NaN) // false
Number.isSafeInteger(Infinity) // false
Number.isSafeInteger(-Infinity) // false

Number.isSafeInteger(3) // true
Number.isSafeInteger(1.2) // false
Number.isSafeInteger(9007199254740990) // true
Number.isSafeInteger(9007199254740992) // false

Number.isSafeInteger(Number.MIN_SAFE_INTEGER - 1) // false
Number.isSafeInteger(Number.MIN_SAFE_INTEGER) // true
Number.isSafeInteger(Number.MAX_SAFE_INTEGER) // true
Number.isSafeInteger(Number.MAX_SAFE_INTEGER + 1) // false
è¿™ä¸ªå‡½æ•°çš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯è·Ÿå®‰å…¨æ•´æ•°çš„ä¸¤ä¸ªè¾¹ç•Œå€¼æ¯”è¾ƒä¸€ä¸‹ã€‚

Number.isSafeInteger = function (n) {
  return (typeof n === 'number' &&
    Math.round(n) === n &&
    Number.MIN_SAFE_INTEGER <= n &&
    n <= Number.MAX_SAFE_INTEGER);
}
å®é™…ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œéœ€è¦æ³¨æ„ã€‚éªŒè¯è¿ç®—ç»“æœæ˜¯å¦è½åœ¨å®‰å…¨æ•´æ•°çš„èŒƒå›´å†…ï¼Œä¸è¦åªéªŒè¯è¿ç®—ç»“æœï¼Œè€Œè¦åŒæ—¶éªŒè¯å‚ä¸è¿ç®—çš„æ¯ä¸ªå€¼ã€‚

Number.isSafeInteger(9007199254740993)
// false
Number.isSafeInteger(990)
// true
Number.isSafeInteger(9007199254740993 - 990)
// true
9007199254740993 - 990
// è¿”å›ç»“æœ 9007199254740002
// æ­£ç¡®ç­”æ¡ˆåº”è¯¥æ˜¯ 9007199254740003
ä¸Šé¢ä»£ç ä¸­ï¼Œ9007199254740993ä¸æ˜¯ä¸€ä¸ªå®‰å…¨æ•´æ•°ï¼Œä½†æ˜¯Number.isSafeIntegerä¼šè¿”å›ç»“æœï¼Œæ˜¾ç¤ºè®¡ç®—ç»“æœæ˜¯å®‰å…¨çš„ã€‚è¿™æ˜¯å› ä¸ºï¼Œè¿™ä¸ªæ•°è¶…å‡ºäº†ç²¾åº¦èŒƒå›´ï¼Œå¯¼è‡´åœ¨è®¡ç®—æœºå†…éƒ¨ï¼Œä»¥9007199254740992çš„å½¢å¼å‚¨å­˜ã€‚

9007199254740993 === 9007199254740992
// true
æ‰€ä»¥ï¼Œå¦‚æœåªéªŒè¯è¿ç®—ç»“æœæ˜¯å¦ä¸ºå®‰å…¨æ•´æ•°ï¼Œå¾ˆå¯èƒ½å¾—åˆ°é”™è¯¯ç»“æœã€‚ä¸‹é¢çš„å‡½æ•°å¯ä»¥åŒæ—¶éªŒè¯ä¸¤ä¸ªè¿ç®—æ•°å’Œè¿ç®—ç»“æœã€‚

function trusty (left, right, result) {
  if (
    Number.isSafeInteger(left) &&
    Number.isSafeInteger(right) &&
    Number.isSafeInteger(result)
  ) {
    return result;
  }
  throw new RangeError('Operation cannot be trusted!');
}

trusty(9007199254740993, 990, 9007199254740993 - 990)
// RangeError: Operation cannot be trusted!

trusty(1, 2, 3)
// 3
Mathå¯¹è±¡çš„æ‰©å±•
ES6åœ¨Mathå¯¹è±¡ä¸Šæ–°å¢äº†17ä¸ªä¸æ•°å­¦ç›¸å…³çš„æ–¹æ³•ã€‚æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œåªèƒ½åœ¨Mathå¯¹è±¡ä¸Šè°ƒç”¨ã€‚

Math.trunc()
Math.truncæ–¹æ³•ç”¨äºå»é™¤ä¸€ä¸ªæ•°çš„å°æ•°éƒ¨åˆ†ï¼Œè¿”å›æ•´æ•°éƒ¨åˆ†ã€‚

Math.trunc(4.1) // 4
Math.trunc(4.9) // 4
Math.trunc(-4.1) // -4
Math.trunc(-4.9) // -4
Math.trunc(-0.1234) // -0
å¯¹äºéæ•°å€¼ï¼ŒMath.truncå†…éƒ¨ä½¿ç”¨Numberæ–¹æ³•å°†å…¶å…ˆè½¬ä¸ºæ•°å€¼ã€‚

Math.trunc('123.456')
// 123
å¯¹äºç©ºå€¼å’Œæ— æ³•æˆªå–æ•´æ•°çš„å€¼ï¼Œè¿”å›NaNã€‚

Math.trunc(NaN);      // NaN
Math.trunc('foo');    // NaN
Math.trunc();         // NaN
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.trunc = Math.trunc || function(x) {
  return x < 0 ? Math.ceil(x) : Math.floor(x);
};
Math.sign()
Math.signæ–¹æ³•ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•°åˆ°åº•æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€è¿˜æ˜¯é›¶ã€‚

å®ƒä¼šè¿”å›äº”ç§å€¼ã€‚

å‚æ•°ä¸ºæ­£æ•°ï¼Œè¿”å›+1ï¼›
å‚æ•°ä¸ºè´Ÿæ•°ï¼Œè¿”å›-1ï¼›
å‚æ•°ä¸º0ï¼Œè¿”å›0ï¼›
å‚æ•°ä¸º-0ï¼Œè¿”å›-0;
å…¶ä»–å€¼ï¼Œè¿”å›NaNã€‚
Math.sign(-5) // -1
Math.sign(5) // +1
Math.sign(0) // +0
Math.sign(-0) // -0
Math.sign(NaN) // NaN
Math.sign('foo'); // NaN
Math.sign();      // NaN
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.sign = Math.sign || function(x) {
  x = +x; // convert to a number
  if (x === 0 || isNaN(x)) {
    return x;
  }
  return x > 0 ? 1 : -1;
};
Math.cbrt()
Math.cbrtæ–¹æ³•ç”¨äºè®¡ç®—ä¸€ä¸ªæ•°çš„ç«‹æ–¹æ ¹ã€‚

Math.cbrt(-1) // -1
Math.cbrt(0)  // 0
Math.cbrt(1)  // 1
Math.cbrt(2)  // 1.2599210498948734
å¯¹äºéæ•°å€¼ï¼ŒMath.cbrtæ–¹æ³•å†…éƒ¨ä¹Ÿæ˜¯å…ˆä½¿ç”¨Numberæ–¹æ³•å°†å…¶è½¬ä¸ºæ•°å€¼ã€‚

Math.cbrt('8') // 2
Math.cbrt('hello') // NaN
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.cbrt = Math.cbrt || function(x) {
  var y = Math.pow(Math.abs(x), 1/3);
  return x < 0 ? -y : y;
};
Math.clz32()
JavaScriptçš„æ•´æ•°ä½¿ç”¨32ä½äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºï¼ŒMath.clz32æ–¹æ³•è¿”å›ä¸€ä¸ªæ•°çš„32ä½æ— ç¬¦å·æ•´æ•°å½¢å¼æœ‰å¤šå°‘ä¸ªå‰å¯¼0ã€‚

Math.clz32(0) // 32
Math.clz32(1) // 31
Math.clz32(1000) // 22
Math.clz32(0b01000000000000000000000000000000) // 1
Math.clz32(0b00100000000000000000000000000000) // 2
ä¸Šé¢ä»£ç ä¸­ï¼Œ0çš„äºŒè¿›åˆ¶å½¢å¼å…¨ä¸º0ï¼Œæ‰€ä»¥æœ‰32ä¸ªå‰å¯¼0ï¼›1çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯0b1ï¼Œåªå 1ä½ï¼Œæ‰€ä»¥32ä½ä¹‹ä¸­æœ‰31ä¸ªå‰å¯¼0ï¼›1000çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯0b1111101000ï¼Œä¸€å…±æœ‰10ä½ï¼Œæ‰€ä»¥32ä½ä¹‹ä¸­æœ‰22ä¸ªå‰å¯¼0ã€‚

clz32è¿™ä¸ªå‡½æ•°åå°±æ¥è‡ªâ€count leading zero bits in 32-bit binary representations of a numberâ€œï¼ˆè®¡ç®—32ä½æ•´æ•°çš„å‰å¯¼0ï¼‰çš„ç¼©å†™ã€‚

å·¦ç§»è¿ç®—ç¬¦ï¼ˆ<<ï¼‰ä¸Math.clz32æ–¹æ³•ç›´æ¥ç›¸å…³ã€‚

Math.clz32(0) // 32
Math.clz32(1) // 31
Math.clz32(1 << 1) // 30
Math.clz32(1 << 2) // 29
Math.clz32(1 << 29) // 2
å¯¹äºå°æ•°ï¼ŒMath.clz32æ–¹æ³•åªè€ƒè™‘æ•´æ•°éƒ¨åˆ†ã€‚

Math.clz32(3.2) // 30
Math.clz32(3.9) // 30
å¯¹äºç©ºå€¼æˆ–å…¶ä»–ç±»å‹çš„å€¼ï¼ŒMath.clz32æ–¹æ³•ä¼šå°†å®ƒä»¬å…ˆè½¬ä¸ºæ•°å€¼ï¼Œç„¶åå†è®¡ç®—ã€‚

Math.clz32() // 32
Math.clz32(NaN) // 32
Math.clz32(Infinity) // 32
Math.clz32(null) // 32
Math.clz32('foo') // 32
Math.clz32([]) // 32
Math.clz32({}) // 32
Math.clz32(true) // 31
Math.imul()
Math.imulæ–¹æ³•è¿”å›ä¸¤ä¸ªæ•°ä»¥32ä½å¸¦ç¬¦å·æ•´æ•°å½¢å¼ç›¸ä¹˜çš„ç»“æœï¼Œè¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ª32ä½çš„å¸¦ç¬¦å·æ•´æ•°ã€‚

Math.imul(2, 4)   // 8
Math.imul(-1, 8)  // -8
Math.imul(-2, -2) // 4
å¦‚æœåªè€ƒè™‘æœ€å32ä½ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒMath.imul(a, b)ä¸a * bçš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œå³è¯¥æ–¹æ³•ç­‰åŒäº(a * b)|0çš„æ•ˆæœï¼ˆè¶…è¿‡32ä½çš„éƒ¨åˆ†æº¢å‡ºï¼‰ã€‚ä¹‹æ‰€ä»¥éœ€è¦éƒ¨ç½²è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯å› ä¸ºJavaScriptæœ‰ç²¾åº¦é™åˆ¶ï¼Œè¶…è¿‡2çš„53æ¬¡æ–¹çš„å€¼æ— æ³•ç²¾ç¡®è¡¨ç¤ºã€‚è¿™å°±æ˜¯è¯´ï¼Œå¯¹äºé‚£äº›å¾ˆå¤§çš„æ•°çš„ä¹˜æ³•ï¼Œä½ä½æ•°å€¼å¾€å¾€éƒ½æ˜¯ä¸ç²¾ç¡®çš„ï¼ŒMath.imulæ–¹æ³•å¯ä»¥è¿”å›æ­£ç¡®çš„ä½ä½æ•°å€¼ã€‚

(0x7fffffff * 0x7fffffff)|0 // 0
ä¸Šé¢è¿™ä¸ªä¹˜æ³•ç®—å¼ï¼Œè¿”å›ç»“æœä¸º0ã€‚ä½†æ˜¯ç”±äºè¿™ä¸¤ä¸ªäºŒè¿›åˆ¶æ•°çš„æœ€ä½ä½éƒ½æ˜¯1ï¼Œæ‰€ä»¥è¿™ä¸ªç»“æœè‚¯å®šæ˜¯ä¸æ­£ç¡®çš„ï¼Œå› ä¸ºæ ¹æ®äºŒè¿›åˆ¶ä¹˜æ³•ï¼Œè®¡ç®—ç»“æœçš„äºŒè¿›åˆ¶æœ€ä½ä½åº”è¯¥ä¹Ÿæ˜¯1ã€‚è¿™ä¸ªé”™è¯¯å°±æ˜¯å› ä¸ºå®ƒä»¬çš„ä¹˜ç§¯è¶…è¿‡äº†2çš„53æ¬¡æ–¹ï¼ŒJavaScriptæ— æ³•ä¿å­˜é¢å¤–çš„ç²¾åº¦ï¼Œå°±æŠŠä½ä½çš„å€¼éƒ½å˜æˆäº†0ã€‚Math.imulæ–¹æ³•å¯ä»¥è¿”å›æ­£ç¡®çš„å€¼1ã€‚

Math.imul(0x7fffffff, 0x7fffffff) // 1
Math.fround()
Math.froundæ–¹æ³•è¿”å›ä¸€ä¸ªæ•°çš„å•ç²¾åº¦æµ®ç‚¹æ•°å½¢å¼ã€‚

Math.fround(0)     // 0
Math.fround(1)     // 1
Math.fround(1.337) // 1.3370000123977661
Math.fround(1.5)   // 1.5
Math.fround(NaN)   // NaN
å¯¹äºæ•´æ•°æ¥è¯´ï¼ŒMath.froundæ–¹æ³•è¿”å›ç»“æœä¸ä¼šæœ‰ä»»ä½•ä¸åŒï¼ŒåŒºåˆ«ä¸»è¦æ˜¯é‚£äº›æ— æ³•ç”¨64ä¸ªäºŒè¿›åˆ¶ä½ç²¾ç¡®è¡¨ç¤ºçš„å°æ•°ã€‚è¿™æ—¶ï¼ŒMath.froundæ–¹æ³•ä¼šè¿”å›æœ€æ¥è¿‘è¿™ä¸ªå°æ•°çš„å•ç²¾åº¦æµ®ç‚¹æ•°ã€‚

å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.fround = Math.fround || function(x) {
  return new Float32Array([x])[0];
};
Math.hypot()
Math.hypotæ–¹æ³•è¿”å›æ‰€æœ‰å‚æ•°çš„å¹³æ–¹å’Œçš„å¹³æ–¹æ ¹ã€‚

Math.hypot(3, 4);        // 5
Math.hypot(3, 4, 5);     // 7.0710678118654755
Math.hypot();            // 0
Math.hypot(NaN);         // NaN
Math.hypot(3, 4, 'foo'); // NaN
Math.hypot(3, 4, '5');   // 7.0710678118654755
Math.hypot(-3);          // 3
ä¸Šé¢ä»£ç ä¸­ï¼Œ3çš„å¹³æ–¹åŠ ä¸Š4çš„å¹³æ–¹ï¼Œç­‰äº5çš„å¹³æ–¹ã€‚

å¦‚æœå‚æ•°ä¸æ˜¯æ•°å€¼ï¼ŒMath.hypotæ–¹æ³•ä¼šå°†å…¶è½¬ä¸ºæ•°å€¼ã€‚åªè¦æœ‰ä¸€ä¸ªå‚æ•°æ— æ³•è½¬ä¸ºæ•°å€¼ï¼Œå°±ä¼šè¿”å›NaNã€‚

å¯¹æ•°æ–¹æ³•
ES6æ–°å¢äº†4ä¸ªå¯¹æ•°ç›¸å…³æ–¹æ³•ã€‚

ï¼ˆ1ï¼‰ Math.expm1()

Math.expm1(x)è¿”å›ex - 1ï¼Œå³Math.exp(x) - 1ã€‚

Math.expm1(-1) // -0.6321205588285577
Math.expm1(0)  // 0
Math.expm1(1)  // 1.718281828459045
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.expm1 = Math.expm1 || function(x) {
  return Math.exp(x) - 1;
};
ï¼ˆ2ï¼‰Math.log1p()

Math.log1p(x)æ–¹æ³•è¿”å›1 + xçš„è‡ªç„¶å¯¹æ•°ï¼Œå³Math.log(1 + x)ã€‚å¦‚æœxå°äº-1ï¼Œè¿”å›NaNã€‚

Math.log1p(1)  // 0.6931471805599453
Math.log1p(0)  // 0
Math.log1p(-1) // -Infinity
Math.log1p(-2) // NaN
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.log1p = Math.log1p || function(x) {
  return Math.log(1 + x);
};
ï¼ˆ3ï¼‰Math.log10()

Math.log10(x)è¿”å›ä»¥10ä¸ºåº•çš„xçš„å¯¹æ•°ã€‚å¦‚æœxå°äº0ï¼Œåˆ™è¿”å›NaNã€‚

Math.log10(2)      // 0.3010299956639812
Math.log10(1)      // 0
Math.log10(0)      // -Infinity
Math.log10(-2)     // NaN
Math.log10(100000) // 5
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.log10 = Math.log10 || function(x) {
  return Math.log(x) / Math.LN10;
};
ï¼ˆ4ï¼‰Math.log2()

Math.log2(x)è¿”å›ä»¥2ä¸ºåº•çš„xçš„å¯¹æ•°ã€‚å¦‚æœxå°äº0ï¼Œåˆ™è¿”å›NaNã€‚

Math.log2(3)       // 1.584962500721156
Math.log2(2)       // 1
Math.log2(1)       // 0
Math.log2(0)       // -Infinity
Math.log2(-2)      // NaN
Math.log2(1024)    // 10
Math.log2(1 << 29) // 29
å¯¹äºæ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ–¹æ³•çš„ç¯å¢ƒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿã€‚

Math.log2 = Math.log2 || function(x) {
  return Math.log(x) / Math.LN2;
};
ä¸‰è§’å‡½æ•°æ–¹æ³•
ES6æ–°å¢äº†6ä¸ªä¸‰è§’å‡½æ•°æ–¹æ³•ã€‚

Math.sinh(x) è¿”å›xçš„åŒæ›²æ­£å¼¦ï¼ˆhyperbolic sineï¼‰
Math.cosh(x) è¿”å›xçš„åŒæ›²ä½™å¼¦ï¼ˆhyperbolic cosineï¼‰
Math.tanh(x) è¿”å›xçš„åŒæ›²æ­£åˆ‡ï¼ˆhyperbolic tangentï¼‰
Math.asinh(x) è¿”å›xçš„ååŒæ›²æ­£å¼¦ï¼ˆinverse hyperbolic sineï¼‰
Math.acosh(x) è¿”å›xçš„ååŒæ›²ä½™å¼¦ï¼ˆinverse hyperbolic cosineï¼‰
Math.atanh(x) è¿”å›xçš„ååŒæ›²æ­£åˆ‡ï¼ˆinverse hyperbolic tangentï¼‰
æŒ‡æ•°è¿ç®—ç¬¦
ES7æ–°å¢äº†ä¸€ä¸ªæŒ‡æ•°è¿ç®—ç¬¦ï¼ˆ**ï¼‰ï¼Œç›®å‰Babelè½¬ç å™¨å·²ç»æ”¯æŒã€‚

2 ** 2 // 4
2 ** 3 // 8
æŒ‡æ•°è¿ç®—ç¬¦å¯ä»¥ä¸ç­‰å·ç»“åˆï¼Œå½¢æˆä¸€ä¸ªæ–°çš„èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ**=ï¼‰ã€‚

let a = 2;
a **= 2;
// ç­‰åŒäº a = a * a;

let b = 3;
b **= 3;
// ç­‰åŒäº b = b * b * b;

##æ•°ç»„çš„æ‰©å±•
1.Array.from()
Array.fromæ–¹æ³•ç”¨äºå°†ä¸¤ç±»å¯¹è±¡è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼šç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼ˆarray-like objectï¼‰å’Œå¯éå†ï¼ˆiterableï¼‰çš„å¯¹è±¡ï¼ˆåŒ…æ‹¬ES6æ–°å¢çš„æ•°æ®ç»“æ„Setå’ŒMapï¼‰ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼ŒArray.fromå°†å®ƒè½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

let arrayLike = {
    '0': 'a',
    '1': 'b',
    '2': 'c',
    length: 3
};

// ES5çš„å†™æ³•
var arr1 = [].slice.call(arrayLike); // ['a', 'b', 'c']

// ES6çš„å†™æ³•
let arr2 = Array.from(arrayLike); // ['a', 'b', 'c']
å®é™…åº”ç”¨ä¸­ï¼Œå¸¸è§çš„ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡æ˜¯DOMæ“ä½œè¿”å›çš„NodeListé›†åˆï¼Œä»¥åŠå‡½æ•°å†…éƒ¨çš„argumentså¯¹è±¡ã€‚Array.froméƒ½å¯ä»¥å°†å®ƒä»¬è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

// NodeListå¯¹è±¡
let ps = document.querySelectorAll('p');
Array.from(ps).forEach(function (p) {
  console.log(p);
});

// argumentså¯¹è±¡
function foo() {
  var args = Array.from(arguments);
  // ...
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒquerySelectorAllæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œåªæœ‰å°†è¿™ä¸ªå¯¹è±¡è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼Œæ‰èƒ½ä½¿ç”¨forEachæ–¹æ³•ã€‚

åªè¦æ˜¯éƒ¨ç½²äº†Iteratoræ¥å£çš„æ•°æ®ç»“æ„ï¼ŒArray.froméƒ½èƒ½å°†å…¶è½¬ä¸ºæ•°ç»„ã€‚

Array.from('hello')
// ['h', 'e', 'l', 'l', 'o']

let namesSet = new Set(['a', 'b'])
Array.from(namesSet) // ['a', 'b']
ä¸Šé¢ä»£ç ä¸­ï¼Œå­—ç¬¦ä¸²å’ŒSetç»“æ„éƒ½å…·æœ‰Iteratoræ¥å£ï¼Œå› æ­¤å¯ä»¥è¢«Array.fromè½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼ŒArray.fromä¼šè¿”å›ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ–°æ•°ç»„ã€‚

Array.from([1, 2, 3])
// [1, 2, 3]
å€¼å¾—æé†’çš„æ˜¯ï¼Œæ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ä¹Ÿå¯ä»¥å°†æŸäº›æ•°æ®ç»“æ„è½¬ä¸ºæ•°ç»„ã€‚

// argumentså¯¹è±¡
function foo() {
  var args = [...arguments];
}

// NodeListå¯¹è±¡
[...document.querySelectorAll('div')]
æ‰©å±•è¿ç®—ç¬¦èƒŒåè°ƒç”¨çš„æ˜¯éå†å™¨æ¥å£ï¼ˆSymbol.iteratorï¼‰ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ¥å£ï¼Œå°±æ— æ³•è½¬æ¢ã€‚Array.fromæ–¹æ³•åˆ™æ˜¯è¿˜æ”¯æŒç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚æ‰€è°“ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œæœ¬è´¨ç‰¹å¾åªæœ‰ä¸€ç‚¹ï¼Œå³å¿…é¡»æœ‰lengthå±æ€§ã€‚å› æ­¤ï¼Œä»»ä½•æœ‰lengthå±æ€§çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥é€šè¿‡Array.fromæ–¹æ³•è½¬ä¸ºæ•°ç»„ï¼Œè€Œæ­¤æ—¶æ‰©å±•è¿ç®—ç¬¦å°±æ— æ³•è½¬æ¢ã€‚

Array.from({ length: 3 });
// [ undefined, undefined, undefined ]
ä¸Šé¢ä»£ç ä¸­ï¼ŒArray.fromè¿”å›äº†ä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªæˆå‘˜çš„æ•°ç»„ï¼Œæ¯ä¸ªä½ç½®çš„å€¼éƒ½æ˜¯undefinedã€‚æ‰©å±•è¿ç®—ç¬¦è½¬æ¢ä¸äº†è¿™ä¸ªå¯¹è±¡ã€‚

å¯¹äºè¿˜æ²¡æœ‰éƒ¨ç½²è¯¥æ–¹æ³•çš„æµè§ˆå™¨ï¼Œå¯ä»¥ç”¨Array.prototype.sliceæ–¹æ³•æ›¿ä»£ã€‚

const toArray = (() =>
  Array.from ? Array.from : obj => [].slice.call(obj)
)();
Array.fromè¿˜å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œä½œç”¨ç±»ä¼¼äºæ•°ç»„çš„mapæ–¹æ³•ï¼Œç”¨æ¥å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†ï¼Œå°†å¤„ç†åçš„å€¼æ”¾å…¥è¿”å›çš„æ•°ç»„ã€‚

Array.from(arrayLike, x => x * x);
// ç­‰åŒäº
Array.from(arrayLike).map(x => x * x);

Array.from([1, 2, 3], (x) => x * x)
// [1, 4, 9]
ä¸‹é¢çš„ä¾‹å­æ˜¯å–å‡ºä¸€ç»„DOMèŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ã€‚

let spans = document.querySelectorAll('span.name');

// map()
let names1 = Array.prototype.map.call(spans, s => s.textContent);

// Array.from()
let names2 = Array.from(spans, s => s.textContent)
ä¸‹é¢çš„ä¾‹å­å°†æ•°ç»„ä¸­å¸ƒå°”å€¼ä¸ºfalseçš„æˆå‘˜è½¬ä¸º0ã€‚

Array.from([1, , 2, , 3], (n) => n || 0)
// [1, 0, 2, 0, 3]
å¦ä¸€ä¸ªä¾‹å­æ˜¯è¿”å›å„ç§æ•°æ®çš„ç±»å‹ã€‚

function typesOf () {
  return Array.from(arguments, value => typeof value)
}
typesOf(null, [], NaN)
// ['object', 'object', 'number']
å¦‚æœmapå‡½æ•°é‡Œé¢ç”¨åˆ°äº†thiså…³é”®å­—ï¼Œè¿˜å¯ä»¥ä¼ å…¥Array.fromçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨æ¥ç»‘å®šthisã€‚

Array.from()å¯ä»¥å°†å„ç§å€¼è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼Œå¹¶ä¸”è¿˜æä¾›mapåŠŸèƒ½ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€ï¼Œåªè¦æœ‰ä¸€ä¸ªåŸå§‹çš„æ•°æ®ç»“æ„ï¼Œä½ å°±å¯ä»¥å…ˆå¯¹å®ƒçš„å€¼è¿›è¡Œå¤„ç†ï¼Œç„¶åè½¬æˆè§„èŒƒçš„æ•°ç»„ç»“æ„ï¼Œè¿›è€Œå°±å¯ä»¥ä½¿ç”¨æ•°é‡ä¼—å¤šçš„æ•°ç»„æ–¹æ³•ã€‚

Array.from({ length: 2 }, () => 'jack')
// ['jack', 'jack']
ä¸Šé¢ä»£ç ä¸­ï¼ŒArray.fromçš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†ç¬¬äºŒä¸ªå‚æ•°è¿è¡Œçš„æ¬¡æ•°ã€‚è¿™ç§ç‰¹æ€§å¯ä»¥è®©è¯¥æ–¹æ³•çš„ç”¨æ³•å˜å¾—éå¸¸çµæ´»ã€‚

Array.from()çš„å¦ä¸€ä¸ªåº”ç”¨æ˜¯ï¼Œå°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°ç»„ï¼Œç„¶åè¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚å› ä¸ºå®ƒèƒ½æ­£ç¡®å¤„ç†å„ç§Unicodeå­—ç¬¦ï¼Œå¯ä»¥é¿å…JavaScriptå°†å¤§äº\uFFFFçš„Unicodeå­—ç¬¦ï¼Œç®—ä½œä¸¤ä¸ªå­—ç¬¦çš„bugã€‚

function countSymbols(string) {
  return Array.from(string).length;
}
Array.of()
Array.ofæ–¹æ³•ç”¨äºå°†ä¸€ç»„å€¼ï¼Œè½¬æ¢ä¸ºæ•°ç»„ã€‚

Array.of(3, 11, 8) // [3,11,8]
Array.of(3) // [3]
Array.of(3).length // 1
è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯å¼¥è¡¥æ•°ç»„æ„é€ å‡½æ•°Array()çš„ä¸è¶³ã€‚å› ä¸ºå‚æ•°ä¸ªæ•°çš„ä¸åŒï¼Œä¼šå¯¼è‡´Array()çš„è¡Œä¸ºæœ‰å·®å¼‚ã€‚

Array() // []
Array(3) // [, , ,]
Array(3, 11, 8) // [3, 11, 8]
ä¸Šé¢ä»£ç ä¸­ï¼ŒArrayæ–¹æ³•æ²¡æœ‰å‚æ•°ã€ä¸€ä¸ªå‚æ•°ã€ä¸‰ä¸ªå‚æ•°æ—¶ï¼Œè¿”å›ç»“æœéƒ½ä¸ä¸€æ ·ã€‚åªæœ‰å½“å‚æ•°ä¸ªæ•°ä¸å°‘äº2ä¸ªæ—¶ï¼ŒArray()æ‰ä¼šè¿”å›ç”±å‚æ•°ç»„æˆçš„æ–°æ•°ç»„ã€‚å‚æ•°ä¸ªæ•°åªæœ‰ä¸€ä¸ªæ—¶ï¼Œå®é™…ä¸Šæ˜¯æŒ‡å®šæ•°ç»„çš„é•¿åº¦ã€‚

Array.ofåŸºæœ¬ä¸Šå¯ä»¥ç”¨æ¥æ›¿ä»£Array()æˆ–new Array()ï¼Œå¹¶ä¸”ä¸å­˜åœ¨ç”±äºå‚æ•°ä¸åŒè€Œå¯¼è‡´çš„é‡è½½ã€‚å®ƒçš„è¡Œä¸ºéå¸¸ç»Ÿä¸€ã€‚

Array.of() // []
Array.of(undefined) // [undefined]
Array.of(1) // [1]
Array.of(1, 2) // [1, 2]
Array.ofæ€»æ˜¯è¿”å›å‚æ•°å€¼ç»„æˆçš„æ•°ç»„ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œå°±è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ã€‚

Array.ofæ–¹æ³•å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿå®ç°ã€‚

function ArrayOf(){
  return [].slice.call(arguments);
}
æ•°ç»„å®ä¾‹çš„copyWithin()
æ•°ç»„å®ä¾‹çš„copyWithinæ–¹æ³•ï¼Œåœ¨å½“å‰æ•°ç»„å†…éƒ¨ï¼Œå°†æŒ‡å®šä½ç½®çš„æˆå‘˜å¤åˆ¶åˆ°å…¶ä»–ä½ç½®ï¼ˆä¼šè¦†ç›–åŸæœ‰æˆå‘˜ï¼‰ï¼Œç„¶åè¿”å›å½“å‰æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä¼šä¿®æ”¹å½“å‰æ•°ç»„ã€‚

Array.prototype.copyWithin(target, start = 0, end = this.length)
å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ã€‚

targetï¼ˆå¿…éœ€ï¼‰ï¼šä»è¯¥ä½ç½®å¼€å§‹æ›¿æ¢æ•°æ®ã€‚
startï¼ˆå¯é€‰ï¼‰ï¼šä»è¯¥ä½ç½®å¼€å§‹è¯»å–æ•°æ®ï¼Œé»˜è®¤ä¸º0ã€‚å¦‚æœä¸ºè´Ÿå€¼ï¼Œè¡¨ç¤ºå€’æ•°ã€‚
endï¼ˆå¯é€‰ï¼‰ï¼šåˆ°è¯¥ä½ç½®å‰åœæ­¢è¯»å–æ•°æ®ï¼Œé»˜è®¤ç­‰äºæ•°ç»„é•¿åº¦ã€‚å¦‚æœä¸ºè´Ÿå€¼ï¼Œè¡¨ç¤ºå€’æ•°ã€‚
è¿™ä¸‰ä¸ªå‚æ•°éƒ½åº”è¯¥æ˜¯æ•°å€¼ï¼Œå¦‚æœä¸æ˜¯ï¼Œä¼šè‡ªåŠ¨è½¬ä¸ºæ•°å€¼ã€‚

[1, 2, 3, 4, 5].copyWithin(0, 3)
// [4, 5, 3, 4, 5]
ä¸Šé¢ä»£ç è¡¨ç¤ºå°†ä»3å·ä½ç›´åˆ°æ•°ç»„ç»“æŸçš„æˆå‘˜ï¼ˆ4å’Œ5ï¼‰ï¼Œå¤åˆ¶åˆ°ä»0å·ä½å¼€å§‹çš„ä½ç½®ï¼Œç»“æœè¦†ç›–äº†åŸæ¥çš„1å’Œ2ã€‚

ä¸‹é¢æ˜¯æ›´å¤šä¾‹å­ã€‚

// å°†3å·ä½å¤åˆ¶åˆ°0å·ä½
[1, 2, 3, 4, 5].copyWithin(0, 3, 4)
// [4, 2, 3, 4, 5]

// -2ç›¸å½“äº3å·ä½ï¼Œ-1ç›¸å½“äº4å·ä½
[1, 2, 3, 4, 5].copyWithin(0, -2, -1)
// [4, 2, 3, 4, 5]

// å°†3å·ä½å¤åˆ¶åˆ°0å·ä½
[].copyWithin.call({length: 5, 3: 1}, 0, 3)
// {0: 1, 3: 1, length: 5}

// å°†2å·ä½åˆ°æ•°ç»„ç»“æŸï¼Œå¤åˆ¶åˆ°0å·ä½
var i32a = new Int32Array([1, 2, 3, 4, 5]);
i32a.copyWithin(0, 2);
// Int32Array [3, 4, 5, 4, 5]

// å¯¹äºæ²¡æœ‰éƒ¨ç½²TypedArrayçš„copyWithinæ–¹æ³•çš„å¹³å°
// éœ€è¦é‡‡ç”¨ä¸‹é¢çš„å†™æ³•
[].copyWithin.call(new Int32Array([1, 2, 3, 4, 5]), 0, 3, 4);
// Int32Array [4, 2, 3, 4, 5]
æ•°ç»„å®ä¾‹çš„find()å’ŒfindIndex()
æ•°ç»„å®ä¾‹çš„findæ–¹æ³•ï¼Œç”¨äºæ‰¾å‡ºç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æ•°ç»„æˆå‘˜ã€‚å®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ‰€æœ‰æ•°ç»„æˆå‘˜ä¾æ¬¡æ‰§è¡Œè¯¥å›è°ƒå‡½æ•°ï¼Œç›´åˆ°æ‰¾å‡ºç¬¬ä¸€ä¸ªè¿”å›å€¼ä¸ºtrueçš„æˆå‘˜ï¼Œç„¶åè¿”å›è¯¥æˆå‘˜ã€‚å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æˆå‘˜ï¼Œåˆ™è¿”å›undefinedã€‚

[1, 4, -5, 10].find((n) => n < 0)
// -5
ä¸Šé¢ä»£ç æ‰¾å‡ºæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå°äº0çš„æˆå‘˜ã€‚

[1, 5, 10, 15].find(function(value, index, arr) {
  return value > 9;
}) // 10
ä¸Šé¢ä»£ç ä¸­ï¼Œfindæ–¹æ³•çš„å›è°ƒå‡½æ•°å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œä¾æ¬¡ä¸ºå½“å‰çš„å€¼ã€å½“å‰çš„ä½ç½®å’ŒåŸæ•°ç»„ã€‚

æ•°ç»„å®ä¾‹çš„findIndexæ–¹æ³•çš„ç”¨æ³•ä¸findæ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æ•°ç»„æˆå‘˜çš„ä½ç½®ï¼Œå¦‚æœæ‰€æœ‰æˆå‘˜éƒ½ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›-1ã€‚

[1, 5, 10, 15].findIndex(function(value, index, arr) {
  return value > 9;
}) // 2
è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥ç»‘å®šå›è°ƒå‡½æ•°çš„thiså¯¹è±¡ã€‚

å¦å¤–ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å‘ç°NaNï¼Œå¼¥è¡¥äº†æ•°ç»„çš„IndexOfæ–¹æ³•çš„ä¸è¶³ã€‚

[NaN].indexOf(NaN)
// -1

[NaN].findIndex(y => Object.is(NaN, y))
// 0
ä¸Šé¢ä»£ç ä¸­ï¼ŒindexOfæ–¹æ³•æ— æ³•è¯†åˆ«æ•°ç»„çš„NaNæˆå‘˜ï¼Œä½†æ˜¯findIndexæ–¹æ³•å¯ä»¥å€ŸåŠ©Object.isæ–¹æ³•åšåˆ°ã€‚

æ•°ç»„å®ä¾‹çš„fill()
fillæ–¹æ³•ä½¿ç”¨ç»™å®šå€¼ï¼Œå¡«å……ä¸€ä¸ªæ•°ç»„ã€‚

['a', 'b', 'c'].fill(7)
// [7, 7, 7]

new Array(3).fill(7)
// [7, 7, 7]
ä¸Šé¢ä»£ç è¡¨æ˜ï¼Œfillæ–¹æ³•ç”¨äºç©ºæ•°ç»„çš„åˆå§‹åŒ–éå¸¸æ–¹ä¾¿ã€‚æ•°ç»„ä¸­å·²æœ‰çš„å…ƒç´ ï¼Œä¼šè¢«å…¨éƒ¨æŠ¹å»ã€‚

fillæ–¹æ³•è¿˜å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®šå¡«å……çš„èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚

['a', 'b', 'c'].fill(7, 1, 2)
// ['a', 7, 'c']
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œfillæ–¹æ³•ä»1å·ä½å¼€å§‹ï¼Œå‘åŸæ•°ç»„å¡«å……7ï¼Œåˆ°2å·ä½ä¹‹å‰ç»“æŸã€‚

æ•°ç»„å®ä¾‹çš„entries()ï¼Œkeys()å’Œvalues()
ES6æä¾›ä¸‰ä¸ªæ–°çš„æ–¹æ³•â€”â€”entries()ï¼Œkeys()å’Œvalues()â€”â€”ç”¨äºéå†æ•°ç»„ã€‚å®ƒä»¬éƒ½è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼ˆè¯¦è§ã€ŠIteratorã€‹ä¸€ç« ï¼‰ï¼Œå¯ä»¥ç”¨for...ofå¾ªç¯è¿›è¡Œéå†ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯keys()æ˜¯å¯¹é”®åçš„éå†ã€values()æ˜¯å¯¹é”®å€¼çš„éå†ï¼Œentries()æ˜¯å¯¹é”®å€¼å¯¹çš„éå†ã€‚

for (let index of ['a', 'b'].keys()) {
  console.log(index);
}
// 0
// 1

for (let elem of ['a', 'b'].values()) {
  console.log(elem);
}
// 'a'
// 'b'

for (let [index, elem] of ['a', 'b'].entries()) {
  console.log(index, elem);
}
// 0 "a"
// 1 "b"
å¦‚æœä¸ä½¿ç”¨for...ofå¾ªç¯ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œè¿›è¡Œéå†ã€‚

let letter = ['a', 'b', 'c'];
let entries = letter.entries();
console.log(entries.next().value); // [0, 'a']
console.log(entries.next().value); // [1, 'b']
console.log(entries.next().value); // [2, 'c']
æ•°ç»„å®ä¾‹çš„includes()
Array.prototype.includesæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæŸä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ç»™å®šçš„å€¼ï¼Œä¸å­—ç¬¦ä¸²çš„includesæ–¹æ³•ç±»ä¼¼ã€‚è¯¥æ–¹æ³•å±äºES7ï¼Œä½†Babelè½¬ç å™¨å·²ç»æ”¯æŒã€‚

[1, 2, 3].includes(2);     // true
[1, 2, 3].includes(4);     // false
[1, 2, NaN].includes(NaN); // true
è¯¥æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæœç´¢çš„èµ·å§‹ä½ç½®ï¼Œé»˜è®¤ä¸º0ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤ºå€’æ•°çš„ä½ç½®ï¼Œå¦‚æœè¿™æ—¶å®ƒå¤§äºæ•°ç»„é•¿åº¦ï¼ˆæ¯”å¦‚ç¬¬äºŒä¸ªå‚æ•°ä¸º-4ï¼Œä½†æ•°ç»„é•¿åº¦ä¸º3ï¼‰ï¼Œåˆ™ä¼šé‡ç½®ä¸ºä»0å¼€å§‹ã€‚

[1, 2, 3].includes(3, 3);  // false
[1, 2, 3].includes(3, -1); // true
æ²¡æœ‰è¯¥æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ•°ç»„çš„indexOfæ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªå€¼ã€‚

if (arr.indexOf(el) !== -1) {
  // ...
}
indexOfæ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œä¸€æ˜¯ä¸å¤Ÿè¯­ä¹‰åŒ–ï¼Œå®ƒçš„å«ä¹‰æ˜¯æ‰¾åˆ°å‚æ•°å€¼çš„ç¬¬ä¸€ä¸ªå‡ºç°ä½ç½®ï¼Œæ‰€ä»¥è¦å»æ¯”è¾ƒæ˜¯å¦ä¸ç­‰äº-1ï¼Œè¡¨è¾¾èµ·æ¥ä¸å¤Ÿç›´è§‚ã€‚äºŒæ˜¯ï¼Œå®ƒå†…éƒ¨ä½¿ç”¨ä¸¥æ ¼ç›¸å½“è¿ç®—ç¬¦ï¼ˆ===ï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¼šå¯¼è‡´å¯¹NaNçš„è¯¯åˆ¤ã€‚

[NaN].indexOf(NaN)
// -1
includesä½¿ç”¨çš„æ˜¯ä¸ä¸€æ ·çš„åˆ¤æ–­ç®—æ³•ï¼Œå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚

[NaN].includes(NaN)
// true
ä¸‹é¢ä»£ç ç”¨æ¥æ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦æ”¯æŒè¯¥æ–¹æ³•ï¼Œå¦‚æœä¸æ”¯æŒï¼Œéƒ¨ç½²ä¸€ä¸ªç®€æ˜“çš„æ›¿ä»£ç‰ˆæœ¬ã€‚

const contains = (() =>
  Array.prototype.includes
    ? (arr, value) => arr.includes(value)
    : (arr, value) => arr.some(el => el === value)
)();
contains(["foo", "bar"], "baz"); // => false
å¦å¤–ï¼ŒMapå’ŒSetæ•°æ®ç»“æ„æœ‰ä¸€ä¸ªhasæ–¹æ³•ï¼Œéœ€è¦æ³¨æ„ä¸includesåŒºåˆ†ã€‚

Mapç»“æ„çš„hasæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥æŸ¥æ‰¾é”®åçš„ï¼Œæ¯”å¦‚Map.prototype.has(key)ã€WeakMap.prototype.has(key)ã€Reflect.has(target, propertyKey)ã€‚
Setç»“æ„çš„hasæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥æŸ¥æ‰¾å€¼çš„ï¼Œæ¯”å¦‚Set.prototype.has(value)ã€WeakSet.prototype.has(value)ã€‚
æ•°ç»„çš„ç©ºä½
æ•°ç»„çš„ç©ºä½æŒ‡ï¼Œæ•°ç»„çš„æŸä¸€ä¸ªä½ç½®æ²¡æœ‰ä»»ä½•å€¼ã€‚æ¯”å¦‚ï¼ŒArrayæ„é€ å‡½æ•°è¿”å›çš„æ•°ç»„éƒ½æ˜¯ç©ºä½ã€‚

Array(3) // [, , ,]
ä¸Šé¢ä»£ç ä¸­ï¼ŒArray(3)è¿”å›ä¸€ä¸ªå…·æœ‰3ä¸ªç©ºä½çš„æ•°ç»„ã€‚

æ³¨æ„ï¼Œç©ºä½ä¸æ˜¯undefinedï¼Œä¸€ä¸ªä½ç½®çš„å€¼ç­‰äºundefinedï¼Œä¾ç„¶æ˜¯æœ‰å€¼çš„ã€‚ç©ºä½æ˜¯æ²¡æœ‰ä»»ä½•å€¼ï¼Œinè¿ç®—ç¬¦å¯ä»¥è¯´æ˜è¿™ä¸€ç‚¹ã€‚

0 in [undefined, undefined, undefined] // true
0 in [, , ,] // false
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œç¬¬ä¸€ä¸ªæ•°ç»„çš„0å·ä½ç½®æ˜¯æœ‰å€¼çš„ï¼Œç¬¬äºŒä¸ªæ•°ç»„çš„0å·ä½ç½®æ²¡æœ‰å€¼ã€‚

ES5å¯¹ç©ºä½çš„å¤„ç†ï¼Œå·²ç»å¾ˆä¸ä¸€è‡´äº†ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¼šå¿½ç•¥ç©ºä½ã€‚

forEach(), filter(), every() å’Œsome()éƒ½ä¼šè·³è¿‡ç©ºä½ã€‚
map()ä¼šè·³è¿‡ç©ºä½ï¼Œä½†ä¼šä¿ç•™è¿™ä¸ªå€¼
join()å’ŒtoString()ä¼šå°†ç©ºä½è§†ä¸ºundefinedï¼Œè€Œundefinedå’Œnullä¼šè¢«å¤„ç†æˆç©ºå­—ç¬¦ä¸²ã€‚
// forEachæ–¹æ³•
[,'a'].forEach((x,i) => console.log(i)); // 1

// filteræ–¹æ³•
['a',,'b'].filter(x => true) // ['a','b']

// everyæ–¹æ³•
[,'a'].every(x => x==='a') // true

// someæ–¹æ³•
[,'a'].some(x => x !== 'a') // false

// mapæ–¹æ³•
[,'a'].map(x => 1) // [,1]

// joinæ–¹æ³•
[,'a',undefined,null].join('#') // "#a##"

// toStringæ–¹æ³•
[,'a',undefined,null].toString() // ",a,,"
ES6åˆ™æ˜¯æ˜ç¡®å°†ç©ºä½è½¬ä¸ºundefinedã€‚

Array.fromæ–¹æ³•ä¼šå°†æ•°ç»„çš„ç©ºä½ï¼Œè½¬ä¸ºundefinedï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ä¼šå¿½ç•¥ç©ºä½ã€‚

Array.from(['a',,'b'])
// [ "a", undefined, "b" ]
æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ä¹Ÿä¼šå°†ç©ºä½è½¬ä¸ºundefinedã€‚

[...['a',,'b']]
// [ "a", undefined, "b" ]
copyWithin()ä¼šè¿ç©ºä½ä¸€èµ·æ‹·è´ã€‚

[,'a','b',,].copyWithin(2,0) // [,"a",,"a"]
fill()ä¼šå°†ç©ºä½è§†ä¸ºæ­£å¸¸çš„æ•°ç»„ä½ç½®ã€‚

new Array(3).fill('a') // ["a","a","a"]
for...ofå¾ªç¯ä¹Ÿä¼šéå†ç©ºä½ã€‚

let arr = [, ,];
for (let i of arr) {
  console.log(1);
}
// 1
// 1
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„arræœ‰ä¸¤ä¸ªç©ºä½ï¼Œfor...ofå¹¶æ²¡æœ‰å¿½ç•¥å®ƒä»¬ã€‚å¦‚æœæ”¹æˆmapæ–¹æ³•éå†ï¼Œç©ºä½æ˜¯ä¼šè·³è¿‡çš„ã€‚

entries()ã€keys()ã€values()ã€find()å’ŒfindIndex()ä¼šå°†ç©ºä½å¤„ç†æˆundefinedã€‚

// entries()
[...[,'a'].entries()] // [[0,undefined], [1,"a"]]

// keys()
[...[,'a'].keys()] // [0,1]

// values()
[...[,'a'].values()] // [undefined,"a"]

// find()
[,'a'].find(x => true) // undefined

// findIndex()
[,'a'].findIndex(x => true) // 0
ç”±äºç©ºä½çš„å¤„ç†è§„åˆ™éå¸¸ä¸ç»Ÿä¸€ï¼Œæ‰€ä»¥å»ºè®®é¿å…å‡ºç°ç©ºä½ã€‚Array.from()
Array.fromæ–¹æ³•ç”¨äºå°†ä¸¤ç±»å¯¹è±¡è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼šç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼ˆarray-like objectï¼‰å’Œå¯éå†ï¼ˆiterableï¼‰çš„å¯¹è±¡ï¼ˆåŒ…æ‹¬ES6æ–°å¢çš„æ•°æ®ç»“æ„Setå’ŒMapï¼‰ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼ŒArray.fromå°†å®ƒè½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

let arrayLike = {
    '0': 'a',
    '1': 'b',
    '2': 'c',
    length: 3
};

// ES5çš„å†™æ³•
var arr1 = [].slice.call(arrayLike); // ['a', 'b', 'c']

// ES6çš„å†™æ³•
let arr2 = Array.from(arrayLike); // ['a', 'b', 'c']
å®é™…åº”ç”¨ä¸­ï¼Œå¸¸è§çš„ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡æ˜¯DOMæ“ä½œè¿”å›çš„NodeListé›†åˆï¼Œä»¥åŠå‡½æ•°å†…éƒ¨çš„argumentså¯¹è±¡ã€‚Array.froméƒ½å¯ä»¥å°†å®ƒä»¬è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

// NodeListå¯¹è±¡
let ps = document.querySelectorAll('p');
Array.from(ps).forEach(function (p) {
  console.log(p);
});

// argumentså¯¹è±¡
function foo() {
  var args = Array.from(arguments);
  // ...
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒquerySelectorAllæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œåªæœ‰å°†è¿™ä¸ªå¯¹è±¡è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼Œæ‰èƒ½ä½¿ç”¨forEachæ–¹æ³•ã€‚

åªè¦æ˜¯éƒ¨ç½²äº†Iteratoræ¥å£çš„æ•°æ®ç»“æ„ï¼ŒArray.froméƒ½èƒ½å°†å…¶è½¬ä¸ºæ•°ç»„ã€‚

Array.from('hello')
// ['h', 'e', 'l', 'l', 'o']

let namesSet = new Set(['a', 'b'])
Array.from(namesSet) // ['a', 'b']
ä¸Šé¢ä»£ç ä¸­ï¼Œå­—ç¬¦ä¸²å’ŒSetç»“æ„éƒ½å…·æœ‰Iteratoræ¥å£ï¼Œå› æ­¤å¯ä»¥è¢«Array.fromè½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼ŒArray.fromä¼šè¿”å›ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ–°æ•°ç»„ã€‚

Array.from([1, 2, 3])
// [1, 2, 3]
å€¼å¾—æé†’çš„æ˜¯ï¼Œæ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ä¹Ÿå¯ä»¥å°†æŸäº›æ•°æ®ç»“æ„è½¬ä¸ºæ•°ç»„ã€‚

// argumentså¯¹è±¡
function foo() {
  var args = [...arguments];
}

// NodeListå¯¹è±¡
[...document.querySelectorAll('div')]
æ‰©å±•è¿ç®—ç¬¦èƒŒåè°ƒç”¨çš„æ˜¯éå†å™¨æ¥å£ï¼ˆSymbol.iteratorï¼‰ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰éƒ¨ç½²è¿™ä¸ªæ¥å£ï¼Œå°±æ— æ³•è½¬æ¢ã€‚Array.fromæ–¹æ³•åˆ™æ˜¯è¿˜æ”¯æŒç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚æ‰€è°“ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œæœ¬è´¨ç‰¹å¾åªæœ‰ä¸€ç‚¹ï¼Œå³å¿…é¡»æœ‰lengthå±æ€§ã€‚å› æ­¤ï¼Œä»»ä½•æœ‰lengthå±æ€§çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥é€šè¿‡Array.fromæ–¹æ³•è½¬ä¸ºæ•°ç»„ï¼Œè€Œæ­¤æ—¶æ‰©å±•è¿ç®—ç¬¦å°±æ— æ³•è½¬æ¢ã€‚

Array.from({ length: 3 });
// [ undefined, undefined, undefined ]
ä¸Šé¢ä»£ç ä¸­ï¼ŒArray.fromè¿”å›äº†ä¸€ä¸ªå…·æœ‰ä¸‰ä¸ªæˆå‘˜çš„æ•°ç»„ï¼Œæ¯ä¸ªä½ç½®çš„å€¼éƒ½æ˜¯undefinedã€‚æ‰©å±•è¿ç®—ç¬¦è½¬æ¢ä¸äº†è¿™ä¸ªå¯¹è±¡ã€‚

å¯¹äºè¿˜æ²¡æœ‰éƒ¨ç½²è¯¥æ–¹æ³•çš„æµè§ˆå™¨ï¼Œå¯ä»¥ç”¨Array.prototype.sliceæ–¹æ³•æ›¿ä»£ã€‚

const toArray = (() =>
  Array.from ? Array.from : obj => [].slice.call(obj)
)();
Array.fromè¿˜å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œä½œç”¨ç±»ä¼¼äºæ•°ç»„çš„mapæ–¹æ³•ï¼Œç”¨æ¥å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†ï¼Œå°†å¤„ç†åçš„å€¼æ”¾å…¥è¿”å›çš„æ•°ç»„ã€‚

Array.from(arrayLike, x => x * x);
// ç­‰åŒäº
Array.from(arrayLike).map(x => x * x);

Array.from([1, 2, 3], (x) => x * x)
// [1, 4, 9]
ä¸‹é¢çš„ä¾‹å­æ˜¯å–å‡ºä¸€ç»„DOMèŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ã€‚

let spans = document.querySelectorAll('span.name');

// map()
let names1 = Array.prototype.map.call(spans, s => s.textContent);

// Array.from()
let names2 = Array.from(spans, s => s.textContent)
ä¸‹é¢çš„ä¾‹å­å°†æ•°ç»„ä¸­å¸ƒå°”å€¼ä¸ºfalseçš„æˆå‘˜è½¬ä¸º0ã€‚

Array.from([1, , 2, , 3], (n) => n || 0)
// [1, 0, 2, 0, 3]
å¦ä¸€ä¸ªä¾‹å­æ˜¯è¿”å›å„ç§æ•°æ®çš„ç±»å‹ã€‚

function typesOf () {
  return Array.from(arguments, value => typeof value)
}
typesOf(null, [], NaN)
// ['object', 'object', 'number']
å¦‚æœmapå‡½æ•°é‡Œé¢ç”¨åˆ°äº†thiså…³é”®å­—ï¼Œè¿˜å¯ä»¥ä¼ å…¥Array.fromçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨æ¥ç»‘å®šthisã€‚

Array.from()å¯ä»¥å°†å„ç§å€¼è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼Œå¹¶ä¸”è¿˜æä¾›mapåŠŸèƒ½ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€ï¼Œåªè¦æœ‰ä¸€ä¸ªåŸå§‹çš„æ•°æ®ç»“æ„ï¼Œä½ å°±å¯ä»¥å…ˆå¯¹å®ƒçš„å€¼è¿›è¡Œå¤„ç†ï¼Œç„¶åè½¬æˆè§„èŒƒçš„æ•°ç»„ç»“æ„ï¼Œè¿›è€Œå°±å¯ä»¥ä½¿ç”¨æ•°é‡ä¼—å¤šçš„æ•°ç»„æ–¹æ³•ã€‚

Array.from({ length: 2 }, () => 'jack')
// ['jack', 'jack']
ä¸Šé¢ä»£ç ä¸­ï¼ŒArray.fromçš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†ç¬¬äºŒä¸ªå‚æ•°è¿è¡Œçš„æ¬¡æ•°ã€‚è¿™ç§ç‰¹æ€§å¯ä»¥è®©è¯¥æ–¹æ³•çš„ç”¨æ³•å˜å¾—éå¸¸çµæ´»ã€‚

Array.from()çš„å¦ä¸€ä¸ªåº”ç”¨æ˜¯ï¼Œå°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°ç»„ï¼Œç„¶åè¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚å› ä¸ºå®ƒèƒ½æ­£ç¡®å¤„ç†å„ç§Unicodeå­—ç¬¦ï¼Œå¯ä»¥é¿å…JavaScriptå°†å¤§äº\uFFFFçš„Unicodeå­—ç¬¦ï¼Œç®—ä½œä¸¤ä¸ªå­—ç¬¦çš„bugã€‚

function countSymbols(string) {
  return Array.from(string).length;
}
Array.of()
Array.ofæ–¹æ³•ç”¨äºå°†ä¸€ç»„å€¼ï¼Œè½¬æ¢ä¸ºæ•°ç»„ã€‚

Array.of(3, 11, 8) // [3,11,8]
Array.of(3) // [3]
Array.of(3).length // 1
è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯å¼¥è¡¥æ•°ç»„æ„é€ å‡½æ•°Array()çš„ä¸è¶³ã€‚å› ä¸ºå‚æ•°ä¸ªæ•°çš„ä¸åŒï¼Œä¼šå¯¼è‡´Array()çš„è¡Œä¸ºæœ‰å·®å¼‚ã€‚

Array() // []
Array(3) // [, , ,]
Array(3, 11, 8) // [3, 11, 8]
ä¸Šé¢ä»£ç ä¸­ï¼ŒArrayæ–¹æ³•æ²¡æœ‰å‚æ•°ã€ä¸€ä¸ªå‚æ•°ã€ä¸‰ä¸ªå‚æ•°æ—¶ï¼Œè¿”å›ç»“æœéƒ½ä¸ä¸€æ ·ã€‚åªæœ‰å½“å‚æ•°ä¸ªæ•°ä¸å°‘äº2ä¸ªæ—¶ï¼ŒArray()æ‰ä¼šè¿”å›ç”±å‚æ•°ç»„æˆçš„æ–°æ•°ç»„ã€‚å‚æ•°ä¸ªæ•°åªæœ‰ä¸€ä¸ªæ—¶ï¼Œå®é™…ä¸Šæ˜¯æŒ‡å®šæ•°ç»„çš„é•¿åº¦ã€‚

Array.ofåŸºæœ¬ä¸Šå¯ä»¥ç”¨æ¥æ›¿ä»£Array()æˆ–new Array()ï¼Œå¹¶ä¸”ä¸å­˜åœ¨ç”±äºå‚æ•°ä¸åŒè€Œå¯¼è‡´çš„é‡è½½ã€‚å®ƒçš„è¡Œä¸ºéå¸¸ç»Ÿä¸€ã€‚

Array.of() // []
Array.of(undefined) // [undefined]
Array.of(1) // [1]
Array.of(1, 2) // [1, 2]
Array.ofæ€»æ˜¯è¿”å›å‚æ•°å€¼ç»„æˆçš„æ•°ç»„ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œå°±è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ã€‚

Array.ofæ–¹æ³•å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿå®ç°ã€‚

function ArrayOf(){
  return [].slice.call(arguments);
}
æ•°ç»„å®ä¾‹çš„copyWithin()
æ•°ç»„å®ä¾‹çš„copyWithinæ–¹æ³•ï¼Œåœ¨å½“å‰æ•°ç»„å†…éƒ¨ï¼Œå°†æŒ‡å®šä½ç½®çš„æˆå‘˜å¤åˆ¶åˆ°å…¶ä»–ä½ç½®ï¼ˆä¼šè¦†ç›–åŸæœ‰æˆå‘˜ï¼‰ï¼Œç„¶åè¿”å›å½“å‰æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä¼šä¿®æ”¹å½“å‰æ•°ç»„ã€‚

Array.prototype.copyWithin(target, start = 0, end = this.length)
å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ã€‚

targetï¼ˆå¿…éœ€ï¼‰ï¼šä»è¯¥ä½ç½®å¼€å§‹æ›¿æ¢æ•°æ®ã€‚
startï¼ˆå¯é€‰ï¼‰ï¼šä»è¯¥ä½ç½®å¼€å§‹è¯»å–æ•°æ®ï¼Œé»˜è®¤ä¸º0ã€‚å¦‚æœä¸ºè´Ÿå€¼ï¼Œè¡¨ç¤ºå€’æ•°ã€‚
endï¼ˆå¯é€‰ï¼‰ï¼šåˆ°è¯¥ä½ç½®å‰åœæ­¢è¯»å–æ•°æ®ï¼Œé»˜è®¤ç­‰äºæ•°ç»„é•¿åº¦ã€‚å¦‚æœä¸ºè´Ÿå€¼ï¼Œè¡¨ç¤ºå€’æ•°ã€‚
è¿™ä¸‰ä¸ªå‚æ•°éƒ½åº”è¯¥æ˜¯æ•°å€¼ï¼Œå¦‚æœä¸æ˜¯ï¼Œä¼šè‡ªåŠ¨è½¬ä¸ºæ•°å€¼ã€‚

[1, 2, 3, 4, 5].copyWithin(0, 3)
// [4, 5, 3, 4, 5]
ä¸Šé¢ä»£ç è¡¨ç¤ºå°†ä»3å·ä½ç›´åˆ°æ•°ç»„ç»“æŸçš„æˆå‘˜ï¼ˆ4å’Œ5ï¼‰ï¼Œå¤åˆ¶åˆ°ä»0å·ä½å¼€å§‹çš„ä½ç½®ï¼Œç»“æœè¦†ç›–äº†åŸæ¥çš„1å’Œ2ã€‚

ä¸‹é¢æ˜¯æ›´å¤šä¾‹å­ã€‚

// å°†3å·ä½å¤åˆ¶åˆ°0å·ä½
[1, 2, 3, 4, 5].copyWithin(0, 3, 4)
// [4, 2, 3, 4, 5]

// -2ç›¸å½“äº3å·ä½ï¼Œ-1ç›¸å½“äº4å·ä½
[1, 2, 3, 4, 5].copyWithin(0, -2, -1)
// [4, 2, 3, 4, 5]

// å°†3å·ä½å¤åˆ¶åˆ°0å·ä½
[].copyWithin.call({length: 5, 3: 1}, 0, 3)
// {0: 1, 3: 1, length: 5}

// å°†2å·ä½åˆ°æ•°ç»„ç»“æŸï¼Œå¤åˆ¶åˆ°0å·ä½
var i32a = new Int32Array([1, 2, 3, 4, 5]);
i32a.copyWithin(0, 2);
// Int32Array [3, 4, 5, 4, 5]

// å¯¹äºæ²¡æœ‰éƒ¨ç½²TypedArrayçš„copyWithinæ–¹æ³•çš„å¹³å°
// éœ€è¦é‡‡ç”¨ä¸‹é¢çš„å†™æ³•
[].copyWithin.call(new Int32Array([1, 2, 3, 4, 5]), 0, 3, 4);
// Int32Array [4, 2, 3, 4, 5]
æ•°ç»„å®ä¾‹çš„find()å’ŒfindIndex()
æ•°ç»„å®ä¾‹çš„findæ–¹æ³•ï¼Œç”¨äºæ‰¾å‡ºç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æ•°ç»„æˆå‘˜ã€‚å®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ‰€æœ‰æ•°ç»„æˆå‘˜ä¾æ¬¡æ‰§è¡Œè¯¥å›è°ƒå‡½æ•°ï¼Œç›´åˆ°æ‰¾å‡ºç¬¬ä¸€ä¸ªè¿”å›å€¼ä¸ºtrueçš„æˆå‘˜ï¼Œç„¶åè¿”å›è¯¥æˆå‘˜ã€‚å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æˆå‘˜ï¼Œåˆ™è¿”å›undefinedã€‚

[1, 4, -5, 10].find((n) => n < 0)
// -5
ä¸Šé¢ä»£ç æ‰¾å‡ºæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå°äº0çš„æˆå‘˜ã€‚

[1, 5, 10, 15].find(function(value, index, arr) {
  return value > 9;
}) // 10
ä¸Šé¢ä»£ç ä¸­ï¼Œfindæ–¹æ³•çš„å›è°ƒå‡½æ•°å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œä¾æ¬¡ä¸ºå½“å‰çš„å€¼ã€å½“å‰çš„ä½ç½®å’ŒåŸæ•°ç»„ã€‚

æ•°ç»„å®ä¾‹çš„findIndexæ–¹æ³•çš„ç”¨æ³•ä¸findæ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æ•°ç»„æˆå‘˜çš„ä½ç½®ï¼Œå¦‚æœæ‰€æœ‰æˆå‘˜éƒ½ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›-1ã€‚

[1, 5, 10, 15].findIndex(function(value, index, arr) {
  return value > 9;
}) // 2
è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥ç»‘å®šå›è°ƒå‡½æ•°çš„thiså¯¹è±¡ã€‚

å¦å¤–ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å‘ç°NaNï¼Œå¼¥è¡¥äº†æ•°ç»„çš„IndexOfæ–¹æ³•çš„ä¸è¶³ã€‚

[NaN].indexOf(NaN)
// -1

[NaN].findIndex(y => Object.is(NaN, y))
// 0
ä¸Šé¢ä»£ç ä¸­ï¼ŒindexOfæ–¹æ³•æ— æ³•è¯†åˆ«æ•°ç»„çš„NaNæˆå‘˜ï¼Œä½†æ˜¯findIndexæ–¹æ³•å¯ä»¥å€ŸåŠ©Object.isæ–¹æ³•åšåˆ°ã€‚

æ•°ç»„å®ä¾‹çš„fill()
fillæ–¹æ³•ä½¿ç”¨ç»™å®šå€¼ï¼Œå¡«å……ä¸€ä¸ªæ•°ç»„ã€‚

['a', 'b', 'c'].fill(7)
// [7, 7, 7]

new Array(3).fill(7)
// [7, 7, 7]
ä¸Šé¢ä»£ç è¡¨æ˜ï¼Œfillæ–¹æ³•ç”¨äºç©ºæ•°ç»„çš„åˆå§‹åŒ–éå¸¸æ–¹ä¾¿ã€‚æ•°ç»„ä¸­å·²æœ‰çš„å…ƒç´ ï¼Œä¼šè¢«å…¨éƒ¨æŠ¹å»ã€‚

fillæ–¹æ³•è¿˜å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®šå¡«å……çš„èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚

['a', 'b', 'c'].fill(7, 1, 2)
// ['a', 7, 'c']
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œfillæ–¹æ³•ä»1å·ä½å¼€å§‹ï¼Œå‘åŸæ•°ç»„å¡«å……7ï¼Œåˆ°2å·ä½ä¹‹å‰ç»“æŸã€‚

æ•°ç»„å®ä¾‹çš„entries()ï¼Œkeys()å’Œvalues()
ES6æä¾›ä¸‰ä¸ªæ–°çš„æ–¹æ³•â€”â€”entries()ï¼Œkeys()å’Œvalues()â€”â€”ç”¨äºéå†æ•°ç»„ã€‚å®ƒä»¬éƒ½è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼ˆè¯¦è§ã€ŠIteratorã€‹ä¸€ç« ï¼‰ï¼Œå¯ä»¥ç”¨for...ofå¾ªç¯è¿›è¡Œéå†ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯keys()æ˜¯å¯¹é”®åçš„éå†ã€values()æ˜¯å¯¹é”®å€¼çš„éå†ï¼Œentries()æ˜¯å¯¹é”®å€¼å¯¹çš„éå†ã€‚

for (let index of ['a', 'b'].keys()) {
  console.log(index);
}
// 0
// 1

for (let elem of ['a', 'b'].values()) {
  console.log(elem);
}
// 'a'
// 'b'

for (let [index, elem] of ['a', 'b'].entries()) {
  console.log(index, elem);
}
// 0 "a"
// 1 "b"
å¦‚æœä¸ä½¿ç”¨for...ofå¾ªç¯ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œè¿›è¡Œéå†ã€‚

let letter = ['a', 'b', 'c'];
let entries = letter.entries();
console.log(entries.next().value); // [0, 'a']
console.log(entries.next().value); // [1, 'b']
console.log(entries.next().value); // [2, 'c']
æ•°ç»„å®ä¾‹çš„includes()
Array.prototype.includesæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæŸä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ç»™å®šçš„å€¼ï¼Œä¸å­—ç¬¦ä¸²çš„includesæ–¹æ³•ç±»ä¼¼ã€‚è¯¥æ–¹æ³•å±äºES7ï¼Œä½†Babelè½¬ç å™¨å·²ç»æ”¯æŒã€‚

[1, 2, 3].includes(2);     // true
[1, 2, 3].includes(4);     // false
[1, 2, NaN].includes(NaN); // true
è¯¥æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæœç´¢çš„èµ·å§‹ä½ç½®ï¼Œé»˜è®¤ä¸º0ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤ºå€’æ•°çš„ä½ç½®ï¼Œå¦‚æœè¿™æ—¶å®ƒå¤§äºæ•°ç»„é•¿åº¦ï¼ˆæ¯”å¦‚ç¬¬äºŒä¸ªå‚æ•°ä¸º-4ï¼Œä½†æ•°ç»„é•¿åº¦ä¸º3ï¼‰ï¼Œåˆ™ä¼šé‡ç½®ä¸ºä»0å¼€å§‹ã€‚

[1, 2, 3].includes(3, 3);  // false
[1, 2, 3].includes(3, -1); // true
æ²¡æœ‰è¯¥æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ•°ç»„çš„indexOfæ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªå€¼ã€‚

if (arr.indexOf(el) !== -1) {
  // ...
}
indexOfæ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œä¸€æ˜¯ä¸å¤Ÿè¯­ä¹‰åŒ–ï¼Œå®ƒçš„å«ä¹‰æ˜¯æ‰¾åˆ°å‚æ•°å€¼çš„ç¬¬ä¸€ä¸ªå‡ºç°ä½ç½®ï¼Œæ‰€ä»¥è¦å»æ¯”è¾ƒæ˜¯å¦ä¸ç­‰äº-1ï¼Œè¡¨è¾¾èµ·æ¥ä¸å¤Ÿç›´è§‚ã€‚äºŒæ˜¯ï¼Œå®ƒå†…éƒ¨ä½¿ç”¨ä¸¥æ ¼ç›¸å½“è¿ç®—ç¬¦ï¼ˆ===ï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¼šå¯¼è‡´å¯¹NaNçš„è¯¯åˆ¤ã€‚

[NaN].indexOf(NaN)
// -1
includesä½¿ç”¨çš„æ˜¯ä¸ä¸€æ ·çš„åˆ¤æ–­ç®—æ³•ï¼Œå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚

[NaN].includes(NaN)
// true
ä¸‹é¢ä»£ç ç”¨æ¥æ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦æ”¯æŒè¯¥æ–¹æ³•ï¼Œå¦‚æœä¸æ”¯æŒï¼Œéƒ¨ç½²ä¸€ä¸ªç®€æ˜“çš„æ›¿ä»£ç‰ˆæœ¬ã€‚

const contains = (() =>
  Array.prototype.includes
    ? (arr, value) => arr.includes(value)
    : (arr, value) => arr.some(el => el === value)
)();
contains(["foo", "bar"], "baz"); // => false
å¦å¤–ï¼ŒMapå’ŒSetæ•°æ®ç»“æ„æœ‰ä¸€ä¸ªhasæ–¹æ³•ï¼Œéœ€è¦æ³¨æ„ä¸includesåŒºåˆ†ã€‚

Mapç»“æ„çš„hasæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥æŸ¥æ‰¾é”®åçš„ï¼Œæ¯”å¦‚Map.prototype.has(key)ã€WeakMap.prototype.has(key)ã€Reflect.has(target, propertyKey)ã€‚
Setç»“æ„çš„hasæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥æŸ¥æ‰¾å€¼çš„ï¼Œæ¯”å¦‚Set.prototype.has(value)ã€WeakSet.prototype.has(value)ã€‚
æ•°ç»„çš„ç©ºä½
æ•°ç»„çš„ç©ºä½æŒ‡ï¼Œæ•°ç»„çš„æŸä¸€ä¸ªä½ç½®æ²¡æœ‰ä»»ä½•å€¼ã€‚æ¯”å¦‚ï¼ŒArrayæ„é€ å‡½æ•°è¿”å›çš„æ•°ç»„éƒ½æ˜¯ç©ºä½ã€‚

Array(3) // [, , ,]
ä¸Šé¢ä»£ç ä¸­ï¼ŒArray(3)è¿”å›ä¸€ä¸ªå…·æœ‰3ä¸ªç©ºä½çš„æ•°ç»„ã€‚

æ³¨æ„ï¼Œç©ºä½ä¸æ˜¯undefinedï¼Œä¸€ä¸ªä½ç½®çš„å€¼ç­‰äºundefinedï¼Œä¾ç„¶æ˜¯æœ‰å€¼çš„ã€‚ç©ºä½æ˜¯æ²¡æœ‰ä»»ä½•å€¼ï¼Œinè¿ç®—ç¬¦å¯ä»¥è¯´æ˜è¿™ä¸€ç‚¹ã€‚

0 in [undefined, undefined, undefined] // true
0 in [, , ,] // false
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œç¬¬ä¸€ä¸ªæ•°ç»„çš„0å·ä½ç½®æ˜¯æœ‰å€¼çš„ï¼Œç¬¬äºŒä¸ªæ•°ç»„çš„0å·ä½ç½®æ²¡æœ‰å€¼ã€‚

ES5å¯¹ç©ºä½çš„å¤„ç†ï¼Œå·²ç»å¾ˆä¸ä¸€è‡´äº†ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¼šå¿½ç•¥ç©ºä½ã€‚

forEach(), filter(), every() å’Œsome()éƒ½ä¼šè·³è¿‡ç©ºä½ã€‚
map()ä¼šè·³è¿‡ç©ºä½ï¼Œä½†ä¼šä¿ç•™è¿™ä¸ªå€¼
join()å’ŒtoString()ä¼šå°†ç©ºä½è§†ä¸ºundefinedï¼Œè€Œundefinedå’Œnullä¼šè¢«å¤„ç†æˆç©ºå­—ç¬¦ä¸²ã€‚
// forEachæ–¹æ³•
[,'a'].forEach((x,i) => console.log(i)); // 1

// filteræ–¹æ³•
['a',,'b'].filter(x => true) // ['a','b']

// everyæ–¹æ³•
[,'a'].every(x => x==='a') // true

// someæ–¹æ³•
[,'a'].some(x => x !== 'a') // false

// mapæ–¹æ³•
[,'a'].map(x => 1) // [,1]

// joinæ–¹æ³•
[,'a',undefined,null].join('#') // "#a##"

// toStringæ–¹æ³•
[,'a',undefined,null].toString() // ",a,,"
ES6åˆ™æ˜¯æ˜ç¡®å°†ç©ºä½è½¬ä¸ºundefinedã€‚

Array.fromæ–¹æ³•ä¼šå°†æ•°ç»„çš„ç©ºä½ï¼Œè½¬ä¸ºundefinedï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ä¼šå¿½ç•¥ç©ºä½ã€‚

Array.from(['a',,'b'])
// [ "a", undefined, "b" ]
æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ä¹Ÿä¼šå°†ç©ºä½è½¬ä¸ºundefinedã€‚

[...['a',,'b']]
// [ "a", undefined, "b" ]
copyWithin()ä¼šè¿ç©ºä½ä¸€èµ·æ‹·è´ã€‚

[,'a','b',,].copyWithin(2,0) // [,"a",,"a"]
fill()ä¼šå°†ç©ºä½è§†ä¸ºæ­£å¸¸çš„æ•°ç»„ä½ç½®ã€‚

new Array(3).fill('a') // ["a","a","a"]
for...ofå¾ªç¯ä¹Ÿä¼šéå†ç©ºä½ã€‚

let arr = [, ,];
for (let i of arr) {
  console.log(1);
}
// 1
// 1
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„arræœ‰ä¸¤ä¸ªç©ºä½ï¼Œfor...ofå¹¶æ²¡æœ‰å¿½ç•¥å®ƒä»¬ã€‚å¦‚æœæ”¹æˆmapæ–¹æ³•éå†ï¼Œç©ºä½æ˜¯ä¼šè·³è¿‡çš„ã€‚

entries()ã€keys()ã€values()ã€find()å’ŒfindIndex()ä¼šå°†ç©ºä½å¤„ç†æˆundefinedã€‚

// entries()
[...[,'a'].entries()] // [[0,undefined], [1,"a"]]

// keys()
[...[,'a'].keys()] // [0,1]

// values()
[...[,'a'].values()] // [undefined,"a"]

// find()
[,'a'].find(x => true) // undefined

// findIndex()
[,'a'].findIndex(x => true) // 0
ç”±äºç©ºä½çš„å¤„ç†è§„åˆ™éå¸¸ä¸ç»Ÿä¸€ï¼Œæ‰€ä»¥å»ºè®®é¿å…å‡ºç°ç©ºä½ã€‚

##å‡½æ•°çš„æ‰©å±•
1.å‡½æ•°å‚æ•°çš„é»˜è®¤å€¼
åŸºæœ¬ç”¨æ³•
åœ¨ES6ä¹‹å‰ï¼Œä¸èƒ½ç›´æ¥ä¸ºå‡½æ•°çš„å‚æ•°æŒ‡å®šé»˜è®¤å€¼ï¼Œåªèƒ½é‡‡ç”¨å˜é€šçš„æ–¹æ³•ã€‚

function log(x, y) {
  y = y || 'World';
  console.log(x, y);
}

log('Hello') // Hello World
log('Hello', 'China') // Hello China
log('Hello', '') // Hello World
ä¸Šé¢ä»£ç æ£€æŸ¥å‡½æ•°logçš„å‚æ•°yæœ‰æ²¡æœ‰èµ‹å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æŒ‡å®šé»˜è®¤å€¼ä¸ºWorldã€‚è¿™ç§å†™æ³•çš„ç¼ºç‚¹åœ¨äºï¼Œå¦‚æœå‚æ•°yèµ‹å€¼äº†ï¼Œä½†æ˜¯å¯¹åº”çš„å¸ƒå°”å€¼ä¸ºfalseï¼Œåˆ™è¯¥èµ‹å€¼ä¸èµ·ä½œç”¨ã€‚å°±åƒä¸Šé¢ä»£ç çš„æœ€åä¸€è¡Œï¼Œå‚æ•°yç­‰äºç©ºå­—ç¬¦ï¼Œç»“æœè¢«æ”¹ä¸ºé»˜è®¤å€¼ã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œé€šå¸¸éœ€è¦å…ˆåˆ¤æ–­ä¸€ä¸‹å‚æ•°yæ˜¯å¦è¢«èµ‹å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†ç­‰äºé»˜è®¤å€¼ã€‚

if (typeof y === 'undefined') {
  y = 'World';
}
ES6å…è®¸ä¸ºå‡½æ•°çš„å‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œå³ç›´æ¥å†™åœ¨å‚æ•°å®šä¹‰çš„åé¢ã€‚

function log(x, y = 'World') {
  console.log(x, y);
}

log('Hello') // Hello World
log('Hello', 'China') // Hello China
log('Hello', '') // Hello
å¯ä»¥çœ‹åˆ°ï¼ŒES6çš„å†™æ³•æ¯”ES5ç®€æ´è®¸å¤šï¼Œè€Œä¸”éå¸¸è‡ªç„¶ã€‚ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

function Point(x = 0, y = 0) {
  this.x = x;
  this.y = y;
}

var p = new Point();
p // { x: 0, y: 0 }
é™¤äº†ç®€æ´ï¼ŒES6çš„å†™æ³•è¿˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼šé¦–å…ˆï¼Œé˜…è¯»ä»£ç çš„äººï¼Œå¯ä»¥ç«‹åˆ»æ„è¯†åˆ°å“ªäº›å‚æ•°æ˜¯å¯ä»¥çœç•¥çš„ï¼Œä¸ç”¨æŸ¥çœ‹å‡½æ•°ä½“æˆ–æ–‡æ¡£ï¼›å…¶æ¬¡ï¼Œæœ‰åˆ©äºå°†æ¥çš„ä»£ç ä¼˜åŒ–ï¼Œå³ä½¿æœªæ¥çš„ç‰ˆæœ¬åœ¨å¯¹å¤–æ¥å£ä¸­ï¼Œå½»åº•æ‹¿æ‰è¿™ä¸ªå‚æ•°ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ä»¥å‰çš„ä»£ç æ— æ³•è¿è¡Œã€‚

å‚æ•°å˜é‡æ˜¯é»˜è®¤å£°æ˜çš„ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨letæˆ–constå†æ¬¡å£°æ˜ã€‚

function foo(x = 5) {
  let x = 1; // error
  const x = 2; // error
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå‚æ•°å˜é‡xæ˜¯é»˜è®¤å£°æ˜çš„ï¼Œåœ¨å‡½æ•°ä½“ä¸­ï¼Œä¸èƒ½ç”¨letæˆ–constå†æ¬¡å£°æ˜ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

ä¸è§£æ„èµ‹å€¼é»˜è®¤å€¼ç»“åˆä½¿ç”¨
å‚æ•°é»˜è®¤å€¼å¯ä»¥ä¸è§£æ„èµ‹å€¼çš„é»˜è®¤å€¼ï¼Œç»“åˆèµ·æ¥ä½¿ç”¨ã€‚

function foo({x, y = 5}) {
  console.log(x, y);
}

foo({}) // undefined, 5
foo({x: 1}) // 1, 5
foo({x: 1, y: 2}) // 1, 2
foo() // TypeError: Cannot read property 'x' of undefined
ä¸Šé¢ä»£ç ä½¿ç”¨äº†å¯¹è±¡çš„è§£æ„èµ‹å€¼é»˜è®¤å€¼ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨å‡½æ•°å‚æ•°çš„é»˜è®¤å€¼ã€‚åªæœ‰å½“å‡½æ•°fooçš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå˜é‡xå’Œyæ‰ä¼šé€šè¿‡è§£æ„èµ‹å€¼è€Œç”Ÿæˆã€‚å¦‚æœå‡½æ•°fooè°ƒç”¨æ—¶å‚æ•°ä¸æ˜¯å¯¹è±¡ï¼Œå˜é‡xå’Œyå°±ä¸ä¼šç”Ÿæˆï¼Œä»è€ŒæŠ¥é”™ã€‚å¦‚æœå‚æ•°å¯¹è±¡æ²¡æœ‰yå±æ€§ï¼Œyçš„é»˜è®¤å€¼5æ‰ä¼šç”Ÿæ•ˆã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªå¯¹è±¡çš„è§£æ„èµ‹å€¼é»˜è®¤å€¼çš„ä¾‹å­ã€‚

function fetch(url, { body = '', method = 'GET', headers = {} }) {
  console.log(method);
}

fetch('http://example.com', {})
// "GET"

fetch('http://example.com')
// æŠ¥é”™
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœå‡½æ•°fetchçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥ä¸ºå®ƒçš„ä¸‰ä¸ªå±æ€§è®¾ç½®é»˜è®¤å€¼ã€‚

ä¸Šé¢çš„å†™æ³•ä¸èƒ½çœç•¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¦‚æœç»“åˆå‡½æ•°å‚æ•°çš„é»˜è®¤å€¼ï¼Œå°±å¯ä»¥çœç•¥ç¬¬äºŒä¸ªå‚æ•°ã€‚è¿™æ—¶ï¼Œå°±å‡ºç°äº†åŒé‡é»˜è®¤å€¼ã€‚

function fetch(url, { method = 'GET' } = {}) {
  console.log(method);
}

fetch('http://example.com')
// "GET"
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fetchæ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°æ—¶ï¼Œå‡½æ•°å‚æ•°çš„é»˜è®¤å€¼å°±ä¼šç”Ÿæ•ˆï¼Œç„¶åæ‰æ˜¯è§£æ„èµ‹å€¼çš„é»˜è®¤å€¼ç”Ÿæ•ˆï¼Œå˜é‡methodæ‰ä¼šå–åˆ°é»˜è®¤å€¼GETã€‚

å†è¯·é—®ä¸‹é¢ä¸¤ç§å†™æ³•æœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ

// å†™æ³•ä¸€
function m1({x = 0, y = 0} = {}) {
  return [x, y];
}

// å†™æ³•äºŒ
function m2({x, y} = { x: 0, y: 0 }) {
  return [x, y];
}
ä¸Šé¢ä¸¤ç§å†™æ³•éƒ½å¯¹å‡½æ•°çš„å‚æ•°è®¾å®šäº†é»˜è®¤å€¼ï¼ŒåŒºåˆ«æ˜¯å†™æ³•ä¸€å‡½æ•°å‚æ•°çš„é»˜è®¤å€¼æ˜¯ç©ºå¯¹è±¡ï¼Œä½†æ˜¯è®¾ç½®äº†å¯¹è±¡è§£æ„èµ‹å€¼çš„é»˜è®¤å€¼ï¼›å†™æ³•äºŒå‡½æ•°å‚æ•°çš„é»˜è®¤å€¼æ˜¯ä¸€ä¸ªæœ‰å…·ä½“å±æ€§çš„å¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®å¯¹è±¡è§£æ„èµ‹å€¼çš„é»˜è®¤å€¼ã€‚

// å‡½æ•°æ²¡æœ‰å‚æ•°çš„æƒ…å†µ
m1() // [0, 0]
m2() // [0, 0]

// xå’Œyéƒ½æœ‰å€¼çš„æƒ…å†µ
m1({x: 3, y: 8}) // [3, 8]
m2({x: 3, y: 8}) // [3, 8]

// xæœ‰å€¼ï¼Œyæ— å€¼çš„æƒ…å†µ
m1({x: 3}) // [3, 0]
m2({x: 3}) // [3, undefined]

// xå’Œyéƒ½æ— å€¼çš„æƒ…å†µ
m1({}) // [0, 0];
m2({}) // [undefined, undefined]

m1({z: 3}) // [0, 0]
m2({z: 3}) // [undefined, undefined]
å‚æ•°é»˜è®¤å€¼çš„ä½ç½®
é€šå¸¸æƒ…å†µä¸‹ï¼Œå®šä¹‰äº†é»˜è®¤å€¼çš„å‚æ•°ï¼Œåº”è¯¥æ˜¯å‡½æ•°çš„å°¾å‚æ•°ã€‚å› ä¸ºè¿™æ ·æ¯”è¾ƒå®¹æ˜“çœ‹å‡ºæ¥ï¼Œåˆ°åº•çœç•¥äº†å“ªäº›å‚æ•°ã€‚å¦‚æœéå°¾éƒ¨çš„å‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œå®é™…ä¸Šè¿™ä¸ªå‚æ•°æ˜¯æ²¡æ³•çœç•¥çš„ã€‚

// ä¾‹ä¸€
function f(x = 1, y) {
  return [x, y];
}

f() // [1, undefined]
f(2) // [2, undefined])
f(, 1) // æŠ¥é”™
f(undefined, 1) // [1, 1]

// ä¾‹äºŒ
function f(x, y = 5, z) {
  return [x, y, z];
}

f() // [undefined, 5, undefined]
f(1) // [1, 5, undefined]
f(1, ,2) // æŠ¥é”™
f(1, undefined, 2) // [1, 5, 2]
ä¸Šé¢ä»£ç ä¸­ï¼Œæœ‰é»˜è®¤å€¼çš„å‚æ•°éƒ½ä¸æ˜¯å°¾å‚æ•°ã€‚è¿™æ—¶ï¼Œæ— æ³•åªçœç•¥è¯¥å‚æ•°ï¼Œè€Œä¸çœç•¥å®ƒåé¢çš„å‚æ•°ï¼Œé™¤éæ˜¾å¼è¾“å…¥undefinedã€‚

å¦‚æœä¼ å…¥undefinedï¼Œå°†è§¦å‘è¯¥å‚æ•°ç­‰äºé»˜è®¤å€¼ï¼Œnullåˆ™æ²¡æœ‰è¿™ä¸ªæ•ˆæœã€‚

function foo(x = 5, y = 6) {
  console.log(x, y);
}

foo(undefined, null)
// 5 null
ä¸Šé¢ä»£ç ä¸­ï¼Œxå‚æ•°å¯¹åº”undefinedï¼Œç»“æœè§¦å‘äº†é»˜è®¤å€¼ï¼Œyå‚æ•°ç­‰äºnullï¼Œå°±æ²¡æœ‰è§¦å‘é»˜è®¤å€¼ã€‚

å‡½æ•°çš„lengthå±æ€§
æŒ‡å®šäº†é»˜è®¤å€¼ä»¥åï¼Œå‡½æ•°çš„lengthå±æ€§ï¼Œå°†è¿”å›æ²¡æœ‰æŒ‡å®šé»˜è®¤å€¼çš„å‚æ•°ä¸ªæ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŒ‡å®šäº†é»˜è®¤å€¼åï¼Œlengthå±æ€§å°†å¤±çœŸã€‚

(function (a) {}).length // 1
(function (a = 5) {}).length // 0
(function (a, b, c = 5) {}).length // 2
ä¸Šé¢ä»£ç ä¸­ï¼Œlengthå±æ€§çš„è¿”å›å€¼ï¼Œç­‰äºå‡½æ•°çš„å‚æ•°ä¸ªæ•°å‡å»æŒ‡å®šäº†é»˜è®¤å€¼çš„å‚æ•°ä¸ªæ•°ã€‚æ¯”å¦‚ï¼Œä¸Šé¢æœ€åä¸€ä¸ªå‡½æ•°ï¼Œå®šä¹‰äº†3ä¸ªå‚æ•°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå‚æ•°cæŒ‡å®šäº†é»˜è®¤å€¼ï¼Œå› æ­¤lengthå±æ€§ç­‰äº3å‡å»1ï¼Œæœ€åå¾—åˆ°2ã€‚

è¿™æ˜¯å› ä¸ºlengthå±æ€§çš„å«ä¹‰æ˜¯ï¼Œè¯¥å‡½æ•°é¢„æœŸä¼ å…¥çš„å‚æ•°ä¸ªæ•°ã€‚æŸä¸ªå‚æ•°æŒ‡å®šé»˜è®¤å€¼ä»¥åï¼Œé¢„æœŸä¼ å…¥çš„å‚æ•°ä¸ªæ•°å°±ä¸åŒ…æ‹¬è¿™ä¸ªå‚æ•°äº†ã€‚åŒç†ï¼Œrestå‚æ•°ä¹Ÿä¸ä¼šè®¡å…¥lengthå±æ€§ã€‚

(function(...args) {}).length // 0
å¦‚æœè®¾ç½®äº†é»˜è®¤å€¼çš„å‚æ•°ä¸æ˜¯å°¾å‚æ•°ï¼Œé‚£ä¹ˆlengthå±æ€§ä¹Ÿä¸å†è®¡å…¥åé¢çš„å‚æ•°äº†ã€‚

(function (a = 0, b, c) {}).length // 0
(function (a, b = 1, c) {}).length // 1
ä½œç”¨åŸŸ
ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå¦‚æœå‚æ•°é»˜è®¤å€¼æ˜¯ä¸€ä¸ªå˜é‡ï¼Œåˆ™è¯¥å˜é‡æ‰€å¤„çš„ä½œç”¨åŸŸï¼Œä¸å…¶ä»–å˜é‡çš„ä½œç”¨åŸŸè§„åˆ™æ˜¯ä¸€æ ·çš„ï¼Œå³å…ˆæ˜¯å½“å‰å‡½æ•°çš„ä½œç”¨åŸŸï¼Œç„¶åæ‰æ˜¯å…¨å±€ä½œç”¨åŸŸã€‚

var x = 1;

function f(x, y = x) {
  console.log(y);
}

f(2) // 2
ä¸Šé¢ä»£ç ä¸­ï¼Œå‚æ•°yçš„é»˜è®¤å€¼ç­‰äºxã€‚è°ƒç”¨æ—¶ï¼Œç”±äºå‡½æ•°ä½œç”¨åŸŸå†…éƒ¨çš„å˜é‡xå·²ç»ç”Ÿæˆï¼Œæ‰€ä»¥yç­‰äºå‚æ•°xï¼Œè€Œä¸æ˜¯å…¨å±€å˜é‡xã€‚

å¦‚æœè°ƒç”¨æ—¶ï¼Œå‡½æ•°ä½œç”¨åŸŸå†…éƒ¨çš„å˜é‡xæ²¡æœ‰ç”Ÿæˆï¼Œç»“æœå°±ä¼šä¸ä¸€æ ·ã€‚

let x = 1;

function f(y = x) {
  let x = 2;
  console.log(y);
}

f() // 1
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œyçš„é»˜è®¤å€¼å˜é‡xå°šæœªåœ¨å‡½æ•°å†…éƒ¨ç”Ÿæˆï¼Œæ‰€ä»¥xæŒ‡å‘å…¨å±€å˜é‡ã€‚

å¦‚æœæ­¤æ—¶ï¼Œå…¨å±€å˜é‡xä¸å­˜åœ¨ï¼Œå°±ä¼šæŠ¥é”™ã€‚

function f(y = x) {
  let x = 2;
  console.log(y);
}

f() // ReferenceError: x is not defined
ä¸‹é¢è¿™æ ·å†™ï¼Œä¹Ÿä¼šæŠ¥é”™ã€‚

var x = 1;

function foo(x = x) {
  // ...
}

foo() // ReferenceError: x is not defined
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fooçš„å‚æ•°xçš„é»˜è®¤å€¼ä¹Ÿæ˜¯xã€‚è¿™æ—¶ï¼Œé»˜è®¤å€¼xçš„ä½œç”¨åŸŸæ˜¯å‡½æ•°ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯å…¨å±€ä½œç”¨åŸŸã€‚ç”±äºåœ¨å‡½æ•°ä½œç”¨åŸŸä¸­ï¼Œå­˜åœ¨å˜é‡xï¼Œä½†æ˜¯é»˜è®¤å€¼åœ¨xèµ‹å€¼ä¹‹å‰å…ˆæ‰§è¡Œäº†ï¼Œæ‰€ä»¥è¿™æ—¶å±äºæš‚æ—¶æ€§æ­»åŒºï¼ˆå‚è§ã€Šletå’Œconstå‘½ä»¤ã€‹ä¸€ç« ï¼‰ï¼Œä»»ä½•å¯¹xçš„æ“ä½œéƒ½ä¼šæŠ¥é”™ã€‚

å¦‚æœå‚æ•°çš„é»˜è®¤å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨åŸŸæ˜¯å…¶å£°æ˜æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸã€‚è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

let foo = 'outer';

function bar(func = x => foo) {
  let foo = 'inner';
  console.log(func()); // outer
}

bar();
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°barçš„å‚æ•°funcçš„é»˜è®¤å€¼æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¿”å›å€¼ä¸ºå˜é‡fooã€‚è¿™ä¸ªåŒ¿åå‡½æ•°å£°æ˜æ—¶ï¼Œbarå‡½æ•°çš„ä½œç”¨åŸŸè¿˜æ²¡æœ‰å½¢æˆï¼Œæ‰€ä»¥åŒ¿åå‡½æ•°é‡Œé¢çš„fooæŒ‡å‘å¤–å±‚ä½œç”¨åŸŸçš„fooï¼Œè¾“å‡ºouterã€‚

å¦‚æœå†™æˆä¸‹é¢è¿™æ ·ï¼Œå°±ä¼šæŠ¥é”™ã€‚

function bar(func = () => foo) {
  let foo = 'inner';
  console.log(func());
}

bar() // ReferenceError: foo is not defined
ä¸Šé¢ä»£ç ä¸­ï¼ŒåŒ¿åå‡½æ•°é‡Œé¢çš„fooæŒ‡å‘å‡½æ•°å¤–å±‚ï¼Œä½†æ˜¯å‡½æ•°å¤–å±‚å¹¶æ²¡æœ‰å£°æ˜fooï¼Œæ‰€ä»¥å°±æŠ¥é”™äº†ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ã€‚

var x = 1;
function foo(x, y = function() { x = 2; }) {
  var x = 3;
  y();
  console.log(x);
}

foo() // 3
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fooçš„å‚æ•°yçš„é»˜è®¤å€¼æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚å‡½æ•°fooè°ƒç”¨æ—¶ï¼Œå®ƒçš„å‚æ•°xçš„å€¼ä¸ºundefinedï¼Œæ‰€ä»¥yå‡½æ•°å†…éƒ¨çš„xä¸€å¼€å§‹æ˜¯undefinedï¼Œåæ¥è¢«é‡æ–°èµ‹å€¼2ã€‚ä½†æ˜¯ï¼Œå‡½æ•°fooå†…éƒ¨é‡æ–°å£°æ˜äº†ä¸€ä¸ªxï¼Œå€¼ä¸º3ï¼Œè¿™ä¸¤ä¸ªxæ˜¯ä¸ä¸€æ ·çš„ï¼Œäº’ç›¸ä¸äº§ç”Ÿå½±å“ï¼Œå› æ­¤æœ€åè¾“å‡º3ã€‚

å¦‚æœå°†var x = 3çš„varå»é™¤ï¼Œä¸¤ä¸ªxå°±æ˜¯ä¸€æ ·çš„ï¼Œæœ€åè¾“å‡ºçš„å°±æ˜¯2ã€‚

var x = 1;
function foo(x, y = function() { x = 2; }) {
  x = 3;
  y();
  console.log(x);
}

foo() // 2
åº”ç”¨
åˆ©ç”¨å‚æ•°é»˜è®¤å€¼ï¼Œå¯ä»¥æŒ‡å®šæŸä¸€ä¸ªå‚æ•°ä¸å¾—çœç•¥ï¼Œå¦‚æœçœç•¥å°±æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

function throwIfMissing() {
  throw new Error('Missing parameter');
}

function foo(mustBeProvided = throwIfMissing()) {
  return mustBeProvided;
}

foo()
// Error: Missing parameter
ä¸Šé¢ä»£ç çš„fooå‡½æ•°ï¼Œå¦‚æœè°ƒç”¨çš„æ—¶å€™æ²¡æœ‰å‚æ•°ï¼Œå°±ä¼šè°ƒç”¨é»˜è®¤å€¼throwIfMissingå‡½æ•°ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

ä»ä¸Šé¢ä»£ç è¿˜å¯ä»¥çœ‹åˆ°ï¼Œå‚æ•°mustBeProvidedçš„é»˜è®¤å€¼ç­‰äºthrowIfMissingå‡½æ•°çš„è¿è¡Œç»“æœï¼ˆå³å‡½æ•°åä¹‹åæœ‰ä¸€å¯¹åœ†æ‹¬å·ï¼‰ï¼Œè¿™è¡¨æ˜å‚æ•°çš„é»˜è®¤å€¼ä¸æ˜¯åœ¨å®šä¹‰æ—¶æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼ˆå³å¦‚æœå‚æ•°å·²ç»èµ‹å€¼ï¼Œé»˜è®¤å€¼ä¸­çš„å‡½æ•°å°±ä¸ä¼šè¿è¡Œï¼‰ï¼Œè¿™ä¸pythonè¯­è¨€ä¸ä¸€æ ·ã€‚

å¦å¤–ï¼Œå¯ä»¥å°†å‚æ•°é»˜è®¤å€¼è®¾ä¸ºundefinedï¼Œè¡¨æ˜è¿™ä¸ªå‚æ•°æ˜¯å¯ä»¥çœç•¥çš„ã€‚

function foo(optional = undefined) { Â·Â·Â· }
restå‚æ•°
ES6å¼•å…¥restå‚æ•°ï¼ˆå½¢å¼ä¸ºâ€œ...å˜é‡åâ€ï¼‰ï¼Œç”¨äºè·å–å‡½æ•°çš„å¤šä½™å‚æ•°ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä½¿ç”¨argumentså¯¹è±¡äº†ã€‚restå‚æ•°æ­é…çš„å˜é‡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥å˜é‡å°†å¤šä½™çš„å‚æ•°æ”¾å…¥æ•°ç»„ä¸­ã€‚

function add(...values) {
  let sum = 0;

  for (var val of values) {
    sum += val;
  }

  return sum;
}

add(2, 5, 3) // 10
ä¸Šé¢ä»£ç çš„addå‡½æ•°æ˜¯ä¸€ä¸ªæ±‚å’Œå‡½æ•°ï¼Œåˆ©ç”¨restå‚æ•°ï¼Œå¯ä»¥å‘è¯¥å‡½æ•°ä¼ å…¥ä»»æ„æ•°ç›®çš„å‚æ•°ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªrestå‚æ•°ä»£æ›¿argumentså˜é‡çš„ä¾‹å­ã€‚

// argumentså˜é‡çš„å†™æ³•
function sortNumbers() {
  return Array.prototype.slice.call(arguments).sort();
}

// restå‚æ•°çš„å†™æ³•
const sortNumbers = (...numbers) => numbers.sort();
ä¸Šé¢ä»£ç çš„ä¸¤ç§å†™æ³•ï¼Œæ¯”è¾ƒåå¯ä»¥å‘ç°ï¼Œrestå‚æ•°çš„å†™æ³•æ›´è‡ªç„¶ä¹Ÿæ›´ç®€æ´ã€‚

restå‚æ•°ä¸­çš„å˜é‡ä»£è¡¨ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥æ•°ç»„ç‰¹æœ‰çš„æ–¹æ³•éƒ½å¯ä»¥ç”¨äºè¿™ä¸ªå˜é‡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ©ç”¨restå‚æ•°æ”¹å†™æ•°ç»„pushæ–¹æ³•çš„ä¾‹å­ã€‚

function push(array, ...items) {
  items.forEach(function(item) {
    array.push(item);
    console.log(item);
  });
}

var a = [];
push(a, 1, 2, 3)
æ³¨æ„ï¼Œrestå‚æ•°ä¹‹åä¸èƒ½å†æœ‰å…¶ä»–å‚æ•°ï¼ˆå³åªèƒ½æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

// æŠ¥é”™
function f(a, ...b, c) {
  // ...
}
å‡½æ•°çš„lengthå±æ€§ï¼Œä¸åŒ…æ‹¬restå‚æ•°ã€‚

(function(a) {}).length  // 1
(function(...a) {}).length  // 0
(function(a, ...b) {}).length  // 1
æ‰©å±•è¿ç®—ç¬¦
å«ä¹‰
æ‰©å±•è¿ç®—ç¬¦ï¼ˆspreadï¼‰æ˜¯ä¸‰ä¸ªç‚¹ï¼ˆ...ï¼‰ã€‚å®ƒå¥½æ¯”restå‚æ•°çš„é€†è¿ç®—ï¼Œå°†ä¸€ä¸ªæ•°ç»„è½¬ä¸ºç”¨é€—å·åˆ†éš”çš„å‚æ•°åºåˆ—ã€‚

console.log(...[1, 2, 3])
// 1 2 3

console.log(1, ...[2, 3, 4], 5)
// 1 2 3 4 5

[...document.querySelectorAll('div')]
// [<div>, <div>, <div>]
è¯¥è¿ç®—ç¬¦ä¸»è¦ç”¨äºå‡½æ•°è°ƒç”¨ã€‚

function push(array, ...items) {
  array.push(...items);
}

function add(x, y) {
  return x + y;
}

var numbers = [4, 38];
add(...numbers) // 42
ä¸Šé¢ä»£ç ä¸­ï¼Œarray.push(...items)å’Œadd(...numbers)è¿™ä¸¤è¡Œï¼Œéƒ½æ˜¯å‡½æ•°çš„è°ƒç”¨ï¼Œå®ƒä»¬çš„éƒ½ä½¿ç”¨äº†æ‰©å±•è¿ç®—ç¬¦ã€‚è¯¥è¿ç®—ç¬¦å°†ä¸€ä¸ªæ•°ç»„ï¼Œå˜ä¸ºå‚æ•°åºåˆ—ã€‚

æ‰©å±•è¿ç®—ç¬¦ä¸æ­£å¸¸çš„å‡½æ•°å‚æ•°å¯ä»¥ç»“åˆä½¿ç”¨ï¼Œéå¸¸çµæ´»ã€‚

function f(v, w, x, y, z) { }
var args = [0, 1];
f(-1, ...args, 2, ...[3]);
æ›¿ä»£æ•°ç»„çš„applyæ–¹æ³•
ç”±äºæ‰©å±•è¿ç®—ç¬¦å¯ä»¥å±•å¼€æ•°ç»„ï¼Œæ‰€ä»¥ä¸å†éœ€è¦applyæ–¹æ³•ï¼Œå°†æ•°ç»„è½¬ä¸ºå‡½æ•°çš„å‚æ•°äº†ã€‚

// ES5çš„å†™æ³•
function f(x, y, z) {
  // ...
}
var args = [0, 1, 2];
f.apply(null, args);

// ES6çš„å†™æ³•
function f(x, y, z) {
  // ...
}
var args = [0, 1, 2];
f(...args);
ä¸‹é¢æ˜¯æ‰©å±•è¿ç®—ç¬¦å–ä»£applyæ–¹æ³•çš„ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œåº”ç”¨Math.maxæ–¹æ³•ï¼Œç®€åŒ–æ±‚å‡ºä¸€ä¸ªæ•°ç»„æœ€å¤§å…ƒç´ çš„å†™æ³•ã€‚

// ES5çš„å†™æ³•
Math.max.apply(null, [14, 3, 77])

// ES6çš„å†™æ³•
Math.max(...[14, 3, 77])

// ç­‰åŒäº
Math.max(14, 3, 77);
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œç”±äºJavaScriptä¸æä¾›æ±‚æ•°ç»„æœ€å¤§å…ƒç´ çš„å‡½æ•°ï¼Œæ‰€ä»¥åªèƒ½å¥—ç”¨Math.maxå‡½æ•°ï¼Œå°†æ•°ç»„è½¬ä¸ºä¸€ä¸ªå‚æ•°åºåˆ—ï¼Œç„¶åæ±‚æœ€å¤§å€¼ã€‚æœ‰äº†æ‰©å±•è¿ç®—ç¬¦ä»¥åï¼Œå°±å¯ä»¥ç›´æ¥ç”¨Math.maxäº†ã€‚

å¦ä¸€ä¸ªä¾‹å­æ˜¯é€šè¿‡pushå‡½æ•°ï¼Œå°†ä¸€ä¸ªæ•°ç»„æ·»åŠ åˆ°å¦ä¸€ä¸ªæ•°ç»„çš„å°¾éƒ¨ã€‚

// ES5çš„å†™æ³•
var arr1 = [0, 1, 2];
var arr2 = [3, 4, 5];
Array.prototype.push.apply(arr1, arr2);

// ES6çš„å†™æ³•
var arr1 = [0, 1, 2];
var arr2 = [3, 4, 5];
arr1.push(...arr2);
ä¸Šé¢ä»£ç çš„ES5å†™æ³•ä¸­ï¼Œpushæ–¹æ³•çš„å‚æ•°ä¸èƒ½æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥åªå¥½é€šè¿‡applyæ–¹æ³•å˜é€šä½¿ç”¨pushæ–¹æ³•ã€‚æœ‰äº†æ‰©å±•è¿ç®—ç¬¦ï¼Œå°±å¯ä»¥ç›´æ¥å°†æ•°ç»„ä¼ å…¥pushæ–¹æ³•ã€‚

ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªä¾‹å­ã€‚

// ES5
new (Date.bind.apply(Date, [null, 2015, 1, 1]))
// ES6
new Date(...[2015, 1, 1]);
æ‰©å±•è¿ç®—ç¬¦çš„åº”ç”¨
ï¼ˆ1ï¼‰åˆå¹¶æ•°ç»„

æ‰©å±•è¿ç®—ç¬¦æä¾›äº†æ•°ç»„åˆå¹¶çš„æ–°å†™æ³•ã€‚

// ES5
[1, 2].concat(more)
// ES6
[1, 2, ...more]

var arr1 = ['a', 'b'];
var arr2 = ['c'];
var arr3 = ['d', 'e'];

// ES5çš„åˆå¹¶æ•°ç»„
arr1.concat(arr2, arr3);
// [ 'a', 'b', 'c', 'd', 'e' ]

// ES6çš„åˆå¹¶æ•°ç»„
[...arr1, ...arr2, ...arr3]
// [ 'a', 'b', 'c', 'd', 'e' ]
ï¼ˆ2ï¼‰ä¸è§£æ„èµ‹å€¼ç»“åˆ

æ‰©å±•è¿ç®—ç¬¦å¯ä»¥ä¸è§£æ„èµ‹å€¼ç»“åˆèµ·æ¥ï¼Œç”¨äºç”Ÿæˆæ•°ç»„ã€‚

// ES5
a = list[0], rest = list.slice(1)
// ES6
[a, ...rest] = list
ä¸‹é¢æ˜¯å¦å¤–ä¸€äº›ä¾‹å­ã€‚

const [first, ...rest] = [1, 2, 3, 4, 5];
first // 1
rest  // [2, 3, 4, 5]

const [first, ...rest] = [];
first // undefined
rest  // []:

const [first, ...rest] = ["foo"];
first  // "foo"
rest   // []
å¦‚æœå°†æ‰©å±•è¿ç®—ç¬¦ç”¨äºæ•°ç»„èµ‹å€¼ï¼Œåªèƒ½æ”¾åœ¨å‚æ•°çš„æœ€åä¸€ä½ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

const [...butLast, last] = [1, 2, 3, 4, 5];
// æŠ¥é”™

const [first, ...middle, last] = [1, 2, 3, 4, 5];
// æŠ¥é”™
ï¼ˆ3ï¼‰å‡½æ•°çš„è¿”å›å€¼

JavaScriptçš„å‡½æ•°åªèƒ½è¿”å›ä¸€ä¸ªå€¼ï¼Œå¦‚æœéœ€è¦è¿”å›å¤šä¸ªå€¼ï¼Œåªèƒ½è¿”å›æ•°ç»„æˆ–å¯¹è±¡ã€‚æ‰©å±•è¿ç®—ç¬¦æä¾›äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§å˜é€šæ–¹æ³•ã€‚

var dateFields = readDateFields(database);
var d = new Date(...dateFields);
ä¸Šé¢ä»£ç ä»æ•°æ®åº“å–å‡ºä¸€è¡Œæ•°æ®ï¼Œé€šè¿‡æ‰©å±•è¿ç®—ç¬¦ï¼Œç›´æ¥å°†å…¶ä¼ å…¥æ„é€ å‡½æ•°Dateã€‚

ï¼ˆ4ï¼‰å­—ç¬¦ä¸²

æ‰©å±•è¿ç®—ç¬¦è¿˜å¯ä»¥å°†å­—ç¬¦ä¸²è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

[...'hello']
// [ "h", "e", "l", "l", "o" ]
ä¸Šé¢çš„å†™æ³•ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„å¥½å¤„ï¼Œé‚£å°±æ˜¯èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«32ä½çš„Unicodeå­—ç¬¦ã€‚

'x\uD83D\uDE80y'.length // 4
[...'x\uD83D\uDE80y'].length // 3
ä¸Šé¢ä»£ç çš„ç¬¬ä¸€ç§å†™æ³•ï¼ŒJavaScriptä¼šå°†32ä½Unicodeå­—ç¬¦ï¼Œè¯†åˆ«ä¸º2ä¸ªå­—ç¬¦ï¼Œé‡‡ç”¨æ‰©å±•è¿ç®—ç¬¦å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤ï¼Œæ­£ç¡®è¿”å›å­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•°ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ã€‚

function length(str) {
  return [...str].length;
}

length('x\uD83D\uDE80y') // 3
å‡¡æ˜¯æ¶‰åŠåˆ°æ“ä½œ32ä½Unicodeå­—ç¬¦çš„å‡½æ•°ï¼Œéƒ½æœ‰è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤ï¼Œæœ€å¥½éƒ½ç”¨æ‰©å±•è¿ç®—ç¬¦æ”¹å†™ã€‚

let str = 'x\uD83D\uDE80y';

str.split('').reverse().join('')
// 'y\uDE80\uD83Dx'

[...str].reverse().join('')
// 'y\uD83D\uDE80x'
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœä¸ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œå­—ç¬¦ä¸²çš„reverseæ“ä½œå°±ä¸æ­£ç¡®ã€‚

ï¼ˆ5ï¼‰å®ç°äº†Iteratoræ¥å£çš„å¯¹è±¡

ä»»ä½•Iteratoræ¥å£çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥ç”¨æ‰©å±•è¿ç®—ç¬¦è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

var nodeList = document.querySelectorAll('div');
var array = [...nodeList];
ä¸Šé¢ä»£ç ä¸­ï¼ŒquerySelectorAllæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªnodeListå¯¹è±¡ã€‚å®ƒä¸æ˜¯æ•°ç»„ï¼Œè€Œæ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚è¿™æ—¶ï¼Œæ‰©å±•è¿ç®—ç¬¦å¯ä»¥å°†å…¶è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ï¼ŒåŸå› å°±åœ¨äºNodeListå¯¹è±¡å®ç°äº†Iteratoræ¥å£ã€‚

å¯¹äºé‚£äº›æ²¡æœ‰éƒ¨ç½²Iteratoræ¥å£çš„ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œæ‰©å±•è¿ç®—ç¬¦å°±æ— æ³•å°†å…¶è½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

let arrayLike = {
  '0': 'a',
  '1': 'b',
  '2': 'c',
  length: 3
};

// TypeError: Cannot spread non-iterable object.
let arr = [...arrayLike];
ä¸Šé¢ä»£ç ä¸­ï¼ŒarrayLikeæ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰éƒ¨ç½²Iteratoræ¥å£ï¼Œæ‰©å±•è¿ç®—ç¬¦å°±ä¼šæŠ¥é”™ã€‚è¿™æ—¶ï¼Œå¯ä»¥æ”¹ä¸ºä½¿ç”¨Array.fromæ–¹æ³•å°†arrayLikeè½¬ä¸ºçœŸæ­£çš„æ•°ç»„ã€‚

ï¼ˆ6ï¼‰Mapå’ŒSetç»“æ„ï¼ŒGeneratorå‡½æ•°

æ‰©å±•è¿ç®—ç¬¦å†…éƒ¨è°ƒç”¨çš„æ˜¯æ•°æ®ç»“æ„çš„Iteratoræ¥å£ï¼Œå› æ­¤åªè¦å…·æœ‰Iteratoræ¥å£çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œæ¯”å¦‚Mapç»“æ„ã€‚

let map = new Map([
  [1, 'one'],
  [2, 'two'],
  [3, 'three'],
]);

let arr = [...map.keys()]; // [1, 2, 3]
Generatorå‡½æ•°è¿è¡Œåï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ã€‚

var go = function*(){
  yield 1;
  yield 2;
  yield 3;
};

[...go()] // [1, 2, 3]
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡goæ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œæ‰§è¡Œåè¿”å›çš„æ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œå¯¹è¿™ä¸ªéå†å™¨å¯¹è±¡æ‰§è¡Œæ‰©å±•è¿ç®—ç¬¦ï¼Œå°±ä¼šå°†å†…éƒ¨éå†å¾—åˆ°çš„å€¼ï¼Œè½¬ä¸ºä¸€ä¸ªæ•°ç»„ã€‚

å¦‚æœå¯¹æ²¡æœ‰iteratoræ¥å£çš„å¯¹è±¡ï¼Œä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œå°†ä¼šæŠ¥é”™ã€‚

var obj = {a: 1, b: 2};
let arr = [...obj]; // TypeError: Cannot spread non-iterable object
ä¸¥æ ¼æ¨¡å¼
ä»ES5å¼€å§‹ï¼Œå‡½æ•°å†…éƒ¨å¯ä»¥è®¾å®šä¸ºä¸¥æ ¼æ¨¡å¼ã€‚

function doSomething(a, b) {
  'use strict';
  // code
}
ã€ŠECMAScript 2016æ ‡å‡†ã€‹åšäº†ä¸€ç‚¹ä¿®æ”¹ï¼Œè§„å®šåªè¦å‡½æ•°å‚æ•°ä½¿ç”¨äº†é»˜è®¤å€¼ã€è§£æ„èµ‹å€¼ã€æˆ–è€…æ‰©å±•è¿ç®—ç¬¦ï¼Œé‚£ä¹ˆå‡½æ•°å†…éƒ¨å°±ä¸èƒ½æ˜¾å¼è®¾å®šä¸ºä¸¥æ ¼æ¨¡å¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

// æŠ¥é”™
function doSomething(a, b = a) {
  'use strict';
  // code
}

// æŠ¥é”™
const doSomething = function ({a, b}) {
  'use strict';
  // code
};

// æŠ¥é”™
const doSomething = (...a) => {
  'use strict';
  // code
};

const obj = {
  // æŠ¥é”™
  doSomething({a, b}) {
    'use strict';
    // code
  }
};
è¿™æ ·è§„å®šçš„åŸå› æ˜¯ï¼Œå‡½æ•°å†…éƒ¨çš„ä¸¥æ ¼æ¨¡å¼ï¼ŒåŒæ—¶é€‚ç”¨äºå‡½æ•°ä½“ä»£ç å’Œå‡½æ•°å‚æ•°ä»£ç ã€‚ä½†æ˜¯ï¼Œå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆæ‰§è¡Œå‡½æ•°å‚æ•°ä»£ç ï¼Œç„¶åå†æ‰§è¡Œå‡½æ•°ä½“ä»£ç ã€‚è¿™æ ·å°±æœ‰ä¸€ä¸ªä¸åˆç†çš„åœ°æ–¹ï¼Œåªæœ‰ä»å‡½æ•°ä½“ä»£ç ä¹‹ä¸­ï¼Œæ‰èƒ½çŸ¥é“å‚æ•°ä»£ç æ˜¯å¦åº”è¯¥ä»¥ä¸¥æ ¼æ¨¡å¼æ‰§è¡Œï¼Œä½†æ˜¯å‚æ•°ä»£ç å´åº”è¯¥å…ˆäºå‡½æ•°ä½“ä»£ç æ‰§è¡Œã€‚

// æŠ¥é”™
function doSomething(value = 070) {
  'use strict';
  return value;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå‚æ•°valueçš„é»˜è®¤å€¼æ˜¯å…«è¿›åˆ¶æ•°070ï¼Œä½†æ˜¯ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸èƒ½ç”¨å‰ç¼€0è¡¨ç¤ºå…«è¿›åˆ¶ï¼Œæ‰€ä»¥åº”è¯¥æŠ¥é”™ã€‚ä½†æ˜¯å®é™…ä¸Šï¼ŒJavaScriptå¼•æ“ä¼šå…ˆæˆåŠŸæ‰§è¡Œvalue = 070ï¼Œç„¶åè¿›å…¥å‡½æ•°ä½“å†…éƒ¨ï¼Œå‘ç°éœ€è¦ç”¨ä¸¥æ ¼æ¨¡å¼æ‰§è¡Œï¼Œè¿™æ—¶æ‰ä¼šæŠ¥é”™ã€‚

è™½ç„¶å¯ä»¥å…ˆè§£æå‡½æ•°ä½“ä»£ç ï¼Œå†æ‰§è¡Œå‚æ•°ä»£ç ï¼Œä½†æ˜¯è¿™æ ·æ— ç–‘å°±å¢åŠ äº†å¤æ‚æ€§ã€‚å› æ­¤ï¼Œæ ‡å‡†ç´¢æ€§ç¦æ­¢äº†è¿™ç§ç”¨æ³•ï¼Œåªè¦å‚æ•°ä½¿ç”¨äº†é»˜è®¤å€¼ã€è§£æ„èµ‹å€¼ã€æˆ–è€…æ‰©å±•è¿ç®—ç¬¦ï¼Œå°±ä¸èƒ½æ˜¾å¼æŒ‡å®šä¸¥æ ¼æ¨¡å¼ã€‚

ä¸¤ç§æ–¹æ³•å¯ä»¥è§„é¿è¿™ç§é™åˆ¶ã€‚ç¬¬ä¸€ç§æ˜¯è®¾å®šå…¨å±€æ€§çš„ä¸¥æ ¼æ¨¡å¼ï¼Œè¿™æ˜¯åˆæ³•çš„ã€‚

'use strict';

function doSomething(a, b = a) {
  // code
}
ç¬¬äºŒç§æ˜¯æŠŠå‡½æ•°åŒ…åœ¨ä¸€ä¸ªæ— å‚æ•°çš„ç«‹å³æ‰§è¡Œå‡½æ•°é‡Œé¢ã€‚

const doSomething = (function () {
  'use strict';
  return function(value = 42) {
    return value;
  };
}());
nameå±æ€§
å‡½æ•°çš„nameå±æ€§ï¼Œè¿”å›è¯¥å‡½æ•°çš„å‡½æ•°åã€‚

function foo() {}
foo.name // "foo"
è¿™ä¸ªå±æ€§æ—©å°±è¢«æµè§ˆå™¨å¹¿æ³›æ”¯æŒï¼Œä½†æ˜¯ç›´åˆ°ES6ï¼Œæ‰å°†å…¶å†™å…¥äº†æ ‡å‡†ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒES6å¯¹è¿™ä¸ªå±æ€§çš„è¡Œä¸ºåšå‡ºäº†ä¸€äº›ä¿®æ”¹ã€‚å¦‚æœå°†ä¸€ä¸ªåŒ¿åå‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼ŒES5çš„nameå±æ€§ï¼Œä¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè€ŒES6çš„nameå±æ€§ä¼šè¿”å›å®é™…çš„å‡½æ•°åã€‚

var func1 = function () {};

// ES5
func1.name // ""

// ES6
func1.name // "func1"
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡func1ç­‰äºä¸€ä¸ªåŒ¿åå‡½æ•°ï¼ŒES5å’ŒES6çš„nameå±æ€§è¿”å›çš„å€¼ä¸ä¸€æ ·ã€‚

å¦‚æœå°†ä¸€ä¸ªå…·åå‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œåˆ™ES5å’ŒES6çš„nameå±æ€§éƒ½è¿”å›è¿™ä¸ªå…·åå‡½æ•°åŸæœ¬çš„åå­—ã€‚

const bar = function baz() {};

// ES5
bar.name // "baz"

// ES6
bar.name // "baz"
Functionæ„é€ å‡½æ•°è¿”å›çš„å‡½æ•°å®ä¾‹ï¼Œnameå±æ€§çš„å€¼ä¸ºâ€œanonymousâ€ã€‚

(new Function).name // "anonymous"
bindè¿”å›çš„å‡½æ•°ï¼Œnameå±æ€§å€¼ä¼šåŠ ä¸Šâ€œbound â€å‰ç¼€ã€‚

function foo() {};
foo.bind({}).name // "bound foo"

(function(){}).bind({}).name // "bound "
ç®­å¤´å‡½æ•°
åŸºæœ¬ç”¨æ³•
ES6å…è®¸ä½¿ç”¨â€œç®­å¤´â€ï¼ˆ=>ï¼‰å®šä¹‰å‡½æ•°ã€‚

var f = v => v;
ä¸Šé¢çš„ç®­å¤´å‡½æ•°ç­‰åŒäºï¼š

var f = function(v) {
  return v;
};
å¦‚æœç®­å¤´å‡½æ•°ä¸éœ€è¦å‚æ•°æˆ–éœ€è¦å¤šä¸ªå‚æ•°ï¼Œå°±ä½¿ç”¨ä¸€ä¸ªåœ†æ‹¬å·ä»£è¡¨å‚æ•°éƒ¨åˆ†ã€‚

var f = () => 5;
// ç­‰åŒäº
var f = function () { return 5 };

var sum = (num1, num2) => num1 + num2;
// ç­‰åŒäº
var sum = function(num1, num2) {
  return num1 + num2;
};
å¦‚æœç®­å¤´å‡½æ•°çš„ä»£ç å—éƒ¨åˆ†å¤šäºä¸€æ¡è¯­å¥ï¼Œå°±è¦ä½¿ç”¨å¤§æ‹¬å·å°†å®ƒä»¬æ‹¬èµ·æ¥ï¼Œå¹¶ä¸”ä½¿ç”¨returnè¯­å¥è¿”å›ã€‚

var sum = (num1, num2) => { return num1 + num2; }
ç”±äºå¤§æ‹¬å·è¢«è§£é‡Šä¸ºä»£ç å—ï¼Œæ‰€ä»¥å¦‚æœç®­å¤´å‡½æ•°ç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»åœ¨å¯¹è±¡å¤–é¢åŠ ä¸Šæ‹¬å·ã€‚

var getTempItem = id => ({ id: id, name: "Temp" });
ç®­å¤´å‡½æ•°å¯ä»¥ä¸å˜é‡è§£æ„ç»“åˆä½¿ç”¨ã€‚

const full = ({ first, last }) => first + ' ' + last;

// ç­‰åŒäº
function full(person) {
  return person.first + ' ' + person.last;
}
ç®­å¤´å‡½æ•°ä½¿å¾—è¡¨è¾¾æ›´åŠ ç®€æ´ã€‚

const isEven = n => n % 2 == 0;
const square = n => n * n;
ä¸Šé¢ä»£ç åªç”¨äº†ä¸¤è¡Œï¼Œå°±å®šä¹‰äº†ä¸¤ä¸ªç®€å•çš„å·¥å…·å‡½æ•°ã€‚å¦‚æœä¸ç”¨ç®­å¤´å‡½æ•°ï¼Œå¯èƒ½å°±è¦å ç”¨å¤šè¡Œï¼Œè€Œä¸”è¿˜ä¸å¦‚ç°åœ¨è¿™æ ·å†™é†’ç›®ã€‚

ç®­å¤´å‡½æ•°çš„ä¸€ä¸ªç”¨å¤„æ˜¯ç®€åŒ–å›è°ƒå‡½æ•°ã€‚

// æ­£å¸¸å‡½æ•°å†™æ³•
[1,2,3].map(function (x) {
  return x * x;
});

// ç®­å¤´å‡½æ•°å†™æ³•
[1,2,3].map(x => x * x);
å¦ä¸€ä¸ªä¾‹å­æ˜¯

// æ­£å¸¸å‡½æ•°å†™æ³•
var result = values.sort(function (a, b) {
  return a - b;
});

// ç®­å¤´å‡½æ•°å†™æ³•
var result = values.sort((a, b) => a - b);
ä¸‹é¢æ˜¯restå‚æ•°ä¸ç®­å¤´å‡½æ•°ç»“åˆçš„ä¾‹å­ã€‚

const numbers = (...nums) => nums;

numbers(1, 2, 3, 4, 5)
// [1,2,3,4,5]

const headAndTail = (head, ...tail) => [head, tail];

headAndTail(1, 2, 3, 4, 5)
// [1,[2,3,4,5]]
ä½¿ç”¨æ³¨æ„ç‚¹
ç®­å¤´å‡½æ•°æœ‰å‡ ä¸ªä½¿ç”¨æ³¨æ„ç‚¹ã€‚

ï¼ˆ1ï¼‰å‡½æ•°ä½“å†…çš„thiså¯¹è±¡ï¼Œå°±æ˜¯å®šä¹‰æ—¶æ‰€åœ¨çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ—¶æ‰€åœ¨çš„å¯¹è±¡ã€‚

ï¼ˆ2ï¼‰ä¸å¯ä»¥å½“ä½œæ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸å¯ä»¥ä½¿ç”¨newå‘½ä»¤ï¼Œå¦åˆ™ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

ï¼ˆ3ï¼‰ä¸å¯ä»¥ä½¿ç”¨argumentså¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨å‡½æ•°ä½“å†…ä¸å­˜åœ¨ã€‚å¦‚æœè¦ç”¨ï¼Œå¯ä»¥ç”¨Restå‚æ•°ä»£æ›¿ã€‚

ï¼ˆ4ï¼‰ä¸å¯ä»¥ä½¿ç”¨yieldå‘½ä»¤ï¼Œå› æ­¤ç®­å¤´å‡½æ•°ä¸èƒ½ç”¨ä½œGeneratorå‡½æ•°ã€‚

ä¸Šé¢å››ç‚¹ä¸­ï¼Œç¬¬ä¸€ç‚¹å°¤å…¶å€¼å¾—æ³¨æ„ã€‚thiså¯¹è±¡çš„æŒ‡å‘æ˜¯å¯å˜çš„ï¼Œä½†æ˜¯åœ¨ç®­å¤´å‡½æ•°ä¸­ï¼Œå®ƒæ˜¯å›ºå®šçš„ã€‚

function foo() {
  setTimeout(() => {
    console.log('id:', this.id);
  }, 100);
}

var id = 21;

foo.call({ id: 42 });
// id: 42
ä¸Šé¢ä»£ç ä¸­ï¼ŒsetTimeoutçš„å‚æ•°æ˜¯ä¸€ä¸ªç®­å¤´å‡½æ•°ï¼Œè¿™ä¸ªç®­å¤´å‡½æ•°çš„å®šä¹‰ç”Ÿæ•ˆæ˜¯åœ¨fooå‡½æ•°ç”Ÿæˆæ—¶ï¼Œè€Œå®ƒçš„çœŸæ­£æ‰§è¡Œè¦ç­‰åˆ°100æ¯«ç§’åã€‚å¦‚æœæ˜¯æ™®é€šå‡½æ•°ï¼Œæ‰§è¡Œæ—¶thisåº”è¯¥æŒ‡å‘å…¨å±€å¯¹è±¡windowï¼Œè¿™æ—¶åº”è¯¥è¾“å‡º21ã€‚ä½†æ˜¯ï¼Œç®­å¤´å‡½æ•°å¯¼è‡´thisæ€»æ˜¯æŒ‡å‘å‡½æ•°å®šä¹‰ç”Ÿæ•ˆæ—¶æ‰€åœ¨çš„å¯¹è±¡ï¼ˆæœ¬ä¾‹æ˜¯{id: 42}ï¼‰ï¼Œæ‰€ä»¥è¾“å‡ºçš„æ˜¯42ã€‚

ç®­å¤´å‡½æ•°å¯ä»¥è®©setTimeouté‡Œé¢çš„thisï¼Œç»‘å®šå®šä¹‰æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯æŒ‡å‘è¿è¡Œæ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸã€‚ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

function Timer() {
  this.s1 = 0;
  this.s2 = 0;
  // ç®­å¤´å‡½æ•°
  setInterval(() => this.s1++, 1000);
  // æ™®é€šå‡½æ•°
  setInterval(function () {
    this.s2++;
  }, 1000);
}

var timer = new Timer();

setTimeout(() => console.log('s1: ', timer.s1), 3100);
setTimeout(() => console.log('s2: ', timer.s2), 3100);
// s1: 3
// s2: 0
ä¸Šé¢ä»£ç ä¸­ï¼ŒTimerå‡½æ•°å†…éƒ¨è®¾ç½®äº†ä¸¤ä¸ªå®šæ—¶å™¨ï¼Œåˆ†åˆ«ä½¿ç”¨äº†ç®­å¤´å‡½æ•°å’Œæ™®é€šå‡½æ•°ã€‚å‰è€…çš„thisç»‘å®šå®šä¹‰æ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸï¼ˆå³Timerå‡½æ•°ï¼‰ï¼Œåè€…çš„thisæŒ‡å‘è¿è¡Œæ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸï¼ˆå³å…¨å±€å¯¹è±¡ï¼‰ã€‚æ‰€ä»¥ï¼Œ3100æ¯«ç§’ä¹‹åï¼Œtimer.s1è¢«æ›´æ–°äº†3æ¬¡ï¼Œè€Œtimer.s2ä¸€æ¬¡éƒ½æ²¡æ›´æ–°ã€‚

ç®­å¤´å‡½æ•°å¯ä»¥è®©thisæŒ‡å‘å›ºå®šåŒ–ï¼Œè¿™ç§ç‰¹æ€§å¾ˆæœ‰åˆ©äºå°è£…å›è°ƒå‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼ŒDOMäº‹ä»¶çš„å›è°ƒå‡½æ•°å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œé¢ã€‚

var handler = {
  id: '123456',

  init: function() {
    document.addEventListener('click',
      event => this.doSomething(event.type), false);
  },

  doSomething: function(type) {
    console.log('Handling ' + type  + ' for ' + this.id);
  }
};
ä¸Šé¢ä»£ç çš„initæ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†ç®­å¤´å‡½æ•°ï¼Œè¿™å¯¼è‡´è¿™ä¸ªç®­å¤´å‡½æ•°é‡Œé¢çš„thisï¼Œæ€»æ˜¯æŒ‡å‘handlerå¯¹è±¡ã€‚å¦åˆ™ï¼Œå›è°ƒå‡½æ•°è¿è¡Œæ—¶ï¼Œthis.doSomethingè¿™ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºæ­¤æ—¶thisæŒ‡å‘documentå¯¹è±¡ã€‚

thisæŒ‡å‘çš„å›ºå®šåŒ–ï¼Œå¹¶ä¸æ˜¯å› ä¸ºç®­å¤´å‡½æ•°å†…éƒ¨æœ‰ç»‘å®šthisçš„æœºåˆ¶ï¼Œå®é™…åŸå› æ˜¯ç®­å¤´å‡½æ•°æ ¹æœ¬æ²¡æœ‰è‡ªå·±çš„thisï¼Œå¯¼è‡´å†…éƒ¨çš„thiså°±æ˜¯å¤–å±‚ä»£ç å—çš„thisã€‚æ­£æ˜¯å› ä¸ºå®ƒæ²¡æœ‰thisï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸èƒ½ç”¨ä½œæ„é€ å‡½æ•°ã€‚

æ‰€ä»¥ï¼Œç®­å¤´å‡½æ•°è½¬æˆES5çš„ä»£ç å¦‚ä¸‹ã€‚

// ES6
function foo() {
  setTimeout(() => {
    console.log('id:', this.id);
  }, 100);
}

// ES5
function foo() {
  var _this = this;

  setTimeout(function () {
    console.log('id:', _this.id);
  }, 100);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œè½¬æ¢åçš„ES5ç‰ˆæœ¬æ¸…æ¥šåœ°è¯´æ˜äº†ï¼Œç®­å¤´å‡½æ•°é‡Œé¢æ ¹æœ¬æ²¡æœ‰è‡ªå·±çš„thisï¼Œè€Œæ˜¯å¼•ç”¨å¤–å±‚çš„thisã€‚

è¯·é—®ä¸‹é¢çš„ä»£ç ä¹‹ä¸­æœ‰å‡ ä¸ªthisï¼Ÿ

function foo() {
  return () => {
    return () => {
      return () => {
        console.log('id:', this.id);
      };
    };
  };
}

var f = foo.call({id: 1});

var t1 = f.call({id: 2})()(); // id: 1
var t2 = f().call({id: 3})(); // id: 1
var t3 = f()().call({id: 4}); // id: 1
ä¸Šé¢ä»£ç ä¹‹ä¸­ï¼Œåªæœ‰ä¸€ä¸ªthisï¼Œå°±æ˜¯å‡½æ•°fooçš„thisï¼Œæ‰€ä»¥t1ã€t2ã€t3éƒ½è¾“å‡ºåŒæ ·çš„ç»“æœã€‚å› ä¸ºæ‰€æœ‰çš„å†…å±‚å‡½æ•°éƒ½æ˜¯ç®­å¤´å‡½æ•°ï¼Œéƒ½æ²¡æœ‰è‡ªå·±çš„thisï¼Œå®ƒä»¬çš„thiså…¶å®éƒ½æ˜¯æœ€å¤–å±‚fooå‡½æ•°çš„thisã€‚

é™¤äº†thisï¼Œä»¥ä¸‹ä¸‰ä¸ªå˜é‡åœ¨ç®­å¤´å‡½æ•°ä¹‹ä¸­ä¹Ÿæ˜¯ä¸å­˜åœ¨çš„ï¼ŒæŒ‡å‘å¤–å±‚å‡½æ•°çš„å¯¹åº”å˜é‡ï¼šargumentsã€superã€new.targetã€‚

function foo() {
  setTimeout(() => {
    console.log('args:', arguments);
  }, 100);
}

foo(2, 4, 6, 8)
// args: [2, 4, 6, 8]
ä¸Šé¢ä»£ç ä¸­ï¼Œç®­å¤´å‡½æ•°å†…éƒ¨çš„å˜é‡argumentsï¼Œå…¶å®æ˜¯å‡½æ•°fooçš„argumentså˜é‡ã€‚

å¦å¤–ï¼Œç”±äºç®­å¤´å‡½æ•°æ²¡æœ‰è‡ªå·±çš„thisï¼Œæ‰€ä»¥å½“ç„¶ä¹Ÿå°±ä¸èƒ½ç”¨call()ã€apply()ã€bind()è¿™äº›æ–¹æ³•å»æ”¹å˜thisçš„æŒ‡å‘ã€‚

(function() {
  return [
    (() => this.x).bind({ x: 'inner' })()
  ];
}).call({ x: 'outer' });
// ['outer']
ä¸Šé¢ä»£ç ä¸­ï¼Œç®­å¤´å‡½æ•°æ²¡æœ‰è‡ªå·±çš„thisï¼Œæ‰€ä»¥bindæ–¹æ³•æ— æ•ˆï¼Œå†…éƒ¨çš„thisæŒ‡å‘å¤–éƒ¨çš„thisã€‚

é•¿æœŸä»¥æ¥ï¼ŒJavaScriptè¯­è¨€çš„thiså¯¹è±¡ä¸€ç›´æ˜¯ä¸€ä¸ªä»¤äººå¤´ç—›çš„é—®é¢˜ï¼Œåœ¨å¯¹è±¡æ–¹æ³•ä¸­ä½¿ç”¨thisï¼Œå¿…é¡»éå¸¸å°å¿ƒã€‚ç®­å¤´å‡½æ•°â€ç»‘å®šâ€thisï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³äº†è¿™ä¸ªå›°æ‰°ã€‚

åµŒå¥—çš„ç®­å¤´å‡½æ•°
ç®­å¤´å‡½æ•°å†…éƒ¨ï¼Œè¿˜å¯ä»¥å†ä½¿ç”¨ç®­å¤´å‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªES5è¯­æ³•çš„å¤šé‡åµŒå¥—å‡½æ•°ã€‚

function insert(value) {
  return {into: function (array) {
    return {after: function (afterValue) {
      array.splice(array.indexOf(afterValue) + 1, 0, value);
      return array;
    }};
  }};
}

insert(2).into([1, 3]).after(1); //[1, 2, 3]
ä¸Šé¢è¿™ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨ç®­å¤´å‡½æ•°æ”¹å†™ã€‚

let insert = (value) => ({into: (array) => ({after: (afterValue) => {
  array.splice(array.indexOf(afterValue) + 1, 0, value);
  return array;
}})});

insert(2).into([1, 3]).after(1); //[1, 2, 3]
ä¸‹é¢æ˜¯ä¸€ä¸ªéƒ¨ç½²ç®¡é“æœºåˆ¶ï¼ˆpipelineï¼‰çš„ä¾‹å­ï¼Œå³å‰ä¸€ä¸ªå‡½æ•°çš„è¾“å‡ºæ˜¯åä¸€ä¸ªå‡½æ•°çš„è¾“å…¥ã€‚

const pipeline = (...funcs) =>
  val => funcs.reduce((a, b) => b(a), val);

const plus1 = a => a + 1;
const mult2 = a => a * 2;
const addThenMult = pipeline(plus1, mult2);

addThenMult(5)
// 12
å¦‚æœè§‰å¾—ä¸Šé¢çš„å†™æ³•å¯è¯»æ€§æ¯”è¾ƒå·®ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚

const plus1 = a => a + 1;
const mult2 = a => a * 2;

mult2(plus1(5))
// 12
ç®­å¤´å‡½æ•°è¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ”¹å†™Î»æ¼”ç®—ã€‚

// Î»æ¼”ç®—çš„å†™æ³•
fix = Î»f.(Î»x.f(Î»v.x(x)(v)))(Î»x.f(Î»v.x(x)(v)))

// ES6çš„å†™æ³•
var fix = f => (x => f(v => x(x)(v)))
               (x => f(v => x(x)(v)));
ä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå‡ ä¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ç”±äºÎ»æ¼”ç®—å¯¹äºè®¡ç®—æœºç§‘å­¦éå¸¸é‡è¦ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨ES6ä½œä¸ºæ›¿ä»£å·¥å…·ï¼Œæ¢ç´¢è®¡ç®—æœºç§‘å­¦ã€‚

ç»‘å®š this
ç®­å¤´å‡½æ•°å¯ä»¥ç»‘å®šthiså¯¹è±¡ï¼Œå¤§å¤§å‡å°‘äº†æ˜¾å¼ç»‘å®šthiså¯¹è±¡çš„å†™æ³•ï¼ˆcallã€applyã€bindï¼‰ã€‚ä½†æ˜¯ï¼Œç®­å¤´å‡½æ•°å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰åœºåˆï¼Œæ‰€ä»¥ES7æå‡ºäº†â€œå‡½æ•°ç»‘å®šâ€ï¼ˆfunction bindï¼‰è¿ç®—ç¬¦ï¼Œç”¨æ¥å–ä»£callã€applyã€bindè°ƒç”¨ã€‚è™½ç„¶è¯¥è¯­æ³•è¿˜æ˜¯ES7çš„ä¸€ä¸ªææ¡ˆï¼Œä½†æ˜¯Babelè½¬ç å™¨å·²ç»æ”¯æŒã€‚

å‡½æ•°ç»‘å®šè¿ç®—ç¬¦æ˜¯å¹¶æ’çš„ä¸¤ä¸ªåŒå†’å·ï¼ˆ::ï¼‰ï¼ŒåŒå†’å·å·¦è¾¹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå³è¾¹æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è¯¥è¿ç®—ç¬¦ä¼šè‡ªåŠ¨å°†å·¦è¾¹çš„å¯¹è±¡ï¼Œä½œä¸ºä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆå³thiså¯¹è±¡ï¼‰ï¼Œç»‘å®šåˆ°å³è¾¹çš„å‡½æ•°ä¸Šé¢ã€‚

foo::bar;
// ç­‰åŒäº
bar.bind(foo);

foo::bar(...arguments);
// ç­‰åŒäº
bar.apply(foo, arguments);

const hasOwnProperty = Object.prototype.hasOwnProperty;
function hasOwn(obj, key) {
  return obj::hasOwnProperty(key);
}
å¦‚æœåŒå†’å·å·¦è¾¹ä¸ºç©ºï¼Œå³è¾¹æ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼Œåˆ™ç­‰äºå°†è¯¥æ–¹æ³•ç»‘å®šåœ¨è¯¥å¯¹è±¡ä¸Šé¢ã€‚

var method = obj::obj.foo;
// ç­‰åŒäº
var method = ::obj.foo;

let log = ::console.log;
// ç­‰åŒäº
var log = console.log.bind(console);
ç”±äºåŒå†’å·è¿ç®—ç¬¦è¿”å›çš„è¿˜æ˜¯åŸå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ã€‚

// ä¾‹ä¸€
import { map, takeWhile, forEach } from "iterlib";

getPlayers()
::map(x => x.character())
::takeWhile(x => x.strength > 100)
::forEach(x => console.log(x));

// ä¾‹äºŒ
let { find, html } = jake;

document.querySelectorAll("div.myClass")
::find("p")
::html("hahaha");
å°¾è°ƒç”¨ä¼˜åŒ–
ä»€ä¹ˆæ˜¯å°¾è°ƒç”¨ï¼Ÿ
å°¾è°ƒç”¨ï¼ˆTail Callï¼‰æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œæœ¬èº«éå¸¸ç®€å•ï¼Œä¸€å¥è¯å°±èƒ½è¯´æ¸…æ¥šï¼Œå°±æ˜¯æŒ‡æŸä¸ªå‡½æ•°çš„æœ€åä¸€æ­¥æ˜¯è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ã€‚

function f(x){
  return g(x);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fçš„æœ€åä¸€æ­¥æ˜¯è°ƒç”¨å‡½æ•°gï¼Œè¿™å°±å«å°¾è°ƒç”¨ã€‚

ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼Œéƒ½ä¸å±äºå°¾è°ƒç”¨ã€‚

// æƒ…å†µä¸€
function f(x){
  let y = g(x);
  return y;
}

// æƒ…å†µäºŒ
function f(x){
  return g(x) + 1;
}

// æƒ…å†µä¸‰
function f(x){
  g(x);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œæƒ…å†µä¸€æ˜¯è°ƒç”¨å‡½æ•°gä¹‹åï¼Œè¿˜æœ‰èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥ä¸å±äºå°¾è°ƒç”¨ï¼Œå³ä½¿è¯­ä¹‰å®Œå…¨ä¸€æ ·ã€‚æƒ…å†µäºŒä¹Ÿå±äºè°ƒç”¨åè¿˜æœ‰æ“ä½œï¼Œå³ä½¿å†™åœ¨ä¸€è¡Œå†…ã€‚æƒ…å†µä¸‰ç­‰åŒäºä¸‹é¢çš„ä»£ç ã€‚

function f(x){
  g(x);
  return undefined;
}
å°¾è°ƒç”¨ä¸ä¸€å®šå‡ºç°åœ¨å‡½æ•°å°¾éƒ¨ï¼Œåªè¦æ˜¯æœ€åä¸€æ­¥æ“ä½œå³å¯ã€‚

function f(x) {
  if (x > 0) {
    return m(x)
  }
  return n(x);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°må’Œnéƒ½å±äºå°¾è°ƒç”¨ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯å‡½æ•°fçš„æœ€åä¸€æ­¥æ“ä½œã€‚

å°¾è°ƒç”¨ä¼˜åŒ–
å°¾è°ƒç”¨ä¹‹æ‰€ä»¥ä¸å…¶ä»–è°ƒç”¨ä¸åŒï¼Œå°±åœ¨äºå®ƒçš„ç‰¹æ®Šçš„è°ƒç”¨ä½ç½®ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œå‡½æ•°è°ƒç”¨ä¼šåœ¨å†…å­˜å½¢æˆä¸€ä¸ªâ€œè°ƒç”¨è®°å½•â€ï¼Œåˆç§°â€œè°ƒç”¨å¸§â€ï¼ˆcall frameï¼‰ï¼Œä¿å­˜è°ƒç”¨ä½ç½®å’Œå†…éƒ¨å˜é‡ç­‰ä¿¡æ¯ã€‚å¦‚æœåœ¨å‡½æ•°Açš„å†…éƒ¨è°ƒç”¨å‡½æ•°Bï¼Œé‚£ä¹ˆåœ¨Açš„è°ƒç”¨å¸§ä¸Šæ–¹ï¼Œè¿˜ä¼šå½¢æˆä¸€ä¸ªBçš„è°ƒç”¨å¸§ã€‚ç­‰åˆ°Bè¿è¡Œç»“æŸï¼Œå°†ç»“æœè¿”å›åˆ°Aï¼ŒBçš„è°ƒç”¨å¸§æ‰ä¼šæ¶ˆå¤±ã€‚å¦‚æœå‡½æ•°Bå†…éƒ¨è¿˜è°ƒç”¨å‡½æ•°Cï¼Œé‚£å°±è¿˜æœ‰ä¸€ä¸ªCçš„è°ƒç”¨å¸§ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ‰€æœ‰çš„è°ƒç”¨å¸§ï¼Œå°±å½¢æˆä¸€ä¸ªâ€œè°ƒç”¨æ ˆâ€ï¼ˆcall stackï¼‰ã€‚

å°¾è°ƒç”¨ç”±äºæ˜¯å‡½æ•°çš„æœ€åä¸€æ­¥æ“ä½œï¼Œæ‰€ä»¥ä¸éœ€è¦ä¿ç•™å¤–å±‚å‡½æ•°çš„è°ƒç”¨å¸§ï¼Œå› ä¸ºè°ƒç”¨ä½ç½®ã€å†…éƒ¨å˜é‡ç­‰ä¿¡æ¯éƒ½ä¸ä¼šå†ç”¨åˆ°äº†ï¼Œåªè¦ç›´æ¥ç”¨å†…å±‚å‡½æ•°çš„è°ƒç”¨å¸§ï¼Œå–ä»£å¤–å±‚å‡½æ•°çš„è°ƒç”¨å¸§å°±å¯ä»¥äº†ã€‚

function f() {
  let m = 1;
  let n = 2;
  return g(m + n);
}
f();

// ç­‰åŒäº
function f() {
  return g(3);
}
f();

// ç­‰åŒäº
g(3);
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœå‡½æ•°gä¸æ˜¯å°¾è°ƒç”¨ï¼Œå‡½æ•°få°±éœ€è¦ä¿å­˜å†…éƒ¨å˜é‡må’Œnçš„å€¼ã€gçš„è°ƒç”¨ä½ç½®ç­‰ä¿¡æ¯ã€‚ä½†ç”±äºè°ƒç”¨gä¹‹åï¼Œå‡½æ•°få°±ç»“æŸäº†ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°æœ€åä¸€æ­¥ï¼Œå®Œå…¨å¯ä»¥åˆ é™¤ f(x) çš„è°ƒç”¨å¸§ï¼Œåªä¿ç•™ g(3) çš„è°ƒç”¨å¸§ã€‚

è¿™å°±å«åšâ€œå°¾è°ƒç”¨ä¼˜åŒ–â€ï¼ˆTail call optimizationï¼‰ï¼Œå³åªä¿ç•™å†…å±‚å‡½æ•°çš„è°ƒç”¨å¸§ã€‚å¦‚æœæ‰€æœ‰å‡½æ•°éƒ½æ˜¯å°¾è°ƒç”¨ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥åšåˆ°æ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨å¸§åªæœ‰ä¸€é¡¹ï¼Œè¿™å°†å¤§å¤§èŠ‚çœå†…å­˜ã€‚è¿™å°±æ˜¯â€œå°¾è°ƒç”¨ä¼˜åŒ–â€çš„æ„ä¹‰ã€‚

æ³¨æ„ï¼Œåªæœ‰ä¸å†ç”¨åˆ°å¤–å±‚å‡½æ•°çš„å†…éƒ¨å˜é‡ï¼Œå†…å±‚å‡½æ•°çš„è°ƒç”¨å¸§æ‰ä¼šå–ä»£å¤–å±‚å‡½æ•°çš„è°ƒç”¨å¸§ï¼Œå¦åˆ™å°±æ— æ³•è¿›è¡Œâ€œå°¾è°ƒç”¨ä¼˜åŒ–â€ã€‚

function addOne(a){
  var one = 1;
  function inner(b){
    return b + one;
  }
  return inner(a);
}
ä¸Šé¢çš„å‡½æ•°ä¸ä¼šè¿›è¡Œå°¾è°ƒç”¨ä¼˜åŒ–ï¼Œå› ä¸ºå†…å±‚å‡½æ•°innerç”¨åˆ°äº†å¤–å±‚å‡½æ•°addOneçš„å†…éƒ¨å˜é‡oneã€‚

å°¾é€’å½’
å‡½æ•°è°ƒç”¨è‡ªèº«ï¼Œç§°ä¸ºé€’å½’ã€‚å¦‚æœå°¾è°ƒç”¨è‡ªèº«ï¼Œå°±ç§°ä¸ºå°¾é€’å½’ã€‚

é€’å½’éå¸¸è€—è´¹å†…å­˜ï¼Œå› ä¸ºéœ€è¦åŒæ—¶ä¿å­˜æˆåƒä¸Šç™¾ä¸ªè°ƒç”¨å¸§ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿâ€œæ ˆæº¢å‡ºâ€é”™è¯¯ï¼ˆstack overflowï¼‰ã€‚ä½†å¯¹äºå°¾é€’å½’æ¥è¯´ï¼Œç”±äºåªå­˜åœ¨ä¸€ä¸ªè°ƒç”¨å¸§ï¼Œæ‰€ä»¥æ°¸è¿œä¸ä¼šå‘ç”Ÿâ€œæ ˆæº¢å‡ºâ€é”™è¯¯ã€‚

function factorial(n) {
  if (n === 1) return 1;
  return n * factorial(n - 1);
}

factorial(5) // 120
ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªé˜¶ä¹˜å‡½æ•°ï¼Œè®¡ç®—nçš„é˜¶ä¹˜ï¼Œæœ€å¤šéœ€è¦ä¿å­˜nä¸ªè°ƒç”¨è®°å½•ï¼Œå¤æ‚åº¦ O(n) ã€‚

å¦‚æœæ”¹å†™æˆå°¾é€’å½’ï¼Œåªä¿ç•™ä¸€ä¸ªè°ƒç”¨è®°å½•ï¼Œå¤æ‚åº¦ O(1) ã€‚

function factorial(n, total) {
  if (n === 1) return total;
  return factorial(n - 1, n * total);
}

factorial(5, 1) // 120
è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒè‘—åçš„ä¾‹å­ï¼Œå°±æ˜¯è®¡ç®—fibonacci æ•°åˆ—ï¼Œä¹Ÿèƒ½å……åˆ†è¯´æ˜å°¾é€’å½’ä¼˜åŒ–çš„é‡è¦æ€§

å¦‚æœæ˜¯éå°¾é€’å½’çš„fibonacci é€’å½’æ–¹æ³•

function Fibonacci (n) {
  if ( n <= 1 ) {return 1};

  return Fibonacci(n - 1) + Fibonacci(n - 2);
}

Fibonacci(10); // 89
// Fibonacci(100)
// Fibonacci(500)
// å †æ ˆæº¢å‡ºäº†
å¦‚æœæˆ‘ä»¬ä½¿ç”¨å°¾é€’å½’ä¼˜åŒ–è¿‡çš„fibonacci é€’å½’ç®—æ³•

function Fibonacci2 (n , ac1 = 1 , ac2 = 1) {
  if( n <= 1 ) {return ac2};

  return Fibonacci2 (n - 1, ac2, ac1 + ac2);
}

Fibonacci2(100) // 573147844013817200000
Fibonacci2(1000) // 7.0330367711422765e+208
Fibonacci2(10000) // Infinity
ç”±æ­¤å¯è§ï¼Œâ€œå°¾è°ƒç”¨ä¼˜åŒ–â€å¯¹é€’å½’æ“ä½œæ„ä¹‰é‡å¤§ï¼Œæ‰€ä»¥ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€å°†å…¶å†™å…¥äº†è¯­è¨€è§„æ ¼ã€‚ES6ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œç¬¬ä¸€æ¬¡æ˜ç¡®è§„å®šï¼Œæ‰€æœ‰ECMAScriptçš„å®ç°ï¼Œéƒ½å¿…é¡»éƒ¨ç½²â€œå°¾è°ƒç”¨ä¼˜åŒ–â€ã€‚è¿™å°±æ˜¯è¯´ï¼Œåœ¨ES6ä¸­ï¼Œåªè¦ä½¿ç”¨å°¾é€’å½’ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ ˆæº¢å‡ºï¼Œç›¸å¯¹èŠ‚çœå†…å­˜ã€‚

é€’å½’å‡½æ•°çš„æ”¹å†™
å°¾é€’å½’çš„å®ç°ï¼Œå¾€å¾€éœ€è¦æ”¹å†™é€’å½’å‡½æ•°ï¼Œç¡®ä¿æœ€åä¸€æ­¥åªè°ƒç”¨è‡ªèº«ã€‚åšåˆ°è¿™ä¸€ç‚¹çš„æ–¹æ³•ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰ç”¨åˆ°çš„å†…éƒ¨å˜é‡æ”¹å†™æˆå‡½æ•°çš„å‚æ•°ã€‚æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œé˜¶ä¹˜å‡½æ•° factorial éœ€è¦ç”¨åˆ°ä¸€ä¸ªä¸­é—´å˜é‡ total ï¼Œé‚£å°±æŠŠè¿™ä¸ªä¸­é—´å˜é‡æ”¹å†™æˆå‡½æ•°çš„å‚æ•°ã€‚è¿™æ ·åšçš„ç¼ºç‚¹å°±æ˜¯ä¸å¤ªç›´è§‚ï¼Œç¬¬ä¸€çœ¼å¾ˆéš¾çœ‹å‡ºæ¥ï¼Œä¸ºä»€ä¹ˆè®¡ç®—5çš„é˜¶ä¹˜ï¼Œéœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°5å’Œ1ï¼Ÿ

ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ–¹æ³•ä¸€æ˜¯åœ¨å°¾é€’å½’å‡½æ•°ä¹‹å¤–ï¼Œå†æä¾›ä¸€ä¸ªæ­£å¸¸å½¢å¼çš„å‡½æ•°ã€‚

function tailFactorial(n, total) {
  if (n === 1) return total;
  return tailFactorial(n - 1, n * total);
}

function factorial(n) {
  return tailFactorial(n, 1);
}

factorial(5) // 120
ä¸Šé¢ä»£ç é€šè¿‡ä¸€ä¸ªæ­£å¸¸å½¢å¼çš„é˜¶ä¹˜å‡½æ•° factorial ï¼Œè°ƒç”¨å°¾é€’å½’å‡½æ•° tailFactorial ï¼Œçœ‹èµ·æ¥å°±æ­£å¸¸å¤šäº†ã€‚

å‡½æ•°å¼ç¼–ç¨‹æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œå«åšæŸ¯é‡ŒåŒ–ï¼ˆcurryingï¼‰ï¼Œæ„æ€æ˜¯å°†å¤šå‚æ•°çš„å‡½æ•°è½¬æ¢æˆå•å‚æ•°çš„å½¢å¼ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨æŸ¯é‡ŒåŒ–ã€‚

function currying(fn, n) {
  return function (m) {
    return fn.call(this, m, n);
  };
}

function tailFactorial(n, total) {
  if (n === 1) return total;
  return tailFactorial(n - 1, n * total);
}

const factorial = currying(tailFactorial, 1);

factorial(5) // 120
ä¸Šé¢ä»£ç é€šè¿‡æŸ¯é‡ŒåŒ–ï¼Œå°†å°¾é€’å½’å‡½æ•° tailFactorial å˜ä¸ºåªæ¥å—1ä¸ªå‚æ•°çš„ factorial ã€‚

ç¬¬äºŒç§æ–¹æ³•å°±ç®€å•å¤šäº†ï¼Œå°±æ˜¯é‡‡ç”¨ES6çš„å‡½æ•°é»˜è®¤å€¼ã€‚

function factorial(n, total = 1) {
  if (n === 1) return total;
  return factorial(n - 1, n * total);
}

factorial(5) // 120
ä¸Šé¢ä»£ç ä¸­ï¼Œå‚æ•° total æœ‰é»˜è®¤å€¼1ï¼Œæ‰€ä»¥è°ƒç”¨æ—¶ä¸ç”¨æä¾›è¿™ä¸ªå€¼ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œé€’å½’æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å¾ªç¯æ“ä½œã€‚çº¯ç²¹çš„å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€æ²¡æœ‰å¾ªç¯æ“ä½œå‘½ä»¤ï¼Œæ‰€æœ‰çš„å¾ªç¯éƒ½ç”¨é€’å½’å®ç°ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå°¾é€’å½’å¯¹è¿™äº›è¯­è¨€æå…¶é‡è¦ã€‚å¯¹äºå…¶ä»–æ”¯æŒâ€œå°¾è°ƒç”¨ä¼˜åŒ–â€çš„è¯­è¨€ï¼ˆæ¯”å¦‚Luaï¼ŒES6ï¼‰ï¼Œåªéœ€è¦çŸ¥é“å¾ªç¯å¯ä»¥ç”¨é€’å½’ä»£æ›¿ï¼Œè€Œä¸€æ—¦ä½¿ç”¨é€’å½’ï¼Œå°±æœ€å¥½ä½¿ç”¨å°¾é€’å½’ã€‚

ä¸¥æ ¼æ¨¡å¼
ES6çš„å°¾è°ƒç”¨ä¼˜åŒ–åªåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹å¼€å¯ï¼Œæ­£å¸¸æ¨¡å¼æ˜¯æ— æ•ˆçš„ã€‚

è¿™æ˜¯å› ä¸ºåœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå‡½æ•°å†…éƒ¨æœ‰ä¸¤ä¸ªå˜é‡ï¼Œå¯ä»¥è·Ÿè¸ªå‡½æ•°çš„è°ƒç”¨æ ˆã€‚

func.argumentsï¼šè¿”å›è°ƒç”¨æ—¶å‡½æ•°çš„å‚æ•°ã€‚
func.callerï¼šè¿”å›è°ƒç”¨å½“å‰å‡½æ•°çš„é‚£ä¸ªå‡½æ•°ã€‚
å°¾è°ƒç”¨ä¼˜åŒ–å‘ç”Ÿæ—¶ï¼Œå‡½æ•°çš„è°ƒç”¨æ ˆä¼šæ”¹å†™ï¼Œå› æ­¤ä¸Šé¢ä¸¤ä¸ªå˜é‡å°±ä¼šå¤±çœŸã€‚ä¸¥æ ¼æ¨¡å¼ç¦ç”¨è¿™ä¸¤ä¸ªå˜é‡ï¼Œæ‰€ä»¥å°¾è°ƒç”¨æ¨¡å¼ä»…åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ç”Ÿæ•ˆã€‚

function restricted() {
  "use strict";
  restricted.caller;    // æŠ¥é”™
  restricted.arguments; // æŠ¥é”™
}
restricted();
å°¾é€’å½’ä¼˜åŒ–çš„å®ç°
å°¾é€’å½’ä¼˜åŒ–åªåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæˆ–è€…é‚£äº›ä¸æ”¯æŒè¯¥åŠŸèƒ½çš„ç¯å¢ƒä¸­ï¼Œæœ‰æ²¡æœ‰åŠæ³•ä¹Ÿä½¿ç”¨å°¾é€’å½’ä¼˜åŒ–å‘¢ï¼Ÿå›ç­”æ˜¯å¯ä»¥çš„ï¼Œå°±æ˜¯è‡ªå·±å®ç°å°¾é€’å½’ä¼˜åŒ–ã€‚

å®ƒçš„åŸç†éå¸¸ç®€å•ã€‚å°¾é€’å½’ä¹‹æ‰€ä»¥éœ€è¦ä¼˜åŒ–ï¼ŒåŸå› æ˜¯è°ƒç”¨æ ˆå¤ªå¤šï¼Œé€ æˆæº¢å‡ºï¼Œé‚£ä¹ˆåªè¦å‡å°‘è°ƒç”¨æ ˆï¼Œå°±ä¸ä¼šæº¢å‡ºã€‚æ€ä¹ˆåšå¯ä»¥å‡å°‘è°ƒç”¨æ ˆå‘¢ï¼Ÿå°±æ˜¯é‡‡ç”¨â€œå¾ªç¯â€æ¢æ‰â€œé€’å½’â€ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæ­£å¸¸çš„é€’å½’å‡½æ•°ã€‚

function sum(x, y) {
  if (y > 0) {
    return sum(x + 1, y - 1);
  } else {
    return x;
  }
}

sum(1, 100000)
// Uncaught RangeError: Maximum call stack size exceeded(â€¦)
ä¸Šé¢ä»£ç ä¸­ï¼Œsumæ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œå‚æ•°xæ˜¯éœ€è¦ç´¯åŠ çš„å€¼ï¼Œå‚æ•°yæ§åˆ¶é€’å½’æ¬¡æ•°ã€‚ä¸€æ—¦æŒ‡å®šsumé€’å½’100000æ¬¡ï¼Œå°±ä¼šæŠ¥é”™ï¼Œæç¤ºè¶…å‡ºè°ƒç”¨æ ˆçš„æœ€å¤§æ¬¡æ•°ã€‚

è¹¦åºŠå‡½æ•°ï¼ˆtrampolineï¼‰å¯ä»¥å°†é€’å½’æ‰§è¡Œè½¬ä¸ºå¾ªç¯æ‰§è¡Œã€‚

function trampoline(f) {
  while (f && f instanceof Function) {
    f = f();
  }
  return f;
}
ä¸Šé¢å°±æ˜¯è¹¦åºŠå‡½æ•°çš„ä¸€ä¸ªå®ç°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°fä½œä¸ºå‚æ•°ã€‚åªè¦fæ‰§è¡Œåè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå°±ç»§ç»­æ‰§è¡Œã€‚æ³¨æ„ï¼Œè¿™é‡Œæ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åæ‰§è¡Œè¯¥å‡½æ•°ï¼Œè€Œä¸æ˜¯å‡½æ•°é‡Œé¢è°ƒç”¨å‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†é€’å½’æ‰§è¡Œï¼Œä»è€Œå°±æ¶ˆé™¤äº†è°ƒç”¨æ ˆè¿‡å¤§çš„é—®é¢˜ã€‚

ç„¶åï¼Œè¦åšçš„å°±æ˜¯å°†åŸæ¥çš„é€’å½’å‡½æ•°ï¼Œæ”¹å†™ä¸ºæ¯ä¸€æ­¥è¿”å›å¦ä¸€ä¸ªå‡½æ•°ã€‚

function sum(x, y) {
  if (y > 0) {
    return sum.bind(null, x + 1, y - 1);
  } else {
    return x;
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œsumå‡½æ•°çš„æ¯æ¬¡æ‰§è¡Œï¼Œéƒ½ä¼šè¿”å›è‡ªèº«çš„å¦ä¸€ä¸ªç‰ˆæœ¬ã€‚

ç°åœ¨ï¼Œä½¿ç”¨è¹¦åºŠå‡½æ•°æ‰§è¡Œsumï¼Œå°±ä¸ä¼šå‘ç”Ÿè°ƒç”¨æ ˆæº¢å‡ºã€‚

trampoline(sum(1, 100000))
// 100001
è¹¦åºŠå‡½æ•°å¹¶ä¸æ˜¯çœŸæ­£çš„å°¾é€’å½’ä¼˜åŒ–ï¼Œä¸‹é¢çš„å®ç°æ‰æ˜¯ã€‚

function tco(f) {
  var value;
  var active = false;
  var accumulated = [];

  return function accumulator() {
    accumulated.push(arguments);
    if (!active) {
      active = true;
      while (accumulated.length) {
        value = f.apply(this, accumulated.shift());
      }
      active = false;
      return value;
    }
  };
}

var sum = tco(function(x, y) {
  if (y > 0) {
    return sum(x + 1, y - 1)
  }
  else {
    return x
  }
});

sum(1, 100000)
// 100001
ä¸Šé¢ä»£ç ä¸­ï¼Œtcoå‡½æ•°æ˜¯å°¾é€’å½’ä¼˜åŒ–çš„å®ç°ï¼Œå®ƒçš„å¥¥å¦™å°±åœ¨äºçŠ¶æ€å˜é‡activeã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå˜é‡æ˜¯ä¸æ¿€æ´»çš„ã€‚ä¸€æ—¦è¿›å…¥å°¾é€’å½’ä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå˜é‡å°±æ¿€æ´»äº†ã€‚ç„¶åï¼Œæ¯ä¸€è½®é€’å½’sumè¿”å›çš„éƒ½æ˜¯undefinedï¼Œæ‰€ä»¥å°±é¿å…äº†é€’å½’æ‰§è¡Œï¼›è€Œaccumulatedæ•°ç»„å­˜æ”¾æ¯ä¸€è½®sumæ‰§è¡Œçš„å‚æ•°ï¼Œæ€»æ˜¯æœ‰å€¼çš„ï¼Œè¿™å°±ä¿è¯äº†accumulatorå‡½æ•°å†…éƒ¨çš„whileå¾ªç¯æ€»æ˜¯ä¼šæ‰§è¡Œã€‚è¿™æ ·å°±å¾ˆå·§å¦™åœ°å°†â€œé€’å½’â€æ”¹æˆäº†â€œå¾ªç¯â€ï¼Œè€Œåä¸€è½®çš„å‚æ•°ä¼šå–ä»£å‰ä¸€è½®çš„å‚æ•°ï¼Œä¿è¯äº†è°ƒç”¨æ ˆåªæœ‰ä¸€å±‚ã€‚

å‡½æ•°å‚æ•°çš„å°¾é€—å·
ECMAScript 2017å°†å…è®¸å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°æœ‰å°¾é€—å·ï¼ˆtrailing commaï¼‰ã€‚

æ­¤å‰ï¼Œå‡½æ•°å®šä¹‰å’Œè°ƒç”¨æ—¶ï¼Œéƒ½ä¸å…è®¸æœ€åä¸€ä¸ªå‚æ•°åé¢å‡ºç°é€—å·ã€‚

function clownsEverywhere(
  param1,
  param2
) { /* ... */ }

clownsEverywhere(
  'foo',
  'bar'
);
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœåœ¨param2æˆ–baråé¢åŠ ä¸€ä¸ªé€—å·ï¼Œå°±ä¼šæŠ¥é”™ã€‚

è¿™æ ·çš„è¯ï¼Œå¦‚æœä»¥åä¿®æ”¹ä»£ç ï¼Œæƒ³ä¸ºå‡½æ•°clownsEverywhereæ·»åŠ ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå°±åŠ¿å¿…è¦åœ¨ç¬¬äºŒä¸ªå‚æ•°åé¢æ·»åŠ ä¸€ä¸ªé€—å·ã€‚è¿™å¯¹ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿæ¥è¯´ï¼Œå°±ä¼šæ˜¾ç¤ºï¼Œæ·»åŠ é€—å·çš„é‚£ä¸€è¡Œä¹Ÿå‘ç”Ÿäº†å˜åŠ¨ã€‚è¿™çœ‹ä¸Šå»æœ‰ç‚¹å†—ä½™ï¼Œå› æ­¤æ–°çš„è¯­æ³•å…è®¸å®šä¹‰å’Œè°ƒç”¨æ—¶ï¼Œå°¾éƒ¨ç›´æ¥æœ‰ä¸€ä¸ªé€—å·ã€‚

function clownsEverywhere(
  param1,
  param2,
) { /* ... */ }

clownsEverywhere(
  'foo',
  'bar',
);

##å¯¹è±¡çš„æ‰©å±•
1.å±æ€§çš„ç®€æ´è¡¨ç¤ºæ³•
ES6å…è®¸ç›´æ¥å†™å…¥å˜é‡å’Œå‡½æ•°ï¼Œä½œä¸ºå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚è¿™æ ·çš„ä¹¦å†™æ›´åŠ ç®€æ´ã€‚

var foo = 'bar';
var baz = {foo};
baz // {foo: "bar"}

// ç­‰åŒäº
var baz = {foo: foo};
ä¸Šé¢ä»£ç è¡¨æ˜ï¼ŒES6å…è®¸åœ¨å¯¹è±¡ä¹‹ä¸­ï¼Œç›´æ¥å†™å˜é‡ã€‚è¿™æ—¶ï¼Œå±æ€§åä¸ºå˜é‡å, å±æ€§å€¼ä¸ºå˜é‡çš„å€¼ã€‚ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

function f(x, y) {
  return {x, y};
}

// ç­‰åŒäº

function f(x, y) {
  return {x: x, y: y};
}

f(1, 2) // Object {x: 1, y: 2}
é™¤äº†å±æ€§ç®€å†™ï¼Œæ–¹æ³•ä¹Ÿå¯ä»¥ç®€å†™ã€‚

var o = {
  method() {
    return "Hello!";
  }
};

// ç­‰åŒäº

var o = {
  method: function() {
    return "Hello!";
  }
};
ä¸‹é¢æ˜¯ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚

var birth = '2000/01/01';

var Person = {

  name: 'å¼ ä¸‰',

  //ç­‰åŒäºbirth: birth
  birth,

  // ç­‰åŒäºhello: function ()...
  hello() { console.log('æˆ‘çš„åå­—æ˜¯', this.name); }

};
è¿™ç§å†™æ³•ç”¨äºå‡½æ•°çš„è¿”å›å€¼ï¼Œå°†ä¼šéå¸¸æ–¹ä¾¿ã€‚

function getPoint() {
  var x = 1;
  var y = 10;
  return {x, y};
}

getPoint()
// {x:1, y:10}
CommonJSæ¨¡å—è¾“å‡ºå˜é‡ï¼Œå°±éå¸¸åˆé€‚ä½¿ç”¨ç®€æ´å†™æ³•ã€‚

var ms = {};

function getItem (key) {
  return key in ms ? ms[key] : null;
}

function setItem (key, value) {
  ms[key] = value;
}

function clear () {
  ms = {};
}

module.exports = { getItem, setItem, clear };
// ç­‰åŒäº
module.exports = {
  getItem: getItem,
  setItem: setItem,
  clear: clear
};
å±æ€§çš„èµ‹å€¼å™¨ï¼ˆsetterï¼‰å’Œå–å€¼å™¨ï¼ˆgetterï¼‰ï¼Œäº‹å®ä¸Šä¹Ÿæ˜¯é‡‡ç”¨è¿™ç§å†™æ³•ã€‚

var cart = {
  _wheels: 4,

  get wheels () {
    return this._wheels;
  },

  set wheels (value) {
    if (value < this._wheels) {
      throw new Error('æ•°å€¼å¤ªå°äº†ï¼');
    }
    this._wheels = value;
  }
}
æ³¨æ„ï¼Œç®€æ´å†™æ³•çš„å±æ€§åæ€»æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™ä¼šå¯¼è‡´ä¸€äº›çœ‹ä¸Šå»æ¯”è¾ƒå¥‡æ€ªçš„ç»“æœã€‚

var obj = {
  class () {}
};

// ç­‰åŒäº

var obj = {
  'class': function() {}
};
ä¸Šé¢ä»£ç ä¸­ï¼Œclassæ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸ä¼šå› ä¸ºå®ƒå±äºå…³é”®å­—ï¼Œè€Œå¯¼è‡´è¯­æ³•è§£ææŠ¥é”™ã€‚

å¦‚æœæŸä¸ªæ–¹æ³•çš„å€¼æ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œå‰é¢éœ€è¦åŠ ä¸Šæ˜Ÿå·ã€‚

var obj = {
  * m(){
    yield 'hello world';
  }
};
å±æ€§åè¡¨è¾¾å¼
JavaScriptè¯­è¨€å®šä¹‰å¯¹è±¡çš„å±æ€§ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ã€‚

// æ–¹æ³•ä¸€
obj.foo = true;

// æ–¹æ³•äºŒ
obj['a' + 'bc'] = 123;
ä¸Šé¢ä»£ç çš„æ–¹æ³•ä¸€æ˜¯ç›´æ¥ç”¨æ ‡è¯†ç¬¦ä½œä¸ºå±æ€§åï¼Œæ–¹æ³•äºŒæ˜¯ç”¨è¡¨è¾¾å¼ä½œä¸ºå±æ€§åï¼Œè¿™æ—¶è¦å°†è¡¨è¾¾å¼æ”¾åœ¨æ–¹æ‹¬å·ä¹‹å†…ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½¿ç”¨å­—é¢é‡æ–¹å¼å®šä¹‰å¯¹è±¡ï¼ˆä½¿ç”¨å¤§æ‹¬å·ï¼‰ï¼Œåœ¨ ES5 ä¸­åªèƒ½ä½¿ç”¨æ–¹æ³•ä¸€ï¼ˆæ ‡è¯†ç¬¦ï¼‰å®šä¹‰å±æ€§ã€‚

var obj = {
  foo: true,
  abc: 123
};
ES6 å…è®¸å­—é¢é‡å®šä¹‰å¯¹è±¡æ—¶ï¼Œç”¨æ–¹æ³•äºŒï¼ˆè¡¨è¾¾å¼ï¼‰ä½œä¸ºå¯¹è±¡çš„å±æ€§åï¼Œå³æŠŠè¡¨è¾¾å¼æ”¾åœ¨æ–¹æ‹¬å·å†…ã€‚

let propKey = 'foo';

let obj = {
  [propKey]: true,
  ['a' + 'bc']: 123
};
ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

var lastWord = 'last word';

var a = {
  'first word': 'hello',
  [lastWord]: 'world'
};

a['first word'] // "hello"
a[lastWord] // "world"
a['last word'] // "world"
è¡¨è¾¾å¼è¿˜å¯ä»¥ç”¨äºå®šä¹‰æ–¹æ³•åã€‚

let obj = {
  ['h' + 'ello']() {
    return 'hi';
  }
};

obj.hello() // hi
æ³¨æ„ï¼Œå±æ€§åè¡¨è¾¾å¼ä¸ç®€æ´è¡¨ç¤ºæ³•ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼Œä¼šæŠ¥é”™ã€‚

// æŠ¥é”™
var foo = 'bar';
var bar = 'abc';
var baz = { [foo] };

// æ­£ç¡®
var foo = 'bar';
var baz = { [foo]: 'abc'};
æ³¨æ„ï¼Œå±æ€§åè¡¨è¾¾å¼å¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šè‡ªåŠ¨å°†å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²[object Object]ï¼Œè¿™ä¸€ç‚¹è¦ç‰¹åˆ«å°å¿ƒã€‚

const keyA = {a: 1};
const keyB = {b: 2};

const myObject = {
  [keyA]: 'valueA',
  [keyB]: 'valueB'
};

myObject // Object {[object Object]: "valueB"}
ä¸Šé¢ä»£ç ä¸­ï¼Œ[keyA]å’Œ[keyB]å¾—åˆ°çš„éƒ½æ˜¯[object Object]ï¼Œæ‰€ä»¥[keyB]ä¼šæŠŠ[keyA]è¦†ç›–æ‰ï¼Œè€ŒmyObjectæœ€ååªæœ‰ä¸€ä¸ª[object Object]å±æ€§ã€‚

æ–¹æ³•çš„ name å±æ€§
å‡½æ•°çš„nameå±æ€§ï¼Œè¿”å›å‡½æ•°åã€‚å¯¹è±¡æ–¹æ³•ä¹Ÿæ˜¯å‡½æ•°ï¼Œå› æ­¤ä¹Ÿæœ‰nameå±æ€§ã€‚

var person = {
  sayName() {
    console.log(this.name);
  },
  get firstName() {
    return "Nicholas";
  }
};

person.sayName.name   // "sayName"
person.firstName.name // "get firstName"
ä¸Šé¢ä»£ç ä¸­ï¼Œæ–¹æ³•çš„nameå±æ€§è¿”å›å‡½æ•°åï¼ˆå³æ–¹æ³•åï¼‰ã€‚å¦‚æœä½¿ç”¨äº†å–å€¼å‡½æ•°ï¼Œåˆ™ä¼šåœ¨æ–¹æ³•åå‰åŠ ä¸Šgetã€‚å¦‚æœæ˜¯å­˜å€¼å‡½æ•°ï¼Œæ–¹æ³•åçš„å‰é¢ä¼šåŠ ä¸Šsetã€‚

æœ‰ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼šbindæ–¹æ³•åˆ›é€ çš„å‡½æ•°ï¼Œnameå±æ€§è¿”å›â€œboundâ€åŠ ä¸ŠåŸå‡½æ•°çš„åå­—ï¼›Functionæ„é€ å‡½æ•°åˆ›é€ çš„å‡½æ•°ï¼Œnameå±æ€§è¿”å›â€œanonymousâ€ã€‚

(new Function()).name // "anonymous"

var doSomething = function() {
  // ...
};
doSomething.bind().name // "bound doSomething"
å¦‚æœå¯¹è±¡çš„æ–¹æ³•æ˜¯ä¸€ä¸ªSymbolå€¼ï¼Œé‚£ä¹ˆnameå±æ€§è¿”å›çš„æ˜¯è¿™ä¸ªSymbolå€¼çš„æè¿°ã€‚

const key1 = Symbol('description');
const key2 = Symbol();
let obj = {
  [key1]() {},
  [key2]() {},
};
obj[key1].name // "[description]"
obj[key2].name // ""
ä¸Šé¢ä»£ç ä¸­ï¼Œkey1å¯¹åº”çš„Symbolå€¼æœ‰æè¿°ï¼Œkey2æ²¡æœ‰ã€‚

Object.is()
ES5æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰ä¸¤ä¸ªè¿ç®—ç¬¦ï¼šç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ==ï¼‰å’Œä¸¥æ ¼ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ===ï¼‰ã€‚å®ƒä»¬éƒ½æœ‰ç¼ºç‚¹ï¼Œå‰è€…ä¼šè‡ªåŠ¨è½¬æ¢æ•°æ®ç±»å‹ï¼Œåè€…çš„NaNä¸ç­‰äºè‡ªèº«ï¼Œä»¥åŠ+0ç­‰äº-0ã€‚JavaScriptç¼ºä¹ä¸€ç§è¿ç®—ï¼Œåœ¨æ‰€æœ‰ç¯å¢ƒä¸­ï¼Œåªè¦ä¸¤ä¸ªå€¼æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬å°±åº”è¯¥ç›¸ç­‰ã€‚

ES6æå‡ºâ€œSame-value equalityâ€ï¼ˆåŒå€¼ç›¸ç­‰ï¼‰ç®—æ³•ï¼Œç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚Object.iså°±æ˜¯éƒ¨ç½²è¿™ä¸ªç®—æ³•çš„æ–°æ–¹æ³•ã€‚å®ƒç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ä¸¥æ ¼ç›¸ç­‰ï¼Œä¸ä¸¥æ ¼æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ===ï¼‰çš„è¡Œä¸ºåŸºæœ¬ä¸€è‡´ã€‚

Object.is('foo', 'foo')
// true
Object.is({}, {})
// false
ä¸åŒä¹‹å¤„åªæœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯+0ä¸ç­‰äº-0ï¼ŒäºŒæ˜¯NaNç­‰äºè‡ªèº«ã€‚

+0 === -0 //true
NaN === NaN // false

Object.is(+0, -0) // false
Object.is(NaN, NaN) // true
ES5å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œéƒ¨ç½²Object.isã€‚

Object.defineProperty(Object, 'is', {
  value: function(x, y) {
    if (x === y) {
      // é’ˆå¯¹+0 ä¸ç­‰äº -0çš„æƒ…å†µ
      return x !== 0 || 1 / x === 1 / y;
    }
    // é’ˆå¯¹NaNçš„æƒ…å†µ
    return x !== x && y !== y;
  },
  configurable: true,
  enumerable: false,
  writable: true
});
Object.assign()
åŸºæœ¬ç”¨æ³•
Object.assignæ–¹æ³•ç”¨äºå¯¹è±¡çš„åˆå¹¶ï¼Œå°†æºå¯¹è±¡ï¼ˆsourceï¼‰çš„æ‰€æœ‰å¯æšä¸¾å±æ€§ï¼Œå¤åˆ¶åˆ°ç›®æ ‡å¯¹è±¡ï¼ˆtargetï¼‰ã€‚

var target = { a: 1 };

var source1 = { b: 2 };
var source2 = { c: 3 };

Object.assign(target, source1, source2);
target // {a:1, b:2, c:3}
Object.assignæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡å¯¹è±¡ï¼Œåé¢çš„å‚æ•°éƒ½æ˜¯æºå¯¹è±¡ã€‚

æ³¨æ„ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡ä¸æºå¯¹è±¡æœ‰åŒåå±æ€§ï¼Œæˆ–å¤šä¸ªæºå¯¹è±¡æœ‰åŒåå±æ€§ï¼Œåˆ™åé¢çš„å±æ€§ä¼šè¦†ç›–å‰é¢çš„å±æ€§ã€‚

var target = { a: 1, b: 1 };

var source1 = { b: 2, c: 2 };
var source2 = { c: 3 };

Object.assign(target, source1, source2);
target // {a:1, b:2, c:3}
å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼ŒObject.assignä¼šç›´æ¥è¿”å›è¯¥å‚æ•°ã€‚

var obj = {a: 1};
Object.assign(obj) === obj // true
å¦‚æœè¯¥å‚æ•°ä¸æ˜¯å¯¹è±¡ï¼Œåˆ™ä¼šå…ˆè½¬æˆå¯¹è±¡ï¼Œç„¶åè¿”å›ã€‚

typeof Object.assign(2) // "object"
ç”±äºundefinedå’Œnullæ— æ³•è½¬æˆå¯¹è±¡ï¼Œæ‰€ä»¥å¦‚æœå®ƒä»¬ä½œä¸ºå‚æ•°ï¼Œå°±ä¼šæŠ¥é”™ã€‚

Object.assign(undefined) // æŠ¥é”™
Object.assign(null) // æŠ¥é”™
å¦‚æœéå¯¹è±¡å‚æ•°å‡ºç°åœ¨æºå¯¹è±¡çš„ä½ç½®ï¼ˆå³éé¦–å‚æ•°ï¼‰ï¼Œé‚£ä¹ˆå¤„ç†è§„åˆ™æœ‰æ‰€ä¸åŒã€‚é¦–å…ˆï¼Œè¿™äº›å‚æ•°éƒ½ä¼šè½¬æˆå¯¹è±¡ï¼Œå¦‚æœæ— æ³•è½¬æˆå¯¹è±¡ï¼Œå°±ä¼šè·³è¿‡ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœundefinedå’Œnullä¸åœ¨é¦–å‚æ•°ï¼Œå°±ä¸ä¼šæŠ¥é”™ã€‚

let obj = {a: 1};
Object.assign(obj, undefined) === obj // true
Object.assign(obj, null) === obj // true
å…¶ä»–ç±»å‹çš„å€¼ï¼ˆå³æ•°å€¼ã€å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼ï¼‰ä¸åœ¨é¦–å‚æ•°ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ã€‚ä½†æ˜¯ï¼Œé™¤äº†å­—ç¬¦ä¸²ä¼šä»¥æ•°ç»„å½¢å¼ï¼Œæ‹·è´å…¥ç›®æ ‡å¯¹è±¡ï¼Œå…¶ä»–å€¼éƒ½ä¸ä¼šäº§ç”Ÿæ•ˆæœã€‚

var v1 = 'abc';
var v2 = true;
var v3 = 10;

var obj = Object.assign({}, v1, v2, v3);
console.log(obj); // { "0": "a", "1": "b", "2": "c" }
ä¸Šé¢ä»£ç ä¸­ï¼Œv1ã€v2ã€v3åˆ†åˆ«æ˜¯å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼å’Œæ•°å€¼ï¼Œç»“æœåªæœ‰å­—ç¬¦ä¸²åˆå…¥ç›®æ ‡å¯¹è±¡ï¼ˆä»¥å­—ç¬¦æ•°ç»„çš„å½¢å¼ï¼‰ï¼Œæ•°å€¼å’Œå¸ƒå°”å€¼éƒ½ä¼šè¢«å¿½ç•¥ã€‚è¿™æ˜¯å› ä¸ºåªæœ‰å­—ç¬¦ä¸²çš„åŒ…è£…å¯¹è±¡ï¼Œä¼šäº§ç”Ÿå¯æšä¸¾å±æ€§ã€‚

Object(true) // {[[PrimitiveValue]]: true}
Object(10)  //  {[[PrimitiveValue]]: 10}
Object('abc') // {0: "a", 1: "b", 2: "c", length: 3, [[PrimitiveValue]]: "abc"}
ä¸Šé¢ä»£ç ä¸­ï¼Œå¸ƒå°”å€¼ã€æ•°å€¼ã€å­—ç¬¦ä¸²åˆ†åˆ«è½¬æˆå¯¹åº”çš„åŒ…è£…å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°å®ƒä»¬çš„åŸå§‹å€¼éƒ½åœ¨åŒ…è£…å¯¹è±¡çš„å†…éƒ¨å±æ€§[[PrimitiveValue]]ä¸Šé¢ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸ä¼šè¢«Object.assignæ‹·è´çš„ã€‚åªæœ‰å­—ç¬¦ä¸²çš„åŒ…è£…å¯¹è±¡ï¼Œä¼šäº§ç”Ÿå¯æšä¸¾çš„å®ä¹‰å±æ€§ï¼Œé‚£äº›å±æ€§åˆ™ä¼šè¢«æ‹·è´ã€‚

Object.assignæ‹·è´çš„å±æ€§æ˜¯æœ‰é™åˆ¶çš„ï¼Œåªæ‹·è´æºå¯¹è±¡çš„è‡ªèº«å±æ€§ï¼ˆä¸æ‹·è´ç»§æ‰¿å±æ€§ï¼‰ï¼Œä¹Ÿä¸æ‹·è´ä¸å¯æšä¸¾çš„å±æ€§ï¼ˆenumerable: falseï¼‰ã€‚

Object.assign({b: 'c'},
  Object.defineProperty({}, 'invisible', {
    enumerable: false,
    value: 'hello'
  })
)
// { b: 'c' }
ä¸Šé¢ä»£ç ä¸­ï¼ŒObject.assignè¦æ‹·è´çš„å¯¹è±¡åªæœ‰ä¸€ä¸ªä¸å¯æšä¸¾å±æ€§invisibleï¼Œè¿™ä¸ªå±æ€§å¹¶æ²¡æœ‰è¢«æ‹·è´è¿›å»ã€‚

å±æ€§åä¸ºSymbolå€¼çš„å±æ€§ï¼Œä¹Ÿä¼šè¢«Object.assignæ‹·è´ã€‚

Object.assign({ a: 'b' }, { [Symbol('c')]: 'd' })
// { a: 'b', Symbol(c): 'd' }
æ³¨æ„ç‚¹
Object.assignæ–¹æ³•å®è¡Œçš„æ˜¯æµ…æ‹·è´ï¼Œè€Œä¸æ˜¯æ·±æ‹·è´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæºå¯¹è±¡æŸä¸ªå±æ€§çš„å€¼æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆç›®æ ‡å¯¹è±¡æ‹·è´å¾—åˆ°çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚

var obj1 = {a: {b: 1}};
var obj2 = Object.assign({}, obj1);

obj1.a.b = 2;
obj2.a.b // 2
ä¸Šé¢ä»£ç ä¸­ï¼Œæºå¯¹è±¡obj1çš„aå±æ€§çš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒObject.assignæ‹·è´å¾—åˆ°çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚è¿™ä¸ªå¯¹è±¡çš„ä»»ä½•å˜åŒ–ï¼Œéƒ½ä¼šåæ˜ åˆ°ç›®æ ‡å¯¹è±¡ä¸Šé¢ã€‚

å¯¹äºè¿™ç§åµŒå¥—çš„å¯¹è±¡ï¼Œä¸€æ—¦é‡åˆ°åŒåå±æ€§ï¼ŒObject.assignçš„å¤„ç†æ–¹æ³•æ˜¯æ›¿æ¢ï¼Œè€Œä¸æ˜¯æ·»åŠ ã€‚

var target = { a: { b: 'c', d: 'e' } }
var source = { a: { b: 'hello' } }
Object.assign(target, source)
// { a: { b: 'hello' } }
ä¸Šé¢ä»£ç ä¸­ï¼Œtargetå¯¹è±¡çš„aå±æ€§è¢«sourceå¯¹è±¡çš„aå±æ€§æ•´ä¸ªæ›¿æ¢æ‰äº†ï¼Œè€Œä¸ä¼šå¾—åˆ°{ a: { b: 'hello', d: 'e' } }çš„ç»“æœã€‚è¿™é€šå¸¸ä¸æ˜¯å¼€å‘è€…æƒ³è¦çš„ï¼Œéœ€è¦ç‰¹åˆ«å°å¿ƒã€‚

æœ‰ä¸€äº›å‡½æ•°åº“æä¾›Object.assignçš„å®šåˆ¶ç‰ˆæœ¬ï¼ˆæ¯”å¦‚Lodashçš„_.defaultsDeepæ–¹æ³•ï¼‰ï¼Œå¯ä»¥è§£å†³æµ…æ‹·è´çš„é—®é¢˜ï¼Œå¾—åˆ°æ·±æ‹·è´çš„åˆå¹¶ã€‚

æ³¨æ„ï¼ŒObject.assignå¯ä»¥ç”¨æ¥å¤„ç†æ•°ç»„ï¼Œä½†æ˜¯ä¼šæŠŠæ•°ç»„è§†ä¸ºå¯¹è±¡ã€‚

Object.assign([1, 2, 3], [4, 5])
// [4, 5, 3]
ä¸Šé¢ä»£ç ä¸­ï¼ŒObject.assignæŠŠæ•°ç»„è§†ä¸ºå±æ€§åä¸º0ã€1ã€2çš„å¯¹è±¡ï¼Œå› æ­¤æºæ•°ç»„çš„0å·å±æ€§4è¦†ç›–äº†ç›®æ ‡æ•°ç»„çš„0å·å±æ€§1ã€‚

å¸¸è§ç”¨é€”
Object.assignæ–¹æ³•æœ‰å¾ˆå¤šç”¨å¤„ã€‚

ï¼ˆ1ï¼‰ä¸ºå¯¹è±¡æ·»åŠ å±æ€§

class Point {
  constructor(x, y) {
    Object.assign(this, {x, y});
  }
}
ä¸Šé¢æ–¹æ³•é€šè¿‡Object.assignæ–¹æ³•ï¼Œå°†xå±æ€§å’Œyå±æ€§æ·»åŠ åˆ°Pointç±»çš„å¯¹è±¡å®ä¾‹ã€‚

ï¼ˆ2ï¼‰ä¸ºå¯¹è±¡æ·»åŠ æ–¹æ³•

Object.assign(SomeClass.prototype, {
  someMethod(arg1, arg2) {
    Â·Â·Â·
  },
  anotherMethod() {
    Â·Â·Â·
  }
});

// ç­‰åŒäºä¸‹é¢çš„å†™æ³•
SomeClass.prototype.someMethod = function (arg1, arg2) {
  Â·Â·Â·
};
SomeClass.prototype.anotherMethod = function () {
  Â·Â·Â·
};
ä¸Šé¢ä»£ç ä½¿ç”¨äº†å¯¹è±¡å±æ€§çš„ç®€æ´è¡¨ç¤ºæ³•ï¼Œç›´æ¥å°†ä¸¤ä¸ªå‡½æ•°æ”¾åœ¨å¤§æ‹¬å·ä¸­ï¼Œå†ä½¿ç”¨assignæ–¹æ³•æ·»åŠ åˆ°SomeClass.prototypeä¹‹ä¸­ã€‚

ï¼ˆ3ï¼‰å…‹éš†å¯¹è±¡

function clone(origin) {
  return Object.assign({}, origin);
}
ä¸Šé¢ä»£ç å°†åŸå§‹å¯¹è±¡æ‹·è´åˆ°ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå°±å¾—åˆ°äº†åŸå§‹å¯¹è±¡çš„å…‹éš†ã€‚

ä¸è¿‡ï¼Œé‡‡ç”¨è¿™ç§æ–¹æ³•å…‹éš†ï¼Œåªèƒ½å…‹éš†åŸå§‹å¯¹è±¡è‡ªèº«çš„å€¼ï¼Œä¸èƒ½å…‹éš†å®ƒç»§æ‰¿çš„å€¼ã€‚å¦‚æœæƒ³è¦ä¿æŒç»§æ‰¿é“¾ï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„ä»£ç ã€‚

function clone(origin) {
  let originProto = Object.getPrototypeOf(origin);
  return Object.assign(Object.create(originProto), origin);
}
ï¼ˆ4ï¼‰åˆå¹¶å¤šä¸ªå¯¹è±¡

å°†å¤šä¸ªå¯¹è±¡åˆå¹¶åˆ°æŸä¸ªå¯¹è±¡ã€‚

const merge =
  (target, ...sources) => Object.assign(target, ...sources);
å¦‚æœå¸Œæœ›åˆå¹¶åè¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå¯ä»¥æ”¹å†™ä¸Šé¢å‡½æ•°ï¼Œå¯¹ä¸€ä¸ªç©ºå¯¹è±¡åˆå¹¶ã€‚

const merge =
  (...sources) => Object.assign({}, ...sources);
ï¼ˆ5ï¼‰ä¸ºå±æ€§æŒ‡å®šé»˜è®¤å€¼

const DEFAULTS = {
  logLevel: 0,
  outputFormat: 'html'
};

function processContent(options) {
  options = Object.assign({}, DEFAULTS, options);
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒDEFAULTSå¯¹è±¡æ˜¯é»˜è®¤å€¼ï¼Œoptionså¯¹è±¡æ˜¯ç”¨æˆ·æä¾›çš„å‚æ•°ã€‚Object.assignæ–¹æ³•å°†DEFAULTSå’Œoptionsåˆå¹¶æˆä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå¦‚æœä¸¤è€…æœ‰åŒåå±æ€§ï¼Œåˆ™optionçš„å±æ€§å€¼ä¼šè¦†ç›–DEFAULTSçš„å±æ€§å€¼ã€‚

æ³¨æ„ï¼Œç”±äºå­˜åœ¨æ·±æ‹·è´çš„é—®é¢˜ï¼ŒDEFAULTSå¯¹è±¡å’Œoptionså¯¹è±¡çš„æ‰€æœ‰å±æ€§çš„å€¼ï¼Œéƒ½åªèƒ½æ˜¯ç®€å•ç±»å‹ï¼Œè€Œä¸èƒ½æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ã€‚å¦åˆ™ï¼Œå°†å¯¼è‡´DEFAULTSå¯¹è±¡çš„è¯¥å±æ€§ä¸èµ·ä½œç”¨ã€‚

å±æ€§çš„å¯æšä¸¾æ€§
å¯¹è±¡çš„æ¯ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªæè¿°å¯¹è±¡ï¼ˆDescriptorï¼‰ï¼Œç”¨æ¥æ§åˆ¶è¯¥å±æ€§çš„è¡Œä¸ºã€‚Object.getOwnPropertyDescriptoræ–¹æ³•å¯ä»¥è·å–è¯¥å±æ€§çš„æè¿°å¯¹è±¡ã€‚

let obj = { foo: 123 };
Object.getOwnPropertyDescriptor(obj, 'foo')
//  {
//    value: 123,
//    writable: true,
//    enumerable: true,
//    configurable: true
//  }
æè¿°å¯¹è±¡çš„enumerableå±æ€§ï¼Œç§°ä¸ºâ€å¯æšä¸¾æ€§â€œï¼Œå¦‚æœè¯¥å±æ€§ä¸ºfalseï¼Œå°±è¡¨ç¤ºæŸäº›æ“ä½œä¼šå¿½ç•¥å½“å‰å±æ€§ã€‚

ES5æœ‰ä¸‰ä¸ªæ“ä½œä¼šå¿½ç•¥enumerableä¸ºfalseçš„å±æ€§ã€‚

for...inå¾ªç¯ï¼šåªéå†å¯¹è±¡è‡ªèº«çš„å’Œç»§æ‰¿çš„å¯æšä¸¾çš„å±æ€§
Object.keys()ï¼šè¿”å›å¯¹è±¡è‡ªèº«çš„æ‰€æœ‰å¯æšä¸¾çš„å±æ€§çš„é”®å
JSON.stringify()ï¼šåªä¸²è¡ŒåŒ–å¯¹è±¡è‡ªèº«çš„å¯æšä¸¾çš„å±æ€§
ES6æ–°å¢äº†ä¸€ä¸ªæ“ä½œObject.assign()ï¼Œä¼šå¿½ç•¥enumerableä¸ºfalseçš„å±æ€§ï¼Œåªæ‹·è´å¯¹è±¡è‡ªèº«çš„å¯æšä¸¾çš„å±æ€§ã€‚

è¿™å››ä¸ªæ“ä½œä¹‹ä¸­ï¼Œåªæœ‰for...inä¼šè¿”å›ç»§æ‰¿çš„å±æ€§ã€‚å®é™…ä¸Šï¼Œå¼•å…¥enumerableçš„æœ€åˆç›®çš„ï¼Œå°±æ˜¯è®©æŸäº›å±æ€§å¯ä»¥è§„é¿æ‰for...inæ“ä½œã€‚æ¯”å¦‚ï¼Œå¯¹è±¡åŸå‹çš„toStringæ–¹æ³•ï¼Œä»¥åŠæ•°ç»„çš„lengthå±æ€§ï¼Œå°±é€šè¿‡è¿™ç§æ‰‹æ®µï¼Œä¸ä¼šè¢«for...inéå†åˆ°ã€‚

Object.getOwnPropertyDescriptor(Object.prototype, 'toString').enumerable
// false

Object.getOwnPropertyDescriptor([], 'length').enumerable
// false
ä¸Šé¢ä»£ç ä¸­ï¼ŒtoStringå’Œlengthå±æ€§çš„enumerableéƒ½æ˜¯falseï¼Œå› æ­¤for...inä¸ä¼šéå†åˆ°è¿™ä¸¤ä¸ªç»§æ‰¿è‡ªåŸå‹çš„å±æ€§ã€‚

å¦å¤–ï¼ŒES6è§„å®šï¼Œæ‰€æœ‰Classçš„åŸå‹çš„æ–¹æ³•éƒ½æ˜¯ä¸å¯æšä¸¾çš„ã€‚

Object.getOwnPropertyDescriptor(class {foo() {}}.prototype, 'foo').enumerable
// false
æ€»çš„æ¥è¯´ï¼Œæ“ä½œä¸­å¼•å…¥ç»§æ‰¿çš„å±æ€§ä¼šè®©é—®é¢˜å¤æ‚åŒ–ï¼Œå¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬åªå…³å¿ƒå¯¹è±¡è‡ªèº«çš„å±æ€§ã€‚æ‰€ä»¥ï¼Œå°½é‡ä¸è¦ç”¨for...inå¾ªç¯ï¼Œè€Œç”¨Object.keys()ä»£æ›¿ã€‚

å±æ€§çš„éå†
ES6ä¸€å…±æœ‰5ç§æ–¹æ³•å¯ä»¥éå†å¯¹è±¡çš„å±æ€§ã€‚

ï¼ˆ1ï¼‰for...in

for...inå¾ªç¯éå†å¯¹è±¡è‡ªèº«çš„å’Œç»§æ‰¿çš„å¯æšä¸¾å±æ€§ï¼ˆä¸å«Symbolå±æ€§ï¼‰ã€‚

ï¼ˆ2ï¼‰Object.keys(obj)

Object.keysè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…æ‹¬å¯¹è±¡è‡ªèº«çš„ï¼ˆä¸å«ç»§æ‰¿çš„ï¼‰æ‰€æœ‰å¯æšä¸¾å±æ€§ï¼ˆä¸å«Symbolå±æ€§ï¼‰ã€‚

ï¼ˆ3ï¼‰Object.getOwnPropertyNames(obj)

Object.getOwnPropertyNamesè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å¯¹è±¡è‡ªèº«çš„æ‰€æœ‰å±æ€§ï¼ˆä¸å«Symbolå±æ€§ï¼Œä½†æ˜¯åŒ…æ‹¬ä¸å¯æšä¸¾å±æ€§ï¼‰ã€‚

ï¼ˆ4ï¼‰Object.getOwnPropertySymbols(obj)

Object.getOwnPropertySymbolsè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å¯¹è±¡è‡ªèº«çš„æ‰€æœ‰Symbolå±æ€§ã€‚

ï¼ˆ5ï¼‰Reflect.ownKeys(obj)

Reflect.ownKeysè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å¯¹è±¡è‡ªèº«çš„æ‰€æœ‰å±æ€§ï¼Œä¸ç®¡æ˜¯å±æ€§åæ˜¯Symbolæˆ–å­—ç¬¦ä¸²ï¼Œä¹Ÿä¸ç®¡æ˜¯å¦å¯æšä¸¾ã€‚

ä»¥ä¸Šçš„5ç§æ–¹æ³•éå†å¯¹è±¡çš„å±æ€§ï¼Œéƒ½éµå®ˆåŒæ ·çš„å±æ€§éå†çš„æ¬¡åºè§„åˆ™ã€‚

é¦–å…ˆéå†æ‰€æœ‰å±æ€§åä¸ºæ•°å€¼çš„å±æ€§ï¼ŒæŒ‰ç…§æ•°å­—æ’åºã€‚
å…¶æ¬¡éå†æ‰€æœ‰å±æ€§åä¸ºå­—ç¬¦ä¸²çš„å±æ€§ï¼ŒæŒ‰ç…§ç”Ÿæˆæ—¶é—´æ’åºã€‚
æœ€åéå†æ‰€æœ‰å±æ€§åä¸ºSymbolå€¼çš„å±æ€§ï¼ŒæŒ‰ç…§ç”Ÿæˆæ—¶é—´æ’åºã€‚
Reflect.ownKeys({ [Symbol()]:0, b:0, 10:0, 2:0, a:0 })
// ['2', '10', 'b', 'a', Symbol()]
ä¸Šé¢ä»£ç ä¸­ï¼ŒReflect.ownKeysæ–¹æ³•è¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†å‚æ•°å¯¹è±¡çš„æ‰€æœ‰å±æ€§ã€‚è¿™ä¸ªæ•°ç»„çš„å±æ€§æ¬¡åºæ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæ˜¯æ•°å€¼å±æ€§2å’Œ10ï¼Œå…¶æ¬¡æ˜¯å­—ç¬¦ä¸²å±æ€§bå’Œaï¼Œæœ€åæ˜¯Symbolå±æ€§ã€‚

__proto__å±æ€§ï¼ŒObject.setPrototypeOf()ï¼ŒObject.getPrototypeOf()
ï¼ˆ1ï¼‰__proto__å±æ€§

__proto__å±æ€§ï¼ˆå‰åå„ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼‰ï¼Œç”¨æ¥è¯»å–æˆ–è®¾ç½®å½“å‰å¯¹è±¡çš„prototypeå¯¹è±¡ã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨ï¼ˆåŒ…æ‹¬IE11ï¼‰éƒ½éƒ¨ç½²äº†è¿™ä¸ªå±æ€§ã€‚

// es6çš„å†™æ³•
var obj = {
  method: function() { ... }
};
obj.__proto__ = someOtherObj;

// es5çš„å†™æ³•
var obj = Object.create(someOtherObj);
obj.method = function() { ... };
è¯¥å±æ€§æ²¡æœ‰å†™å…¥ES6çš„æ­£æ–‡ï¼Œè€Œæ˜¯å†™å…¥äº†é™„å½•ï¼ŒåŸå› æ˜¯__proto__å‰åçš„åŒä¸‹åˆ’çº¿ï¼Œè¯´æ˜å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå†…éƒ¨å±æ€§ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ­£å¼çš„å¯¹å¤–çš„APIï¼Œåªæ˜¯ç”±äºæµè§ˆå™¨å¹¿æ³›æ”¯æŒï¼Œæ‰è¢«åŠ å…¥äº†ES6ã€‚æ ‡å‡†æ˜ç¡®è§„å®šï¼Œåªæœ‰æµè§ˆå™¨å¿…é¡»éƒ¨ç½²è¿™ä¸ªå±æ€§ï¼Œå…¶ä»–è¿è¡Œç¯å¢ƒä¸ä¸€å®šéœ€è¦éƒ¨ç½²ï¼Œè€Œä¸”æ–°çš„ä»£ç æœ€å¥½è®¤ä¸ºè¿™ä¸ªå±æ€§æ˜¯ä¸å­˜åœ¨çš„ã€‚å› æ­¤ï¼Œæ— è®ºä»è¯­ä¹‰çš„è§’åº¦ï¼Œè¿˜æ˜¯ä»å…¼å®¹æ€§çš„è§’åº¦ï¼Œéƒ½ä¸è¦ä½¿ç”¨è¿™ä¸ªå±æ€§ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸‹é¢çš„Object.setPrototypeOf()ï¼ˆå†™æ“ä½œï¼‰ã€Object.getPrototypeOf()ï¼ˆè¯»æ“ä½œï¼‰ã€Object.create()ï¼ˆç”Ÿæˆæ“ä½œï¼‰ä»£æ›¿ã€‚

åœ¨å®ç°ä¸Šï¼Œ__proto__è°ƒç”¨çš„æ˜¯Object.prototype.__proto__ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ã€‚

Object.defineProperty(Object.prototype, '__proto__', {
  get() {
    let _thisObj = Object(this);
    return Object.getPrototypeOf(_thisObj);
  },
  set(proto) {
    if (this === undefined || this === null) {
      throw new TypeError();
    }
    if (!isObject(this)) {
      return undefined;
    }
    if (!isObject(proto)) {
      return undefined;
    }
    let status = Reflect.setPrototypeOf(this, proto);
    if (!status) {
      throw new TypeError();
    }
  },
});
function isObject(value) {
  return Object(value) === value;
}
å¦‚æœä¸€ä¸ªå¯¹è±¡æœ¬èº«éƒ¨ç½²äº†__proto__å±æ€§ï¼Œåˆ™è¯¥å±æ€§çš„å€¼å°±æ˜¯å¯¹è±¡çš„åŸå‹ã€‚

Object.getPrototypeOf({ __proto__: null })
// null
ï¼ˆ2ï¼‰Object.setPrototypeOf()

Object.setPrototypeOfæ–¹æ³•çš„ä½œç”¨ä¸__proto__ç›¸åŒï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ªå¯¹è±¡çš„prototypeå¯¹è±¡ã€‚å®ƒæ˜¯ES6æ­£å¼æ¨èçš„è®¾ç½®åŸå‹å¯¹è±¡çš„æ–¹æ³•ã€‚

// æ ¼å¼
Object.setPrototypeOf(object, prototype)

// ç”¨æ³•
var o = Object.setPrototypeOf({}, null);
è¯¥æ–¹æ³•ç­‰åŒäºä¸‹é¢çš„å‡½æ•°ã€‚

function (obj, proto) {
  obj.__proto__ = proto;
  return obj;
}
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

let proto = {};
let obj = { x: 10 };
Object.setPrototypeOf(obj, proto);

proto.y = 20;
proto.z = 40;

obj.x // 10
obj.y // 20
obj.z // 40
ä¸Šé¢ä»£ç å°†protoå¯¹è±¡è®¾ä¸ºobjå¯¹è±¡çš„åŸå‹ï¼Œæ‰€ä»¥ä»objå¯¹è±¡å¯ä»¥è¯»å–protoå¯¹è±¡çš„å±æ€§ã€‚

ï¼ˆ3ï¼‰Object.getPrototypeOf()

è¯¥æ–¹æ³•ä¸setPrototypeOfæ–¹æ³•é…å¥—ï¼Œç”¨äºè¯»å–ä¸€ä¸ªå¯¹è±¡çš„prototypeå¯¹è±¡ã€‚

Object.getPrototypeOf(obj);
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

function Rectangle() {
}

var rec = new Rectangle();

Object.getPrototypeOf(rec) === Rectangle.prototype
// true

Object.setPrototypeOf(rec, Object.prototype);
Object.getPrototypeOf(rec) === Rectangle.prototype
// false
Object.keys()ï¼ŒObject.values()ï¼ŒObject.entries()
Object.keys()
ES5 å¼•å…¥äº†Object.keysæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæˆå‘˜æ˜¯å‚æ•°å¯¹è±¡è‡ªèº«çš„ï¼ˆä¸å«ç»§æ‰¿çš„ï¼‰æ‰€æœ‰å¯éå†ï¼ˆenumerableï¼‰å±æ€§çš„é”®åã€‚

var obj = { foo: 'bar', baz: 42 };
Object.keys(obj)
// ["foo", "baz"]
ES2017 å¼•å…¥äº†è·ŸObject.keysé…å¥—çš„Object.valueså’ŒObject.entriesï¼Œä½œä¸ºéå†ä¸€ä¸ªå¯¹è±¡çš„è¡¥å……æ‰‹æ®µã€‚

let {keys, values, entries} = Object;
let obj = { a: 1, b: 2, c: 3 };

for (let key of keys(obj)) {
  console.log(key); // 'a', 'b', 'c'
}

for (let value of values(obj)) {
  console.log(value); // 1, 2, 3
}

for (let [key, value] of entries(obj)) {
  console.log([key, value]); // ['a', 1], ['b', 2], ['c', 3]
}
Object.values()
Object.valuesæ–¹æ³•è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæˆå‘˜æ˜¯å‚æ•°å¯¹è±¡è‡ªèº«çš„ï¼ˆä¸å«ç»§æ‰¿çš„ï¼‰æ‰€æœ‰å¯éå†ï¼ˆenumerableï¼‰å±æ€§çš„é”®å€¼ã€‚

var obj = { foo: 'bar', baz: 42 };
Object.values(obj)
// ["bar", 42]
è¿”å›æ•°ç»„çš„æˆå‘˜é¡ºåºï¼Œä¸æœ¬ç« çš„ã€Šå±æ€§çš„éå†ã€‹éƒ¨åˆ†ä»‹ç»çš„æ’åˆ—è§„åˆ™ä¸€è‡´ã€‚

var obj = { 100: 'a', 2: 'b', 7: 'c' };
Object.values(obj)
// ["b", "c", "a"]
ä¸Šé¢ä»£ç ä¸­ï¼Œå±æ€§åä¸ºæ•°å€¼çš„å±æ€§ï¼Œæ˜¯æŒ‰ç…§æ•°å€¼å¤§å°ï¼Œä»å°åˆ°å¤§éå†çš„ï¼Œå› æ­¤è¿”å›çš„é¡ºåºæ˜¯bã€cã€aã€‚

Object.valuesåªè¿”å›å¯¹è±¡è‡ªèº«çš„å¯éå†å±æ€§ã€‚

var obj = Object.create({}, {p: {value: 42}});
Object.values(obj) // []
ä¸Šé¢ä»£ç ä¸­ï¼ŒObject.createæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ·»åŠ çš„å¯¹è±¡å±æ€§ï¼ˆå±æ€§pï¼‰ï¼Œå¦‚æœä¸æ˜¾å¼å£°æ˜ï¼Œé»˜è®¤æ˜¯ä¸å¯éå†çš„ï¼Œå› ä¸ºpæ˜¯ç»§æ‰¿çš„å±æ€§ï¼Œè€Œä¸æ˜¯å¯¹è±¡è‡ªèº«çš„å±æ€§ã€‚Object.valuesä¸ä¼šè¿”å›è¿™ä¸ªå±æ€§ã€‚

Object.valuesä¼šè¿‡æ»¤å±æ€§åä¸º Symbol å€¼çš„å±æ€§ã€‚

Object.values({ [Symbol()]: 123, foo: 'abc' });
// ['abc']
å¦‚æœObject.valuesæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šè¿”å›å„ä¸ªå­—ç¬¦ç»„æˆçš„ä¸€ä¸ªæ•°ç»„ã€‚

Object.values('foo')
// ['f', 'o', 'o']
ä¸Šé¢ä»£ç ä¸­ï¼Œå­—ç¬¦ä¸²ä¼šå…ˆè½¬æˆä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚å­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦ï¼Œå°±æ˜¯è¯¥å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ã€‚å› æ­¤ï¼ŒObject.valuesè¿”å›æ¯ä¸ªå±æ€§çš„é”®å€¼ï¼Œå°±æ˜¯å„ä¸ªå­—ç¬¦ç»„æˆçš„ä¸€ä¸ªæ•°ç»„ã€‚

å¦‚æœå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒObject.valuesä¼šå…ˆå°†å…¶è½¬ä¸ºå¯¹è±¡ã€‚ç”±äºæ•°å€¼å’Œå¸ƒå°”å€¼çš„åŒ…è£…å¯¹è±¡ï¼Œéƒ½ä¸ä¼šä¸ºå®ä¾‹æ·»åŠ éç»§æ‰¿çš„å±æ€§ã€‚æ‰€ä»¥ï¼ŒObject.valuesä¼šè¿”å›ç©ºæ•°ç»„ã€‚

Object.values(42) // []
Object.values(true) // []
Object.entries
Object.entriesæ–¹æ³•è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæˆå‘˜æ˜¯å‚æ•°å¯¹è±¡è‡ªèº«çš„ï¼ˆä¸å«ç»§æ‰¿çš„ï¼‰æ‰€æœ‰å¯éå†ï¼ˆenumerableï¼‰å±æ€§çš„é”®å€¼å¯¹æ•°ç»„ã€‚

var obj = { foo: 'bar', baz: 42 };
Object.entries(obj)
// [ ["foo", "bar"], ["baz", 42] ]
é™¤äº†è¿”å›å€¼ä¸ä¸€æ ·ï¼Œè¯¥æ–¹æ³•çš„è¡Œä¸ºä¸Object.valuesåŸºæœ¬ä¸€è‡´ã€‚

å¦‚æœåŸå¯¹è±¡çš„å±æ€§åæ˜¯ä¸€ä¸ªSymbolå€¼ï¼Œè¯¥å±æ€§ä¼šè¢«çœç•¥ã€‚

Object.entries({ [Symbol()]: 123, foo: 'abc' });
// [ [ 'foo', 'abc' ] ]
ä¸Šé¢ä»£ç ä¸­ï¼ŒåŸå¯¹è±¡æœ‰ä¸¤ä¸ªå±æ€§ï¼ŒObject.entriesåªè¾“å‡ºå±æ€§åéSymbolå€¼çš„å±æ€§ã€‚å°†æ¥å¯èƒ½ä¼šæœ‰Reflect.ownEntries()æ–¹æ³•ï¼Œè¿”å›å¯¹è±¡è‡ªèº«çš„æ‰€æœ‰å±æ€§ã€‚

Object.entriesçš„åŸºæœ¬ç”¨é€”æ˜¯éå†å¯¹è±¡çš„å±æ€§ã€‚

let obj = { one: 1, two: 2 };
for (let [k, v] of Object.entries(obj)) {
  console.log(`${JSON.stringify(k)}: ${JSON.stringify(v)}`);
}
// "one": 1
// "two": 2
Object.entriesæ–¹æ³•çš„ä¸€ä¸ªç”¨å¤„æ˜¯ï¼Œå°†å¯¹è±¡è½¬ä¸ºçœŸæ­£çš„Mapç»“æ„ã€‚

var obj = { foo: 'bar', baz: 42 };
var map = new Map(Object.entries(obj));
map // Map { foo: "bar", baz: 42 }
è‡ªå·±å®ç°Object.entriesæ–¹æ³•ï¼Œéå¸¸ç®€å•ã€‚

// Generatorå‡½æ•°çš„ç‰ˆæœ¬
function* entries(obj) {
  for (let key of Object.keys(obj)) {
    yield [key, obj[key]];
  }
}

// éGeneratorå‡½æ•°çš„ç‰ˆæœ¬
function entries(obj) {
  let arr = [];
  for (let key of Object.keys(obj)) {
    arr.push([key, obj[key]]);
  }
  return arr;
}
å¯¹è±¡çš„æ‰©å±•è¿ç®—ç¬¦
ç›®å‰ï¼ŒES7æœ‰ä¸€ä¸ªææ¡ˆï¼Œå°†Restè¿ç®—ç¬¦ï¼ˆè§£æ„èµ‹å€¼ï¼‰/æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰å¼•å…¥å¯¹è±¡ã€‚Babelè½¬ç å™¨å·²ç»æ”¯æŒè¿™é¡¹åŠŸèƒ½ã€‚

ï¼ˆ1ï¼‰è§£æ„èµ‹å€¼

å¯¹è±¡çš„è§£æ„èµ‹å€¼ç”¨äºä»ä¸€ä¸ªå¯¹è±¡å–å€¼ï¼Œç›¸å½“äºå°†æ‰€æœ‰å¯éå†çš„ã€ä½†å°šæœªè¢«è¯»å–çš„å±æ€§ï¼Œåˆ†é…åˆ°æŒ‡å®šçš„å¯¹è±¡ä¸Šé¢ã€‚æ‰€æœ‰çš„é”®å’Œå®ƒä»¬çš„å€¼ï¼Œéƒ½ä¼šæ‹·è´åˆ°æ–°å¯¹è±¡ä¸Šé¢ã€‚

let { x, y, ...z } = { x: 1, y: 2, a: 3, b: 4 };
x // 1
y // 2
z // { a: 3, b: 4 }
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡zæ˜¯è§£æ„èµ‹å€¼æ‰€åœ¨çš„å¯¹è±¡ã€‚å®ƒè·å–ç­‰å·å³è¾¹çš„æ‰€æœ‰å°šæœªè¯»å–çš„é”®ï¼ˆaå’Œbï¼‰ï¼Œå°†å®ƒä»¬è¿åŒå€¼ä¸€èµ·æ‹·è´è¿‡æ¥ã€‚

ç”±äºè§£æ„èµ‹å€¼è¦æ±‚ç­‰å·å³è¾¹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥å¦‚æœç­‰å·å³è¾¹æ˜¯undefinedæˆ–nullï¼Œå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒä»¬æ— æ³•è½¬ä¸ºå¯¹è±¡ã€‚

let { x, y, ...z } = null; // è¿è¡Œæ—¶é”™è¯¯
let { x, y, ...z } = undefined; // è¿è¡Œæ—¶é”™è¯¯
è§£æ„èµ‹å€¼å¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

let { ...x, y, z } = obj; // å¥æ³•é”™è¯¯
let { x, ...y, ...z } = obj; // å¥æ³•é”™è¯¯
ä¸Šé¢ä»£ç ä¸­ï¼Œè§£æ„èµ‹å€¼ä¸æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ã€‚

æ³¨æ„ï¼Œè§£æ„èµ‹å€¼çš„æ‹·è´æ˜¯æµ…æ‹·è´ï¼Œå³å¦‚æœä¸€ä¸ªé”®çš„å€¼æ˜¯å¤åˆç±»å‹çš„å€¼ï¼ˆæ•°ç»„ã€å¯¹è±¡ã€å‡½æ•°ï¼‰ã€é‚£ä¹ˆè§£æ„èµ‹å€¼æ‹·è´çš„æ˜¯è¿™ä¸ªå€¼çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯è¿™ä¸ªå€¼çš„å‰¯æœ¬ã€‚

let obj = { a: { b: 1 } };
let { ...x } = obj;
obj.a.b = 2;
x.a.b // 2
ä¸Šé¢ä»£ç ä¸­ï¼Œxæ˜¯è§£æ„èµ‹å€¼æ‰€åœ¨çš„å¯¹è±¡ï¼Œæ‹·è´äº†å¯¹è±¡objçš„aå±æ€§ã€‚aå±æ€§å¼•ç”¨äº†ä¸€ä¸ªå¯¹è±¡ï¼Œä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„å€¼ï¼Œä¼šå½±å“åˆ°è§£æ„èµ‹å€¼å¯¹å®ƒçš„å¼•ç”¨ã€‚

å¦å¤–ï¼Œè§£æ„èµ‹å€¼ä¸ä¼šæ‹·è´ç»§æ‰¿è‡ªåŸå‹å¯¹è±¡çš„å±æ€§ã€‚

let o1 = { a: 1 };
let o2 = { b: 2 };
o2.__proto__ = o1;
let o3 = { ...o2 };
o3 // { b: 2 }
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯¹è±¡o3æ˜¯o2çš„æ‹·è´ï¼Œä½†æ˜¯åªå¤åˆ¶äº†o2è‡ªèº«çš„å±æ€§ï¼Œæ²¡æœ‰å¤åˆ¶å®ƒçš„åŸå‹å¯¹è±¡o1çš„å±æ€§ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

var o = Object.create({ x: 1, y: 2 });
o.z = 3;

let { x, ...{ y, z } } = o;
x // 1
y // undefined
z // 3
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡xæ˜¯å•çº¯çš„è§£æ„èµ‹å€¼ï¼Œæ‰€ä»¥å¯ä»¥è¯»å–ç»§æ‰¿çš„å±æ€§ï¼›è§£æ„èµ‹å€¼äº§ç”Ÿçš„å˜é‡yå’Œzï¼Œåªèƒ½è¯»å–å¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œæ‰€ä»¥åªæœ‰å˜é‡zå¯ä»¥èµ‹å€¼æˆåŠŸã€‚

è§£æ„èµ‹å€¼çš„ä¸€ä¸ªç”¨å¤„ï¼Œæ˜¯æ‰©å±•æŸä¸ªå‡½æ•°çš„å‚æ•°ï¼Œå¼•å…¥å…¶ä»–æ“ä½œã€‚

function baseFunction({ a, b }) {
  // ...
}
function wrapperFunction({ x, y, ...restConfig }) {
  // ä½¿ç”¨xå’Œyå‚æ•°è¿›è¡Œæ“ä½œ
  // å…¶ä½™å‚æ•°ä¼ ç»™åŸå§‹å‡½æ•°
  return baseFunction(restConfig);
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒåŸå§‹å‡½æ•°baseFunctionæ¥å—aå’Œbä½œä¸ºå‚æ•°ï¼Œå‡½æ•°wrapperFunctionåœ¨baseFunctionçš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œèƒ½å¤Ÿæ¥å—å¤šä½™çš„å‚æ•°ï¼Œå¹¶ä¸”ä¿ç•™åŸå§‹å‡½æ•°çš„è¡Œä¸ºã€‚

ï¼ˆ2ï¼‰æ‰©å±•è¿ç®—ç¬¦

æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ç”¨äºå–å‡ºå‚æ•°å¯¹è±¡çš„æ‰€æœ‰å¯éå†å±æ€§ï¼Œæ‹·è´åˆ°å½“å‰å¯¹è±¡ä¹‹ä¸­ã€‚

let z = { a: 3, b: 4 };
let n = { ...z };
n // { a: 3, b: 4 }
è¿™ç­‰åŒäºä½¿ç”¨Object.assignæ–¹æ³•ã€‚

let aClone = { ...a };
// ç­‰åŒäº
let aClone = Object.assign({}, a);
æ‰©å±•è¿ç®—ç¬¦å¯ä»¥ç”¨äºåˆå¹¶ä¸¤ä¸ªå¯¹è±¡ã€‚

let ab = { ...a, ...b };
// ç­‰åŒäº
let ab = Object.assign({}, a, b);
å¦‚æœç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ï¼Œæ”¾åœ¨æ‰©å±•è¿ç®—ç¬¦åé¢ï¼Œåˆ™æ‰©å±•è¿ç®—ç¬¦å†…éƒ¨çš„åŒåå±æ€§ä¼šè¢«è¦†ç›–æ‰ã€‚

let aWithOverrides = { ...a, x: 1, y: 2 };
// ç­‰åŒäº
let aWithOverrides = { ...a, ...{ x: 1, y: 2 } };
// ç­‰åŒäº
let x = 1, y = 2, aWithOverrides = { ...a, x, y };
// ç­‰åŒäº
let aWithOverrides = Object.assign({}, a, { x: 1, y: 2 });
ä¸Šé¢ä»£ç ä¸­ï¼Œaå¯¹è±¡çš„xå±æ€§å’Œyå±æ€§ï¼Œæ‹·è´åˆ°æ–°å¯¹è±¡åä¼šè¢«è¦†ç›–æ‰ã€‚

è¿™ç”¨æ¥ä¿®æ”¹ç°æœ‰å¯¹è±¡éƒ¨åˆ†çš„éƒ¨åˆ†å±æ€§å°±å¾ˆæ–¹ä¾¿äº†ã€‚

let newVersion = {
  ...previousVersion,
  name: 'New Name' // Override the name property
};
ä¸Šé¢ä»£ç ä¸­ï¼ŒnewVersionå¯¹è±¡è‡ªå®šä¹‰äº†nameå±æ€§ï¼Œå…¶ä»–å±æ€§å…¨éƒ¨å¤åˆ¶è‡ªpreviousVersionå¯¹è±¡ã€‚

å¦‚æœæŠŠè‡ªå®šä¹‰å±æ€§æ”¾åœ¨æ‰©å±•è¿ç®—ç¬¦å‰é¢ï¼Œå°±å˜æˆäº†è®¾ç½®æ–°å¯¹è±¡çš„é»˜è®¤å±æ€§å€¼ã€‚

let aWithDefaults = { x: 1, y: 2, ...a };
// ç­‰åŒäº
let aWithDefaults = Object.assign({}, { x: 1, y: 2 }, a);
// ç­‰åŒäº
let aWithDefaults = Object.assign({ x: 1, y: 2 }, a);
æ‰©å±•è¿ç®—ç¬¦çš„å‚æ•°å¯¹è±¡ä¹‹ä¸­ï¼Œå¦‚æœæœ‰å–å€¼å‡½æ•°getï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä¼šæ‰§è¡Œçš„ã€‚

// å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºxå±æ€§åªæ˜¯è¢«å®šä¹‰ï¼Œä½†æ²¡æ‰§è¡Œ
let aWithXGetter = {
  ...a,
  get x() {
    throws new Error('not thrown yet');
  }
};

// ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºxå±æ€§è¢«æ‰§è¡Œäº†
let runtimeError = {
  ...a,
  ...{
    get x() {
      throws new Error('thrown now');
    }
  }
};
å¦‚æœæ‰©å±•è¿ç®—ç¬¦çš„å‚æ•°æ˜¯nullæˆ–undefinedï¼Œè¿™ä¸ªä¸¤ä¸ªå€¼ä¼šè¢«å¿½ç•¥ï¼Œä¸ä¼šæŠ¥é”™ã€‚

let emptyObject = { ...null, ...undefined }; // ä¸æŠ¥é”™
Object.getOwnPropertyDescriptors()
ES5æœ‰ä¸€ä¸ªObject.getOwnPropertyDescriptoræ–¹æ³•ï¼Œè¿”å›æŸä¸ªå¯¹è±¡å±æ€§çš„æè¿°å¯¹è±¡ï¼ˆdescriptorï¼‰ã€‚

var obj = { p: 'a' };

Object.getOwnPropertyDescriptor(obj, 'p')
// Object { value: "a",
//   writable: true,
//   enumerable: true,
//   configurable: true
// }
ES7æœ‰ä¸€ä¸ªææ¡ˆï¼Œæå‡ºäº†Object.getOwnPropertyDescriptorsæ–¹æ³•ï¼Œè¿”å›æŒ‡å®šå¯¹è±¡æ‰€æœ‰è‡ªèº«å±æ€§ï¼ˆéç»§æ‰¿å±æ€§ï¼‰çš„æè¿°å¯¹è±¡ã€‚

const obj = {
  foo: 123,
  get bar() { return 'abc' }
};

Object.getOwnPropertyDescriptors(obj)
// { foo:
//    { value: 123,
//      writable: true,
//      enumerable: true,
//      configurable: true },
//   bar:
//    { get: [Function: bar],
//      set: undefined,
//      enumerable: true,
//      configurable: true } }
Object.getOwnPropertyDescriptorsæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€æœ‰åŸå¯¹è±¡çš„å±æ€§åéƒ½æ˜¯è¯¥å¯¹è±¡çš„å±æ€§åï¼Œå¯¹åº”çš„å±æ€§å€¼å°±æ˜¯è¯¥å±æ€§çš„æè¿°å¯¹è±¡ã€‚

è¯¥æ–¹æ³•çš„å®ç°éå¸¸å®¹æ˜“ã€‚

function getOwnPropertyDescriptors(obj) {
  const result = {};
  for (let key of Reflect.ownKeys(obj)) {
    result[key] = Object.getOwnPropertyDescriptor(obj, key);
  }
  return result;
}
è¯¥æ–¹æ³•çš„æå‡ºç›®çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³Object.assign()æ— æ³•æ­£ç¡®æ‹·è´getå±æ€§å’Œsetå±æ€§çš„é—®é¢˜ã€‚

const source = {
  set foo(value) {
    console.log(value);
  }
};

const target1 = {};
Object.assign(target1, source);

Object.getOwnPropertyDescriptor(target1, 'foo')
// { value: undefined,
//   writable: true,
//   enumerable: true,
//   configurable: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œsourceå¯¹è±¡çš„fooå±æ€§çš„å€¼æ˜¯ä¸€ä¸ªèµ‹å€¼å‡½æ•°ï¼ŒObject.assignæ–¹æ³•å°†è¿™ä¸ªå±æ€§æ‹·è´ç»™target1å¯¹è±¡ï¼Œç»“æœè¯¥å±æ€§çš„å€¼å˜æˆäº†undefinedã€‚è¿™æ˜¯å› ä¸ºObject.assignæ–¹æ³•æ€»æ˜¯æ‹·è´ä¸€ä¸ªå±æ€§çš„å€¼ï¼Œè€Œä¸ä¼šæ‹·è´å®ƒèƒŒåçš„èµ‹å€¼æ–¹æ³•æˆ–å–å€¼æ–¹æ³•ã€‚

è¿™æ—¶ï¼ŒObject.getOwnPropertyDescriptorsæ–¹æ³•é…åˆObject.definePropertiesæ–¹æ³•ï¼Œå°±å¯ä»¥å®ç°æ­£ç¡®æ‹·è´ã€‚

const source = {
  set foo(value) {
    console.log(value);
  }
};

const target2 = {};
Object.defineProperties(target2, Object.getOwnPropertyDescriptors(source));
Object.getOwnPropertyDescriptor(target2, 'foo')
// { get: undefined,
//   set: [Function: foo],
//   enumerable: true,
//   configurable: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œå°†ä¸¤ä¸ªå¯¹è±¡åˆå¹¶çš„é€»è¾‘æç‚¼å‡ºæ¥ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚

const shallowMerge = (target, source) => Object.defineProperties(
  target,
  Object.getOwnPropertyDescriptors(source)
);
Object.getOwnPropertyDescriptorsæ–¹æ³•çš„å¦ä¸€ä¸ªç”¨å¤„ï¼Œæ˜¯é…åˆObject.createæ–¹æ³•ï¼Œå°†å¯¹è±¡å±æ€§å…‹éš†åˆ°ä¸€ä¸ªæ–°å¯¹è±¡ã€‚è¿™å±äºæµ…æ‹·è´ã€‚

const clone = Object.create(Object.getPrototypeOf(obj),
  Object.getOwnPropertyDescriptors(obj));

// æˆ–è€…

const shallowClone = (obj) => Object.create(
  Object.getPrototypeOf(obj),
  Object.getOwnPropertyDescriptors(obj)
);
ä¸Šé¢ä»£ç ä¼šå…‹éš†å¯¹è±¡objã€‚

å¦å¤–ï¼ŒObject.getOwnPropertyDescriptorsæ–¹æ³•å¯ä»¥å®ç°ï¼Œä¸€ä¸ªå¯¹è±¡ç»§æ‰¿å¦ä¸€ä¸ªå¯¹è±¡ã€‚ä»¥å‰ï¼Œç»§æ‰¿å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå¸¸å¸¸å†™æˆä¸‹é¢è¿™æ ·ã€‚

const obj = {
  __proto__: prot,
  foo: 123,
};
ES6è§„å®š__proto__åªæœ‰æµè§ˆå™¨è¦éƒ¨ç½²ï¼Œå…¶ä»–ç¯å¢ƒä¸ç”¨éƒ¨ç½²ã€‚å¦‚æœå»é™¤__proto__ï¼Œä¸Šé¢ä»£ç å°±è¦æ”¹æˆä¸‹é¢è¿™æ ·ã€‚

const obj = Object.create(prot);
obj.foo = 123;

// æˆ–è€…

const obj = Object.assign(
  Object.create(prot),
  {
    foo: 123,
  }
);
æœ‰äº†Object.getOwnPropertyDescriptorsï¼Œæˆ‘ä»¬å°±æœ‰äº†å¦ä¸€ç§å†™æ³•ã€‚

const obj = Object.create(
  prot,
  Object.getOwnPropertyDescriptors({
    foo: 123,
  })
);
Object.getOwnPropertyDescriptorsä¹Ÿå¯ä»¥ç”¨æ¥å®ç°Mixinï¼ˆæ··å…¥ï¼‰æ¨¡å¼ã€‚

let mix = (object) => ({
  with: (...mixins) => mixins.reduce(
    (c, mixin) => Object.create(
      c, Object.getOwnPropertyDescriptors(mixin)
    ), object)
});

// multiple mixins example
let a = {a: 'a'};
let b = {b: 'b'};
let c = {c: 'c'};
let d = mix(c).with(a, b);
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯¹è±¡aå’Œbè¢«æ··å…¥äº†å¯¹è±¡cã€‚

å‡ºäºå®Œæ•´æ€§çš„è€ƒè™‘ï¼ŒObject.getOwnPropertyDescriptorsè¿›å…¥æ ‡å‡†ä»¥åï¼Œè¿˜ä¼šæœ‰Reflect.getOwnPropertyDescriptorsæ–¹æ³•ã€‚

##Symbol
1.æ¦‚è¿°
ES5çš„å¯¹è±¡å±æ€§åéƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™å®¹æ˜“é€ æˆå±æ€§åçš„å†²çªã€‚æ¯”å¦‚ï¼Œä½ ä½¿ç”¨äº†ä¸€ä¸ªä»–äººæä¾›çš„å¯¹è±¡ï¼Œä½†åˆæƒ³ä¸ºè¿™ä¸ªå¯¹è±¡æ·»åŠ æ–°çš„æ–¹æ³•ï¼ˆmixinæ¨¡å¼ï¼‰ï¼Œæ–°æ–¹æ³•çš„åå­—å°±æœ‰å¯èƒ½ä¸ç°æœ‰æ–¹æ³•äº§ç”Ÿå†²çªã€‚å¦‚æœæœ‰ä¸€ç§æœºåˆ¶ï¼Œä¿è¯æ¯ä¸ªå±æ€§çš„åå­—éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„å°±å¥½äº†ï¼Œè¿™æ ·å°±ä»æ ¹æœ¬ä¸Šé˜²æ­¢å±æ€§åçš„å†²çªã€‚è¿™å°±æ˜¯ES6å¼•å…¥Symbolçš„åŸå› ã€‚

ES6å¼•å…¥äº†ä¸€ç§æ–°çš„åŸå§‹æ•°æ®ç±»å‹Symbolï¼Œè¡¨ç¤ºç‹¬ä¸€æ— äºŒçš„å€¼ã€‚å®ƒæ˜¯JavaScriptè¯­è¨€çš„ç¬¬ä¸ƒç§æ•°æ®ç±»å‹ï¼Œå‰å…­ç§æ˜¯ï¼šUndefinedã€Nullã€å¸ƒå°”å€¼ï¼ˆBooleanï¼‰ã€å­—ç¬¦ä¸²ï¼ˆStringï¼‰ã€æ•°å€¼ï¼ˆNumberï¼‰ã€å¯¹è±¡ï¼ˆObjectï¼‰ã€‚

Symbolå€¼é€šè¿‡Symbolå‡½æ•°ç”Ÿæˆã€‚è¿™å°±æ˜¯è¯´ï¼Œå¯¹è±¡çš„å±æ€§åç°åœ¨å¯ä»¥æœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯åŸæ¥å°±æœ‰çš„å­—ç¬¦ä¸²ï¼Œå¦ä¸€ç§å°±æ˜¯æ–°å¢çš„Symbolç±»å‹ã€‚å‡¡æ˜¯å±æ€§åå±äºSymbolç±»å‹ï¼Œå°±éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå¯ä»¥ä¿è¯ä¸ä¼šä¸å…¶ä»–å±æ€§åäº§ç”Ÿå†²çªã€‚

let s = Symbol();

typeof s
// "symbol"
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡så°±æ˜¯ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„å€¼ã€‚typeofè¿ç®—ç¬¦çš„ç»“æœï¼Œè¡¨æ˜å˜é‡sæ˜¯Symbolæ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ä¹‹ç±»çš„å…¶ä»–ç±»å‹ã€‚

æ³¨æ„ï¼ŒSymbolå‡½æ•°å‰ä¸èƒ½ä½¿ç”¨newå‘½ä»¤ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºç”Ÿæˆçš„Symbolæ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹çš„å€¼ï¼Œä¸æ˜¯å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”±äºSymbolå€¼ä¸æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½æ·»åŠ å±æ€§ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒæ˜¯ä¸€ç§ç±»ä¼¼äºå­—ç¬¦ä¸²çš„æ•°æ®ç±»å‹ã€‚

Symbolå‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºå¯¹Symbolå®ä¾‹çš„æè¿°ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨æ§åˆ¶å°æ˜¾ç¤ºï¼Œæˆ–è€…è½¬ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œæ¯”è¾ƒå®¹æ˜“åŒºåˆ†ã€‚

var s1 = Symbol('foo');
var s2 = Symbol('bar');

s1 // Symbol(foo)
s2 // Symbol(bar)

s1.toString() // "Symbol(foo)"
s2.toString() // "Symbol(bar)"
ä¸Šé¢ä»£ç ä¸­ï¼Œs1å’Œs2æ˜¯ä¸¤ä¸ªSymbolå€¼ã€‚å¦‚æœä¸åŠ å‚æ•°ï¼Œå®ƒä»¬åœ¨æ§åˆ¶å°çš„è¾“å‡ºéƒ½æ˜¯Symbol()ï¼Œä¸åˆ©äºåŒºåˆ†ã€‚æœ‰äº†å‚æ•°ä»¥åï¼Œå°±ç­‰äºä¸ºå®ƒä»¬åŠ ä¸Šäº†æè¿°ï¼Œè¾“å‡ºçš„æ—¶å€™å°±èƒ½å¤Ÿåˆ†æ¸…ï¼Œåˆ°åº•æ˜¯å“ªä¸€ä¸ªå€¼ã€‚

å¦‚æœ Symbol çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„toStringæ–¹æ³•ï¼Œå°†å…¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åæ‰ç”Ÿæˆä¸€ä¸ª Symbol å€¼ã€‚

const obj = {
  toString() {
    return 'abc';
  }
};
const sym = Symbol(obj);
sym // Symbol(abc)
æ³¨æ„ï¼ŒSymbolå‡½æ•°çš„å‚æ•°åªæ˜¯è¡¨ç¤ºå¯¹å½“å‰ Symbol å€¼çš„æè¿°ï¼Œå› æ­¤ç›¸åŒå‚æ•°çš„Symbolå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸ç›¸ç­‰çš„ã€‚

// æ²¡æœ‰å‚æ•°çš„æƒ…å†µ
var s1 = Symbol();
var s2 = Symbol();

s1 === s2 // false

// æœ‰å‚æ•°çš„æƒ…å†µ
var s1 = Symbol('foo');
var s2 = Symbol('foo');

s1 === s2 // false
ä¸Šé¢ä»£ç ä¸­ï¼Œs1å’Œs2éƒ½æ˜¯Symbolå‡½æ•°çš„è¿”å›å€¼ï¼Œè€Œä¸”å‚æ•°ç›¸åŒï¼Œä½†æ˜¯å®ƒä»¬æ˜¯ä¸ç›¸ç­‰çš„ã€‚

Symbolå€¼ä¸èƒ½ä¸å…¶ä»–ç±»å‹çš„å€¼è¿›è¡Œè¿ç®—ï¼Œä¼šæŠ¥é”™ã€‚

var sym = Symbol('My symbol');

"your symbol is " + sym
// TypeError: can't convert symbol to string
`your symbol is ${sym}`
// TypeError: can't convert symbol to string
ä½†æ˜¯ï¼ŒSymbolå€¼å¯ä»¥æ˜¾å¼è½¬ä¸ºå­—ç¬¦ä¸²ã€‚

var sym = Symbol('My symbol');

String(sym) // 'Symbol(My symbol)'
sym.toString() // 'Symbol(My symbol)'
å¦å¤–ï¼ŒSymbolå€¼ä¹Ÿå¯ä»¥è½¬ä¸ºå¸ƒå°”å€¼ï¼Œä½†æ˜¯ä¸èƒ½è½¬ä¸ºæ•°å€¼ã€‚

var sym = Symbol();
Boolean(sym) // true
!sym  // false

if (sym) {
  // ...
}

Number(sym) // TypeError
sym + 2 // TypeError
ä½œä¸ºå±æ€§åçš„Symbol
ç”±äºæ¯ä¸€ä¸ªSymbolå€¼éƒ½æ˜¯ä¸ç›¸ç­‰çš„ï¼Œè¿™æ„å‘³ç€Symbolå€¼å¯ä»¥ä½œä¸ºæ ‡è¯†ç¬¦ï¼Œç”¨äºå¯¹è±¡çš„å±æ€§åï¼Œå°±èƒ½ä¿è¯ä¸ä¼šå‡ºç°åŒåçš„å±æ€§ã€‚è¿™å¯¹äºä¸€ä¸ªå¯¹è±¡ç”±å¤šä¸ªæ¨¡å—æ„æˆçš„æƒ…å†µéå¸¸æœ‰ç”¨ï¼Œèƒ½é˜²æ­¢æŸä¸€ä¸ªé”®è¢«ä¸å°å¿ƒæ”¹å†™æˆ–è¦†ç›–ã€‚

var mySymbol = Symbol();

// ç¬¬ä¸€ç§å†™æ³•
var a = {};
a[mySymbol] = 'Hello!';

// ç¬¬äºŒç§å†™æ³•
var a = {
  [mySymbol]: 'Hello!'
};

// ç¬¬ä¸‰ç§å†™æ³•
var a = {};
Object.defineProperty(a, mySymbol, { value: 'Hello!' });

// ä»¥ä¸Šå†™æ³•éƒ½å¾—åˆ°åŒæ ·ç»“æœ
a[mySymbol] // "Hello!"
ä¸Šé¢ä»£ç é€šè¿‡æ–¹æ‹¬å·ç»“æ„å’ŒObject.definePropertyï¼Œå°†å¯¹è±¡çš„å±æ€§åæŒ‡å®šä¸ºä¸€ä¸ªSymbolå€¼ã€‚

æ³¨æ„ï¼ŒSymbolå€¼ä½œä¸ºå¯¹è±¡å±æ€§åæ—¶ï¼Œä¸èƒ½ç”¨ç‚¹è¿ç®—ç¬¦ã€‚

var mySymbol = Symbol();
var a = {};

a.mySymbol = 'Hello!';
a[mySymbol] // undefined
a['mySymbol'] // "Hello!"
ä¸Šé¢ä»£ç ä¸­ï¼Œå› ä¸ºç‚¹è¿ç®—ç¬¦åé¢æ€»æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸ä¼šè¯»å–mySymbolä½œä¸ºæ ‡è¯†åæ‰€æŒ‡ä»£çš„é‚£ä¸ªå€¼ï¼Œå¯¼è‡´açš„å±æ€§åå®é™…ä¸Šæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªSymbolå€¼ã€‚

åŒç†ï¼Œåœ¨å¯¹è±¡çš„å†…éƒ¨ï¼Œä½¿ç”¨Symbolå€¼å®šä¹‰å±æ€§æ—¶ï¼ŒSymbolå€¼å¿…é¡»æ”¾åœ¨æ–¹æ‹¬å·ä¹‹ä¸­ã€‚

let s = Symbol();

let obj = {
  [s]: function (arg) { ... }
};

obj[s](123);
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœsä¸æ”¾åœ¨æ–¹æ‹¬å·ä¸­ï¼Œè¯¥å±æ€§çš„é”®åå°±æ˜¯å­—ç¬¦ä¸²sï¼Œè€Œä¸æ˜¯sæ‰€ä»£è¡¨çš„é‚£ä¸ªSymbolå€¼ã€‚

é‡‡ç”¨å¢å¼ºçš„å¯¹è±¡å†™æ³•ï¼Œä¸Šé¢ä»£ç çš„objå¯¹è±¡å¯ä»¥å†™å¾—æ›´ç®€æ´ä¸€äº›ã€‚

let obj = {
  [s](arg) { ... }
};
Symbolç±»å‹è¿˜å¯ä»¥ç”¨äºå®šä¹‰ä¸€ç»„å¸¸é‡ï¼Œä¿è¯è¿™ç»„å¸¸é‡çš„å€¼éƒ½æ˜¯ä¸ç›¸ç­‰çš„ã€‚

log.levels = {
  DEBUG: Symbol('debug'),
  INFO: Symbol('info'),
  WARN: Symbol('warn')
};
log(log.levels.DEBUG, 'debug message');
log(log.levels.INFO, 'info message');
ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªä¾‹å­ã€‚

const COLOR_RED    = Symbol();
const COLOR_GREEN  = Symbol();

function getComplement(color) {
  switch (color) {
    case COLOR_RED:
      return COLOR_GREEN;
    case COLOR_GREEN:
      return COLOR_RED;
    default:
      throw new Error('Undefined color');
    }
}
å¸¸é‡ä½¿ç”¨Symbolå€¼æœ€å¤§çš„å¥½å¤„ï¼Œå°±æ˜¯å…¶ä»–ä»»ä½•å€¼éƒ½ä¸å¯èƒ½æœ‰ç›¸åŒçš„å€¼äº†ï¼Œå› æ­¤å¯ä»¥ä¿è¯ä¸Šé¢çš„switchè¯­å¥ä¼šæŒ‰è®¾è®¡çš„æ–¹å¼å·¥ä½œã€‚

è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒSymbolå€¼ä½œä¸ºå±æ€§åæ—¶ï¼Œè¯¥å±æ€§è¿˜æ˜¯å…¬å¼€å±æ€§ï¼Œä¸æ˜¯ç§æœ‰å±æ€§ã€‚

å®ä¾‹ï¼šæ¶ˆé™¤é­”æœ¯å­—ç¬¦ä¸²
é­”æœ¯å­—ç¬¦ä¸²æŒ‡çš„æ˜¯ï¼Œåœ¨ä»£ç ä¹‹ä¸­å¤šæ¬¡å‡ºç°ã€ä¸ä»£ç å½¢æˆå¼ºè€¦åˆçš„æŸä¸€ä¸ªå…·ä½“çš„å­—ç¬¦ä¸²æˆ–è€…æ•°å€¼ã€‚é£æ ¼è‰¯å¥½çš„ä»£ç ï¼Œåº”è¯¥å°½é‡æ¶ˆé™¤é­”æœ¯å­—ç¬¦ä¸²ï¼Œè¯¥ç”±å«ä¹‰æ¸…æ™°çš„å˜é‡ä»£æ›¿ã€‚

function getArea(shape, options) {
  var area = 0;

  switch (shape) {
    case 'Triangle': // é­”æœ¯å­—ç¬¦ä¸²
      area = .5 * options.width * options.height;
      break;
    /* ... more code ... */
  }

  return area;
}

getArea('Triangle', { width: 100, height: 100 }); // é­”æœ¯å­—ç¬¦ä¸²
ä¸Šé¢ä»£ç ä¸­ï¼Œå­—ç¬¦ä¸²â€œTriangleâ€å°±æ˜¯ä¸€ä¸ªé­”æœ¯å­—ç¬¦ä¸²ã€‚å®ƒå¤šæ¬¡å‡ºç°ï¼Œä¸ä»£ç å½¢æˆâ€œå¼ºè€¦åˆâ€ï¼Œä¸åˆ©äºå°†æ¥çš„ä¿®æ”¹å’Œç»´æŠ¤ã€‚

å¸¸ç”¨çš„æ¶ˆé™¤é­”æœ¯å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œå°±æ˜¯æŠŠå®ƒå†™æˆä¸€ä¸ªå˜é‡ã€‚

var shapeType = {
  triangle: 'Triangle'
};

function getArea(shape, options) {
  var area = 0;
  switch (shape) {
    case shapeType.triangle:
      area = .5 * options.width * options.height;
      break;
  }
  return area;
}

getArea(shapeType.triangle, { width: 100, height: 100 });
ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æŠŠâ€œTriangleâ€å†™æˆshapeTypeå¯¹è±¡çš„triangleå±æ€§ï¼Œè¿™æ ·å°±æ¶ˆé™¤äº†å¼ºè€¦åˆã€‚

å¦‚æœä»”ç»†åˆ†æï¼Œå¯ä»¥å‘ç°shapeType.triangleç­‰äºå“ªä¸ªå€¼å¹¶ä¸é‡è¦ï¼Œåªè¦ç¡®ä¿ä¸ä¼šè·Ÿå…¶ä»–shapeTypeå±æ€§çš„å€¼å†²çªå³å¯ã€‚å› æ­¤ï¼Œè¿™é‡Œå°±å¾ˆé€‚åˆæ”¹ç”¨Symbolå€¼ã€‚

const shapeType = {
  triangle: Symbol()
};
ä¸Šé¢ä»£ç ä¸­ï¼Œé™¤äº†å°†shapeType.triangleçš„å€¼è®¾ä¸ºä¸€ä¸ªSymbolï¼Œå…¶ä»–åœ°æ–¹éƒ½ä¸ç”¨ä¿®æ”¹ã€‚

å±æ€§åçš„éå†
Symbol ä½œä¸ºå±æ€§åï¼Œè¯¥å±æ€§ä¸ä¼šå‡ºç°åœ¨for...inã€for...ofå¾ªç¯ä¸­ï¼Œä¹Ÿä¸ä¼šè¢«Object.keys()ã€Object.getOwnPropertyNames()ã€JSON.stringify()è¿”å›ã€‚ä½†æ˜¯ï¼Œå®ƒä¹Ÿä¸æ˜¯ç§æœ‰å±æ€§ï¼Œæœ‰ä¸€ä¸ªObject.getOwnPropertySymbolsæ–¹æ³•ï¼Œå¯ä»¥è·å–æŒ‡å®šå¯¹è±¡çš„æ‰€æœ‰ Symbol å±æ€§åã€‚

Object.getOwnPropertySymbolsæ–¹æ³•è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæˆå‘˜æ˜¯å½“å‰å¯¹è±¡çš„æ‰€æœ‰ç”¨ä½œå±æ€§åçš„ Symbol å€¼ã€‚

var obj = {};
var a = Symbol('a');
var b = Symbol('b');

obj[a] = 'Hello';
obj[b] = 'World';

var objectSymbols = Object.getOwnPropertySymbols(obj);

objectSymbols
// [Symbol(a), Symbol(b)]
ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ï¼ŒObject.getOwnPropertySymbolsæ–¹æ³•ä¸for...inå¾ªç¯ã€Object.getOwnPropertyNamesæ–¹æ³•è¿›è¡Œå¯¹æ¯”çš„ä¾‹å­ã€‚

var obj = {};

var foo = Symbol("foo");

Object.defineProperty(obj, foo, {
  value: "foobar",
});

for (var i in obj) {
  console.log(i); // æ— è¾“å‡º
}

Object.getOwnPropertyNames(obj)
// []

Object.getOwnPropertySymbols(obj)
// [Symbol(foo)]
ä¸Šé¢ä»£ç ä¸­ï¼Œä½¿ç”¨Object.getOwnPropertyNamesæ–¹æ³•å¾—ä¸åˆ°Symbolå±æ€§åï¼Œéœ€è¦ä½¿ç”¨Object.getOwnPropertySymbolsæ–¹æ³•ã€‚

å¦ä¸€ä¸ªæ–°çš„APIï¼ŒReflect.ownKeysæ–¹æ³•å¯ä»¥è¿”å›æ‰€æœ‰ç±»å‹çš„é”®åï¼ŒåŒ…æ‹¬å¸¸è§„é”®åå’Œ Symbol é”®åã€‚

let obj = {
  [Symbol('my_key')]: 1,
  enum: 2,
  nonEnum: 3
};

Reflect.ownKeys(obj)
//  ["enum", "nonEnum", Symbol(my_key)]
ç”±äºä»¥ Symbol å€¼ä½œä¸ºåç§°çš„å±æ€§ï¼Œä¸ä¼šè¢«å¸¸è§„æ–¹æ³•éå†å¾—åˆ°ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œä¸ºå¯¹è±¡å®šä¹‰ä¸€äº›éç§æœ‰çš„ã€ä½†åˆå¸Œæœ›åªç”¨äºå†…éƒ¨çš„æ–¹æ³•ã€‚

var size = Symbol('size');

class Collection {
  constructor() {
    this[size] = 0;
  }

  add(item) {
    this[this[size]] = item;
    this[size]++;
  }

  static sizeOf(instance) {
    return instance[size];
  }
}

var x = new Collection();
Collection.sizeOf(x) // 0

x.add('foo');
Collection.sizeOf(x) // 1

Object.keys(x) // ['0']
Object.getOwnPropertyNames(x) // ['0']
Object.getOwnPropertySymbols(x) // [Symbol(size)]
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯¹è±¡xçš„sizeå±æ€§æ˜¯ä¸€ä¸ª Symbol å€¼ï¼Œæ‰€ä»¥Object.keys(x)ã€Object.getOwnPropertyNames(x)éƒ½æ— æ³•è·å–å®ƒã€‚è¿™å°±é€ æˆäº†ä¸€ç§éç§æœ‰çš„å†…éƒ¨æ–¹æ³•çš„æ•ˆæœã€‚

Symbol.for()ï¼ŒSymbol.keyFor()
æœ‰æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›é‡æ–°ä½¿ç”¨åŒä¸€ä¸ªSymbolå€¼ï¼ŒSymbol.foræ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚å®ƒæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œç„¶åæœç´¢æœ‰æ²¡æœ‰ä»¥è¯¥å‚æ•°ä½œä¸ºåç§°çš„Symbolå€¼ã€‚å¦‚æœæœ‰ï¼Œå°±è¿”å›è¿™ä¸ªSymbolå€¼ï¼Œå¦åˆ™å°±æ–°å»ºå¹¶è¿”å›ä¸€ä¸ªä»¥è¯¥å­—ç¬¦ä¸²ä¸ºåç§°çš„Symbolå€¼ã€‚

var s1 = Symbol.for('foo');
var s2 = Symbol.for('foo');

s1 === s2 // true
ä¸Šé¢ä»£ç ä¸­ï¼Œs1å’Œs2éƒ½æ˜¯ Symbol å€¼ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯åŒæ ·å‚æ•°çš„Symbol.foræ–¹æ³•ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªå€¼ã€‚

Symbol.for()ä¸Symbol()è¿™ä¸¤ç§å†™æ³•ï¼Œéƒ½ä¼šç”Ÿæˆæ–°çš„Symbolã€‚å®ƒä»¬çš„åŒºåˆ«æ˜¯ï¼Œå‰è€…ä¼šè¢«ç™»è®°åœ¨å…¨å±€ç¯å¢ƒä¸­ä¾›æœç´¢ï¼Œåè€…ä¸ä¼šã€‚Symbol.for()ä¸ä¼šæ¯æ¬¡è°ƒç”¨å°±è¿”å›ä¸€ä¸ªæ–°çš„ Symbol ç±»å‹çš„å€¼ï¼Œè€Œæ˜¯ä¼šå…ˆæ£€æŸ¥ç»™å®šçš„keyæ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨æ‰ä¼šæ–°å»ºä¸€ä¸ªå€¼ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ è°ƒç”¨Symbol.for("cat")30æ¬¡ï¼Œæ¯æ¬¡éƒ½ä¼šè¿”å›åŒä¸€ä¸ª Symbol å€¼ï¼Œä½†æ˜¯è°ƒç”¨Symbol("cat")30æ¬¡ï¼Œä¼šè¿”å›30ä¸ªä¸åŒçš„Symbolå€¼ã€‚

Symbol.for("bar") === Symbol.for("bar")
// true

Symbol("bar") === Symbol("bar")
// false
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºSymbol()å†™æ³•æ²¡æœ‰ç™»è®°æœºåˆ¶ï¼Œæ‰€ä»¥æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªä¸åŒçš„å€¼ã€‚

Symbol.keyForæ–¹æ³•è¿”å›ä¸€ä¸ªå·²ç™»è®°çš„ Symbol ç±»å‹å€¼çš„keyã€‚

var s1 = Symbol.for("foo");
Symbol.keyFor(s1) // "foo"

var s2 = Symbol("foo");
Symbol.keyFor(s2) // undefined
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡s2å±äºæœªç™»è®°çš„Symbolå€¼ï¼Œæ‰€ä»¥è¿”å›undefinedã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSymbol.forä¸ºSymbolå€¼ç™»è®°çš„åå­—ï¼Œæ˜¯å…¨å±€ç¯å¢ƒçš„ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ iframe æˆ– service worker ä¸­å–åˆ°åŒä¸€ä¸ªå€¼ã€‚

iframe = document.createElement('iframe');
iframe.src = String(window.location);
document.body.appendChild(iframe);

iframe.contentWindow.Symbol.for('foo') === Symbol.for('foo')
// true
ä¸Šé¢ä»£ç ä¸­ï¼Œiframe çª—å£ç”Ÿæˆçš„ Symbol å€¼ï¼Œå¯ä»¥åœ¨ä¸»é¡µé¢å¾—åˆ°ã€‚

å®ä¾‹ï¼šæ¨¡å—çš„ Singleton æ¨¡å¼
Singletonæ¨¡å¼æŒ‡çš„æ˜¯è°ƒç”¨ä¸€ä¸ªç±»ï¼Œä»»ä½•æ—¶å€™è¿”å›çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚

å¯¹äºNodeæ¥è¯´ï¼Œæ¨¡å—æ–‡ä»¶å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç±»ã€‚æ€ä¹ˆä¿è¯æ¯æ¬¡æ‰§è¡Œè¿™ä¸ªæ¨¡å—æ–‡ä»¶ï¼Œè¿”å›çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹å‘¢ï¼Ÿ

å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå¯ä»¥æŠŠå®ä¾‹æ”¾åˆ°é¡¶å±‚å¯¹è±¡globalã€‚

// mod.js
function A() {
  this.foo = 'hello';
}

if (!global._foo) {
  global._foo = new A();
}

module.exports = global._foo;
ç„¶åï¼ŒåŠ è½½ä¸Šé¢çš„mod.jsã€‚

var a = require('./mod.js');
console.log(a.foo);
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡aä»»ä½•æ—¶å€™åŠ è½½çš„éƒ½æ˜¯Açš„åŒä¸€ä¸ªå®ä¾‹ã€‚

ä½†æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå…¨å±€å˜é‡global._fooæ˜¯å¯å†™çš„ï¼Œä»»ä½•æ–‡ä»¶éƒ½å¯ä»¥ä¿®æ”¹ã€‚

var a = require('./mod.js');
global._foo = 123;
ä¸Šé¢çš„ä»£ç ï¼Œä¼šä½¿å¾—åˆ«çš„è„šæœ¬åŠ è½½mod.jséƒ½å¤±çœŸã€‚

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‡ºç°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Symbolã€‚

// mod.js
const FOO_KEY = Symbol.for('foo');

function A() {
  this.foo = 'hello';
}

if (!global[FOO_KEY]) {
  global[FOO_KEY] = new A();
}

module.exports = global[FOO_KEY];
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯ä»¥ä¿è¯global[FOO_KEY]ä¸ä¼šè¢«æ— æ„é—´è¦†ç›–ï¼Œä½†è¿˜æ˜¯å¯ä»¥è¢«æ”¹å†™ã€‚

var a = require('./mod.js');
global[Symbol.for('foo')] = 123;
å¦‚æœé”®åä½¿ç”¨Symbolæ–¹æ³•ç”Ÿæˆï¼Œé‚£ä¹ˆå¤–éƒ¨å°†æ— æ³•å¼•ç”¨è¿™ä¸ªå€¼ï¼Œå½“ç„¶ä¹Ÿå°±æ— æ³•æ”¹å†™ã€‚

// mod.js
const FOO_KEY = Symbol('foo');

// åé¢ä»£ç ç›¸åŒ â€¦â€¦
ä¸Šé¢ä»£ç å°†å¯¼è‡´å…¶ä»–è„šæœ¬éƒ½æ— æ³•å¼•ç”¨FOO_KEYã€‚ä½†è¿™æ ·ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœå¤šæ¬¡æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œæ¯æ¬¡å¾—åˆ°çš„FOO_KEYéƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚è™½ç„¶Nodeä¼šå°†è„šæœ¬çš„æ‰§è¡Œç»“æœç¼“å­˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ä¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€ä¸ªè„šæœ¬ï¼Œä½†æ˜¯ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯å®Œå…¨å¯é ã€‚

å†…ç½®çš„Symbolå€¼
é™¤äº†å®šä¹‰è‡ªå·±ä½¿ç”¨çš„Symbolå€¼ä»¥å¤–ï¼ŒES6è¿˜æä¾›äº†11ä¸ªå†…ç½®çš„Symbolå€¼ï¼ŒæŒ‡å‘è¯­è¨€å†…éƒ¨ä½¿ç”¨çš„æ–¹æ³•ã€‚

Symbol.hasInstance
å¯¹è±¡çš„Symbol.hasInstanceå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ã€‚å½“å…¶ä»–å¯¹è±¡ä½¿ç”¨instanceofè¿ç®—ç¬¦ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºè¯¥å¯¹è±¡çš„å®ä¾‹æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚æ¯”å¦‚ï¼Œfoo instanceof Fooåœ¨è¯­è¨€å†…éƒ¨ï¼Œå®é™…è°ƒç”¨çš„æ˜¯Foo[Symbol.hasInstance](foo)ã€‚

class MyClass {
  [Symbol.hasInstance](foo) {
    return foo instanceof Array;
  }
}

[1, 2, 3] instanceof new MyClass() // true
ä¸Šé¢ä»£ç ä¸­ï¼ŒMyClassæ˜¯ä¸€ä¸ªç±»ï¼Œnew MyClass()ä¼šè¿”å›ä¸€ä¸ªå®ä¾‹ã€‚è¯¥å®ä¾‹çš„Symbol.hasInstanceæ–¹æ³•ï¼Œä¼šåœ¨è¿›è¡Œinstanceofè¿ç®—æ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œåˆ¤æ–­å·¦ä¾§çš„è¿ç®—å­æ˜¯å¦ä¸ºArrayçš„å®ä¾‹ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

class Even {
  static [Symbol.hasInstance](obj) {
    return Number(obj) % 2 === 0;
  }
}

1 instanceof Even // false
2 instanceof Even // true
12345 instanceof Even // false
Symbol.isConcatSpreadable
å¯¹è±¡çš„Symbol.isConcatSpreadableå±æ€§ç­‰äºä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡ä½¿ç”¨Array.prototype.concat()æ—¶ï¼Œæ˜¯å¦å¯ä»¥å±•å¼€ã€‚

let arr1 = ['c', 'd'];
['a', 'b'].concat(arr1, 'e') // ['a', 'b', 'c', 'd', 'e']
arr1[Symbol.isConcatSpreadable] // undefined

let arr2 = ['c', 'd'];
arr2[Symbol.isConcatSpreadable] = false;
['a', 'b'].concat(arr2, 'e') // ['a', 'b', ['c','d'], 'e']
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œæ•°ç»„çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯ä»¥å±•å¼€ã€‚Symbol.isConcatSpreadableå±æ€§ç­‰äºtrueæˆ–undefinedï¼Œéƒ½æœ‰è¿™ä¸ªæ•ˆæœã€‚

ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ä¹Ÿå¯ä»¥å±•å¼€ï¼Œä½†å®ƒçš„Symbol.isConcatSpreadableå±æ€§é»˜è®¤ä¸ºfalseï¼Œå¿…é¡»æ‰‹åŠ¨æ‰“å¼€ã€‚

let obj = {length: 2, 0: 'c', 1: 'd'};
['a', 'b'].concat(obj, 'e') // ['a', 'b', obj, 'e']

obj[Symbol.isConcatSpreadable] = true;
['a', 'b'].concat(obj, 'e') // ['a', 'b', 'c', 'd', 'e']
å¯¹äºä¸€ä¸ªç±»æ¥è¯´ï¼ŒSymbol.isConcatSpreadableå±æ€§å¿…é¡»å†™æˆå®ä¾‹çš„å±æ€§ã€‚

class A1 extends Array {
  constructor(args) {
    super(args);
    this[Symbol.isConcatSpreadable] = true;
  }
}
class A2 extends Array {
  constructor(args) {
    super(args);
    this[Symbol.isConcatSpreadable] = false;
  }
}
let a1 = new A1();
a1[0] = 3;
a1[1] = 4;
let a2 = new A2();
a2[0] = 5;
a2[1] = 6;
[1, 2].concat(a1).concat(a2)
// [1, 2, 3, 4, [5, 6]]
ä¸Šé¢ä»£ç ä¸­ï¼Œç±»A1æ˜¯å¯å±•å¼€çš„ï¼Œç±»A2æ˜¯ä¸å¯å±•å¼€çš„ï¼Œæ‰€ä»¥ä½¿ç”¨concatæ—¶æœ‰ä¸ä¸€æ ·çš„ç»“æœã€‚

Symbol.species
å¯¹è±¡çš„Symbol.specieså±æ€§ï¼ŒæŒ‡å‘å½“å‰å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚åˆ›é€ å®ä¾‹æ—¶ï¼Œé»˜è®¤ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå³ä½¿ç”¨è¿™ä¸ªå±æ€§è¿”å›çš„å‡½æ•°å½“ä½œæ„é€ å‡½æ•°ï¼Œæ¥åˆ›é€ æ–°çš„å®ä¾‹å¯¹è±¡ã€‚

class MyArray extends Array {
  // è¦†ç›–çˆ¶ç±» Array çš„æ„é€ å‡½æ•°
  static get [Symbol.species]() { return Array; }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå­ç±»MyArrayç»§æ‰¿äº†çˆ¶ç±»Arrayã€‚åˆ›å»ºMyArrayçš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œæœ¬æ¥ä¼šè°ƒç”¨å®ƒè‡ªå·±çš„æ„é€ å‡½æ•°ï¼ˆæœ¬ä¾‹ä¸­è¢«çœç•¥äº†ï¼‰ï¼Œä½†æ˜¯ç”±äºå®šä¹‰äº†Symbol.specieså±æ€§ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨è¿™ä¸ªå±æ€§è¿”å›çš„çš„å‡½æ•°ï¼Œåˆ›å»ºMyArrayçš„å®ä¾‹ã€‚

è¿™ä¸ªä¾‹å­ä¹Ÿè¯´æ˜ï¼Œå®šä¹‰Symbol.specieså±æ€§è¦é‡‡ç”¨getè¯»å–å™¨ã€‚é»˜è®¤çš„Symbol.specieså±æ€§ç­‰åŒäºä¸‹é¢çš„å†™æ³•ã€‚

static get [Symbol.species]() {
  return this;
}
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

class MyArray extends Array {
  static get [Symbol.species]() { return Array; }
}
var a = new MyArray(1,2,3);
var mapped = a.map(x => x * x);

mapped instanceof MyArray // false
mapped instanceof Array // true
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºæ„é€ å‡½æ•°è¢«æ›¿æ¢æˆäº†Arrayã€‚æ‰€ä»¥ï¼Œmappedå¯¹è±¡ä¸æ˜¯MyArrayçš„å®ä¾‹ï¼Œè€Œæ˜¯Arrayçš„å®ä¾‹ã€‚

Symbol.match
å¯¹è±¡çš„Symbol.matchå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªå‡½æ•°ã€‚å½“æ‰§è¡Œstr.match(myObject)æ—¶ï¼Œå¦‚æœè¯¥å±æ€§å­˜åœ¨ï¼Œä¼šè°ƒç”¨å®ƒï¼Œè¿”å›è¯¥æ–¹æ³•çš„è¿”å›å€¼ã€‚

String.prototype.match(regexp)
// ç­‰åŒäº
regexp[Symbol.match](this)

class MyMatcher {
  [Symbol.match](string) {
    return 'hello world'.indexOf(string);
  }
}

'e'.match(new MyMatcher()) // 1
Symbol.replace
å¯¹è±¡çš„Symbol.replaceå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ–¹æ³•ï¼Œå½“è¯¥å¯¹è±¡è¢«String.prototype.replaceæ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šè¿”å›è¯¥æ–¹æ³•çš„è¿”å›å€¼ã€‚

String.prototype.replace(searchValue, replaceValue)
// ç­‰åŒäº
searchValue[Symbol.replace](this, replaceValue)
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

const x = {};
x[Symbol.replace] = (...s) => console.log(s);

'Hello'.replace(x, 'World') // ["Hello", "World"]
Symbol.replaceæ–¹æ³•ä¼šæ”¶åˆ°ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯replaceæ–¹æ³•æ­£åœ¨ä½œç”¨çš„å¯¹è±¡ï¼Œä¸Šé¢ä¾‹å­æ˜¯Helloï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ›¿æ¢åçš„å€¼ï¼Œä¸Šé¢ä¾‹å­æ˜¯Worldã€‚

Symbol.search
å¯¹è±¡çš„Symbol.searchå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ–¹æ³•ï¼Œå½“è¯¥å¯¹è±¡è¢«String.prototype.searchæ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šè¿”å›è¯¥æ–¹æ³•çš„è¿”å›å€¼ã€‚

String.prototype.search(regexp)
// ç­‰åŒäº
regexp[Symbol.search](this)

class MySearch {
  constructor(value) {
    this.value = value;
  }
  [Symbol.search](string) {
    return string.indexOf(this.value);
  }
}
'foobar'.search(new MySearch('foo')) // 0
Symbol.split
å¯¹è±¡çš„Symbol.splitå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ–¹æ³•ï¼Œå½“è¯¥å¯¹è±¡è¢«String.prototype.splitæ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šè¿”å›è¯¥æ–¹æ³•çš„è¿”å›å€¼ã€‚

String.prototype.split(separator, limit)
// ç­‰åŒäº
separator[Symbol.split](this, limit)
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

class MySplitter {
  constructor(value) {
    this.value = value;
  }
  [Symbol.split](string) {
    var index = string.indexOf(this.value);
    if (index === -1) {
      return string;
    }
    return [
      string.substr(0, index),
      string.substr(index + this.value.length)
    ];
  }
}

'foobar'.split(new MySplitter('foo'))
// ['', 'bar']

'foobar'.split(new MySplitter('bar'))
// ['foo', '']

'foobar'.split(new MySplitter('baz'))
// 'foobar'
ä¸Šé¢æ–¹æ³•ä½¿ç”¨Symbol.splitæ–¹æ³•ï¼Œé‡æ–°å®šä¹‰äº†å­—ç¬¦ä¸²å¯¹è±¡çš„splitæ–¹æ³•çš„è¡Œä¸ºï¼Œ

Symbol.iterator
å¯¹è±¡çš„Symbol.iteratorå±æ€§ï¼ŒæŒ‡å‘è¯¥å¯¹è±¡çš„é»˜è®¤éå†å™¨æ–¹æ³•ã€‚

var myIterable = {};
myIterable[Symbol.iterator] = function* () {
  yield 1;
  yield 2;
  yield 3;
};

[...myIterable] // [1, 2, 3]
å¯¹è±¡è¿›è¡Œfor...ofå¾ªç¯æ—¶ï¼Œä¼šè°ƒç”¨Symbol.iteratoræ–¹æ³•ï¼Œè¿”å›è¯¥å¯¹è±¡çš„é»˜è®¤éå†å™¨ï¼Œè¯¦ç»†ä»‹ç»å‚è§ã€ŠIteratorå’Œfor...ofå¾ªç¯ã€‹ä¸€ç« ã€‚

class Collection {
  *[Symbol.iterator]() {
    let i = 0;
    while(this[i] !== undefined) {
      yield this[i];
      ++i;
    }
  }
}

let myCollection = new Collection();
myCollection[0] = 1;
myCollection[1] = 2;

for(let value of myCollection) {
  console.log(value);
}
// 1
// 2
Symbol.toPrimitive
å¯¹è±¡çš„Symbol.toPrimitiveå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ–¹æ³•ã€‚è¯¥å¯¹è±¡è¢«è½¬ä¸ºåŸå§‹ç±»å‹çš„å€¼æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›è¯¥å¯¹è±¡å¯¹åº”çš„åŸå§‹ç±»å‹å€¼ã€‚

Symbol.toPrimitiveè¢«è°ƒç”¨æ—¶ï¼Œä¼šæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œè¡¨ç¤ºå½“å‰è¿ç®—çš„æ¨¡å¼ï¼Œä¸€å…±æœ‰ä¸‰ç§æ¨¡å¼ã€‚

Numberï¼šè¯¥åœºåˆéœ€è¦è½¬æˆæ•°å€¼
Stringï¼šè¯¥åœºåˆéœ€è¦è½¬æˆå­—ç¬¦ä¸²
Defaultï¼šè¯¥åœºåˆå¯ä»¥è½¬æˆæ•°å€¼ï¼Œä¹Ÿå¯ä»¥è½¬æˆå­—ç¬¦ä¸²
let obj = {
  [Symbol.toPrimitive](hint) {
    switch (hint) {
      case 'number':
        return 123;
      case 'string':
        return 'str';
      case 'default':
        return 'default';
      default:
        throw new Error();
     }
   }
};

2 * obj // 246
3 + obj // '3default'
obj == 'default' // true
String(obj) // 'str'
Symbol.toStringTag
å¯¹è±¡çš„Symbol.toStringTagå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªæ–¹æ³•ã€‚åœ¨è¯¥å¯¹è±¡ä¸Šé¢è°ƒç”¨Object.prototype.toStringæ–¹æ³•æ—¶ï¼Œå¦‚æœè¿™ä¸ªå±æ€§å­˜åœ¨ï¼Œå®ƒçš„è¿”å›å€¼ä¼šå‡ºç°åœ¨toStringæ–¹æ³•è¿”å›çš„å­—ç¬¦ä¸²ä¹‹ä¸­ï¼Œè¡¨ç¤ºå¯¹è±¡çš„ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥ç”¨æ¥å®šåˆ¶[object Object]æˆ–[object Array]ä¸­objectåé¢çš„é‚£ä¸ªå­—ç¬¦ä¸²ã€‚

// ä¾‹ä¸€
({[Symbol.toStringTag]: 'Foo'}.toString())
// "[object Foo]"

// ä¾‹äºŒ
class Collection {
  get [Symbol.toStringTag]() {
    return 'xxx';
  }
}
var x = new Collection();
Object.prototype.toString.call(x) // "[object xxx]"
ES6æ–°å¢å†…ç½®å¯¹è±¡çš„Symbol.toStringTagå±æ€§å€¼å¦‚ä¸‹ã€‚

JSON[Symbol.toStringTag]ï¼š'JSON'
Math[Symbol.toStringTag]ï¼š'Math'
Moduleå¯¹è±¡M[Symbol.toStringTag]ï¼š'Module'
ArrayBuffer.prototype[Symbol.toStringTag]ï¼š'ArrayBuffer'
DataView.prototype[Symbol.toStringTag]ï¼š'DataView'
Map.prototype[Symbol.toStringTag]ï¼š'Map'
Promise.prototype[Symbol.toStringTag]ï¼š'Promise'
Set.prototype[Symbol.toStringTag]ï¼š'Set'
%TypedArray%.prototype[Symbol.toStringTag]ï¼š'Uint8Array'ç­‰
WeakMap.prototype[Symbol.toStringTag]ï¼š'WeakMap'
WeakSet.prototype[Symbol.toStringTag]ï¼š'WeakSet'
%MapIteratorPrototype%[Symbol.toStringTag]ï¼š'Map Iterator'
%SetIteratorPrototype%[Symbol.toStringTag]ï¼š'Set Iterator'
%StringIteratorPrototype%[Symbol.toStringTag]ï¼š'String Iterator'
Symbol.prototype[Symbol.toStringTag]ï¼š'Symbol'
Generator.prototype[Symbol.toStringTag]ï¼š'Generator'
GeneratorFunction.prototype[Symbol.toStringTag]ï¼š'GeneratorFunction'
Symbol.unscopables
å¯¹è±¡çš„Symbol.unscopableså±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ã€‚è¯¥å¯¹è±¡æŒ‡å®šäº†ä½¿ç”¨withå…³é”®å­—æ—¶ï¼Œå“ªäº›å±æ€§ä¼šè¢«withç¯å¢ƒæ’é™¤ã€‚

Array.prototype[Symbol.unscopables]
// {
//   copyWithin: true,
//   entries: true,
//   fill: true,
//   find: true,
//   findIndex: true,
//   keys: true
// }

Object.keys(Array.prototype[Symbol.unscopables])
// ['copyWithin', 'entries', 'fill', 'find', 'findIndex', 'keys']
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œæ•°ç»„æœ‰6ä¸ªå±æ€§ï¼Œä¼šè¢«withå‘½ä»¤æ’é™¤ã€‚

// æ²¡æœ‰unscopablesæ—¶
class MyClass {
  foo() { return 1; }
}

var foo = function () { return 2; };

with (MyClass.prototype) {
  foo(); // 1
}

// æœ‰unscopablesæ—¶
class MyClass {
  foo() { return 1; }
  get [Symbol.unscopables]() {
    return { foo: true };
  }
}

var foo = function () { return 2; };

with (MyClass.prototype) {
  foo(); // 2
}

##Setå’ŒMapæ•°æ®ç»“æ„
1.Set
åŸºæœ¬ç”¨æ³•
ES6æä¾›äº†æ–°çš„æ•°æ®ç»“æ„Setã€‚å®ƒç±»ä¼¼äºæ•°ç»„ï¼Œä½†æ˜¯æˆå‘˜çš„å€¼éƒ½æ˜¯å”¯ä¸€çš„ï¼Œæ²¡æœ‰é‡å¤çš„å€¼ã€‚

Setæœ¬èº«æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”ŸæˆSetæ•°æ®ç»“æ„ã€‚

var s = new Set();

[2, 3, 5, 4, 5, 2, 2].map(x => s.add(x));

for (let i of s) {
  console.log(i);
}
// 2 3 5 4
ä¸Šé¢ä»£ç é€šè¿‡addæ–¹æ³•å‘Setç»“æ„åŠ å…¥æˆå‘˜ï¼Œç»“æœè¡¨æ˜Setç»“æ„ä¸ä¼šæ·»åŠ é‡å¤çš„å€¼ã€‚

Setå‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„ï¼ˆæˆ–ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼‰ä½œä¸ºå‚æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–ã€‚

// ä¾‹ä¸€
var set = new Set([1, 2, 3, 4, 4]);
[...set]
// [1, 2, 3, 4]

// ä¾‹äºŒ
var items = new Set([1, 2, 3, 4, 5, 5, 5, 5]);
items.size // 5

// ä¾‹ä¸‰
function divs () {
  return [...document.querySelectorAll('div')];
}

var set = new Set(divs());
set.size // 56

// ç±»ä¼¼äº
divs().forEach(div => set.add(div));
set.size // 56
ä¸Šé¢ä»£ç ä¸­ï¼Œä¾‹ä¸€å’Œä¾‹äºŒéƒ½æ˜¯Setå‡½æ•°æ¥å—æ•°ç»„ä½œä¸ºå‚æ•°ï¼Œä¾‹ä¸‰æ˜¯æ¥å—ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚

ä¸Šé¢ä»£ç ä¸­ï¼Œä¹Ÿå±•ç¤ºäº†ä¸€ç§å»é™¤æ•°ç»„é‡å¤æˆå‘˜çš„æ–¹æ³•ã€‚

// å»é™¤æ•°ç»„çš„é‡å¤æˆå‘˜
[...new Set(array)]
å‘SetåŠ å…¥å€¼çš„æ—¶å€™ï¼Œä¸ä¼šå‘ç”Ÿç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥5å’Œ"5"æ˜¯ä¸¤ä¸ªä¸åŒçš„å€¼ã€‚Setå†…éƒ¨åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ä¸åŒï¼Œä½¿ç”¨çš„ç®—æ³•å«åšâ€œSame-value equalityâ€ï¼Œå®ƒç±»ä¼¼äºç²¾ç¡®ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ===ï¼‰ï¼Œä¸»è¦çš„åŒºåˆ«æ˜¯NaNç­‰äºè‡ªèº«ï¼Œè€Œç²¾ç¡®ç›¸ç­‰è¿ç®—ç¬¦è®¤ä¸ºNaNä¸ç­‰äºè‡ªèº«ã€‚

let set = new Set();
let a = NaN;
let b = NaN;
set.add(a);
set.add(b);
set // Set {NaN}
ä¸Šé¢ä»£ç å‘Setå®ä¾‹æ·»åŠ äº†ä¸¤ä¸ªNaNï¼Œä½†æ˜¯åªèƒ½åŠ å…¥ä¸€ä¸ªã€‚è¿™è¡¨æ˜ï¼Œåœ¨Setå†…éƒ¨ï¼Œä¸¤ä¸ªNaNæ˜¯ç›¸ç­‰ã€‚

å¦å¤–ï¼Œä¸¤ä¸ªå¯¹è±¡æ€»æ˜¯ä¸ç›¸ç­‰çš„ã€‚

let set = new Set();

set.add({});
set.size // 1

set.add({});
set.size // 2
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œç”±äºä¸¤ä¸ªç©ºå¯¹è±¡ä¸ç›¸ç­‰ï¼Œæ‰€ä»¥å®ƒä»¬è¢«è§†ä¸ºä¸¤ä¸ªå€¼ã€‚

Setå®ä¾‹çš„å±æ€§å’Œæ–¹æ³•
Setç»“æ„çš„å®ä¾‹æœ‰ä»¥ä¸‹å±æ€§ã€‚

Set.prototype.constructorï¼šæ„é€ å‡½æ•°ï¼Œé»˜è®¤å°±æ˜¯Setå‡½æ•°ã€‚
Set.prototype.sizeï¼šè¿”å›Setå®ä¾‹çš„æˆå‘˜æ€»æ•°ã€‚
Setå®ä¾‹çš„æ–¹æ³•åˆ†ä¸ºä¸¤å¤§ç±»ï¼šæ“ä½œæ–¹æ³•ï¼ˆç”¨äºæ“ä½œæ•°æ®ï¼‰å’Œéå†æ–¹æ³•ï¼ˆç”¨äºéå†æˆå‘˜ï¼‰ã€‚ä¸‹é¢å…ˆä»‹ç»å››ä¸ªæ“ä½œæ–¹æ³•ã€‚

add(value)ï¼šæ·»åŠ æŸä¸ªå€¼ï¼Œè¿”å›Setç»“æ„æœ¬èº«ã€‚
delete(value)ï¼šåˆ é™¤æŸä¸ªå€¼ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºåˆ é™¤æ˜¯å¦æˆåŠŸã€‚
has(value)ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥å€¼æ˜¯å¦ä¸ºSetçš„æˆå‘˜ã€‚
clear()ï¼šæ¸…é™¤æ‰€æœ‰æˆå‘˜ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚
ä¸Šé¢è¿™äº›å±æ€§å’Œæ–¹æ³•çš„å®ä¾‹å¦‚ä¸‹ã€‚

s.add(1).add(2).add(2);
// æ³¨æ„2è¢«åŠ å…¥äº†ä¸¤æ¬¡

s.size // 2

s.has(1) // true
s.has(2) // true
s.has(3) // false

s.delete(2);
s.has(2) // false
ä¸‹é¢æ˜¯ä¸€ä¸ªå¯¹æ¯”ï¼Œçœ‹çœ‹åœ¨åˆ¤æ–­æ˜¯å¦åŒ…æ‹¬ä¸€ä¸ªé”®ä¸Šé¢ï¼ŒObjectç»“æ„å’ŒSetç»“æ„çš„å†™æ³•ä¸åŒã€‚

// å¯¹è±¡çš„å†™æ³•
var properties = {
  'width': 1,
  'height': 1
};

if (properties[someName]) {
  // do something
}

// Setçš„å†™æ³•
var properties = new Set();

properties.add('width');
properties.add('height');

if (properties.has(someName)) {
  // do something
}
Array.fromæ–¹æ³•å¯ä»¥å°†Setç»“æ„è½¬ä¸ºæ•°ç»„ã€‚

var items = new Set([1, 2, 3, 4, 5]);
var array = Array.from(items);
è¿™å°±æä¾›äº†å»é™¤æ•°ç»„é‡å¤æˆå‘˜çš„å¦ä¸€ç§æ–¹æ³•ã€‚

function dedupe(array) {
  return Array.from(new Set(array));
}

dedupe([1, 1, 2, 3]) // [1, 2, 3]
éå†æ“ä½œ
Setç»“æ„çš„å®ä¾‹æœ‰å››ä¸ªéå†æ–¹æ³•ï¼Œå¯ä»¥ç”¨äºéå†æˆå‘˜ã€‚

keys()ï¼šè¿”å›é”®åçš„éå†å™¨
values()ï¼šè¿”å›é”®å€¼çš„éå†å™¨
entries()ï¼šè¿”å›é”®å€¼å¯¹çš„éå†å™¨
forEach()ï¼šä½¿ç”¨å›è°ƒå‡½æ•°éå†æ¯ä¸ªæˆå‘˜
éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒSetçš„éå†é¡ºåºå°±æ˜¯æ’å…¥é¡ºåºã€‚è¿™ä¸ªç‰¹æ€§æœ‰æ—¶éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚ä½¿ç”¨Setä¿å­˜ä¸€ä¸ªå›è°ƒå‡½æ•°åˆ—è¡¨ï¼Œè°ƒç”¨æ—¶å°±èƒ½ä¿è¯æŒ‰ç…§æ·»åŠ é¡ºåºè°ƒç”¨ã€‚

ï¼ˆ1ï¼‰keys()ï¼Œvalues()ï¼Œentries()

keysæ–¹æ³•ã€valuesæ–¹æ³•ã€entriesæ–¹æ³•è¿”å›çš„éƒ½æ˜¯éå†å™¨å¯¹è±¡ï¼ˆè¯¦è§ã€ŠIterator å¯¹è±¡ã€‹ä¸€ç« ï¼‰ã€‚ç”±äº Set ç»“æ„æ²¡æœ‰é”®åï¼Œåªæœ‰é”®å€¼ï¼ˆæˆ–è€…è¯´é”®åå’Œé”®å€¼æ˜¯åŒä¸€ä¸ªå€¼ï¼‰ï¼Œæ‰€ä»¥keysæ–¹æ³•å’Œvaluesæ–¹æ³•çš„è¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚

let set = new Set(['red', 'green', 'blue']);

for (let item of set.keys()) {
  console.log(item);
}
// red
// green
// blue

for (let item of set.values()) {
  console.log(item);
}
// red
// green
// blue

for (let item of set.entries()) {
  console.log(item);
}
// ["red", "red"]
// ["green", "green"]
// ["blue", "blue"]
ä¸Šé¢ä»£ç ä¸­ï¼Œentriesæ–¹æ³•è¿”å›çš„éå†å™¨ï¼ŒåŒæ—¶åŒ…æ‹¬é”®åå’Œé”®å€¼ï¼Œæ‰€ä»¥æ¯æ¬¡è¾“å‡ºä¸€ä¸ªæ•°ç»„ï¼Œå®ƒçš„ä¸¤ä¸ªæˆå‘˜å®Œå…¨ç›¸ç­‰ã€‚

Setç»“æ„çš„å®ä¾‹é»˜è®¤å¯éå†ï¼Œå®ƒçš„é»˜è®¤éå†å™¨ç”Ÿæˆå‡½æ•°å°±æ˜¯å®ƒçš„valuesæ–¹æ³•ã€‚

Set.prototype[Symbol.iterator] === Set.prototype.values
// true
è¿™æ„å‘³ç€ï¼Œå¯ä»¥çœç•¥valuesæ–¹æ³•ï¼Œç›´æ¥ç”¨for...ofå¾ªç¯éå†Setã€‚

let set = new Set(['red', 'green', 'blue']);

for (let x of set) {
  console.log(x);
}
// red
// green
// blue
ï¼ˆ2ï¼‰forEach()

Setç»“æ„çš„å®ä¾‹çš„forEachæ–¹æ³•ï¼Œç”¨äºå¯¹æ¯ä¸ªæˆå‘˜æ‰§è¡ŒæŸç§æ“ä½œï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚

let set = new Set([1, 2, 3]);
set.forEach((value, key) => console.log(value * 2) )
// 2
// 4
// 6
ä¸Šé¢ä»£ç è¯´æ˜ï¼ŒforEachæ–¹æ³•çš„å‚æ•°å°±æ˜¯ä¸€ä¸ªå¤„ç†å‡½æ•°ã€‚è¯¥å‡½æ•°çš„å‚æ•°ä¾æ¬¡ä¸ºé”®å€¼ã€é”®åã€é›†åˆæœ¬èº«ï¼ˆä¸Šä¾‹çœç•¥äº†è¯¥å‚æ•°ï¼‰ã€‚å¦å¤–ï¼ŒforEachæ–¹æ³•è¿˜å¯ä»¥æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¡¨ç¤ºç»‘å®šçš„thiså¯¹è±¡ã€‚

ï¼ˆ3ï¼‰éå†çš„åº”ç”¨

æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰å†…éƒ¨ä½¿ç”¨for...ofå¾ªç¯ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨äºSetç»“æ„ã€‚

let set = new Set(['red', 'green', 'blue']);
let arr = [...set];
// ['red', 'green', 'blue']
æ‰©å±•è¿ç®—ç¬¦å’ŒSetç»“æ„ç›¸ç»“åˆï¼Œå°±å¯ä»¥å»é™¤æ•°ç»„çš„é‡å¤æˆå‘˜ã€‚

let arr = [3, 5, 2, 2, 5, 5];
let unique = [...new Set(arr)];
// [3, 5, 2]
è€Œä¸”ï¼Œæ•°ç»„çš„mapå’Œfilteræ–¹æ³•ä¹Ÿå¯ä»¥ç”¨äºSetäº†ã€‚

let set = new Set([1, 2, 3]);
set = new Set([...set].map(x => x * 2));
// è¿”å›Setç»“æ„ï¼š{2, 4, 6}

let set = new Set([1, 2, 3, 4, 5]);
set = new Set([...set].filter(x => (x % 2) == 0));
// è¿”å›Setç»“æ„ï¼š{2, 4}
å› æ­¤ä½¿ç”¨Setå¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°å¹¶é›†ï¼ˆUnionï¼‰ã€äº¤é›†ï¼ˆIntersectï¼‰å’Œå·®é›†ï¼ˆDifferenceï¼‰ã€‚

let a = new Set([1, 2, 3]);
let b = new Set([4, 3, 2]);

// å¹¶é›†
let union = new Set([...a, ...b]);
// Set {1, 2, 3, 4}

// äº¤é›†
let intersect = new Set([...a].filter(x => b.has(x)));
// set {2, 3}

// å·®é›†
let difference = new Set([...a].filter(x => !b.has(x)));
// Set {1}
å¦‚æœæƒ³åœ¨éå†æ“ä½œä¸­ï¼ŒåŒæ­¥æ”¹å˜åŸæ¥çš„Setç»“æ„ï¼Œç›®å‰æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•ï¼Œä½†æœ‰ä¸¤ç§å˜é€šæ–¹æ³•ã€‚ä¸€ç§æ˜¯åˆ©ç”¨åŸSetç»“æ„æ˜ å°„å‡ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼Œç„¶åèµ‹å€¼ç»™åŸæ¥çš„Setç»“æ„ï¼›å¦ä¸€ç§æ˜¯åˆ©ç”¨Array.fromæ–¹æ³•ã€‚

// æ–¹æ³•ä¸€
let set = new Set([1, 2, 3]);
set = new Set([...set].map(val => val * 2));
// setçš„å€¼æ˜¯2, 4, 6

// æ–¹æ³•äºŒ
let set = new Set([1, 2, 3]);
set = new Set(Array.from(set, val => val * 2));
// setçš„å€¼æ˜¯2, 4, 6
ä¸Šé¢ä»£ç æä¾›äº†ä¸¤ç§æ–¹æ³•ï¼Œç›´æ¥åœ¨éå†æ“ä½œä¸­æ”¹å˜åŸæ¥çš„Setç»“æ„ã€‚

WeakSet
WeakSetç»“æ„ä¸Setç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸é‡å¤çš„å€¼çš„é›†åˆã€‚ä½†æ˜¯ï¼Œå®ƒä¸Setæœ‰ä¸¤ä¸ªåŒºåˆ«ã€‚

é¦–å…ˆï¼ŒWeakSetçš„æˆå‘˜åªèƒ½æ˜¯å¯¹è±¡ï¼Œè€Œä¸èƒ½æ˜¯å…¶ä»–ç±»å‹çš„å€¼ã€‚

å…¶æ¬¡ï¼ŒWeakSetä¸­çš„å¯¹è±¡éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œå³åƒåœ¾å›æ”¶æœºåˆ¶ä¸è€ƒè™‘WeakSetå¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå…¶ä»–å¯¹è±¡éƒ½ä¸å†å¼•ç”¨è¯¥å¯¹è±¡ï¼Œé‚£ä¹ˆåƒåœ¾å›æ”¶æœºåˆ¶ä¼šè‡ªåŠ¨å›æ”¶è¯¥å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ï¼Œä¸è€ƒè™‘è¯¥å¯¹è±¡è¿˜å­˜åœ¨äºWeakSetä¹‹ä¸­ã€‚è¿™ä¸ªç‰¹ç‚¹æ„å‘³ç€ï¼Œæ— æ³•å¼•ç”¨WeakSetçš„æˆå‘˜ï¼Œå› æ­¤WeakSetæ˜¯ä¸å¯éå†çš„ã€‚

var ws = new WeakSet();
ws.add(1)
// TypeError: Invalid value used in weak set
ws.add(Symbol())
// TypeError: invalid value used in weak set
ä¸Šé¢ä»£ç è¯•å›¾å‘WeakSetæ·»åŠ ä¸€ä¸ªæ•°å€¼å’ŒSymbolå€¼ï¼Œç»“æœæŠ¥é”™ï¼Œå› ä¸ºWeakSetåªèƒ½æ”¾ç½®å¯¹è±¡ã€‚

WeakSetæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨newå‘½ä»¤ï¼Œåˆ›å»ºWeakSetæ•°æ®ç»“æ„ã€‚

var ws = new WeakSet();
ä½œä¸ºæ„é€ å‡½æ•°ï¼ŒWeakSetå¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„æˆ–ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚ï¼ˆå®é™…ä¸Šï¼Œä»»ä½•å…·æœ‰iterableæ¥å£çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥ä½œä¸ºWeakSetçš„å‚æ•°ã€‚ï¼‰è¯¥æ•°ç»„çš„æ‰€æœ‰æˆå‘˜ï¼Œéƒ½ä¼šè‡ªåŠ¨æˆä¸ºWeakSetå®ä¾‹å¯¹è±¡çš„æˆå‘˜ã€‚

var a = [[1,2], [3,4]];
var ws = new WeakSet(a);
ä¸Šé¢ä»£ç ä¸­ï¼Œaæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒæœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¹Ÿéƒ½æ˜¯æ•°ç»„ã€‚å°†aä½œä¸ºWeakSetæ„é€ å‡½æ•°çš„å‚æ•°ï¼Œaçš„æˆå‘˜ä¼šè‡ªåŠ¨æˆä¸ºWeakSetçš„æˆå‘˜ã€‚

æ³¨æ„ï¼Œæ˜¯aæ•°ç»„çš„æˆå‘˜æˆä¸ºWeakSetçš„æˆå‘˜ï¼Œè€Œä¸æ˜¯aæ•°ç»„æœ¬èº«ã€‚è¿™æ„å‘³ç€ï¼Œæ•°ç»„çš„æˆå‘˜åªèƒ½æ˜¯å¯¹è±¡ã€‚

var b = [3, 4];
var ws = new WeakSet(b);
// Uncaught TypeError: Invalid value used in weak set(â€¦)
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„bçš„æˆå‘˜ä¸æ˜¯å¯¹è±¡ï¼ŒåŠ å…¥WeaKSetå°±ä¼šæŠ¥é”™ã€‚

WeakSetç»“æ„æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ã€‚

WeakSet.prototype.add(value)ï¼šå‘WeakSetå®ä¾‹æ·»åŠ ä¸€ä¸ªæ–°æˆå‘˜ã€‚
WeakSet.prototype.delete(value)ï¼šæ¸…é™¤WeakSetå®ä¾‹çš„æŒ‡å®šæˆå‘˜ã€‚
WeakSet.prototype.has(value)ï¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæŸä¸ªå€¼æ˜¯å¦åœ¨WeakSetå®ä¾‹ä¹‹ä¸­ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var ws = new WeakSet();
var obj = {};
var foo = {};

ws.add(window);
ws.add(obj);

ws.has(window); // true
ws.has(foo);    // false

ws.delete(window);
ws.has(window);    // false
WeakSetæ²¡æœ‰sizeå±æ€§ï¼Œæ²¡æœ‰åŠæ³•éå†å®ƒçš„æˆå‘˜ã€‚

ws.size // undefined
ws.forEach // undefined

ws.forEach(function(item){ console.log('WeakSet has ' + item)})
// TypeError: undefined is not a function
ä¸Šé¢ä»£ç è¯•å›¾è·å–sizeå’ŒforEachå±æ€§ï¼Œç»“æœéƒ½ä¸èƒ½æˆåŠŸã€‚

WeakSetä¸èƒ½éå†ï¼Œæ˜¯å› ä¸ºæˆå‘˜éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œéšæ—¶å¯èƒ½æ¶ˆå¤±ï¼Œéå†æœºåˆ¶æ— æ³•ä¿è¯æˆå‘˜çš„å­˜åœ¨ï¼Œå¾ˆå¯èƒ½åˆšåˆšéå†ç»“æŸï¼Œæˆå‘˜å°±å–ä¸åˆ°äº†ã€‚WeakSetçš„ä¸€ä¸ªç”¨å¤„ï¼Œæ˜¯å‚¨å­˜DOMèŠ‚ç‚¹ï¼Œè€Œä¸ç”¨æ‹…å¿ƒè¿™äº›èŠ‚ç‚¹ä»æ–‡æ¡£ç§»é™¤æ—¶ï¼Œä¼šå¼•å‘å†…å­˜æ³„æ¼ã€‚

ä¸‹é¢æ˜¯WeakSetçš„å¦ä¸€ä¸ªä¾‹å­ã€‚

const foos = new WeakSet()
class Foo {
  constructor() {
    foos.add(this)
  }
  method () {
    if (!foos.has(this)) {
      throw new TypeError('Foo.prototype.method åªèƒ½åœ¨Fooçš„å®ä¾‹ä¸Šè°ƒç”¨ï¼');
    }
  }
}
ä¸Šé¢ä»£ç ä¿è¯äº†Fooçš„å®ä¾‹æ–¹æ³•ï¼Œåªèƒ½åœ¨Fooçš„å®ä¾‹ä¸Šè°ƒç”¨ã€‚è¿™é‡Œä½¿ç”¨WeakSetçš„å¥½å¤„æ˜¯ï¼Œfooså¯¹å®ä¾‹çš„å¼•ç”¨ï¼Œä¸ä¼šè¢«è®¡å…¥å†…å­˜å›æ”¶æœºåˆ¶ï¼Œæ‰€ä»¥åˆ é™¤å®ä¾‹çš„æ—¶å€™ï¼Œä¸ç”¨è€ƒè™‘foosï¼Œä¹Ÿä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ã€‚

Map
Mapç»“æ„çš„ç›®çš„å’ŒåŸºæœ¬ç”¨æ³•
JavaScriptçš„å¯¹è±¡ï¼ˆObjectï¼‰ï¼Œæœ¬è´¨ä¸Šæ˜¯é”®å€¼å¯¹çš„é›†åˆï¼ˆHashç»“æ„ï¼‰ï¼Œä½†æ˜¯ä¼ ç»Ÿä¸Šåªèƒ½ç”¨å­—ç¬¦ä¸²å½“ä½œé”®ã€‚è¿™ç»™å®ƒçš„ä½¿ç”¨å¸¦æ¥äº†å¾ˆå¤§çš„é™åˆ¶ã€‚

var data = {};
var element = document.getElementById('myDiv');

data[element] = 'metadata';
data['[object HTMLDivElement]'] // "metadata"
ä¸Šé¢ä»£ç åŸæ„æ˜¯å°†ä¸€ä¸ªDOMèŠ‚ç‚¹ä½œä¸ºå¯¹è±¡dataçš„é”®ï¼Œä½†æ˜¯ç”±äºå¯¹è±¡åªæ¥å—å­—ç¬¦ä¸²ä½œä¸ºé”®åï¼Œæ‰€ä»¥elementè¢«è‡ªåŠ¨è½¬ä¸ºå­—ç¬¦ä¸²[object HTMLDivElement]ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒES6æä¾›äº†Mapæ•°æ®ç»“æ„ã€‚å®ƒç±»ä¼¼äºå¯¹è±¡ï¼Œä¹Ÿæ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œä½†æ˜¯â€œé”®â€çš„èŒƒå›´ä¸é™äºå­—ç¬¦ä¸²ï¼Œå„ç§ç±»å‹çš„å€¼ï¼ˆåŒ…æ‹¬å¯¹è±¡ï¼‰éƒ½å¯ä»¥å½“ä½œé”®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒObjectç»“æ„æä¾›äº†â€œå­—ç¬¦ä¸²â€”å€¼â€çš„å¯¹åº”ï¼ŒMapç»“æ„æä¾›äº†â€œå€¼â€”å€¼â€çš„å¯¹åº”ï¼Œæ˜¯ä¸€ç§æ›´å®Œå–„çš„Hashç»“æ„å®ç°ã€‚å¦‚æœä½ éœ€è¦â€œé”®å€¼å¯¹â€çš„æ•°æ®ç»“æ„ï¼ŒMapæ¯”Objectæ›´åˆé€‚ã€‚

var m = new Map();
var o = {p: 'Hello World'};

m.set(o, 'content')
m.get(o) // "content"

m.has(o) // true
m.delete(o) // true
m.has(o) // false
ä¸Šé¢ä»£ç ä½¿ç”¨setæ–¹æ³•ï¼Œå°†å¯¹è±¡oå½“ä½œmçš„ä¸€ä¸ªé”®ï¼Œç„¶ååˆä½¿ç”¨getæ–¹æ³•è¯»å–è¿™ä¸ªé”®ï¼Œæ¥ç€ä½¿ç”¨deleteæ–¹æ³•åˆ é™¤äº†è¿™ä¸ªé”®ã€‚

ä½œä¸ºæ„é€ å‡½æ•°ï¼ŒMapä¹Ÿå¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„ä½œä¸ºå‚æ•°ã€‚è¯¥æ•°ç»„çš„æˆå‘˜æ˜¯ä¸€ä¸ªä¸ªè¡¨ç¤ºé”®å€¼å¯¹çš„æ•°ç»„ã€‚

var map = new Map([
  ['name', 'å¼ ä¸‰'],
  ['title', 'Author']
]);

map.size // 2
map.has('name') // true
map.get('name') // "å¼ ä¸‰"
map.has('title') // true
map.get('title') // "Author"
ä¸Šé¢ä»£ç åœ¨æ–°å»ºMapå®ä¾‹æ—¶ï¼Œå°±æŒ‡å®šäº†ä¸¤ä¸ªé”®nameå’Œtitleã€‚

Mapæ„é€ å‡½æ•°æ¥å—æ•°ç»„ä½œä¸ºå‚æ•°ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ä¸‹é¢çš„ç®—æ³•ã€‚

var items = [
  ['name', 'å¼ ä¸‰'],
  ['title', 'Author']
];
var map = new Map();
items.forEach(([key, value]) => map.set(key, value));
ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå­—ç¬¦ä¸²trueå’Œå¸ƒå°”å€¼trueæ˜¯ä¸¤ä¸ªä¸åŒçš„é”®ã€‚

var m = new Map([
  [true, 'foo'],
  ['true', 'bar']
]);

m.get(true) // 'foo'
m.get('true') // 'bar'
å¦‚æœå¯¹åŒä¸€ä¸ªé”®å¤šæ¬¡èµ‹å€¼ï¼Œåé¢çš„å€¼å°†è¦†ç›–å‰é¢çš„å€¼ã€‚

let map = new Map();

map
.set(1, 'aaa')
.set(1, 'bbb');

map.get(1) // "bbb"
ä¸Šé¢ä»£ç å¯¹é”®1è¿ç»­èµ‹å€¼ä¸¤æ¬¡ï¼Œåä¸€æ¬¡çš„å€¼è¦†ç›–å‰ä¸€æ¬¡çš„å€¼ã€‚

å¦‚æœè¯»å–ä¸€ä¸ªæœªçŸ¥çš„é”®ï¼Œåˆ™è¿”å›undefinedã€‚

new Map().get('asfddfsasadf')
// undefined
æ³¨æ„ï¼Œåªæœ‰å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼ŒMapç»“æ„æ‰å°†å…¶è§†ä¸ºåŒä¸€ä¸ªé”®ã€‚è¿™ä¸€ç‚¹è¦éå¸¸å°å¿ƒã€‚

var map = new Map();

map.set(['a'], 555);
map.get(['a']) // undefined
ä¸Šé¢ä»£ç çš„setå’Œgetæ–¹æ³•ï¼Œè¡¨é¢æ˜¯é’ˆå¯¹åŒä¸€ä¸ªé”®ï¼Œä½†å®é™…ä¸Šè¿™æ˜¯ä¸¤ä¸ªå€¼ï¼Œå†…å­˜åœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› æ­¤getæ–¹æ³•æ— æ³•è¯»å–è¯¥é”®ï¼Œè¿”å›undefinedã€‚

åŒç†ï¼ŒåŒæ ·çš„å€¼çš„ä¸¤ä¸ªå®ä¾‹ï¼Œåœ¨Mapç»“æ„ä¸­è¢«è§†ä¸ºä¸¤ä¸ªé”®ã€‚

var map = new Map();

var k1 = ['a'];
var k2 = ['a'];

map
.set(k1, 111)
.set(k2, 222);

map.get(k1) // 111
map.get(k2) // 222
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡k1å’Œk2çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®ƒä»¬åœ¨Mapç»“æ„ä¸­è¢«è§†ä¸ºä¸¤ä¸ªé”®ã€‚

ç”±ä¸Šå¯çŸ¥ï¼ŒMapçš„é”®å®é™…ä¸Šæ˜¯è·Ÿå†…å­˜åœ°å€ç»‘å®šçš„ï¼Œåªè¦å†…å­˜åœ°å€ä¸ä¸€æ ·ï¼Œå°±è§†ä¸ºä¸¤ä¸ªé”®ã€‚è¿™å°±è§£å†³äº†åŒåå±æ€§ç¢°æ’ï¼ˆclashï¼‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ‰©å±•åˆ«äººçš„åº“çš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®åï¼Œå°±ä¸ç”¨æ‹…å¿ƒè‡ªå·±çš„å±æ€§ä¸åŸä½œè€…çš„å±æ€§åŒåã€‚

å¦‚æœMapçš„é”®æ˜¯ä¸€ä¸ªç®€å•ç±»å‹çš„å€¼ï¼ˆæ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ï¼‰ï¼Œåˆ™åªè¦ä¸¤ä¸ªå€¼ä¸¥æ ¼ç›¸ç­‰ï¼ŒMapå°†å…¶è§†ä¸ºä¸€ä¸ªé”®ï¼ŒåŒ…æ‹¬0å’Œ-0ã€‚å¦å¤–ï¼Œè™½ç„¶NaNä¸ä¸¥æ ¼ç›¸ç­‰äºè‡ªèº«ï¼Œä½†Mapå°†å…¶è§†ä¸ºåŒä¸€ä¸ªé”®ã€‚

let map = new Map();

map.set(NaN, 123);
map.get(NaN) // 123

map.set(-0, 123);
map.get(+0) // 123
å®ä¾‹çš„å±æ€§å’Œæ“ä½œæ–¹æ³•
Mapç»“æ„çš„å®ä¾‹æœ‰ä»¥ä¸‹å±æ€§å’Œæ“ä½œæ–¹æ³•ã€‚

ï¼ˆ1ï¼‰sizeå±æ€§

sizeå±æ€§è¿”å›Mapç»“æ„çš„æˆå‘˜æ€»æ•°ã€‚

let map = new Map();
map.set('foo', true);
map.set('bar', false);

map.size // 2
ï¼ˆ2ï¼‰set(key, value)

setæ–¹æ³•è®¾ç½®keyæ‰€å¯¹åº”çš„é”®å€¼ï¼Œç„¶åè¿”å›æ•´ä¸ªMapç»“æ„ã€‚å¦‚æœkeyå·²ç»æœ‰å€¼ï¼Œåˆ™é”®å€¼ä¼šè¢«æ›´æ–°ï¼Œå¦åˆ™å°±æ–°ç”Ÿæˆè¯¥é”®ã€‚

var m = new Map();

m.set("edition", 6)        // é”®æ˜¯å­—ç¬¦ä¸²
m.set(262, "standard")     // é”®æ˜¯æ•°å€¼
m.set(undefined, "nah")    // é”®æ˜¯undefined
setæ–¹æ³•è¿”å›çš„æ˜¯Mapæœ¬èº«ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ã€‚

let map = new Map()
  .set(1, 'a')
  .set(2, 'b')
  .set(3, 'c');
ï¼ˆ3ï¼‰get(key)

getæ–¹æ³•è¯»å–keyå¯¹åº”çš„é”®å€¼ï¼Œå¦‚æœæ‰¾ä¸åˆ°keyï¼Œè¿”å›undefinedã€‚

var m = new Map();

var hello = function() {console.log("hello");}
m.set(hello, "Hello ES6!") // é”®æ˜¯å‡½æ•°

m.get(hello)  // Hello ES6!
ï¼ˆ4ï¼‰has(key)

hasæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæŸä¸ªé”®æ˜¯å¦åœ¨Mapæ•°æ®ç»“æ„ä¸­ã€‚

var m = new Map();

m.set("edition", 6);
m.set(262, "standard");
m.set(undefined, "nah");

m.has("edition")     // true
m.has("years")       // false
m.has(262)           // true
m.has(undefined)     // true
ï¼ˆ5ï¼‰delete(key)

deleteæ–¹æ³•åˆ é™¤æŸä¸ªé”®ï¼Œè¿”å›trueã€‚å¦‚æœåˆ é™¤å¤±è´¥ï¼Œè¿”å›falseã€‚

var m = new Map();
m.set(undefined, "nah");
m.has(undefined)     // true

m.delete(undefined)
m.has(undefined)       // false
ï¼ˆ6ï¼‰clear()

clearæ–¹æ³•æ¸…é™¤æ‰€æœ‰æˆå‘˜ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚

let map = new Map();
map.set('foo', true);
map.set('bar', false);

map.size // 2
map.clear()
map.size // 0
éå†æ–¹æ³•
MapåŸç”Ÿæä¾›ä¸‰ä¸ªéå†å™¨ç”Ÿæˆå‡½æ•°å’Œä¸€ä¸ªéå†æ–¹æ³•ã€‚

keys()ï¼šè¿”å›é”®åçš„éå†å™¨ã€‚
values()ï¼šè¿”å›é”®å€¼çš„éå†å™¨ã€‚
entries()ï¼šè¿”å›æ‰€æœ‰æˆå‘˜çš„éå†å™¨ã€‚
forEach()ï¼šéå†Mapçš„æ‰€æœ‰æˆå‘˜ã€‚
éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼ŒMapçš„éå†é¡ºåºå°±æ˜¯æ’å…¥é¡ºåºã€‚

ä¸‹é¢æ˜¯ä½¿ç”¨å®ä¾‹ã€‚

let map = new Map([
  ['F', 'no'],
  ['T',  'yes'],
]);

for (let key of map.keys()) {
  console.log(key);
}
// "F"
// "T"

for (let value of map.values()) {
  console.log(value);
}
// "no"
// "yes"

for (let item of map.entries()) {
  console.log(item[0], item[1]);
}
// "F" "no"
// "T" "yes"

// æˆ–è€…
for (let [key, value] of map.entries()) {
  console.log(key, value);
}

// ç­‰åŒäºä½¿ç”¨map.entries()
for (let [key, value] of map) {
  console.log(key, value);
}
ä¸Šé¢ä»£ç æœ€åçš„é‚£ä¸ªä¾‹å­ï¼Œè¡¨ç¤ºMapç»“æ„çš„é»˜è®¤éå†å™¨æ¥å£ï¼ˆSymbol.iteratorå±æ€§ï¼‰ï¼Œå°±æ˜¯entriesæ–¹æ³•ã€‚

map[Symbol.iterator] === map.entries
// true
Mapç»“æ„è½¬ä¸ºæ•°ç»„ç»“æ„ï¼Œæ¯”è¾ƒå¿«é€Ÿçš„æ–¹æ³•æ˜¯ç»“åˆä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ã€‚

let map = new Map([
  [1, 'one'],
  [2, 'two'],
  [3, 'three'],
]);

[...map.keys()]
// [1, 2, 3]

[...map.values()]
// ['one', 'two', 'three']

[...map.entries()]
// [[1,'one'], [2, 'two'], [3, 'three']]

[...map]
// [[1,'one'], [2, 'two'], [3, 'three']]
ç»“åˆæ•°ç»„çš„mapæ–¹æ³•ã€filteræ–¹æ³•ï¼Œå¯ä»¥å®ç°Mapçš„éå†å’Œè¿‡æ»¤ï¼ˆMapæœ¬èº«æ²¡æœ‰mapå’Œfilteræ–¹æ³•ï¼‰ã€‚

let map0 = new Map()
  .set(1, 'a')
  .set(2, 'b')
  .set(3, 'c');

let map1 = new Map(
  [...map0].filter(([k, v]) => k < 3)
);
// äº§ç”ŸMapç»“æ„ {1 => 'a', 2 => 'b'}

let map2 = new Map(
  [...map0].map(([k, v]) => [k * 2, '_' + v])
    );
// äº§ç”ŸMapç»“æ„ {2 => '_a', 4 => '_b', 6 => '_c'}
æ­¤å¤–ï¼ŒMapè¿˜æœ‰ä¸€ä¸ªforEachæ–¹æ³•ï¼Œä¸æ•°ç»„çš„forEachæ–¹æ³•ç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥å®ç°éå†ã€‚

map.forEach(function(value, key, map) {
  console.log("Key: %s, Value: %s", key, value);
});
forEachæ–¹æ³•è¿˜å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥ç»‘å®šthisã€‚

var reporter = {
  report: function(key, value) {
    console.log("Key: %s, Value: %s", key, value);
  }
};

map.forEach(function(value, key, map) {
  this.report(key, value);
}, reporter);
ä¸Šé¢ä»£ç ä¸­ï¼ŒforEachæ–¹æ³•çš„å›è°ƒå‡½æ•°çš„thisï¼Œå°±æŒ‡å‘reporterã€‚

ä¸å…¶ä»–æ•°æ®ç»“æ„çš„äº’ç›¸è½¬æ¢
ï¼ˆ1ï¼‰Mapè½¬ä¸ºæ•°ç»„

å‰é¢å·²ç»æè¿‡ï¼ŒMapè½¬ä¸ºæ•°ç»„æœ€æ–¹ä¾¿çš„æ–¹æ³•ï¼Œå°±æ˜¯ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ã€‚

let myMap = new Map().set(true, 7).set({foo: 3}, ['abc']);
[...myMap]
// [ [ true, 7 ], [ { foo: 3 }, [ 'abc' ] ] ]
ï¼ˆ2ï¼‰æ•°ç»„è½¬ä¸ºMap

å°†æ•°ç»„è½¬å…¥Mapæ„é€ å‡½æ•°ï¼Œå°±å¯ä»¥è½¬ä¸ºMapã€‚

new Map([[true, 7], [{foo: 3}, ['abc']]])
// Map {true => 7, Object {foo: 3} => ['abc']}
ï¼ˆ3ï¼‰Mapè½¬ä¸ºå¯¹è±¡

å¦‚æœæ‰€æœ‰Mapçš„é”®éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå®ƒå¯ä»¥è½¬ä¸ºå¯¹è±¡ã€‚

function strMapToObj(strMap) {
  let obj = Object.create(null);
  for (let [k,v] of strMap) {
    obj[k] = v;
  }
  return obj;
}

let myMap = new Map().set('yes', true).set('no', false);
strMapToObj(myMap)
// { yes: true, no: false }
ï¼ˆ4ï¼‰å¯¹è±¡è½¬ä¸ºMap

function objToStrMap(obj) {
  let strMap = new Map();
  for (let k of Object.keys(obj)) {
    strMap.set(k, obj[k]);
  }
  return strMap;
}

objToStrMap({yes: true, no: false})
// [ [ 'yes', true ], [ 'no', false ] ]
ï¼ˆ5ï¼‰Mapè½¬ä¸ºJSON

Mapè½¬ä¸ºJSONè¦åŒºåˆ†ä¸¤ç§æƒ…å†µã€‚ä¸€ç§æƒ…å†µæ˜¯ï¼ŒMapçš„é”®åéƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™æ—¶å¯ä»¥é€‰æ‹©è½¬ä¸ºå¯¹è±¡JSONã€‚

function strMapToJson(strMap) {
  return JSON.stringify(strMapToObj(strMap));
}

let myMap = new Map().set('yes', true).set('no', false);
strMapToJson(myMap)
// '{"yes":true,"no":false}'
å¦ä¸€ç§æƒ…å†µæ˜¯ï¼ŒMapçš„é”®åæœ‰éå­—ç¬¦ä¸²ï¼Œè¿™æ—¶å¯ä»¥é€‰æ‹©è½¬ä¸ºæ•°ç»„JSONã€‚

function mapToArrayJson(map) {
  return JSON.stringify([...map]);
}

let myMap = new Map().set(true, 7).set({foo: 3}, ['abc']);
mapToArrayJson(myMap)
// '[[true,7],[{"foo":3},["abc"]]]'
ï¼ˆ6ï¼‰JSONè½¬ä¸ºMap

JSONè½¬ä¸ºMapï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é”®åéƒ½æ˜¯å­—ç¬¦ä¸²ã€‚

function jsonToStrMap(jsonStr) {
  return objToStrMap(JSON.parse(jsonStr));
}

jsonToStrMap('{"yes":true,"no":false}')
// Map {'yes' => true, 'no' => false}
ä½†æ˜¯ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œæ•´ä¸ªJSONå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸”æ¯ä¸ªæ•°ç»„æˆå‘˜æœ¬èº«ï¼Œåˆæ˜¯ä¸€ä¸ªæœ‰ä¸¤ä¸ªæˆå‘˜çš„æ•°ç»„ã€‚è¿™æ—¶ï¼Œå®ƒå¯ä»¥ä¸€ä¸€å¯¹åº”åœ°è½¬ä¸ºMapã€‚è¿™å¾€å¾€æ˜¯æ•°ç»„è½¬ä¸ºJSONçš„é€†æ“ä½œã€‚

function jsonToMap(jsonStr) {
  return new Map(JSON.parse(jsonStr));
}

jsonToMap('[[true,7],[{"foo":3},["abc"]]]')
// Map {true => 7, Object {foo: 3} => ['abc']}
WeakMap
WeakMapç»“æ„ä¸Mapç»“æ„åŸºæœ¬ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å®ƒåªæ¥å—å¯¹è±¡ä½œä¸ºé”®åï¼ˆnullé™¤å¤–ï¼‰ï¼Œä¸æ¥å—å…¶ä»–ç±»å‹çš„å€¼ä½œä¸ºé”®åï¼Œè€Œä¸”é”®åæ‰€æŒ‡å‘çš„å¯¹è±¡ï¼Œä¸è®¡å…¥åƒåœ¾å›æ”¶æœºåˆ¶ã€‚

var map = new WeakMap()
map.set(1, 2)
// TypeError: 1 is not an object!
map.set(Symbol(), 2)
// TypeError: Invalid value used as weak map key
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœå°†1å’ŒSymbolä½œä¸ºWeakMapçš„é”®åï¼Œéƒ½ä¼šæŠ¥é”™ã€‚

WeakMapçš„è®¾è®¡ç›®çš„åœ¨äºï¼Œé”®åæ˜¯å¯¹è±¡çš„å¼±å¼•ç”¨ï¼ˆåƒåœ¾å›æ”¶æœºåˆ¶ä¸å°†è¯¥å¼•ç”¨è€ƒè™‘åœ¨å†…ï¼‰ï¼Œæ‰€ä»¥å…¶æ‰€å¯¹åº”çš„å¯¹è±¡å¯èƒ½ä¼šè¢«è‡ªåŠ¨å›æ”¶ã€‚å½“å¯¹è±¡è¢«å›æ”¶åï¼ŒWeakMapè‡ªåŠ¨ç§»é™¤å¯¹åº”çš„é”®å€¼å¯¹ã€‚å…¸å‹åº”ç”¨æ˜¯ï¼Œä¸€ä¸ªå¯¹åº”DOMå…ƒç´ çš„WeakMapç»“æ„ï¼Œå½“æŸä¸ªDOMå…ƒç´ è¢«æ¸…é™¤ï¼Œå…¶æ‰€å¯¹åº”çš„WeakMapè®°å½•å°±ä¼šè‡ªåŠ¨è¢«ç§»é™¤ã€‚åŸºæœ¬ä¸Šï¼ŒWeakMapçš„ä¸“ç”¨åœºåˆå°±æ˜¯ï¼Œå®ƒçš„é”®æ‰€å¯¹åº”çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šåœ¨å°†æ¥æ¶ˆå¤±ã€‚WeakMapç»“æ„æœ‰åŠ©äºé˜²æ­¢å†…å­˜æ³„æ¼ã€‚

ä¸‹é¢æ˜¯WeakMapç»“æ„çš„ä¸€ä¸ªä¾‹å­ï¼Œå¯ä»¥çœ‹åˆ°ç”¨æ³•ä¸Šä¸Mapå‡ ä¹ä¸€æ ·ã€‚

var wm = new WeakMap();
var element = document.querySelector(".element");

wm.set(element, "Original");
wm.get(element) // "Original"

element.parentNode.removeChild(element);
element = null;
wm.get(element) // undefined
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡wmæ˜¯ä¸€ä¸ªWeakMapå®ä¾‹ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªDOMèŠ‚ç‚¹elementä½œä¸ºé”®åï¼Œç„¶åé”€æ¯è¿™ä¸ªèŠ‚ç‚¹ï¼Œelementå¯¹åº”çš„é”®å°±è‡ªåŠ¨æ¶ˆå¤±äº†ï¼Œå†å¼•ç”¨è¿™ä¸ªé”®åå°±è¿”å›undefinedã€‚

WeakMapä¸Mapåœ¨APIä¸Šçš„åŒºåˆ«ä¸»è¦æ˜¯ä¸¤ä¸ªï¼Œä¸€æ˜¯æ²¡æœ‰éå†æ“ä½œï¼ˆå³æ²¡æœ‰key()ã€values()å’Œentries()æ–¹æ³•ï¼‰ï¼Œä¹Ÿæ²¡æœ‰sizeå±æ€§ï¼›äºŒæ˜¯æ— æ³•æ¸…ç©ºï¼Œå³ä¸æ”¯æŒclearæ–¹æ³•ã€‚è¿™ä¸WeakMapçš„é”®ä¸è¢«è®¡å…¥å¼•ç”¨ã€è¢«åƒåœ¾å›æ”¶æœºåˆ¶å¿½ç•¥æœ‰å…³ã€‚å› æ­¤ï¼ŒWeakMapåªæœ‰å››ä¸ªæ–¹æ³•å¯ç”¨ï¼šget()ã€set()ã€has()ã€delete()ã€‚

var wm = new WeakMap();

wm.size
// undefined

wm.forEach
// undefined
å‰æ–‡è¯´è¿‡ï¼ŒWeakMapåº”ç”¨çš„å…¸å‹åœºåˆå°±æ˜¯DOMèŠ‚ç‚¹ä½œä¸ºé”®åã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

let myElement = document.getElementById('logo');
let myWeakmap = new WeakMap();

myWeakmap.set(myElement, {timesClicked: 0});

myElement.addEventListener('click', function() {
  let logoData = myWeakmap.get(myElement);
  logoData.timesClicked++;
}, false);
ä¸Šé¢ä»£ç ä¸­ï¼ŒmyElementæ˜¯ä¸€ä¸ª DOM èŠ‚ç‚¹ï¼Œæ¯å½“å‘ç”Ÿclickäº‹ä»¶ï¼Œå°±æ›´æ–°ä¸€ä¸‹çŠ¶æ€ã€‚æˆ‘ä»¬å°†è¿™ä¸ªçŠ¶æ€ä½œä¸ºé”®å€¼æ”¾åœ¨ WeakMap é‡Œï¼Œå¯¹åº”çš„é”®åå°±æ˜¯myElementã€‚ä¸€æ—¦è¿™ä¸ª DOM èŠ‚ç‚¹åˆ é™¤ï¼Œè¯¥çŠ¶æ€å°±ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œä¸å­˜åœ¨å†…å­˜æ³„æ¼é£é™©ã€‚

WeakMap çš„å¦ä¸€ä¸ªç”¨å¤„æ˜¯éƒ¨ç½²ç§æœ‰å±æ€§ã€‚

let _counter = new WeakMap();
let _action = new WeakMap();

class Countdown {
  constructor(counter, action) {
    _counter.set(this, counter);
    _action.set(this, action);
  }
  dec() {
    let counter = _counter.get(this);
    if (counter < 1) return;
    counter--;
    _counter.set(this, counter);
    if (counter === 0) {
      _action.get(this)();
    }
  }
}

let c = new Countdown(2, () => console.log('DONE'));

c.dec()
c.dec()
// DONE
ä¸Šé¢ä»£ç ä¸­ï¼ŒCountdownç±»çš„ä¸¤ä¸ªå†…éƒ¨å±æ€§_counterå’Œ_actionï¼Œæ˜¯å®ä¾‹çš„å¼±å¼•ç”¨ï¼Œæ‰€ä»¥å¦‚æœåˆ é™¤å®ä¾‹ï¼Œå®ƒä»¬ä¹Ÿå°±éšä¹‹æ¶ˆå¤±ï¼Œä¸ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚

##Proxy
1.æ¦‚è¿°
Proxy ç”¨äºä¿®æ”¹æŸäº›æ“ä½œçš„é»˜è®¤è¡Œä¸ºï¼Œç­‰åŒäºåœ¨è¯­è¨€å±‚é¢åšå‡ºä¿®æ”¹ï¼Œæ‰€ä»¥å±äºä¸€ç§â€œå…ƒç¼–ç¨‹â€ï¼ˆmeta programmingï¼‰ï¼Œå³å¯¹ç¼–ç¨‹è¯­è¨€è¿›è¡Œç¼–ç¨‹ã€‚

Proxy å¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚â€œæ‹¦æˆªâ€ï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚Proxy è¿™ä¸ªè¯çš„åŸæ„æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼Œå¯ä»¥è¯‘ä¸ºâ€œä»£ç†å™¨â€ã€‚

var obj = new Proxy({}, {
  get: function (target, key, receiver) {
    console.log(`getting ${key}!`);
    return Reflect.get(target, key, receiver);
  },
  set: function (target, key, value, receiver) {
    console.log(`setting ${key}!`);
    return Reflect.set(target, key, value, receiver);
  }
});
ä¸Šé¢ä»£ç å¯¹ä¸€ä¸ªç©ºå¯¹è±¡æ¶è®¾äº†ä¸€å±‚æ‹¦æˆªï¼Œé‡å®šä¹‰äº†å±æ€§çš„è¯»å–ï¼ˆgetï¼‰å’Œè®¾ç½®ï¼ˆsetï¼‰è¡Œä¸ºã€‚è¿™é‡Œæš‚æ—¶å…ˆä¸è§£é‡Šå…·ä½“çš„è¯­æ³•ï¼Œåªçœ‹è¿è¡Œç»“æœã€‚å¯¹è®¾ç½®äº†æ‹¦æˆªè¡Œä¸ºçš„å¯¹è±¡objï¼Œå»è¯»å†™å®ƒçš„å±æ€§ï¼Œå°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç»“æœã€‚

obj.count = 1
//  setting count!
++obj.count
//  getting count!
//  setting count!
//  2
ä¸Šé¢ä»£ç è¯´æ˜ï¼ŒProxy å®é™…ä¸Šé‡è½½ï¼ˆoverloadï¼‰äº†ç‚¹è¿ç®—ç¬¦ï¼Œå³ç”¨è‡ªå·±çš„å®šä¹‰è¦†ç›–äº†è¯­è¨€çš„åŸå§‹å®šä¹‰ã€‚

ES6 åŸç”Ÿæä¾› Proxy æ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”Ÿæˆ Proxy å®ä¾‹ã€‚

var proxy = new Proxy(target, handler);
Proxy å¯¹è±¡çš„æ‰€æœ‰ç”¨æ³•ï¼Œéƒ½æ˜¯ä¸Šé¢è¿™ç§å½¢å¼ï¼Œä¸åŒçš„åªæ˜¯handlerå‚æ•°çš„å†™æ³•ã€‚å…¶ä¸­ï¼Œnew Proxy()è¡¨ç¤ºç”Ÿæˆä¸€ä¸ªProxyå®ä¾‹ï¼Œtargetå‚æ•°è¡¨ç¤ºæ‰€è¦æ‹¦æˆªçš„ç›®æ ‡å¯¹è±¡ï¼Œhandlerå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å®šåˆ¶æ‹¦æˆªè¡Œä¸ºã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªæ‹¦æˆªè¯»å–å±æ€§è¡Œä¸ºçš„ä¾‹å­ã€‚

var proxy = new Proxy({}, {
  get: function(target, property) {
    return 35;
  }
});

proxy.time // 35
proxy.name // 35
proxy.title // 35
ä¸Šé¢ä»£ç ä¸­ï¼Œä½œä¸ºæ„é€ å‡½æ•°ï¼ŒProxyæ¥å—ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰€è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼ˆä¸Šä¾‹æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼‰ï¼Œå³å¦‚æœæ²¡æœ‰Proxyçš„ä»‹å…¥ï¼Œæ“ä½œåŸæ¥è¦è®¿é—®çš„å°±æ˜¯è¿™ä¸ªå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¢«ä»£ç†çš„æ“ä½œï¼Œéœ€è¦æä¾›ä¸€ä¸ªå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ‹¦æˆªå¯¹åº”çš„æ“ä½œã€‚æ¯”å¦‚ï¼Œä¸Šé¢ä»£ç ä¸­ï¼Œé…ç½®å¯¹è±¡æœ‰ä¸€ä¸ªgetæ–¹æ³•ï¼Œç”¨æ¥æ‹¦æˆªå¯¹ç›®æ ‡å¯¹è±¡å±æ€§çš„è®¿é—®è¯·æ±‚ã€‚getæ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡å’Œæ‰€è¦è®¿é—®çš„å±æ€§ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç”±äºæ‹¦æˆªå‡½æ•°æ€»æ˜¯è¿”å›35ï¼Œæ‰€ä»¥è®¿é—®ä»»ä½•å±æ€§éƒ½å¾—åˆ°35ã€‚

æ³¨æ„ï¼Œè¦ä½¿å¾—Proxyèµ·ä½œç”¨ï¼Œå¿…é¡»é’ˆå¯¹Proxyå®ä¾‹ï¼ˆä¸Šä¾‹æ˜¯proxyå¯¹è±¡ï¼‰è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç›®æ ‡å¯¹è±¡ï¼ˆä¸Šä¾‹æ˜¯ç©ºå¯¹è±¡ï¼‰è¿›è¡Œæ“ä½œã€‚

å¦‚æœhandleræ²¡æœ‰è®¾ç½®ä»»ä½•æ‹¦æˆªï¼Œé‚£å°±ç­‰åŒäºç›´æ¥é€šå‘åŸå¯¹è±¡ã€‚

var target = {};
var handler = {};
var proxy = new Proxy(target, handler);
proxy.a = 'b';
target.a // "b"
ä¸Šé¢ä»£ç ä¸­ï¼Œhandleræ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œæ²¡æœ‰ä»»ä½•æ‹¦æˆªæ•ˆæœï¼Œè®¿é—®handlerå°±ç­‰åŒäºè®¿é—®targetã€‚

ä¸€ä¸ªæŠ€å·§æ˜¯å°† Proxy å¯¹è±¡ï¼Œè®¾ç½®åˆ°object.proxyå±æ€§ï¼Œä»è€Œå¯ä»¥åœ¨objectå¯¹è±¡ä¸Šè°ƒç”¨ã€‚

var object = { proxy: new Proxy(target, handler) };
Proxy å®ä¾‹ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–å¯¹è±¡çš„åŸå‹å¯¹è±¡ã€‚

var proxy = new Proxy({}, {
  get: function(target, property) {
    return 35;
  }
});

let obj = Object.create(proxy);
obj.time // 35
ä¸Šé¢ä»£ç ä¸­ï¼Œproxyå¯¹è±¡æ˜¯objå¯¹è±¡çš„åŸå‹ï¼Œobjå¯¹è±¡æœ¬èº«å¹¶æ²¡æœ‰timeå±æ€§ï¼Œæ‰€ä»¥æ ¹æ®åŸå‹é“¾ï¼Œä¼šåœ¨proxyå¯¹è±¡ä¸Šè¯»å–è¯¥å±æ€§ï¼Œå¯¼è‡´è¢«æ‹¦æˆªã€‚

åŒä¸€ä¸ªæ‹¦æˆªå™¨å‡½æ•°ï¼Œå¯ä»¥è®¾ç½®æ‹¦æˆªå¤šä¸ªæ“ä½œã€‚

var handler = {
  get: function(target, name) {
    if (name === 'prototype') {
      return Object.prototype;
    }
    return 'Hello, ' + name;
  },

  apply: function(target, thisBinding, args) {
    return args[0];
  },

  construct: function(target, args) {
    return {value: args[1]};
  }
};

var fproxy = new Proxy(function(x, y) {
  return x + y;
}, handler);

fproxy(1, 2) // 1
new fproxy(1,2) // {value: 2}
fproxy.prototype === Object.prototype // true
fproxy.foo // "Hello, foo"
ä¸‹é¢æ˜¯ Proxy æ”¯æŒçš„æ‹¦æˆªæ“ä½œä¸€è§ˆã€‚

å¯¹äºå¯ä»¥è®¾ç½®ã€ä½†æ²¡æœ‰è®¾ç½®æ‹¦æˆªçš„æ“ä½œï¼Œåˆ™ç›´æ¥è½åœ¨ç›®æ ‡å¯¹è±¡ä¸Šï¼ŒæŒ‰ç…§åŸå…ˆçš„æ–¹å¼äº§ç”Ÿç»“æœã€‚

ï¼ˆ1ï¼‰get(target, propKey, receiver)

æ‹¦æˆªå¯¹è±¡å±æ€§çš„è¯»å–ï¼Œæ¯”å¦‚proxy.fooå’Œproxy['foo']ã€‚

æœ€åä¸€ä¸ªå‚æ•°receiveræ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯é€‰ï¼Œå‚è§ä¸‹é¢Reflect.getçš„éƒ¨åˆ†ã€‚

ï¼ˆ2ï¼‰set(target, propKey, value, receiver)

æ‹¦æˆªå¯¹è±¡å±æ€§çš„è®¾ç½®ï¼Œæ¯”å¦‚proxy.foo = væˆ–proxy['foo'] = vï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ï¼ˆ3ï¼‰has(target, propKey)

æ‹¦æˆªpropKey in proxyçš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ï¼ˆ4ï¼‰deleteProperty(target, propKey)

æ‹¦æˆªdelete proxy[propKey]çš„æ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ï¼ˆ5ï¼‰ownKeys(target)

æ‹¦æˆªObject.getOwnPropertyNames(proxy)ã€Object.getOwnPropertySymbols(proxy)ã€Object.keys(proxy)ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ã€‚è¯¥æ–¹æ³•è¿”å›ç›®æ ‡å¯¹è±¡æ‰€æœ‰è‡ªèº«çš„å±æ€§çš„å±æ€§åï¼Œè€ŒObject.keys()çš„è¿”å›ç»“æœä»…åŒ…æ‹¬ç›®æ ‡å¯¹è±¡è‡ªèº«çš„å¯éå†å±æ€§ã€‚

ï¼ˆ6ï¼‰getOwnPropertyDescriptor(target, propKey)

æ‹¦æˆªObject.getOwnPropertyDescriptor(proxy, propKey)ï¼Œè¿”å›å±æ€§çš„æè¿°å¯¹è±¡ã€‚

ï¼ˆ7ï¼‰defineProperty(target, propKey, propDesc)

æ‹¦æˆªObject.defineProperty(proxy, propKey, propDescï¼‰ã€Object.defineProperties(proxy, propDescs)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ï¼ˆ8ï¼‰preventExtensions(target)

æ‹¦æˆªObject.preventExtensions(proxy)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ï¼ˆ9ï¼‰getPrototypeOf(target)

æ‹¦æˆªObject.getPrototypeOf(proxy)ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚

ï¼ˆ10ï¼‰isExtensible(target)

æ‹¦æˆªObject.isExtensible(proxy)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ï¼ˆ11ï¼‰setPrototypeOf(target, proto)

æ‹¦æˆªObject.setPrototypeOf(proxy, proto)ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸¤ç§é¢å¤–æ“ä½œå¯ä»¥æ‹¦æˆªã€‚

ï¼ˆ12ï¼‰apply(target, object, args)

æ‹¦æˆª Proxy å®ä¾‹ä½œä¸ºå‡½æ•°è°ƒç”¨çš„æ“ä½œï¼Œæ¯”å¦‚proxy(...args)ã€proxy.call(object, ...args)ã€proxy.apply(...)ã€‚

ï¼ˆ13ï¼‰construct(target, args)

æ‹¦æˆª Proxy å®ä¾‹ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨çš„æ“ä½œï¼Œæ¯”å¦‚new proxy(...args)ã€‚

Proxy å®ä¾‹çš„æ–¹æ³•
ä¸‹é¢æ˜¯ä¸Šé¢è¿™äº›æ‹¦æˆªæ–¹æ³•çš„è¯¦ç»†ä»‹ç»ã€‚

get()
getæ–¹æ³•ç”¨äºæ‹¦æˆªæŸä¸ªå±æ€§çš„è¯»å–æ“ä½œã€‚ä¸Šæ–‡å·²ç»æœ‰ä¸€ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯å¦ä¸€ä¸ªæ‹¦æˆªè¯»å–æ“ä½œçš„ä¾‹å­ã€‚

var person = {
  name: "å¼ ä¸‰"
};

var proxy = new Proxy(person, {
  get: function(target, property) {
    if (property in target) {
      return target[property];
    } else {
      throw new ReferenceError("Property \"" + property + "\" does not exist.");
    }
  }
});

proxy.name // "å¼ ä¸‰"
proxy.age // æŠ›å‡ºä¸€ä¸ªé”™è¯¯
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œå¦‚æœè®¿é—®ç›®æ ‡å¯¹è±¡ä¸å­˜åœ¨çš„å±æ€§ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ‹¦æˆªå‡½æ•°ï¼Œè®¿é—®ä¸å­˜åœ¨çš„å±æ€§ï¼Œåªä¼šè¿”å›undefinedã€‚

getæ–¹æ³•å¯ä»¥ç»§æ‰¿ã€‚

let proto = new Proxy({}, {
  get(target, propertyKey, receiver) {
    console.log('GET '+propertyKey);
    return target[propertyKey];
  }
});

let obj = Object.create(proto);
obj.xxx // "GET xxx"
ä¸Šé¢ä»£ç ä¸­ï¼Œæ‹¦æˆªæ“ä½œå®šä¹‰åœ¨Prototypeå¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥å¦‚æœè¯»å–objå¯¹è±¡ç»§æ‰¿çš„å±æ€§æ—¶ï¼Œæ‹¦æˆªä¼šç”Ÿæ•ˆã€‚

ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨getæ‹¦æˆªï¼Œå®ç°æ•°ç»„è¯»å–è´Ÿæ•°çš„ç´¢å¼•ã€‚

function createArray(...elements) {
  let handler = {
    get(target, propKey, receiver) {
      let index = Number(propKey);
      if (index < 0) {
        propKey = String(target.length + index);
      }
      return Reflect.get(target, propKey, receiver);
    }
  };

  let target = [];
  target.push(...elements);
  return new Proxy(target, handler);
}

let arr = createArray('a', 'b', 'c');
arr[-1] // c
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„çš„ä½ç½®å‚æ•°æ˜¯-1ï¼Œå°±ä¼šè¾“å‡ºæ•°ç»„çš„å€’æ•°æœ€åä¸€ä¸ªæˆå‘˜ã€‚

åˆ©ç”¨ Proxyï¼Œå¯ä»¥å°†è¯»å–å±æ€§çš„æ“ä½œï¼ˆgetï¼‰ï¼Œè½¬å˜ä¸ºæ‰§è¡ŒæŸä¸ªå‡½æ•°ï¼Œä»è€Œå®ç°å±æ€§çš„é“¾å¼æ“ä½œã€‚

var pipe = (function () {
  return function (value) {
    var funcStack = [];
    var oproxy = new Proxy({} , {
      get : function (pipeObject, fnName) {
        if (fnName === 'get') {
          return funcStack.reduce(function (val, fn) {
            return fn(val);
          },value);
        }
        funcStack.push(window[fnName]);
        return oproxy;
      }
    });

    return oproxy;
  }
}());

var double = n => n * 2;
var pow    = n => n * n;
var reverseInt = n => n.toString().split("").reverse().join("") | 0;

pipe(3).double.pow.reverseInt.get; // 63
ä¸Šé¢ä»£ç è®¾ç½® Proxy ä»¥åï¼Œè¾¾åˆ°äº†å°†å‡½æ•°åé“¾å¼ä½¿ç”¨çš„æ•ˆæœã€‚

ä¸‹é¢çš„ä¾‹å­åˆ™æ˜¯åˆ©ç”¨getæ‹¦æˆªï¼Œå®ç°ä¸€ä¸ªç”Ÿæˆå„ç§DOMèŠ‚ç‚¹çš„é€šç”¨å‡½æ•°domã€‚

const dom = new Proxy({}, {
  get(target, property) {
    return function(attrs = {}, ...children) {
      const el = document.createElement(property);
      for (let prop of Object.keys(attrs)) {
        el.setAttribute(prop, attrs[prop]);
      }
      for (let child of children) {
        if (typeof child === 'string') {
          child = document.createTextNode(child);
        }
        el.appendChild(child);
      }
      return el;
    }
  }
});

const el = dom.div({},
  'Hello, my name is ',
  dom.a({href: '//example.com'}, 'Mark'),
  '. I like:',
  dom.ul({},
    dom.li({}, 'The web'),
    dom.li({}, 'Food'),
    dom.li({}, 'â€¦actually that\'s it')
  )
);

document.body.appendChild(el);
å¦‚æœä¸€ä¸ªå±æ€§ä¸å¯é…ç½®ï¼ˆconfigurableï¼‰å’Œä¸å¯å†™ï¼ˆwritableï¼‰ï¼Œåˆ™è¯¥å±æ€§ä¸èƒ½è¢«ä»£ç†ï¼Œé€šè¿‡ Proxy å¯¹è±¡è®¿é—®è¯¥å±æ€§ä¼šæŠ¥é”™ã€‚

const target = Object.defineProperties({}, {
  foo: {
    value: 123,
    writable: false,
    configurable: false
  },
});

const handler = {
  get(target, propKey) {
    return 'abc';
  }
};

const proxy = new Proxy(target, handler);

proxy.foo
// TypeError: Invariant check failed
set()
setæ–¹æ³•ç”¨æ¥æ‹¦æˆªæŸä¸ªå±æ€§çš„èµ‹å€¼æ“ä½œã€‚

å‡å®šPersonå¯¹è±¡æœ‰ä¸€ä¸ªageå±æ€§ï¼Œè¯¥å±æ€§åº”è¯¥æ˜¯ä¸€ä¸ªä¸å¤§äº200çš„æ•´æ•°ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨Proxyä¿è¯ageçš„å±æ€§å€¼ç¬¦åˆè¦æ±‚ã€‚

let validator = {
  set: function(obj, prop, value) {
    if (prop === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError('The age is not an integer');
      }
      if (value > 200) {
        throw new RangeError('The age seems invalid');
      }
    }

    // å¯¹äºageä»¥å¤–çš„å±æ€§ï¼Œç›´æ¥ä¿å­˜
    obj[prop] = value;
  }
};

let person = new Proxy({}, validator);

person.age = 100;

person.age // 100
person.age = 'young' // æŠ¥é”™
person.age = 300 // æŠ¥é”™
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºè®¾ç½®äº†å­˜å€¼å‡½æ•°setï¼Œä»»ä½•ä¸ç¬¦åˆè¦æ±‚çš„ageå±æ€§èµ‹å€¼ï¼Œéƒ½ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¿™æ˜¯æ•°æ®éªŒè¯çš„ä¸€ç§å®ç°æ–¹æ³•ã€‚åˆ©ç”¨setæ–¹æ³•ï¼Œè¿˜å¯ä»¥æ•°æ®ç»‘å®šï¼Œå³æ¯å½“å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨æ›´æ–° DOMã€‚

æœ‰æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨å¯¹è±¡ä¸Šé¢è®¾ç½®å†…éƒ¨å±æ€§ï¼Œå±æ€§åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä½¿ç”¨ä¸‹åˆ’çº¿å¼€å¤´ï¼Œè¡¨ç¤ºè¿™äº›å±æ€§ä¸åº”è¯¥è¢«å¤–éƒ¨ä½¿ç”¨ã€‚ç»“åˆgetå’Œsetæ–¹æ³•ï¼Œå°±å¯ä»¥åšåˆ°é˜²æ­¢è¿™äº›å†…éƒ¨å±æ€§è¢«å¤–éƒ¨è¯»å†™ã€‚

var handler = {
  get (target, key) {
    invariant(key, 'get');
    return target[key];
  },
  set (target, key, value) {
    invariant(key, 'set');
    target[key] = value;
    return true;
  }
};
function invariant (key, action) {
  if (key[0] === '_') {
    throw new Error(`Invalid attempt to ${action} private "${key}" property`);
  }
}
var target = {};
var proxy = new Proxy(target, handler);
proxy._prop
// Error: Invalid attempt to get private "_prop" property
proxy._prop = 'c'
// Error: Invalid attempt to set private "_prop" property
ä¸Šé¢ä»£ç ä¸­ï¼Œåªè¦è¯»å†™çš„å±æ€§åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸‹åˆ’çº¿ï¼Œä¸€å¾‹æŠ›é”™ï¼Œä»è€Œè¾¾åˆ°ç¦æ­¢è¯»å†™å†…éƒ¨å±æ€§çš„ç›®çš„ã€‚

æ³¨æ„ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡è‡ªèº«çš„æŸä¸ªå±æ€§ï¼Œä¸å¯å†™ä¹Ÿä¸å¯é…ç½®ï¼Œé‚£ä¹ˆsetä¸å¾—æ”¹å˜è¿™ä¸ªå±æ€§çš„å€¼ï¼Œåªèƒ½è¿”å›åŒæ ·çš„å€¼ï¼Œå¦åˆ™æŠ¥é”™ã€‚

apply()
applyæ–¹æ³•æ‹¦æˆªå‡½æ•°çš„è°ƒç”¨ã€callå’Œapplyæ“ä½œã€‚

applyæ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€ç›®æ ‡å¯¹è±¡çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆthisï¼‰å’Œç›®æ ‡å¯¹è±¡çš„å‚æ•°æ•°ç»„ã€‚

var handler = {
  apply (target, ctx, args) {
    return Reflect.apply(...arguments);
  }
};
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var target = function () { return 'I am the target'; };
var handler = {
  apply: function () {
    return 'I am the proxy';
  }
};

var p = new Proxy(target, handler);

p()
// "I am the proxy"
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡pæ˜¯ Proxy çš„å®ä¾‹ï¼Œå½“å®ƒä½œä¸ºå‡½æ•°è°ƒç”¨æ—¶ï¼ˆp()ï¼‰ï¼Œå°±ä¼šè¢«applyæ–¹æ³•æ‹¦æˆªï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªä¾‹å­ã€‚

var twice = {
  apply (target, ctx, args) {
    return Reflect.apply(...arguments) * 2;
  }
};
function sum (left, right) {
  return left + right;
};
var proxy = new Proxy(sum, twice);
proxy(1, 2) // 6
proxy.call(null, 5, 6) // 22
proxy.apply(null, [7, 8]) // 30
ä¸Šé¢ä»£ç ä¸­ï¼Œæ¯å½“æ‰§è¡Œproxyå‡½æ•°ï¼ˆç›´æ¥è°ƒç”¨æˆ–callå’Œapplyè°ƒç”¨ï¼‰ï¼Œå°±ä¼šè¢«applyæ–¹æ³•æ‹¦æˆªã€‚

å¦å¤–ï¼Œç›´æ¥è°ƒç”¨Reflect.applyæ–¹æ³•ï¼Œä¹Ÿä¼šè¢«æ‹¦æˆªã€‚

Reflect.apply(proxy, null, [9, 10]) // 38
has()
hasæ–¹æ³•ç”¨æ¥æ‹¦æˆªHasPropertyæ“ä½œï¼Œå³åˆ¤æ–­å¯¹è±¡æ˜¯å¦å…·æœ‰æŸä¸ªå±æ€§æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç”Ÿæ•ˆã€‚å…¸å‹çš„æ“ä½œå°±æ˜¯inè¿ç®—ç¬¦ã€‚

ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨hasæ–¹æ³•éšè—æŸäº›å±æ€§ï¼Œä¸è¢«inè¿ç®—ç¬¦å‘ç°ã€‚

var handler = {
  has (target, key) {
    if (key[0] === '_') {
      return false;
    }
    return key in target;
  }
};
var target = { _prop: 'foo', prop: 'foo' };
var proxy = new Proxy(target, handler);
'_prop' in proxy // false
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœåŸå¯¹è±¡çš„å±æ€§åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸‹åˆ’çº¿ï¼Œproxy.haså°±ä¼šè¿”å›falseï¼Œä»è€Œä¸ä¼šè¢«inè¿ç®—ç¬¦å‘ç°ã€‚

å¦‚æœåŸå¯¹è±¡ä¸å¯é…ç½®æˆ–è€…ç¦æ­¢æ‰©å±•ï¼Œè¿™æ—¶hasæ‹¦æˆªä¼šæŠ¥é”™ã€‚

var obj = { a: 10 };
Object.preventExtensions(obj);

var p = new Proxy(obj, {
  has: function(target, prop) {
    return false;
  }
});

'a' in p // TypeError is thrown
ä¸Šé¢ä»£ç ä¸­ï¼Œobjå¯¹è±¡ç¦æ­¢æ‰©å±•ï¼Œç»“æœä½¿ç”¨hasæ‹¦æˆªå°±ä¼šæŠ¥é”™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæŸä¸ªå±æ€§ä¸å¯é…ç½®ï¼ˆæˆ–è€…ç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼‰ï¼Œåˆ™hasæ–¹æ³•å°±ä¸å¾—â€œéšè—â€ï¼ˆå³è¿”å›falseï¼‰ç›®æ ‡å¯¹è±¡çš„è¯¥å±æ€§ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œhasæ–¹æ³•æ‹¦æˆªçš„æ˜¯HasPropertyæ“ä½œï¼Œè€Œä¸æ˜¯HasOwnPropertyæ“ä½œï¼Œå³hasæ–¹æ³•ä¸åˆ¤æ–­ä¸€ä¸ªå±æ€§æ˜¯å¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œè¿˜æ˜¯ç»§æ‰¿çš„å±æ€§ã€‚

å¦å¤–ï¼Œè™½ç„¶for...inå¾ªç¯ä¹Ÿç”¨åˆ°äº†inè¿ç®—ç¬¦ï¼Œä½†æ˜¯hasæ‹¦æˆªå¯¹for...inå¾ªç¯ä¸ç”Ÿæ•ˆã€‚

let stu1 = {name: 'å¼ ä¸‰', score: 59};
let stu2 = {name: 'æå››', score: 99};

let handler = {
  has(target, prop) {
    if (prop === 'score' && target[prop] < 60) {
      console.log(`${target.name} ä¸åŠæ ¼`);
      return false;
    }
    return prop in target;
  }
}

let oproxy1 = new Proxy(stu1, handler);
let oproxy2 = new Proxy(stu2, handler);

'score' in oproxy1
// å¼ ä¸‰ ä¸åŠæ ¼
// false

'score' in oproxy2
// true

for (let a in oproxy1) {
  console.log(oproxy1[a]);
}
// å¼ ä¸‰
// 59

for (let b in oproxy2) {
  console.log(oproxy2[b]);
}
// æå››
// 99
ä¸Šé¢ä»£ç ä¸­ï¼Œhasæ‹¦æˆªåªå¯¹inå¾ªç¯ç”Ÿæ•ˆï¼Œå¯¹for...inå¾ªç¯ä¸ç”Ÿæ•ˆï¼Œå¯¼è‡´ä¸ç¬¦åˆè¦æ±‚çš„å±æ€§æ²¡æœ‰è¢«æ’é™¤åœ¨for...inå¾ªç¯ä¹‹å¤–ã€‚

construct()
constructæ–¹æ³•ç”¨äºæ‹¦æˆªnewå‘½ä»¤ï¼Œä¸‹é¢æ˜¯æ‹¦æˆªå¯¹è±¡çš„å†™æ³•ã€‚

var handler = {
  construct (target, args, newTarget) {
    return new target(...args);
  }
};
constructæ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ã€‚

target: ç›®æ ‡å¯¹è±¡
argsï¼šæ„å»ºå‡½æ•°çš„å‚æ•°å¯¹è±¡
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var p = new Proxy(function () {}, {
  construct: function(target, args) {
    console.log('called: ' + args.join(', '));
    return { value: args[0] * 10 };
  }
});

(new p(1)).value
// "called: 1"
// 10
constructæ–¹æ³•è¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

var p = new Proxy(function() {}, {
  construct: function(target, argumentsList) {
    return 1;
  }
});

new p() // æŠ¥é”™
deleteProperty()
deletePropertyæ–¹æ³•ç”¨äºæ‹¦æˆªdeleteæ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æŠ›å‡ºé”™è¯¯æˆ–è€…è¿”å›falseï¼Œå½“å‰å±æ€§å°±æ— æ³•è¢«deleteå‘½ä»¤åˆ é™¤ã€‚

var handler = {
  deleteProperty (target, key) {
    invariant(key, 'delete');
    return true;
  }
};
function invariant (key, action) {
  if (key[0] === '_') {
    throw new Error(`Invalid attempt to ${action} private "${key}" property`);
  }
}

var target = { _prop: 'foo' };
var proxy = new Proxy(target, handler);
delete proxy._prop
// Error: Invalid attempt to delete private "_prop" property
ä¸Šé¢ä»£ç ä¸­ï¼ŒdeletePropertyæ–¹æ³•æ‹¦æˆªäº†deleteæ“ä½œç¬¦ï¼Œåˆ é™¤ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºä¸‹åˆ’çº¿çš„å±æ€§ä¼šæŠ¥é”™ã€‚

æ³¨æ„ï¼Œç›®æ ‡å¯¹è±¡è‡ªèº«çš„ä¸å¯é…ç½®ï¼ˆconfigurableï¼‰çš„å±æ€§ï¼Œä¸èƒ½è¢«deletePropertyæ–¹æ³•åˆ é™¤ï¼Œå¦åˆ™æŠ¥é”™ã€‚

defineProperty()
definePropertyæ–¹æ³•æ‹¦æˆªäº†Object.definePropertyæ“ä½œã€‚

var handler = {
  defineProperty (target, key, descriptor) {
    return false;
  }
};
var target = {};
var proxy = new Proxy(target, handler);
proxy.foo = 'bar'
// TypeError: proxy defineProperty handler returned false for property '"foo"'
ä¸Šé¢ä»£ç ä¸­ï¼ŒdefinePropertyæ–¹æ³•è¿”å›falseï¼Œå¯¼è‡´æ·»åŠ æ–°å±æ€§ä¼šæŠ›å‡ºé”™è¯¯ã€‚

æ³¨æ„ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼ˆextensibleï¼‰ï¼Œåˆ™definePropertyä¸èƒ½å¢åŠ ç›®æ ‡å¯¹è±¡ä¸Šä¸å­˜åœ¨çš„å±æ€§ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡çš„æŸä¸ªå±æ€§ä¸å¯å†™ï¼ˆwritableï¼‰æˆ–ä¸å¯é…ç½®ï¼ˆconfigurableï¼‰ï¼Œåˆ™definePropertyæ–¹æ³•ä¸å¾—æ”¹å˜è¿™ä¸¤ä¸ªè®¾ç½®ã€‚

getOwnPropertyDescriptor()
getOwnPropertyDescriptoræ–¹æ³•æ‹¦æˆªObject.getOwnPropertyDescriptorï¼Œè¿”å›ä¸€ä¸ªå±æ€§æè¿°å¯¹è±¡æˆ–è€…undefinedã€‚

var handler = {
  getOwnPropertyDescriptor (target, key) {
    if (key[0] === '_') {
      return;
    }
    return Object.getOwnPropertyDescriptor(target, key);
  }
};
var target = { _foo: 'bar', baz: 'tar' };
var proxy = new Proxy(target, handler);
Object.getOwnPropertyDescriptor(proxy, 'wat')
// undefined
Object.getOwnPropertyDescriptor(proxy, '_foo')
// undefined
Object.getOwnPropertyDescriptor(proxy, 'baz')
// { value: 'tar', writable: true, enumerable: true, configurable: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œhandler.getOwnPropertyDescriptoræ–¹æ³•å¯¹äºç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºä¸‹åˆ’çº¿çš„å±æ€§åä¼šè¿”å›undefinedã€‚

getPrototypeOf()
getPrototypeOfæ–¹æ³•ä¸»è¦ç”¨æ¥æ‹¦æˆªObject.getPrototypeOf()è¿ç®—ç¬¦ï¼Œä»¥åŠå…¶ä»–ä¸€äº›æ“ä½œã€‚

Object.prototype.__proto__
Object.prototype.isPrototypeOf()
Object.getPrototypeOf()
Reflect.getPrototypeOf()
instanceofè¿ç®—ç¬¦
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var proto = {};
var p = new Proxy({}, {
  getPrototypeOf(target) {
    return proto;
  }
});
Object.getPrototypeOf(p) === proto // true
ä¸Šé¢ä»£ç ä¸­ï¼ŒgetPrototypeOfæ–¹æ³•æ‹¦æˆªObject.getPrototypeOf()ï¼Œè¿”å›protoå¯¹è±¡ã€‚

æ³¨æ„ï¼ŒgetPrototypeOfæ–¹æ³•çš„è¿”å›å€¼å¿…é¡»æ˜¯å¯¹è±¡æˆ–è€…nullï¼Œå¦åˆ™æŠ¥é”™ã€‚å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼ˆextensibleï¼‰ï¼Œ getPrototypeOfæ–¹æ³•å¿…é¡»è¿”å›ç›®æ ‡å¯¹è±¡çš„åŸå‹å¯¹è±¡ã€‚

isExtensible()
isExtensibleæ–¹æ³•æ‹¦æˆªObject.isExtensibleæ“ä½œã€‚

var p = new Proxy({}, {
  isExtensible: function(target) {
    console.log("called");
    return true;
  }
});

Object.isExtensible(p)
// "called"
// true
ä¸Šé¢ä»£ç è®¾ç½®äº†isExtensibleæ–¹æ³•ï¼Œåœ¨è°ƒç”¨Object.isExtensibleæ—¶ä¼šè¾“å‡ºcalledã€‚

æ³¨æ„ï¼Œè¯¥æ–¹æ³•åªèƒ½è¿”å›å¸ƒå°”å€¼ï¼Œå¦åˆ™è¿”å›å€¼ä¼šè¢«è‡ªåŠ¨è½¬ä¸ºå¸ƒå°”å€¼ã€‚

è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå¼ºé™åˆ¶ï¼Œå®ƒçš„è¿”å›å€¼å¿…é¡»ä¸ç›®æ ‡å¯¹è±¡çš„isExtensibleå±æ€§ä¿æŒä¸€è‡´ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚

Object.isExtensible(proxy) === Object.isExtensible(target)
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var p = new Proxy({}, {
  isExtensible: function(target) {
    return false;
  }
});

Object.isExtensible(p) // æŠ¥é”™
ownKeys()
ownKeysæ–¹æ³•ç”¨æ¥æ‹¦æˆªä»¥ä¸‹æ“ä½œã€‚

Object.getOwnPropertyNames()
Object.getOwnPropertySymbols()
Object.keys()
ä¸‹é¢æ˜¯æ‹¦æˆªObject.keys()çš„ä¾‹å­ã€‚

let target = {
  a: 1,
  b: 2,
  c: 3
};

let handler = {
  ownKeys(target) {
    return ['a'];
  }
};

let proxy = new Proxy(target, handler);

Object.keys(proxy)
// [ 'a' ]
ä¸Šé¢ä»£ç æ‹¦æˆªäº†å¯¹äºtargetå¯¹è±¡çš„Object.keys()æ“ä½œï¼Œåªè¿”å›aã€bã€cä¸‰ä¸ªå±æ€§ä¹‹ä¸­çš„aå±æ€§ã€‚

ä¸‹é¢çš„ä¾‹å­æ˜¯æ‹¦æˆªç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºä¸‹åˆ’çº¿çš„å±æ€§åã€‚

let target = {
  _bar: 'foo',
  _prop: 'bar',
  prop: 'baz'
};

let handler = {
  ownKeys (target) {
    return Reflect.ownKeys(target).filter(key => key[0] !== '_');
  }
};

let proxy = new Proxy(target, handler);
for (let key of Object.keys(proxy)) {
  console.log(target[key]);
}
// "baz"
æ³¨æ„ï¼Œä½¿ç”¨Object.keysæ–¹æ³•æ—¶ï¼Œæœ‰ä¸‰ç±»å±æ€§ä¼šè¢«ownKeysæ–¹æ³•è‡ªåŠ¨è¿‡æ»¤ï¼Œä¸ä¼šè¿”å›ã€‚

ç›®æ ‡å¯¹è±¡ä¸Šä¸å­˜åœ¨çš„å±æ€§
å±æ€§åä¸º Symbol å€¼
ä¸å¯éå†ï¼ˆenumerableï¼‰çš„å±æ€§
let target = {
  a: 1,
  b: 2,
  c: 3,
  [Symbol.for('secret')]: '4',
};

Object.defineProperty(target, 'key', {
  enumerable: false,
  configurable: true,
  writable: true,
  value: 'static'
});

let handler = {
  ownKeys(target) {
    return ['a', 'd', Symbol.for('secret'), 'key'];
  }
};

let proxy = new Proxy(target, handler);

Object.keys(proxy)
// ['a']
ä¸Šé¢ä»£ç ä¸­ï¼ŒownKeysæ–¹æ³•ä¹‹ä¸­ï¼Œæ˜¾å¼è¿”å›ä¸å­˜åœ¨çš„å±æ€§ï¼ˆdï¼‰ã€Symbol å€¼ï¼ˆSymbol.for('secret')ï¼‰ã€ä¸å¯éå†çš„å±æ€§ï¼ˆkeyï¼‰ï¼Œç»“æœéƒ½è¢«è‡ªåŠ¨è¿‡æ»¤æ‰ã€‚

ownKeysæ–¹æ³•è¿˜å¯ä»¥æ‹¦æˆªObject.getOwnPropertyNames()ã€‚

var p = new Proxy({}, {
  ownKeys: function(target) {
    return ['a', 'b', 'c'];
  }
});

Object.getOwnPropertyNames(p)
// [ 'a', 'b', 'c' ]
ownKeysæ–¹æ³•è¿”å›çš„æ•°ç»„æˆå‘˜ï¼Œåªèƒ½æ˜¯å­—ç¬¦ä¸²æˆ– Symbol å€¼ã€‚å¦‚æœæœ‰å…¶ä»–ç±»å‹çš„å€¼ï¼Œæˆ–è€…è¿”å›çš„æ ¹æœ¬ä¸æ˜¯æ•°ç»„ï¼Œå°±ä¼šæŠ¥é”™ã€‚

var obj = {};

var p = new Proxy(obj, {
  ownKeys: function(target) {
    return [123, true, undefined, null, {}, []];
  }
});

Object.getOwnPropertyNames(p)
// Uncaught TypeError: 123 is not a valid property name
ä¸Šé¢ä»£ç ä¸­ï¼ŒownKeysæ–¹æ³•è™½ç„¶è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªæ•°ç»„æˆå‘˜éƒ½ä¸æ˜¯å­—ç¬¦ä¸²æˆ– Symbol å€¼ï¼Œå› æ­¤å°±æŠ¥é”™äº†ã€‚

å¦‚æœç›®æ ‡å¯¹è±¡è‡ªèº«åŒ…å«ä¸å¯é…ç½®çš„å±æ€§ï¼Œåˆ™è¯¥å±æ€§å¿…é¡»è¢«ownKeysæ–¹æ³•è¿”å›ï¼Œå¦åˆ™æŠ¥é”™ã€‚

var obj = {};
Object.defineProperty(obj, 'a', {
  configurable: false,
  enumerable: true,
  value: 10 }
);

var p = new Proxy(obj, {
  ownKeys: function(target) {
    return ['b'];
  }
});

Object.getOwnPropertyNames(p)
// Uncaught TypeError: 'ownKeys' on proxy: trap result did not include 'a'
ä¸Šé¢ä»£ç ä¸­ï¼Œobjå¯¹è±¡çš„aå±æ€§æ˜¯ä¸å¯é…ç½®çš„ï¼Œè¿™æ—¶ownKeysæ–¹æ³•è¿”å›çš„æ•°ç»„ä¹‹ä¸­ï¼Œå¿…é¡»åŒ…å«aï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡æ˜¯ä¸å¯æ‰©å±•çš„ï¼ˆnon-extensitionï¼‰ï¼Œè¿™æ—¶ownKeysæ–¹æ³•è¿”å›çš„æ•°ç»„ä¹‹ä¸­ï¼Œå¿…é¡»åŒ…å«åŸå¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä¸”ä¸èƒ½åŒ…å«å¤šä½™çš„å±æ€§ï¼Œå¦åˆ™æŠ¥é”™ã€‚

var obj = {
  a: 1
};

Object.preventExtensions(obj);

var p = new Proxy(obj, {
  ownKeys: function(target) {
    return ['a', 'b'];
  }
});

Object.getOwnPropertyNames(p)
// Uncaught TypeError: 'ownKeys' on proxy: trap returned extra keys but proxy target is non-extensible
ä¸Šé¢ä»£ç ä¸­ï¼ŒObjå¯¹è±¡æ˜¯ä¸å¯æ‰©å±•çš„ï¼Œè¿™æ—¶ownKeysæ–¹æ³•è¿”å›çš„æ•°ç»„ä¹‹ä¸­ï¼ŒåŒ…å«äº†objå¯¹è±¡çš„å¤šä½™å±æ€§bï¼Œæ‰€ä»¥å¯¼è‡´äº†æŠ¥é”™ã€‚

preventExtensions()
preventExtensionsæ–¹æ³•æ‹¦æˆªObject.preventExtensions()ã€‚è¯¥æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦åˆ™ä¼šè¢«è‡ªåŠ¨è½¬ä¸ºå¸ƒå°”å€¼ã€‚

è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œåªæœ‰ç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•æ—¶ï¼ˆå³Object.isExtensible(proxy)ä¸ºfalseï¼‰ï¼Œproxy.preventExtensionsæ‰èƒ½è¿”å›trueï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

var p = new Proxy({}, {
  preventExtensions: function(target) {
    return true;
  }
});

Object.preventExtensions(p) // æŠ¥é”™
ä¸Šé¢ä»£ç ä¸­ï¼Œproxy.preventExtensionsæ–¹æ³•è¿”å›trueï¼Œä½†è¿™æ—¶Object.isExtensible(proxy)ä¼šè¿”å›trueï¼Œå› æ­¤æŠ¥é”™ã€‚

ä¸ºäº†é˜²æ­¢å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œé€šå¸¸è¦åœ¨proxy.preventExtensionsæ–¹æ³•é‡Œé¢ï¼Œè°ƒç”¨ä¸€æ¬¡Object.preventExtensionsã€‚

var p = new Proxy({}, {
  preventExtensions: function(target) {
    console.log('called');
    Object.preventExtensions(target);
    return true;
  }
});

Object.preventExtensions(p)
// "called"
// true
setPrototypeOf()
setPrototypeOfæ–¹æ³•ä¸»è¦ç”¨æ¥æ‹¦æˆªObject.setPrototypeOfæ–¹æ³•ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var handler = {
  setPrototypeOf (target, proto) {
    throw new Error('Changing the prototype is forbidden');
  }
};
var proto = {};
var target = function () {};
var proxy = new Proxy(target, handler);
proxy.setPrototypeOf(proxy, proto);
// Error: Changing the prototype is forbidden
ä¸Šé¢ä»£ç ä¸­ï¼Œåªè¦ä¿®æ”¹targetçš„åŸå‹å¯¹è±¡ï¼Œå°±ä¼šæŠ¥é”™ã€‚

æ³¨æ„ï¼Œè¯¥æ–¹æ³•åªèƒ½è¿”å›å¸ƒå°”å€¼ï¼Œå¦åˆ™ä¼šè¢«è‡ªåŠ¨è½¬ä¸ºå¸ƒå°”å€¼ã€‚å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼ˆextensibleï¼‰ï¼ŒsetPrototypeOfæ–¹æ³•ä¸å¾—æ”¹å˜ç›®æ ‡å¯¹è±¡çš„åŸå‹ã€‚

Proxy.revocable()
Proxy.revocableæ–¹æ³•è¿”å›ä¸€ä¸ªå¯å–æ¶ˆçš„ Proxy å®ä¾‹ã€‚

let target = {};
let handler = {};

let {proxy, revoke} = Proxy.revocable(target, handler);

proxy.foo = 123;
proxy.foo // 123

revoke();
proxy.foo // TypeError: Revoked
Proxy.revocableæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„proxyå±æ€§æ˜¯Proxyå®ä¾‹ï¼Œrevokeå±æ€§æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å–æ¶ˆProxyå®ä¾‹ã€‚ä¸Šé¢ä»£ç ä¸­ï¼Œå½“æ‰§è¡Œrevokeå‡½æ•°ä¹‹åï¼Œå†è®¿é—®Proxyå®ä¾‹ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

Proxy.revocableçš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯ï¼Œç›®æ ‡å¯¹è±¡ä¸å…è®¸ç›´æ¥è®¿é—®ï¼Œå¿…é¡»é€šè¿‡ä»£ç†è®¿é—®ï¼Œä¸€æ—¦è®¿é—®ç»“æŸï¼Œå°±æ”¶å›ä»£ç†æƒï¼Œä¸å…è®¸å†æ¬¡è®¿é—®ã€‚

this é—®é¢˜
è™½ç„¶ Proxy å¯ä»¥ä»£ç†é’ˆå¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œä½†å®ƒä¸æ˜¯ç›®æ ‡å¯¹è±¡çš„é€æ˜ä»£ç†ï¼Œå³ä¸åšä»»ä½•æ‹¦æˆªçš„æƒ…å†µä¸‹ï¼Œä¹Ÿæ— æ³•ä¿è¯ä¸ç›®æ ‡å¯¹è±¡çš„è¡Œä¸ºä¸€è‡´ã€‚ä¸»è¦åŸå› å°±æ˜¯åœ¨ Proxy ä»£ç†çš„æƒ…å†µä¸‹ï¼Œç›®æ ‡å¯¹è±¡å†…éƒ¨çš„thiså…³é”®å­—ä¼šæŒ‡å‘ Proxy ä»£ç†ã€‚

const target = {
  m: function () {
    console.log(this === proxy);
  }
};
const handler = {};

const proxy = new Proxy(target, handler);

target.m() // false
proxy.m()  // true
ä¸Šé¢ä»£ç ä¸­ï¼Œä¸€æ—¦proxyä»£ç†target.mï¼Œåè€…å†…éƒ¨çš„thiså°±æ˜¯æŒ‡å‘proxyï¼Œè€Œä¸æ˜¯targetã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œç”±äºthisæŒ‡å‘çš„å˜åŒ–ï¼Œå¯¼è‡´ Proxy æ— æ³•ä»£ç†ç›®æ ‡å¯¹è±¡ã€‚

const _name = new WeakMap();

class Person {
  constructor(name) {
    _name.set(this, name);
  }
  get name() {
    return _name.get(this);
  }
}

const jane = new Person('Jane');
jane.name // 'Jane'

const proxy = new Proxy(jane, {});
proxy.name // undefined
ä¸Šé¢ä»£ç ä¸­ï¼Œç›®æ ‡å¯¹è±¡janeçš„nameå±æ€§ï¼Œå®é™…ä¿å­˜åœ¨å¤–éƒ¨WeakMapå¯¹è±¡_nameä¸Šé¢ï¼Œé€šè¿‡thisé”®åŒºåˆ†ã€‚ç”±äºé€šè¿‡proxy.nameè®¿é—®æ—¶ï¼ŒthisæŒ‡å‘proxyï¼Œå¯¼è‡´æ— æ³•å–åˆ°å€¼ï¼Œæ‰€ä»¥è¿”å›undefinedã€‚

æ­¤å¤–ï¼Œæœ‰äº›åŸç”Ÿå¯¹è±¡çš„å†…éƒ¨å±æ€§ï¼Œåªæœ‰é€šè¿‡æ­£ç¡®çš„thisæ‰èƒ½æ‹¿åˆ°ï¼Œæ‰€ä»¥ Proxy ä¹Ÿæ— æ³•ä»£ç†è¿™äº›åŸç”Ÿå¯¹è±¡çš„å±æ€§ã€‚

const target = new Date();
const handler = {};
const proxy = new Proxy(target, handler);

proxy.getDate();
// TypeError: this is not a Date object.
ä¸Šé¢ä»£ç ä¸­ï¼ŒgetDateæ–¹æ³•åªèƒ½åœ¨Dateå¯¹è±¡å®ä¾‹ä¸Šé¢æ‹¿åˆ°ï¼Œå¦‚æœthisä¸æ˜¯Dateå¯¹è±¡å®ä¾‹å°±ä¼šæŠ¥é”™ã€‚è¿™æ—¶ï¼Œthisç»‘å®šåŸå§‹å¯¹è±¡ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

const target = new Date('2015-01-01');
const handler = {
  get(target, prop) {
    if (prop === 'getDate') {
      return target.getDate.bind(target);
    }
    return Reflect.get(target, prop);
  }
};
const proxy = new Proxy(target, handler);

proxy.getDate() // 1
å®ä¾‹ï¼šWeb æœåŠ¡çš„å®¢æˆ·ç«¯
Proxy å¯¹è±¡å¯ä»¥æ‹¦æˆªç›®æ ‡å¯¹è±¡çš„ä»»æ„å±æ€§ï¼Œè¿™ä½¿å¾—å®ƒå¾ˆåˆé€‚ç”¨æ¥å†™ Web æœåŠ¡çš„å®¢æˆ·ç«¯ã€‚

const service = createWebService('http://example.com/data');

service.employees().then(json => {
  const employees = JSON.parse(json);
  // Â·Â·Â·
});
ä¸Šé¢ä»£ç æ–°å»ºäº†ä¸€ä¸ª Web æœåŠ¡çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£è¿”å›å„ç§æ•°æ®ã€‚Proxy å¯ä»¥æ‹¦æˆªè¿™ä¸ªå¯¹è±¡çš„ä»»æ„å±æ€§ï¼Œæ‰€ä»¥ä¸ç”¨ä¸ºæ¯ä¸€ç§æ•°æ®å†™ä¸€ä¸ªé€‚é…æ–¹æ³•ï¼Œåªè¦å†™ä¸€ä¸ª Proxy æ‹¦æˆªå°±å¯ä»¥äº†ã€‚

function createWebService(baseUrl) {
  return new Proxy({}, {
    get(target, propKey, receiver) {
      return () => httpGet(baseUrl+'/' + propKey);
    }
  });
}
åŒç†ï¼ŒProxy ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°æ•°æ®åº“çš„ ORM å±‚ã€‚

##Reflect
1.æ¦‚è¿°
Reflectå¯¹è±¡ä¸Proxyå¯¹è±¡ä¸€æ ·ï¼Œä¹Ÿæ˜¯ ES6 ä¸ºäº†æ“ä½œå¯¹è±¡è€Œæä¾›çš„æ–° APIã€‚Reflectå¯¹è±¡çš„è®¾è®¡ç›®çš„æœ‰è¿™æ ·å‡ ä¸ªã€‚

ï¼ˆ1ï¼‰ å°†Objectå¯¹è±¡çš„ä¸€äº›æ˜æ˜¾å±äºè¯­è¨€å†…éƒ¨çš„æ–¹æ³•ï¼ˆæ¯”å¦‚Object.definePropertyï¼‰ï¼Œæ”¾åˆ°Reflectå¯¹è±¡ä¸Šã€‚ç°é˜¶æ®µï¼ŒæŸäº›æ–¹æ³•åŒæ—¶åœ¨Objectå’ŒReflectå¯¹è±¡ä¸Šéƒ¨ç½²ï¼Œæœªæ¥çš„æ–°æ–¹æ³•å°†åªéƒ¨ç½²åœ¨Reflectå¯¹è±¡ä¸Šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»Reflectå¯¹è±¡ä¸Šå¯ä»¥æ‹¿åˆ°è¯­è¨€å†…éƒ¨çš„æ–¹æ³•ã€‚

ï¼ˆ2ï¼‰ ä¿®æ”¹æŸäº›Objectæ–¹æ³•çš„è¿”å›ç»“æœï¼Œè®©å…¶å˜å¾—æ›´åˆç†ã€‚æ¯”å¦‚ï¼ŒObject.defineProperty(obj, name, desc)åœ¨æ— æ³•å®šä¹‰å±æ€§æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè€ŒReflect.defineProperty(obj, name, desc)åˆ™ä¼šè¿”å›falseã€‚

// è€å†™æ³•
try {
  Object.defineProperty(target, property, attributes);
  // success
} catch (e) {
  // failure
}

// æ–°å†™æ³•
if (Reflect.defineProperty(target, property, attributes)) {
  // success
} else {
  // failure
}
ï¼ˆ3ï¼‰ è®©Objectæ“ä½œéƒ½å˜æˆå‡½æ•°è¡Œä¸ºã€‚æŸäº›Objectæ“ä½œæ˜¯å‘½ä»¤å¼ï¼Œæ¯”å¦‚name in objå’Œdelete obj[name]ï¼Œè€ŒReflect.has(obj, name)å’ŒReflect.deleteProperty(obj, name)è®©å®ƒä»¬å˜æˆäº†å‡½æ•°è¡Œä¸ºã€‚

// è€å†™æ³•
'assign' in Object // true

// æ–°å†™æ³•
Reflect.has(Object, 'assign') // true
ï¼ˆ4ï¼‰Reflectå¯¹è±¡çš„æ–¹æ³•ä¸Proxyå¯¹è±¡çš„æ–¹æ³•ä¸€ä¸€å¯¹åº”ï¼Œåªè¦æ˜¯Proxyå¯¹è±¡çš„æ–¹æ³•ï¼Œå°±èƒ½åœ¨Reflectå¯¹è±¡ä¸Šæ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚è¿™å°±è®©Proxyå¯¹è±¡å¯ä»¥æ–¹ä¾¿åœ°è°ƒç”¨å¯¹åº”çš„Reflectæ–¹æ³•ï¼Œå®Œæˆé»˜è®¤è¡Œä¸ºï¼Œä½œä¸ºä¿®æ”¹è¡Œä¸ºçš„åŸºç¡€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡Proxyæ€ä¹ˆä¿®æ”¹é»˜è®¤è¡Œä¸ºï¼Œä½ æ€»å¯ä»¥åœ¨Reflectä¸Šè·å–é»˜è®¤è¡Œä¸ºã€‚

Proxy(target, {
  set: function(target, name, value, receiver) {
    var success = Reflect.set(target,name, value, receiver);
    if (success) {
      log('property ' + name + ' on ' + target + ' set to ' + value);
    }
    return success;
  }
});
ä¸Šé¢ä»£ç ä¸­ï¼ŒProxyæ–¹æ³•æ‹¦æˆªtargetå¯¹è±¡çš„å±æ€§èµ‹å€¼è¡Œä¸ºã€‚å®ƒé‡‡ç”¨Reflect.setæ–¹æ³•å°†å€¼èµ‹å€¼ç»™å¯¹è±¡çš„å±æ€§ï¼Œç¡®ä¿å®ŒæˆåŸæœ‰çš„è¡Œä¸ºï¼Œç„¶åå†éƒ¨ç½²é¢å¤–çš„åŠŸèƒ½ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

var loggedObj = new Proxy(obj, {
  get(target, name) {
    console.log('get', target, name);
    return Reflect.get(target, name);
  },
  deleteProperty(target, name) {
    console.log('delete' + name);
    return Reflect.deleteProperty(target, name);
  },
  has(target, name) {
    console.log('has' + name);
    return Reflect.has(target, name);
  }
});
ä¸Šé¢ä»£ç ä¸­ï¼Œæ¯ä¸€ä¸ªProxyå¯¹è±¡çš„æ‹¦æˆªæ“ä½œï¼ˆgetã€deleteã€hasï¼‰ï¼Œå†…éƒ¨éƒ½è°ƒç”¨å¯¹åº”çš„Reflectæ–¹æ³•ï¼Œä¿è¯åŸç”Ÿè¡Œä¸ºèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œã€‚æ·»åŠ çš„å·¥ä½œï¼Œå°±æ˜¯å°†æ¯ä¸€ä¸ªæ“ä½œè¾“å‡ºä¸€è¡Œæ—¥å¿—ã€‚

æœ‰äº†Reflectå¯¹è±¡ä»¥åï¼Œå¾ˆå¤šæ“ä½œä¼šæ›´æ˜“è¯»ã€‚

// è€å†™æ³•
Function.prototype.apply.call(Math.floor, undefined, [1.75]) // 1

// æ–°å†™æ³•
Reflect.apply(Math.floor, undefined, [1.75]) // 1
é™æ€æ–¹æ³•
Reflectå¯¹è±¡ä¸€å…±æœ‰13ä¸ªé™æ€æ–¹æ³•ã€‚

Reflect.apply(target,thisArg,args)
Reflect.construct(target,args)
Reflect.get(target,name,receiver)
Reflect.set(target,name,value,receiver)
Reflect.defineProperty(target,name,desc)
Reflect.deleteProperty(target,name)
Reflect.has(target,name)
Reflect.ownKeys(target)
Reflect.isExtensible(target)
Reflect.preventExtensions(target)
Reflect.getOwnPropertyDescriptor(target, name)
Reflect.getPrototypeOf(target)
Reflect.setPrototypeOf(target, prototype)
ä¸Šé¢è¿™äº›æ–¹æ³•çš„ä½œç”¨ï¼Œå¤§éƒ¨åˆ†ä¸Objectå¯¹è±¡çš„åŒåæ–¹æ³•çš„ä½œç”¨éƒ½æ˜¯ç›¸åŒçš„ï¼Œè€Œä¸”å®ƒä¸Proxyå¯¹è±¡çš„æ–¹æ³•æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä¸‹é¢æ˜¯å¯¹å®ƒä»¬çš„è§£é‡Šã€‚

Reflect.get(target, name, receiver)
Reflect.getæ–¹æ³•æŸ¥æ‰¾å¹¶è¿”å›targetå¯¹è±¡çš„nameå±æ€§ï¼Œå¦‚æœæ²¡æœ‰è¯¥å±æ€§ï¼Œåˆ™è¿”å›undefinedã€‚

var myObject = {
  foo: 1,
  bar: 2,
  get baz() {
    return this.foo + this.bar;
  },
}

Reflect.get(myObject, 'foo') // 1
Reflect.get(myObject, 'bar') // 2
Reflect.get(myObject, 'baz') // 3
å¦‚æœnameå±æ€§éƒ¨ç½²äº†è¯»å–å‡½æ•°ï¼ˆgetterï¼‰ï¼Œåˆ™è¯»å–å‡½æ•°çš„thisç»‘å®šreceiverã€‚

var myObject = {
  foo: 1,
  bar: 2,
  get baz() {
    return this.foo + this.bar;
  },
};

var myReceiverObject = {
  foo: 4,
  bar: 4,
};

Reflect.get(myObject, 'baz', myReceiverObject) // 8
å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒReflect.getæ–¹æ³•ä¼šæŠ¥é”™ã€‚

Reflect.get(1, 'foo') // æŠ¥é”™
Reflect.get(false, 'foo') // æŠ¥é”™
Reflect.set(target, name, value, receiver)
Reflect.setæ–¹æ³•è®¾ç½®targetå¯¹è±¡çš„nameå±æ€§ç­‰äºvalueã€‚

var myObject = {
  foo: 1,
  set bar(value) {
    return this.foo = value;
  },
}

myObject.foo // 1

Reflect.set(myObject, 'foo', 2);
myObject.foo // 2

Reflect.set(myObject, 'bar', 3)
myObject.foo // 3
å¦‚æœnameå±æ€§è®¾ç½®äº†èµ‹å€¼å‡½æ•°ï¼Œåˆ™èµ‹å€¼å‡½æ•°çš„thisç»‘å®šreceiverã€‚

var myObject = {
  foo: 4,
  set bar(value) {
    return this.foo = value;
  },
};

var myReceiverObject = {
  foo: 0,
};

Reflect.set(myObject, 'bar', 1, myReceiverObject);
myObject.foo // 4
myReceiverObject.foo // 1
å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒReflect.setä¼šæŠ¥é”™ã€‚

Reflect.set(1, 'foo', {}) // æŠ¥é”™
Reflect.set(false, 'foo', {}) // æŠ¥é”™
Reflect.has(obj, name)
Reflect.hasæ–¹æ³•å¯¹åº”name in objé‡Œé¢çš„inè¿ç®—ç¬¦ã€‚

var myObject = {
  foo: 1,
};

// æ—§å†™æ³•
'foo' in myObject // true

// æ–°å†™æ³•
Reflect.has(myObject, 'foo') // true
å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒReflect.haså’Œinè¿ç®—ç¬¦éƒ½ä¼šæŠ¥é”™ã€‚

Reflect.deleteProperty(obj, name)
Reflect.deletePropertyæ–¹æ³•ç­‰åŒäºdelete obj[name]ï¼Œç”¨äºåˆ é™¤å¯¹è±¡çš„å±æ€§ã€‚

const myObj = { foo: 'bar' };

// æ—§å†™æ³•
delete myObj.foo;

// æ–°å†™æ³•
Reflect.deleteProperty(myObj, 'foo');
è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚å¦‚æœåˆ é™¤æˆåŠŸï¼Œæˆ–è€…è¢«åˆ é™¤çš„å±æ€§ä¸å­˜åœ¨ï¼Œè¿”å›trueï¼›åˆ é™¤å¤±è´¥ï¼Œè¢«åˆ é™¤çš„å±æ€§ä¾ç„¶å­˜åœ¨ï¼Œè¿”å›falseã€‚

Reflect.construct(target, args)
Reflect.constructæ–¹æ³•ç­‰åŒäºnew target(...args)ï¼Œè¿™æä¾›äº†ä¸€ç§ä¸ä½¿ç”¨newï¼Œæ¥è°ƒç”¨æ„é€ å‡½æ•°çš„æ–¹æ³•ã€‚

function Greeting(name) {
  this.name = name;
}

// new çš„å†™æ³•
const instance = new Greeting('å¼ ä¸‰');

// Reflect.construct çš„å†™æ³•
const instance = Reflect.construct(Greeting, 'å¼ ä¸‰');
Reflect.getPrototypeOf(obj)
Reflect.getPrototypeOfæ–¹æ³•ç”¨äºè¯»å–å¯¹è±¡çš„__proto__å±æ€§ï¼Œå¯¹åº”Object.getPrototypeOf(obj)ã€‚

const myObj = new FancyThing();

// æ—§å†™æ³•
Object.getPrototypeOf(myObj) === FancyThing.prototype;

// æ–°å†™æ³•
Reflect.getPrototypeOf(myObj) === FancyThing.prototype;
Reflect.getPrototypeOfå’ŒObject.getPrototypeOfçš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ˆåŒ…æ‹¬nullå’Œundefinedï¼‰ï¼ŒObject.getPrototypeOfä¼šå°†è¿™ä¸ªå‚æ•°è½¬ä¸ºå¯¹è±¡ï¼Œç„¶åå†è¿è¡Œï¼Œè€ŒReflect.getPrototypeOfä¼šæŠ¥é”™ã€‚

Object.getPrototypeOf(1) // undefined
Reflect.getPrototypeOf(1) // æŠ¥é”™
Reflect.setPrototypeOf(obj, newProto)
Reflect.setPrototypeOfæ–¹æ³•ç”¨äºè®¾ç½®å¯¹è±¡çš„__proto__å±æ€§ï¼Œå¯¹åº”Object.setPrototypeOf(obj, newProto)ã€‚

const myObj = new FancyThing();

// æ—§å†™æ³•
Object.setPrototypeOf(myObj, OtherThing.prototype);

// æ–°å†™æ³•
Reflect.setPrototypeOf(myObj, OtherThing.prototype);
å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒReflect.setPrototypeOfå’ŒObject.setPrototypeOféƒ½ä¼šæŠ¥é”™ã€‚

Object.setPrototypeOf(1) // æŠ¥é”™
Reflect.setPrototypeOf(1) // æŠ¥é”™
Reflect.apply(func, thisArg, args)
Reflect.applyæ–¹æ³•ç­‰åŒäºFunction.prototype.apply.call(func, thisArg, args)ï¼Œç”¨äºç»‘å®šthiså¯¹è±¡åæ‰§è¡Œç»™å®šå‡½æ•°ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœè¦ç»‘å®šä¸€ä¸ªå‡½æ•°çš„thiså¯¹è±¡ï¼Œå¯ä»¥è¿™æ ·å†™fn.apply(obj, args)ï¼Œä½†æ˜¯å¦‚æœå‡½æ•°å®šä¹‰äº†è‡ªå·±çš„applyæ–¹æ³•ï¼Œå°±åªèƒ½å†™æˆFunction.prototype.apply.call(fn, obj, args)ï¼Œé‡‡ç”¨Reflectå¯¹è±¡å¯ä»¥ç®€åŒ–è¿™ç§æ“ä½œã€‚

const ages = [11, 33, 12, 54, 18, 96];

// æ—§å†™æ³•
const youngest = Math.min.apply(Math, ages);
const oldest = Math.max.apply(Math, ages);
const type = Object.prototype.toString.call(youngest);

// æ–°å†™æ³•
const youngest = Reflect.apply(Math.min, Math, ages);
const oldest = Reflect.apply(Math.max, Math, ages);
const type = Reflect.apply(Object.prototype.toString, youngest);
Reflect.defineProperty(target, propertyKey, attributes)
Reflect.definePropertyæ–¹æ³•åŸºæœ¬ç­‰åŒäºObject.definePropertyï¼Œç”¨æ¥ä¸ºå¯¹è±¡å®šä¹‰å±æ€§ã€‚æœªæ¥ï¼Œåè€…ä¼šè¢«é€æ¸åºŸé™¤ï¼Œè¯·ä»ç°åœ¨å¼€å§‹å°±ä½¿ç”¨Reflect.definePropertyä»£æ›¿å®ƒã€‚

function MyDate() {
  /*â€¦*/
}

// æ—§å†™æ³•
Object.defineProperty(MyDate, 'now', {
  value: () => new Date.now()
});

// æ–°å†™æ³•
Reflect.defineProperty(MyDate, 'now', {
  value: () => new Date.now()
});
å¦‚æœReflect.definePropertyçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼Œå°±ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ¯”å¦‚Reflect.defineProperty(1, 'foo')ã€‚

Reflect.getOwnPropertyDescriptor(target, propertyKey)
Reflect.getOwnPropertyDescriptoråŸºæœ¬ç­‰åŒäºObject.getOwnPropertyDescriptorï¼Œç”¨äºå¾—åˆ°æŒ‡å®šå±æ€§çš„æè¿°å¯¹è±¡ï¼Œå°†æ¥ä¼šæ›¿ä»£æ‰åè€…ã€‚

var myObject = {};
Object.defineProperty(myObject, 'hidden', {
  value: true,
  enumerable: false,
});

// æ—§å†™æ³•
var theDescriptor = Object.getOwnPropertyDescriptor(myObject, 'hidden');

// æ–°å†™æ³•
var theDescriptor = Reflect.getOwnPropertyDescriptor(myObject, 'hidden');
Reflect.getOwnPropertyDescriptorå’ŒObject.getOwnPropertyDescriptorçš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒObject.getOwnPropertyDescriptor(1, 'foo')ä¸æŠ¥é”™ï¼Œè¿”å›undefinedï¼Œè€ŒReflect.getOwnPropertyDescriptor(1, 'foo')ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè¡¨ç¤ºå‚æ•°éæ³•ã€‚

Reflect.isExtensible (target)
Reflect.isExtensibleæ–¹æ³•å¯¹åº”Object.isExtensibleï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå½“å‰å¯¹è±¡æ˜¯å¦å¯æ‰©å±•ã€‚

const myObject = {};

// æ—§å†™æ³•
Object.isExtensible(myObject) // true

// æ–°å†™æ³•
Reflect.isExtensible(myObject) // true
å¦‚æœå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒObject.isExtensibleä¼šè¿”å›falseï¼Œå› ä¸ºéå¯¹è±¡æœ¬æ¥å°±æ˜¯ä¸å¯æ‰©å±•çš„ï¼Œè€ŒReflect.isExtensibleä¼šæŠ¥é”™ã€‚

Object.isExtensible(1) // false
Reflect.isExtensible(1) // æŠ¥é”™
Reflect.preventExtensions(target)
Reflect.preventExtensionså¯¹åº”Object.preventExtensionsæ–¹æ³•ï¼Œç”¨äºè®©ä¸€ä¸ªå¯¹è±¡å˜ä¸ºä¸å¯æ‰©å±•ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æ“ä½œæˆåŠŸã€‚

var myObject = {};

// æ—§å†™æ³•
Object.isExtensible(myObject) // true

// æ–°å†™æ³•
Reflect.preventExtensions(myObject) // true
å¦‚æœå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼ŒObject.isExtensibleåœ¨ ES5 ç¯å¢ƒæŠ¥é”™ï¼Œåœ¨ ES6 ç¯å¢ƒè¿”å›è¿™ä¸ªå‚æ•°ï¼Œè€ŒReflect.preventExtensionsä¼šæŠ¥é”™ã€‚

// ES5
Object.preventExtensions(1) // æŠ¥é”™

// ES6
Object.preventExtensions(1) // 1

// æ–°å†™æ³•
Reflect.preventExtensions(1) // æŠ¥é”™
Reflect.ownKeys (target)
Reflect.ownKeysæ–¹æ³•ç”¨äºè¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼ŒåŸºæœ¬ç­‰åŒäºObject.getOwnPropertyNamesä¸Object.getOwnPropertySymbolsä¹‹å’Œã€‚

var myObject = {
  foo: 1,
  bar: 2,
  [Symbol.for('baz')]: 3,
  [Symbol.for('bing')]: 4,
};

// æ—§å†™æ³•
Object.getOwnPropertyNames(myObject)
// ['foo', 'bar']

Object.getOwnPropertySymbols(myObject)
//[Symbol.for('baz'), Symbol.for('bing')]

// æ–°å†™æ³•
Reflect.ownKeys(myObject)
// ['foo', 'bar', Symbol.for('baz'), Symbol.for('bing')]
å®ä¾‹ï¼šä½¿ç”¨ Proxy å®ç°è§‚å¯Ÿè€…æ¨¡å¼
è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver modeï¼‰æŒ‡çš„æ˜¯å‡½æ•°è‡ªåŠ¨è§‚å¯Ÿæ•°æ®å¯¹è±¡ï¼Œä¸€æ—¦å¯¹è±¡æœ‰å˜åŒ–ï¼Œå‡½æ•°å°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚

const person = observable({
  name: 'å¼ ä¸‰',
  age: 20
});

function print() {
  console.log(`${person.name}, ${person.age}`)
}

observe(print);
person.name = 'æå››';
// è¾“å‡º
// æå››, 20
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°æ®å¯¹è±¡personæ˜¯è§‚å¯Ÿç›®æ ‡ï¼Œå‡½æ•°printæ˜¯è§‚å¯Ÿè€…ã€‚ä¸€æ—¦æ•°æ®å¯¹è±¡å‘ç”Ÿå˜åŒ–ï¼Œprintå°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚

ä¸‹é¢ï¼Œä½¿ç”¨ Proxy å†™ä¸€ä¸ªè§‚å¯Ÿè€…æ¨¡å¼çš„æœ€ç®€å•å®ç°ï¼Œå³å®ç°observableå’Œobserveè¿™ä¸¤ä¸ªå‡½æ•°ã€‚æ€è·¯æ˜¯observableå‡½æ•°è¿”å›ä¸€ä¸ªåŸå§‹å¯¹è±¡çš„ Proxy ä»£ç†ï¼Œæ‹¦æˆªèµ‹å€¼æ“ä½œï¼Œè§¦å‘å……å½“è§‚å¯Ÿè€…çš„å„ä¸ªå‡½æ•°ã€‚

const queuedObservers = new Set();

const observe = fn => queuedObservers.add(fn);
const observable = obj => new Proxy(obj, {set});

function set(target, key, value, receiver) {
  const result = Reflect.set(target, key, value, receiver);
  queuedObservers.forEach(observer => observer());
  return result;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå…ˆå®šä¹‰äº†ä¸€ä¸ªSeté›†åˆï¼Œæ‰€æœ‰è§‚å¯Ÿè€…å‡½æ•°éƒ½æ”¾è¿›è¿™ä¸ªé›†åˆã€‚ç„¶åï¼Œobservableå‡½æ•°è¿”å›åŸå§‹å¯¹è±¡çš„ä»£ç†ï¼Œæ‹¦æˆªèµ‹å€¼æ“ä½œã€‚æ‹¦æˆªå‡½æ•°setä¹‹ä¸­ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰è§‚å¯Ÿè€…ã€‚

##Iteratorå’Œfor...ofå¾ªç¯
1.Iteratorï¼ˆéå†å™¨ï¼‰çš„æ¦‚å¿µ
JavaScriptåŸæœ‰çš„è¡¨ç¤ºâ€œé›†åˆâ€çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦æ˜¯æ•°ç»„ï¼ˆArrayï¼‰å’Œå¯¹è±¡ï¼ˆObjectï¼‰ï¼ŒES6åˆæ·»åŠ äº†Mapå’ŒSetã€‚è¿™æ ·å°±æœ‰äº†å››ç§æ•°æ®é›†åˆï¼Œç”¨æˆ·è¿˜å¯ä»¥ç»„åˆä½¿ç”¨å®ƒä»¬ï¼Œå®šä¹‰è‡ªå·±çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚æ•°ç»„çš„æˆå‘˜æ˜¯Mapï¼ŒMapçš„æˆå‘˜æ˜¯å¯¹è±¡ã€‚è¿™æ ·å°±éœ€è¦ä¸€ç§ç»Ÿä¸€çš„æ¥å£æœºåˆ¶ï¼Œæ¥å¤„ç†æ‰€æœ‰ä¸åŒçš„æ•°æ®ç»“æ„ã€‚

éå†å™¨ï¼ˆIteratorï¼‰å°±æ˜¯è¿™æ ·ä¸€ç§æœºåˆ¶ã€‚å®ƒæ˜¯ä¸€ç§æ¥å£ï¼Œä¸ºå„ç§ä¸åŒçš„æ•°æ®ç»“æ„æä¾›ç»Ÿä¸€çš„è®¿é—®æœºåˆ¶ã€‚ä»»ä½•æ•°æ®ç»“æ„åªè¦éƒ¨ç½²Iteratoræ¥å£ï¼Œå°±å¯ä»¥å®Œæˆéå†æ“ä½œï¼ˆå³ä¾æ¬¡å¤„ç†è¯¥æ•°æ®ç»“æ„çš„æ‰€æœ‰æˆå‘˜ï¼‰ã€‚

Iteratorçš„ä½œç”¨æœ‰ä¸‰ä¸ªï¼šä¸€æ˜¯ä¸ºå„ç§æ•°æ®ç»“æ„ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„ã€ç®€ä¾¿çš„è®¿é—®æ¥å£ï¼›äºŒæ˜¯ä½¿å¾—æ•°æ®ç»“æ„çš„æˆå‘˜èƒ½å¤ŸæŒ‰æŸç§æ¬¡åºæ’åˆ—ï¼›ä¸‰æ˜¯ES6åˆ›é€ äº†ä¸€ç§æ–°çš„éå†å‘½ä»¤for...ofå¾ªç¯ï¼ŒIteratoræ¥å£ä¸»è¦ä¾›for...ofæ¶ˆè´¹ã€‚

Iteratorçš„éå†è¿‡ç¨‹æ˜¯è¿™æ ·çš„ã€‚

ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆå¯¹è±¡ï¼ŒæŒ‡å‘å½“å‰æ•°æ®ç»“æ„çš„èµ·å§‹ä½ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œéå†å™¨å¯¹è±¡æœ¬è´¨ä¸Šï¼Œå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¯¹è±¡ã€‚

ï¼ˆ2ï¼‰ç¬¬ä¸€æ¬¡è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„nextæ–¹æ³•ï¼Œå¯ä»¥å°†æŒ‡é’ˆæŒ‡å‘æ•°æ®ç»“æ„çš„ç¬¬ä¸€ä¸ªæˆå‘˜ã€‚

ï¼ˆ3ï¼‰ç¬¬äºŒæ¬¡è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„nextæ–¹æ³•ï¼ŒæŒ‡é’ˆå°±æŒ‡å‘æ•°æ®ç»“æ„çš„ç¬¬äºŒä¸ªæˆå‘˜ã€‚

ï¼ˆ4ï¼‰ä¸æ–­è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„nextæ–¹æ³•ï¼Œç›´åˆ°å®ƒæŒ‡å‘æ•°æ®ç»“æ„çš„ç»“æŸä½ç½®ã€‚

æ¯ä¸€æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œéƒ½ä¼šè¿”å›æ•°æ®ç»“æ„çš„å½“å‰æˆå‘˜çš„ä¿¡æ¯ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯è¿”å›ä¸€ä¸ªåŒ…å«valueå’Œdoneä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ã€‚å…¶ä¸­ï¼Œvalueå±æ€§æ˜¯å½“å‰æˆå‘˜çš„å€¼ï¼Œdoneå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºéå†æ˜¯å¦ç»“æŸã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿnextæ–¹æ³•è¿”å›å€¼çš„ä¾‹å­ã€‚

var it = makeIterator(['a', 'b']);

it.next() // { value: "a", done: false }
it.next() // { value: "b", done: false }
it.next() // { value: undefined, done: true }

function makeIterator(array) {
  var nextIndex = 0;
  return {
    next: function() {
      return nextIndex < array.length ?
        {value: array[nextIndex++], done: false} :
        {value: undefined, done: true};
    }
  };
}
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªmakeIteratorå‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªéå†å™¨ç”Ÿæˆå‡½æ•°ï¼Œä½œç”¨å°±æ˜¯è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚å¯¹æ•°ç»„['a', 'b']æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå°±ä¼šè¿”å›è¯¥æ•°ç»„çš„éå†å™¨å¯¹è±¡ï¼ˆå³æŒ‡é’ˆå¯¹è±¡ï¼‰itã€‚

æŒ‡é’ˆå¯¹è±¡çš„nextæ–¹æ³•ï¼Œç”¨æ¥ç§»åŠ¨æŒ‡é’ˆã€‚å¼€å§‹æ—¶ï¼ŒæŒ‡é’ˆæŒ‡å‘æ•°ç»„çš„å¼€å§‹ä½ç½®ã€‚ç„¶åï¼Œæ¯æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼ŒæŒ‡é’ˆå°±ä¼šæŒ‡å‘æ•°ç»„çš„ä¸‹ä¸€ä¸ªæˆå‘˜ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ŒæŒ‡å‘aï¼›ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ŒæŒ‡å‘bã€‚

nextæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰æ•°æ®æˆå‘˜çš„ä¿¡æ¯ã€‚è¿™ä¸ªå¯¹è±¡å…·æœ‰valueå’Œdoneä¸¤ä¸ªå±æ€§ï¼Œvalueå±æ€§è¿”å›å½“å‰ä½ç½®çš„æˆå‘˜ï¼Œdoneå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºéå†æ˜¯å¦ç»“æŸï¼Œå³æ˜¯å¦è¿˜æœ‰å¿…è¦å†ä¸€æ¬¡è°ƒç”¨nextæ–¹æ³•ã€‚

æ€»ä¹‹ï¼Œè°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„nextæ–¹æ³•ï¼Œå°±å¯ä»¥éå†äº‹å…ˆç»™å®šçš„æ•°æ®ç»“æ„ã€‚

å¯¹äºéå†å™¨å¯¹è±¡æ¥è¯´ï¼Œdone: falseå’Œvalue: undefinedå±æ€§éƒ½æ˜¯å¯ä»¥çœç•¥çš„ï¼Œå› æ­¤ä¸Šé¢çš„makeIteratorå‡½æ•°å¯ä»¥ç®€å†™æˆä¸‹é¢çš„å½¢å¼ã€‚

function makeIterator(array) {
  var nextIndex = 0;
  return {
    next: function() {
      return nextIndex < array.length ?
        {value: array[nextIndex++]} :
        {done: true};
    }
  };
}
ç”±äºIteratoråªæ˜¯æŠŠæ¥å£è§„æ ¼åŠ åˆ°æ•°æ®ç»“æ„ä¹‹ä¸Šï¼Œæ‰€ä»¥ï¼Œéå†å™¨ä¸å®ƒæ‰€éå†çš„é‚£ä¸ªæ•°æ®ç»“æ„ï¼Œå®é™…ä¸Šæ˜¯åˆ†å¼€çš„ï¼Œå®Œå…¨å¯ä»¥å†™å‡ºæ²¡æœ‰å¯¹åº”æ•°æ®ç»“æ„çš„éå†å™¨å¯¹è±¡ï¼Œæˆ–è€…è¯´ç”¨éå†å™¨å¯¹è±¡æ¨¡æ‹Ÿå‡ºæ•°æ®ç»“æ„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ— é™è¿è¡Œçš„éå†å™¨å¯¹è±¡çš„ä¾‹å­ã€‚

var it = idMaker();

it.next().value // '0'
it.next().value // '1'
it.next().value // '2'
// ...

function idMaker() {
  var index = 0;

  return {
    next: function() {
      return {value: index++, done: false};
    }
  };
}
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œéå†å™¨ç”Ÿæˆå‡½æ•°idMakerï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼ˆå³æŒ‡é’ˆå¯¹è±¡ï¼‰ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œæˆ–è€…è¯´ï¼Œéå†å™¨å¯¹è±¡è‡ªå·±æè¿°äº†ä¸€ä¸ªæ•°æ®ç»“æ„å‡ºæ¥ã€‚

åœ¨ES6ä¸­ï¼Œæœ‰äº›æ•°æ®ç»“æ„åŸç”Ÿå…·å¤‡Iteratoræ¥å£ï¼ˆæ¯”å¦‚æ•°ç»„ï¼‰ï¼Œå³ä¸ç”¨ä»»ä½•å¤„ç†ï¼Œå°±å¯ä»¥è¢«for...ofå¾ªç¯éå†ï¼Œæœ‰äº›å°±ä¸è¡Œï¼ˆæ¯”å¦‚å¯¹è±¡ï¼‰ã€‚åŸå› åœ¨äºï¼Œè¿™äº›æ•°æ®ç»“æ„åŸç”Ÿéƒ¨ç½²äº†Symbol.iteratorå±æ€§ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œå¦å¤–ä¸€äº›æ•°æ®ç»“æ„æ²¡æœ‰ã€‚å‡¡æ˜¯éƒ¨ç½²äº†Symbol.iteratorå±æ€§çš„æ•°æ®ç»“æ„ï¼Œå°±ç§°ä¸ºéƒ¨ç½²äº†éå†å™¨æ¥å£ã€‚è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚

å¦‚æœä½¿ç”¨TypeScriptçš„å†™æ³•ï¼Œéå†å™¨æ¥å£ï¼ˆIterableï¼‰ã€æŒ‡é’ˆå¯¹è±¡ï¼ˆIteratorï¼‰å’Œnextæ–¹æ³•è¿”å›å€¼çš„è§„æ ¼å¯ä»¥æè¿°å¦‚ä¸‹ã€‚

interface Iterable {
  [Symbol.iterator]() : Iterator,
}

interface Iterator {
  next(value?: any) : IterationResult,
}

interface IterationResult {
  value: any,
  done: boolean,
}
æ•°æ®ç»“æ„çš„é»˜è®¤Iteratoræ¥å£
Iteratoræ¥å£çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºæ‰€æœ‰æ•°æ®ç»“æ„ï¼Œæä¾›äº†ä¸€ç§ç»Ÿä¸€çš„è®¿é—®æœºåˆ¶ï¼Œå³for...ofå¾ªç¯ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ã€‚å½“ä½¿ç”¨for...ofå¾ªç¯éå†æŸç§æ•°æ®ç»“æ„æ—¶ï¼Œè¯¥å¾ªç¯ä¼šè‡ªåŠ¨å»å¯»æ‰¾Iteratoræ¥å£ã€‚

ä¸€ç§æ•°æ®ç»“æ„åªè¦éƒ¨ç½²äº†Iteratoræ¥å£ï¼Œæˆ‘ä»¬å°±ç§°è¿™ç§æ•°æ®ç»“æ„æ˜¯â€å¯éå†çš„â€œï¼ˆiterableï¼‰ã€‚

ES6è§„å®šï¼Œé»˜è®¤çš„Iteratoræ¥å£éƒ¨ç½²åœ¨æ•°æ®ç»“æ„çš„Symbol.iteratorå±æ€§ï¼Œæˆ–è€…è¯´ï¼Œä¸€ä¸ªæ•°æ®ç»“æ„åªè¦å…·æœ‰Symbol.iteratorå±æ€§ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯â€œå¯éå†çš„â€ï¼ˆiterableï¼‰ã€‚Symbol.iteratorå±æ€§æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æ˜¯å½“å‰æ•°æ®ç»“æ„é»˜è®¤çš„éå†å™¨ç”Ÿæˆå‡½æ•°ã€‚æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªéå†å™¨ã€‚è‡³äºå±æ€§åSymbol.iteratorï¼Œå®ƒæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿”å›Symbolå¯¹è±¡çš„iteratorå±æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢„å®šä¹‰å¥½çš„ã€ç±»å‹ä¸ºSymbolçš„ç‰¹æ®Šå€¼ï¼Œæ‰€ä»¥è¦æ”¾åœ¨æ–¹æ‹¬å·å†…ã€‚ï¼ˆå‚è§Symbolä¸€ç« ï¼‰ã€‚

const obj = {
  [Symbol.iterator] : function () {
    return {
      next: function () {
        return {
          value: 1,
          done: true
        };
      }
    };
  }
};
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯¹è±¡objæ˜¯å¯éå†çš„ï¼ˆiterableï¼‰ï¼Œå› ä¸ºå…·æœ‰Symbol.iteratorå±æ€§ã€‚æ‰§è¡Œè¿™ä¸ªå±æ€§ï¼Œä¼šè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„æ ¹æœ¬ç‰¹å¾å°±æ˜¯å…·æœ‰nextæ–¹æ³•ã€‚æ¯æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªä»£è¡¨å½“å‰æˆå‘˜çš„ä¿¡æ¯å¯¹è±¡ï¼Œå…·æœ‰valueå’Œdoneä¸¤ä¸ªå±æ€§ã€‚

åœ¨ES6ä¸­ï¼Œæœ‰ä¸‰ç±»æ•°æ®ç»“æ„åŸç”Ÿå…·å¤‡Iteratoræ¥å£ï¼šæ•°ç»„ã€æŸäº›ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€Setå’ŒMapç»“æ„ã€‚

let arr = ['a', 'b', 'c'];
let iter = arr[Symbol.iterator]();

iter.next() // { value: 'a', done: false }
iter.next() // { value: 'b', done: false }
iter.next() // { value: 'c', done: false }
iter.next() // { value: undefined, done: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡arræ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŸç”Ÿå°±å…·æœ‰éå†å™¨æ¥å£ï¼Œéƒ¨ç½²åœ¨arrçš„Symbol.iteratorå±æ€§ä¸Šé¢ã€‚æ‰€ä»¥ï¼Œè°ƒç”¨è¿™ä¸ªå±æ€§ï¼Œå°±å¾—åˆ°éå†å™¨å¯¹è±¡ã€‚

ä¸Šé¢æåˆ°ï¼ŒåŸç”Ÿå°±éƒ¨ç½²Iteratoræ¥å£çš„æ•°æ®ç»“æ„æœ‰ä¸‰ç±»ï¼Œå¯¹äºè¿™ä¸‰ç±»æ•°æ®ç»“æ„ï¼Œä¸ç”¨è‡ªå·±å†™éå†å™¨ç”Ÿæˆå‡½æ•°ï¼Œfor...ofå¾ªç¯ä¼šè‡ªåŠ¨éå†å®ƒä»¬ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–æ•°æ®ç»“æ„ï¼ˆä¸»è¦æ˜¯å¯¹è±¡ï¼‰çš„Iteratoræ¥å£ï¼Œéƒ½éœ€è¦è‡ªå·±åœ¨Symbol.iteratorå±æ€§ä¸Šé¢éƒ¨ç½²ï¼Œè¿™æ ·æ‰ä¼šè¢«for...ofå¾ªç¯éå†ã€‚

å¯¹è±¡ï¼ˆObjectï¼‰ä¹‹æ‰€ä»¥æ²¡æœ‰é»˜è®¤éƒ¨ç½²Iteratoræ¥å£ï¼Œæ˜¯å› ä¸ºå¯¹è±¡çš„å“ªä¸ªå±æ€§å…ˆéå†ï¼Œå“ªä¸ªå±æ€§åéå†æ˜¯ä¸ç¡®å®šçš„ï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨æŒ‡å®šã€‚æœ¬è´¨ä¸Šï¼Œéå†å™¨æ˜¯ä¸€ç§çº¿æ€§å¤„ç†ï¼Œå¯¹äºä»»ä½•éçº¿æ€§çš„æ•°æ®ç»“æ„ï¼Œéƒ¨ç½²éå†å™¨æ¥å£ï¼Œå°±ç­‰äºéƒ¨ç½²ä¸€ç§çº¿æ€§è½¬æ¢ã€‚ä¸è¿‡ï¼Œä¸¥æ ¼åœ°è¯´ï¼Œå¯¹è±¡éƒ¨ç½²éå†å™¨æ¥å£å¹¶ä¸æ˜¯å¾ˆå¿…è¦ï¼Œå› ä¸ºè¿™æ—¶å¯¹è±¡å®é™…ä¸Šè¢«å½“ä½œMapç»“æ„ä½¿ç”¨ï¼ŒES5æ²¡æœ‰Mapç»“æ„ï¼Œè€ŒES6åŸç”Ÿæä¾›äº†ã€‚

ä¸€ä¸ªå¯¹è±¡å¦‚æœè¦æœ‰å¯è¢«for...ofå¾ªç¯è°ƒç”¨çš„Iteratoræ¥å£ï¼Œå°±å¿…é¡»åœ¨Symbol.iteratorçš„å±æ€§ä¸Šéƒ¨ç½²éå†å™¨ç”Ÿæˆæ–¹æ³•ï¼ˆåŸå‹é“¾ä¸Šçš„å¯¹è±¡å…·æœ‰è¯¥æ–¹æ³•ä¹Ÿå¯ï¼‰ã€‚

class RangeIterator {
  constructor(start, stop) {
    this.value = start;
    this.stop = stop;
  }

  [Symbol.iterator]() { return this; }

  next() {
    var value = this.value;
    if (value < this.stop) {
      this.value++;
      return {done: false, value: value};
    } else {
      return {done: true, value: undefined};
    }
  }
}

function range(start, stop) {
  return new RangeIterator(start, stop);
}

for (var value of range(0, 3)) {
  console.log(value);
}
ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªç±»éƒ¨ç½²Iteratoræ¥å£çš„å†™æ³•ã€‚Symbol.iteratorå±æ€§å¯¹åº”ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œåè¿”å›å½“å‰å¯¹è±¡çš„éå†å™¨å¯¹è±¡ã€‚

ä¸‹é¢æ˜¯é€šè¿‡éå†å™¨å®ç°æŒ‡é’ˆç»“æ„çš„ä¾‹å­ã€‚

function Obj(value) {
  this.value = value;
  this.next = null;
}

Obj.prototype[Symbol.iterator] = function() {
  var iterator = {
    next: next
  };

  var current = this;

  function next() {
    if (current) {
      var value = current.value;
      current = current.next;
      return {
        done: false,
        value: value
      };
    } else {
      return {
        done: true
      };
    }
  }
  return iterator;
}

var one = new Obj(1);
var two = new Obj(2);
var three = new Obj(3);

one.next = two;
two.next = three;

for (var i of one){
  console.log(i);
}
// 1
// 2
// 3
ä¸Šé¢ä»£ç é¦–å…ˆåœ¨æ„é€ å‡½æ•°çš„åŸå‹é“¾ä¸Šéƒ¨ç½²Symbol.iteratoræ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šè¿”å›éå†å™¨å¯¹è±¡iteratorï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„nextæ–¹æ³•ï¼Œåœ¨è¿”å›ä¸€ä¸ªå€¼çš„åŒæ—¶ï¼Œè‡ªåŠ¨å°†å†…éƒ¨æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€ä¸ªå®ä¾‹ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¸ºå¯¹è±¡æ·»åŠ Iteratoræ¥å£çš„ä¾‹å­ã€‚

let obj = {
  data: [ 'hello', 'world' ],
  [Symbol.iterator]() {
    const self = this;
    let index = 0;
    return {
      next() {
        if (index < self.data.length) {
          return {
            value: self.data[index++],
            done: false
          };
        } else {
          return { value: undefined, done: true };
        }
      }
    };
  }
};
å¯¹äºç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼ˆå­˜åœ¨æ•°å€¼é”®åå’Œlengthå±æ€§ï¼‰ï¼Œéƒ¨ç½²Iteratoræ¥å£ï¼Œæœ‰ä¸€ä¸ªç®€ä¾¿æ–¹æ³•ï¼Œå°±æ˜¯Symbol.iteratoræ–¹æ³•ç›´æ¥å¼•ç”¨æ•°ç»„çš„Iteratoræ¥å£ã€‚

NodeList.prototype[Symbol.iterator] = Array.prototype[Symbol.iterator];
// æˆ–è€…
NodeList.prototype[Symbol.iterator] = [][Symbol.iterator];

[...document.querySelectorAll('div')] // å¯ä»¥æ‰§è¡Œäº†
ä¸‹é¢æ˜¯ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡è°ƒç”¨æ•°ç»„çš„Symbol.iteratoræ–¹æ³•çš„ä¾‹å­ã€‚

let iterable = {
  0: 'a',
  1: 'b',
  2: 'c',
  length: 3,
  [Symbol.iterator]: Array.prototype[Symbol.iterator]
};
for (let item of iterable) {
  console.log(item); // 'a', 'b', 'c'
}
æ³¨æ„ï¼Œæ™®é€šå¯¹è±¡éƒ¨ç½²æ•°ç»„çš„Symbol.iteratoræ–¹æ³•ï¼Œå¹¶æ— æ•ˆæœã€‚

let iterable = {
  a: 'a',
  b: 'b',
  c: 'c',
  length: 3,
  [Symbol.iterator]: Array.prototype[Symbol.iterator]
};
for (let item of iterable) {
  console.log(item); // undefined, undefined, undefined
}
å¦‚æœSymbol.iteratoræ–¹æ³•å¯¹åº”çš„ä¸æ˜¯éå†å™¨ç”Ÿæˆå‡½æ•°ï¼ˆå³ä¼šè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼‰ï¼Œè§£é‡Šå¼•æ“å°†ä¼šæŠ¥é”™ã€‚

var obj = {};

obj[Symbol.iterator] = () => 1;

[...obj] // TypeError: [] is not a function
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡objçš„Symbol.iteratoræ–¹æ³•å¯¹åº”çš„ä¸æ˜¯éå†å™¨ç”Ÿæˆå‡½æ•°ï¼Œå› æ­¤æŠ¥é”™ã€‚

æœ‰äº†éå†å™¨æ¥å£ï¼Œæ•°æ®ç»“æ„å°±å¯ä»¥ç”¨for...ofå¾ªç¯éå†ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨whileå¾ªç¯éå†ã€‚

var $iterator = ITERABLE[Symbol.iterator]();
var $result = $iterator.next();
while (!$result.done) {
  var x = $result.value;
  // ...
  $result = $iterator.next();
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒITERABLEä»£è¡¨æŸç§å¯éå†çš„æ•°æ®ç»“æ„ï¼Œ$iteratoræ˜¯å®ƒçš„éå†å™¨å¯¹è±¡ã€‚éå†å™¨å¯¹è±¡æ¯æ¬¡ç§»åŠ¨æŒ‡é’ˆï¼ˆnextæ–¹æ³•ï¼‰ï¼Œéƒ½æ£€æŸ¥ä¸€ä¸‹è¿”å›å€¼çš„doneå±æ€§ï¼Œå¦‚æœéå†è¿˜æ²¡ç»“æŸï¼Œå°±ç§»åŠ¨éå†å™¨å¯¹è±¡çš„æŒ‡é’ˆåˆ°ä¸‹ä¸€æ­¥ï¼ˆnextæ–¹æ³•ï¼‰ï¼Œä¸æ–­å¾ªç¯ã€‚

è°ƒç”¨Iteratoræ¥å£çš„åœºåˆ
æœ‰ä¸€äº›åœºåˆä¼šé»˜è®¤è°ƒç”¨Iteratoræ¥å£ï¼ˆå³Symbol.iteratoræ–¹æ³•ï¼‰ï¼Œé™¤äº†ä¸‹æ–‡ä¼šä»‹ç»çš„for...ofå¾ªç¯ï¼Œè¿˜æœ‰å‡ ä¸ªåˆ«çš„åœºåˆã€‚

ï¼ˆ1ï¼‰è§£æ„èµ‹å€¼

å¯¹æ•°ç»„å’ŒSetç»“æ„è¿›è¡Œè§£æ„èµ‹å€¼æ—¶ï¼Œä¼šé»˜è®¤è°ƒç”¨Symbol.iteratoræ–¹æ³•ã€‚

let set = new Set().add('a').add('b').add('c');

let [x,y] = set;
// x='a'; y='b'

let [first, ...rest] = set;
// first='a'; rest=['b','c'];
ï¼ˆ2ï¼‰æ‰©å±•è¿ç®—ç¬¦

æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ä¹Ÿä¼šè°ƒç”¨é»˜è®¤çš„iteratoræ¥å£ã€‚

// ä¾‹ä¸€
var str = 'hello';
[...str] //  ['h','e','l','l','o']

// ä¾‹äºŒ
let arr = ['b', 'c'];
['a', ...arr, 'd']
// ['a', 'b', 'c', 'd']
ä¸Šé¢ä»£ç çš„æ‰©å±•è¿ç®—ç¬¦å†…éƒ¨å°±è°ƒç”¨Iteratoræ¥å£ã€‚

å®é™…ä¸Šï¼Œè¿™æä¾›äº†ä¸€ç§ç®€ä¾¿æœºåˆ¶ï¼Œå¯ä»¥å°†ä»»ä½•éƒ¨ç½²äº†Iteratoræ¥å£çš„æ•°æ®ç»“æ„ï¼Œè½¬ä¸ºæ•°ç»„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æŸä¸ªæ•°æ®ç»“æ„éƒ¨ç½²äº†Iteratoræ¥å£ï¼Œå°±å¯ä»¥å¯¹å®ƒä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œå°†å…¶è½¬ä¸ºæ•°ç»„ã€‚

let arr = [...iterable];
ï¼ˆ3ï¼‰yield*

yield*åé¢è·Ÿçš„æ˜¯ä¸€ä¸ªå¯éå†çš„ç»“æ„ï¼Œå®ƒä¼šè°ƒç”¨è¯¥ç»“æ„çš„éå†å™¨æ¥å£ã€‚

let generator = function* () {
  yield 1;
  yield* [2,3,4];
  yield 5;
};

var iterator = generator();

iterator.next() // { value: 1, done: false }
iterator.next() // { value: 2, done: false }
iterator.next() // { value: 3, done: false }
iterator.next() // { value: 4, done: false }
iterator.next() // { value: 5, done: false }
iterator.next() // { value: undefined, done: true }
ï¼ˆ4ï¼‰å…¶ä»–åœºåˆ

ç”±äºæ•°ç»„çš„éå†ä¼šè°ƒç”¨éå†å™¨æ¥å£ï¼Œæ‰€ä»¥ä»»ä½•æ¥å—æ•°ç»„ä½œä¸ºå‚æ•°çš„åœºåˆï¼Œå…¶å®éƒ½è°ƒç”¨äº†éå†å™¨æ¥å£ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ã€‚

for...of
Array.from()
Map(), Set(), WeakMap(), WeakSet()ï¼ˆæ¯”å¦‚new Map([['a',1],['b',2]])ï¼‰
Promise.all()
Promise.race()
å­—ç¬¦ä¸²çš„Iteratoræ¥å£
å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œä¹ŸåŸç”Ÿå…·æœ‰Iteratoræ¥å£ã€‚

var someString = "hi";
typeof someString[Symbol.iterator]
// "function"

var iterator = someString[Symbol.iterator]();

iterator.next()  // { value: "h", done: false }
iterator.next()  // { value: "i", done: false }
iterator.next()  // { value: undefined, done: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œè°ƒç”¨Symbol.iteratoræ–¹æ³•è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªéå†å™¨ä¸Šå¯ä»¥è°ƒç”¨nextæ–¹æ³•ï¼Œå®ç°å¯¹äºå­—ç¬¦ä¸²çš„éå†ã€‚

å¯ä»¥è¦†ç›–åŸç”Ÿçš„Symbol.iteratoræ–¹æ³•ï¼Œè¾¾åˆ°ä¿®æ”¹éå†å™¨è¡Œä¸ºçš„ç›®çš„ã€‚

var str = new String("hi");

[...str] // ["h", "i"]

str[Symbol.iterator] = function() {
  return {
    next: function() {
      if (this._first) {
        this._first = false;
        return { value: "bye", done: false };
      } else {
        return { done: true };
      }
    },
    _first: true
  };
};

[...str] // ["bye"]
str // "hi"
ä¸Šé¢ä»£ç ä¸­ï¼Œå­—ç¬¦ä¸²strçš„Symbol.iteratoræ–¹æ³•è¢«ä¿®æ”¹äº†ï¼Œæ‰€ä»¥æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰è¿”å›çš„å€¼å˜æˆäº†byeï¼Œè€Œå­—ç¬¦ä¸²æœ¬èº«è¿˜æ˜¯hiã€‚

Iteratoræ¥å£ä¸Generatorå‡½æ•°
Symbol.iteratoræ–¹æ³•çš„æœ€ç®€å•å®ç°ï¼Œè¿˜æ˜¯ä½¿ç”¨ä¸‹ä¸€ç« è¦ä»‹ç»çš„Generatorå‡½æ•°ã€‚

var myIterable = {};

myIterable[Symbol.iterator] = function* () {
  yield 1;
  yield 2;
  yield 3;
};
[...myIterable] // [1, 2, 3]

// æˆ–è€…é‡‡ç”¨ä¸‹é¢çš„ç®€æ´å†™æ³•

let obj = {
  * [Symbol.iterator]() {
    yield 'hello';
    yield 'world';
  }
};

for (let x of obj) {
  console.log(x);
}
// hello
// world
ä¸Šé¢ä»£ç ä¸­ï¼ŒSymbol.iteratoræ–¹æ³•å‡ ä¹ä¸ç”¨éƒ¨ç½²ä»»ä½•ä»£ç ï¼Œåªè¦ç”¨yieldå‘½ä»¤ç»™å‡ºæ¯ä¸€æ­¥çš„è¿”å›å€¼å³å¯ã€‚

éå†å™¨å¯¹è±¡çš„return()ï¼Œthrow()
éå†å™¨å¯¹è±¡é™¤äº†å…·æœ‰nextæ–¹æ³•ï¼Œè¿˜å¯ä»¥å…·æœ‰returnæ–¹æ³•å’Œthrowæ–¹æ³•ã€‚å¦‚æœä½ è‡ªå·±å†™éå†å™¨å¯¹è±¡ç”Ÿæˆå‡½æ•°ï¼Œé‚£ä¹ˆnextæ–¹æ³•æ˜¯å¿…é¡»éƒ¨ç½²çš„ï¼Œreturnæ–¹æ³•å’Œthrowæ–¹æ³•æ˜¯å¦éƒ¨ç½²æ˜¯å¯é€‰çš„ã€‚

returnæ–¹æ³•çš„ä½¿ç”¨åœºåˆæ˜¯ï¼Œå¦‚æœfor...ofå¾ªç¯æå‰é€€å‡ºï¼ˆé€šå¸¸æ˜¯å› ä¸ºå‡ºé”™ï¼Œæˆ–è€…æœ‰breakè¯­å¥æˆ–continueè¯­å¥ï¼‰ï¼Œå°±ä¼šè°ƒç”¨returnæ–¹æ³•ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å®Œæˆéå†å‰ï¼Œéœ€è¦æ¸…ç†æˆ–é‡Šæ”¾èµ„æºï¼Œå°±å¯ä»¥éƒ¨ç½²returnæ–¹æ³•ã€‚

function readLinesSync(file) {
  return {
    next() {
      if (file.isAtEndOfFile()) {
        file.close();
        return { done: true };
      }
    },
    return() {
      file.close();
      return { done: true };
    },
  };
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°readLinesSyncæ¥å—ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œå…¶ä¸­é™¤äº†nextæ–¹æ³•ï¼Œè¿˜éƒ¨ç½²äº†returnæ–¹æ³•ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬è®©æ–‡ä»¶çš„éå†æå‰è¿”å›ï¼Œè¿™æ ·å°±ä¼šè§¦å‘æ‰§è¡Œreturnæ–¹æ³•ã€‚

for (let line of readLinesSync(fileName)) {
  console.log(line);
  break;
}
æ³¨æ„ï¼Œreturnæ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ˜¯Generatorè§„æ ¼å†³å®šçš„ã€‚

throwæ–¹æ³•ä¸»è¦æ˜¯é…åˆGeneratorå‡½æ•°ä½¿ç”¨ï¼Œä¸€èˆ¬çš„éå†å™¨å¯¹è±¡ç”¨ä¸åˆ°è¿™ä¸ªæ–¹æ³•ã€‚è¯·å‚é˜…ã€ŠGeneratorå‡½æ•°ã€‹ä¸€ç« ã€‚

for...ofå¾ªç¯
ES6 å€Ÿé‰´ C++ã€Javaã€C# å’Œ Python è¯­è¨€ï¼Œå¼•å…¥äº†for...ofå¾ªç¯ï¼Œä½œä¸ºéå†æ‰€æœ‰æ•°æ®ç»“æ„çš„ç»Ÿä¸€çš„æ–¹æ³•ã€‚

ä¸€ä¸ªæ•°æ®ç»“æ„åªè¦éƒ¨ç½²äº†Symbol.iteratorå±æ€§ï¼Œå°±è¢«è§†ä¸ºå…·æœ‰iteratoræ¥å£ï¼Œå°±å¯ä»¥ç”¨for...ofå¾ªç¯éå†å®ƒçš„æˆå‘˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œfor...ofå¾ªç¯å†…éƒ¨è°ƒç”¨çš„æ˜¯æ•°æ®ç»“æ„çš„Symbol.iteratoræ–¹æ³•ã€‚

for...ofå¾ªç¯å¯ä»¥ä½¿ç”¨çš„èŒƒå›´åŒ…æ‹¬æ•°ç»„ã€Set å’Œ Map ç»“æ„ã€æŸäº›ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼ˆæ¯”å¦‚argumentså¯¹è±¡ã€DOM NodeList å¯¹è±¡ï¼‰ã€åæ–‡çš„ Generator å¯¹è±¡ï¼Œä»¥åŠå­—ç¬¦ä¸²ã€‚

æ•°ç»„
æ•°ç»„åŸç”Ÿå…·å¤‡iteratoræ¥å£ï¼ˆå³é»˜è®¤éƒ¨ç½²äº†Symbol.iteratorå±æ€§ï¼‰ï¼Œfor...ofå¾ªç¯æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨è¿™ä¸ªæ¥å£äº§ç”Ÿçš„éå†å™¨ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç è¯æ˜ã€‚

const arr = ['red', 'green', 'blue'];

for(let v of arr) {
  console.log(v); // red green blue
}

const obj = {};
obj[Symbol.iterator] = arr[Symbol.iterator].bind(arr);

for(let v of obj) {
  console.log(v); // red green blue
}
ä¸Šé¢ä»£ç ä¸­ï¼Œç©ºå¯¹è±¡objéƒ¨ç½²äº†æ•°ç»„arrçš„Symbol.iteratorå±æ€§ï¼Œç»“æœobjçš„for...ofå¾ªç¯ï¼Œäº§ç”Ÿäº†ä¸arrå®Œå…¨ä¸€æ ·çš„ç»“æœã€‚

for...ofå¾ªç¯å¯ä»¥ä»£æ›¿æ•°ç»„å®ä¾‹çš„forEachæ–¹æ³•ã€‚

const arr = ['red', 'green', 'blue'];

arr.forEach(function (element, index) {
  console.log(element); // red green blue
  console.log(index);   // 0 1 2
});
JavaScriptåŸæœ‰çš„for...inå¾ªç¯ï¼Œåªèƒ½è·å¾—å¯¹è±¡çš„é”®åï¼Œä¸èƒ½ç›´æ¥è·å–é”®å€¼ã€‚ES6æä¾›for...ofå¾ªç¯ï¼Œå…è®¸éå†è·å¾—é”®å€¼ã€‚

var arr = ['a', 'b', 'c', 'd'];

for (let a in arr) {
  console.log(a); // 0 1 2 3
}

for (let a of arr) {
  console.log(a); // a b c d
}
ä¸Šé¢ä»£ç è¡¨æ˜ï¼Œfor...inå¾ªç¯è¯»å–é”®åï¼Œfor...ofå¾ªç¯è¯»å–é”®å€¼ã€‚å¦‚æœè¦é€šè¿‡for...ofå¾ªç¯ï¼Œè·å–æ•°ç»„çš„ç´¢å¼•ï¼Œå¯ä»¥å€ŸåŠ©æ•°ç»„å®ä¾‹çš„entriesæ–¹æ³•å’Œkeysæ–¹æ³•ï¼Œå‚è§ã€Šæ•°ç»„çš„æ‰©å±•ã€‹ç« èŠ‚ã€‚

for...ofå¾ªç¯è°ƒç”¨éå†å™¨æ¥å£ï¼Œæ•°ç»„çš„éå†å™¨æ¥å£åªè¿”å›å…·æœ‰æ•°å­—ç´¢å¼•çš„å±æ€§ã€‚è¿™ä¸€ç‚¹è·Ÿfor...inå¾ªç¯ä¹Ÿä¸ä¸€æ ·ã€‚

let arr = [3, 5, 7];
arr.foo = 'hello';

for (let i in arr) {
  console.log(i); // "0", "1", "2", "foo"
}

for (let i of arr) {
  console.log(i); //  "3", "5", "7"
}
ä¸Šé¢ä»£ç ä¸­ï¼Œfor...ofå¾ªç¯ä¸ä¼šè¿”å›æ•°ç»„arrçš„fooå±æ€§ã€‚

Setå’ŒMapç»“æ„
Setå’ŒMapç»“æ„ä¹ŸåŸç”Ÿå…·æœ‰Iteratoræ¥å£ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨for...ofå¾ªç¯ã€‚

var engines = new Set(["Gecko", "Trident", "Webkit", "Webkit"]);
for (var e of engines) {
  console.log(e);
}
// Gecko
// Trident
// Webkit

var es6 = new Map();
es6.set("edition", 6);
es6.set("committee", "TC39");
es6.set("standard", "ECMA-262");
for (var [name, value] of es6) {
  console.log(name + ": " + value);
}
// edition: 6
// committee: TC39
// standard: ECMA-262
ä¸Šé¢ä»£ç æ¼”ç¤ºäº†å¦‚ä½•éå†Setç»“æ„å’ŒMapç»“æ„ã€‚å€¼å¾—æ³¨æ„çš„åœ°æ–¹æœ‰ä¸¤ä¸ªï¼Œé¦–å…ˆï¼Œéå†çš„é¡ºåºæ˜¯æŒ‰ç…§å„ä¸ªæˆå‘˜è¢«æ·»åŠ è¿›æ•°æ®ç»“æ„çš„é¡ºåºã€‚å…¶æ¬¡ï¼ŒSetç»“æ„éå†æ—¶ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå€¼ï¼Œè€ŒMapç»“æ„éå†æ—¶ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„çš„ä¸¤ä¸ªæˆå‘˜åˆ†åˆ«ä¸ºå½“å‰Mapæˆå‘˜çš„é”®åå’Œé”®å€¼ã€‚

let map = new Map().set('a', 1).set('b', 2);
for (let pair of map) {
  console.log(pair);
}
// ['a', 1]
// ['b', 2]

for (let [key, value] of map) {
  console.log(key + ' : ' + value);
}
// a : 1
// b : 2
è®¡ç®—ç”Ÿæˆçš„æ•°æ®ç»“æ„
æœ‰äº›æ•°æ®ç»“æ„æ˜¯åœ¨ç°æœ‰æ•°æ®ç»“æ„çš„åŸºç¡€ä¸Šï¼Œè®¡ç®—ç”Ÿæˆçš„ã€‚æ¯”å¦‚ï¼ŒES6çš„æ•°ç»„ã€Setã€Mapéƒ½éƒ¨ç½²äº†ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨åéƒ½è¿”å›éå†å™¨å¯¹è±¡ã€‚

entries() è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œç”¨æ¥éå†[é”®å, é”®å€¼]ç»„æˆçš„æ•°ç»„ã€‚å¯¹äºæ•°ç»„ï¼Œé”®åå°±æ˜¯ç´¢å¼•å€¼ï¼›å¯¹äºSetï¼Œé”®åä¸é”®å€¼ç›¸åŒã€‚Mapç»“æ„çš„iteratoræ¥å£ï¼Œé»˜è®¤å°±æ˜¯è°ƒç”¨entriesæ–¹æ³•ã€‚
keys() è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œç”¨æ¥éå†æ‰€æœ‰çš„é”®åã€‚
values() è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œç”¨æ¥éå†æ‰€æœ‰çš„é”®å€¼ã€‚
è¿™ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨åç”Ÿæˆçš„éå†å™¨å¯¹è±¡ï¼Œæ‰€éå†çš„éƒ½æ˜¯è®¡ç®—ç”Ÿæˆçš„æ•°æ®ç»“æ„ã€‚

let arr = ['a', 'b', 'c'];
for (let pair of arr.entries()) {
  console.log(pair);
}
// [0, 'a']
// [1, 'b']
// [2, 'c']
ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡
ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡åŒ…æ‹¬å¥½å‡ ç±»ã€‚ä¸‹é¢æ˜¯for...ofå¾ªç¯ç”¨äºå­—ç¬¦ä¸²ã€DOM NodeListå¯¹è±¡ã€argumentså¯¹è±¡çš„ä¾‹å­ã€‚

// å­—ç¬¦ä¸²
let str = "hello";

for (let s of str) {
  console.log(s); // h e l l o
}

// DOM NodeListå¯¹è±¡
let paras = document.querySelectorAll("p");

for (let p of paras) {
  p.classList.add("test");
}

// argumentså¯¹è±¡
function printArgs() {
  for (let x of arguments) {
    console.log(x);
  }
}
printArgs('a', 'b');
// 'a'
// 'b'
å¯¹äºå­—ç¬¦ä¸²æ¥è¯´ï¼Œfor...ofå¾ªç¯è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯ä¼šæ­£ç¡®è¯†åˆ«32ä½UTF-16å­—ç¬¦ã€‚

for (let x of 'a\uD83D\uDC0A') {
  console.log(x);
}
// 'a'
// '\uD83D\uDC0A'
å¹¶ä¸æ˜¯æ‰€æœ‰ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡éƒ½å…·æœ‰iteratoræ¥å£ï¼Œä¸€ä¸ªç®€ä¾¿çš„è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯ä½¿ç”¨Array.fromæ–¹æ³•å°†å…¶è½¬ä¸ºæ•°ç»„ã€‚

let arrayLike = { length: 2, 0: 'a', 1: 'b' };

// æŠ¥é”™
for (let x of arrayLike) {
  console.log(x);
}

// æ­£ç¡®
for (let x of Array.from(arrayLike)) {
  console.log(x);
}
å¯¹è±¡
å¯¹äºæ™®é€šçš„å¯¹è±¡ï¼Œfor...ofç»“æ„ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä¼šæŠ¥é”™ï¼Œå¿…é¡»éƒ¨ç½²äº†iteratoræ¥å£åæ‰èƒ½ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œè¿™æ ·æƒ…å†µä¸‹ï¼Œfor...inå¾ªç¯ä¾ç„¶å¯ä»¥ç”¨æ¥éå†é”®åã€‚

var es6 = {
  edition: 6,
  committee: "TC39",
  standard: "ECMA-262"
};

for (let e in es6) {
  console.log(e);
}
// edition
// committee
// standard

for (let e of es6) {
  console.log(e);
}
// TypeError: es6 is not iterable
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œå¯¹äºæ™®é€šçš„å¯¹è±¡ï¼Œfor...inå¾ªç¯å¯ä»¥éå†é”®åï¼Œfor...ofå¾ªç¯ä¼šæŠ¥é”™ã€‚

ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ï¼Œä½¿ç”¨Object.keysæ–¹æ³•å°†å¯¹è±¡çš„é”®åç”Ÿæˆä¸€ä¸ªæ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„ã€‚

for (var key of Object.keys(someObject)) {
  console.log(key + ": " + someObject[key]);
}
åœ¨å¯¹è±¡ä¸Šéƒ¨ç½²iteratoræ¥å£çš„ä»£ç ï¼Œå‚è§æœ¬ç« å‰é¢éƒ¨åˆ†ã€‚ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹æ³•æ˜¯å°†æ•°ç»„çš„Symbol.iteratorå±æ€§ï¼Œç›´æ¥èµ‹å€¼ç»™å…¶ä»–å¯¹è±¡çš„Symbol.iteratorå±æ€§ã€‚æ¯”å¦‚ï¼Œæƒ³è¦è®©for...ofç¯éå†jQueryå¯¹è±¡ï¼Œåªè¦åŠ ä¸Šä¸‹é¢è¿™ä¸€è¡Œå°±å¯ä»¥äº†ã€‚

jQuery.prototype[Symbol.iterator] =
  Array.prototype[Symbol.iterator];
å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ä½¿ç”¨Generatorå‡½æ•°å°†å¯¹è±¡é‡æ–°åŒ…è£…ä¸€ä¸‹ã€‚

function* entries(obj) {
  for (let key of Object.keys(obj)) {
    yield [key, obj[key]];
  }
}

for (let [key, value] of entries(obj)) {
  console.log(key, "->", value);
}
// a -> 1
// b -> 2
// c -> 3
ä¸å…¶ä»–éå†è¯­æ³•çš„æ¯”è¾ƒ
ä»¥æ•°ç»„ä¸ºä¾‹ï¼ŒJavaScriptæä¾›å¤šç§éå†è¯­æ³•ã€‚æœ€åŸå§‹çš„å†™æ³•å°±æ˜¯forå¾ªç¯ã€‚

for (var index = 0; index < myArray.length; index++) {
  console.log(myArray[index]);
}
è¿™ç§å†™æ³•æ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤æ•°ç»„æä¾›å†…ç½®çš„forEachæ–¹æ³•ã€‚

myArray.forEach(function (value) {
  console.log(value);
});
è¿™ç§å†™æ³•çš„é—®é¢˜åœ¨äºï¼Œæ— æ³•ä¸­é€”è·³å‡ºforEachå¾ªç¯ï¼Œbreakå‘½ä»¤æˆ–returnå‘½ä»¤éƒ½ä¸èƒ½å¥æ•ˆã€‚

for...inå¾ªç¯å¯ä»¥éå†æ•°ç»„çš„é”®åã€‚

for (var index in myArray) {
  console.log(myArray[index]);
}
for...inå¾ªç¯æœ‰å‡ ä¸ªç¼ºç‚¹ã€‚

æ•°ç»„çš„é”®åæ˜¯æ•°å­—ï¼Œä½†æ˜¯for...inå¾ªç¯æ˜¯ä»¥å­—ç¬¦ä¸²ä½œä¸ºé”®åâ€œ0â€ã€â€œ1â€ã€â€œ2â€ç­‰ç­‰ã€‚
for...inå¾ªç¯ä¸ä»…éå†æ•°å­—é”®åï¼Œè¿˜ä¼šéå†æ‰‹åŠ¨æ·»åŠ çš„å…¶ä»–é”®ï¼Œç”šè‡³åŒ…æ‹¬åŸå‹é“¾ä¸Šçš„é”®ã€‚
æŸäº›æƒ…å†µä¸‹ï¼Œfor...inå¾ªç¯ä¼šä»¥ä»»æ„é¡ºåºéå†é”®åã€‚
æ€»ä¹‹ï¼Œfor...inå¾ªç¯ä¸»è¦æ˜¯ä¸ºéå†å¯¹è±¡è€Œè®¾è®¡çš„ï¼Œä¸é€‚ç”¨äºéå†æ•°ç»„ã€‚

for...ofå¾ªç¯ç›¸æ¯”ä¸Šé¢å‡ ç§åšæ³•ï¼Œæœ‰ä¸€äº›æ˜¾è‘—çš„ä¼˜ç‚¹ã€‚

for (let value of myArray) {
  console.log(value);
}
æœ‰ç€åŒfor...inä¸€æ ·çš„ç®€æ´è¯­æ³•ï¼Œä½†æ˜¯æ²¡æœ‰for...iné‚£äº›ç¼ºç‚¹ã€‚
ä¸åŒç”¨äºforEachæ–¹æ³•ï¼Œå®ƒå¯ä»¥ä¸breakã€continueå’Œreturné…åˆä½¿ç”¨ã€‚
æä¾›äº†éå†æ‰€æœ‰æ•°æ®ç»“æ„çš„ç»Ÿä¸€æ“ä½œæ¥å£ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨breakè¯­å¥ï¼Œè·³å‡ºfor...ofå¾ªç¯çš„ä¾‹å­ã€‚

for (var n of fibonacci) {
  if (n > 1000)
    break;
  console.log(n);
}
ä¸Šé¢çš„ä¾‹å­ï¼Œä¼šè¾“å‡ºæ–æ³¢çº³å¥‘æ•°åˆ—å°äºç­‰äº1000çš„é¡¹ã€‚å¦‚æœå½“å‰é¡¹å¤§äº1000ï¼Œå°±ä¼šä½¿ç”¨breakè¯­å¥è·³å‡ºfor...ofå¾ªç¯ã€‚

##Generator å‡½æ•°
1.ç®€ä»‹
åŸºæœ¬æ¦‚å¿µ
Generatorå‡½æ•°æ˜¯ES6æä¾›çš„ä¸€ç§å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆï¼Œè¯­æ³•è¡Œä¸ºä¸ä¼ ç»Ÿå‡½æ•°å®Œå…¨ä¸åŒã€‚æœ¬ç« è¯¦ç»†ä»‹ç»Generatorå‡½æ•°çš„è¯­æ³•å’ŒAPIï¼Œå®ƒçš„å¼‚æ­¥ç¼–ç¨‹åº”ç”¨è¯·çœ‹ã€Šå¼‚æ­¥æ“ä½œã€‹ä¸€ç« ã€‚

Generatorå‡½æ•°æœ‰å¤šç§ç†è§£è§’åº¦ã€‚ä»è¯­æ³•ä¸Šï¼Œé¦–å…ˆå¯ä»¥æŠŠå®ƒç†è§£æˆï¼ŒGeneratorå‡½æ•°æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå°è£…äº†å¤šä¸ªå†…éƒ¨çŠ¶æ€ã€‚

æ‰§è¡ŒGeneratorå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒGeneratorå‡½æ•°é™¤äº†çŠ¶æ€æœºï¼Œè¿˜æ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ç”Ÿæˆå‡½æ•°ã€‚è¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œå¯ä»¥ä¾æ¬¡éå†Generatorå‡½æ•°å†…éƒ¨çš„æ¯ä¸€ä¸ªçŠ¶æ€ã€‚

å½¢å¼ä¸Šï¼ŒGeneratorå‡½æ•°æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªç‰¹å¾ã€‚ä¸€æ˜¯ï¼Œfunctionå…³é”®å­—ä¸å‡½æ•°åä¹‹é—´æœ‰ä¸€ä¸ªæ˜Ÿå·ï¼›äºŒæ˜¯ï¼Œå‡½æ•°ä½“å†…éƒ¨ä½¿ç”¨yieldè¯­å¥ï¼Œå®šä¹‰ä¸åŒçš„å†…éƒ¨çŠ¶æ€ï¼ˆyieldè¯­å¥åœ¨è‹±è¯­é‡Œçš„æ„æ€å°±æ˜¯â€œäº§å‡ºâ€ï¼‰ã€‚

function* helloWorldGenerator() {
  yield 'hello';
  yield 'world';
  return 'ending';
}

var hw = helloWorldGenerator();
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªGeneratorå‡½æ•°helloWorldGeneratorï¼Œå®ƒå†…éƒ¨æœ‰ä¸¤ä¸ªyieldè¯­å¥â€œhelloâ€å’Œâ€œworldâ€ï¼Œå³è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼šhelloï¼Œworldå’Œreturnè¯­å¥ï¼ˆç»“æŸæ‰§è¡Œï¼‰ã€‚

ç„¶åï¼ŒGeneratorå‡½æ•°çš„è°ƒç”¨æ–¹æ³•ä¸æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨å‡½æ•°ååé¢åŠ ä¸Šä¸€å¯¹åœ†æ‹¬å·ã€‚ä¸åŒçš„æ˜¯ï¼Œè°ƒç”¨Generatorå‡½æ•°åï¼Œè¯¥å‡½æ•°å¹¶ä¸æ‰§è¡Œï¼Œè¿”å›çš„ä¹Ÿä¸æ˜¯å‡½æ•°è¿è¡Œç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªæŒ‡å‘å†…éƒ¨çŠ¶æ€çš„æŒ‡é’ˆå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€ç« ä»‹ç»çš„éå†å™¨å¯¹è±¡ï¼ˆIterator Objectï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼Œå¿…é¡»è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œä½¿å¾—æŒ‡é’ˆç§»å‘ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œå†…éƒ¨æŒ‡é’ˆå°±ä»å‡½æ•°å¤´éƒ¨æˆ–ä¸Šä¸€æ¬¡åœä¸‹æ¥çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªyieldè¯­å¥ï¼ˆæˆ–returnè¯­å¥ï¼‰ä¸ºæ­¢ã€‚æ¢è¨€ä¹‹ï¼ŒGeneratorå‡½æ•°æ˜¯åˆ†æ®µæ‰§è¡Œçš„ï¼Œyieldè¯­å¥æ˜¯æš‚åœæ‰§è¡Œçš„æ ‡è®°ï¼Œè€Œnextæ–¹æ³•å¯ä»¥æ¢å¤æ‰§è¡Œã€‚

hw.next()
// { value: 'hello', done: false }

hw.next()
// { value: 'world', done: false }

hw.next()
// { value: 'ending', done: true }

hw.next()
// { value: undefined, done: true }
ä¸Šé¢ä»£ç ä¸€å…±è°ƒç”¨äº†å››æ¬¡nextæ–¹æ³•ã€‚

ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ŒGeneratorå‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªyieldè¯­å¥ä¸ºæ­¢ã€‚nextæ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„valueå±æ€§å°±æ˜¯å½“å‰yieldè¯­å¥çš„å€¼helloï¼Œdoneå±æ€§çš„å€¼falseï¼Œè¡¨ç¤ºéå†è¿˜æ²¡æœ‰ç»“æŸã€‚

ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ŒGeneratorå‡½æ•°ä»ä¸Šæ¬¡yieldè¯­å¥åœä¸‹çš„åœ°æ–¹ï¼Œä¸€ç›´æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªyieldè¯­å¥ã€‚nextæ–¹æ³•è¿”å›çš„å¯¹è±¡çš„valueå±æ€§å°±æ˜¯å½“å‰yieldè¯­å¥çš„å€¼worldï¼Œdoneå±æ€§çš„å€¼falseï¼Œè¡¨ç¤ºéå†è¿˜æ²¡æœ‰ç»“æŸã€‚

ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼ŒGeneratorå‡½æ•°ä»ä¸Šæ¬¡yieldè¯­å¥åœä¸‹çš„åœ°æ–¹ï¼Œä¸€ç›´æ‰§è¡Œåˆ°returnè¯­å¥ï¼ˆå¦‚æœæ²¡æœ‰returnè¯­å¥ï¼Œå°±æ‰§è¡Œåˆ°å‡½æ•°ç»“æŸï¼‰ã€‚nextæ–¹æ³•è¿”å›çš„å¯¹è±¡çš„valueå±æ€§ï¼Œå°±æ˜¯ç´§è·Ÿåœ¨returnè¯­å¥åé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼ˆå¦‚æœæ²¡æœ‰returnè¯­å¥ï¼Œåˆ™valueå±æ€§çš„å€¼ä¸ºundefinedï¼‰ï¼Œdoneå±æ€§çš„å€¼trueï¼Œè¡¨ç¤ºéå†å·²ç»ç»“æŸã€‚

ç¬¬å››æ¬¡è°ƒç”¨ï¼Œæ­¤æ—¶Generatorå‡½æ•°å·²ç»è¿è¡Œå®Œæ¯•ï¼Œnextæ–¹æ³•è¿”å›å¯¹è±¡çš„valueå±æ€§ä¸ºundefinedï¼Œdoneå±æ€§ä¸ºtrueã€‚ä»¥åå†è°ƒç”¨nextæ–¹æ³•ï¼Œè¿”å›çš„éƒ½æ˜¯è¿™ä¸ªå€¼ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œè°ƒç”¨Generatorå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œä»£è¡¨Generatorå‡½æ•°çš„å†…éƒ¨æŒ‡é’ˆã€‚ä»¥åï¼Œæ¯æ¬¡è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªæœ‰ç€valueå’Œdoneä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ã€‚valueå±æ€§è¡¨ç¤ºå½“å‰çš„å†…éƒ¨çŠ¶æ€çš„å€¼ï¼Œæ˜¯yieldè¯­å¥åé¢é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼›doneå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éå†ç»“æŸã€‚

ES6æ²¡æœ‰è§„å®šï¼Œfunctionå…³é”®å­—ä¸å‡½æ•°åä¹‹é—´çš„æ˜Ÿå·ï¼Œå†™åœ¨å“ªä¸ªä½ç½®ã€‚è¿™å¯¼è‡´ä¸‹é¢çš„å†™æ³•éƒ½èƒ½é€šè¿‡ã€‚

function * foo(x, y) { Â·Â·Â· }

function *foo(x, y) { Â·Â·Â· }

function* foo(x, y) { Â·Â·Â· }

function*foo(x, y) { Â·Â·Â· }
ç”±äºGeneratorå‡½æ•°ä»ç„¶æ˜¯æ™®é€šå‡½æ•°ï¼Œæ‰€ä»¥ä¸€èˆ¬çš„å†™æ³•æ˜¯ä¸Šé¢çš„ç¬¬ä¸‰ç§ï¼Œå³æ˜Ÿå·ç´§è·Ÿåœ¨functionå…³é”®å­—åé¢ã€‚æœ¬ä¹¦ä¹Ÿé‡‡ç”¨è¿™ç§å†™æ³•ã€‚

yieldè¯­å¥
ç”±äºGeneratorå‡½æ•°è¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œåªæœ‰è°ƒç”¨nextæ–¹æ³•æ‰ä¼šéå†ä¸‹ä¸€ä¸ªå†…éƒ¨çŠ¶æ€ï¼Œæ‰€ä»¥å…¶å®æä¾›äº†ä¸€ç§å¯ä»¥æš‚åœæ‰§è¡Œçš„å‡½æ•°ã€‚yieldè¯­å¥å°±æ˜¯æš‚åœæ ‡å¿—ã€‚

éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•çš„è¿è¡Œé€»è¾‘å¦‚ä¸‹ã€‚

ï¼ˆ1ï¼‰é‡åˆ°yieldè¯­å¥ï¼Œå°±æš‚åœæ‰§è¡Œåé¢çš„æ“ä½œï¼Œå¹¶å°†ç´§è·Ÿåœ¨yieldåé¢çš„é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œä½œä¸ºè¿”å›çš„å¯¹è±¡çš„valueå±æ€§å€¼ã€‚

ï¼ˆ2ï¼‰ä¸‹ä¸€æ¬¡è°ƒç”¨nextæ–¹æ³•æ—¶ï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªyieldè¯­å¥ã€‚

ï¼ˆ3ï¼‰å¦‚æœæ²¡æœ‰å†é‡åˆ°æ–°çš„yieldè¯­å¥ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°å‡½æ•°ç»“æŸï¼Œç›´åˆ°returnè¯­å¥ä¸ºæ­¢ï¼Œå¹¶å°†returnè¯­å¥åé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼Œä½œä¸ºè¿”å›çš„å¯¹è±¡çš„valueå±æ€§å€¼ã€‚

ï¼ˆ4ï¼‰å¦‚æœè¯¥å‡½æ•°æ²¡æœ‰returnè¯­å¥ï¼Œåˆ™è¿”å›çš„å¯¹è±¡çš„valueå±æ€§å€¼ä¸ºundefinedã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œyieldè¯­å¥åé¢çš„è¡¨è¾¾å¼ï¼Œåªæœ‰å½“è°ƒç”¨nextæ–¹æ³•ã€å†…éƒ¨æŒ‡é’ˆæŒ‡å‘è¯¥è¯­å¥æ—¶æ‰ä¼šæ‰§è¡Œï¼Œå› æ­¤ç­‰äºä¸ºJavaScriptæä¾›äº†æ‰‹åŠ¨çš„â€œæƒ°æ€§æ±‚å€¼â€ï¼ˆLazy Evaluationï¼‰çš„è¯­æ³•åŠŸèƒ½ã€‚

function* gen() {
  yield  123 + 456;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œyieldåé¢çš„è¡¨è¾¾å¼123 + 456ï¼Œä¸ä¼šç«‹å³æ±‚å€¼ï¼Œåªä¼šåœ¨nextæ–¹æ³•å°†æŒ‡é’ˆç§»åˆ°è¿™ä¸€å¥æ—¶ï¼Œæ‰ä¼šæ±‚å€¼ã€‚

yieldè¯­å¥ä¸returnè¯­å¥æ—¢æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œä¹Ÿæœ‰åŒºåˆ«ã€‚ç›¸ä¼¼ä¹‹å¤„åœ¨äºï¼Œéƒ½èƒ½è¿”å›ç´§è·Ÿåœ¨è¯­å¥åé¢çš„é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼ã€‚åŒºåˆ«åœ¨äºæ¯æ¬¡é‡åˆ°yieldï¼Œå‡½æ•°æš‚åœæ‰§è¡Œï¼Œä¸‹ä¸€æ¬¡å†ä»è¯¥ä½ç½®ç»§ç»­å‘åæ‰§è¡Œï¼Œè€Œreturnè¯­å¥ä¸å…·å¤‡ä½ç½®è®°å¿†çš„åŠŸèƒ½ã€‚ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼ˆæˆ–è€…è¯´ä¸€ä¸ªï¼‰returnè¯­å¥ï¼Œä½†æ˜¯å¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼ˆæˆ–è€…è¯´å¤šä¸ªï¼‰yieldè¯­å¥ã€‚æ­£å¸¸å‡½æ•°åªèƒ½è¿”å›ä¸€ä¸ªå€¼ï¼Œå› ä¸ºåªèƒ½æ‰§è¡Œä¸€æ¬¡returnï¼›Generatorå‡½æ•°å¯ä»¥è¿”å›ä¸€ç³»åˆ—çš„å€¼ï¼Œå› ä¸ºå¯ä»¥æœ‰ä»»æ„å¤šä¸ªyieldã€‚ä»å¦ä¸€ä¸ªè§’åº¦çœ‹ï¼Œä¹Ÿå¯ä»¥è¯´Generatorç”Ÿæˆäº†ä¸€ç³»åˆ—çš„å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯å®ƒçš„åç§°çš„æ¥å†ï¼ˆåœ¨è‹±è¯­ä¸­ï¼Œgeneratorè¿™ä¸ªè¯æ˜¯â€œç”Ÿæˆå™¨â€çš„æ„æ€ï¼‰ã€‚

Generatorå‡½æ•°å¯ä»¥ä¸ç”¨yieldè¯­å¥ï¼Œè¿™æ—¶å°±å˜æˆäº†ä¸€ä¸ªå•çº¯çš„æš‚ç¼“æ‰§è¡Œå‡½æ•°ã€‚

function* f() {
  console.log('æ‰§è¡Œäº†ï¼')
}

var generator = f();

setTimeout(function () {
  generator.next()
}, 2000);
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°få¦‚æœæ˜¯æ™®é€šå‡½æ•°ï¼Œåœ¨ä¸ºå˜é‡generatorèµ‹å€¼æ—¶å°±ä¼šæ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå‡½æ•°fæ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œå°±å˜æˆåªæœ‰è°ƒç”¨nextæ–¹æ³•æ—¶ï¼Œå‡½æ•°fæ‰ä¼šæ‰§è¡Œã€‚

å¦å¤–éœ€è¦æ³¨æ„ï¼Œyieldè¯­å¥ä¸èƒ½ç”¨åœ¨æ™®é€šå‡½æ•°ä¸­ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

(function (){
  yield 1;
})()
// SyntaxError: Unexpected number
ä¸Šé¢ä»£ç åœ¨ä¸€ä¸ªæ™®é€šå‡½æ•°ä¸­ä½¿ç”¨yieldè¯­å¥ï¼Œç»“æœäº§ç”Ÿä¸€ä¸ªå¥æ³•é”™è¯¯ã€‚

ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªä¾‹å­ã€‚

var arr = [1, [[2, 3], 4], [5, 6]];

var flat = function* (a) {
  a.forEach(function (item) {
    if (typeof item !== 'number') {
      yield* flat(item);
    } else {
      yield item;
    }
  }
};

for (var f of flat(arr)){
  console.log(f);
}
ä¸Šé¢ä»£ç ä¹Ÿä¼šäº§ç”Ÿå¥æ³•é”™è¯¯ï¼Œå› ä¸ºforEachæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œä½†æ˜¯åœ¨é‡Œé¢ä½¿ç”¨äº†yieldè¯­å¥ï¼ˆè¿™ä¸ªå‡½æ•°é‡Œé¢è¿˜ä½¿ç”¨äº†yield*è¯­å¥ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨ç†ä¼šï¼Œè¯¦ç»†è¯´æ˜è§åæ–‡ï¼‰ã€‚ä¸€ç§ä¿®æ”¹æ–¹æ³•æ˜¯æ”¹ç”¨forå¾ªç¯ã€‚

var arr = [1, [[2, 3], 4], [5, 6]];

var flat = function* (a) {
  var length = a.length;
  for (var i = 0; i < length; i++) {
    var item = a[i];
    if (typeof item !== 'number') {
      yield* flat(item);
    } else {
      yield item;
    }
  }
};

for (var f of flat(arr)) {
  console.log(f);
}
// 1, 2, 3, 4, 5, 6
å¦å¤–ï¼Œyieldè¯­å¥å¦‚æœç”¨åœ¨ä¸€ä¸ªè¡¨è¾¾å¼ä¹‹ä¸­ï¼Œå¿…é¡»æ”¾åœ¨åœ†æ‹¬å·é‡Œé¢ã€‚

console.log('Hello' + yield); // SyntaxError
console.log('Hello' + yield 123); // SyntaxError

console.log('Hello' + (yield)); // OK
console.log('Hello' + (yield 123)); // OK
yieldè¯­å¥ç”¨ä½œå‡½æ•°å‚æ•°æˆ–èµ‹å€¼è¡¨è¾¾å¼çš„å³è¾¹ï¼Œå¯ä»¥ä¸åŠ æ‹¬å·ã€‚

foo(yield 'a', yield 'b'); // OK
let input = yield; // OK
ä¸Iteratoræ¥å£çš„å…³ç³»
ä¸Šä¸€ç« è¯´è¿‡ï¼Œä»»æ„ä¸€ä¸ªå¯¹è±¡çš„Symbol.iteratoræ–¹æ³•ï¼Œç­‰äºè¯¥å¯¹è±¡çš„éå†å™¨ç”Ÿæˆå‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¼šè¿”å›è¯¥å¯¹è±¡çš„ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚

ç”±äºGeneratorå‡½æ•°å°±æ˜¯éå†å™¨ç”Ÿæˆå‡½æ•°ï¼Œå› æ­¤å¯ä»¥æŠŠGeneratorèµ‹å€¼ç»™å¯¹è±¡çš„Symbol.iteratorå±æ€§ï¼Œä»è€Œä½¿å¾—è¯¥å¯¹è±¡å…·æœ‰Iteratoræ¥å£ã€‚

var myIterable = {};
myIterable[Symbol.iterator] = function* () {
  yield 1;
  yield 2;
  yield 3;
};

[...myIterable] // [1, 2, 3]
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°èµ‹å€¼ç»™Symbol.iteratorå±æ€§ï¼Œä»è€Œä½¿å¾—myIterableå¯¹è±¡å…·æœ‰äº†Iteratoræ¥å£ï¼Œå¯ä»¥è¢«...è¿ç®—ç¬¦éå†äº†ã€‚

Generatorå‡½æ•°æ‰§è¡Œåï¼Œè¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚è¯¥å¯¹è±¡æœ¬èº«ä¹Ÿå…·æœ‰Symbol.iteratorå±æ€§ï¼Œæ‰§è¡Œåè¿”å›è‡ªèº«ã€‚

function* gen(){
  // some code
}

var g = gen();

g[Symbol.iterator]() === g
// true
ä¸Šé¢ä»£ç ä¸­ï¼Œgenæ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œè°ƒç”¨å®ƒä¼šç”Ÿæˆä¸€ä¸ªéå†å™¨å¯¹è±¡gã€‚å®ƒçš„Symbol.iteratorå±æ€§ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ç”Ÿæˆå‡½æ•°ï¼Œæ‰§è¡Œåè¿”å›å®ƒè‡ªå·±ã€‚

nextæ–¹æ³•çš„å‚æ•°
yieldå¥æœ¬èº«æ²¡æœ‰è¿”å›å€¼ï¼Œæˆ–è€…è¯´æ€»æ˜¯è¿”å›undefinedã€‚nextæ–¹æ³•å¯ä»¥å¸¦ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°å°±ä¼šè¢«å½“ä½œä¸Šä¸€ä¸ªyieldè¯­å¥çš„è¿”å›å€¼ã€‚

function* f() {
  for(var i=0; true; i++) {
    var reset = yield i;
    if(reset) { i = -1; }
  }
}

var g = f();

g.next() // { value: 0, done: false }
g.next() // { value: 1, done: false }
g.next(true) // { value: 0, done: false }
ä¸Šé¢ä»£ç å…ˆå®šä¹‰äº†ä¸€ä¸ªå¯ä»¥æ— é™è¿è¡Œçš„Generatorå‡½æ•°fï¼Œå¦‚æœnextæ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œæ¯æ¬¡è¿è¡Œåˆ°yieldè¯­å¥ï¼Œå˜é‡resetçš„å€¼æ€»æ˜¯undefinedã€‚å½“nextæ–¹æ³•å¸¦ä¸€ä¸ªå‚æ•°trueæ—¶ï¼Œå½“å‰çš„å˜é‡resetå°±è¢«é‡ç½®ä¸ºè¿™ä¸ªå‚æ•°ï¼ˆå³trueï¼‰ï¼Œå› æ­¤iä¼šç­‰äº-1ï¼Œä¸‹ä¸€è½®å¾ªç¯å°±ä¼šä»-1å¼€å§‹é€’å¢ã€‚

è¿™ä¸ªåŠŸèƒ½æœ‰å¾ˆé‡è¦çš„è¯­æ³•æ„ä¹‰ã€‚Generatorå‡½æ•°ä»æš‚åœçŠ¶æ€åˆ°æ¢å¤è¿è¡Œï¼Œå®ƒçš„ä¸Šä¸‹æ–‡çŠ¶æ€ï¼ˆcontextï¼‰æ˜¯ä¸å˜çš„ã€‚é€šè¿‡nextæ–¹æ³•çš„å‚æ•°ï¼Œå°±æœ‰åŠæ³•åœ¨Generatorå‡½æ•°å¼€å§‹è¿è¡Œä¹‹åï¼Œç»§ç»­å‘å‡½æ•°ä½“å†…éƒ¨æ³¨å…¥å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥åœ¨Generatorå‡½æ•°è¿è¡Œçš„ä¸åŒé˜¶æ®µï¼Œä»å¤–éƒ¨å‘å†…éƒ¨æ³¨å…¥ä¸åŒçš„å€¼ï¼Œä»è€Œè°ƒæ•´å‡½æ•°è¡Œä¸ºã€‚

å†çœ‹ä¸€ä¸ªä¾‹å­ã€‚

function* foo(x) {
  var y = 2 * (yield (x + 1));
  var z = yield (y / 3);
  return (x + y + z);
}

var a = foo(5);
a.next() // Object{value:6, done:false}
a.next() // Object{value:NaN, done:false}
a.next() // Object{value:NaN, done:true}

var b = foo(5);
b.next() // { value:6, done:false }
b.next(12) // { value:8, done:false }
b.next(13) // { value:42, done:true }
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒæ¬¡è¿è¡Œnextæ–¹æ³•çš„æ—¶å€™ä¸å¸¦å‚æ•°ï¼Œå¯¼è‡´yçš„å€¼ç­‰äº2 * undefinedï¼ˆå³NaNï¼‰ï¼Œé™¤ä»¥3ä»¥åè¿˜æ˜¯NaNï¼Œå› æ­¤è¿”å›å¯¹è±¡çš„valueå±æ€§ä¹Ÿç­‰äºNaNã€‚ç¬¬ä¸‰æ¬¡è¿è¡ŒNextæ–¹æ³•çš„æ—¶å€™ä¸å¸¦å‚æ•°ï¼Œæ‰€ä»¥zç­‰äºundefinedï¼Œè¿”å›å¯¹è±¡çš„valueå±æ€§ç­‰äº5 + NaN + undefinedï¼Œå³NaNã€‚

å¦‚æœå‘nextæ–¹æ³•æä¾›å‚æ•°ï¼Œè¿”å›ç»“æœå°±å®Œå…¨ä¸ä¸€æ ·äº†ã€‚ä¸Šé¢ä»£ç ç¬¬ä¸€æ¬¡è°ƒç”¨bçš„nextæ–¹æ³•æ—¶ï¼Œè¿”å›x+1çš„å€¼6ï¼›ç¬¬äºŒæ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œå°†ä¸Šä¸€æ¬¡yieldè¯­å¥çš„å€¼è®¾ä¸º12ï¼Œå› æ­¤yç­‰äº24ï¼Œè¿”å›y / 3çš„å€¼8ï¼›ç¬¬ä¸‰æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œå°†ä¸Šä¸€æ¬¡yieldè¯­å¥çš„å€¼è®¾ä¸º13ï¼Œå› æ­¤zç­‰äº13ï¼Œè¿™æ—¶xç­‰äº5ï¼Œyç­‰äº24ï¼Œæ‰€ä»¥returnè¯­å¥çš„å€¼ç­‰äº42ã€‚

æ³¨æ„ï¼Œç”±äºnextæ–¹æ³•çš„å‚æ•°è¡¨ç¤ºä¸Šä¸€ä¸ªyieldè¯­å¥çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡ä½¿ç”¨nextæ–¹æ³•æ—¶ï¼Œä¸èƒ½å¸¦æœ‰å‚æ•°ã€‚V8å¼•æ“ç›´æ¥å¿½ç•¥ç¬¬ä¸€æ¬¡ä½¿ç”¨nextæ–¹æ³•æ—¶çš„å‚æ•°ï¼Œåªæœ‰ä»ç¬¬äºŒæ¬¡ä½¿ç”¨nextæ–¹æ³•å¼€å§‹ï¼Œå‚æ•°æ‰æ˜¯æœ‰æ•ˆçš„ã€‚ä»è¯­ä¹‰ä¸Šè®²ï¼Œç¬¬ä¸€ä¸ªnextæ–¹æ³•ç”¨æ¥å¯åŠ¨éå†å™¨å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ç”¨å¸¦æœ‰å‚æ•°ã€‚

å¦‚æœæƒ³è¦ç¬¬ä¸€æ¬¡è°ƒç”¨nextæ–¹æ³•æ—¶ï¼Œå°±èƒ½å¤Ÿè¾“å…¥å€¼ï¼Œå¯ä»¥åœ¨Generatorå‡½æ•°å¤–é¢å†åŒ…ä¸€å±‚ã€‚

function wrapper(generatorFunction) {
  return function (...args) {
    let generatorObject = generatorFunction(...args);
    generatorObject.next();
    return generatorObject;
  };
}

const wrapped = wrapper(function* () {
  console.log(`First input: ${yield}`);
  return 'DONE';
});

wrapped().next('hello!')
// First input: hello!
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°å¦‚æœä¸ç”¨wrapperå…ˆåŒ…ä¸€å±‚ï¼Œæ˜¯æ— æ³•ç¬¬ä¸€æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œå°±è¾“å…¥å‚æ•°çš„ã€‚

å†çœ‹ä¸€ä¸ªé€šè¿‡nextæ–¹æ³•çš„å‚æ•°ï¼Œå‘Generatorå‡½æ•°å†…éƒ¨è¾“å…¥å€¼çš„ä¾‹å­ã€‚

function* dataConsumer() {
  console.log('Started');
  console.log(`1. ${yield}`);
  console.log(`2. ${yield}`);
  return 'result';
}

let genObj = dataConsumer();
genObj.next();
// Started
genObj.next('a')
// 1. a
genObj.next('b')
// 2. b
ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªå¾ˆç›´è§‚çš„ä¾‹å­ï¼Œæ¯æ¬¡é€šè¿‡nextæ–¹æ³•å‘Generatorå‡½æ•°è¾“å…¥å€¼ï¼Œç„¶åæ‰“å°å‡ºæ¥ã€‚

for...ofå¾ªç¯
for...ofå¾ªç¯å¯ä»¥è‡ªåŠ¨éå†Generatorå‡½æ•°æ—¶ç”Ÿæˆçš„Iteratorå¯¹è±¡ï¼Œä¸”æ­¤æ—¶ä¸å†éœ€è¦è°ƒç”¨nextæ–¹æ³•ã€‚

function *foo() {
  yield 1;
  yield 2;
  yield 3;
  yield 4;
  yield 5;
  return 6;
}

for (let v of foo()) {
  console.log(v);
}
// 1 2 3 4 5
ä¸Šé¢ä»£ç ä½¿ç”¨for...ofå¾ªç¯ï¼Œä¾æ¬¡æ˜¾ç¤º5ä¸ªyieldè¯­å¥çš„å€¼ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä¸€æ—¦nextæ–¹æ³•çš„è¿”å›å¯¹è±¡çš„doneå±æ€§ä¸ºtrueï¼Œfor...ofå¾ªç¯å°±ä¼šä¸­æ­¢ï¼Œä¸”ä¸åŒ…å«è¯¥è¿”å›å¯¹è±¡ï¼Œæ‰€ä»¥ä¸Šé¢ä»£ç çš„returnè¯­å¥è¿”å›çš„6ï¼Œä¸åŒ…æ‹¬åœ¨for...ofå¾ªç¯ä¹‹ä¸­ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ©ç”¨Generatorå‡½æ•°å’Œfor...ofå¾ªç¯ï¼Œå®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ä¾‹å­ã€‚

function* fibonacci() {
  let [prev, curr] = [0, 1];
  for (;;) {
    [prev, curr] = [curr, prev + curr];
    yield curr;
  }
}

for (let n of fibonacci()) {
  if (n > 1000) break;
  console.log(n);
}
ä»ä¸Šé¢ä»£ç å¯è§ï¼Œä½¿ç”¨for...ofè¯­å¥æ—¶ä¸éœ€è¦ä½¿ç”¨nextæ–¹æ³•ã€‚

åˆ©ç”¨for...ofå¾ªç¯ï¼Œå¯ä»¥å†™å‡ºéå†ä»»æ„å¯¹è±¡ï¼ˆobjectï¼‰çš„æ–¹æ³•ã€‚åŸç”Ÿçš„JavaScriptå¯¹è±¡æ²¡æœ‰éå†æ¥å£ï¼Œæ— æ³•ä½¿ç”¨for...ofå¾ªç¯ï¼Œé€šè¿‡Generatorå‡½æ•°ä¸ºå®ƒåŠ ä¸Šè¿™ä¸ªæ¥å£ï¼Œå°±å¯ä»¥ç”¨äº†ã€‚

function* objectEntries(obj) {
  let propKeys = Reflect.ownKeys(obj);

  for (let propKey of propKeys) {
    yield [propKey, obj[propKey]];
  }
}

let jane = { first: 'Jane', last: 'Doe' };

for (let [key, value] of objectEntries(jane)) {
  console.log(`${key}: ${value}`);
}
// first: Jane
// last: Doe
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯¹è±¡janeåŸç”Ÿä¸å…·å¤‡Iteratoræ¥å£ï¼Œæ— æ³•ç”¨for...oféå†ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡Generatorå‡½æ•°objectEntriesä¸ºå®ƒåŠ ä¸Šéå†å™¨æ¥å£ï¼Œå°±å¯ä»¥ç”¨for...oféå†äº†ã€‚åŠ ä¸Šéå†å™¨æ¥å£çš„å¦ä¸€ç§å†™æ³•æ˜¯ï¼Œå°†Generatorå‡½æ•°åŠ åˆ°å¯¹è±¡çš„Symbol.iteratorå±æ€§ä¸Šé¢ã€‚

function* objectEntries() {
  let propKeys = Object.keys(this);

  for (let propKey of propKeys) {
    yield [propKey, this[propKey]];
  }
}

let jane = { first: 'Jane', last: 'Doe' };

jane[Symbol.iterator] = objectEntries;

for (let [key, value] of jane) {
  console.log(`${key}: ${value}`);
}
// first: Jane
// last: Doe
é™¤äº†for...ofå¾ªç¯ä»¥å¤–ï¼Œæ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰ã€è§£æ„èµ‹å€¼å’ŒArray.fromæ–¹æ³•å†…éƒ¨è°ƒç”¨çš„ï¼Œéƒ½æ˜¯éå†å™¨æ¥å£ã€‚è¿™æ„å‘³ç€ï¼Œå®ƒä»¬éƒ½å¯ä»¥å°†Generatorå‡½æ•°è¿”å›çš„Iteratorå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ã€‚

function* numbers () {
  yield 1
  yield 2
  return 3
  yield 4
}

// æ‰©å±•è¿ç®—ç¬¦
[...numbers()] // [1, 2]

// Array.from æ–¹æ³•
Array.from(numbers()) // [1, 2]

// è§£æ„èµ‹å€¼
let [x, y] = numbers();
x // 1
y // 2

// for...of å¾ªç¯
for (let n of numbers()) {
  console.log(n)
}
// 1
// 2
Generator.prototype.throw()
Generatorå‡½æ•°è¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œéƒ½æœ‰ä¸€ä¸ªthrowæ–¹æ³•ï¼Œå¯ä»¥åœ¨å‡½æ•°ä½“å¤–æŠ›å‡ºé”™è¯¯ï¼Œç„¶ååœ¨Generatorå‡½æ•°ä½“å†…æ•è·ã€‚

var g = function* () {
  try {
    yield;
  } catch (e) {
    console.log('å†…éƒ¨æ•è·', e);
  }
};

var i = g();
i.next();

try {
  i.throw('a');
  i.throw('b');
} catch (e) {
  console.log('å¤–éƒ¨æ•è·', e);
}
// å†…éƒ¨æ•è· a
// å¤–éƒ¨æ•è· b
ä¸Šé¢ä»£ç ä¸­ï¼Œéå†å™¨å¯¹è±¡iè¿ç»­æŠ›å‡ºä¸¤ä¸ªé”™è¯¯ã€‚ç¬¬ä¸€ä¸ªé”™è¯¯è¢«Generatorå‡½æ•°ä½“å†…çš„catchè¯­å¥æ•è·ã€‚iç¬¬äºŒæ¬¡æŠ›å‡ºé”™è¯¯ï¼Œç”±äºGeneratorå‡½æ•°å†…éƒ¨çš„catchè¯­å¥å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œä¸ä¼šå†æ•æ‰åˆ°è¿™ä¸ªé”™è¯¯äº†ï¼Œæ‰€ä»¥è¿™ä¸ªé”™è¯¯å°±è¢«æŠ›å‡ºäº†Generatorå‡½æ•°ä½“ï¼Œè¢«å‡½æ•°ä½“å¤–çš„catchè¯­å¥æ•è·ã€‚

throwæ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°ä¼šè¢«catchè¯­å¥æ¥æ”¶ï¼Œå»ºè®®æŠ›å‡ºErrorå¯¹è±¡çš„å®ä¾‹ã€‚

var g = function* () {
  try {
    yield;
  } catch (e) {
    console.log(e);
  }
};

var i = g();
i.next();
i.throw(new Error('å‡ºé”™äº†ï¼'));
// Error: å‡ºé”™äº†ï¼(â€¦)
æ³¨æ„ï¼Œä¸è¦æ··æ·†éå†å™¨å¯¹è±¡çš„throwæ–¹æ³•å’Œå…¨å±€çš„throwå‘½ä»¤ã€‚ä¸Šé¢ä»£ç çš„é”™è¯¯ï¼Œæ˜¯ç”¨éå†å™¨å¯¹è±¡çš„throwæ–¹æ³•æŠ›å‡ºçš„ï¼Œè€Œä¸æ˜¯ç”¨throwå‘½ä»¤æŠ›å‡ºçš„ã€‚åè€…åªèƒ½è¢«å‡½æ•°ä½“å¤–çš„catchè¯­å¥æ•è·ã€‚

var g = function* () {
  while (true) {
    try {
      yield;
    } catch (e) {
      if (e != 'a') throw e;
      console.log('å†…éƒ¨æ•è·', e);
    }
  }
};

var i = g();
i.next();

try {
  throw new Error('a');
  throw new Error('b');
} catch (e) {
  console.log('å¤–éƒ¨æ•è·', e);
}
// å¤–éƒ¨æ•è· [Error: a]
ä¸Šé¢ä»£ç ä¹‹æ‰€ä»¥åªæ•è·äº†aï¼Œæ˜¯å› ä¸ºå‡½æ•°ä½“å¤–çš„catchè¯­å¥å—ï¼Œæ•è·äº†æŠ›å‡ºçš„aé”™è¯¯ä»¥åï¼Œå°±ä¸ä¼šå†ç»§ç»­tryä»£ç å—é‡Œé¢å‰©ä½™çš„è¯­å¥äº†ã€‚

å¦‚æœGeneratorå‡½æ•°å†…éƒ¨æ²¡æœ‰éƒ¨ç½²try...catchä»£ç å—ï¼Œé‚£ä¹ˆthrowæ–¹æ³•æŠ›å‡ºçš„é”™è¯¯ï¼Œå°†è¢«å¤–éƒ¨try...catchä»£ç å—æ•è·ã€‚

var g = function* () {
  while (true) {
    yield;
    console.log('å†…éƒ¨æ•è·', e);
  }
};

var i = g();
i.next();

try {
  i.throw('a');
  i.throw('b');
} catch (e) {
  console.log('å¤–éƒ¨æ•è·', e);
}
// å¤–éƒ¨æ•è· a
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°gå†…éƒ¨æ²¡æœ‰éƒ¨ç½²try...catchä»£ç å—ï¼Œæ‰€ä»¥æŠ›å‡ºçš„é”™è¯¯ç›´æ¥è¢«å¤–éƒ¨catchä»£ç å—æ•è·ã€‚

å¦‚æœGeneratorå‡½æ•°å†…éƒ¨å’Œå¤–éƒ¨ï¼Œéƒ½æ²¡æœ‰éƒ¨ç½²try...catchä»£ç å—ï¼Œé‚£ä¹ˆç¨‹åºå°†æŠ¥é”™ï¼Œç›´æ¥ä¸­æ–­æ‰§è¡Œã€‚

var gen = function* gen(){
  yield console.log('hello');
  yield console.log('world');
}

var g = gen();
g.next();
g.throw();
// hello
// Uncaught undefined
ä¸Šé¢ä»£ç ä¸­ï¼Œg.throwæŠ›å‡ºé”™è¯¯ä»¥åï¼Œæ²¡æœ‰ä»»ä½•try...catchä»£ç å—å¯ä»¥æ•è·è¿™ä¸ªé”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºæŠ¥é”™ï¼Œä¸­æ–­æ‰§è¡Œã€‚

throwæ–¹æ³•è¢«æ•è·ä»¥åï¼Œä¼šé™„å¸¦æ‰§è¡Œä¸‹ä¸€æ¡yieldè¯­å¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šé™„å¸¦æ‰§è¡Œä¸€æ¬¡nextæ–¹æ³•ã€‚

var gen = function* gen(){
  try {
    yield console.log('a');
  } catch (e) {
    // ...
  }
  yield console.log('b');
  yield console.log('c');
}

var g = gen();
g.next() // a
g.throw() // b
g.next() // c
ä¸Šé¢ä»£ç ä¸­ï¼Œg.throwæ–¹æ³•è¢«æ•è·ä»¥åï¼Œè‡ªåŠ¨æ‰§è¡Œäº†ä¸€æ¬¡nextæ–¹æ³•ï¼Œæ‰€ä»¥ä¼šæ‰“å°bã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåªè¦Generatorå‡½æ•°å†…éƒ¨éƒ¨ç½²äº†try...catchä»£ç å—ï¼Œé‚£ä¹ˆéå†å™¨çš„throwæ–¹æ³•æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸å½±å“ä¸‹ä¸€æ¬¡éå†ã€‚

å¦å¤–ï¼Œthrowå‘½ä»¤ä¸g.throwæ–¹æ³•æ˜¯æ— å…³çš„ï¼Œä¸¤è€…äº’ä¸å½±å“ã€‚

var gen = function* gen(){
  yield console.log('hello');
  yield console.log('world');
}

var g = gen();
g.next();

try {
  throw new Error();
} catch (e) {
  g.next();
}
// hello
// world
ä¸Šé¢ä»£ç ä¸­ï¼Œthrowå‘½ä»¤æŠ›å‡ºçš„é”™è¯¯ä¸ä¼šå½±å“åˆ°éå†å™¨çš„çŠ¶æ€ï¼Œæ‰€ä»¥ä¸¤æ¬¡æ‰§è¡Œnextæ–¹æ³•ï¼Œéƒ½è¿›è¡Œäº†æ­£ç¡®çš„æ“ä½œã€‚

è¿™ç§å‡½æ•°ä½“å†…æ•è·é”™è¯¯çš„æœºåˆ¶ï¼Œå¤§å¤§æ–¹ä¾¿äº†å¯¹é”™è¯¯çš„å¤„ç†ã€‚å¤šä¸ªyieldè¯­å¥ï¼Œå¯ä»¥åªç”¨ä¸€ä¸ªtry...catchä»£ç å—æ¥æ•è·é”™è¯¯ã€‚å¦‚æœä½¿ç”¨å›è°ƒå‡½æ•°çš„å†™æ³•ï¼Œæƒ³è¦æ•è·å¤šä¸ªé”™è¯¯ï¼Œå°±ä¸å¾—ä¸ä¸ºæ¯ä¸ªå‡½æ•°å†…éƒ¨å†™ä¸€ä¸ªé”™è¯¯å¤„ç†è¯­å¥ï¼Œç°åœ¨åªåœ¨Generatorå‡½æ•°å†…éƒ¨å†™ä¸€æ¬¡catchè¯­å¥å°±å¯ä»¥äº†ã€‚

Generatorå‡½æ•°ä½“å¤–æŠ›å‡ºçš„é”™è¯¯ï¼Œå¯ä»¥åœ¨å‡½æ•°ä½“å†…æ•è·ï¼›åè¿‡æ¥ï¼ŒGeneratorå‡½æ•°ä½“å†…æŠ›å‡ºçš„é”™è¯¯ï¼Œä¹Ÿå¯ä»¥è¢«å‡½æ•°ä½“å¤–çš„catchæ•è·ã€‚

function *foo() {
  var x = yield 3;
  var y = x.toUpperCase();
  yield y;
}

var it = foo();

it.next(); // { value:3, done:false }

try {
  it.next(42);
} catch (err) {
  console.log(err);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒä¸ªnextæ–¹æ³•å‘å‡½æ•°ä½“å†…ä¼ å…¥ä¸€ä¸ªå‚æ•°42ï¼Œæ•°å€¼æ˜¯æ²¡æœ‰toUpperCaseæ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¼šæŠ›å‡ºä¸€ä¸ªTypeErroré”™è¯¯ï¼Œè¢«å‡½æ•°ä½“å¤–çš„catchæ•è·ã€‚

ä¸€æ—¦Generatoræ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºé”™è¯¯ï¼Œä¸”æ²¡æœ‰è¢«å†…éƒ¨æ•è·ï¼Œå°±ä¸ä¼šå†æ‰§è¡Œä¸‹å»äº†ã€‚å¦‚æœæ­¤åè¿˜è°ƒç”¨nextæ–¹æ³•ï¼Œå°†è¿”å›ä¸€ä¸ªvalueå±æ€§ç­‰äºundefinedã€doneå±æ€§ç­‰äºtrueçš„å¯¹è±¡ï¼Œå³JavaScriptå¼•æ“è®¤ä¸ºè¿™ä¸ªGeneratorå·²ç»è¿è¡Œç»“æŸäº†ã€‚

function* g() {
  yield 1;
  console.log('throwing an exception');
  throw new Error('generator broke!');
  yield 2;
  yield 3;
}

function log(generator) {
  var v;
  console.log('starting generator');
  try {
    v = generator.next();
    console.log('ç¬¬ä¸€æ¬¡è¿è¡Œnextæ–¹æ³•', v);
  } catch (err) {
    console.log('æ•æ‰é”™è¯¯', v);
  }
  try {
    v = generator.next();
    console.log('ç¬¬äºŒæ¬¡è¿è¡Œnextæ–¹æ³•', v);
  } catch (err) {
    console.log('æ•æ‰é”™è¯¯', v);
  }
  try {
    v = generator.next();
    console.log('ç¬¬ä¸‰æ¬¡è¿è¡Œnextæ–¹æ³•', v);
  } catch (err) {
    console.log('æ•æ‰é”™è¯¯', v);
  }
  console.log('caller done');
}

log(g());
// starting generator
// ç¬¬ä¸€æ¬¡è¿è¡Œnextæ–¹æ³• { value: 1, done: false }
// throwing an exception
// æ•æ‰é”™è¯¯ { value: 1, done: false }
// ç¬¬ä¸‰æ¬¡è¿è¡Œnextæ–¹æ³• { value: undefined, done: true }
// caller done
ä¸Šé¢ä»£ç ä¸€å…±ä¸‰æ¬¡è¿è¡Œnextæ–¹æ³•ï¼Œç¬¬äºŒæ¬¡è¿è¡Œçš„æ—¶å€™ä¼šæŠ›å‡ºé”™è¯¯ï¼Œç„¶åç¬¬ä¸‰æ¬¡è¿è¡Œçš„æ—¶å€™ï¼ŒGeneratorå‡½æ•°å°±å·²ç»ç»“æŸäº†ï¼Œä¸å†æ‰§è¡Œä¸‹å»äº†ã€‚

Generator.prototype.return()
Generatorå‡½æ•°è¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œè¿˜æœ‰ä¸€ä¸ªreturnæ–¹æ³•ï¼Œå¯ä»¥è¿”å›ç»™å®šçš„å€¼ï¼Œå¹¶ä¸”ç»ˆç»“éå†Generatorå‡½æ•°ã€‚

function* gen() {
  yield 1;
  yield 2;
  yield 3;
}

var g = gen();

g.next()        // { value: 1, done: false }
g.return('foo') // { value: "foo", done: true }
g.next()        // { value: undefined, done: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œéå†å™¨å¯¹è±¡gè°ƒç”¨returnæ–¹æ³•åï¼Œè¿”å›å€¼çš„valueå±æ€§å°±æ˜¯returnæ–¹æ³•çš„å‚æ•°fooã€‚å¹¶ä¸”ï¼ŒGeneratorå‡½æ•°çš„éå†å°±ç»ˆæ­¢äº†ï¼Œè¿”å›å€¼çš„doneå±æ€§ä¸ºtrueï¼Œä»¥åå†è°ƒç”¨nextæ–¹æ³•ï¼Œdoneå±æ€§æ€»æ˜¯è¿”å›trueã€‚

å¦‚æœreturnæ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¸æä¾›å‚æ•°ï¼Œåˆ™è¿”å›å€¼çš„valueå±æ€§ä¸ºundefinedã€‚

function* gen() {
  yield 1;
  yield 2;
  yield 3;
}

var g = gen();

g.next()        // { value: 1, done: false }
g.return() // { value: undefined, done: true }
å¦‚æœGeneratorå‡½æ•°å†…éƒ¨æœ‰try...finallyä»£ç å—ï¼Œé‚£ä¹ˆreturnæ–¹æ³•ä¼šæ¨è¿Ÿåˆ°finallyä»£ç å—æ‰§è¡Œå®Œå†æ‰§è¡Œã€‚

function* numbers () {
  yield 1;
  try {
    yield 2;
    yield 3;
  } finally {
    yield 4;
    yield 5;
  }
  yield 6;
}
var g = numbers()
g.next() // { done: false, value: 1 }
g.next() // { done: false, value: 2 }
g.return(7) // { done: false, value: 4 }
g.next() // { done: false, value: 5 }
g.next() // { done: true, value: 7 }
ä¸Šé¢ä»£ç ä¸­ï¼Œè°ƒç”¨returnæ–¹æ³•åï¼Œå°±å¼€å§‹æ‰§è¡Œfinallyä»£ç å—ï¼Œç„¶åç­‰åˆ°finallyä»£ç å—æ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œreturnæ–¹æ³•ã€‚

yield*è¯­å¥
å¦‚æœåœ¨Generaterå‡½æ•°å†…éƒ¨ï¼Œè°ƒç”¨å¦ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚

function* foo() {
  yield 'a';
  yield 'b';
}

function* bar() {
  yield 'x';
  foo();
  yield 'y';
}

for (let v of bar()){
  console.log(v);
}
// "x"
// "y"
ä¸Šé¢ä»£ç ä¸­ï¼Œfooå’Œbaréƒ½æ˜¯Generatorå‡½æ•°ï¼Œåœ¨baré‡Œé¢è°ƒç”¨fooï¼Œæ˜¯ä¸ä¼šæœ‰æ•ˆæœçš„ã€‚

è¿™ä¸ªå°±éœ€è¦ç”¨åˆ°yield*è¯­å¥ï¼Œç”¨æ¥åœ¨ä¸€ä¸ªGeneratorå‡½æ•°é‡Œé¢æ‰§è¡Œå¦ä¸€ä¸ªGeneratorå‡½æ•°ã€‚

function* bar() {
  yield 'x';
  yield* foo();
  yield 'y';
}

// ç­‰åŒäº
function* bar() {
  yield 'x';
  yield 'a';
  yield 'b';
  yield 'y';
}

// ç­‰åŒäº
function* bar() {
  yield 'x';
  for (let v of foo()) {
    yield v;
  }
  yield 'y';
}

for (let v of bar()){
  console.log(v);
}
// "x"
// "a"
// "b"
// "y"
å†æ¥çœ‹ä¸€ä¸ªå¯¹æ¯”çš„ä¾‹å­ã€‚

function* inner() {
  yield 'hello!';
}

function* outer1() {
  yield 'open';
  yield inner();
  yield 'close';
}

var gen = outer1()
gen.next().value // "open"
gen.next().value // è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡
gen.next().value // "close"

function* outer2() {
  yield 'open'
  yield* inner()
  yield 'close'
}

var gen = outer2()
gen.next().value // "open"
gen.next().value // "hello!"
gen.next().value // "close"
ä¸Šé¢ä¾‹å­ä¸­ï¼Œouter2ä½¿ç”¨äº†yield*ï¼Œouter1æ²¡ä½¿ç”¨ã€‚ç»“æœå°±æ˜¯ï¼Œouter1è¿”å›ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œouter2è¿”å›è¯¥éå†å™¨å¯¹è±¡çš„å†…éƒ¨å€¼ã€‚

ä»è¯­æ³•è§’åº¦çœ‹ï¼Œå¦‚æœyieldå‘½ä»¤åé¢è·Ÿçš„æ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ï¼Œéœ€è¦åœ¨yieldå‘½ä»¤åé¢åŠ ä¸Šæ˜Ÿå·ï¼Œè¡¨æ˜å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚è¿™è¢«ç§°ä¸ºyield*è¯­å¥ã€‚

let delegatedIterator = (function* () {
  yield 'Hello!';
  yield 'Bye!';
}());

let delegatingIterator = (function* () {
  yield 'Greetings!';
  yield* delegatedIterator;
  yield 'Ok, bye.';
}());

for(let value of delegatingIterator) {
  console.log(value);
}
// "Greetings!
// "Hello!"
// "Bye!"
// "Ok, bye."
ä¸Šé¢ä»£ç ä¸­ï¼ŒdelegatingIteratoræ˜¯ä»£ç†è€…ï¼ŒdelegatedIteratoræ˜¯è¢«ä»£ç†è€…ã€‚ç”±äºyield* delegatedIteratorè¯­å¥å¾—åˆ°çš„å€¼ï¼Œæ˜¯ä¸€ä¸ªéå†å™¨ï¼Œæ‰€ä»¥è¦ç”¨æ˜Ÿå·è¡¨ç¤ºã€‚è¿è¡Œç»“æœå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªéå†å™¨ï¼Œéå†äº†å¤šä¸ªGeneratorå‡½æ•°ï¼Œæœ‰é€’å½’çš„æ•ˆæœã€‚

yield*åé¢çš„Generatorå‡½æ•°ï¼ˆæ²¡æœ‰returnè¯­å¥æ—¶ï¼‰ï¼Œç­‰åŒäºåœ¨Generatorå‡½æ•°å†…éƒ¨ï¼Œéƒ¨ç½²ä¸€ä¸ªfor...ofå¾ªç¯ã€‚

function* concat(iter1, iter2) {
  yield* iter1;
  yield* iter2;
}

// ç­‰åŒäº

function* concat(iter1, iter2) {
  for (var value of iter1) {
    yield value;
  }
  for (var value of iter2) {
    yield value;
  }
}
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œyield*åé¢çš„Generatorå‡½æ•°ï¼ˆæ²¡æœ‰returnè¯­å¥æ—¶ï¼‰ï¼Œä¸è¿‡æ˜¯for...ofçš„ä¸€ç§ç®€å†™å½¢å¼ï¼Œå®Œå…¨å¯ä»¥ç”¨åè€…æ›¿ä»£å‰è€…ã€‚åä¹‹ï¼Œåˆ™éœ€è¦ç”¨var value = yield* iteratorçš„å½¢å¼è·å–returnè¯­å¥çš„å€¼ã€‚

å¦‚æœyield*åé¢è·Ÿç€ä¸€ä¸ªæ•°ç»„ï¼Œç”±äºæ•°ç»„åŸç”Ÿæ”¯æŒéå†å™¨ï¼Œå› æ­¤å°±ä¼šéå†æ•°ç»„æˆå‘˜ã€‚

function* gen(){
  yield* ["a", "b", "c"];
}

gen().next() // { value:"a", done:false }
ä¸Šé¢ä»£ç ä¸­ï¼Œyieldå‘½ä»¤åé¢å¦‚æœä¸åŠ æ˜Ÿå·ï¼Œè¿”å›çš„æ˜¯æ•´ä¸ªæ•°ç»„ï¼ŒåŠ äº†æ˜Ÿå·å°±è¡¨ç¤ºè¿”å›çš„æ˜¯æ•°ç»„çš„éå†å™¨å¯¹è±¡ã€‚

å®é™…ä¸Šï¼Œä»»ä½•æ•°æ®ç»“æ„åªè¦æœ‰Iteratoræ¥å£ï¼Œå°±å¯ä»¥è¢«yield*éå†ã€‚

let read = (function* () {
  yield 'hello';
  yield* 'hello';
})();

read.next().value // "hello"
read.next().value // "h"
ä¸Šé¢ä»£ç ä¸­ï¼Œyieldè¯­å¥è¿”å›æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œyield*è¯­å¥è¿”å›å•ä¸ªå­—ç¬¦ã€‚å› ä¸ºå­—ç¬¦ä¸²å…·æœ‰Iteratoræ¥å£ï¼Œæ‰€ä»¥è¢«yield*éå†ã€‚

å¦‚æœè¢«ä»£ç†çš„Generatorå‡½æ•°æœ‰returnè¯­å¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‘ä»£ç†å®ƒçš„Generatorå‡½æ•°è¿”å›æ•°æ®ã€‚

function *foo() {
  yield 2;
  yield 3;
  return "foo";
}

function *bar() {
  yield 1;
  var v = yield *foo();
  console.log( "v: " + v );
  yield 4;
}

var it = bar();

it.next()
// {value: 1, done: false}
it.next()
// {value: 2, done: false}
it.next()
// {value: 3, done: false}
it.next();
// "v: foo"
// {value: 4, done: false}
it.next()
// {value: undefined, done: true}
ä¸Šé¢ä»£ç åœ¨ç¬¬å››æ¬¡è°ƒç”¨nextæ–¹æ³•çš„æ—¶å€™ï¼Œå±å¹•ä¸Šä¼šæœ‰è¾“å‡ºï¼Œè¿™æ˜¯å› ä¸ºå‡½æ•°fooçš„returnè¯­å¥ï¼Œå‘å‡½æ•°baræä¾›äº†è¿”å›å€¼ã€‚

å†çœ‹ä¸€ä¸ªä¾‹å­ã€‚

function* genFuncWithReturn() {
  yield 'a';
  yield 'b';
  return 'The result';
}
function* logReturned(genObj) {
  let result = yield* genObj;
  console.log(result);
}

[...logReturned(genFuncWithReturn())]
// The result
// å€¼ä¸º [ 'a', 'b' ]
ä¸Šé¢ä»£ç ä¸­ï¼Œå­˜åœ¨ä¸¤æ¬¡éå†ã€‚ç¬¬ä¸€æ¬¡æ˜¯æ‰©å±•è¿ç®—ç¬¦éå†å‡½æ•°logReturnedè¿”å›çš„éå†å™¨å¯¹è±¡ï¼Œç¬¬äºŒæ¬¡æ˜¯yield*è¯­å¥éå†å‡½æ•°genFuncWithReturnè¿”å›çš„éå†å™¨å¯¹è±¡ã€‚è¿™ä¸¤æ¬¡éå†çš„æ•ˆæœæ˜¯å åŠ çš„ï¼Œæœ€ç»ˆè¡¨ç°ä¸ºæ‰©å±•è¿ç®—ç¬¦éå†å‡½æ•°genFuncWithReturnè¿”å›çš„éå†å™¨å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œæœ€åçš„æ•°æ®è¡¨è¾¾å¼å¾—åˆ°çš„å€¼ç­‰äº[ 'a', 'b' ]ã€‚ä½†æ˜¯ï¼Œå‡½æ•°genFuncWithReturnçš„returnè¯­å¥çš„è¿”å›å€¼The resultï¼Œä¼šè¿”å›ç»™å‡½æ•°logReturnedå†…éƒ¨çš„resultå˜é‡ï¼Œå› æ­¤ä¼šæœ‰ç»ˆç«¯è¾“å‡ºã€‚

yield*å‘½ä»¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å–å‡ºåµŒå¥—æ•°ç»„çš„æ‰€æœ‰æˆå‘˜ã€‚

function* iterTree(tree) {
  if (Array.isArray(tree)) {
    for(let i=0; i < tree.length; i++) {
      yield* iterTree(tree[i]);
    }
  } else {
    yield tree;
  }
}

const tree = [ 'a', ['b', 'c'], ['d', 'e'] ];

for(let x of iterTree(tree)) {
  console.log(x);
}
// a
// b
// c
// d
// e
ä¸‹é¢æ˜¯ä¸€ä¸ªç¨å¾®å¤æ‚çš„ä¾‹å­ï¼Œä½¿ç”¨yield*è¯­å¥éå†å®Œå…¨äºŒå‰æ ‘ã€‚

// ä¸‹é¢æ˜¯äºŒå‰æ ‘çš„æ„é€ å‡½æ•°ï¼Œ
// ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯å·¦æ ‘ã€å½“å‰èŠ‚ç‚¹å’Œå³æ ‘
function Tree(left, label, right) {
  this.left = left;
  this.label = label;
  this.right = right;
}

// ä¸‹é¢æ˜¯ä¸­åºï¼ˆinorderï¼‰éå†å‡½æ•°ã€‚
// ç”±äºè¿”å›çš„æ˜¯ä¸€ä¸ªéå†å™¨ï¼Œæ‰€ä»¥è¦ç”¨generatorå‡½æ•°ã€‚
// å‡½æ•°ä½“å†…é‡‡ç”¨é€’å½’ç®—æ³•ï¼Œæ‰€ä»¥å·¦æ ‘å’Œå³æ ‘è¦ç”¨yield*éå†
function* inorder(t) {
  if (t) {
    yield* inorder(t.left);
    yield t.label;
    yield* inorder(t.right);
  }
}

// ä¸‹é¢ç”ŸæˆäºŒå‰æ ‘
function make(array) {
  // åˆ¤æ–­æ˜¯å¦ä¸ºå¶èŠ‚ç‚¹
  if (array.length == 1) return new Tree(null, array[0], null);
  return new Tree(make(array[0]), array[1], make(array[2]));
}
let tree = make([[['a'], 'b', ['c']], 'd', [['e'], 'f', ['g']]]);

// éå†äºŒå‰æ ‘
var result = [];
for (let node of inorder(tree)) {
  result.push(node);
}

result
// ['a', 'b', 'c', 'd', 'e', 'f', 'g']
ä½œä¸ºå¯¹è±¡å±æ€§çš„Generatorå‡½æ•°
å¦‚æœä¸€ä¸ªå¯¹è±¡çš„å±æ€§æ˜¯Generatorå‡½æ•°ï¼Œå¯ä»¥ç®€å†™æˆä¸‹é¢çš„å½¢å¼ã€‚

let obj = {
  * myGeneratorMethod() {
    Â·Â·Â·
  }
};
ä¸Šé¢ä»£ç ä¸­ï¼ŒmyGeneratorMethodå±æ€§å‰é¢æœ‰ä¸€ä¸ªæ˜Ÿå·ï¼Œè¡¨ç¤ºè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ã€‚

å®ƒçš„å®Œæ•´å½¢å¼å¦‚ä¸‹ï¼Œä¸ä¸Šé¢çš„å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚

let obj = {
  myGeneratorMethod: function* () {
    // Â·Â·Â·
  }
};
Generatorå‡½æ•°çš„this
Generatorå‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ªéå†å™¨ï¼ŒES6è§„å®šè¿™ä¸ªéå†å™¨æ˜¯Generatorå‡½æ•°çš„å®ä¾‹ï¼Œä¹Ÿç»§æ‰¿äº†Generatorå‡½æ•°çš„prototypeå¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚

function* g() {}

g.prototype.hello = function () {
  return 'hi!';
};

let obj = g();

obj instanceof g // true
obj.hello() // 'hi!'
ä¸Šé¢ä»£ç è¡¨æ˜ï¼ŒGeneratorå‡½æ•°gè¿”å›çš„éå†å™¨objï¼Œæ˜¯gçš„å®ä¾‹ï¼Œè€Œä¸”ç»§æ‰¿äº†g.prototypeã€‚ä½†æ˜¯ï¼Œå¦‚æœæŠŠgå½“ä½œæ™®é€šçš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºgè¿”å›çš„æ€»æ˜¯éå†å™¨å¯¹è±¡ï¼Œè€Œä¸æ˜¯thiså¯¹è±¡ã€‚

function* g() {
  this.a = 11;
}

let obj = g();
obj.a // undefined
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°gåœ¨thiså¯¹è±¡ä¸Šé¢æ·»åŠ äº†ä¸€ä¸ªå±æ€§aï¼Œä½†æ˜¯objå¯¹è±¡æ‹¿ä¸åˆ°è¿™ä¸ªå±æ€§ã€‚

Generatorå‡½æ•°ä¹Ÿä¸èƒ½è·Ÿnewå‘½ä»¤ä¸€èµ·ç”¨ï¼Œä¼šæŠ¥é”™ã€‚

function* F() {
  yield this.x = 2;
  yield this.y = 3;
}

new F()
// TypeError: F is not a constructor
ä¸Šé¢ä»£ç ä¸­ï¼Œnewå‘½ä»¤è·Ÿæ„é€ å‡½æ•°Fä¸€èµ·ä½¿ç”¨ï¼Œç»“æœæŠ¥é”™ï¼Œå› ä¸ºFä¸æ˜¯æ„é€ å‡½æ•°ã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰åŠæ³•è®©Generatorå‡½æ•°è¿”å›ä¸€ä¸ªæ­£å¸¸çš„å¯¹è±¡å®ä¾‹ï¼Œæ—¢å¯ä»¥ç”¨nextæ–¹æ³•ï¼Œåˆå¯ä»¥è·å¾—æ­£å¸¸çš„thisï¼Ÿ

ä¸‹é¢æ˜¯ä¸€ä¸ªå˜é€šæ–¹æ³•ã€‚é¦–å…ˆï¼Œç”Ÿæˆä¸€ä¸ªç©ºå¯¹è±¡ï¼Œä½¿ç”¨callæ–¹æ³•ç»‘å®šGeneratorå‡½æ•°å†…éƒ¨çš„thisã€‚è¿™æ ·ï¼Œæ„é€ å‡½æ•°è°ƒç”¨ä»¥åï¼Œè¿™ä¸ªç©ºå¯¹è±¡å°±æ˜¯Generatorå‡½æ•°çš„å®ä¾‹å¯¹è±¡äº†ã€‚

function* F() {
  this.a = 1;
  yield this.b = 2;
  yield this.c = 3;
}
var obj = {};
var f = F.call(obj);

f.next();  // Object {value: 2, done: false}
f.next();  // Object {value: 3, done: false}
f.next();  // Object {value: undefined, done: true}

obj.a // 1
obj.b // 2
obj.c // 3
ä¸Šé¢ä»£ç ä¸­ï¼Œé¦–å…ˆæ˜¯Få†…éƒ¨çš„thiså¯¹è±¡ç»‘å®šobjå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒï¼Œè¿”å›ä¸€ä¸ªIteratorå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æ‰§è¡Œä¸‰æ¬¡nextæ–¹æ³•ï¼ˆå› ä¸ºFå†…éƒ¨æœ‰ä¸¤ä¸ªyieldè¯­å¥ï¼‰ï¼Œå®ŒæˆFå†…éƒ¨æ‰€æœ‰ä»£ç çš„è¿è¡Œã€‚è¿™æ—¶ï¼Œæ‰€æœ‰å†…éƒ¨å±æ€§éƒ½ç»‘å®šåœ¨objå¯¹è±¡ä¸Šäº†ï¼Œå› æ­¤objå¯¹è±¡ä¹Ÿå°±æˆäº†Fçš„å®ä¾‹ã€‚

ä¸Šé¢ä»£ç ä¸­ï¼Œæ‰§è¡Œçš„æ˜¯éå†å™¨å¯¹è±¡fï¼Œä½†æ˜¯ç”Ÿæˆçš„å¯¹è±¡å®ä¾‹æ˜¯objï¼Œæœ‰æ²¡æœ‰åŠæ³•å°†è¿™ä¸¤ä¸ªå¯¹è±¡ç»Ÿä¸€å‘¢ï¼Ÿ

ä¸€ä¸ªåŠæ³•å°±æ˜¯å°†objæ¢æˆF.prototypeã€‚

function* F() {
  this.a = 1;
  yield this.b = 2;
  yield this.c = 3;
}
var f = F.call(F.prototype);

f.next();  // Object {value: 2, done: false}
f.next();  // Object {value: 3, done: false}
f.next();  // Object {value: undefined, done: true}

f.a // 1
f.b // 2
f.c // 3
å†å°†Fæ”¹æˆæ„é€ å‡½æ•°ï¼Œå°±å¯ä»¥å¯¹å®ƒæ‰§è¡Œnewå‘½ä»¤äº†ã€‚

function* gen() {
  this.a = 1;
  yield this.b = 2;
  yield this.c = 3;
}

function F() {
  return gen.call(gen.prototype);
}

var f = new F();

f.next();  // Object {value: 2, done: false}
f.next();  // Object {value: 3, done: false}
f.next();  // Object {value: undefined, done: true}

f.a // 1
f.b // 2
f.c // 3
å«ä¹‰
Generatorä¸çŠ¶æ€æœº
Generatoræ˜¯å®ç°çŠ¶æ€æœºçš„æœ€ä½³ç»“æ„ã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„clockå‡½æ•°å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºã€‚

var ticking = true;
var clock = function() {
  if (ticking)
    console.log('Tick!');
  else
    console.log('Tock!');
  ticking = !ticking;
}
ä¸Šé¢ä»£ç çš„clockå‡½æ•°ä¸€å…±æœ‰ä¸¤ç§çŠ¶æ€ï¼ˆTickå’ŒTockï¼‰ï¼Œæ¯è¿è¡Œä¸€æ¬¡ï¼Œå°±æ”¹å˜ä¸€æ¬¡çŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°å¦‚æœç”¨Generatorå®ç°ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚

var clock = function*() {
  while (true) {
    console.log('Tick!');
    yield;
    console.log('Tock!');
    yield;
  }
};
ä¸Šé¢çš„Generatorå®ç°ä¸ES5å®ç°å¯¹æ¯”ï¼Œå¯ä»¥çœ‹åˆ°å°‘äº†ç”¨æ¥ä¿å­˜çŠ¶æ€çš„å¤–éƒ¨å˜é‡tickingï¼Œè¿™æ ·å°±æ›´ç®€æ´ï¼Œæ›´å®‰å…¨ï¼ˆçŠ¶æ€ä¸ä¼šè¢«éæ³•ç¯¡æ”¹ï¼‰ã€æ›´ç¬¦åˆå‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³ï¼Œåœ¨å†™æ³•ä¸Šä¹Ÿæ›´ä¼˜é›…ã€‚Generatorä¹‹æ‰€ä»¥å¯ä»¥ä¸ç”¨å¤–éƒ¨å˜é‡ä¿å­˜çŠ¶æ€ï¼Œæ˜¯å› ä¸ºå®ƒæœ¬èº«å°±åŒ…å«äº†ä¸€ä¸ªçŠ¶æ€ä¿¡æ¯ï¼Œå³ç›®å‰æ˜¯å¦å¤„äºæš‚åœæ€ã€‚

Generatorä¸åç¨‹
åç¨‹ï¼ˆcoroutineï¼‰æ˜¯ä¸€ç§ç¨‹åºè¿è¡Œçš„æ–¹å¼ï¼Œå¯ä»¥ç†è§£æˆâ€œåä½œçš„çº¿ç¨‹â€æˆ–â€œåä½œçš„å‡½æ•°â€ã€‚åç¨‹æ—¢å¯ä»¥ç”¨å•çº¿ç¨‹å®ç°ï¼Œä¹Ÿå¯ä»¥ç”¨å¤šçº¿ç¨‹å®ç°ã€‚å‰è€…æ˜¯ä¸€ç§ç‰¹æ®Šçš„å­ä¾‹ç¨‹ï¼Œåè€…æ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ã€‚

ï¼ˆ1ï¼‰åç¨‹ä¸å­ä¾‹ç¨‹çš„å·®å¼‚

ä¼ ç»Ÿçš„â€œå­ä¾‹ç¨‹â€ï¼ˆsubroutineï¼‰é‡‡ç”¨å †æ ˆå¼â€œåè¿›å…ˆå‡ºâ€çš„æ‰§è¡Œæ–¹å¼ï¼Œåªæœ‰å½“è°ƒç”¨çš„å­å‡½æ•°å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šç»“æŸæ‰§è¡Œçˆ¶å‡½æ•°ã€‚åç¨‹ä¸å…¶ä¸åŒï¼Œå¤šä¸ªçº¿ç¨‹ï¼ˆå•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œå³å¤šä¸ªå‡½æ•°ï¼‰å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–å‡½æ•°ï¼‰å¤„äºæ­£åœ¨è¿è¡Œçš„çŠ¶æ€ï¼Œå…¶ä»–çº¿ç¨‹ï¼ˆæˆ–å‡½æ•°ï¼‰éƒ½å¤„äºæš‚åœæ€ï¼ˆsuspendedï¼‰ï¼Œçº¿ç¨‹ï¼ˆæˆ–å‡½æ•°ï¼‰ä¹‹é—´å¯ä»¥äº¤æ¢æ‰§è¡Œæƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–å‡½æ•°ï¼‰æ‰§è¡Œåˆ°ä¸€åŠï¼Œå¯ä»¥æš‚åœæ‰§è¡Œï¼Œå°†æ‰§è¡Œæƒäº¤ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–å‡½æ•°ï¼‰ï¼Œç­‰åˆ°ç¨åæ”¶å›æ‰§è¡Œæƒçš„æ—¶å€™ï¼Œå†æ¢å¤æ‰§è¡Œã€‚è¿™ç§å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€äº¤æ¢æ‰§è¡Œæƒçš„çº¿ç¨‹ï¼ˆæˆ–å‡½æ•°ï¼‰ï¼Œå°±ç§°ä¸ºåç¨‹ã€‚

ä»å®ç°ä¸Šçœ‹ï¼Œåœ¨å†…å­˜ä¸­ï¼Œå­ä¾‹ç¨‹åªä½¿ç”¨ä¸€ä¸ªæ ˆï¼ˆstackï¼‰ï¼Œè€Œåç¨‹æ˜¯åŒæ—¶å­˜åœ¨å¤šä¸ªæ ˆï¼Œä½†åªæœ‰ä¸€ä¸ªæ ˆæ˜¯åœ¨è¿è¡ŒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåç¨‹æ˜¯ä»¥å¤šå ç”¨å†…å­˜ä¸ºä»£ä»·ï¼Œå®ç°å¤šä»»åŠ¡çš„å¹¶è¡Œã€‚

ï¼ˆ2ï¼‰åç¨‹ä¸æ™®é€šçº¿ç¨‹çš„å·®å¼‚

ä¸éš¾çœ‹å‡ºï¼Œåç¨‹é€‚åˆç”¨äºå¤šä»»åŠ¡è¿è¡Œçš„ç¯å¢ƒã€‚åœ¨è¿™ä¸ªæ„ä¹‰ä¸Šï¼Œå®ƒä¸æ™®é€šçš„çº¿ç¨‹å¾ˆç›¸ä¼¼ï¼Œéƒ½æœ‰è‡ªå·±çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€å¯ä»¥åˆ†äº«å…¨å±€å˜é‡ã€‚å®ƒä»¬çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒåŒä¸€æ—¶é—´å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä½†æ˜¯è¿è¡Œçš„åç¨‹åªèƒ½æœ‰ä¸€ä¸ªï¼Œå…¶ä»–åç¨‹éƒ½å¤„äºæš‚åœçŠ¶æ€ã€‚æ­¤å¤–ï¼Œæ™®é€šçš„çº¿ç¨‹æ˜¯æŠ¢å…ˆå¼çš„ï¼Œåˆ°åº•å“ªä¸ªçº¿ç¨‹ä¼˜å…ˆå¾—åˆ°èµ„æºï¼Œå¿…é¡»ç”±è¿è¡Œç¯å¢ƒå†³å®šï¼Œä½†æ˜¯åç¨‹æ˜¯åˆä½œå¼çš„ï¼Œæ‰§è¡Œæƒç”±åç¨‹è‡ªå·±åˆ†é…ã€‚

ç”±äºECMAScriptæ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œåªèƒ½ä¿æŒä¸€ä¸ªè°ƒç”¨æ ˆã€‚å¼•å…¥åç¨‹ä»¥åï¼Œæ¯ä¸ªä»»åŠ¡å¯ä»¥ä¿æŒè‡ªå·±çš„è°ƒç”¨æ ˆã€‚è¿™æ ·åšçš„æœ€å¤§å¥½å¤„ï¼Œå°±æ˜¯æŠ›å‡ºé”™è¯¯çš„æ—¶å€™ï¼Œå¯ä»¥æ‰¾åˆ°åŸå§‹çš„è°ƒç”¨æ ˆã€‚ä¸è‡³äºåƒå¼‚æ­¥æ“ä½œçš„å›è°ƒå‡½æ•°é‚£æ ·ï¼Œä¸€æ—¦å‡ºé”™ï¼ŒåŸå§‹çš„è°ƒç”¨æ ˆæ—©å°±ç»“æŸã€‚

Generatorå‡½æ•°æ˜¯ECMAScript 6å¯¹åç¨‹çš„å®ç°ï¼Œä½†å±äºä¸å®Œå…¨å®ç°ã€‚Generatorå‡½æ•°è¢«ç§°ä¸ºâ€œåŠåç¨‹â€ï¼ˆsemi-coroutineï¼‰ï¼Œæ„æ€æ˜¯åªæœ‰Generatorå‡½æ•°çš„è°ƒç”¨è€…ï¼Œæ‰èƒ½å°†ç¨‹åºçš„æ‰§è¡Œæƒè¿˜ç»™Generatorå‡½æ•°ã€‚å¦‚æœæ˜¯å®Œå…¨æ‰§è¡Œçš„åç¨‹ï¼Œä»»ä½•å‡½æ•°éƒ½å¯ä»¥è®©æš‚åœçš„åç¨‹ç»§ç»­æ‰§è¡Œã€‚

å¦‚æœå°†Generatorå‡½æ•°å½“ä½œåç¨‹ï¼Œå®Œå…¨å¯ä»¥å°†å¤šä¸ªéœ€è¦äº’ç›¸åä½œçš„ä»»åŠ¡å†™æˆGeneratorå‡½æ•°ï¼Œå®ƒä»¬ä¹‹é—´ä½¿ç”¨yieldè¯­å¥äº¤æ¢æ§åˆ¶æƒã€‚

åº”ç”¨
Generatorå¯ä»¥æš‚åœå‡½æ•°æ‰§è¡Œï¼Œè¿”å›ä»»æ„è¡¨è¾¾å¼çš„å€¼ã€‚è¿™ç§ç‰¹ç‚¹ä½¿å¾—Generatoræœ‰å¤šç§åº”ç”¨åœºæ™¯ã€‚

ï¼ˆ1ï¼‰å¼‚æ­¥æ“ä½œçš„åŒæ­¥åŒ–è¡¨è¾¾
Generatorå‡½æ•°çš„æš‚åœæ‰§è¡Œçš„æ•ˆæœï¼Œæ„å‘³ç€å¯ä»¥æŠŠå¼‚æ­¥æ“ä½œå†™åœ¨yieldè¯­å¥é‡Œé¢ï¼Œç­‰åˆ°è°ƒç”¨nextæ–¹æ³•æ—¶å†å¾€åæ‰§è¡Œã€‚è¿™å®é™…ä¸Šç­‰åŒäºä¸éœ€è¦å†™å›è°ƒå‡½æ•°äº†ï¼Œå› ä¸ºå¼‚æ­¥æ“ä½œçš„åç»­æ“ä½œå¯ä»¥æ”¾åœ¨yieldè¯­å¥ä¸‹é¢ï¼Œåæ­£è¦ç­‰åˆ°è°ƒç”¨nextæ–¹æ³•æ—¶å†æ‰§è¡Œã€‚æ‰€ä»¥ï¼ŒGeneratorå‡½æ•°çš„ä¸€ä¸ªé‡è¦å®é™…æ„ä¹‰å°±æ˜¯ç”¨æ¥å¤„ç†å¼‚æ­¥æ“ä½œï¼Œæ”¹å†™å›è°ƒå‡½æ•°ã€‚

function* loadUI() {
  showLoadingScreen();
  yield loadUIDataAsynchronously();
  hideLoadingScreen();
}
var loader = loadUI();
// åŠ è½½UI
loader.next()

// å¸è½½UI
loader.next()
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨loadUIå‡½æ•°æ—¶ï¼Œè¯¥å‡½æ•°ä¸ä¼šæ‰§è¡Œï¼Œä»…è¿”å›ä¸€ä¸ªéå†å™¨ã€‚ä¸‹ä¸€æ¬¡å¯¹è¯¥éå†å™¨è°ƒç”¨nextæ–¹æ³•ï¼Œåˆ™ä¼šæ˜¾ç¤ºLoadingç•Œé¢ï¼Œå¹¶ä¸”å¼‚æ­¥åŠ è½½æ•°æ®ã€‚ç­‰åˆ°æ•°æ®åŠ è½½å®Œæˆï¼Œå†ä¸€æ¬¡ä½¿ç”¨nextæ–¹æ³•ï¼Œåˆ™ä¼šéšè—Loadingç•Œé¢ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§å†™æ³•çš„å¥½å¤„æ˜¯æ‰€æœ‰Loadingç•Œé¢çš„é€»è¾‘ï¼Œéƒ½è¢«å°è£…åœ¨ä¸€ä¸ªå‡½æ•°ï¼ŒæŒ‰éƒ¨å°±ç­éå¸¸æ¸…æ™°ã€‚

Ajaxæ˜¯å…¸å‹çš„å¼‚æ­¥æ“ä½œï¼Œé€šè¿‡Generatorå‡½æ•°éƒ¨ç½²Ajaxæ“ä½œï¼Œå¯ä»¥ç”¨åŒæ­¥çš„æ–¹å¼è¡¨è¾¾ã€‚

function* main() {
  var result = yield request("http://some.url");
  var resp = JSON.parse(result);
    console.log(resp.value);
}

function request(url) {
  makeAjaxCall(url, function(response){
    it.next(response);
  });
}

var it = main();
it.next();
ä¸Šé¢ä»£ç çš„mainå‡½æ•°ï¼Œå°±æ˜¯é€šè¿‡Ajaxæ“ä½œè·å–æ•°æ®ã€‚å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†å¤šäº†ä¸€ä¸ªyieldï¼Œå®ƒå‡ ä¹ä¸åŒæ­¥æ“ä½œçš„å†™æ³•å®Œå…¨ä¸€æ ·ã€‚æ³¨æ„ï¼ŒmakeAjaxCallå‡½æ•°ä¸­çš„nextæ–¹æ³•ï¼Œå¿…é¡»åŠ ä¸Šresponseå‚æ•°ï¼Œå› ä¸ºyieldè¯­å¥æ„æˆçš„è¡¨è¾¾å¼ï¼Œæœ¬èº«æ˜¯æ²¡æœ‰å€¼çš„ï¼Œæ€»æ˜¯ç­‰äºundefinedã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ï¼Œé€šè¿‡Generatorå‡½æ•°é€è¡Œè¯»å–æ–‡æœ¬æ–‡ä»¶ã€‚

function* numbers() {
  let file = new FileReader("numbers.txt");
  try {
    while(!file.eof) {
      yield parseInt(file.readLine(), 10);
    }
  } finally {
    file.close();
  }
}
ä¸Šé¢ä»£ç æ‰“å¼€æ–‡æœ¬æ–‡ä»¶ï¼Œä½¿ç”¨yieldè¯­å¥å¯ä»¥æ‰‹åŠ¨é€è¡Œè¯»å–æ–‡ä»¶ã€‚

ï¼ˆ2ï¼‰æ§åˆ¶æµç®¡ç†
å¦‚æœæœ‰ä¸€ä¸ªå¤šæ­¥æ“ä½œéå¸¸è€—æ—¶ï¼Œé‡‡ç”¨å›è°ƒå‡½æ•°ï¼Œå¯èƒ½ä¼šå†™æˆä¸‹é¢è¿™æ ·ã€‚

step1(function (value1) {
  step2(value1, function(value2) {
    step3(value2, function(value3) {
      step4(value3, function(value4) {
        // Do something with value4
      });
    });
  });
});
é‡‡ç”¨Promiseæ”¹å†™ä¸Šé¢çš„ä»£ç ã€‚

Promise.resolve(step1)
  .then(step2)
  .then(step3)
  .then(step4)
  .then(function (value4) {
    // Do something with value4
  }, function (error) {
    // Handle any error from step1 through step4
  })
  .done();
ä¸Šé¢ä»£ç å·²ç»æŠŠå›è°ƒå‡½æ•°ï¼Œæ”¹æˆäº†ç›´çº¿æ‰§è¡Œçš„å½¢å¼ï¼Œä½†æ˜¯åŠ å…¥äº†å¤§é‡Promiseçš„è¯­æ³•ã€‚Generatorå‡½æ•°å¯ä»¥è¿›ä¸€æ­¥æ”¹å–„ä»£ç è¿è¡Œæµç¨‹ã€‚

function* longRunningTask(value1) {
  try {
    var value2 = yield step1(value1);
    var value3 = yield step2(value2);
    var value4 = yield step3(value3);
    var value5 = yield step4(value4);
    // Do something with value4
  } catch (e) {
    // Handle any error from step1 through step4
  }
}
ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‡½æ•°ï¼ŒæŒ‰æ¬¡åºè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤ã€‚

scheduler(longRunningTask(initialValue));

function scheduler(task) {
  var taskObj = task.next(task.value);
  // å¦‚æœGeneratorå‡½æ•°æœªç»“æŸï¼Œå°±ç»§ç»­è°ƒç”¨
  if (!taskObj.done) {
    task.value = taskObj.value
    scheduler(task);
  }
}
æ³¨æ„ï¼Œä¸Šé¢è¿™ç§åšæ³•ï¼Œåªé€‚åˆåŒæ­¥æ“ä½œï¼Œå³æ‰€æœ‰çš„taskéƒ½å¿…é¡»æ˜¯åŒæ­¥çš„ï¼Œä¸èƒ½æœ‰å¼‚æ­¥æ“ä½œã€‚å› ä¸ºè¿™é‡Œçš„ä»£ç ä¸€å¾—åˆ°è¿”å›å€¼ï¼Œå°±ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ²¡æœ‰åˆ¤æ–­å¼‚æ­¥æ“ä½œä½•æ—¶å®Œæˆã€‚å¦‚æœè¦æ§åˆ¶å¼‚æ­¥çš„æ“ä½œæµç¨‹ï¼Œè¯¦è§åé¢çš„ã€Šå¼‚æ­¥æ“ä½œã€‹ä¸€ç« ã€‚

ä¸‹é¢ï¼Œåˆ©ç”¨for...ofå¾ªç¯ä¼šè‡ªåŠ¨ä¾æ¬¡æ‰§è¡Œyieldå‘½ä»¤çš„ç‰¹æ€§ï¼Œæä¾›ä¸€ç§æ›´ä¸€èˆ¬çš„æ§åˆ¶æµç®¡ç†çš„æ–¹æ³•ã€‚

let steps = [step1Func, step2Func, step3Func];

function *iterateSteps(steps){
  for (var i=0; i< steps.length; i++){
    var step = steps[i];
    yield step();
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„stepså°è£…äº†ä¸€ä¸ªä»»åŠ¡çš„å¤šä¸ªæ­¥éª¤ï¼ŒGeneratorå‡½æ•°iterateStepsåˆ™æ˜¯ä¾æ¬¡ä¸ºè¿™äº›æ­¥éª¤åŠ ä¸Šyieldå‘½ä»¤ã€‚

å°†ä»»åŠ¡åˆ†è§£æˆæ­¥éª¤ä¹‹åï¼Œè¿˜å¯ä»¥å°†é¡¹ç›®åˆ†è§£æˆå¤šä¸ªä¾æ¬¡æ‰§è¡Œçš„ä»»åŠ¡ã€‚

let jobs = [job1, job2, job3];

function *iterateJobs(jobs){
  for (var i=0; i< jobs.length; i++){
    var job = jobs[i];
    yield *iterateSteps(job.steps);
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„jobså°è£…äº†ä¸€ä¸ªé¡¹ç›®çš„å¤šä¸ªä»»åŠ¡ï¼ŒGeneratorå‡½æ•°iterateJobsåˆ™æ˜¯ä¾æ¬¡ä¸ºè¿™äº›ä»»åŠ¡åŠ ä¸Šyield *å‘½ä»¤ã€‚

æœ€åï¼Œå°±å¯ä»¥ç”¨for...ofå¾ªç¯ä¸€æ¬¡æ€§ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡çš„æ‰€æœ‰æ­¥éª¤ã€‚

for (var step of iterateJobs(jobs)){
  console.log(step.id);
}
å†æ¬¡æé†’ï¼Œä¸Šé¢çš„åšæ³•åªèƒ½ç”¨äºæ‰€æœ‰æ­¥éª¤éƒ½æ˜¯åŒæ­¥æ“ä½œçš„æƒ…å†µï¼Œä¸èƒ½æœ‰å¼‚æ­¥æ“ä½œçš„æ­¥éª¤ã€‚å¦‚æœæƒ³è¦ä¾æ¬¡æ‰§è¡Œå¼‚æ­¥çš„æ­¥éª¤ï¼Œå¿…é¡»ä½¿ç”¨åé¢çš„ã€Šå¼‚æ­¥æ“ä½œã€‹ä¸€ç« ä»‹ç»çš„æ–¹æ³•ã€‚

for...ofçš„æœ¬è´¨æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç å®è´¨ä¸Šæ‰§è¡Œçš„æ˜¯ä¸‹é¢çš„é€»è¾‘ã€‚

var it = iterateJobs(jobs);
var res = it.next();

while (!res.done){
  var result = res.value;
  // ...
  res = it.next();
}
ï¼ˆ3ï¼‰éƒ¨ç½²Iteratoræ¥å£
åˆ©ç”¨Generatorå‡½æ•°ï¼Œå¯ä»¥åœ¨ä»»æ„å¯¹è±¡ä¸Šéƒ¨ç½²Iteratoræ¥å£ã€‚

function* iterEntries(obj) {
  let keys = Object.keys(obj);
  for (let i=0; i < keys.length; i++) {
    let key = keys[i];
    yield [key, obj[key]];
  }
}

let myObj = { foo: 3, bar: 7 };

for (let [key, value] of iterEntries(myObj)) {
  console.log(key, value);
}

// foo 3
// bar 7
ä¸Šè¿°ä»£ç ä¸­ï¼ŒmyObjæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œé€šè¿‡iterEntrieså‡½æ•°ï¼Œå°±æœ‰äº†Iteratoræ¥å£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥åœ¨ä»»æ„å¯¹è±¡ä¸Šéƒ¨ç½²nextæ–¹æ³•ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¯¹æ•°ç»„éƒ¨ç½²Iteratoræ¥å£çš„ä¾‹å­ï¼Œå°½ç®¡æ•°ç»„åŸç”Ÿå…·æœ‰è¿™ä¸ªæ¥å£ã€‚

function* makeSimpleGenerator(array){
  var nextIndex = 0;

  while(nextIndex < array.length){
    yield array[nextIndex++];
  }
}

var gen = makeSimpleGenerator(['yo', 'ya']);

gen.next().value // 'yo'
gen.next().value // 'ya'
gen.next().done  // true
ï¼ˆ4ï¼‰ä½œä¸ºæ•°æ®ç»“æ„
Generatorå¯ä»¥çœ‹ä½œæ˜¯æ•°æ®ç»“æ„ï¼Œæ›´ç¡®åˆ‡åœ°è¯´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæ•°ç»„ç»“æ„ï¼Œå› ä¸ºGeneratorå‡½æ•°å¯ä»¥è¿”å›ä¸€ç³»åˆ—çš„å€¼ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥å¯¹ä»»æ„è¡¨è¾¾å¼ï¼Œæä¾›ç±»ä¼¼æ•°ç»„çš„æ¥å£ã€‚

function *doStuff() {
  yield fs.readFile.bind(null, 'hello.txt');
  yield fs.readFile.bind(null, 'world.txt');
  yield fs.readFile.bind(null, 'and-such.txt');
}
ä¸Šé¢ä»£ç å°±æ˜¯ä¾æ¬¡è¿”å›ä¸‰ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº†Generatorå‡½æ•°ï¼Œå¯¼è‡´å¯ä»¥åƒå¤„ç†æ•°ç»„é‚£æ ·ï¼Œå¤„ç†è¿™ä¸‰ä¸ªè¿”å›çš„å‡½æ•°ã€‚

for (task of doStuff()) {
  // taskæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥åƒå›è°ƒå‡½æ•°é‚£æ ·ä½¿ç”¨å®ƒ
}
å®é™…ä¸Šï¼Œå¦‚æœç”¨ES5è¡¨è¾¾ï¼Œå®Œå…¨å¯ä»¥ç”¨æ•°ç»„æ¨¡æ‹ŸGeneratorçš„è¿™ç§ç”¨æ³•ã€‚

function doStuff() {
  return [
    fs.readFile.bind(null, 'hello.txt'),
    fs.readFile.bind(null, 'world.txt'),
    fs.readFile.bind(null, 'and-such.txt')
  ];
}
ä¸Šé¢çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨ä¸€æ¨¡ä¸€æ ·çš„for...ofå¾ªç¯å¤„ç†ï¼ä¸¤ç›¸ä¸€æ¯”è¾ƒï¼Œå°±ä¸éš¾çœ‹å‡ºGeneratorä½¿å¾—æ•°æ®æˆ–è€…æ“ä½œï¼Œå…·å¤‡äº†ç±»ä¼¼æ•°ç»„çš„æ¥å£ã€‚

##Promiseå¯¹è±¡
1.Promiseçš„å«ä¹‰
Promiseæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆâ€”â€”å›è°ƒå‡½æ•°å’Œäº‹ä»¶â€”â€”æ›´åˆç†å’Œæ›´å¼ºå¤§ã€‚å®ƒç”±ç¤¾åŒºæœ€æ—©æå‡ºå’Œå®ç°ï¼ŒES6å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼ŒåŸç”Ÿæä¾›äº†Promiseå¯¹è±¡ã€‚

æ‰€è°“Promiseï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼‰çš„ç»“æœã€‚ä»è¯­æ³•ä¸Šè¯´ï¼ŒPromiseæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»å®ƒå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ã€‚Promiseæä¾›ç»Ÿä¸€çš„APIï¼Œå„ç§å¼‚æ­¥æ“ä½œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

Promiseå¯¹è±¡æœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ã€‚

ï¼ˆ1ï¼‰å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ã€‚Promiseå¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼šPendingï¼ˆè¿›è¡Œä¸­ï¼‰ã€Resolvedï¼ˆå·²å®Œæˆï¼Œåˆç§°Fulfilledï¼‰å’ŒRejectedï¼ˆå·²å¤±è´¥ï¼‰ã€‚åªæœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¯ä»¥å†³å®šå½“å‰æ˜¯å“ªä¸€ç§çŠ¶æ€ï¼Œä»»ä½•å…¶ä»–æ“ä½œéƒ½æ— æ³•æ”¹å˜è¿™ä¸ªçŠ¶æ€ã€‚è¿™ä¹Ÿæ˜¯Promiseè¿™ä¸ªåå­—çš„ç”±æ¥ï¼Œå®ƒçš„è‹±è¯­æ„æ€å°±æ˜¯â€œæ‰¿è¯ºâ€ï¼Œè¡¨ç¤ºå…¶ä»–æ‰‹æ®µæ— æ³•æ”¹å˜ã€‚

ï¼ˆ2ï¼‰ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªç»“æœã€‚Promiseå¯¹è±¡çš„çŠ¶æ€æ”¹å˜ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½ï¼šä»Pendingå˜ä¸ºResolvedå’Œä»Pendingå˜ä¸ºRejectedã€‚åªè¦è¿™ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼ŒçŠ¶æ€å°±å‡å›ºäº†ï¼Œä¸ä¼šå†å˜äº†ï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœã€‚å°±ç®—æ”¹å˜å·²ç»å‘ç”Ÿäº†ï¼Œä½ å†å¯¹Promiseå¯¹è±¡æ·»åŠ å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šç«‹å³å¾—åˆ°è¿™ä¸ªç»“æœã€‚è¿™ä¸äº‹ä»¶ï¼ˆEventï¼‰å®Œå…¨ä¸åŒï¼Œäº‹ä»¶çš„ç‰¹ç‚¹æ˜¯ï¼Œå¦‚æœä½ é”™è¿‡äº†å®ƒï¼Œå†å»ç›‘å¬ï¼Œæ˜¯å¾—ä¸åˆ°ç»“æœçš„ã€‚

æœ‰äº†Promiseå¯¹è±¡ï¼Œå°±å¯ä»¥å°†å¼‚æ­¥æ“ä½œä»¥åŒæ­¥æ“ä½œçš„æµç¨‹è¡¨è¾¾å‡ºæ¥ï¼Œé¿å…äº†å±‚å±‚åµŒå¥—çš„å›è°ƒå‡½æ•°ã€‚æ­¤å¤–ï¼ŒPromiseå¯¹è±¡æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—æ§åˆ¶å¼‚æ­¥æ“ä½œæ›´åŠ å®¹æ˜“ã€‚

Promiseä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚é¦–å…ˆï¼Œæ— æ³•å–æ¶ˆPromiseï¼Œä¸€æ—¦æ–°å»ºå®ƒå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•ä¸­é€”å–æ¶ˆã€‚å…¶æ¬¡ï¼Œå¦‚æœä¸è®¾ç½®å›è°ƒå‡½æ•°ï¼ŒPromiseå†…éƒ¨æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸ä¼šååº”åˆ°å¤–éƒ¨ã€‚ç¬¬ä¸‰ï¼Œå½“å¤„äºPendingçŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥ç›®å‰è¿›å±•åˆ°å“ªä¸€ä¸ªé˜¶æ®µï¼ˆåˆšåˆšå¼€å§‹è¿˜æ˜¯å³å°†å®Œæˆï¼‰ã€‚

å¦‚æœæŸäº›äº‹ä»¶ä¸æ–­åœ°åå¤å‘ç”Ÿï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨streamæ¨¡å¼æ˜¯æ¯”éƒ¨ç½²Promiseæ›´å¥½çš„é€‰æ‹©ã€‚

åŸºæœ¬ç”¨æ³•
ES6è§„å®šï¼ŒPromiseå¯¹è±¡æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”ŸæˆPromiseå®ä¾‹ã€‚

ä¸‹é¢ä»£ç åˆ›é€ äº†ä¸€ä¸ªPromiseå®ä¾‹ã€‚

var promise = new Promise(function(resolve, reject) {
  // ... some code

  if (/* å¼‚æ­¥æ“ä½œæˆåŠŸ */){
    resolve(value);
  } else {
    reject(error);
  }
});
Promiseæ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯resolveå’Œrejectã€‚å®ƒä»¬æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œç”±JavaScriptå¼•æ“æä¾›ï¼Œä¸ç”¨è‡ªå·±éƒ¨ç½²ã€‚

resolveå‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°†Promiseå¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œæˆåŠŸâ€ï¼ˆå³ä»Pendingå˜ä¸ºResolvedï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ï¼›rejectå‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°†Promiseå¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œå¤±è´¥â€ï¼ˆå³ä»Pendingå˜ä¸ºRejectedï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œæŠ¥å‡ºçš„é”™è¯¯ï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ã€‚

Promiseå®ä¾‹ç”Ÿæˆä»¥åï¼Œå¯ä»¥ç”¨thenæ–¹æ³•åˆ†åˆ«æŒ‡å®šResolvedçŠ¶æ€å’ŒRejectçŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚

promise.then(function(value) {
  // success
}, function(error) {
  // failure
});
thenæ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°æ˜¯Promiseå¯¹è±¡çš„çŠ¶æ€å˜ä¸ºResolvedæ—¶è°ƒç”¨ï¼Œç¬¬äºŒä¸ªå›è°ƒå‡½æ•°æ˜¯Promiseå¯¹è±¡çš„çŠ¶æ€å˜ä¸ºRejectæ—¶è°ƒç”¨ã€‚å…¶ä¸­ï¼Œç¬¬äºŒä¸ªå‡½æ•°æ˜¯å¯é€‰çš„ï¼Œä¸ä¸€å®šè¦æä¾›ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ¥å—Promiseå¯¹è±¡ä¼ å‡ºçš„å€¼ä½œä¸ºå‚æ•°ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡çš„ç®€å•ä¾‹å­ã€‚

function timeout(ms) {
  return new Promise((resolve, reject) => {
    setTimeout(resolve, ms, 'done');
  });
}

timeout(100).then((value) => {
  console.log(value);
});
ä¸Šé¢ä»£ç ä¸­ï¼Œtimeoutæ–¹æ³•è¿”å›ä¸€ä¸ªPromiseå®ä¾‹ï¼Œè¡¨ç¤ºä¸€æ®µæ—¶é—´ä»¥åæ‰ä¼šå‘ç”Ÿçš„ç»“æœã€‚è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼ˆmså‚æ•°ï¼‰ä»¥åï¼ŒPromiseå®ä¾‹çš„çŠ¶æ€å˜ä¸ºResolvedï¼Œå°±ä¼šè§¦å‘thenæ–¹æ³•ç»‘å®šçš„å›è°ƒå‡½æ•°ã€‚

Promiseæ–°å»ºåå°±ä¼šç«‹å³æ‰§è¡Œã€‚

let promise = new Promise(function(resolve, reject) {
  console.log('Promise');
  resolve();
});

promise.then(function() {
  console.log('Resolved.');
});

console.log('Hi!');

// Promise
// Hi!
// Resolved
ä¸Šé¢ä»£ç ä¸­ï¼ŒPromiseæ–°å»ºåç«‹å³æ‰§è¡Œï¼Œæ‰€ä»¥é¦–å…ˆè¾“å‡ºçš„æ˜¯â€œPromiseâ€ã€‚ç„¶åï¼Œthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå°†åœ¨å½“å‰è„šæœ¬æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥â€œResolvedâ€æœ€åè¾“å‡ºã€‚

ä¸‹é¢æ˜¯å¼‚æ­¥åŠ è½½å›¾ç‰‡çš„ä¾‹å­ã€‚

function loadImageAsync(url) {
  return new Promise(function(resolve, reject) {
    var image = new Image();

    image.onload = function() {
      resolve(image);
    };

    image.onerror = function() {
      reject(new Error('Could not load image at ' + url));
    };

    image.src = url;
  });
}
ä¸Šé¢ä»£ç ä¸­ï¼Œä½¿ç”¨PromiseåŒ…è£…äº†ä¸€ä¸ªå›¾ç‰‡åŠ è½½çš„å¼‚æ­¥æ“ä½œã€‚å¦‚æœåŠ è½½æˆåŠŸï¼Œå°±è°ƒç”¨resolveæ–¹æ³•ï¼Œå¦åˆ™å°±è°ƒç”¨rejectæ–¹æ³•ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç”¨Promiseå¯¹è±¡å®ç°çš„Ajaxæ“ä½œçš„ä¾‹å­ã€‚

var getJSON = function(url) {
  var promise = new Promise(function(resolve, reject){
    var client = new XMLHttpRequest();
    client.open("GET", url);
    client.onreadystatechange = handler;
    client.responseType = "json";
    client.setRequestHeader("Accept", "application/json");
    client.send();

    function handler() {
      if (this.readyState !== 4) {
        return;
      }
      if (this.status === 200) {
        resolve(this.response);
      } else {
        reject(new Error(this.statusText));
      }
    };
  });

  return promise;
};

getJSON("/posts.json").then(function(json) {
  console.log('Contents: ' + json);
}, function(error) {
  console.error('å‡ºé”™äº†', error);
});
ä¸Šé¢ä»£ç ä¸­ï¼ŒgetJSONæ˜¯å¯¹XMLHttpRequestå¯¹è±¡çš„å°è£…ï¼Œç”¨äºå‘å‡ºä¸€ä¸ªé’ˆå¯¹JSONæ•°æ®çš„HTTPè¯·æ±‚ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨getJSONå†…éƒ¨ï¼Œresolveå‡½æ•°å’Œrejectå‡½æ•°è°ƒç”¨æ—¶ï¼Œéƒ½å¸¦æœ‰å‚æ•°ã€‚

å¦‚æœè°ƒç”¨resolveå‡½æ•°å’Œrejectå‡½æ•°æ—¶å¸¦æœ‰å‚æ•°ï¼Œé‚£ä¹ˆå®ƒä»¬çš„å‚æ•°ä¼šè¢«ä¼ é€’ç»™å›è°ƒå‡½æ•°ã€‚rejectå‡½æ•°çš„å‚æ•°é€šå¸¸æ˜¯Errorå¯¹è±¡çš„å®ä¾‹ï¼Œè¡¨ç¤ºæŠ›å‡ºçš„é”™è¯¯ï¼›resolveå‡½æ•°çš„å‚æ•°é™¤äº†æ­£å¸¸çš„å€¼ä»¥å¤–ï¼Œè¿˜å¯èƒ½æ˜¯å¦ä¸€ä¸ªPromiseå®ä¾‹ï¼Œè¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„ç»“æœæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªå€¼ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ ·ã€‚

var p1 = new Promise(function (resolve, reject) {
  // ...
});

var p2 = new Promise(function (resolve, reject) {
  // ...
  resolve(p1);
})
ä¸Šé¢ä»£ç ä¸­ï¼Œp1å’Œp2éƒ½æ˜¯Promiseçš„å®ä¾‹ï¼Œä½†æ˜¯p2çš„resolveæ–¹æ³•å°†p1ä½œä¸ºå‚æ•°ï¼Œå³ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœæ˜¯è¿”å›å¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚

æ³¨æ„ï¼Œè¿™æ—¶p1çš„çŠ¶æ€å°±ä¼šä¼ é€’ç»™p2ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œp1çš„çŠ¶æ€å†³å®šäº†p2çš„çŠ¶æ€ã€‚å¦‚æœp1çš„çŠ¶æ€æ˜¯Pendingï¼Œé‚£ä¹ˆp2çš„å›è°ƒå‡½æ•°å°±ä¼šç­‰å¾…p1çš„çŠ¶æ€æ”¹å˜ï¼›å¦‚æœp1çš„çŠ¶æ€å·²ç»æ˜¯Resolvedæˆ–è€…Rejectedï¼Œé‚£ä¹ˆp2çš„å›è°ƒå‡½æ•°å°†ä¼šç«‹åˆ»æ‰§è¡Œã€‚

var p1 = new Promise(function (resolve, reject) {
  setTimeout(() => reject(new Error('fail')), 3000)
})

var p2 = new Promise(function (resolve, reject) {
  setTimeout(() => resolve(p1), 1000)
})

p2
  .then(result => console.log(result))
  .catch(error => console.log(error))
// Error: fail
ä¸Šé¢ä»£ç ä¸­ï¼Œp1æ˜¯ä¸€ä¸ªPromiseï¼Œ3ç§’ä¹‹åå˜ä¸ºrejectedã€‚p2çš„çŠ¶æ€åœ¨1ç§’ä¹‹åæ”¹å˜ï¼Œresolveæ–¹æ³•è¿”å›çš„æ˜¯p1ã€‚æ­¤æ—¶ï¼Œç”±äºp2è¿”å›çš„æ˜¯å¦ä¸€ä¸ªPromiseï¼Œæ‰€ä»¥åé¢çš„thenè¯­å¥éƒ½å˜æˆé’ˆå¯¹åè€…ï¼ˆp1ï¼‰ã€‚åˆè¿‡äº†2ç§’ï¼Œp1å˜ä¸ºrejectedï¼Œå¯¼è‡´è§¦å‘catchæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

Promise.prototype.then()
Promiseå®ä¾‹å…·æœ‰thenæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œthenæ–¹æ³•æ˜¯å®šä¹‰åœ¨åŸå‹å¯¹è±¡Promise.prototypeä¸Šçš„ã€‚å®ƒçš„ä½œç”¨æ˜¯ä¸ºPromiseå®ä¾‹æ·»åŠ çŠ¶æ€æ”¹å˜æ—¶çš„å›è°ƒå‡½æ•°ã€‚å‰é¢è¯´è¿‡ï¼Œthenæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ResolvedçŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰æ˜¯RejectedçŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚

thenæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ªPromiseå®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³thenæ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ªthenæ–¹æ³•ã€‚

getJSON("/posts.json").then(function(json) {
  return json.post;
}).then(function(post) {
  // ...
});
ä¸Šé¢çš„ä»£ç ä½¿ç”¨thenæ–¹æ³•ï¼Œä¾æ¬¡æŒ‡å®šäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å®Œæˆä»¥åï¼Œä¼šå°†è¿”å›ç»“æœä½œä¸ºå‚æ•°ï¼Œä¼ å…¥ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ã€‚

é‡‡ç”¨é“¾å¼çš„thenï¼Œå¯ä»¥æŒ‡å®šä¸€ç»„æŒ‰ç…§æ¬¡åºè°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚è¿™æ—¶ï¼Œå‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæœ‰å¯èƒ½è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ï¼ˆå³æœ‰å¼‚æ­¥æ“ä½œï¼‰ï¼Œè¿™æ—¶åä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¯¥Promiseå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œæ‰ä¼šè¢«è°ƒç”¨ã€‚

getJSON("/post/1.json").then(function(post) {
  return getJSON(post.commentURL);
}).then(function funcA(comments) {
  console.log("Resolved: ", comments);
}, function funcB(err){
  console.log("Rejected: ", err);
});
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬ä¸€ä¸ªthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè¿”å›çš„æ˜¯å¦ä¸€ä¸ªPromiseå¯¹è±¡ã€‚è¿™æ—¶ï¼Œç¬¬äºŒä¸ªthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¿™ä¸ªæ–°çš„Promiseå¯¹è±¡çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœå˜ä¸ºResolvedï¼Œå°±è°ƒç”¨funcAï¼Œå¦‚æœçŠ¶æ€å˜ä¸ºRejectedï¼Œå°±è°ƒç”¨funcBã€‚

å¦‚æœé‡‡ç”¨ç®­å¤´å‡½æ•°ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥å†™å¾—æ›´ç®€æ´ã€‚

getJSON("/post/1.json").then(
  post => getJSON(post.commentURL)
).then(
  comments => console.log("Resolved: ", comments),
  err => console.log("Rejected: ", err)
);
Promise.prototype.catch()
Promise.prototype.catchæ–¹æ³•æ˜¯.then(null, rejection)çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•°ã€‚

getJSON("/posts.json").then(function(posts) {
  // ...
}).catch(function(error) {
  // å¤„ç† getJSON å’Œ å‰ä¸€ä¸ªå›è°ƒå‡½æ•°è¿è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯
  console.log('å‘ç”Ÿé”™è¯¯ï¼', error);
});
ä¸Šé¢ä»£ç ä¸­ï¼ŒgetJSONæ–¹æ³•è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¦‚æœè¯¥å¯¹è±¡çŠ¶æ€å˜ä¸ºResolvedï¼Œåˆ™ä¼šè°ƒç”¨thenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼›å¦‚æœå¼‚æ­¥æ“ä½œæŠ›å‡ºé”™è¯¯ï¼ŒçŠ¶æ€å°±ä¼šå˜ä¸ºRejectedï¼Œå°±ä¼šè°ƒç”¨catchæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†è¿™ä¸ªé”™è¯¯ã€‚å¦å¤–ï¼Œthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœè¿è¡Œä¸­æŠ›å‡ºé”™è¯¯ï¼Œä¹Ÿä¼šè¢«catchæ–¹æ³•æ•è·ã€‚

p.then((val) => console.log("fulfilled:", val))
  .catch((err) => console.log("rejected:", err));

// ç­‰åŒäº
p.then((val) => console.log("fulfilled:", val))
  .then(null, (err) => console.log("rejected:", err));
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var promise = new Promise(function(resolve, reject) {
  throw new Error('test');
});
promise.catch(function(error) {
  console.log(error);
});
// Error: test
ä¸Šé¢ä»£ç ä¸­ï¼ŒpromiseæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢«catchæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œä¸Šé¢çš„å†™æ³•ä¸ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚

// å†™æ³•ä¸€
var promise = new Promise(function(resolve, reject) {
  try {
    throw new Error('test');
  } catch(e) {
    reject(e);
  }
});
promise.catch(function(error) {
  console.log(error);
});

// å†™æ³•äºŒ
var promise = new Promise(function(resolve, reject) {
  reject(new Error('test'));
});
promise.catch(function(error) {
  console.log(error);
});
æ¯”è¾ƒä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå¯ä»¥å‘ç°rejectæ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯ã€‚

å¦‚æœPromiseçŠ¶æ€å·²ç»å˜æˆResolvedï¼Œå†æŠ›å‡ºé”™è¯¯æ˜¯æ— æ•ˆçš„ã€‚

var promise = new Promise(function(resolve, reject) {
  resolve('ok');
  throw new Error('test');
});
promise
  .then(function(value) { console.log(value) })
  .catch(function(error) { console.log(error) });
// ok
ä¸Šé¢ä»£ç ä¸­ï¼ŒPromiseåœ¨resolveè¯­å¥åé¢ï¼Œå†æŠ›å‡ºé”™è¯¯ï¼Œä¸ä¼šè¢«æ•è·ï¼Œç­‰äºæ²¡æœ‰æŠ›å‡ºã€‚

Promiseå¯¹è±¡çš„é”™è¯¯å…·æœ‰â€œå†’æ³¡â€æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ªcatchè¯­å¥æ•è·ã€‚

getJSON("/post/1.json").then(function(post) {
  return getJSON(post.commentURL);
}).then(function(comments) {
  // some code
}).catch(function(error) {
  // å¤„ç†å‰é¢ä¸‰ä¸ªPromiseäº§ç”Ÿçš„é”™è¯¯
});
ä¸Šé¢ä»£ç ä¸­ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªPromiseå¯¹è±¡ï¼šä¸€ä¸ªç”±getJSONäº§ç”Ÿï¼Œä¸¤ä¸ªç”±thenäº§ç”Ÿã€‚å®ƒä»¬ä¹‹ä¸­ä»»ä½•ä¸€ä¸ªæŠ›å‡ºçš„é”™è¯¯ï¼Œéƒ½ä¼šè¢«æœ€åä¸€ä¸ªcatchæ•è·ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨thenæ–¹æ³•é‡Œé¢å®šä¹‰RejectçŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³thençš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨catchæ–¹æ³•ã€‚

// bad
promise
  .then(function(data) {
    // success
  }, function(err) {
    // error
  });

// good
promise
  .then(function(data) { //cb
    // success
  })
  .catch(function(err) {
    // error
  });
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒç§å†™æ³•è¦å¥½äºç¬¬ä¸€ç§å†™æ³•ï¼Œç†ç”±æ˜¯ç¬¬äºŒç§å†™æ³•å¯ä»¥æ•è·å‰é¢thenæ–¹æ³•æ‰§è¡Œä¸­çš„é”™è¯¯ï¼Œä¹Ÿæ›´æ¥è¿‘åŒæ­¥çš„å†™æ³•ï¼ˆtry/catchï¼‰ã€‚å› æ­¤ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨catchæ–¹æ³•ï¼Œè€Œä¸ä½¿ç”¨thenæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚

è·Ÿä¼ ç»Ÿçš„try/catchä»£ç å—ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨catchæ–¹æ³•æŒ‡å®šé”™è¯¯å¤„ç†çš„å›è°ƒå‡½æ•°ï¼ŒPromiseå¯¹è±¡æŠ›å‡ºçš„é”™è¯¯ä¸ä¼šä¼ é€’åˆ°å¤–å±‚ä»£ç ï¼Œå³ä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚

var someAsyncThing = function() {
  return new Promise(function(resolve, reject) {
    // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºxæ²¡æœ‰å£°æ˜
    resolve(x + 2);
  });
};

someAsyncThing().then(function() {
  console.log('everything is great');
});
ä¸Šé¢ä»£ç ä¸­ï¼ŒsomeAsyncThingå‡½æ•°äº§ç”Ÿçš„Promiseå¯¹è±¡ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰æŒ‡å®šcatchæ–¹æ³•ï¼Œè¿™ä¸ªé”™è¯¯ä¸ä¼šè¢«æ•è·ï¼Œä¹Ÿä¸ä¼šä¼ é€’åˆ°å¤–å±‚ä»£ç ï¼Œå¯¼è‡´è¿è¡Œåæ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚æ³¨æ„ï¼ŒChromeæµè§ˆå™¨ä¸éµå®ˆè¿™æ¡è§„å®šï¼Œå®ƒä¼šæŠ›å‡ºé”™è¯¯â€œReferenceError: x is not definedâ€ã€‚

var promise = new Promise(function(resolve, reject) {
  resolve('ok');
  setTimeout(function() { throw new Error('test') }, 0)
});
promise.then(function(value) { console.log(value) });
// ok
// Uncaught Error: test
ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise æŒ‡å®šåœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€å†æŠ›å‡ºé”™è¯¯ï¼Œç»“æœç”±äºæ²¡æœ‰æŒ‡å®šä½¿ç”¨try...catchè¯­å¥ï¼Œå°±å†’æ³¡åˆ°æœ€å¤–å±‚ï¼Œæˆäº†æœªæ•è·çš„é”™è¯¯ã€‚å› ä¸ºæ­¤æ—¶ï¼ŒPromiseçš„å‡½æ•°ä½“å·²ç»è¿è¡Œç»“æŸäº†ï¼Œæ‰€ä»¥è¿™ä¸ªé”™è¯¯æ˜¯åœ¨Promiseå‡½æ•°ä½“å¤–æŠ›å‡ºçš„ã€‚

Node æœ‰ä¸€ä¸ªunhandledRejectionäº‹ä»¶ï¼Œä¸“é—¨ç›‘å¬æœªæ•è·çš„rejecté”™è¯¯ã€‚

process.on('unhandledRejection', function (err, p) {
  console.error(err.stack)
});
ä¸Šé¢ä»£ç ä¸­ï¼ŒunhandledRejectionäº‹ä»¶çš„ç›‘å¬å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯é”™è¯¯å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ˜¯æŠ¥é”™çš„Promiseå®ä¾‹ï¼Œå®ƒå¯ä»¥ç”¨æ¥äº†è§£å‘ç”Ÿé”™è¯¯çš„ç¯å¢ƒä¿¡æ¯ã€‚ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œcatchæ–¹æ³•è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå› æ­¤åé¢è¿˜å¯ä»¥æ¥ç€è°ƒç”¨thenæ–¹æ³•ã€‚

var someAsyncThing = function() {
  return new Promise(function(resolve, reject) {
    // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºxæ²¡æœ‰å£°æ˜
    resolve(x + 2);
  });
};

someAsyncThing()
.catch(function(error) {
  console.log('oh no', error);
})
.then(function() {
  console.log('carry on');
});
// oh no [ReferenceError: x is not defined]
// carry on
ä¸Šé¢ä»£ç è¿è¡Œå®Œcatchæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œä¼šæ¥ç€è¿è¡Œåé¢é‚£ä¸ªthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œåˆ™ä¼šè·³è¿‡catchæ–¹æ³•ã€‚

Promise.resolve()
.catch(function(error) {
  console.log('oh no', error);
})
.then(function() {
  console.log('carry on');
});
// carry on
ä¸Šé¢çš„ä»£ç å› ä¸ºæ²¡æœ‰æŠ¥é”™ï¼Œè·³è¿‡äº†catchæ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œåé¢çš„thenæ–¹æ³•ã€‚æ­¤æ—¶ï¼Œè¦æ˜¯thenæ–¹æ³•é‡Œé¢æŠ¥é”™ï¼Œå°±ä¸å‰é¢çš„catchæ— å…³äº†ã€‚

catchæ–¹æ³•ä¹‹ä¸­ï¼Œè¿˜èƒ½å†æŠ›å‡ºé”™è¯¯ã€‚

var someAsyncThing = function() {
  return new Promise(function(resolve, reject) {
    // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºxæ²¡æœ‰å£°æ˜
    resolve(x + 2);
  });
};

someAsyncThing().then(function() {
  return someOtherAsyncThing();
}).catch(function(error) {
  console.log('oh no', error);
  // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºyæ²¡æœ‰å£°æ˜
  y + 2;
}).then(function() {
  console.log('carry on');
});
// oh no [ReferenceError: x is not defined]
ä¸Šé¢ä»£ç ä¸­ï¼Œcatchæ–¹æ³•æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºåé¢æ²¡æœ‰åˆ«çš„catchæ–¹æ³•äº†ï¼Œå¯¼è‡´è¿™ä¸ªé”™è¯¯ä¸ä¼šè¢«æ•è·ï¼Œä¹Ÿä¸ä¼šä¼ é€’åˆ°å¤–å±‚ã€‚å¦‚æœæ”¹å†™ä¸€ä¸‹ï¼Œç»“æœå°±ä¸ä¸€æ ·äº†ã€‚

someAsyncThing().then(function() {
  return someOtherAsyncThing();
}).catch(function(error) {
  console.log('oh no', error);
  // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºyæ²¡æœ‰å£°æ˜
  y + 2;
}).catch(function(error) {
  console.log('carry on', error);
});
// oh no [ReferenceError: x is not defined]
// carry on [ReferenceError: y is not defined]
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒä¸ªcatchæ–¹æ³•ç”¨æ¥æ•è·ï¼Œå‰ä¸€ä¸ªcatchæ–¹æ³•æŠ›å‡ºçš„é”™è¯¯ã€‚

Promise.all()
Promise.allæ–¹æ³•ç”¨äºå°†å¤šä¸ªPromiseå®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ã€‚

var p = Promise.all([p1, p2, p3]);
ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise.allæ–¹æ³•æ¥å—ä¸€ä¸ªæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œp1ã€p2ã€p3éƒ½æ˜¯Promiseå¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ä¼šå…ˆè°ƒç”¨ä¸‹é¢è®²åˆ°çš„Promise.resolveæ–¹æ³•ï¼Œå°†å‚æ•°è½¬ä¸ºPromiseå®ä¾‹ï¼Œå†è¿›ä¸€æ­¥å¤„ç†ã€‚ï¼ˆPromise.allæ–¹æ³•çš„å‚æ•°å¯ä»¥ä¸æ˜¯æ•°ç»„ï¼Œä½†å¿…é¡»å…·æœ‰Iteratoræ¥å£ï¼Œä¸”è¿”å›çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯Promiseå®ä¾‹ã€‚ï¼‰

pçš„çŠ¶æ€ç”±p1ã€p2ã€p3å†³å®šï¼Œåˆ†æˆä¸¤ç§æƒ…å†µã€‚

ï¼ˆ1ï¼‰åªæœ‰p1ã€p2ã€p3çš„çŠ¶æ€éƒ½å˜æˆfulfilledï¼Œpçš„çŠ¶æ€æ‰ä¼šå˜æˆfulfilledï¼Œæ­¤æ—¶p1ã€p2ã€p3çš„è¿”å›å€¼ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œä¼ é€’ç»™pçš„å›è°ƒå‡½æ•°ã€‚

ï¼ˆ2ï¼‰åªè¦p1ã€p2ã€p3ä¹‹ä¸­æœ‰ä¸€ä¸ªè¢«rejectedï¼Œpçš„çŠ¶æ€å°±å˜æˆrejectedï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªè¢«rejectçš„å®ä¾‹çš„è¿”å›å€¼ï¼Œä¼šä¼ é€’ç»™pçš„å›è°ƒå‡½æ•°ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚

// ç”Ÿæˆä¸€ä¸ªPromiseå¯¹è±¡çš„æ•°ç»„
var promises = [2, 3, 5, 7, 11, 13].map(function (id) {
  return getJSON("/post/" + id + ".json");
});

Promise.all(promises).then(function (posts) {
  // ...
}).catch(function(reason){
  // ...
});
ä¸Šé¢ä»£ç ä¸­ï¼Œpromisesæ˜¯åŒ…å«6ä¸ªPromiseå®ä¾‹çš„æ•°ç»„ï¼Œåªæœ‰è¿™6ä¸ªå®ä¾‹çš„çŠ¶æ€éƒ½å˜æˆfulfilledï¼Œæˆ–è€…å…¶ä¸­æœ‰ä¸€ä¸ªå˜ä¸ºrejectedï¼Œæ‰ä¼šè°ƒç”¨Promise.allæ–¹æ³•åé¢çš„å›è°ƒå‡½æ•°ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

const databasePromise = connectDatabase();

const booksPromise = databaseProimse
  .then(findAllBooks);

const userPromise = databasePromise
  .then(getCurrentUser);

Promise.all([
  booksPromise,
  userPromise
])
.then(([books, user]) => pickTopRecommentations(books, user));
ä¸Šé¢ä»£ç ä¸­ï¼ŒbooksPromiseå’ŒuserPromiseæ˜¯ä¸¤ä¸ªå¼‚æ­¥æ“ä½œï¼Œåªæœ‰ç­‰åˆ°å®ƒä»¬çš„ç»“æœéƒ½è¿”å›äº†ï¼Œæ‰ä¼šè§¦å‘pickTopRecommentationsè¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

Promise.race()
Promise.raceæ–¹æ³•åŒæ ·æ˜¯å°†å¤šä¸ªPromiseå®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ã€‚

var p = Promise.race([p1, p2, p3]);
ä¸Šé¢ä»£ç ä¸­ï¼Œåªè¦p1ã€p2ã€p3ä¹‹ä¸­æœ‰ä¸€ä¸ªå®ä¾‹ç‡å…ˆæ”¹å˜çŠ¶æ€ï¼Œpçš„çŠ¶æ€å°±è·Ÿç€æ”¹å˜ã€‚é‚£ä¸ªç‡å…ˆæ”¹å˜çš„ Promise å®ä¾‹çš„è¿”å›å€¼ï¼Œå°±ä¼ é€’ç»™pçš„å›è°ƒå‡½æ•°ã€‚

Promise.raceæ–¹æ³•çš„å‚æ•°ä¸Promise.allæ–¹æ³•ä¸€æ ·ï¼Œå¦‚æœä¸æ˜¯ Promise å®ä¾‹ï¼Œå°±ä¼šå…ˆè°ƒç”¨ä¸‹é¢è®²åˆ°çš„Promise.resolveæ–¹æ³•ï¼Œå°†å‚æ•°è½¬ä¸º Promise å®ä¾‹ï¼Œå†è¿›ä¸€æ­¥å¤„ç†ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å¾—ç»“æœï¼Œå°±å°†Promiseçš„çŠ¶æ€å˜ä¸ºrejectï¼Œå¦åˆ™å˜ä¸ºresolveã€‚

var p = Promise.race([
  fetch('/resource-that-may-take-a-while'),
  new Promise(function (resolve, reject) {
    setTimeout(() => reject(new Error('request timeout')), 5000)
  })
])
p.then(response => console.log(response))
p.catch(error => console.log(error))
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœ5ç§’ä¹‹å†…fetchæ–¹æ³•æ— æ³•è¿”å›ç»“æœï¼Œå˜é‡pçš„çŠ¶æ€å°±ä¼šå˜ä¸ºrejectedï¼Œä»è€Œè§¦å‘catchæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

Promise.resolve()
æœ‰æ—¶éœ€è¦å°†ç°æœ‰å¯¹è±¡è½¬ä¸ºPromiseå¯¹è±¡ï¼ŒPromise.resolveæ–¹æ³•å°±èµ·åˆ°è¿™ä¸ªä½œç”¨ã€‚

var jsPromise = Promise.resolve($.ajax('/whatever.json'));
ä¸Šé¢ä»£ç å°†jQueryç”Ÿæˆçš„deferredå¯¹è±¡ï¼Œè½¬ä¸ºä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ã€‚

Promise.resolveç­‰ä»·äºä¸‹é¢çš„å†™æ³•ã€‚

Promise.resolve('foo')
// ç­‰ä»·äº
new Promise(resolve => resolve('foo'))
Promise.resolveæ–¹æ³•çš„å‚æ•°åˆ†æˆå››ç§æƒ…å†µã€‚

ï¼ˆ1ï¼‰å‚æ•°æ˜¯ä¸€ä¸ªPromiseå®ä¾‹

å¦‚æœå‚æ•°æ˜¯Promiseå®ä¾‹ï¼Œé‚£ä¹ˆPromise.resolveå°†ä¸åšä»»ä½•ä¿®æ”¹ã€åŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå®ä¾‹ã€‚

ï¼ˆ2ï¼‰å‚æ•°æ˜¯ä¸€ä¸ªthenableå¯¹è±¡

thenableå¯¹è±¡æŒ‡çš„æ˜¯å…·æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªå¯¹è±¡ã€‚

let thenable = {
  then: function(resolve, reject) {
    resolve(42);
  }
};
Promise.resolveæ–¹æ³•ä¼šå°†è¿™ä¸ªå¯¹è±¡è½¬ä¸ºPromiseå¯¹è±¡ï¼Œç„¶åå°±ç«‹å³æ‰§è¡Œthenableå¯¹è±¡çš„thenæ–¹æ³•ã€‚

let thenable = {
  then: function(resolve, reject) {
    resolve(42);
  }
};

let p1 = Promise.resolve(thenable);
p1.then(function(value) {
  console.log(value);  // 42
});
ä¸Šé¢ä»£ç ä¸­ï¼Œthenableå¯¹è±¡çš„thenæ–¹æ³•æ‰§è¡Œåï¼Œå¯¹è±¡p1çš„çŠ¶æ€å°±å˜ä¸ºresolvedï¼Œä»è€Œç«‹å³æ‰§è¡Œæœ€åé‚£ä¸ªthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè¾“å‡º42ã€‚

ï¼ˆ3ï¼‰å‚æ•°ä¸æ˜¯å…·æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼Œæˆ–æ ¹æœ¬å°±ä¸æ˜¯å¯¹è±¡

å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªä¸å…·æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼Œåˆ™Promise.resolveæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ï¼ŒçŠ¶æ€ä¸ºResolvedã€‚

var p = Promise.resolve('Hello');

p.then(function (s){
  console.log(s)
});
// Hello
ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡çš„å®ä¾‹pã€‚ç”±äºå­—ç¬¦ä¸²Helloä¸å±äºå¼‚æ­¥æ“ä½œï¼ˆåˆ¤æ–­æ–¹æ³•æ˜¯å®ƒä¸æ˜¯å…·æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼‰ï¼Œè¿”å›Promiseå®ä¾‹çš„çŠ¶æ€ä»ä¸€ç”Ÿæˆå°±æ˜¯Resolvedï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚Promise.resolveæ–¹æ³•çš„å‚æ•°ï¼Œä¼šåŒæ—¶ä¼ ç»™å›è°ƒå‡½æ•°ã€‚

ï¼ˆ4ï¼‰ä¸å¸¦æœ‰ä»»ä½•å‚æ•°

Promise.resolveæ–¹æ³•å…è®¸è°ƒç”¨æ—¶ä¸å¸¦å‚æ•°ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªResolvedçŠ¶æ€çš„Promiseå¯¹è±¡ã€‚

æ‰€ä»¥ï¼Œå¦‚æœå¸Œæœ›å¾—åˆ°ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œæ¯”è¾ƒæ–¹ä¾¿çš„æ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨Promise.resolveæ–¹æ³•ã€‚

var p = Promise.resolve();

p.then(function () {
  // ...
});
ä¸Šé¢ä»£ç çš„å˜é‡på°±æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç«‹å³resolveçš„Promiseå¯¹è±¡ï¼Œæ˜¯åœ¨æœ¬è½®â€œäº‹ä»¶å¾ªç¯â€ï¼ˆevent loopï¼‰çš„ç»“æŸæ—¶ï¼Œè€Œä¸æ˜¯åœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€çš„å¼€å§‹æ—¶ã€‚

setTimeout(function () {
  console.log('three');
}, 0);

Promise.resolve().then(function () {
  console.log('two');
});

console.log('one');

// one
// two
// three
ä¸Šé¢ä»£ç ä¸­ï¼ŒsetTimeout(fn, 0)åœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€å¼€å§‹æ—¶æ‰§è¡Œï¼ŒPromise.resolve()åœ¨æœ¬è½®â€œäº‹ä»¶å¾ªç¯â€ç»“æŸæ—¶æ‰§è¡Œï¼Œconsole.log(â€™oneâ€˜)åˆ™æ˜¯ç«‹å³æ‰§è¡Œï¼Œå› æ­¤æœ€å…ˆè¾“å‡ºã€‚

Promise.reject()
Promise.reject(reason)æ–¹æ³•ä¹Ÿä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œè¯¥å®ä¾‹çš„çŠ¶æ€ä¸ºrejectedã€‚

var p = Promise.reject('å‡ºé”™äº†');
// ç­‰åŒäº
var p = new Promise((resolve, reject) => reject('å‡ºé”™äº†'))

p.then(null, function (s) {
  console.log(s)
});
// å‡ºé”™äº†
ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ªPromiseå¯¹è±¡çš„å®ä¾‹pï¼ŒçŠ¶æ€ä¸ºrejectedï¼Œå›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚

æ³¨æ„ï¼ŒPromise.reject()æ–¹æ³•çš„å‚æ•°ï¼Œä¼šåŸå°ä¸åŠ¨åœ°ä½œä¸ºrejectçš„ç†ç”±ï¼Œå˜æˆåç»­æ–¹æ³•çš„å‚æ•°ã€‚è¿™ä¸€ç‚¹ä¸Promise.resolveæ–¹æ³•ä¸ä¸€è‡´ã€‚

const thenable = {
  then(resolve, reject) {
    reject('å‡ºé”™äº†');
  }
};

Promise.reject(thenable)
.catch(e => {
  console.log(e === thenable)
})
// true
ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise.rejectæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªthenableå¯¹è±¡ï¼Œæ‰§è¡Œä»¥åï¼Œåé¢catchæ–¹æ³•çš„å‚æ•°ä¸æ˜¯rejectæŠ›å‡ºçš„â€œå‡ºé”™äº†â€è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯thenableå¯¹è±¡ã€‚

ä¸¤ä¸ªæœ‰ç”¨çš„é™„åŠ æ–¹æ³•
ES6çš„Promise APIæä¾›çš„æ–¹æ³•ä¸æ˜¯å¾ˆå¤šï¼Œæœ‰äº›æœ‰ç”¨çš„æ–¹æ³•å¯ä»¥è‡ªå·±éƒ¨ç½²ã€‚ä¸‹é¢ä»‹ç»å¦‚ä½•éƒ¨ç½²ä¸¤ä¸ªä¸åœ¨ES6ä¹‹ä¸­ã€ä½†å¾ˆæœ‰ç”¨çš„æ–¹æ³•ã€‚

done()
Promiseå¯¹è±¡çš„å›è°ƒé“¾ï¼Œä¸ç®¡ä»¥thenæ–¹æ³•æˆ–catchæ–¹æ³•ç»“å°¾ï¼Œè¦æ˜¯æœ€åä¸€ä¸ªæ–¹æ³•æŠ›å‡ºé”™è¯¯ï¼Œéƒ½æœ‰å¯èƒ½æ— æ³•æ•æ‰åˆ°ï¼ˆå› ä¸ºPromiseå†…éƒ¨çš„é”™è¯¯ä¸ä¼šå†’æ³¡åˆ°å…¨å±€ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªdoneæ–¹æ³•ï¼Œæ€»æ˜¯å¤„äºå›è°ƒé“¾çš„å°¾ç«¯ï¼Œä¿è¯æŠ›å‡ºä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚

asyncFunc()
  .then(f1)
  .catch(r1)
  .then(f2)
  .done();
å®ƒçš„å®ç°ä»£ç ç›¸å½“ç®€å•ã€‚

Promise.prototype.done = function (onFulfilled, onRejected) {
  this.then(onFulfilled, onRejected)
    .catch(function (reason) {
      // æŠ›å‡ºä¸€ä¸ªå…¨å±€é”™è¯¯
      setTimeout(() => { throw reason }, 0);
    });
};
ä»ä¸Šé¢ä»£ç å¯è§ï¼Œdoneæ–¹æ³•çš„ä½¿ç”¨ï¼Œå¯ä»¥åƒthenæ–¹æ³•é‚£æ ·ç”¨ï¼Œæä¾›Fulfilledå’ŒRejectedçŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä¸æä¾›ä»»ä½•å‚æ•°ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œdoneéƒ½ä¼šæ•æ‰åˆ°ä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œå¹¶å‘å…¨å±€æŠ›å‡ºã€‚

finally()
finallyæ–¹æ³•ç”¨äºæŒ‡å®šä¸ç®¡Promiseå¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œã€‚å®ƒä¸doneæ–¹æ³•çš„æœ€å¤§åŒºåˆ«ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ™®é€šçš„å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¸ç®¡æ€æ ·éƒ½å¿…é¡»æ‰§è¡Œã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼ŒæœåŠ¡å™¨ä½¿ç”¨Promiseå¤„ç†è¯·æ±‚ï¼Œç„¶åä½¿ç”¨finallyæ–¹æ³•å…³æ‰æœåŠ¡å™¨ã€‚

server.listen(0)
  .then(function () {
    // run test
  })
  .finally(server.stop);
å®ƒçš„å®ç°ä¹Ÿå¾ˆç®€å•ã€‚

Promise.prototype.finally = function (callback) {
  let P = this.constructor;
  return this.then(
    value  => P.resolve(callback()).then(() => value),
    reason => P.resolve(callback()).then(() => { throw reason })
  );
};
ä¸Šé¢ä»£ç ä¸­ï¼Œä¸ç®¡å‰é¢çš„Promiseæ˜¯fulfilledè¿˜æ˜¯rejectedï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°callbackã€‚

åº”ç”¨
åŠ è½½å›¾ç‰‡
æˆ‘ä»¬å¯ä»¥å°†å›¾ç‰‡çš„åŠ è½½å†™æˆä¸€ä¸ªPromiseï¼Œä¸€æ—¦åŠ è½½å®Œæˆï¼ŒPromiseçš„çŠ¶æ€å°±å‘ç”Ÿå˜åŒ–ã€‚

const preloadImage = function (path) {
  return new Promise(function (resolve, reject) {
    var image = new Image();
    image.onload  = resolve;
    image.onerror = reject;
    image.src = path;
  });
};
Generatorå‡½æ•°ä¸Promiseçš„ç»“åˆ
ä½¿ç”¨Generatorå‡½æ•°ç®¡ç†æµç¨‹ï¼Œé‡åˆ°å¼‚æ­¥æ“ä½œçš„æ—¶å€™ï¼Œé€šå¸¸è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ã€‚

function getFoo () {
  return new Promise(function (resolve, reject){
    resolve('foo');
  });
}

var g = function* () {
  try {
    var foo = yield getFoo();
    console.log(foo);
  } catch (e) {
    console.log(e);
  }
};

function run (generator) {
  var it = generator();

  function go(result) {
    if (result.done) return result.value;

    return result.value.then(function (value) {
      return go(it.next(value));
    }, function (error) {
      return go(it.throw(error));
    });
  }

  go(it.next());
}

run(g);
ä¸Šé¢ä»£ç çš„Generatorå‡½æ•°gä¹‹ä¸­ï¼Œæœ‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œgetFooï¼Œå®ƒè¿”å›çš„å°±æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ã€‚å‡½æ•°runç”¨æ¥å¤„ç†è¿™ä¸ªPromiseå¯¹è±¡ï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªnextæ–¹æ³•ã€‚

Promise.try()
å®é™…å¼€å‘ä¸­ï¼Œç»å¸¸é‡åˆ°ä¸€ç§æƒ…å†µï¼šä¸çŸ¥é“æˆ–è€…ä¸æƒ³åŒºåˆ†ï¼Œå‡½æ•°fæ˜¯åŒæ­¥å‡½æ•°è¿˜æ˜¯å¼‚æ­¥æ“ä½œï¼Œä½†æ˜¯æƒ³ç”¨ Promise æ¥å¤„ç†å®ƒã€‚å› ä¸ºè¿™æ ·å°±å¯ä»¥ä¸ç®¡fæ˜¯å¦åŒ…å«å¼‚æ­¥æ“ä½œï¼Œéƒ½ç”¨thenæ–¹æ³•æŒ‡å®šä¸‹ä¸€æ­¥æµç¨‹ï¼Œç”¨catchæ–¹æ³•å¤„ç†fæŠ›å‡ºçš„é”™è¯¯ã€‚ä¸€èˆ¬å°±ä¼šé‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚

Promise.resolve().then(f)
ä¸Šé¢çš„å†™æ³•æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å¦‚æœfæ˜¯åŒæ­¥å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œã€‚

const f = () => console.log('now');
Promise.resolve().then(f);
console.log('next');
// next
// now
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fæ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯ç”¨ Promise åŒ…è£…äº†ä»¥åï¼Œå°±å˜æˆå¼‚æ­¥æ‰§è¡Œäº†ã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œè®©åŒæ­¥å‡½æ•°åŒæ­¥æ‰§è¡Œï¼Œå¼‚æ­¥å‡½æ•°å¼‚æ­¥æ‰§è¡Œï¼Œå¹¶ä¸”è®©å®ƒä»¬å…·æœ‰ç»Ÿä¸€çš„ API å‘¢ï¼Ÿå›ç­”æ˜¯å¯ä»¥çš„ï¼Œå¹¶ä¸”è¿˜æœ‰ä¸¤ç§å†™æ³•ã€‚ç¬¬ä¸€ç§å†™æ³•æ˜¯ç”¨asyncå‡½æ•°æ¥å†™ã€‚

const f = () => console.log('now');
(async () => f())();
console.log('next');
// now
// next
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬ä¸€è¡Œæ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼Œä¼šç«‹å³æ‰§è¡Œé‡Œé¢çš„asyncå‡½æ•°ï¼Œå› æ­¤å¦‚æœfæ˜¯åŒæ­¥çš„ï¼Œå°±ä¼šå¾—åˆ°åŒæ­¥çš„ç»“æœï¼›å¦‚æœfæ˜¯å¼‚æ­¥çš„ï¼Œå°±å¯ä»¥ç”¨thenæŒ‡å®šä¸‹ä¸€æ­¥ï¼Œå°±åƒä¸‹é¢çš„å†™æ³•ã€‚

(async () => f())()
.then(...)
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œasync () => f()ä¼šåƒæ‰f()æŠ›å‡ºçš„é”™è¯¯ã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³æ•è·é”™è¯¯ï¼Œè¦ä½¿ç”¨promise.catchæ–¹æ³•ã€‚

(async () => f())()
.then(...)
.catch(...)
ç¬¬äºŒç§å†™æ³•æ˜¯ä½¿ç”¨new Promise()ã€‚

const f = () => console.log('now');
(
  () => new Promise(
    resolve => resolve(f())
  )
)();
console.log('next');
// now
// next
ä¸Šé¢ä»£ç ä¹Ÿæ˜¯ä½¿ç”¨ç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼Œæ‰§è¡Œnew Promise()ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒåŒæ­¥å‡½æ•°ä¹Ÿæ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚

é‰´äºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œæ‰€ä»¥ç°åœ¨æœ‰ä¸€ä¸ªææ¡ˆï¼Œæä¾›Promise.tryæ–¹æ³•æ›¿ä»£ä¸Šé¢çš„å†™æ³•ã€‚

const f = () => console.log('now');
Promise.try(f);
console.log('next');
// now
// next
äº‹å®ä¸Šï¼ŒPromise.tryå­˜åœ¨å·²ä¹…ï¼ŒPromise åº“Bluebirdã€Qå’Œwhenï¼Œæ—©å°±æä¾›äº†è¿™ä¸ªæ–¹æ³•ã€‚

ç”±äºPromise.tryä¸ºæ‰€æœ‰æ“ä½œæä¾›äº†ç»Ÿä¸€çš„å¤„ç†æœºåˆ¶ï¼Œæ‰€ä»¥å¦‚æœæƒ³ç”¨thenæ–¹æ³•ç®¡ç†æµç¨‹ï¼Œæœ€å¥½éƒ½ç”¨Promise.tryåŒ…è£…ä¸€ä¸‹ã€‚è¿™æ ·æœ‰è®¸å¤šå¥½å¤„ï¼Œå…¶ä¸­ä¸€ç‚¹å°±æ˜¯å¯ä»¥æ›´å¥½åœ°ç®¡ç†å¼‚å¸¸ã€‚

function getUsername(userId) {
  return database.users.get({id: userId})
  .then(function(user) {
    return user.name;
  });
}
ä¸Šé¢ä»£ç ä¸­ï¼Œdatabase.users.get()è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœæŠ›å‡ºå¼‚æ­¥é”™è¯¯ï¼Œå¯ä»¥ç”¨catchæ–¹æ³•æ•è·ï¼Œå°±åƒä¸‹é¢è¿™æ ·å†™ã€‚

database.users.get({id: userId})
.then(...)
.catch(...)
ä½†æ˜¯database.users.get()å¯èƒ½è¿˜ä¼šæŠ›å‡ºåŒæ­¥é”™è¯¯ï¼ˆæ¯”å¦‚æ•°æ®åº“è¿æ¥é”™è¯¯ï¼Œå…·ä½“è¦çœ‹å®ç°æ–¹æ³•ï¼‰ï¼Œè¿™æ—¶ä½ å°±ä¸å¾—ä¸ç”¨try...catchå»æ•è·ã€‚

try {
  database.users.get({id: userId})
  .then(...)
  .catch(...)
} catch (e) {
  // ...
}
ä¸Šé¢è¿™æ ·çš„å†™æ³•å°±å¾ˆç¬¨æ‹™äº†ï¼Œè¿™æ—¶å°±å¯ä»¥ç»Ÿä¸€ç”¨promise.catch()æ•è·æ‰€æœ‰åŒæ­¥å’Œå¼‚æ­¥çš„é”™è¯¯ã€‚

Promise.try(database.users.get({id: userId}))
  .then(...)
  .catch(...)
äº‹å®ä¸Šï¼ŒPromise.tryå°±æ˜¯æ¨¡æ‹Ÿtryä»£ç å—ï¼Œå°±åƒpromise.catchæ¨¡æ‹Ÿçš„æ˜¯catchä»£ç å—ã€‚

##å¼‚æ­¥æ“ä½œå’ŒAsyncå‡½æ•°
1.åŸºæœ¬æ¦‚å¿µ
å¼‚æ­¥
æ‰€è°“"å¼‚æ­¥"ï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªä»»åŠ¡åˆ†æˆä¸¤æ®µï¼Œå…ˆæ‰§è¡Œç¬¬ä¸€æ®µï¼Œç„¶åè½¬è€Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œç­‰åšå¥½äº†å‡†å¤‡ï¼Œå†å›è¿‡å¤´æ‰§è¡Œç¬¬äºŒæ®µã€‚

æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ªä»»åŠ¡æ˜¯è¯»å–æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œä»»åŠ¡çš„ç¬¬ä¸€æ®µæ˜¯å‘æ“ä½œç³»ç»Ÿå‘å‡ºè¯·æ±‚ï¼Œè¦æ±‚è¯»å–æ–‡ä»¶ã€‚ç„¶åï¼Œç¨‹åºæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œç­‰åˆ°æ“ä½œç³»ç»Ÿè¿”å›æ–‡ä»¶ï¼Œå†æ¥ç€æ‰§è¡Œä»»åŠ¡çš„ç¬¬äºŒæ®µï¼ˆå¤„ç†æ–‡ä»¶ï¼‰ã€‚è¿™ç§ä¸è¿ç»­çš„æ‰§è¡Œï¼Œå°±å«åšå¼‚æ­¥ã€‚

ç›¸åº”åœ°ï¼Œè¿ç»­çš„æ‰§è¡Œå°±å«åšåŒæ­¥ã€‚ç”±äºæ˜¯è¿ç»­æ‰§è¡Œï¼Œä¸èƒ½æ’å…¥å…¶ä»–ä»»åŠ¡ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿä»ç¡¬ç›˜è¯»å–æ–‡ä»¶çš„è¿™æ®µæ—¶é—´ï¼Œç¨‹åºåªèƒ½å¹²ç­‰ç€ã€‚

å›è°ƒå‡½æ•°
JavaScriptè¯­è¨€å¯¹å¼‚æ­¥ç¼–ç¨‹çš„å®ç°ï¼Œå°±æ˜¯å›è°ƒå‡½æ•°ã€‚æ‰€è°“å›è°ƒå‡½æ•°ï¼Œå°±æ˜¯æŠŠä»»åŠ¡çš„ç¬¬äºŒæ®µå•ç‹¬å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œç­‰åˆ°é‡æ–°æ‰§è¡Œè¿™ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œå°±ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚å®ƒçš„è‹±è¯­åå­—callbackï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯"é‡æ–°è°ƒç”¨"ã€‚

è¯»å–æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œæ˜¯è¿™æ ·å†™çš„ã€‚

fs.readFile('/etc/passwd', function (err, data) {
  if (err) throw err;
  console.log(data);
});
ä¸Šé¢ä»£ç ä¸­ï¼ŒreadFileå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå°±æ˜¯å›è°ƒå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä»»åŠ¡çš„ç¬¬äºŒæ®µã€‚ç­‰åˆ°æ“ä½œç³»ç»Ÿè¿”å›äº†/etc/passwdè¿™ä¸ªæ–‡ä»¶ä»¥åï¼Œå›è°ƒå‡½æ•°æ‰ä¼šæ‰§è¡Œã€‚

ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆNode.jsçº¦å®šï¼Œå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¿…é¡»æ˜¯é”™è¯¯å¯¹è±¡errï¼ˆå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œè¯¥å‚æ•°å°±æ˜¯nullï¼‰ï¼ŸåŸå› æ˜¯æ‰§è¡Œåˆ†æˆä¸¤æ®µï¼Œåœ¨è¿™ä¸¤æ®µä¹‹é—´æŠ›å‡ºçš„é”™è¯¯ï¼Œç¨‹åºæ— æ³•æ•æ‰ï¼Œåªèƒ½å½“ä½œå‚æ•°ï¼Œä¼ å…¥ç¬¬äºŒæ®µã€‚

Promise
å›è°ƒå‡½æ•°æœ¬èº«å¹¶æ²¡æœ‰é—®é¢˜ï¼Œå®ƒçš„é—®é¢˜å‡ºç°åœ¨å¤šä¸ªå›è°ƒå‡½æ•°åµŒå¥—ã€‚å‡å®šè¯»å–Aæ–‡ä»¶ä¹‹åï¼Œå†è¯»å–Bæ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ã€‚

fs.readFile(fileA, function (err, data) {
  fs.readFile(fileB, function (err, data) {
    // ...
  });
});
ä¸éš¾æƒ³è±¡ï¼Œå¦‚æœä¾æ¬¡è¯»å–å¤šä¸ªæ–‡ä»¶ï¼Œå°±ä¼šå‡ºç°å¤šé‡åµŒå¥—ã€‚ä»£ç ä¸æ˜¯çºµå‘å‘å±•ï¼Œè€Œæ˜¯æ¨ªå‘å‘å±•ï¼Œå¾ˆå¿«å°±ä¼šä¹±æˆä¸€å›¢ï¼Œæ— æ³•ç®¡ç†ã€‚è¿™ç§æƒ…å†µå°±ç§°ä¸º"å›è°ƒå‡½æ•°åœ°ç‹±"ï¼ˆcallback hellï¼‰ã€‚

Promiseå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œæå‡ºçš„ã€‚å®ƒä¸æ˜¯æ–°çš„è¯­æ³•åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸€ç§æ–°çš„å†™æ³•ï¼Œå…è®¸å°†å›è°ƒå‡½æ•°çš„åµŒå¥—ï¼Œæ”¹æˆé“¾å¼è°ƒç”¨ã€‚é‡‡ç”¨Promiseï¼Œè¿ç»­è¯»å–å¤šä¸ªæ–‡ä»¶ï¼Œå†™æ³•å¦‚ä¸‹ã€‚

var readFile = require('fs-readfile-promise');

readFile(fileA)
.then(function(data){
  console.log(data.toString());
})
.then(function(){
  return readFile(fileB);
})
.then(function(data){
  console.log(data.toString());
})
.catch(function(err) {
  console.log(err);
});
ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†fs-readfile-promiseæ¨¡å—ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯è¿”å›ä¸€ä¸ªPromiseç‰ˆæœ¬çš„readFileå‡½æ•°ã€‚Promiseæä¾›thenæ–¹æ³•åŠ è½½å›è°ƒå‡½æ•°ï¼Œcatchæ–¹æ³•æ•æ‰æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºçš„é”™è¯¯ã€‚

å¯ä»¥çœ‹åˆ°ï¼ŒPromise çš„å†™æ³•åªæ˜¯å›è°ƒå‡½æ•°çš„æ”¹è¿›ï¼Œä½¿ç”¨thenæ–¹æ³•ä»¥åï¼Œå¼‚æ­¥ä»»åŠ¡çš„ä¸¤æ®µæ‰§è¡Œçœ‹å¾—æ›´æ¸…æ¥šäº†ï¼Œé™¤æ­¤ä»¥å¤–ï¼Œå¹¶æ— æ–°æ„ã€‚

Promise çš„æœ€å¤§é—®é¢˜æ˜¯ä»£ç å†—ä½™ï¼ŒåŸæ¥çš„ä»»åŠ¡è¢«Promise åŒ…è£…äº†ä¸€ä¸‹ï¼Œä¸ç®¡ä»€ä¹ˆæ“ä½œï¼Œä¸€çœ¼çœ‹å»éƒ½æ˜¯ä¸€å † thenï¼ŒåŸæ¥çš„è¯­ä¹‰å˜å¾—å¾ˆä¸æ¸…æ¥šã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„å†™æ³•å‘¢ï¼Ÿ

Generatorå‡½æ•°
åç¨‹
ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€ï¼Œæ—©æœ‰å¼‚æ­¥ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆï¼ˆå…¶å®æ˜¯å¤šä»»åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼‰ã€‚å…¶ä¸­æœ‰ä¸€ç§å«åš"åç¨‹"ï¼ˆcoroutineï¼‰ï¼Œæ„æ€æ˜¯å¤šä¸ªçº¿ç¨‹äº’ç›¸åä½œï¼Œå®Œæˆå¼‚æ­¥ä»»åŠ¡ã€‚

åç¨‹æœ‰ç‚¹åƒå‡½æ•°ï¼Œåˆæœ‰ç‚¹åƒçº¿ç¨‹ã€‚å®ƒçš„è¿è¡Œæµç¨‹å¤§è‡´å¦‚ä¸‹ã€‚

ç¬¬ä¸€æ­¥ï¼Œåç¨‹Aå¼€å§‹æ‰§è¡Œã€‚
ç¬¬äºŒæ­¥ï¼Œåç¨‹Aæ‰§è¡Œåˆ°ä¸€åŠï¼Œè¿›å…¥æš‚åœï¼Œæ‰§è¡Œæƒè½¬ç§»åˆ°åç¨‹Bã€‚
ç¬¬ä¸‰æ­¥ï¼Œï¼ˆä¸€æ®µæ—¶é—´åï¼‰åç¨‹Bäº¤è¿˜æ‰§è¡Œæƒã€‚
ç¬¬å››æ­¥ï¼Œåç¨‹Aæ¢å¤æ‰§è¡Œã€‚
ä¸Šé¢æµç¨‹çš„åç¨‹Aï¼Œå°±æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œå› ä¸ºå®ƒåˆ†æˆä¸¤æ®µï¼ˆæˆ–å¤šæ®µï¼‰æ‰§è¡Œã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œè¯»å–æ–‡ä»¶çš„åç¨‹å†™æ³•å¦‚ä¸‹ã€‚

function *asyncJob() {
  // ...å…¶ä»–ä»£ç 
  var f = yield readFile(fileA);
  // ...å…¶ä»–ä»£ç 
}
ä¸Šé¢ä»£ç çš„å‡½æ•°asyncJobæ˜¯ä¸€ä¸ªåç¨‹ï¼Œå®ƒçš„å¥¥å¦™å°±åœ¨å…¶ä¸­çš„yieldå‘½ä»¤ã€‚å®ƒè¡¨ç¤ºæ‰§è¡Œåˆ°æ­¤å¤„ï¼Œæ‰§è¡Œæƒå°†äº¤ç»™å…¶ä»–åç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œyieldå‘½ä»¤æ˜¯å¼‚æ­¥ä¸¤ä¸ªé˜¶æ®µçš„åˆ†ç•Œçº¿ã€‚

åç¨‹é‡åˆ°yieldå‘½ä»¤å°±æš‚åœï¼Œç­‰åˆ°æ‰§è¡Œæƒè¿”å›ï¼Œå†ä»æš‚åœçš„åœ°æ–¹ç»§ç»­å¾€åæ‰§è¡Œã€‚å®ƒçš„æœ€å¤§ä¼˜ç‚¹ï¼Œå°±æ˜¯ä»£ç çš„å†™æ³•éå¸¸åƒåŒæ­¥æ“ä½œï¼Œå¦‚æœå»é™¤yieldå‘½ä»¤ï¼Œç®€ç›´ä¸€æ¨¡ä¸€æ ·ã€‚

Generatorå‡½æ•°çš„æ¦‚å¿µ
Generatorå‡½æ•°æ˜¯åç¨‹åœ¨ES6çš„å®ç°ï¼Œæœ€å¤§ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒï¼ˆå³æš‚åœæ‰§è¡Œï¼‰ã€‚

æ•´ä¸ªGeneratorå‡½æ•°å°±æ˜¯ä¸€ä¸ªå°è£…çš„å¼‚æ­¥ä»»åŠ¡ï¼Œæˆ–è€…è¯´æ˜¯å¼‚æ­¥ä»»åŠ¡çš„å®¹å™¨ã€‚å¼‚æ­¥æ“ä½œéœ€è¦æš‚åœçš„åœ°æ–¹ï¼Œéƒ½ç”¨yieldè¯­å¥æ³¨æ˜ã€‚Generatorå‡½æ•°çš„æ‰§è¡Œæ–¹æ³•å¦‚ä¸‹ã€‚

function* gen(x){
  var y = yield x + 2;
  return y;
}

var g = gen(1);
g.next() // { value: 3, done: false }
g.next() // { value: undefined, done: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œè°ƒç”¨Generatorå‡½æ•°ï¼Œä¼šè¿”å›ä¸€ä¸ªå†…éƒ¨æŒ‡é’ˆï¼ˆå³éå†å™¨ï¼‰g ã€‚è¿™æ˜¯Generatorå‡½æ•°ä¸åŒäºæ™®é€šå‡½æ•°çš„å¦ä¸€ä¸ªåœ°æ–¹ï¼Œå³æ‰§è¡Œå®ƒä¸ä¼šè¿”å›ç»“æœï¼Œè¿”å›çš„æ˜¯æŒ‡é’ˆå¯¹è±¡ã€‚è°ƒç”¨æŒ‡é’ˆgçš„nextæ–¹æ³•ï¼Œä¼šç§»åŠ¨å†…éƒ¨æŒ‡é’ˆï¼ˆå³æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ç¬¬ä¸€æ®µï¼‰ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªé‡åˆ°çš„yieldè¯­å¥ï¼Œä¸Šä¾‹æ˜¯æ‰§è¡Œåˆ°x + 2ä¸ºæ­¢ã€‚

æ¢è¨€ä¹‹ï¼Œnextæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ†é˜¶æ®µæ‰§è¡ŒGeneratorå‡½æ•°ã€‚æ¯æ¬¡è°ƒç”¨nextæ–¹æ³•ï¼Œä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰é˜¶æ®µçš„ä¿¡æ¯ï¼ˆvalueå±æ€§å’Œdoneå±æ€§ï¼‰ã€‚valueå±æ€§æ˜¯yieldè¯­å¥åé¢è¡¨è¾¾å¼çš„å€¼ï¼Œè¡¨ç¤ºå½“å‰é˜¶æ®µçš„å€¼ï¼›doneå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºGeneratorå‡½æ•°æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œå³æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

Generatorå‡½æ•°çš„æ•°æ®äº¤æ¢å’Œé”™è¯¯å¤„ç†
Generatorå‡½æ•°å¯ä»¥æš‚åœæ‰§è¡Œå’Œæ¢å¤æ‰§è¡Œï¼Œè¿™æ˜¯å®ƒèƒ½å°è£…å¼‚æ­¥ä»»åŠ¡çš„æ ¹æœ¬åŸå› ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æœ‰ä¸¤ä¸ªç‰¹æ€§ï¼Œä½¿å®ƒå¯ä»¥ä½œä¸ºå¼‚æ­¥ç¼–ç¨‹çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼šå‡½æ•°ä½“å†…å¤–çš„æ•°æ®äº¤æ¢å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚

nextæ–¹æ³•è¿”å›å€¼çš„valueå±æ€§ï¼Œæ˜¯Generatorå‡½æ•°å‘å¤–è¾“å‡ºæ•°æ®ï¼›nextæ–¹æ³•è¿˜å¯ä»¥æ¥å—å‚æ•°ï¼Œè¿™æ˜¯å‘Generatorå‡½æ•°ä½“å†…è¾“å…¥æ•°æ®ã€‚

function* gen(x){
  var y = yield x + 2;
  return y;
}

var g = gen(1);
g.next() // { value: 3, done: false }
g.next(2) // { value: 2, done: true }
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬ä¸€ä¸ªnextæ–¹æ³•çš„valueå±æ€§ï¼Œè¿”å›è¡¨è¾¾å¼x + 2çš„å€¼ï¼ˆ3ï¼‰ã€‚ç¬¬äºŒä¸ªnextæ–¹æ³•å¸¦æœ‰å‚æ•°2ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥ Generator å‡½æ•°ï¼Œä½œä¸ºä¸Šä¸ªé˜¶æ®µå¼‚æ­¥ä»»åŠ¡çš„è¿”å›ç»“æœï¼Œè¢«å‡½æ•°ä½“å†…çš„å˜é‡yæ¥æ”¶ã€‚å› æ­¤ï¼Œè¿™ä¸€æ­¥çš„ value å±æ€§ï¼Œè¿”å›çš„å°±æ˜¯2ï¼ˆå˜é‡yçš„å€¼ï¼‰ã€‚

Generator å‡½æ•°å†…éƒ¨è¿˜å¯ä»¥éƒ¨ç½²é”™è¯¯å¤„ç†ä»£ç ï¼Œæ•è·å‡½æ•°ä½“å¤–æŠ›å‡ºçš„é”™è¯¯ã€‚

function* gen(x){
  try {
    var y = yield x + 2;
  } catch (e){
    console.log(e);
  }
  return y;
}

var g = gen(1);
g.next();
g.throw('å‡ºé”™äº†');
// å‡ºé”™äº†
ä¸Šé¢ä»£ç çš„æœ€åä¸€è¡Œï¼ŒGeneratorå‡½æ•°ä½“å¤–ï¼Œä½¿ç”¨æŒ‡é’ˆå¯¹è±¡çš„throwæ–¹æ³•æŠ›å‡ºçš„é”™è¯¯ï¼Œå¯ä»¥è¢«å‡½æ•°ä½“å†…çš„try ...catchä»£ç å—æ•è·ã€‚è¿™æ„å‘³ç€ï¼Œå‡ºé”™çš„ä»£ç ä¸å¤„ç†é”™è¯¯çš„ä»£ç ï¼Œå®ç°äº†æ—¶é—´å’Œç©ºé—´ä¸Šçš„åˆ†ç¦»ï¼Œè¿™å¯¹äºå¼‚æ­¥ç¼–ç¨‹æ— ç–‘æ˜¯å¾ˆé‡è¦çš„ã€‚

å¼‚æ­¥ä»»åŠ¡çš„å°è£…
ä¸‹é¢çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Generator å‡½æ•°ï¼Œæ‰§è¡Œä¸€ä¸ªçœŸå®çš„å¼‚æ­¥ä»»åŠ¡ã€‚

var fetch = require('node-fetch');

function* gen(){
  var url = 'https://api.github.com/users/github';
  var result = yield fetch(url);
  console.log(result.bio);
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°å°è£…äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œè¯¥æ“ä½œå…ˆè¯»å–ä¸€ä¸ªè¿œç¨‹æ¥å£ï¼Œç„¶åä»JSONæ ¼å¼çš„æ•°æ®è§£æä¿¡æ¯ã€‚å°±åƒå‰é¢è¯´è¿‡çš„ï¼Œè¿™æ®µä»£ç éå¸¸åƒåŒæ­¥æ“ä½œï¼Œé™¤äº†åŠ ä¸Šäº†yieldå‘½ä»¤ã€‚

æ‰§è¡Œè¿™æ®µä»£ç çš„æ–¹æ³•å¦‚ä¸‹ã€‚

var g = gen();
var result = g.next();

result.value.then(function(data){
  return data.json();
}).then(function(data){
  g.next(data);
});
ä¸Šé¢ä»£ç ä¸­ï¼Œé¦–å…ˆæ‰§è¡ŒGeneratorå‡½æ•°ï¼Œè·å–éå†å™¨å¯¹è±¡ï¼Œç„¶åä½¿ç”¨next æ–¹æ³•ï¼ˆç¬¬äºŒè¡Œï¼‰ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ç¬¬ä¸€é˜¶æ®µã€‚ç”±äºFetchæ¨¡å—è¿”å›çš„æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå› æ­¤è¦ç”¨thenæ–¹æ³•è°ƒç”¨ä¸‹ä¸€ä¸ªnext æ–¹æ³•ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ Generator å‡½æ•°å°†å¼‚æ­¥æ“ä½œè¡¨ç¤ºå¾—å¾ˆç®€æ´ï¼Œä½†æ˜¯æµç¨‹ç®¡ç†å´ä¸æ–¹ä¾¿ï¼ˆå³ä½•æ—¶æ‰§è¡Œç¬¬ä¸€é˜¶æ®µã€ä½•æ—¶æ‰§è¡Œç¬¬äºŒé˜¶æ®µï¼‰ã€‚

Thunkå‡½æ•°
å‚æ•°çš„æ±‚å€¼ç­–ç•¥
Thunkå‡½æ•°æ—©åœ¨ä¸Šä¸ªä¸–çºª60å¹´ä»£å°±è¯ç”Ÿäº†ã€‚

é‚£æ—¶ï¼Œç¼–ç¨‹è¯­è¨€åˆšåˆšèµ·æ­¥ï¼Œè®¡ç®—æœºå­¦å®¶è¿˜åœ¨ç ”ç©¶ï¼Œç¼–è¯‘å™¨æ€ä¹ˆå†™æ¯”è¾ƒå¥½ã€‚ä¸€ä¸ªäº‰è®ºçš„ç„¦ç‚¹æ˜¯"æ±‚å€¼ç­–ç•¥"ï¼Œå³å‡½æ•°çš„å‚æ•°åˆ°åº•åº”è¯¥ä½•æ—¶æ±‚å€¼ã€‚

var x = 1;

function f(m){
  return m * 2;
}

f(x + 5)
ä¸Šé¢ä»£ç å…ˆå®šä¹‰å‡½æ•°fï¼Œç„¶åå‘å®ƒä¼ å…¥è¡¨è¾¾å¼x + 5ã€‚è¯·é—®ï¼Œè¿™ä¸ªè¡¨è¾¾å¼åº”è¯¥ä½•æ—¶æ±‚å€¼ï¼Ÿ

ä¸€ç§æ„è§æ˜¯"ä¼ å€¼è°ƒç”¨"ï¼ˆcall by valueï¼‰ï¼Œå³åœ¨è¿›å…¥å‡½æ•°ä½“ä¹‹å‰ï¼Œå°±è®¡ç®—x + 5çš„å€¼ï¼ˆç­‰äº6ï¼‰ï¼Œå†å°†è¿™ä¸ªå€¼ä¼ å…¥å‡½æ•°f ã€‚Cè¯­è¨€å°±é‡‡ç”¨è¿™ç§ç­–ç•¥ã€‚

f(x + 5)
// ä¼ å€¼è°ƒç”¨æ—¶ï¼Œç­‰åŒäº
f(6)
å¦ä¸€ç§æ„è§æ˜¯"ä¼ åè°ƒç”¨"ï¼ˆcall by nameï¼‰ï¼Œå³ç›´æ¥å°†è¡¨è¾¾å¼x + 5ä¼ å…¥å‡½æ•°ä½“ï¼Œåªåœ¨ç”¨åˆ°å®ƒçš„æ—¶å€™æ±‚å€¼ã€‚Haskellè¯­è¨€é‡‡ç”¨è¿™ç§ç­–ç•¥ã€‚

f(x + 5)
// ä¼ åè°ƒç”¨æ—¶ï¼Œç­‰åŒäº
(x + 5) * 2
ä¼ å€¼è°ƒç”¨å’Œä¼ åè°ƒç”¨ï¼Œå“ªä¸€ç§æ¯”è¾ƒå¥½ï¼Ÿå›ç­”æ˜¯å„æœ‰åˆ©å¼Šã€‚ä¼ å€¼è°ƒç”¨æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¯¹å‚æ•°æ±‚å€¼çš„æ—¶å€™ï¼Œå®é™…ä¸Šè¿˜æ²¡ç”¨åˆ°è¿™ä¸ªå‚æ•°ï¼Œæœ‰å¯èƒ½é€ æˆæ€§èƒ½æŸå¤±ã€‚

function f(a, b){
  return b;
}

f(3 * x * x - 2 * x - 1, x);
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¤æ‚çš„è¡¨è¾¾å¼ï¼Œä½†æ˜¯å‡½æ•°ä½“å†…æ ¹æœ¬æ²¡ç”¨åˆ°ã€‚å¯¹è¿™ä¸ªå‚æ•°æ±‚å€¼ï¼Œå®é™…ä¸Šæ˜¯ä¸å¿…è¦çš„ã€‚å› æ­¤ï¼Œæœ‰ä¸€äº›è®¡ç®—æœºå­¦å®¶å€¾å‘äº"ä¼ åè°ƒç”¨"ï¼Œå³åªåœ¨æ‰§è¡Œæ—¶æ±‚å€¼ã€‚

Thunkå‡½æ•°çš„å«ä¹‰
ç¼–è¯‘å™¨çš„"ä¼ åè°ƒç”¨"å®ç°ï¼Œå¾€å¾€æ˜¯å°†å‚æ•°æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶å‡½æ•°ä¹‹ä¸­ï¼Œå†å°†è¿™ä¸ªä¸´æ—¶å‡½æ•°ä¼ å…¥å‡½æ•°ä½“ã€‚è¿™ä¸ªä¸´æ—¶å‡½æ•°å°±å«åšThunkå‡½æ•°ã€‚

function f(m){
  return m * 2;
}

f(x + 5);

// ç­‰åŒäº

var thunk = function () {
  return x + 5;
};

function f(thunk){
  return thunk() * 2;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°fçš„å‚æ•°x + 5è¢«ä¸€ä¸ªå‡½æ•°æ›¿æ¢äº†ã€‚å‡¡æ˜¯ç”¨åˆ°åŸå‚æ•°çš„åœ°æ–¹ï¼Œå¯¹Thunkå‡½æ•°æ±‚å€¼å³å¯ã€‚

è¿™å°±æ˜¯Thunkå‡½æ•°çš„å®šä¹‰ï¼Œå®ƒæ˜¯"ä¼ åè°ƒç”¨"çš„ä¸€ç§å®ç°ç­–ç•¥ï¼Œç”¨æ¥æ›¿æ¢æŸä¸ªè¡¨è¾¾å¼ã€‚

JavaScriptè¯­è¨€çš„Thunkå‡½æ•°
JavaScriptè¯­è¨€æ˜¯ä¼ å€¼è°ƒç”¨ï¼Œå®ƒçš„Thunkå‡½æ•°å«ä¹‰æœ‰æ‰€ä¸åŒã€‚åœ¨JavaScriptè¯­è¨€ä¸­ï¼ŒThunkå‡½æ•°æ›¿æ¢çš„ä¸æ˜¯è¡¨è¾¾å¼ï¼Œè€Œæ˜¯å¤šå‚æ•°å‡½æ•°ï¼Œå°†å…¶æ›¿æ¢æˆå•å‚æ•°çš„ç‰ˆæœ¬ï¼Œä¸”åªæ¥å—å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚

// æ­£å¸¸ç‰ˆæœ¬çš„readFileï¼ˆå¤šå‚æ•°ç‰ˆæœ¬ï¼‰
fs.readFile(fileName, callback);

// Thunkç‰ˆæœ¬çš„readFileï¼ˆå•å‚æ•°ç‰ˆæœ¬ï¼‰
var readFileThunk = Thunk(fileName);
readFileThunk(callback);

var Thunk = function (fileName){
  return function (callback){
    return fs.readFile(fileName, callback);
  };
};
ä¸Šé¢ä»£ç ä¸­ï¼Œfsæ¨¡å—çš„readFileæ–¹æ³•æ˜¯ä¸€ä¸ªå¤šå‚æ•°å‡½æ•°ï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºæ–‡ä»¶åå’Œå›è°ƒå‡½æ•°ã€‚ç»è¿‡è½¬æ¢å™¨å¤„ç†ï¼Œå®ƒå˜æˆäº†ä¸€ä¸ªå•å‚æ•°å‡½æ•°ï¼Œåªæ¥å—å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå•å‚æ•°ç‰ˆæœ¬ï¼Œå°±å«åšThunkå‡½æ•°ã€‚

ä»»ä½•å‡½æ•°ï¼Œåªè¦å‚æ•°æœ‰å›è°ƒå‡½æ•°ï¼Œå°±èƒ½å†™æˆThunkå‡½æ•°çš„å½¢å¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Thunkå‡½æ•°è½¬æ¢å™¨ã€‚

// ES5ç‰ˆæœ¬
var Thunk = function(fn){
  return function (){
    var args = Array.prototype.slice.call(arguments);
    return function (callback){
      args.push(callback);
      return fn.apply(this, args);
    }
  };
};

// ES6ç‰ˆæœ¬
var Thunk = function(fn) {
  return function (...args) {
    return function (callback) {
      return fn.call(this, ...args, callback);
    }
  };
};
ä½¿ç”¨ä¸Šé¢çš„è½¬æ¢å™¨ï¼Œç”Ÿæˆfs.readFileçš„Thunkå‡½æ•°ã€‚

var readFileThunk = Thunk(fs.readFile);
readFileThunk(fileA)(callback);
ä¸‹é¢æ˜¯å¦ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ã€‚

function f(a, cb) {
  cb(a);
}
let ft = Thunk(f);

let log = console.log.bind(console);
ft(1)(log) // 1
Thunkifyæ¨¡å—
ç”Ÿäº§ç¯å¢ƒçš„è½¬æ¢å™¨ï¼Œå»ºè®®ä½¿ç”¨Thunkifyæ¨¡å—ã€‚

é¦–å…ˆæ˜¯å®‰è£…ã€‚

$ npm install thunkify
ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ã€‚

var thunkify = require('thunkify');
var fs = require('fs');

var read = thunkify(fs.readFile);
read('package.json')(function(err, str){
  // ...
});
Thunkifyçš„æºç ä¸ä¸Šä¸€èŠ‚é‚£ä¸ªç®€å•çš„è½¬æ¢å™¨éå¸¸åƒã€‚

function thunkify(fn){
  return function(){
    var args = new Array(arguments.length);
    var ctx = this;

    for(var i = 0; i < args.length; ++i) {
      args[i] = arguments[i];
    }

    return function(done){
      var called;

      args.push(function(){
        if (called) return;
        called = true;
        done.apply(null, arguments);
      });

      try {
        fn.apply(ctx, args);
      } catch (err) {
        done(err);
      }
    }
  }
};
å®ƒçš„æºç ä¸»è¦å¤šäº†ä¸€ä¸ªæ£€æŸ¥æœºåˆ¶ï¼Œå˜é‡calledç¡®ä¿å›è°ƒå‡½æ•°åªè¿è¡Œä¸€æ¬¡ã€‚è¿™æ ·çš„è®¾è®¡ä¸ä¸‹æ–‡çš„Generatorå‡½æ•°ç›¸å…³ã€‚è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

function f(a, b, callback){
  var sum = a + b;
  callback(sum);
  callback(sum);
}

var ft = thunkify(f);
var print = console.log.bind(console);
ft(1, 2)(print);
// 3
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºthunkifyåªå…è®¸å›è°ƒå‡½æ•°æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥åªè¾“å‡ºä¸€è¡Œç»“æœã€‚

Generator å‡½æ•°çš„æµç¨‹ç®¡ç†
ä½ å¯èƒ½ä¼šé—®ï¼Œ Thunkå‡½æ•°æœ‰ä»€ä¹ˆç”¨ï¼Ÿå›ç­”æ˜¯ä»¥å‰ç¡®å®æ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯ES6æœ‰äº†Generatorå‡½æ•°ï¼ŒThunkå‡½æ•°ç°åœ¨å¯ä»¥ç”¨äºGeneratorå‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†ã€‚

Generatorå‡½æ•°å¯ä»¥è‡ªåŠ¨æ‰§è¡Œã€‚

function* gen() {
  // ...
}

var g = gen();
var res = g.next();

while(!res.done){
  console.log(res.value);
  res = g.next();
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°genä¼šè‡ªåŠ¨æ‰§è¡Œå®Œæ‰€æœ‰æ­¥éª¤ã€‚

ä½†æ˜¯ï¼Œè¿™ä¸é€‚åˆå¼‚æ­¥æ“ä½œã€‚å¦‚æœå¿…é¡»ä¿è¯å‰ä¸€æ­¥æ‰§è¡Œå®Œï¼Œæ‰èƒ½æ‰§è¡Œåä¸€æ­¥ï¼Œä¸Šé¢çš„è‡ªåŠ¨æ‰§è¡Œå°±ä¸å¯è¡Œã€‚è¿™æ—¶ï¼ŒThunkå‡½æ•°å°±èƒ½æ´¾ä¸Šç”¨å¤„ã€‚ä»¥è¯»å–æ–‡ä»¶ä¸ºä¾‹ã€‚ä¸‹é¢çš„Generatorå‡½æ•°å°è£…äº†ä¸¤ä¸ªå¼‚æ­¥æ“ä½œã€‚

var fs = require('fs');
var thunkify = require('thunkify');
var readFile = thunkify(fs.readFile);

var gen = function* (){
  var r1 = yield readFile('/etc/fstab');
  console.log(r1.toString());
  var r2 = yield readFile('/etc/shells');
  console.log(r2.toString());
};
ä¸Šé¢ä»£ç ä¸­ï¼Œyieldå‘½ä»¤ç”¨äºå°†ç¨‹åºçš„æ‰§è¡Œæƒç§»å‡ºGeneratorå‡½æ•°ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€ç§æ–¹æ³•ï¼Œå°†æ‰§è¡Œæƒå†äº¤è¿˜ç»™Generatorå‡½æ•°ã€‚

è¿™ç§æ–¹æ³•å°±æ˜¯Thunkå‡½æ•°ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨å›è°ƒå‡½æ•°é‡Œï¼Œå°†æ‰§è¡Œæƒäº¤è¿˜ç»™Generatorå‡½æ•°ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬å…ˆçœ‹å¦‚ä½•æ‰‹åŠ¨æ‰§è¡Œä¸Šé¢è¿™ä¸ªGeneratorå‡½æ•°ã€‚

var g = gen();

var r1 = g.next();
r1.value(function(err, data){
  if (err) throw err;
  var r2 = g.next(data);
  r2.value(function(err, data){
    if (err) throw err;
    g.next(data);
  });
});
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡gæ˜¯Generatorå‡½æ•°çš„å†…éƒ¨æŒ‡é’ˆï¼Œè¡¨ç¤ºç›®å‰æ‰§è¡Œåˆ°å“ªä¸€æ­¥ã€‚nextæ–¹æ³•è´Ÿè´£å°†æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€æ­¥ï¼Œå¹¶è¿”å›è¯¥æ­¥çš„ä¿¡æ¯ï¼ˆvalueå±æ€§å’Œdoneå±æ€§ï¼‰ã€‚

ä»”ç»†æŸ¥çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥å‘ç°Generatorå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå…¶å®æ˜¯å°†åŒä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåå¤ä¼ å…¥nextæ–¹æ³•çš„valueå±æ€§ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨é€’å½’æ¥è‡ªåŠ¨å®Œæˆè¿™ä¸ªè¿‡ç¨‹ã€‚

Thunkå‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†
Thunkå‡½æ•°çœŸæ­£çš„å¨åŠ›ï¼Œåœ¨äºå¯ä»¥è‡ªåŠ¨æ‰§è¡ŒGeneratorå‡½æ•°ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªåŸºäºThunkå‡½æ•°çš„Generatoræ‰§è¡Œå™¨ã€‚

function run(fn) {
  var gen = fn();

  function next(err, data) {
    var result = gen.next(data);
    if (result.done) return;
    result.value(next);
  }

  next();
}

function* g() {
  // ...
}

run(g);
ä¸Šé¢ä»£ç çš„runå‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ªGeneratorå‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚å†…éƒ¨çš„nextå‡½æ•°å°±æ˜¯Thunkçš„å›è°ƒå‡½æ•°ã€‚nextå‡½æ•°å…ˆå°†æŒ‡é’ˆç§»åˆ°Generatorå‡½æ•°çš„ä¸‹ä¸€æ­¥ï¼ˆgen.nextæ–¹æ³•ï¼‰ï¼Œç„¶ååˆ¤æ–­Generatorå‡½æ•°æ˜¯å¦ç»“æŸï¼ˆresult.doneå±æ€§ï¼‰ï¼Œå¦‚æœæ²¡ç»“æŸï¼Œå°±å°†nextå‡½æ•°å†ä¼ å…¥Thunkå‡½æ•°ï¼ˆresult.valueå±æ€§ï¼‰ï¼Œå¦åˆ™å°±ç›´æ¥é€€å‡ºã€‚

æœ‰äº†è¿™ä¸ªæ‰§è¡Œå™¨ï¼Œæ‰§è¡ŒGeneratorå‡½æ•°æ–¹ä¾¿å¤šäº†ã€‚ä¸ç®¡å†…éƒ¨æœ‰å¤šå°‘ä¸ªå¼‚æ­¥æ“ä½œï¼Œç›´æ¥æŠŠGeneratorå‡½æ•°ä¼ å…¥runå‡½æ•°å³å¯ã€‚å½“ç„¶ï¼Œå‰ææ˜¯æ¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œéƒ½è¦æ˜¯Thunkå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè·Ÿåœ¨yieldå‘½ä»¤åé¢çš„å¿…é¡»æ˜¯Thunkå‡½æ•°ã€‚

var g = function* (){
  var f1 = yield readFile('fileA');
  var f2 = yield readFile('fileB');
  // ...
  var fn = yield readFile('fileN');
};

run(g);
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°gå°è£…äº†nä¸ªå¼‚æ­¥çš„è¯»å–æ–‡ä»¶æ“ä½œï¼Œåªè¦æ‰§è¡Œrunå‡½æ•°ï¼Œè¿™äº›æ“ä½œå°±ä¼šè‡ªåŠ¨å®Œæˆã€‚è¿™æ ·ä¸€æ¥ï¼Œå¼‚æ­¥æ“ä½œä¸ä»…å¯ä»¥å†™å¾—åƒåŒæ­¥æ“ä½œï¼Œè€Œä¸”ä¸€è¡Œä»£ç å°±å¯ä»¥æ‰§è¡Œã€‚

Thunkå‡½æ•°å¹¶ä¸æ˜¯Generatorå‡½æ•°è‡ªåŠ¨æ‰§è¡Œçš„å”¯ä¸€æ–¹æ¡ˆã€‚å› ä¸ºè‡ªåŠ¨æ‰§è¡Œçš„å…³é”®æ˜¯ï¼Œå¿…é¡»æœ‰ä¸€ç§æœºåˆ¶ï¼Œè‡ªåŠ¨æ§åˆ¶Generatorå‡½æ•°çš„æµç¨‹ï¼Œæ¥æ”¶å’Œäº¤è¿˜ç¨‹åºçš„æ‰§è¡Œæƒã€‚å›è°ƒå‡½æ•°å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼ŒPromise å¯¹è±¡ä¹Ÿå¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

coæ¨¡å—
åŸºæœ¬ç”¨æ³•
coæ¨¡å—æ˜¯è‘—åç¨‹åºå‘˜TJ Holowaychukäº2013å¹´6æœˆå‘å¸ƒçš„ä¸€ä¸ªå°å·¥å…·ï¼Œç”¨äºGeneratorå‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œã€‚

æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ªGeneratorå‡½æ•°ï¼Œç”¨äºä¾æ¬¡è¯»å–ä¸¤ä¸ªæ–‡ä»¶ã€‚

var gen = function* (){
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};
coæ¨¡å—å¯ä»¥è®©ä½ ä¸ç”¨ç¼–å†™Generatorå‡½æ•°çš„æ‰§è¡Œå™¨ã€‚

var co = require('co');
co(gen);
ä¸Šé¢ä»£ç ä¸­ï¼ŒGeneratorå‡½æ•°åªè¦ä¼ å…¥coå‡½æ•°ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚

coå‡½æ•°è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥ç”¨thenæ–¹æ³•æ·»åŠ å›è°ƒå‡½æ•°ã€‚

co(gen).then(function (){
  console.log('Generator å‡½æ•°æ‰§è¡Œå®Œæˆ');
});
ä¸Šé¢ä»£ç ä¸­ï¼Œç­‰åˆ°Generatorå‡½æ•°æ‰§è¡Œç»“æŸï¼Œå°±ä¼šè¾“å‡ºä¸€è¡Œæç¤ºã€‚

coæ¨¡å—çš„åŸç†
ä¸ºä»€ä¹ˆcoå¯ä»¥è‡ªåŠ¨æ‰§è¡ŒGeneratorå‡½æ•°ï¼Ÿ

å‰é¢è¯´è¿‡ï¼ŒGeneratorå°±æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„å®¹å™¨ã€‚å®ƒçš„è‡ªåŠ¨æ‰§è¡Œéœ€è¦ä¸€ç§æœºåˆ¶ï¼Œå½“å¼‚æ­¥æ“ä½œæœ‰äº†ç»“æœï¼Œèƒ½å¤Ÿè‡ªåŠ¨äº¤å›æ‰§è¡Œæƒã€‚

ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

ï¼ˆ1ï¼‰å›è°ƒå‡½æ•°ã€‚å°†å¼‚æ­¥æ“ä½œåŒ…è£…æˆThunkå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°é‡Œé¢äº¤å›æ‰§è¡Œæƒã€‚

ï¼ˆ2ï¼‰Promise å¯¹è±¡ã€‚å°†å¼‚æ­¥æ“ä½œåŒ…è£…æˆPromiseå¯¹è±¡ï¼Œç”¨thenæ–¹æ³•äº¤å›æ‰§è¡Œæƒã€‚

coæ¨¡å—å…¶å®å°±æ˜¯å°†ä¸¤ç§è‡ªåŠ¨æ‰§è¡Œå™¨ï¼ˆThunkå‡½æ•°å’ŒPromiseå¯¹è±¡ï¼‰ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ¨¡å—ã€‚ä½¿ç”¨coçš„å‰ææ¡ä»¶æ˜¯ï¼ŒGeneratorå‡½æ•°çš„yieldå‘½ä»¤åé¢ï¼Œåªèƒ½æ˜¯Thunkå‡½æ•°æˆ–Promiseå¯¹è±¡ã€‚

ä¸Šä¸€èŠ‚å·²ç»ä»‹ç»äº†åŸºäºThunkå‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚ä¸‹é¢æ¥çœ‹ï¼ŒåŸºäºPromiseå¯¹è±¡çš„è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚è¿™æ˜¯ç†è§£coæ¨¡å—å¿…é¡»çš„ã€‚

åŸºäºPromiseå¯¹è±¡çš„è‡ªåŠ¨æ‰§è¡Œ
è¿˜æ˜¯æ²¿ç”¨ä¸Šé¢çš„ä¾‹å­ã€‚é¦–å…ˆï¼ŒæŠŠfsæ¨¡å—çš„readFileæ–¹æ³•åŒ…è£…æˆä¸€ä¸ªPromiseå¯¹è±¡ã€‚

var fs = require('fs');

var readFile = function (fileName){
  return new Promise(function (resolve, reject){
    fs.readFile(fileName, function(error, data){
      if (error) return reject(error);
      resolve(data);
    });
  });
};

var gen = function* (){
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};
ç„¶åï¼Œæ‰‹åŠ¨æ‰§è¡Œä¸Šé¢çš„Generatorå‡½æ•°ã€‚

var g = gen();

g.next().value.then(function(data){
  g.next(data).value.then(function(data){
    g.next(data);
  });
});
æ‰‹åŠ¨æ‰§è¡Œå…¶å®å°±æ˜¯ç”¨thenæ–¹æ³•ï¼Œå±‚å±‚æ·»åŠ å›è°ƒå‡½æ•°ã€‚ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±å¯ä»¥å†™å‡ºä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨ã€‚

function run(gen){
  var g = gen();

  function next(data){
    var result = g.next(data);
    if (result.done) return result.value;
    result.value.then(function(data){
      next(data);
    });
  }

  next();
}

run(gen);
ä¸Šé¢ä»£ç ä¸­ï¼Œåªè¦Generatorå‡½æ•°è¿˜æ²¡æ‰§è¡Œåˆ°æœ€åä¸€æ­¥ï¼Œnextå‡½æ•°å°±è°ƒç”¨è‡ªèº«ï¼Œä»¥æ­¤å®ç°è‡ªåŠ¨æ‰§è¡Œã€‚

coæ¨¡å—çš„æºç 
coå°±æ˜¯ä¸Šé¢é‚£ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨çš„æ‰©å±•ï¼Œå®ƒçš„æºç åªæœ‰å‡ åè¡Œï¼Œéå¸¸ç®€å•ã€‚

é¦–å…ˆï¼Œcoå‡½æ•°æ¥å—Generatorå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚

function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
  });
}
åœ¨è¿”å›çš„Promiseå¯¹è±¡é‡Œé¢ï¼Œcoå…ˆæ£€æŸ¥å‚æ•°genæ˜¯å¦ä¸ºGeneratorå‡½æ•°ã€‚å¦‚æœæ˜¯ï¼Œå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªå†…éƒ¨æŒ‡é’ˆå¯¹è±¡ï¼›å¦‚æœä¸æ˜¯å°±è¿”å›ï¼Œå¹¶å°†Promiseå¯¹è±¡çš„çŠ¶æ€æ”¹ä¸ºresolvedã€‚

function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx);
    if (!gen || typeof gen.next !== 'function') return resolve(gen);
  });
}
æ¥ç€ï¼Œcoå°†Generatorå‡½æ•°çš„å†…éƒ¨æŒ‡é’ˆå¯¹è±¡çš„nextæ–¹æ³•ï¼ŒåŒ…è£…æˆonFulfilledå‡½æ•°ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿæ•æ‰æŠ›å‡ºçš„é”™è¯¯ã€‚

function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx);
    if (!gen || typeof gen.next !== 'function') return resolve(gen);

    onFulfilled();
    function onFulfilled(res) {
      var ret;
      try {
        ret = gen.next(res);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }
  });
}
æœ€åï¼Œå°±æ˜¯å…³é”®çš„nextå‡½æ•°ï¼Œå®ƒä¼šåå¤è°ƒç”¨è‡ªèº«ã€‚

function next(ret) {
  if (ret.done) return resolve(ret.value);
  var value = toPromise.call(ctx, ret.value);
  if (value && isPromise(value)) return value.then(onFulfilled, onRejected);
  return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, '
    + 'but the following object was passed: "' + String(ret.value) + '"'));
}
ä¸Šé¢ä»£ç ä¸­ï¼Œnext å‡½æ•°çš„å†…éƒ¨ä»£ç ï¼Œä¸€å…±åªæœ‰å››è¡Œå‘½ä»¤ã€‚

ç¬¬ä¸€è¡Œï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦ä¸º Generator å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œå¦‚æœæ˜¯å°±è¿”å›ã€‚

ç¬¬äºŒè¡Œï¼Œç¡®ä¿æ¯ä¸€æ­¥çš„è¿”å›å€¼ï¼Œæ˜¯ Promise å¯¹è±¡ã€‚

ç¬¬ä¸‰è¡Œï¼Œä½¿ç”¨ then æ–¹æ³•ï¼Œä¸ºè¿”å›å€¼åŠ ä¸Šå›è°ƒå‡½æ•°ï¼Œç„¶åé€šè¿‡ onFulfilled å‡½æ•°å†æ¬¡è°ƒç”¨ next å‡½æ•°ã€‚

ç¬¬å››è¡Œï¼Œåœ¨å‚æ•°ä¸ç¬¦åˆè¦æ±‚çš„æƒ…å†µä¸‹ï¼ˆå‚æ•°é Thunk å‡½æ•°å’Œ Promise å¯¹è±¡ï¼‰ï¼Œå°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º rejectedï¼Œä»è€Œç»ˆæ­¢æ‰§è¡Œã€‚

å¤„ç†å¹¶å‘çš„å¼‚æ­¥æ“ä½œ
coæ”¯æŒå¹¶å‘çš„å¼‚æ­¥æ“ä½œï¼Œå³å…è®¸æŸäº›æ“ä½œåŒæ—¶è¿›è¡Œï¼Œç­‰åˆ°å®ƒä»¬å…¨éƒ¨å®Œæˆï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥ã€‚

è¿™æ—¶ï¼Œè¦æŠŠå¹¶å‘çš„æ“ä½œéƒ½æ”¾åœ¨æ•°ç»„æˆ–å¯¹è±¡é‡Œé¢ï¼Œè·Ÿåœ¨yieldè¯­å¥åé¢ã€‚

// æ•°ç»„çš„å†™æ³•
co(function* () {
  var res = yield [
    Promise.resolve(1),
    Promise.resolve(2)
  ];
  console.log(res);
}).catch(onerror);

// å¯¹è±¡çš„å†™æ³•
co(function* () {
  var res = yield {
    1: Promise.resolve(1),
    2: Promise.resolve(2),
  };
  console.log(res);
}).catch(onerror);
ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

co(function* () {
  var values = [n1, n2, n3];
  yield values.map(somethingAsync);
});

function* somethingAsync(x) {
  // do something async
  return y
}
ä¸Šé¢çš„ä»£ç å…è®¸å¹¶å‘ä¸‰ä¸ªsomethingAsyncå¼‚æ­¥æ“ä½œï¼Œç­‰åˆ°å®ƒä»¬å…¨éƒ¨å®Œæˆï¼Œæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥ã€‚

asyncå‡½æ•°
å«ä¹‰
ES2017 æ ‡å‡†æä¾›äº†asyncå‡½æ•°ï¼Œä½¿å¾—å¼‚æ­¥æ“ä½œå˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚

asyncå‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿä¸€å¥è¯ï¼Œasyncå‡½æ•°å°±æ˜¯ Generator å‡½æ•°çš„è¯­æ³•ç³–ã€‚å‰æ–‡æœ‰ä¸€ä¸ª Generator å‡½æ•°ï¼Œä¾æ¬¡è¯»å–ä¸¤ä¸ªæ–‡ä»¶ã€‚

var fs = require('fs');

var readFile = function (fileName) {
  return new Promise(function (resolve, reject) {
    fs.readFile(fileName, function(error, data) {
      if (error) reject(error);
      resolve(data);
    });
  });
};

var gen = function* (){
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};
å†™æˆasyncå‡½æ•°ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚

var asyncReadFile = async function (){
  var f1 = await readFile('/etc/fstab');
  var f2 = await readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};
ä¸€æ¯”è¾ƒå°±ä¼šå‘ç°ï¼Œasyncå‡½æ•°å°±æ˜¯å°† Generator å‡½æ•°çš„æ˜Ÿå·ï¼ˆ*ï¼‰æ›¿æ¢æˆasyncï¼Œå°†yieldæ›¿æ¢æˆawaitï¼Œä»…æ­¤è€Œå·²ã€‚

asyncå‡½æ•°å¯¹ Generator å‡½æ•°çš„æ”¹è¿›ï¼Œä½“ç°åœ¨ä»¥ä¸‹å››ç‚¹ã€‚

ï¼ˆ1ï¼‰å†…ç½®æ‰§è¡Œå™¨ã€‚Generator å‡½æ•°çš„æ‰§è¡Œå¿…é¡»é æ‰§è¡Œå™¨ï¼Œæ‰€ä»¥æ‰æœ‰äº†coæ¨¡å—ï¼Œè€Œasyncå‡½æ•°è‡ªå¸¦æ‰§è¡Œå™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œasyncå‡½æ•°çš„æ‰§è¡Œï¼Œä¸æ™®é€šå‡½æ•°ä¸€æ¨¡ä¸€æ ·ï¼Œåªè¦ä¸€è¡Œã€‚

var result = asyncReadFile();
ä¸Šé¢çš„ä»£ç è°ƒç”¨äº†asyncReadFileå‡½æ•°ï¼Œç„¶åå®ƒå°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œè¾“å‡ºæœ€åç»“æœã€‚è¿™å®Œå…¨ä¸åƒ Generator å‡½æ•°ï¼Œéœ€è¦è°ƒç”¨nextæ–¹æ³•ï¼Œæˆ–è€…ç”¨coæ¨¡å—ï¼Œæ‰èƒ½å¾—åˆ°çœŸæ­£æ‰§è¡Œï¼Œå¾—åˆ°æœ€åç»“æœã€‚

ï¼ˆ2ï¼‰æ›´å¥½çš„è¯­ä¹‰ã€‚asyncå’Œawaitï¼Œæ¯”èµ·æ˜Ÿå·å’Œyieldï¼Œè¯­ä¹‰æ›´æ¸…æ¥šäº†ã€‚asyncè¡¨ç¤ºå‡½æ•°é‡Œæœ‰å¼‚æ­¥æ“ä½œï¼Œawaitè¡¨ç¤ºç´§è·Ÿåœ¨åé¢çš„è¡¨è¾¾å¼éœ€è¦ç­‰å¾…ç»“æœã€‚

ï¼ˆ3ï¼‰æ›´å¹¿çš„é€‚ç”¨æ€§ã€‚ coæ¨¡å—çº¦å®šï¼Œyieldå‘½ä»¤åé¢åªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡ï¼Œè€Œasyncå‡½æ•°çš„awaitå‘½ä»¤åé¢ï¼Œå¯ä»¥æ˜¯Promise å¯¹è±¡å’ŒåŸå§‹ç±»å‹çš„å€¼ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼ï¼Œä½†è¿™æ—¶ç­‰åŒäºåŒæ­¥æ“ä½œï¼‰ã€‚

ï¼ˆ4ï¼‰è¿”å›å€¼æ˜¯ Promiseã€‚asyncå‡½æ•°çš„è¿”å›å€¼æ˜¯ Promise å¯¹è±¡ï¼Œè¿™æ¯” Generator å‡½æ•°çš„è¿”å›å€¼æ˜¯ Iterator å¯¹è±¡æ–¹ä¾¿å¤šäº†ã€‚ä½ å¯ä»¥ç”¨thenæ–¹æ³•æŒ‡å®šä¸‹ä¸€æ­¥çš„æ“ä½œã€‚

è¿›ä¸€æ­¥è¯´ï¼Œasyncå‡½æ•°å®Œå…¨å¯ä»¥çœ‹ä½œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼ŒåŒ…è£…æˆçš„ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè€Œawaitå‘½ä»¤å°±æ˜¯å†…éƒ¨thenå‘½ä»¤çš„è¯­æ³•ç³–ã€‚

è¯­æ³•
asyncå‡½æ•°çš„è¯­æ³•è§„åˆ™æ€»ä½“ä¸Šæ¯”è¾ƒç®€å•ï¼Œéš¾ç‚¹æ˜¯é”™è¯¯å¤„ç†æœºåˆ¶ã€‚

ï¼ˆ1ï¼‰asyncå‡½æ•°è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ã€‚

asyncå‡½æ•°å†…éƒ¨returnè¯­å¥è¿”å›çš„å€¼ï¼Œä¼šæˆä¸ºthenæ–¹æ³•å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚

async function f() {
  return 'hello world';
}

f().then(v => console.log(v))
// "hello world"
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°få†…éƒ¨returnå‘½ä»¤è¿”å›çš„å€¼ï¼Œä¼šè¢«thenæ–¹æ³•å›è°ƒå‡½æ•°æ¥æ”¶åˆ°ã€‚

asyncå‡½æ•°å†…éƒ¨æŠ›å‡ºé”™è¯¯ï¼Œä¼šå¯¼è‡´è¿”å›çš„ Promise å¯¹è±¡å˜ä¸ºrejectçŠ¶æ€ã€‚æŠ›å‡ºçš„é”™è¯¯å¯¹è±¡ä¼šè¢«catchæ–¹æ³•å›è°ƒå‡½æ•°æ¥æ”¶åˆ°ã€‚

async function f() {
  throw new Error('å‡ºé”™äº†');
}

f().then(
  v => console.log(v),
  e => console.log(e)
)
// Error: å‡ºé”™äº†
ï¼ˆ2ï¼‰asyncå‡½æ•°è¿”å›çš„ Promise å¯¹è±¡ï¼Œå¿…é¡»ç­‰åˆ°å†…éƒ¨æ‰€æœ‰awaitå‘½ä»¤çš„Promiseå¯¹è±¡æ‰§è¡Œå®Œï¼Œæ‰ä¼šå‘ç”ŸçŠ¶æ€æ”¹å˜ï¼Œé™¤éé‡åˆ°returnè¯­å¥æˆ–è€…æŠ›å‡ºé”™è¯¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰asyncå‡½æ•°å†…éƒ¨çš„å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œï¼Œæ‰ä¼šæ‰§è¡Œthenæ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

async function getTitle(url) {
  let response = await fetch(url);
  let html = await response.text();
  return html.match(/<title>([\s\S]+)<\/title>/i)[1];
}
getTitle('https://tc39.github.io/ecma262/').then(console.log)
// "ECMAScript 2017 Language Specification"
ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°getTitleå†…éƒ¨æœ‰ä¸‰ä¸ªæ“ä½œï¼šæŠ“å–ç½‘é¡µã€å–å‡ºæ–‡æœ¬ã€åŒ¹é…é¡µé¢æ ‡é¢˜ã€‚åªæœ‰è¿™ä¸‰ä¸ªæ“ä½œå…¨éƒ¨å®Œæˆï¼Œæ‰ä¼šæ‰§è¡Œthenæ–¹æ³•é‡Œé¢çš„console.logã€‚

ï¼ˆ3ï¼‰æ­£å¸¸æƒ…å†µä¸‹ï¼Œawaitå‘½ä»¤åé¢æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚å¦‚æœä¸æ˜¯ï¼Œä¼šè¢«è½¬æˆä¸€ä¸ªç«‹å³resolveçš„ Promise å¯¹è±¡ã€‚

async function f() {
  return await 123;
}

f().then(v => console.log(v))
// 123
ä¸Šé¢ä»£ç ä¸­ï¼Œawaitå‘½ä»¤çš„å‚æ•°æ˜¯æ•°å€¼123ï¼Œå®ƒè¢«è½¬æˆPromiseå¯¹è±¡ï¼Œå¹¶ç«‹å³resolveã€‚

awaitå‘½ä»¤åé¢çš„Promiseå¯¹è±¡å¦‚æœå˜ä¸ºrejectçŠ¶æ€ï¼Œåˆ™rejectçš„å‚æ•°ä¼šè¢«catchæ–¹æ³•çš„å›è°ƒå‡½æ•°æ¥æ”¶åˆ°ã€‚

async function f() {
  await Promise.reject('å‡ºé”™äº†');
}

f()
.then(v => console.log(v))
.catch(e => console.log(e))
// å‡ºé”™äº†
æ³¨æ„ï¼Œä¸Šé¢ä»£ç ä¸­ï¼Œawaitè¯­å¥å‰é¢æ²¡æœ‰returnï¼Œä½†æ˜¯rejectæ–¹æ³•çš„å‚æ•°ä¾ç„¶ä¼ å…¥äº†catchæ–¹æ³•çš„å›è°ƒå‡½æ•°ã€‚è¿™é‡Œå¦‚æœåœ¨awaitå‰é¢åŠ ä¸Šreturnï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

åªè¦ä¸€ä¸ªawaitè¯­å¥åé¢çš„Promiseå˜ä¸ºrejectï¼Œé‚£ä¹ˆæ•´ä¸ªasyncå‡½æ•°éƒ½ä¼šä¸­æ–­æ‰§è¡Œã€‚

async function f() {
  await Promise.reject('å‡ºé”™äº†');
  await Promise.resolve('hello world'); // ä¸ä¼šæ‰§è¡Œ
}
ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒä¸ªawaitè¯­å¥æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªawaitè¯­å¥çŠ¶æ€å˜æˆäº†rejectã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å°†ç¬¬ä¸€ä¸ªawaitæ”¾åœ¨try...catchç»“æ„é‡Œé¢ï¼Œè¿™æ ·ç¬¬äºŒä¸ªawaitå°±ä¼šæ‰§è¡Œã€‚

async function f() {
  try {
    await Promise.reject('å‡ºé”™äº†');
  } catch(e) {
  }
  return await Promise.resolve('hello world');
}

f()
.then(v => console.log(v))
// hello world
å¦ä¸€ç§æ–¹æ³•æ˜¯awaitåé¢çš„Promiseå¯¹è±¡å†è·Ÿä¸€ä¸ªcatchæ–¹é¢ï¼Œå¤„ç†å‰é¢å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚

async function f() {
  await Promise.reject('å‡ºé”™äº†')
    .catch(e => console.log(e));
  return await Promise.resolve('hello world');
}

f()
.then(v => console.log(v))
// å‡ºé”™äº†
// hello world
å¦‚æœæœ‰å¤šä¸ªawaitå‘½ä»¤ï¼Œå¯ä»¥ç»Ÿä¸€æ”¾åœ¨try...catchç»“æ„ä¸­ã€‚

async function main() {
  try {
    var val1 = await firstStep();
    var val2 = await secondStep(val1);
    var val3 = await thirdStep(val1, val2);

    console.log('Final: ', val3);
  }
  catch (err) {
    console.error(err);
  }
}
ï¼ˆ4ï¼‰å¦‚æœawaitåé¢çš„å¼‚æ­¥æ“ä½œå‡ºé”™ï¼Œé‚£ä¹ˆç­‰åŒäºasyncå‡½æ•°è¿”å›çš„Promiseå¯¹è±¡è¢«rejectã€‚

async function f() {
  await new Promise(function (resolve, reject) {
    throw new Error('å‡ºé”™äº†');
  });
}

f()
.then(v => console.log(v))
.catch(e => console.log(e))
// Errorï¼šå‡ºé”™äº†
ä¸Šé¢ä»£ç ä¸­ï¼Œasyncå‡½æ•°fæ‰§è¡Œåï¼Œawaitåé¢çš„Promiseå¯¹è±¡ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œå¯¼è‡´catchæ–¹æ³•çš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒçš„å‚æ•°å°±æ˜¯æŠ›å‡ºçš„é”™è¯¯å¯¹è±¡ã€‚å…·ä½“çš„æ‰§è¡Œæœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒåæ–‡çš„â€œasyncå‡½æ•°çš„å®ç°â€ã€‚

é˜²æ­¢å‡ºé”™çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯å°†å…¶æ”¾åœ¨try...catchä»£ç å—ä¹‹ä¸­ã€‚

async function f() {
  try {
    await new Promise(function (resolve, reject) {
      throw new Error('å‡ºé”™äº†');
    });
  } catch(e) {
  }
  return await('hello world');
}
asyncå‡½æ•°çš„å®ç°
async å‡½æ•°çš„å®ç°ï¼Œå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚

async function fn(args){
  // ...
}

// ç­‰åŒäº

function fn(args){
  return spawn(function*() {
    // ...
  });
}
æ‰€æœ‰çš„asyncå‡½æ•°éƒ½å¯ä»¥å†™æˆä¸Šé¢çš„ç¬¬äºŒç§å½¢å¼ï¼Œå…¶ä¸­çš„ spawn å‡½æ•°å°±æ˜¯è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚

ä¸‹é¢ç»™å‡ºspawnå‡½æ•°çš„å®ç°ï¼ŒåŸºæœ¬å°±æ˜¯å‰æ–‡è‡ªåŠ¨æ‰§è¡Œå™¨çš„ç¿»ç‰ˆã€‚

function spawn(genF) {
  return new Promise(function(resolve, reject) {
    var gen = genF();
    function step(nextF) {
      try {
        var next = nextF();
      } catch(e) {
        return reject(e);
      }
      if(next.done) {
        return resolve(next.value);
      }
      Promise.resolve(next.value).then(function(v) {
        step(function() { return gen.next(v); });
      }, function(e) {
        step(function() { return gen.throw(e); });
      });
    }
    step(function() { return gen.next(undefined); });
  });
}
async å‡½æ•°çš„ç”¨æ³•
asyncå‡½æ•°è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨thenæ–¹æ³•æ·»åŠ å›è°ƒå‡½æ•°ã€‚å½“å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€æ—¦é‡åˆ°awaitå°±ä¼šå…ˆè¿”å›ï¼Œç­‰åˆ°è§¦å‘çš„å¼‚æ­¥æ“ä½œå®Œæˆï¼Œå†æ¥ç€æ‰§è¡Œå‡½æ•°ä½“å†…åé¢çš„è¯­å¥ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

async function getStockPriceByName(name) {
  var symbol = await getStockSymbol(name);
  var stockPrice = await getStockPrice(symbol);
  return stockPrice;
}

getStockPriceByName('goog').then(function (result) {
  console.log(result);
});
ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªè·å–è‚¡ç¥¨æŠ¥ä»·çš„å‡½æ•°ï¼Œå‡½æ•°å‰é¢çš„asyncå…³é”®å­—ï¼Œè¡¨æ˜è¯¥å‡½æ•°å†…éƒ¨æœ‰å¼‚æ­¥æ“ä½œã€‚è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä¼šç«‹å³è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ã€‚

ä¸‹é¢çš„ä¾‹å­ï¼ŒæŒ‡å®šå¤šå°‘æ¯«ç§’åè¾“å‡ºä¸€ä¸ªå€¼ã€‚

function timeout(ms) {
  return new Promise((resolve) => {
    setTimeout(resolve, ms);
  });
}

async function asyncPrint(value, ms) {
  await timeout(ms);
  console.log(value)
}

asyncPrint('hello world', 50);
ä¸Šé¢ä»£ç æŒ‡å®š50æ¯«ç§’ä»¥åï¼Œè¾“å‡ºhello worldã€‚

Asyncå‡½æ•°æœ‰å¤šç§ä½¿ç”¨å½¢å¼ã€‚

// å‡½æ•°å£°æ˜
async function foo() {}

// å‡½æ•°è¡¨è¾¾å¼
const foo = async function () {};

// å¯¹è±¡çš„æ–¹æ³•
let obj = { async foo() {} };
obj.foo().then(...)

// Class çš„æ–¹æ³•
class Storage {
  constructor() {
    this.cachePromise = caches.open('avatars');
  }

  async getAvatar(name) {
    const cache = await this.cachePromise;
    return cache.match(`/avatars/${name}.jpg`);
  }
}

const storage = new Storage();
storage.getAvatar('jake').then(â€¦);

// ç®­å¤´å‡½æ•°
const foo = async () => {};
æ³¨æ„ç‚¹
ç¬¬ä¸€ç‚¹ï¼Œawaitå‘½ä»¤åé¢çš„Promiseå¯¹è±¡ï¼Œè¿è¡Œç»“æœå¯èƒ½æ˜¯rejectedï¼Œæ‰€ä»¥æœ€å¥½æŠŠawaitå‘½ä»¤æ”¾åœ¨try...catchä»£ç å—ä¸­ã€‚

async function myFunction() {
  try {
    await somethingThatReturnsAPromise();
  } catch (err) {
    console.log(err);
  }
}

// å¦ä¸€ç§å†™æ³•

async function myFunction() {
  await somethingThatReturnsAPromise()
  .catch(function (err) {
    console.log(err);
  };
}
ç¬¬äºŒç‚¹ï¼Œå¤šä¸ªawaitå‘½ä»¤åé¢çš„å¼‚æ­¥æ“ä½œï¼Œå¦‚æœä¸å­˜åœ¨ç»§å‘å…³ç³»ï¼Œæœ€å¥½è®©å®ƒä»¬åŒæ—¶è§¦å‘ã€‚

let foo = await getFoo();
let bar = await getBar();
ä¸Šé¢ä»£ç ä¸­ï¼ŒgetFooå’ŒgetBaræ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¼‚æ­¥æ“ä½œï¼ˆå³äº’ä¸ä¾èµ–ï¼‰ï¼Œè¢«å†™æˆç»§å‘å…³ç³»ã€‚è¿™æ ·æ¯”è¾ƒè€—æ—¶ï¼Œå› ä¸ºåªæœ‰getFooå®Œæˆä»¥åï¼Œæ‰ä¼šæ‰§è¡ŒgetBarï¼Œå®Œå…¨å¯ä»¥è®©å®ƒä»¬åŒæ—¶è§¦å‘ã€‚

// å†™æ³•ä¸€
let [foo, bar] = await Promise.all([getFoo(), getBar()]);

// å†™æ³•äºŒ
let fooPromise = getFoo();
let barPromise = getBar();
let foo = await fooPromise;
let bar = await barPromise;
ä¸Šé¢ä¸¤ç§å†™æ³•ï¼ŒgetFooå’ŒgetBaréƒ½æ˜¯åŒæ—¶è§¦å‘ï¼Œè¿™æ ·å°±ä¼šç¼©çŸ­ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ã€‚

ç¬¬ä¸‰ç‚¹ï¼Œawaitå‘½ä»¤åªèƒ½ç”¨åœ¨asyncå‡½æ•°ä¹‹ä¸­ï¼Œå¦‚æœç”¨åœ¨æ™®é€šå‡½æ•°ï¼Œå°±ä¼šæŠ¥é”™ã€‚

async function dbFuc(db) {
  let docs = [{}, {}, {}];

  // æŠ¥é”™
  docs.forEach(function (doc) {
    await db.post(doc);
  });
}
ä¸Šé¢ä»£ç ä¼šæŠ¥é”™ï¼Œå› ä¸ºawaitç”¨åœ¨æ™®é€šå‡½æ•°ä¹‹ä¸­äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœå°†forEachæ–¹æ³•çš„å‚æ•°æ”¹æˆasyncå‡½æ•°ï¼Œä¹Ÿæœ‰é—®é¢˜ã€‚

async function dbFuc(db) {
  let docs = [{}, {}, {}];

  // å¯èƒ½å¾—åˆ°é”™è¯¯ç»“æœ
  docs.forEach(async function (doc) {
    await db.post(doc);
  });
}
ä¸Šé¢ä»£ç å¯èƒ½ä¸ä¼šæ­£å¸¸å·¥ä½œï¼ŒåŸå› æ˜¯è¿™æ—¶ä¸‰ä¸ªdb.postæ“ä½œå°†æ˜¯å¹¶å‘æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åŒæ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç»§å‘æ‰§è¡Œã€‚æ­£ç¡®çš„å†™æ³•æ˜¯é‡‡ç”¨forå¾ªç¯ã€‚

async function dbFuc(db) {
  let docs = [{}, {}, {}];

  for (let doc of docs) {
    await db.post(doc);
  }
}
å¦‚æœç¡®å®å¸Œæœ›å¤šä¸ªè¯·æ±‚å¹¶å‘æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨Promise.allæ–¹æ³•ã€‚

async function dbFuc(db) {
  let docs = [{}, {}, {}];
  let promises = docs.map((doc) => db.post(doc));

  let results = await Promise.all(promises);
  console.log(results);
}

// æˆ–è€…ä½¿ç”¨ä¸‹é¢çš„å†™æ³•

async function dbFuc(db) {
  let docs = [{}, {}, {}];
  let promises = docs.map((doc) => db.post(doc));

  let results = [];
  for (let promise of promises) {
    results.push(await promise);
  }
  console.log(results);
}
ES6å°†awaitå¢åŠ ä¸ºä¿ç•™å­—ã€‚ä½¿ç”¨è¿™ä¸ªè¯ä½œä¸ºæ ‡è¯†ç¬¦ï¼Œåœ¨ES5æ˜¯åˆæ³•çš„ï¼Œåœ¨ES6å°†æŠ›å‡ºSyntaxErrorã€‚

ä¸Promiseã€Generatorçš„æ¯”è¾ƒ
æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥çœ‹Asyncå‡½æ•°ä¸Promiseã€Generatorå‡½æ•°çš„åŒºåˆ«ã€‚

å‡å®šæŸä¸ªDOMå…ƒç´ ä¸Šé¢ï¼Œéƒ¨ç½²äº†ä¸€ç³»åˆ—çš„åŠ¨ç”»ï¼Œå‰ä¸€ä¸ªåŠ¨ç”»ç»“æŸï¼Œæ‰èƒ½å¼€å§‹åä¸€ä¸ªã€‚å¦‚æœå½“ä¸­æœ‰ä¸€ä¸ªåŠ¨ç”»å‡ºé”™ï¼Œå°±ä¸å†å¾€ä¸‹æ‰§è¡Œï¼Œè¿”å›ä¸Šä¸€ä¸ªæˆåŠŸæ‰§è¡Œçš„åŠ¨ç”»çš„è¿”å›å€¼ã€‚

é¦–å…ˆæ˜¯Promiseçš„å†™æ³•ã€‚

function chainAnimationsPromise(elem, animations) {

  // å˜é‡retç”¨æ¥ä¿å­˜ä¸Šä¸€ä¸ªåŠ¨ç”»çš„è¿”å›å€¼
  var ret = null;

  // æ–°å»ºä¸€ä¸ªç©ºçš„Promise
  var p = Promise.resolve();

  // ä½¿ç”¨thenæ–¹æ³•ï¼Œæ·»åŠ æ‰€æœ‰åŠ¨ç”»
  for(var anim of animations) {
    p = p.then(function(val) {
      ret = val;
      return anim(elem);
    });
  }

  // è¿”å›ä¸€ä¸ªéƒ¨ç½²äº†é”™è¯¯æ•æ‰æœºåˆ¶çš„Promise
  return p.catch(function(e) {
    /* å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ */
  }).then(function() {
    return ret;
  });

}
è™½ç„¶Promiseçš„å†™æ³•æ¯”å›è°ƒå‡½æ•°çš„å†™æ³•å¤§å¤§æ”¹è¿›ï¼Œä½†æ˜¯ä¸€çœ¼çœ‹ä¸Šå»ï¼Œä»£ç å®Œå…¨éƒ½æ˜¯Promiseçš„APIï¼ˆthenã€catchç­‰ç­‰ï¼‰ï¼Œæ“ä½œæœ¬èº«çš„è¯­ä¹‰åè€Œä¸å®¹æ˜“çœ‹å‡ºæ¥ã€‚

æ¥ç€æ˜¯Generatorå‡½æ•°çš„å†™æ³•ã€‚

function chainAnimationsGenerator(elem, animations) {

  return spawn(function*() {
    var ret = null;
    try {
      for(var anim of animations) {
        ret = yield anim(elem);
      }
    } catch(e) {
      /* å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ */
    }
    return ret;
  });

}
ä¸Šé¢ä»£ç ä½¿ç”¨Generatorå‡½æ•°éå†äº†æ¯ä¸ªåŠ¨ç”»ï¼Œè¯­ä¹‰æ¯”Promiseå†™æ³•æ›´æ¸…æ™°ï¼Œç”¨æˆ·å®šä¹‰çš„æ“ä½œå…¨éƒ¨éƒ½å‡ºç°åœ¨spawnå‡½æ•°çš„å†…éƒ¨ã€‚è¿™ä¸ªå†™æ³•çš„é—®é¢˜åœ¨äºï¼Œå¿…é¡»æœ‰ä¸€ä¸ªä»»åŠ¡è¿è¡Œå™¨ï¼Œè‡ªåŠ¨æ‰§è¡ŒGeneratorå‡½æ•°ï¼Œä¸Šé¢ä»£ç çš„spawnå‡½æ•°å°±æ˜¯è‡ªåŠ¨æ‰§è¡Œå™¨ï¼Œå®ƒè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œè€Œä¸”å¿…é¡»ä¿è¯yieldè¯­å¥åé¢çš„è¡¨è¾¾å¼ï¼Œå¿…é¡»è¿”å›ä¸€ä¸ªPromiseã€‚

æœ€åæ˜¯Asyncå‡½æ•°çš„å†™æ³•ã€‚

async function chainAnimationsAsync(elem, animations) {
  var ret = null;
  try {
    for(var anim of animations) {
      ret = await anim(elem);
    }
  } catch(e) {
    /* å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ */
  }
  return ret;
}
å¯ä»¥çœ‹åˆ°Asyncå‡½æ•°çš„å®ç°æœ€ç®€æ´ï¼Œæœ€ç¬¦åˆè¯­ä¹‰ï¼Œå‡ ä¹æ²¡æœ‰è¯­ä¹‰ä¸ç›¸å…³çš„ä»£ç ã€‚å®ƒå°†Generatorå†™æ³•ä¸­çš„è‡ªåŠ¨æ‰§è¡Œå™¨ï¼Œæ”¹åœ¨è¯­è¨€å±‚é¢æä¾›ï¼Œä¸æš´éœ²ç»™ç”¨æˆ·ï¼Œå› æ­¤ä»£ç é‡æœ€å°‘ã€‚å¦‚æœä½¿ç”¨Generatorå†™æ³•ï¼Œè‡ªåŠ¨æ‰§è¡Œå™¨éœ€è¦ç”¨æˆ·è‡ªå·±æä¾›ã€‚

å®ä¾‹ï¼šæŒ‰é¡ºåºå®Œæˆå¼‚æ­¥æ“ä½œ
å®é™…å¼€å‘ä¸­ï¼Œç»å¸¸é‡åˆ°ä¸€ç»„å¼‚æ­¥æ“ä½œï¼Œéœ€è¦æŒ‰ç…§é¡ºåºå®Œæˆã€‚æ¯”å¦‚ï¼Œä¾æ¬¡è¿œç¨‹è¯»å–ä¸€ç»„URLï¼Œç„¶åæŒ‰ç…§è¯»å–çš„é¡ºåºè¾“å‡ºç»“æœã€‚

Promise çš„å†™æ³•å¦‚ä¸‹ã€‚

function logInOrder(urls) {
  // è¿œç¨‹è¯»å–æ‰€æœ‰URL
  const textPromises = urls.map(url => {
    return fetch(url).then(response => response.text());
  });

  // æŒ‰æ¬¡åºè¾“å‡º
  textPromises.reduce((chain, textPromise) => {
    return chain.then(() => textPromise)
      .then(text => console.log(text));
  }, Promise.resolve());
}
ä¸Šé¢ä»£ç ä½¿ç”¨fetchæ–¹æ³•ï¼ŒåŒæ—¶è¿œç¨‹è¯»å–ä¸€ç»„URLã€‚æ¯ä¸ªfetchæ“ä½œéƒ½è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œæ”¾å…¥textPromisesæ•°ç»„ã€‚ç„¶åï¼Œreduceæ–¹æ³•ä¾æ¬¡å¤„ç†æ¯ä¸ªPromiseå¯¹è±¡ï¼Œç„¶åä½¿ç”¨thenï¼Œå°†æ‰€æœ‰Promiseå¯¹è±¡è¿èµ·æ¥ï¼Œå› æ­¤å°±å¯ä»¥ä¾æ¬¡è¾“å‡ºç»“æœã€‚

è¿™ç§å†™æ³•ä¸å¤ªç›´è§‚ï¼Œå¯è¯»æ€§æ¯”è¾ƒå·®ã€‚ä¸‹é¢æ˜¯asyncå‡½æ•°å®ç°ã€‚

async function logInOrder(urls) {
  for (const url of urls) {
    const response = await fetch(url);
    console.log(await response.text());
  }
}
ä¸Šé¢ä»£ç ç¡®å®å¤§å¤§ç®€åŒ–ï¼Œé—®é¢˜æ˜¯æ‰€æœ‰è¿œç¨‹æ“ä½œéƒ½æ˜¯ç»§å‘ã€‚åªæœ‰å‰ä¸€ä¸ªURLè¿”å›ç»“æœï¼Œæ‰ä¼šå»è¯»å–ä¸‹ä¸€ä¸ªURLï¼Œè¿™æ ·åšæ•ˆç‡å¾ˆå·®ï¼Œéå¸¸æµªè´¹æ—¶é—´ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯å¹¶å‘å‘å‡ºè¿œç¨‹è¯·æ±‚ã€‚

async function logInOrder(urls) {
  // å¹¶å‘è¯»å–è¿œç¨‹URL
  const textPromises = urls.map(async url => {
    const response = await fetch(url);
    return response.text();
  });

  // æŒ‰æ¬¡åºè¾“å‡º
  for (const textPromise of textPromises) {
    console.log(await textPromise);
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œè™½ç„¶mapæ–¹æ³•çš„å‚æ•°æ˜¯asyncå‡½æ•°ï¼Œä½†å®ƒæ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå› ä¸ºåªæœ‰asyncå‡½æ•°å†…éƒ¨æ˜¯ç»§å‘æ‰§è¡Œï¼Œå¤–éƒ¨ä¸å—å½±å“ã€‚åé¢çš„for..ofå¾ªç¯å†…éƒ¨ä½¿ç”¨äº†awaitï¼Œå› æ­¤å®ç°äº†æŒ‰é¡ºåºè¾“å‡ºã€‚

å¼‚æ­¥éå†å™¨
ã€Šéå†å™¨ã€‹ä¸€ç« è¯´è¿‡ï¼ŒIterator æ¥å£æ˜¯ä¸€ç§æ•°æ®éå†çš„åè®®ï¼Œåªè¦è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªè¡¨ç¤ºå½“å‰æˆå‘˜ä¿¡æ¯çš„å¯¹è±¡{value, done}ã€‚å…¶ä¸­ï¼Œvalueè¡¨ç¤ºå½“å‰çš„æ•°æ®çš„å€¼ï¼Œdoneæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºéå†æ˜¯å¦ç»“æŸã€‚

è¿™éšå«ç€è§„å®šï¼Œnextæ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œåªè¦è°ƒç”¨å°±å¿…é¡»ç«‹åˆ»è¿”å›å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦æ‰§è¡Œnextæ–¹æ³•ï¼Œå°±å¿…é¡»åŒæ­¥åœ°å¾—åˆ°valueå’Œdoneè¿™ä¸¤æ–¹é¢çš„ä¿¡æ¯ã€‚è¿™å¯¹äºåŒæ­¥æ“ä½œï¼Œå½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†å¯¹äºå¼‚æ­¥æ“ä½œï¼Œå°±ä¸å¤ªåˆé€‚äº†ã€‚ç›®å‰çš„è§£å†³æ–¹æ³•æ˜¯ï¼ŒGeneratorå‡½æ•°é‡Œé¢çš„å¼‚æ­¥æ“ä½œï¼Œè¿”å›ä¸€ä¸ªThunkå‡½æ•°æˆ–è€…Promiseå¯¹è±¡ï¼Œå³valueå±æ€§æ˜¯ä¸€ä¸ªThunkå‡½æ•°æˆ–è€…Promiseå¯¹è±¡ï¼Œç­‰å¾…ä»¥åè¿”å›çœŸæ­£çš„å€¼ï¼Œè€Œdoneå±æ€§åˆ™è¿˜æ˜¯åŒæ­¥äº§ç”Ÿçš„ã€‚

ç›®å‰ï¼Œæœ‰ä¸€ä¸ªææ¡ˆï¼Œä¸ºå¼‚æ­¥æ“ä½œæä¾›åŸç”Ÿçš„éå†å™¨æ¥å£ï¼Œå³valueå’Œdoneè¿™ä¸¤ä¸ªå±æ€§éƒ½æ˜¯å¼‚æ­¥äº§ç”Ÿï¼Œè¿™ç§°ä¸ºâ€å¼‚æ­¥éå†å™¨â€œï¼ˆAsync Iteratorï¼‰ã€‚

å¼‚æ­¥éå†çš„æ¥å£
å¼‚æ­¥éå†å™¨çš„æœ€å¤§çš„è¯­æ³•ç‰¹ç‚¹ï¼Œå°±æ˜¯è°ƒç”¨éå†å™¨çš„nextæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ã€‚

asyncIterator
  .next()
  .then(
    ({ value, done }) => /* ... */
  );
ä¸Šé¢ä»£ç ä¸­ï¼ŒasyncIteratoræ˜¯ä¸€ä¸ªå¼‚æ­¥éå†å™¨ï¼Œè°ƒç”¨nextæ–¹æ³•ä»¥åï¼Œè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨thenæ–¹æ³•æŒ‡å®šï¼Œè¿™ä¸ªPromiseå¯¹è±¡çš„çŠ¶æ€å˜ä¸ºresolveä»¥åçš„å›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œåˆ™æ˜¯ä¸€ä¸ªå…·æœ‰valueå’Œdoneä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼Œè¿™ä¸ªè·ŸåŒæ­¥éå†å™¨æ˜¯ä¸€æ ·çš„ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªå¯¹è±¡çš„åŒæ­¥éå†å™¨çš„æ¥å£ï¼Œéƒ¨ç½²åœ¨Symbol.iteratorå±æ€§ä¸Šé¢ã€‚åŒæ ·åœ°ï¼Œå¯¹è±¡çš„å¼‚æ­¥éå†å™¨æ¥å£ï¼Œéƒ¨ç½²åœ¨Symbol.asyncIteratorå±æ€§ä¸Šé¢ã€‚ä¸ç®¡æ˜¯ä»€ä¹ˆæ ·çš„å¯¹è±¡ï¼Œåªè¦å®ƒçš„Symbol.asyncIteratorå±æ€§æœ‰å€¼ï¼Œå°±è¡¨ç¤ºåº”è¯¥å¯¹å®ƒè¿›è¡Œå¼‚æ­¥éå†ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¼‚æ­¥éå†å™¨çš„ä¾‹å­ã€‚

const asyncIterable = createAsyncIterable(['a', 'b']);
const asyncIterator = someCollection[Symbol.asyncIterator]();

asyncIterator.next()
.then(iterResult1 => {
  console.log(iterResult1); // { value: 'a', done: false }
  return asyncIterator.next();
}).then(iterResult2 => {
  console.log(iterResult2); // { value: 'b', done: false }
  return asyncIterator.next();
}).then(iterResult3 => {
  console.log(iterResult3); // { value: undefined, done: true }
});
ä¸Šé¢ä»£ç ä¸­ï¼Œå¼‚æ­¥éå†å™¨å…¶å®è¿”å›äº†ä¸¤æ¬¡å€¼ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼›ç­‰åˆ°Promiseå¯¹è±¡resolveäº†ï¼Œå†è¿”å›ä¸€ä¸ªè¡¨ç¤ºå½“å‰æ•°æ®æˆå‘˜ä¿¡æ¯çš„å¯¹è±¡ã€‚è¿™å°±æ˜¯è¯´ï¼Œå¼‚æ­¥éå†å™¨ä¸åŒæ­¥éå†å™¨æœ€ç»ˆè¡Œä¸ºæ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯ä¼šå…ˆè¿”å›Promiseå¯¹è±¡ï¼Œä½œä¸ºä¸­ä»‹ã€‚

ç”±äºå¼‚æ­¥éå†å™¨çš„nextæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ã€‚å› æ­¤ï¼Œå¯ä»¥æŠŠå®ƒæ”¾åœ¨awaitå‘½ä»¤åé¢ã€‚

async function f() {
  const asyncIterable = createAsyncIterable(['a', 'b']);
  const asyncIterator = asyncIterable[Symbol.asyncIterator]();
  console.log(await asyncIterator.next());
  // { value: 'a', done: false }
  console.log(await asyncIterator.next());
  // { value: 'b', done: false }
  console.log(await asyncIterator.next());
  // { value: undefined, done: true }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œnextæ–¹æ³•ç”¨awaitå¤„ç†ä»¥åï¼Œå°±ä¸å¿…ä½¿ç”¨thenæ–¹æ³•äº†ã€‚æ•´ä¸ªæµç¨‹å·²ç»å¾ˆæ¥è¿‘åŒæ­¥å¤„ç†äº†ã€‚

æ³¨æ„ï¼Œå¼‚æ­¥éå†å™¨çš„nextæ–¹æ³•æ˜¯å¯ä»¥è¿ç»­è°ƒç”¨çš„ï¼Œä¸å¿…ç­‰åˆ°ä¸Šä¸€æ­¥äº§ç”Ÿçš„Promiseå¯¹è±¡resolveä»¥åå†è°ƒç”¨ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œnextæ–¹æ³•ä¼šç´¯ç§¯èµ·æ¥ï¼Œè‡ªåŠ¨æŒ‰ç…§æ¯ä¸€æ­¥çš„é¡ºåºè¿è¡Œä¸‹å»ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼ŒæŠŠæ‰€æœ‰çš„nextæ–¹æ³•æ”¾åœ¨Promise.allæ–¹æ³•é‡Œé¢ã€‚

const asyncGenObj = createAsyncIterable(['a', 'b']);
const [{value: v1}, {value: v2}] = await Promise.all([
  asyncGenObj.next(), asyncGenObj.next()
]);

console.log(v1, v2); // a b
å¦ä¸€ç§ç”¨æ³•æ˜¯ä¸€æ¬¡æ€§è°ƒç”¨æ‰€æœ‰çš„nextæ–¹æ³•ï¼Œç„¶åawaitæœ€åä¸€æ­¥æ“ä½œã€‚

const writer = openFile('someFile.txt');
writer.next('hello');
writer.next('world');
await writer.return();
for await...of
å‰é¢ä»‹ç»è¿‡ï¼Œfor...ofå¾ªç¯ç”¨äºéå†åŒæ­¥çš„Iteratoræ¥å£ã€‚æ–°å¼•å…¥çš„for await...ofå¾ªç¯ï¼Œåˆ™æ˜¯ç”¨äºéå†å¼‚æ­¥çš„Iteratoræ¥å£ã€‚

async function f() {
  for await (const x of createAsyncIterable(['a', 'b'])) {
    console.log(x);
  }
}
// a
// b
ä¸Šé¢ä»£ç ä¸­ï¼ŒcreateAsyncIterable()è¿”å›ä¸€ä¸ªå¼‚æ­¥éå†å™¨ï¼Œfor...ofå¾ªç¯è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªéå†å™¨çš„nextæ–¹æ³•ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªPromiseå¯¹è±¡ã€‚awaitç”¨æ¥å¤„ç†è¿™ä¸ªPromiseå¯¹è±¡ï¼Œä¸€æ—¦resolveï¼Œå°±æŠŠå¾—åˆ°çš„å€¼ï¼ˆxï¼‰ä¼ å…¥for...ofçš„å¾ªç¯ä½“ã€‚

å¦‚æœnextæ–¹æ³•è¿”å›çš„Promiseå¯¹è±¡è¢«rejectï¼Œé‚£ä¹ˆå°±è¦ç”¨try...catchæ•æ‰ã€‚

async function () {
  try {
    for await (const x of createRejectingIterable()) {
      console.log(x);
    }
  } catch (e) {
    console.error(e);
  }
}
æ³¨æ„ï¼Œfor await...ofå¾ªç¯ä¹Ÿå¯ä»¥ç”¨äºåŒæ­¥éå†å™¨ã€‚

(async function () {
  for await (const x of ['a', 'b']) {
    console.log(x);
  }
})();
// a
// b
å¼‚æ­¥Generatorå‡½æ•°
å°±åƒGeneratorå‡½æ•°è¿”å›ä¸€ä¸ªåŒæ­¥éå†å™¨å¯¹è±¡ä¸€æ ·ï¼Œå¼‚æ­¥Generatorå‡½æ•°çš„ä½œç”¨ï¼Œæ˜¯è¿”å›ä¸€ä¸ªå¼‚æ­¥éå†å™¨å¯¹è±¡ã€‚

åœ¨è¯­æ³•ä¸Šï¼Œå¼‚æ­¥Generatorå‡½æ•°å°±æ˜¯asyncå‡½æ•°ä¸Generatorå‡½æ•°çš„ç»“åˆã€‚

async function* readLines(path) {
  let file = await fileOpen(path);

  try {
    while (!file.EOF) {
      yield await file.readLine();
    }
  } finally {
    await file.close();
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå¼‚æ­¥æ“ä½œå‰é¢ä½¿ç”¨awaitå…³é”®å­—æ ‡æ˜ï¼Œå³awaitåé¢çš„æ“ä½œï¼Œåº”è¯¥è¿”å›Promiseå¯¹è±¡ã€‚å‡¡æ˜¯ä½¿ç”¨yieldå…³é”®å­—çš„åœ°æ–¹ï¼Œå°±æ˜¯nextæ–¹æ³•çš„åœä¸‹æ¥çš„åœ°æ–¹ï¼Œå®ƒåé¢çš„è¡¨è¾¾å¼çš„å€¼ï¼ˆå³await file.readLine()çš„å€¼ï¼‰ï¼Œä¼šä½œä¸ºnext()è¿”å›å¯¹è±¡çš„valueå±æ€§ï¼Œè¿™ä¸€ç‚¹æ˜¯äºåŒæ­¥Generatorå‡½æ•°ä¸€è‡´çš„ã€‚

å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼Œä½¿ç”¨ä¸Šé¢ä»£ç å®šä¹‰çš„å¼‚æ­¥Generatorå‡½æ•°ã€‚

for await (const line of readLines(filePath)) {
  console.log(line);
}
å¼‚æ­¥Generatorå‡½æ•°å¯ä»¥ä¸for await...ofå¾ªç¯ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚

async function* prefixLines(asyncIterable) {
  for await (const line of asyncIterable) {
    yield '> ' + line;
  }
}
yieldå‘½ä»¤ä¾ç„¶æ˜¯ç«‹åˆ»è¿”å›çš„ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ã€‚

async function* asyncGenerator() {
  console.log('Start');
  const result = await doSomethingAsync(); // (A)
  yield 'Result: '+ result; // (B)
  console.log('Done');
}
ä¸Šé¢ä»£ç ä¸­ï¼Œè°ƒç”¨nextæ–¹æ³•ä»¥åï¼Œä¼šåœ¨Bå¤„æš‚åœæ‰§è¡Œï¼Œyieldå‘½ä»¤ç«‹åˆ»è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ã€‚è¿™ä¸ªPromiseå¯¹è±¡ä¸åŒäºAå¤„awaitå‘½ä»¤åé¢çš„é‚£ä¸ªPromiseå¯¹è±¡ã€‚ä¸»è¦æœ‰ä¸¤ç‚¹ä¸åŒï¼Œä¸€æ˜¯Aå¤„çš„Promiseå¯¹è±¡resolveä»¥åäº§ç”Ÿçš„å€¼ï¼Œä¼šæ”¾å…¥resultå˜é‡ï¼›äºŒæ˜¯Bå¤„çš„Promiseå¯¹è±¡resolveä»¥åäº§ç”Ÿçš„å€¼ï¼Œæ˜¯è¡¨è¾¾å¼'Resultï¼š ' + resultçš„å€¼ï¼›äºŒæ˜¯Aå¤„çš„Promiseå¯¹è±¡ä¸€å®šå…ˆäºBå¤„çš„Promiseå¯¹è±¡resolveã€‚

å¦‚æœå¼‚æ­¥Generatorå‡½æ•°æŠ›å‡ºé”™è¯¯ï¼Œä¼šè¢«Promiseå¯¹è±¡rejectï¼Œç„¶åæŠ›å‡ºçš„é”™è¯¯è¢«catchæ–¹æ³•æ•è·ã€‚

async function* asyncGenerator() {
  throw new Error('Problem!');
}

asyncGenerator()
.next()
.catch(err => console.log(err)); // Error: Problem!
æ³¨æ„ï¼Œæ™®é€šçš„asyncå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œè€Œå¼‚æ­¥Generatorå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¼‚æ­¥Iteratorå¯¹è±¡ã€‚åŸºæœ¬ä¸Šï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼Œasyncå‡½æ•°å’Œå¼‚æ­¥Generatorå‡½æ•°ï¼Œæ˜¯å°è£…å¼‚æ­¥æ“ä½œçš„ä¸¤ç§æ–¹æ³•ï¼Œéƒ½ç”¨æ¥è¾¾åˆ°åŒä¸€ç§ç›®çš„ã€‚åŒºåˆ«åœ¨äºï¼Œå‰è€…è‡ªå¸¦æ‰§è¡Œå™¨ï¼Œåè€…é€šè¿‡for await...ofæ‰§è¡Œï¼Œæˆ–è€…è‡ªå·±ç¼–å†™æ‰§è¡Œå™¨ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥Generatorå‡½æ•°çš„æ‰§è¡Œå™¨ã€‚

async function takeAsync(asyncIterable, count=Infinity) {
  const result = [];
  const iterator = asyncIterable[Symbol.asyncIterator]();
  while (result.length < count) {
    const {value,done} = await iterator.next();
    if (done) break;
    result.push(value);
  }
  return result;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå¼‚æ­¥Generatorå‡½æ•°äº§ç”Ÿçš„å¼‚æ­¥éå†å™¨ï¼Œä¼šé€šè¿‡whileå¾ªç¯è‡ªåŠ¨æ‰§è¡Œï¼Œæ¯å½“await iterator.next()å®Œæˆï¼Œå°±ä¼šè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ã€‚

ä¸‹é¢æ˜¯è¿™ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨çš„ä¸€ä¸ªä½¿ç”¨å®ä¾‹ã€‚

async function f() {
  async function* gen() {
    yield 'a';
    yield 'b';
    yield 'c';
  }

  return await takeAsync(gen());
}

f().then(function (result) {
  console.log(result); // ['a', 'b', 'c']
})
å¼‚æ­¥Generatorå‡½æ•°å‡ºç°ä»¥åï¼ŒJavaScriptå°±æœ‰äº†å››ç§å‡½æ•°å½¢å¼ï¼šæ™®é€šå‡½æ•°ã€asyncå‡½æ•°ã€Generatorå‡½æ•°å’Œå¼‚æ­¥Generatorå‡½æ•°ã€‚è¯·æ³¨æ„åŒºåˆ†æ¯ç§å‡½æ•°çš„ä¸åŒä¹‹å¤„ã€‚

æœ€åï¼ŒåŒæ­¥çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼‚æ­¥Generatorå‡½æ•°ã€‚

async function* createAsyncIterable(syncIterable) {
  for (const elem of syncIterable) {
    yield elem;
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºæ²¡æœ‰å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰ä½¿ç”¨awaitå…³é”®å­—ã€‚

yield* è¯­å¥
yield*è¯­å¥ä¹Ÿå¯ä»¥è·Ÿä¸€ä¸ªå¼‚æ­¥éå†å™¨ã€‚

async function* gen1() {
  yield 'a';
  yield 'b';
  return 2;
}

async function* gen2() {
  const result = yield* gen1();
}
ä¸Šé¢ä»£ç ä¸­ï¼Œgen2å‡½æ•°é‡Œé¢çš„resultå˜é‡ï¼Œæœ€åçš„å€¼æ˜¯2ã€‚

ä¸åŒæ­¥Generatorå‡½æ•°ä¸€æ ·ï¼Œfor await...ofå¾ªç¯ä¼šå±•å¼€yield*ã€‚

(async function () {
  for await (const x of gen2()) {
    console.log(x);
  }
})();
// a
// b

##Class
1.ClassåŸºæœ¬è¯­æ³•
æ¦‚è¿°
JavaScriptè¯­è¨€çš„ä¼ ç»Ÿæ–¹æ³•æ˜¯é€šè¿‡æ„é€ å‡½æ•°ï¼Œå®šä¹‰å¹¶ç”Ÿæˆæ–°å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

function Point(x, y) {
  this.x = x;
  this.y = y;
}

Point.prototype.toString = function () {
  return '(' + this.x + ', ' + this.y + ')';
};

var p = new Point(1, 2);
ä¸Šé¢è¿™ç§å†™æ³•è·Ÿä¼ ç»Ÿçš„é¢å‘å¯¹è±¡è¯­è¨€ï¼ˆæ¯”å¦‚C++å’ŒJavaï¼‰å·®å¼‚å¾ˆå¤§ï¼Œå¾ˆå®¹æ˜“è®©æ–°å­¦ä¹ è¿™é—¨è¯­è¨€çš„ç¨‹åºå‘˜æ„Ÿåˆ°å›°æƒ‘ã€‚

ES6æä¾›äº†æ›´æ¥è¿‘ä¼ ç»Ÿè¯­è¨€çš„å†™æ³•ï¼Œå¼•å…¥äº†Classï¼ˆç±»ï¼‰è¿™ä¸ªæ¦‚å¿µï¼Œä½œä¸ºå¯¹è±¡çš„æ¨¡æ¿ã€‚é€šè¿‡classå…³é”®å­—ï¼Œå¯ä»¥å®šä¹‰ç±»ã€‚åŸºæœ¬ä¸Šï¼ŒES6çš„classå¯ä»¥çœ‹ä½œåªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå®ƒçš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ï¼ŒES5éƒ½å¯ä»¥åšåˆ°ï¼Œæ–°çš„classå†™æ³•åªæ˜¯è®©å¯¹è±¡åŸå‹çš„å†™æ³•æ›´åŠ æ¸…æ™°ã€æ›´åƒé¢å‘å¯¹è±¡ç¼–ç¨‹çš„è¯­æ³•è€Œå·²ã€‚ä¸Šé¢çš„ä»£ç ç”¨ES6çš„â€œç±»â€æ”¹å†™ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚

//å®šä¹‰ç±»
class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }

  toString() {
    return '(' + this.x + ', ' + this.y + ')';
  }
}
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªâ€œç±»â€ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªconstructoræ–¹æ³•ï¼Œè¿™å°±æ˜¯æ„é€ æ–¹æ³•ï¼Œè€Œthiså…³é”®å­—åˆ™ä»£è¡¨å®ä¾‹å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒES5çš„æ„é€ å‡½æ•°Pointï¼Œå¯¹åº”ES6çš„Pointç±»çš„æ„é€ æ–¹æ³•ã€‚

Pointç±»é™¤äº†æ„é€ æ–¹æ³•ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªtoStringæ–¹æ³•ã€‚æ³¨æ„ï¼Œå®šä¹‰â€œç±»â€çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå‰é¢ä¸éœ€è¦åŠ ä¸Šfunctionè¿™ä¸ªå…³é”®å­—ï¼Œç›´æ¥æŠŠå‡½æ•°å®šä¹‰æ”¾è¿›å»äº†å°±å¯ä»¥äº†ã€‚å¦å¤–ï¼Œæ–¹æ³•ä¹‹é—´ä¸éœ€è¦é€—å·åˆ†éš”ï¼ŒåŠ äº†ä¼šæŠ¥é”™ã€‚

ES6çš„ç±»ï¼Œå®Œå…¨å¯ä»¥çœ‹ä½œæ„é€ å‡½æ•°çš„å¦ä¸€ç§å†™æ³•ã€‚

class Point {
  // ...
}

typeof Point // "function"
Point === Point.prototype.constructor // true
ä¸Šé¢ä»£ç è¡¨æ˜ï¼Œç±»çš„æ•°æ®ç±»å‹å°±æ˜¯å‡½æ•°ï¼Œç±»æœ¬èº«å°±æŒ‡å‘æ„é€ å‡½æ•°ã€‚

ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ç›´æ¥å¯¹ç±»ä½¿ç”¨newå‘½ä»¤ï¼Œè·Ÿæ„é€ å‡½æ•°çš„ç”¨æ³•å®Œå…¨ä¸€è‡´ã€‚

class Bar {
  doStuff() {
    console.log('stuff');
  }
}

var b = new Bar();
b.doStuff() // "stuff"
æ„é€ å‡½æ•°çš„prototypeå±æ€§ï¼Œåœ¨ES6çš„â€œç±»â€ä¸Šé¢ç»§ç»­å­˜åœ¨ã€‚äº‹å®ä¸Šï¼Œç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½å®šä¹‰åœ¨ç±»çš„prototypeå±æ€§ä¸Šé¢ã€‚

class Point {
  constructor(){
    // ...
  }

  toString(){
    // ...
  }

  toValue(){
    // ...
  }
}

// ç­‰åŒäº

Point.prototype = {
  toString(){},
  toValue(){}
};
åœ¨ç±»çš„å®ä¾‹ä¸Šé¢è°ƒç”¨æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨åŸå‹ä¸Šçš„æ–¹æ³•ã€‚

class B {}
let b = new B();

b.constructor === B.prototype.constructor // true
ä¸Šé¢ä»£ç ä¸­ï¼Œbæ˜¯Bç±»çš„å®ä¾‹ï¼Œå®ƒçš„constructoræ–¹æ³•å°±æ˜¯Bç±»åŸå‹çš„constructoræ–¹æ³•ã€‚

ç”±äºç±»çš„æ–¹æ³•éƒ½å®šä¹‰åœ¨prototypeå¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥ç±»çš„æ–°æ–¹æ³•å¯ä»¥æ·»åŠ åœ¨prototypeå¯¹è±¡ä¸Šé¢ã€‚Object.assignæ–¹æ³•å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸€æ¬¡å‘ç±»æ·»åŠ å¤šä¸ªæ–¹æ³•ã€‚

class Point {
  constructor(){
    // ...
  }
}

Object.assign(Point.prototype, {
  toString(){},
  toValue(){}
});
prototypeå¯¹è±¡çš„constructorå±æ€§ï¼Œç›´æ¥æŒ‡å‘â€œç±»â€çš„æœ¬èº«ï¼Œè¿™ä¸ES5çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚

Point.prototype.constructor === Point // true
å¦å¤–ï¼Œç±»çš„å†…éƒ¨æ‰€æœ‰å®šä¹‰çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸å¯æšä¸¾çš„ï¼ˆnon-enumerableï¼‰ã€‚

class Point {
  constructor(x, y) {
    // ...
  }

  toString() {
    // ...
  }
}

Object.keys(Point.prototype)
// []
Object.getOwnPropertyNames(Point.prototype)
// ["constructor","toString"]
ä¸Šé¢ä»£ç ä¸­ï¼ŒtoStringæ–¹æ³•æ˜¯Pointç±»å†…éƒ¨å®šä¹‰çš„æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸å¯æšä¸¾çš„ã€‚è¿™ä¸€ç‚¹ä¸ES5çš„è¡Œä¸ºä¸ä¸€è‡´ã€‚

var Point = function (x, y) {
  // ...
};

Point.prototype.toString = function() {
  // ...
};

Object.keys(Point.prototype)
// ["toString"]
Object.getOwnPropertyNames(Point.prototype)
// ["constructor","toString"]
ä¸Šé¢ä»£ç é‡‡ç”¨ES5çš„å†™æ³•ï¼ŒtoStringæ–¹æ³•å°±æ˜¯å¯æšä¸¾çš„ã€‚

ç±»çš„å±æ€§åï¼Œå¯ä»¥é‡‡ç”¨è¡¨è¾¾å¼ã€‚

let methodName = "getArea";
class Square{
  constructor(length) {
    // ...
  }

  [methodName]() {
    // ...
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒSquareç±»çš„æ–¹æ³•ågetAreaï¼Œæ˜¯ä»è¡¨è¾¾å¼å¾—åˆ°çš„ã€‚

constructoræ–¹æ³•
constructoræ–¹æ³•æ˜¯ç±»çš„é»˜è®¤æ–¹æ³•ï¼Œé€šè¿‡newå‘½ä»¤ç”Ÿæˆå¯¹è±¡å®ä¾‹æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ã€‚ä¸€ä¸ªç±»å¿…é¡»æœ‰constructoræ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼å®šä¹‰ï¼Œä¸€ä¸ªç©ºçš„constructoræ–¹æ³•ä¼šè¢«é»˜è®¤æ·»åŠ ã€‚

constructor() {}
constructoræ–¹æ³•é»˜è®¤è¿”å›å®ä¾‹å¯¹è±¡ï¼ˆå³thisï¼‰ï¼Œå®Œå…¨å¯ä»¥æŒ‡å®šè¿”å›å¦å¤–ä¸€ä¸ªå¯¹è±¡ã€‚

class Foo {
  constructor() {
    return Object.create(null);
  }
}

new Foo() instanceof Foo
// false
ä¸Šé¢ä»£ç ä¸­ï¼Œconstructorå‡½æ•°è¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œç»“æœå¯¼è‡´å®ä¾‹å¯¹è±¡ä¸æ˜¯Fooç±»çš„å®ä¾‹ã€‚

ç±»çš„æ„é€ å‡½æ•°ï¼Œä¸ä½¿ç”¨newæ˜¯æ²¡æ³•è°ƒç”¨çš„ï¼Œä¼šæŠ¥é”™ã€‚è¿™æ˜¯å®ƒè·Ÿæ™®é€šæ„é€ å‡½æ•°çš„ä¸€ä¸ªä¸»è¦åŒºåˆ«ï¼Œåè€…ä¸ç”¨newä¹Ÿå¯ä»¥æ‰§è¡Œã€‚

class Foo {
  constructor() {
    return Object.create(null);
  }
}

Foo()
// TypeError: Class constructor Foo cannot be invoked without 'new'
ç±»çš„å®ä¾‹å¯¹è±¡
ç”Ÿæˆç±»çš„å®ä¾‹å¯¹è±¡çš„å†™æ³•ï¼Œä¸ES5å®Œå…¨ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä½¿ç”¨newå‘½ä»¤ã€‚å¦‚æœå¿˜è®°åŠ ä¸Šnewï¼Œåƒå‡½æ•°é‚£æ ·è°ƒç”¨Classï¼Œå°†ä¼šæŠ¥é”™ã€‚

// æŠ¥é”™
var point = Point(2, 3);

// æ­£ç¡®
var point = new Point(2, 3);
ä¸ES5ä¸€æ ·ï¼Œå®ä¾‹çš„å±æ€§é™¤éæ˜¾å¼å®šä¹‰åœ¨å…¶æœ¬èº«ï¼ˆå³å®šä¹‰åœ¨thiså¯¹è±¡ä¸Šï¼‰ï¼Œå¦åˆ™éƒ½æ˜¯å®šä¹‰åœ¨åŸå‹ä¸Šï¼ˆå³å®šä¹‰åœ¨classä¸Šï¼‰ã€‚

//å®šä¹‰ç±»
class Point {

  constructor(x, y) {
    this.x = x;
    this.y = y;
  }

  toString() {
    return '(' + this.x + ', ' + this.y + ')';
  }

}

var point = new Point(2, 3);

point.toString() // (2, 3)

point.hasOwnProperty('x') // true
point.hasOwnProperty('y') // true
point.hasOwnProperty('toString') // false
point.__proto__.hasOwnProperty('toString') // true
ä¸Šé¢ä»£ç ä¸­ï¼Œxå’Œyéƒ½æ˜¯å®ä¾‹å¯¹è±¡pointè‡ªèº«çš„å±æ€§ï¼ˆå› ä¸ºå®šä¹‰åœ¨thiså˜é‡ä¸Šï¼‰ï¼Œæ‰€ä»¥hasOwnPropertyæ–¹æ³•è¿”å›trueï¼Œè€ŒtoStringæ˜¯åŸå‹å¯¹è±¡çš„å±æ€§ï¼ˆå› ä¸ºå®šä¹‰åœ¨Pointç±»ä¸Šï¼‰ï¼Œæ‰€ä»¥hasOwnPropertyæ–¹æ³•è¿”å›falseã€‚è¿™äº›éƒ½ä¸ES5çš„è¡Œä¸ºä¿æŒä¸€è‡´ã€‚

ä¸ES5ä¸€æ ·ï¼Œç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ä¸€ä¸ªåŸå‹å¯¹è±¡ã€‚

var p1 = new Point(2,3);
var p2 = new Point(3,2);

p1.__proto__ === p2.__proto__
//true
ä¸Šé¢ä»£ç ä¸­ï¼Œp1å’Œp2éƒ½æ˜¯Pointçš„å®ä¾‹ï¼Œå®ƒä»¬çš„åŸå‹éƒ½æ˜¯Point.prototypeï¼Œæ‰€ä»¥__proto__å±æ€§æ˜¯ç›¸ç­‰çš„ã€‚

è¿™ä¹Ÿæ„å‘³ç€ï¼Œå¯ä»¥é€šè¿‡å®ä¾‹çš„__proto__å±æ€§ä¸ºClassæ·»åŠ æ–¹æ³•ã€‚

var p1 = new Point(2,3);
var p2 = new Point(3,2);

p1.__proto__.printName = function () { return 'Oops' };

p1.printName() // "Oops"
p2.printName() // "Oops"

var p3 = new Point(4,2);
p3.printName() // "Oops"
ä¸Šé¢ä»£ç åœ¨p1çš„åŸå‹ä¸Šæ·»åŠ äº†ä¸€ä¸ªprintNameæ–¹æ³•ï¼Œç”±äºp1çš„åŸå‹å°±æ˜¯p2çš„åŸå‹ï¼Œå› æ­¤p2ä¹Ÿå¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è€Œä¸”ï¼Œæ­¤åæ–°å»ºçš„å®ä¾‹p3ä¹Ÿå¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ„å‘³ç€ï¼Œä½¿ç”¨å®ä¾‹çš„__proto__å±æ€§æ”¹å†™åŸå‹ï¼Œå¿…é¡»ç›¸å½“è°¨æ…ï¼Œä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºè¿™ä¼šæ”¹å˜Classçš„åŸå§‹å®šä¹‰ï¼Œå½±å“åˆ°æ‰€æœ‰å®ä¾‹ã€‚

ä¸å­˜åœ¨å˜é‡æå‡
Classä¸å­˜åœ¨å˜é‡æå‡ï¼ˆhoistï¼‰ï¼Œè¿™ä¸€ç‚¹ä¸ES5å®Œå…¨ä¸åŒã€‚

new Foo(); // ReferenceError
class Foo {}
ä¸Šé¢ä»£ç ä¸­ï¼ŒFooç±»ä½¿ç”¨åœ¨å‰ï¼Œå®šä¹‰åœ¨åï¼Œè¿™æ ·ä¼šæŠ¥é”™ï¼Œå› ä¸ºES6ä¸ä¼šæŠŠç±»çš„å£°æ˜æå‡åˆ°ä»£ç å¤´éƒ¨ã€‚è¿™ç§è§„å®šçš„åŸå› ä¸ä¸‹æ–‡è¦æåˆ°çš„ç»§æ‰¿æœ‰å…³ï¼Œå¿…é¡»ä¿è¯å­ç±»åœ¨çˆ¶ç±»ä¹‹åå®šä¹‰ã€‚

{
  let Foo = class {};
  class Bar extends Foo {
  }
}
ä¸Šé¢çš„ä»£ç ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºBarç»§æ‰¿Fooçš„æ—¶å€™ï¼ŒFooå·²ç»æœ‰å®šä¹‰äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœå­˜åœ¨classçš„æå‡ï¼Œä¸Šé¢ä»£ç å°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºclassä¼šè¢«æå‡åˆ°ä»£ç å¤´éƒ¨ï¼Œè€Œletå‘½ä»¤æ˜¯ä¸æå‡çš„ï¼Œæ‰€ä»¥å¯¼è‡´Barç»§æ‰¿Fooçš„æ—¶å€™ï¼ŒFooè¿˜æ²¡æœ‰å®šä¹‰ã€‚

Classè¡¨è¾¾å¼
ä¸å‡½æ•°ä¸€æ ·ï¼Œç±»ä¹Ÿå¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼çš„å½¢å¼å®šä¹‰ã€‚

const MyClass = class Me {
  getClassName() {
    return Me.name;
  }
};
ä¸Šé¢ä»£ç ä½¿ç”¨è¡¨è¾¾å¼å®šä¹‰äº†ä¸€ä¸ªç±»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç±»çš„åå­—æ˜¯MyClassè€Œä¸æ˜¯Meï¼ŒMeåªåœ¨Classçš„å†…éƒ¨ä»£ç å¯ç”¨ï¼ŒæŒ‡ä»£å½“å‰ç±»ã€‚

let inst = new MyClass();
inst.getClassName() // Me
Me.name // ReferenceError: Me is not defined
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼ŒMeåªåœ¨Classå†…éƒ¨æœ‰å®šä¹‰ã€‚

å¦‚æœç±»çš„å†…éƒ¨æ²¡ç”¨åˆ°çš„è¯ï¼Œå¯ä»¥çœç•¥Meï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™æˆä¸‹é¢çš„å½¢å¼ã€‚

const MyClass = class { /* ... */ };
é‡‡ç”¨Classè¡¨è¾¾å¼ï¼Œå¯ä»¥å†™å‡ºç«‹å³æ‰§è¡Œçš„Classã€‚

let person = new class {
  constructor(name) {
    this.name = name;
  }

  sayName() {
    console.log(this.name);
  }
}('å¼ ä¸‰');

person.sayName(); // "å¼ ä¸‰"
ä¸Šé¢ä»£ç ä¸­ï¼Œpersonæ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„ç±»çš„å®ä¾‹ã€‚

ç§æœ‰æ–¹æ³•
ç§æœ‰æ–¹æ³•æ˜¯å¸¸è§éœ€æ±‚ï¼Œä½†ES6ä¸æä¾›ï¼Œåªèƒ½é€šè¿‡å˜é€šæ–¹æ³•æ¨¡æ‹Ÿå®ç°ã€‚

ä¸€ç§åšæ³•æ˜¯åœ¨å‘½åä¸ŠåŠ ä»¥åŒºåˆ«ã€‚

class Widget {

  // å…¬æœ‰æ–¹æ³•
  foo (baz) {
    this._bar(baz);
  }

  // ç§æœ‰æ–¹æ³•
  _bar(baz) {
    return this.snaf = baz;
  }

  // ...
}
ä¸Šé¢ä»£ç ä¸­ï¼Œ_baræ–¹æ³•å‰é¢çš„ä¸‹åˆ’çº¿ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåªé™äºå†…éƒ¨ä½¿ç”¨çš„ç§æœ‰æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ç§å‘½åæ˜¯ä¸ä¿é™©çš„ï¼Œåœ¨ç±»çš„å¤–éƒ¨ï¼Œè¿˜æ˜¯å¯ä»¥è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ã€‚

å¦ä¸€ç§æ–¹æ³•å°±æ˜¯ç´¢æ€§å°†ç§æœ‰æ–¹æ³•ç§»å‡ºæ¨¡å—ï¼Œå› ä¸ºæ¨¡å—å†…éƒ¨çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å¯¹å¤–å¯è§çš„ã€‚

class Widget {
  foo (baz) {
    bar.call(this, baz);
  }

  // ...
}

function bar(baz) {
  return this.snaf = baz;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œfooæ˜¯å…¬æœ‰æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨äº†bar.call(this, baz)ã€‚è¿™ä½¿å¾—barå®é™…ä¸Šæˆä¸ºäº†å½“å‰æ¨¡å—çš„ç§æœ‰æ–¹æ³•ã€‚

è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨Symbolå€¼çš„å”¯ä¸€æ€§ï¼Œå°†ç§æœ‰æ–¹æ³•çš„åå­—å‘½åä¸ºä¸€ä¸ªSymbolå€¼ã€‚

const bar = Symbol('bar');
const snaf = Symbol('snaf');

export default class myClass{

  // å…¬æœ‰æ–¹æ³•
  foo(baz) {
    this[bar](baz);
  }

  // ç§æœ‰æ–¹æ³•
  [bar](baz) {
    return this[snaf] = baz;
  }

  // ...
};
ä¸Šé¢ä»£ç ä¸­ï¼Œbarå’Œsnaféƒ½æ˜¯Symbolå€¼ï¼Œå¯¼è‡´ç¬¬ä¸‰æ–¹æ— æ³•è·å–åˆ°å®ƒä»¬ï¼Œå› æ­¤è¾¾åˆ°äº†ç§æœ‰æ–¹æ³•å’Œç§æœ‰å±æ€§çš„æ•ˆæœã€‚

thisçš„æŒ‡å‘
ç±»çš„æ–¹æ³•å†…éƒ¨å¦‚æœå«æœ‰thisï¼Œå®ƒé»˜è®¤æŒ‡å‘ç±»çš„å®ä¾‹ã€‚ä½†æ˜¯ï¼Œå¿…é¡»éå¸¸å°å¿ƒï¼Œä¸€æ—¦å•ç‹¬ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œå¾ˆå¯èƒ½æŠ¥é”™ã€‚

class Logger {
  printName(name = 'there') {
    this.print(`Hello ${name}`);
  }

  print(text) {
    console.log(text);
  }
}

const logger = new Logger();
const { printName } = logger;
printName(); // TypeError: Cannot read property 'print' of undefined
ä¸Šé¢ä»£ç ä¸­ï¼ŒprintNameæ–¹æ³•ä¸­çš„thisï¼Œé»˜è®¤æŒ‡å‘Loggerç±»çš„å®ä¾‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœå°†è¿™ä¸ªæ–¹æ³•æå–å‡ºæ¥å•ç‹¬ä½¿ç”¨ï¼Œthisä¼šæŒ‡å‘è¯¥æ–¹æ³•è¿è¡Œæ—¶æ‰€åœ¨çš„ç¯å¢ƒï¼Œå› ä¸ºæ‰¾ä¸åˆ°printæ–¹æ³•è€Œå¯¼è‡´æŠ¥é”™ã€‚

ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ç»‘å®šthisï¼Œè¿™æ ·å°±ä¸ä¼šæ‰¾ä¸åˆ°printæ–¹æ³•äº†ã€‚

class Logger {
  constructor() {
    this.printName = this.printName.bind(this);
  }

  // ...
}
å¦ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ç®­å¤´å‡½æ•°ã€‚

class Logger {
  constructor() {
    this.printName = (name = 'there') => {
      this.print(`Hello ${name}`);
    };
  }

  // ...
}
è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨Proxyï¼Œè·å–æ–¹æ³•çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç»‘å®šthisã€‚

function selfish (target) {
  const cache = new WeakMap();
  const handler = {
    get (target, key) {
      const value = Reflect.get(target, key);
      if (typeof value !== 'function') {
        return value;
      }
      if (!cache.has(value)) {
        cache.set(value, value.bind(target));
      }
      return cache.get(value);
    }
  };
  const proxy = new Proxy(target, handler);
  return proxy;
}

const logger = selfish(new Logger());
ä¸¥æ ¼æ¨¡å¼
ç±»å’Œæ¨¡å—çš„å†…éƒ¨ï¼Œé»˜è®¤å°±æ˜¯ä¸¥æ ¼æ¨¡å¼ï¼Œæ‰€ä»¥ä¸éœ€è¦ä½¿ç”¨use strictæŒ‡å®šè¿è¡Œæ¨¡å¼ã€‚åªè¦ä½ çš„ä»£ç å†™åœ¨ç±»æˆ–æ¨¡å—ä¹‹ä¸­ï¼Œå°±åªæœ‰ä¸¥æ ¼æ¨¡å¼å¯ç”¨ã€‚

è€ƒè™‘åˆ°æœªæ¥æ‰€æœ‰çš„ä»£ç ï¼Œå…¶å®éƒ½æ˜¯è¿è¡Œåœ¨æ¨¡å—ä¹‹ä¸­ï¼Œæ‰€ä»¥ES6å®é™…ä¸ŠæŠŠæ•´ä¸ªè¯­è¨€å‡çº§åˆ°äº†ä¸¥æ ¼æ¨¡å¼ã€‚

nameå±æ€§
ç”±äºæœ¬è´¨ä¸Šï¼ŒES6çš„ç±»åªæ˜¯ES5çš„æ„é€ å‡½æ•°çš„ä¸€å±‚åŒ…è£…ï¼Œæ‰€ä»¥å‡½æ•°çš„è®¸å¤šç‰¹æ€§éƒ½è¢«Classç»§æ‰¿ï¼ŒåŒ…æ‹¬nameå±æ€§ã€‚

class Point {}
Point.name // "Point"
nameå±æ€§æ€»æ˜¯è¿”å›ç´§è·Ÿåœ¨classå…³é”®å­—åé¢çš„ç±»åã€‚

Classçš„ç»§æ‰¿
åŸºæœ¬ç”¨æ³•
Classä¹‹é—´å¯ä»¥é€šè¿‡extendså…³é”®å­—å®ç°ç»§æ‰¿ï¼Œè¿™æ¯”ES5çš„é€šè¿‡ä¿®æ”¹åŸå‹é“¾å®ç°ç»§æ‰¿ï¼Œè¦æ¸…æ™°å’Œæ–¹ä¾¿å¾ˆå¤šã€‚

class ColorPoint extends Point {}
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªColorPointç±»ï¼Œè¯¥ç±»é€šè¿‡extendså…³é”®å­—ï¼Œç»§æ‰¿äº†Pointç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚ä½†æ˜¯ç”±äºæ²¡æœ‰éƒ¨ç½²ä»»ä½•ä»£ç ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªç±»å®Œå…¨ä¸€æ ·ï¼Œç­‰äºå¤åˆ¶äº†ä¸€ä¸ªPointç±»ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬åœ¨ColorPointå†…éƒ¨åŠ ä¸Šä»£ç ã€‚

class ColorPoint extends Point {
  constructor(x, y, color) {
    super(x, y); // è°ƒç”¨çˆ¶ç±»çš„constructor(x, y)
    this.color = color;
  }

  toString() {
    return this.color + ' ' + super.toString(); // è°ƒç”¨çˆ¶ç±»çš„toString()
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œconstructoræ–¹æ³•å’ŒtoStringæ–¹æ³•ä¹‹ä¸­ï¼Œéƒ½å‡ºç°äº†superå…³é”®å­—ï¼Œå®ƒåœ¨è¿™é‡Œè¡¨ç¤ºçˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œç”¨æ¥æ–°å»ºçˆ¶ç±»çš„thiså¯¹è±¡ã€‚

å­ç±»å¿…é¡»åœ¨constructoræ–¹æ³•ä¸­è°ƒç”¨superæ–¹æ³•ï¼Œå¦åˆ™æ–°å»ºå®ä¾‹æ—¶ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºå­ç±»æ²¡æœ‰è‡ªå·±çš„thiså¯¹è±¡ï¼Œè€Œæ˜¯ç»§æ‰¿çˆ¶ç±»çš„thiså¯¹è±¡ï¼Œç„¶åå¯¹å…¶è¿›è¡ŒåŠ å·¥ã€‚å¦‚æœä¸è°ƒç”¨superæ–¹æ³•ï¼Œå­ç±»å°±å¾—ä¸åˆ°thiså¯¹è±¡ã€‚

class Point { /* ... */ }

class ColorPoint extends Point {
  constructor() {
  }
}

let cp = new ColorPoint(); // ReferenceError
ä¸Šé¢ä»£ç ä¸­ï¼ŒColorPointç»§æ‰¿äº†çˆ¶ç±»Pointï¼Œä½†æ˜¯å®ƒçš„æ„é€ å‡½æ•°æ²¡æœ‰è°ƒç”¨superæ–¹æ³•ï¼Œå¯¼è‡´æ–°å»ºå®ä¾‹æ—¶æŠ¥é”™ã€‚

ES5çš„ç»§æ‰¿ï¼Œå®è´¨æ˜¯å…ˆåˆ›é€ å­ç±»çš„å®ä¾‹å¯¹è±¡thisï¼Œç„¶åå†å°†çˆ¶ç±»çš„æ–¹æ³•æ·»åŠ åˆ°thisä¸Šé¢ï¼ˆParent.apply(this)ï¼‰ã€‚ES6çš„ç»§æ‰¿æœºåˆ¶å®Œå…¨ä¸åŒï¼Œå®è´¨æ˜¯å…ˆåˆ›é€ çˆ¶ç±»çš„å®ä¾‹å¯¹è±¡thisï¼ˆæ‰€ä»¥å¿…é¡»å…ˆè°ƒç”¨superæ–¹æ³•ï¼‰ï¼Œç„¶åå†ç”¨å­ç±»çš„æ„é€ å‡½æ•°ä¿®æ”¹thisã€‚

å¦‚æœå­ç±»æ²¡æœ‰å®šä¹‰constructoræ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«é»˜è®¤æ·»åŠ ï¼Œä»£ç å¦‚ä¸‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ˜¾å¼å®šä¹‰ï¼Œä»»ä½•ä¸€ä¸ªå­ç±»éƒ½æœ‰constructoræ–¹æ³•ã€‚

constructor(...args) {
  super(...args);
}
å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œåœ¨å­ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œåªæœ‰è°ƒç”¨superä¹‹åï¼Œæ‰å¯ä»¥ä½¿ç”¨thiså…³é”®å­—ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºå­ç±»å®ä¾‹çš„æ„å»ºï¼Œæ˜¯åŸºäºå¯¹çˆ¶ç±»å®ä¾‹åŠ å·¥ï¼Œåªæœ‰superæ–¹æ³•æ‰èƒ½è¿”å›çˆ¶ç±»å®ä¾‹ã€‚

class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
}

class ColorPoint extends Point {
  constructor(x, y, color) {
    this.color = color; // ReferenceError
    super(x, y);
    this.color = color; // æ­£ç¡®
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå­ç±»çš„constructoræ–¹æ³•æ²¡æœ‰è°ƒç”¨superä¹‹å‰ï¼Œå°±ä½¿ç”¨thiså…³é”®å­—ï¼Œç»“æœæŠ¥é”™ï¼Œè€Œæ”¾åœ¨superæ–¹æ³•ä¹‹åå°±æ˜¯æ­£ç¡®çš„ã€‚

ä¸‹é¢æ˜¯ç”Ÿæˆå­ç±»å®ä¾‹çš„ä»£ç ã€‚

let cp = new ColorPoint(25, 8, 'green');

cp instanceof ColorPoint // true
cp instanceof Point // true
ä¸Šé¢ä»£ç ä¸­ï¼Œå®ä¾‹å¯¹è±¡cpåŒæ—¶æ˜¯ColorPointå’ŒPointä¸¤ä¸ªç±»çš„å®ä¾‹ï¼Œè¿™ä¸ES5çš„è¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚

ç±»çš„prototypeå±æ€§å’Œ__proto__å±æ€§
å¤§å¤šæ•°æµè§ˆå™¨çš„ES5å®ç°ä¹‹ä¸­ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰__proto__å±æ€§ï¼ŒæŒ‡å‘å¯¹åº”çš„æ„é€ å‡½æ•°çš„prototypeå±æ€§ã€‚Classä½œä¸ºæ„é€ å‡½æ•°çš„è¯­æ³•ç³–ï¼ŒåŒæ—¶æœ‰prototypeå±æ€§å’Œ__proto__å±æ€§ï¼Œå› æ­¤åŒæ—¶å­˜åœ¨ä¸¤æ¡ç»§æ‰¿é“¾ã€‚

ï¼ˆ1ï¼‰å­ç±»çš„__proto__å±æ€§ï¼Œè¡¨ç¤ºæ„é€ å‡½æ•°çš„ç»§æ‰¿ï¼Œæ€»æ˜¯æŒ‡å‘çˆ¶ç±»ã€‚

ï¼ˆ2ï¼‰å­ç±»prototypeå±æ€§çš„__proto__å±æ€§ï¼Œè¡¨ç¤ºæ–¹æ³•çš„ç»§æ‰¿ï¼Œæ€»æ˜¯æŒ‡å‘çˆ¶ç±»çš„prototypeå±æ€§ã€‚

class A {
}

class B extends A {
}

B.__proto__ === A // true
B.prototype.__proto__ === A.prototype // true
ä¸Šé¢ä»£ç ä¸­ï¼Œå­ç±»Bçš„__proto__å±æ€§æŒ‡å‘çˆ¶ç±»Aï¼Œå­ç±»Bçš„prototypeå±æ€§çš„__proto__å±æ€§æŒ‡å‘çˆ¶ç±»Açš„prototypeå±æ€§ã€‚

è¿™æ ·çš„ç»“æœæ˜¯å› ä¸ºï¼Œç±»çš„ç»§æ‰¿æ˜¯æŒ‰ç…§ä¸‹é¢çš„æ¨¡å¼å®ç°çš„ã€‚

class A {
}

class B {
}

// Bçš„å®ä¾‹ç»§æ‰¿Açš„å®ä¾‹
Object.setPrototypeOf(B.prototype, A.prototype);
const b = new B();

// Bçš„å®ä¾‹ç»§æ‰¿Açš„é™æ€å±æ€§
Object.setPrototypeOf(B, A);
const b = new B();
ã€Šå¯¹è±¡çš„æ‰©å±•ã€‹ä¸€ç« ç»™å‡ºè¿‡Object.setPrototypeOfæ–¹æ³•çš„å®ç°ã€‚

Object.setPrototypeOf = function (obj, proto) {
  obj.__proto__ = proto;
  return obj;
}
å› æ­¤ï¼Œå°±å¾—åˆ°äº†ä¸Šé¢çš„ç»“æœã€‚

Object.setPrototypeOf(B.prototype, A.prototype);
// ç­‰åŒäº
B.prototype.__proto__ = A.prototype;

Object.setPrototypeOf(B, A);
// ç­‰åŒäº
B.__proto__ = A;
è¿™ä¸¤æ¡ç»§æ‰¿é“¾ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼šä½œä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå­ç±»ï¼ˆBï¼‰çš„åŸå‹ï¼ˆ__proto__å±æ€§ï¼‰æ˜¯çˆ¶ç±»ï¼ˆAï¼‰ï¼›ä½œä¸ºä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå­ç±»ï¼ˆBï¼‰çš„åŸå‹ï¼ˆprototypeå±æ€§ï¼‰æ˜¯çˆ¶ç±»çš„å®ä¾‹ã€‚

Object.create(A.prototype);
// ç­‰åŒäº
B.prototype.__proto__ = A.prototype;
Extends çš„ç»§æ‰¿ç›®æ ‡
extendså…³é”®å­—åé¢å¯ä»¥è·Ÿå¤šç§ç±»å‹çš„å€¼ã€‚

class B extends A {
}
ä¸Šé¢ä»£ç çš„Aï¼Œåªè¦æ˜¯ä¸€ä¸ªæœ‰prototypeå±æ€§çš„å‡½æ•°ï¼Œå°±èƒ½è¢«Bç»§æ‰¿ã€‚ç”±äºå‡½æ•°éƒ½æœ‰prototypeå±æ€§ï¼ˆé™¤äº†Function.prototypeå‡½æ•°ï¼‰ï¼Œå› æ­¤Aå¯ä»¥æ˜¯ä»»æ„å‡½æ•°ã€‚

ä¸‹é¢ï¼Œè®¨è®ºä¸‰ç§ç‰¹æ®Šæƒ…å†µã€‚

ç¬¬ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå­ç±»ç»§æ‰¿Objectç±»ã€‚

class A extends Object {
}

A.__proto__ === Object // true
A.prototype.__proto__ === Object.prototype // true
è¿™ç§æƒ…å†µä¸‹ï¼ŒAå…¶å®å°±æ˜¯æ„é€ å‡½æ•°Objectçš„å¤åˆ¶ï¼ŒAçš„å®ä¾‹å°±æ˜¯Objectçš„å®ä¾‹ã€‚

ç¬¬äºŒç§ç‰¹æ®Šæƒ…å†µï¼Œä¸å­˜åœ¨ä»»ä½•ç»§æ‰¿ã€‚

class A {
}

A.__proto__ === Function.prototype // true
A.prototype.__proto__ === Object.prototype // true
è¿™ç§æƒ…å†µä¸‹ï¼ŒAä½œä¸ºä¸€ä¸ªåŸºç±»ï¼ˆå³ä¸å­˜åœ¨ä»»ä½•ç»§æ‰¿ï¼‰ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥ç»§æ‰¿Funciton.prototypeã€‚ä½†æ˜¯ï¼ŒAè°ƒç”¨åè¿”å›ä¸€ä¸ªç©ºå¯¹è±¡ï¼ˆå³Objectå®ä¾‹ï¼‰ï¼Œæ‰€ä»¥A.prototype.__proto__æŒ‡å‘æ„é€ å‡½æ•°ï¼ˆObjectï¼‰çš„prototypeå±æ€§ã€‚

ç¬¬ä¸‰ç§ç‰¹æ®Šæƒ…å†µï¼Œå­ç±»ç»§æ‰¿nullã€‚

class A extends null {
}

A.__proto__ === Function.prototype // true
A.prototype.__proto__ === undefined // true
è¿™ç§æƒ…å†µä¸ç¬¬äºŒç§æƒ…å†µéå¸¸åƒã€‚Aä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥ç»§æ‰¿Funciton.prototypeã€‚ä½†æ˜¯ï¼ŒAè°ƒç”¨åè¿”å›çš„å¯¹è±¡ä¸ç»§æ‰¿ä»»ä½•æ–¹æ³•ï¼Œæ‰€ä»¥å®ƒçš„__proto__æŒ‡å‘Function.prototypeï¼Œå³å®è´¨ä¸Šæ‰§è¡Œäº†ä¸‹é¢çš„ä»£ç ã€‚

class C extends null {
  constructor() { return Object.create(null); }
}
Object.getPrototypeOf()
Object.getPrototypeOfæ–¹æ³•å¯ä»¥ç”¨æ¥ä»å­ç±»ä¸Šè·å–çˆ¶ç±»ã€‚

Object.getPrototypeOf(ColorPoint) === Point
// true
å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•åˆ¤æ–­ï¼Œä¸€ä¸ªç±»æ˜¯å¦ç»§æ‰¿äº†å¦ä¸€ä¸ªç±»ã€‚

super å…³é”®å­—
superè¿™ä¸ªå…³é”®å­—ï¼Œæ—¢å¯ä»¥å½“ä½œå‡½æ•°ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å½“ä½œå¯¹è±¡ä½¿ç”¨ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå®ƒçš„ç”¨æ³•å®Œå…¨ä¸åŒã€‚

ç¬¬ä¸€ç§æƒ…å†µï¼Œsuperä½œä¸ºå‡½æ•°è°ƒç”¨æ—¶ï¼Œä»£è¡¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚ES6 è¦æ±‚ï¼Œå­ç±»çš„æ„é€ å‡½æ•°å¿…é¡»æ‰§è¡Œä¸€æ¬¡superå‡½æ•°ã€‚

class A {}

class B extends A {
  constructor() {
    super();
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå­ç±»Bçš„æ„é€ å‡½æ•°ä¹‹ä¸­çš„super()ï¼Œä»£è¡¨è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ JavaScript å¼•æ“ä¼šæŠ¥é”™ã€‚

æ³¨æ„ï¼Œsuperè™½ç„¶ä»£è¡¨äº†çˆ¶ç±»Açš„æ„é€ å‡½æ•°ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯å­ç±»Bçš„å®ä¾‹ï¼Œå³superå†…éƒ¨çš„thisæŒ‡çš„æ˜¯Bï¼Œå› æ­¤super()åœ¨è¿™é‡Œç›¸å½“äºA.prototype.constructor.call(this)ã€‚

class A {
  constructor() {
    console.log(new.target.name);
  }
}
class B extends A {
  constructor() {
    super();
  }
}
new A() // A
new B() // B
ä¸Šé¢ä»£ç ä¸­ï¼Œnew.targetæŒ‡å‘å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨super()æ‰§è¡Œæ—¶ï¼Œå®ƒæŒ‡å‘çš„æ˜¯å­ç±»Bçš„æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯çˆ¶ç±»Açš„æ„é€ å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsuper()å†…éƒ¨çš„thisæŒ‡å‘çš„æ˜¯Bã€‚

ä½œä¸ºå‡½æ•°æ—¶ï¼Œsuper()åªèƒ½ç”¨åœ¨å­ç±»çš„æ„é€ å‡½æ•°ä¹‹ä¸­ï¼Œç”¨åœ¨å…¶ä»–åœ°æ–¹å°±ä¼šæŠ¥é”™ã€‚

class A {}

class B extends A {
  m() {
    super(); // æŠ¥é”™
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œsuper()ç”¨åœ¨Bç±»çš„mæ–¹æ³•ä¹‹ä¸­ï¼Œå°±ä¼šé€ æˆå¥æ³•é”™è¯¯ã€‚

ç¬¬äºŒç§æƒ…å†µï¼Œsuperä½œä¸ºå¯¹è±¡æ—¶ï¼ŒæŒ‡å‘çˆ¶ç±»çš„åŸå‹å¯¹è±¡ã€‚

class A {
  p() {
    return 2;
  }
}

class B extends A {
  constructor() {
    super();
    console.log(super.p()); // 2
  }
}

let b = new B();
ä¸Šé¢ä»£ç ä¸­ï¼Œå­ç±»Bå½“ä¸­çš„super.p()ï¼Œå°±æ˜¯å°†superå½“ä½œä¸€ä¸ªå¯¹è±¡ä½¿ç”¨ã€‚è¿™æ—¶ï¼ŒsuperæŒ‡å‘A.prototypeï¼Œæ‰€ä»¥super.p()å°±ç›¸å½“äºA.prototype.p()ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œç”±äºsuperæŒ‡å‘çˆ¶ç±»çš„åŸå‹å¯¹è±¡ï¼Œæ‰€ä»¥å®šä¹‰åœ¨çˆ¶ç±»å®ä¾‹ä¸Šçš„æ–¹æ³•æˆ–å±æ€§ï¼Œæ˜¯æ— æ³•é€šè¿‡superè°ƒç”¨çš„ã€‚

class A {
  constructor() {
    this.p = 2;
  }
}

class B extends A {
  get m() {
    return super.p;
  }
}

let b = new B();
b.m // undefined
ä¸Šé¢ä»£ç ä¸­ï¼Œpæ˜¯çˆ¶ç±»Aå®ä¾‹çš„å±æ€§ï¼Œsuper.på°±å¼•ç”¨ä¸åˆ°å®ƒã€‚

å¦‚æœå±æ€§å®šä¹‰åœ¨çˆ¶ç±»çš„åŸå‹å¯¹è±¡ä¸Šï¼Œsuperå°±å¯ä»¥å–åˆ°ã€‚

class A {}
A.prototype.x = 2;

class B extends A {
  constructor() {
    super();
    console.log(super.x) // 2
  }
}

let b = new B();
ä¸Šé¢ä»£ç ä¸­ï¼Œå±æ€§xæ˜¯å®šä¹‰åœ¨A.prototypeä¸Šé¢çš„ï¼Œæ‰€ä»¥super.xå¯ä»¥å–åˆ°å®ƒçš„å€¼ã€‚

ES6 è§„å®šï¼Œé€šè¿‡superè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œsuperä¼šç»‘å®šå­ç±»çš„thisã€‚

class A {
  constructor() {
    this.x = 1;
  }
  print() {
    console.log(this.x);
  }
}

class B extends A {
  constructor() {
    super();
    this.x = 2;
  }
  m() {
    super.print();
  }
}

let b = new B();
b.m() // 2
ä¸Šé¢ä»£ç ä¸­ï¼Œsuper.print()è™½ç„¶è°ƒç”¨çš„æ˜¯A.prototype.print()ï¼Œä½†æ˜¯A.prototype.print()ä¼šç»‘å®šå­ç±»Bçš„thisï¼Œå¯¼è‡´è¾“å‡ºçš„æ˜¯2ï¼Œè€Œä¸æ˜¯1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„æ˜¯super.print.call(this)ã€‚

ç”±äºç»‘å®šå­ç±»çš„thisï¼Œæ‰€ä»¥å¦‚æœé€šè¿‡superå¯¹æŸä¸ªå±æ€§èµ‹å€¼ï¼Œè¿™æ—¶superå°±æ˜¯thisï¼Œèµ‹å€¼çš„å±æ€§ä¼šå˜æˆå­ç±»å®ä¾‹çš„å±æ€§ã€‚

class A {
  constructor() {
    this.x = 1;
  }
}

class B extends A {
  constructor() {
    super();
    this.x = 2;
    super.x = 3;
    console.log(super.x); // undefined
    console.log(this.x); // 3
  }
}

let b = new B();
ä¸Šé¢ä»£ç ä¸­ï¼Œsuper.xèµ‹å€¼ä¸º3ï¼Œè¿™æ—¶ç­‰åŒäºå¯¹this.xèµ‹å€¼ä¸º3ã€‚è€Œå½“è¯»å–super.xçš„æ—¶å€™ï¼Œè¯»çš„æ˜¯A.prototype.xï¼Œæ‰€ä»¥è¿”å›undefinedã€‚

æ³¨æ„ï¼Œä½¿ç”¨superçš„æ—¶å€™ï¼Œå¿…é¡»æ˜¾å¼æŒ‡å®šæ˜¯ä½œä¸ºå‡½æ•°ã€è¿˜æ˜¯ä½œä¸ºå¯¹è±¡ä½¿ç”¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

class A {}

class B extends A {
  constructor() {
    super();
    console.log(super); // æŠ¥é”™
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œconsole.log(super)å½“ä¸­çš„superï¼Œæ— æ³•çœ‹å‡ºæ˜¯ä½œä¸ºå‡½æ•°ä½¿ç”¨ï¼Œè¿˜æ˜¯ä½œä¸ºå¯¹è±¡ä½¿ç”¨ï¼Œæ‰€ä»¥ JavaScript å¼•æ“è§£æä»£ç çš„æ—¶å€™å°±ä¼šæŠ¥é”™ã€‚è¿™æ—¶ï¼Œå¦‚æœèƒ½æ¸…æ™°åœ°è¡¨æ˜superçš„æ•°æ®ç±»å‹ï¼Œå°±ä¸ä¼šæŠ¥é”™ã€‚

class A {}

class B extends A {
  constructor() {
    super();
    console.log(super.valueOf() instanceof B); // true
  }
}

let b = new B();
ä¸Šé¢ä»£ç ä¸­ï¼Œsuper.valueOf()è¡¨æ˜superæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤å°±ä¸ä¼šæŠ¥é”™ã€‚åŒæ—¶ï¼Œç”±äºsuperç»‘å®šBçš„thisï¼Œæ‰€ä»¥super.valueOf()è¿”å›çš„æ˜¯ä¸€ä¸ªBçš„å®ä¾‹ã€‚

æœ€åï¼Œç”±äºå¯¹è±¡æ€»æ˜¯ç»§æ‰¿å…¶ä»–å¯¹è±¡çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œä½¿ç”¨superå…³é”®å­—ã€‚

var obj = {
  toString() {
    return "MyObject: " + super.toString();
  }
};

obj.toString(); // MyObject: [object Object]
å®ä¾‹çš„__proto__å±æ€§
å­ç±»å®ä¾‹çš„__proto__å±æ€§çš„__proto__å±æ€§ï¼ŒæŒ‡å‘çˆ¶ç±»å®ä¾‹çš„__proto__å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­ç±»çš„åŸå‹çš„åŸå‹ï¼Œæ˜¯çˆ¶ç±»çš„åŸå‹ã€‚

var p1 = new Point(2, 3);
var p2 = new ColorPoint(2, 3, 'red');

p2.__proto__ === p1.__proto__ // false
p2.__proto__.__proto__ === p1.__proto__ // true
ä¸Šé¢ä»£ç ä¸­ï¼ŒColorPointç»§æ‰¿äº†Pointï¼Œå¯¼è‡´å‰è€…åŸå‹çš„åŸå‹æ˜¯åè€…çš„åŸå‹ã€‚

å› æ­¤ï¼Œé€šè¿‡å­ç±»å®ä¾‹çš„__proto__.__proto__å±æ€§ï¼Œå¯ä»¥ä¿®æ”¹çˆ¶ç±»å®ä¾‹çš„è¡Œä¸ºã€‚

p2.__proto__.__proto__.printName = function () {
  console.log('Ha');
};

p1.printName() // "Ha"
ä¸Šé¢ä»£ç åœ¨ColorPointçš„å®ä¾‹p2ä¸Šå‘Pointç±»æ·»åŠ æ–¹æ³•ï¼Œç»“æœå½±å“åˆ°äº†Pointçš„å®ä¾‹p1ã€‚

åŸç”Ÿæ„é€ å‡½æ•°çš„ç»§æ‰¿
åŸç”Ÿæ„é€ å‡½æ•°æ˜¯æŒ‡è¯­è¨€å†…ç½®çš„æ„é€ å‡½æ•°ï¼Œé€šå¸¸ç”¨æ¥ç”Ÿæˆæ•°æ®ç»“æ„ã€‚ECMAScriptçš„åŸç”Ÿæ„é€ å‡½æ•°å¤§è‡´æœ‰ä¸‹é¢è¿™äº›ã€‚

Boolean()
Number()
String()
Array()
Date()
Function()
RegExp()
Error()
Object()
ä»¥å‰ï¼Œè¿™äº›åŸç”Ÿæ„é€ å‡½æ•°æ˜¯æ— æ³•ç»§æ‰¿çš„ï¼Œæ¯”å¦‚ï¼Œä¸èƒ½è‡ªå·±å®šä¹‰ä¸€ä¸ªArrayçš„å­ç±»ã€‚

function MyArray() {
  Array.apply(this, arguments);
}

MyArray.prototype = Object.create(Array.prototype, {
  constructor: {
    value: MyArray,
    writable: true,
    configurable: true,
    enumerable: true
  }
});
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿Arrayçš„MyArrayç±»ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªç±»çš„è¡Œä¸ºä¸Arrayå®Œå…¨ä¸ä¸€è‡´ã€‚

var colors = new MyArray();
colors[0] = "red";
colors.length  // 0

colors.length = 0;
colors[0]  // "red"
ä¹‹æ‰€ä»¥ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œæ˜¯å› ä¸ºå­ç±»æ— æ³•è·å¾—åŸç”Ÿæ„é€ å‡½æ•°çš„å†…éƒ¨å±æ€§ï¼Œé€šè¿‡Array.apply()æˆ–è€…åˆ†é…ç»™åŸå‹å¯¹è±¡éƒ½ä¸è¡Œã€‚åŸç”Ÿæ„é€ å‡½æ•°ä¼šå¿½ç•¥applyæ–¹æ³•ä¼ å…¥çš„thisï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸç”Ÿæ„é€ å‡½æ•°çš„thisæ— æ³•ç»‘å®šï¼Œå¯¼è‡´æ‹¿ä¸åˆ°å†…éƒ¨å±æ€§ã€‚

ES5æ˜¯å…ˆæ–°å»ºå­ç±»çš„å®ä¾‹å¯¹è±¡thisï¼Œå†å°†çˆ¶ç±»çš„å±æ€§æ·»åŠ åˆ°å­ç±»ä¸Šï¼Œç”±äºçˆ¶ç±»çš„å†…éƒ¨å±æ€§æ— æ³•è·å–ï¼Œå¯¼è‡´æ— æ³•ç»§æ‰¿åŸç”Ÿçš„æ„é€ å‡½æ•°ã€‚æ¯”å¦‚ï¼ŒArrayæ„é€ å‡½æ•°æœ‰ä¸€ä¸ªå†…éƒ¨å±æ€§[[DefineOwnProperty]]ï¼Œç”¨æ¥å®šä¹‰æ–°å±æ€§æ—¶ï¼Œæ›´æ–°lengthå±æ€§ï¼Œè¿™ä¸ªå†…éƒ¨å±æ€§æ— æ³•åœ¨å­ç±»è·å–ï¼Œå¯¼è‡´å­ç±»çš„lengthå±æ€§è¡Œä¸ºä¸æ­£å¸¸ã€‚

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æƒ³è®©ä¸€ä¸ªæ™®é€šå¯¹è±¡ç»§æ‰¿Errorå¯¹è±¡ã€‚

var e = {};

Object.getOwnPropertyNames(Error.call(e))
// [ 'stack' ]

Object.getOwnPropertyNames(e)
// []
ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡Error.call(e)è¿™ç§å†™æ³•ï¼Œè®©æ™®é€šå¯¹è±¡eå…·æœ‰Errorå¯¹è±¡çš„å®ä¾‹å±æ€§ã€‚ä½†æ˜¯ï¼ŒError.call()å®Œå…¨å¿½ç•¥ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œeæœ¬èº«æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚è¿™è¯æ˜äº†Error.call(e)è¿™ç§å†™æ³•ï¼Œæ— æ³•ç»§æ‰¿åŸç”Ÿæ„é€ å‡½æ•°ã€‚

ES6å…è®¸ç»§æ‰¿åŸç”Ÿæ„é€ å‡½æ•°å®šä¹‰å­ç±»ï¼Œå› ä¸ºES6æ˜¯å…ˆæ–°å»ºçˆ¶ç±»çš„å®ä¾‹å¯¹è±¡thisï¼Œç„¶åå†ç”¨å­ç±»çš„æ„é€ å‡½æ•°ä¿®é¥°thisï¼Œä½¿å¾—çˆ¶ç±»çš„æ‰€æœ‰è¡Œä¸ºéƒ½å¯ä»¥ç»§æ‰¿ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç»§æ‰¿Arrayçš„ä¾‹å­ã€‚

class MyArray extends Array {
  constructor(...args) {
    super(...args);
  }
}

var arr = new MyArray();
arr[0] = 12;
arr.length // 1

arr.length = 0;
arr[0] // undefined
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªMyArrayç±»ï¼Œç»§æ‰¿äº†Arrayæ„é€ å‡½æ•°ï¼Œå› æ­¤å°±å¯ä»¥ä»MyArrayç”Ÿæˆæ•°ç»„çš„å®ä¾‹ã€‚è¿™æ„å‘³ç€ï¼ŒES6å¯ä»¥è‡ªå®šä¹‰åŸç”Ÿæ•°æ®ç»“æ„ï¼ˆæ¯”å¦‚Arrayã€Stringç­‰ï¼‰çš„å­ç±»ï¼Œè¿™æ˜¯ES5æ— æ³•åšåˆ°çš„ã€‚

ä¸Šé¢è¿™ä¸ªä¾‹å­ä¹Ÿè¯´æ˜ï¼Œextendså…³é”®å­—ä¸ä»…å¯ä»¥ç”¨æ¥ç»§æ‰¿ç±»ï¼Œè¿˜å¯ä»¥ç”¨æ¥ç»§æ‰¿åŸç”Ÿçš„æ„é€ å‡½æ•°ã€‚å› æ­¤å¯ä»¥åœ¨åŸç”Ÿæ•°æ®ç»“æ„çš„åŸºç¡€ä¸Šï¼Œå®šä¹‰è‡ªå·±çš„æ•°æ®ç»“æ„ã€‚ä¸‹é¢å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªå¸¦ç‰ˆæœ¬åŠŸèƒ½çš„æ•°ç»„ã€‚

class VersionedArray extends Array {
  constructor() {
    super();
    this.history = [[]];
  }
  commit() {
    this.history.push(this.slice());
  }
  revert() {
    this.splice(0, this.length, ...this.history[this.history.length - 1]);
  }
}

var x = new VersionedArray();

x.push(1);
x.push(2);
x // [1, 2]
x.history // [[]]

x.commit();
x.history // [[], [1, 2]]
x.push(3);
x // [1, 2, 3]

x.revert();
x // [1, 2]
ä¸Šé¢ä»£ç ä¸­ï¼ŒVersionedArrayç»“æ„ä¼šé€šè¿‡commitæ–¹æ³•ï¼Œå°†è‡ªå·±çš„å½“å‰çŠ¶æ€å­˜å…¥historyå±æ€§ï¼Œç„¶åé€šè¿‡revertæ–¹æ³•ï¼Œå¯ä»¥æ’¤é”€å½“å‰ç‰ˆæœ¬ï¼Œå›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒVersionedArrayä¾ç„¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰åŸç”Ÿçš„æ•°ç»„æ–¹æ³•éƒ½å¯ä»¥åœ¨å®ƒä¸Šé¢è°ƒç”¨ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰Errorå­ç±»çš„ä¾‹å­ã€‚

class ExtendableError extends Error {
  constructor(message) {
    super();
    this.message = message;
    this.stack = (new Error()).stack;
    this.name = this.constructor.name;
  }
}

class MyError extends ExtendableError {
  constructor(m) {
    super(m);
  }
}

var myerror = new MyError('ll');
myerror.message // "ll"
myerror instanceof Error // true
myerror.name // "MyError"
myerror.stack
// Error
//     at MyError.ExtendableError
//     ...
æ³¨æ„ï¼Œç»§æ‰¿Objectçš„å­ç±»ï¼Œæœ‰ä¸€ä¸ªè¡Œä¸ºå·®å¼‚ã€‚

class NewObj extends Object{
  constructor(){
    super(...arguments);
  }
}
var o = new NewObj({attr: true});
console.log(o.attr === true);  // false
ä¸Šé¢ä»£ç ä¸­ï¼ŒNewObjç»§æ‰¿äº†Objectï¼Œä½†æ˜¯æ— æ³•é€šè¿‡superæ–¹æ³•å‘çˆ¶ç±»Objectä¼ å‚ã€‚è¿™æ˜¯å› ä¸ºES6æ”¹å˜äº†Objectæ„é€ å‡½æ•°çš„è¡Œä¸ºï¼Œä¸€æ—¦å‘ç°Objectæ–¹æ³•ä¸æ˜¯é€šè¿‡new Object()è¿™ç§å½¢å¼è°ƒç”¨ï¼ŒES6è§„å®šObjectæ„é€ å‡½æ•°ä¼šå¿½ç•¥å‚æ•°ã€‚

Classçš„å–å€¼å‡½æ•°ï¼ˆgetterï¼‰å’Œå­˜å€¼å‡½æ•°ï¼ˆsetterï¼‰
ä¸ES5ä¸€æ ·ï¼Œåœ¨Classå†…éƒ¨å¯ä»¥ä½¿ç”¨getå’Œsetå…³é”®å­—ï¼Œå¯¹æŸä¸ªå±æ€§è®¾ç½®å­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°ï¼Œæ‹¦æˆªè¯¥å±æ€§çš„å­˜å–è¡Œä¸ºã€‚

class MyClass {
  constructor() {
    // ...
  }
  get prop() {
    return 'getter';
  }
  set prop(value) {
    console.log('setter: '+value);
  }
}

let inst = new MyClass();

inst.prop = 123;
// setter: 123

inst.prop
// 'getter'
ä¸Šé¢ä»£ç ä¸­ï¼Œpropå±æ€§æœ‰å¯¹åº”çš„å­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°ï¼Œå› æ­¤èµ‹å€¼å’Œè¯»å–è¡Œä¸ºéƒ½è¢«è‡ªå®šä¹‰äº†ã€‚

å­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°æ˜¯è®¾ç½®åœ¨å±æ€§çš„descriptorå¯¹è±¡ä¸Šçš„ã€‚

class CustomHTMLElement {
  constructor(element) {
    this.element = element;
  }

  get html() {
    return this.element.innerHTML;
  }

  set html(value) {
    this.element.innerHTML = value;
  }
}

var descriptor = Object.getOwnPropertyDescriptor(
  CustomHTMLElement.prototype, "html");
"get" in descriptor  // true
"set" in descriptor  // true
ä¸Šé¢ä»£ç ä¸­ï¼Œå­˜å€¼å‡½æ•°å’Œå–å€¼å‡½æ•°æ˜¯å®šä¹‰åœ¨htmlå±æ€§çš„æè¿°å¯¹è±¡ä¸Šé¢ï¼Œè¿™ä¸ES5å®Œå…¨ä¸€è‡´ã€‚

Classçš„Generatoræ–¹æ³•
å¦‚æœæŸä¸ªæ–¹æ³•ä¹‹å‰åŠ ä¸Šæ˜Ÿå·ï¼ˆ*ï¼‰ï¼Œå°±è¡¨ç¤ºè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ã€‚

class Foo {
  constructor(...args) {
    this.args = args;
  }
  * [Symbol.iterator]() {
    for (let arg of this.args) {
      yield arg;
    }
  }
}

for (let x of new Foo('hello', 'world')) {
  console.log(x);
}
// hello
// world
ä¸Šé¢ä»£ç ä¸­ï¼ŒFooç±»çš„Symbol.iteratoræ–¹æ³•å‰æœ‰ä¸€ä¸ªæ˜Ÿå·ï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªGeneratorå‡½æ•°ã€‚Symbol.iteratoræ–¹æ³•è¿”å›ä¸€ä¸ªFooç±»çš„é»˜è®¤éå†å™¨ï¼Œfor...ofå¾ªç¯ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªéå†å™¨ã€‚

Classçš„é™æ€æ–¹æ³•
ç±»ç›¸å½“äºå®ä¾‹çš„åŸå‹ï¼Œæ‰€æœ‰åœ¨ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œéƒ½ä¼šè¢«å®ä¾‹ç»§æ‰¿ã€‚å¦‚æœåœ¨ä¸€ä¸ªæ–¹æ³•å‰ï¼ŒåŠ ä¸Šstaticå…³é”®å­—ï¼Œå°±è¡¨ç¤ºè¯¥æ–¹æ³•ä¸ä¼šè¢«å®ä¾‹ç»§æ‰¿ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ç±»æ¥è°ƒç”¨ï¼Œè¿™å°±ç§°ä¸ºâ€œé™æ€æ–¹æ³•â€ã€‚

class Foo {
  static classMethod() {
    return 'hello';
  }
}

Foo.classMethod() // 'hello'

var foo = new Foo();
foo.classMethod()
// TypeError: foo.classMethod is not a function
ä¸Šé¢ä»£ç ä¸­ï¼ŒFooç±»çš„classMethodæ–¹æ³•å‰æœ‰staticå…³é”®å­—ï¼Œè¡¨æ˜è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥åœ¨Fooç±»ä¸Šè°ƒç”¨ï¼ˆFoo.classMethod()ï¼‰ï¼Œè€Œä¸æ˜¯åœ¨Fooç±»çš„å®ä¾‹ä¸Šè°ƒç”¨ã€‚å¦‚æœåœ¨å®ä¾‹ä¸Šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¡¨ç¤ºä¸å­˜åœ¨è¯¥æ–¹æ³•ã€‚

çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œå¯ä»¥è¢«å­ç±»ç»§æ‰¿ã€‚

class Foo {
  static classMethod() {
    return 'hello';
  }
}

class Bar extends Foo {
}

Bar.classMethod(); // 'hello'
ä¸Šé¢ä»£ç ä¸­ï¼Œçˆ¶ç±»Fooæœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå­ç±»Barå¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚

é™æ€æ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥ä»superå¯¹è±¡ä¸Šè°ƒç”¨çš„ã€‚

class Foo {
  static classMethod() {
    return 'hello';
  }
}

class Bar extends Foo {
  static classMethod() {
    return super.classMethod() + ', too';
  }
}

Bar.classMethod();
Classçš„é™æ€å±æ€§å’Œå®ä¾‹å±æ€§
é™æ€å±æ€§æŒ‡çš„æ˜¯Classæœ¬èº«çš„å±æ€§ï¼Œå³Class.propnameï¼Œè€Œä¸æ˜¯å®šä¹‰åœ¨å®ä¾‹å¯¹è±¡ï¼ˆthisï¼‰ä¸Šçš„å±æ€§ã€‚

class Foo {
}

Foo.prop = 1;
Foo.prop // 1
ä¸Šé¢çš„å†™æ³•ä¸ºFooç±»å®šä¹‰äº†ä¸€ä¸ªé™æ€å±æ€§propã€‚

ç›®å‰ï¼Œåªæœ‰è¿™ç§å†™æ³•å¯è¡Œï¼Œå› ä¸ºES6æ˜ç¡®è§„å®šï¼ŒClasså†…éƒ¨åªæœ‰é™æ€æ–¹æ³•ï¼Œæ²¡æœ‰é™æ€å±æ€§ã€‚

// ä»¥ä¸‹ä¸¤ç§å†™æ³•éƒ½æ— æ•ˆ
class Foo {
  // å†™æ³•ä¸€
  prop: 2

  // å†™æ³•äºŒ
  static prop: 2
}

Foo.prop // undefined
ES7æœ‰ä¸€ä¸ªé™æ€å±æ€§çš„ææ¡ˆï¼Œç›®å‰Babelè½¬ç å™¨æ”¯æŒã€‚

è¿™ä¸ªææ¡ˆå¯¹å®ä¾‹å±æ€§å’Œé™æ€å±æ€§ï¼Œéƒ½è§„å®šäº†æ–°çš„å†™æ³•ã€‚

ï¼ˆ1ï¼‰ç±»çš„å®ä¾‹å±æ€§

ç±»çš„å®ä¾‹å±æ€§å¯ä»¥ç”¨ç­‰å¼ï¼Œå†™å…¥ç±»çš„å®šä¹‰ä¹‹ä¸­ã€‚

class MyClass {
  myProp = 42;

  constructor() {
    console.log(this.myProp); // 42
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒmyPropå°±æ˜¯MyClassçš„å®ä¾‹å±æ€§ã€‚åœ¨MyClassçš„å®ä¾‹ä¸Šï¼Œå¯ä»¥è¯»å–è¿™ä¸ªå±æ€§ã€‚

ä»¥å‰ï¼Œæˆ‘ä»¬å®šä¹‰å®ä¾‹å±æ€§ï¼Œåªèƒ½å†™åœ¨ç±»çš„constructoræ–¹æ³•é‡Œé¢ã€‚

class ReactCounter extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      count: 0
    };
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œæ„é€ æ–¹æ³•constructoré‡Œé¢ï¼Œå®šä¹‰äº†this.stateå±æ€§ã€‚

æœ‰äº†æ–°çš„å†™æ³•ä»¥åï¼Œå¯ä»¥ä¸åœ¨constructoræ–¹æ³•é‡Œé¢å®šä¹‰ã€‚

class ReactCounter extends React.Component {
  state = {
    count: 0
  };
}
è¿™ç§å†™æ³•æ¯”ä»¥å‰æ›´æ¸…æ™°ã€‚

ä¸ºäº†å¯è¯»æ€§çš„ç›®çš„ï¼Œå¯¹äºé‚£äº›åœ¨constructoré‡Œé¢å·²ç»å®šä¹‰çš„å®ä¾‹å±æ€§ï¼Œæ–°å†™æ³•å…è®¸ç›´æ¥åˆ—å‡ºã€‚

class ReactCounter extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      count: 0
    };
  }
  state;
}
ï¼ˆ2ï¼‰ç±»çš„é™æ€å±æ€§

ç±»çš„é™æ€å±æ€§åªè¦åœ¨ä¸Šé¢çš„å®ä¾‹å±æ€§å†™æ³•å‰é¢ï¼ŒåŠ ä¸Šstaticå…³é”®å­—å°±å¯ä»¥äº†ã€‚

class MyClass {
  static myStaticProp = 42;

  constructor() {
    console.log(MyClass.myProp); // 42
  }
}
åŒæ ·çš„ï¼Œè¿™ä¸ªæ–°å†™æ³•å¤§å¤§æ–¹ä¾¿äº†é™æ€å±æ€§çš„è¡¨è¾¾ã€‚

// è€å†™æ³•
class Foo {
}
Foo.prop = 1;

// æ–°å†™æ³•
class Foo {
  static prop = 1;
}
ä¸Šé¢ä»£ç ä¸­ï¼Œè€å†™æ³•çš„é™æ€å±æ€§å®šä¹‰åœ¨ç±»çš„å¤–éƒ¨ã€‚æ•´ä¸ªç±»ç”Ÿæˆä»¥åï¼Œå†ç”Ÿæˆé™æ€å±æ€§ã€‚è¿™æ ·è®©äººå¾ˆå®¹æ˜“å¿½ç•¥è¿™ä¸ªé™æ€å±æ€§ï¼Œä¹Ÿä¸ç¬¦åˆç›¸å…³ä»£ç åº”è¯¥æ”¾åœ¨ä¸€èµ·çš„ä»£ç ç»„ç»‡åŸåˆ™ã€‚å¦å¤–ï¼Œæ–°å†™æ³•æ˜¯æ˜¾å¼å£°æ˜ï¼ˆdeclarativeï¼‰ï¼Œè€Œä¸æ˜¯èµ‹å€¼å¤„ç†ï¼Œè¯­ä¹‰æ›´å¥½ã€‚

new.targetå±æ€§
newæ˜¯ä»æ„é€ å‡½æ•°ç”Ÿæˆå®ä¾‹çš„å‘½ä»¤ã€‚ES6ä¸ºnewå‘½ä»¤å¼•å…¥äº†ä¸€ä¸ªnew.targetå±æ€§ï¼Œï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­ï¼‰è¿”å›newå‘½ä»¤ä½œç”¨äºçš„é‚£ä¸ªæ„é€ å‡½æ•°ã€‚å¦‚æœæ„é€ å‡½æ•°ä¸æ˜¯é€šè¿‡newå‘½ä»¤è°ƒç”¨çš„ï¼Œnew.targetä¼šè¿”å›undefinedï¼Œå› æ­¤è¿™ä¸ªå±æ€§å¯ä»¥ç”¨æ¥ç¡®å®šæ„é€ å‡½æ•°æ˜¯æ€ä¹ˆè°ƒç”¨çš„ã€‚

function Person(name) {
  if (new.target !== undefined) {
    this.name = name;
  } else {
    throw new Error('å¿…é¡»ä½¿ç”¨newç”Ÿæˆå®ä¾‹');
  }
}

// å¦ä¸€ç§å†™æ³•
function Person(name) {
  if (new.target === Person) {
    this.name = name;
  } else {
    throw new Error('å¿…é¡»ä½¿ç”¨newç”Ÿæˆå®ä¾‹');
  }
}

var person = new Person('å¼ ä¸‰'); // æ­£ç¡®
var notAPerson = Person.call(person, 'å¼ ä¸‰');  // æŠ¥é”™
ä¸Šé¢ä»£ç ç¡®ä¿æ„é€ å‡½æ•°åªèƒ½é€šè¿‡newå‘½ä»¤è°ƒç”¨ã€‚

Classå†…éƒ¨è°ƒç”¨new.targetï¼Œè¿”å›å½“å‰Classã€‚

class Rectangle {
  constructor(length, width) {
    console.log(new.target === Rectangle);
    this.length = length;
    this.width = width;
  }
}

var obj = new Rectangle(3, 4); // è¾“å‡º true
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶ï¼Œnew.targetä¼šè¿”å›å­ç±»ã€‚

class Rectangle {
  constructor(length, width) {
    console.log(new.target === Rectangle);
    // ...
  }
}

class Square extends Rectangle {
  constructor(length) {
    super(length, length);
  }
}

var obj = new Square(3); // è¾“å‡º false
ä¸Šé¢ä»£ç ä¸­ï¼Œnew.targetä¼šè¿”å›å­ç±»ã€‚

åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹ï¼Œå¯ä»¥å†™å‡ºä¸èƒ½ç‹¬ç«‹ä½¿ç”¨ã€å¿…é¡»ç»§æ‰¿åæ‰èƒ½ä½¿ç”¨çš„ç±»ã€‚

class Shape {
  constructor() {
    if (new.target === Shape) {
      throw new Error('æœ¬ç±»ä¸èƒ½å®ä¾‹åŒ–');
    }
  }
}

class Rectangle extends Shape {
  constructor(length, width) {
    super();
    // ...
  }
}

var x = new Shape();  // æŠ¥é”™
var y = new Rectangle(3, 4);  // æ­£ç¡®
ä¸Šé¢ä»£ç ä¸­ï¼ŒShapeç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œåªèƒ½ç”¨äºç»§æ‰¿ã€‚

æ³¨æ„ï¼Œåœ¨å‡½æ•°å¤–éƒ¨ï¼Œä½¿ç”¨new.targetä¼šæŠ¥é”™ã€‚

Mixinæ¨¡å¼çš„å®ç°
Mixinæ¨¡å¼æŒ‡çš„æ˜¯ï¼Œå°†å¤šä¸ªç±»çš„æ¥å£â€œæ··å…¥â€ï¼ˆmix inï¼‰å¦ä¸€ä¸ªç±»ã€‚å®ƒåœ¨ES6çš„å®ç°å¦‚ä¸‹ã€‚

function mix(...mixins) {
  class Mix {}

  for (let mixin of mixins) {
    copyProperties(Mix, mixin);
    copyProperties(Mix.prototype, mixin.prototype);
  }

  return Mix;
}

function copyProperties(target, source) {
  for (let key of Reflect.ownKeys(source)) {
    if ( key !== "constructor"
      && key !== "prototype"
      && key !== "name"
    ) {
      let desc = Object.getOwnPropertyDescriptor(source, key);
      Object.defineProperty(target, key, desc);
    }
  }
}
ä¸Šé¢ä»£ç çš„mixå‡½æ•°ï¼Œå¯ä»¥å°†å¤šä¸ªå¯¹è±¡åˆæˆä¸ºä¸€ä¸ªç±»ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œåªè¦ç»§æ‰¿è¿™ä¸ªç±»å³å¯ã€‚

class DistributedEdit extends mix(Loggable, Serializable) {
  // ...
}

##ä¿®é¥°å™¨
1.ç±»çš„ä¿®é¥°
ä¿®é¥°å™¨ï¼ˆDecoratorï¼‰æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥ä¿®æ”¹ç±»çš„è¡Œä¸ºã€‚è¿™æ˜¯ES7çš„ä¸€ä¸ªææ¡ˆï¼Œç›®å‰Babelè½¬ç å™¨å·²ç»æ”¯æŒã€‚

ä¿®é¥°å™¨å¯¹ç±»çš„è¡Œä¸ºçš„æ”¹å˜ï¼Œæ˜¯ä»£ç ç¼–è¯‘æ—¶å‘ç”Ÿçš„ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ã€‚è¿™æ„å‘³ç€ï¼Œä¿®é¥°å™¨èƒ½åœ¨ç¼–è¯‘é˜¶æ®µè¿è¡Œä»£ç ã€‚

function testable(target) {
  target.isTestable = true;
}

@testable
class MyTestableClass {}

console.log(MyTestableClass.isTestable) // true
ä¸Šé¢ä»£ç ä¸­ï¼Œ@testableå°±æ˜¯ä¸€ä¸ªä¿®é¥°å™¨ã€‚å®ƒä¿®æ”¹äº†MyTestableClassè¿™ä¸ªç±»çš„è¡Œä¸ºï¼Œä¸ºå®ƒåŠ ä¸Šäº†é™æ€å±æ€§isTestableã€‚

åŸºæœ¬ä¸Šï¼Œä¿®é¥°å™¨çš„è¡Œä¸ºå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚

@decorator
class A {}

// ç­‰åŒäº

class A {}
A = decorator(A) || A;
ä¹Ÿå°±æ˜¯è¯´ï¼Œä¿®é¥°å™¨æœ¬è´¨å°±æ˜¯ç¼–è¯‘æ—¶æ‰§è¡Œçš„å‡½æ•°ã€‚

ä¿®é¥°å™¨å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯æ‰€è¦ä¿®é¥°çš„ç›®æ ‡ç±»ã€‚

function testable(target) {
  // ...
}
ä¸Šé¢ä»£ç ä¸­ï¼Œtestableå‡½æ•°çš„å‚æ•°targetï¼Œå°±æ˜¯ä¼šè¢«ä¿®é¥°çš„ç±»ã€‚

å¦‚æœè§‰å¾—ä¸€ä¸ªå‚æ•°ä¸å¤Ÿç”¨ï¼Œå¯ä»¥åœ¨ä¿®é¥°å™¨å¤–é¢å†å°è£…ä¸€å±‚å‡½æ•°ã€‚

function testable(isTestable) {
  return function(target) {
    target.isTestable = isTestable;
  }
}

@testable(true)
class MyTestableClass {}
MyTestableClass.isTestable // true

@testable(false)
class MyClass {}
MyClass.isTestable // false
ä¸Šé¢ä»£ç ä¸­ï¼Œä¿®é¥°å™¨testableå¯ä»¥æ¥å—å‚æ•°ï¼Œè¿™å°±ç­‰äºå¯ä»¥ä¿®æ”¹ä¿®é¥°å™¨çš„è¡Œä¸ºã€‚

å‰é¢çš„ä¾‹å­æ˜¯ä¸ºç±»æ·»åŠ ä¸€ä¸ªé™æ€å±æ€§ï¼Œå¦‚æœæƒ³æ·»åŠ å®ä¾‹å±æ€§ï¼Œå¯ä»¥é€šè¿‡ç›®æ ‡ç±»çš„prototypeå¯¹è±¡æ“ä½œã€‚

function testable(target) {
  target.prototype.isTestable = true;
}

@testable
class MyTestableClass {}

let obj = new MyTestableClass();
obj.isTestable // true
ä¸Šé¢ä»£ç ä¸­ï¼Œä¿®é¥°å™¨å‡½æ•°testableæ˜¯åœ¨ç›®æ ‡ç±»çš„prototypeå¯¹è±¡ä¸Šæ·»åŠ å±æ€§ï¼Œå› æ­¤å°±å¯ä»¥åœ¨å®ä¾‹ä¸Šè°ƒç”¨ã€‚

ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªä¾‹å­ã€‚

// mixins.js
export function mixins(...list) {
  return function (target) {
    Object.assign(target.prototype, ...list)
  }
}

// main.js
import { mixins } from './mixins'

const Foo = {
  foo() { console.log('foo') }
};

@mixins(Foo)
class MyClass {}

let obj = new MyClass();
obj.foo() // 'foo'
ä¸Šé¢ä»£ç é€šè¿‡ä¿®é¥°å™¨mixinsï¼ŒæŠŠFooç±»çš„æ–¹æ³•æ·»åŠ åˆ°äº†MyClassçš„å®ä¾‹ä¸Šé¢ã€‚å¯ä»¥ç”¨Object.assign()æ¨¡æ‹Ÿè¿™ä¸ªåŠŸèƒ½ã€‚

const Foo = {
  foo() { console.log('foo') }
};

class MyClass {}

Object.assign(MyClass.prototype, Foo);

let obj = new MyClass();
obj.foo() // 'foo'
æ–¹æ³•çš„ä¿®é¥°
ä¿®é¥°å™¨ä¸ä»…å¯ä»¥ä¿®é¥°ç±»ï¼Œè¿˜å¯ä»¥ä¿®é¥°ç±»çš„å±æ€§ã€‚

class Person {
  @readonly
  name() { return `${this.first} ${this.last}` }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œä¿®é¥°å™¨readonlyç”¨æ¥ä¿®é¥°â€œç±»â€çš„nameæ–¹æ³•ã€‚

æ­¤æ—¶ï¼Œä¿®é¥°å™¨å‡½æ•°ä¸€å…±å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰€è¦ä¿®é¥°çš„ç›®æ ‡å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰€è¦ä¿®é¥°çš„å±æ€§åï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è¯¥å±æ€§çš„æè¿°å¯¹è±¡ã€‚

function readonly(target, name, descriptor){
  // descriptorå¯¹è±¡åŸæ¥çš„å€¼å¦‚ä¸‹
  // {
  //   value: specifiedFunction,
  //   enumerable: false,
  //   configurable: true,
  //   writable: true
  // };
  descriptor.writable = false;
  return descriptor;
}

readonly(Person.prototype, 'name', descriptor);
// ç±»ä¼¼äº
Object.defineProperty(Person.prototype, 'name', descriptor);
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œä¿®é¥°å™¨ï¼ˆreadonlyï¼‰ä¼šä¿®æ”¹å±æ€§çš„æè¿°å¯¹è±¡ï¼ˆdescriptorï¼‰ï¼Œç„¶åè¢«ä¿®æ”¹çš„æè¿°å¯¹è±¡å†ç”¨æ¥å®šä¹‰å±æ€§ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ï¼Œä¿®æ”¹å±æ€§æè¿°å¯¹è±¡çš„enumerableå±æ€§ï¼Œä½¿å¾—è¯¥å±æ€§ä¸å¯éå†ã€‚

class Person {
  @nonenumerable
  get kidCount() { return this.children.length; }
}

function nonenumerable(target, name, descriptor) {
  descriptor.enumerable = false;
  return descriptor;
}
ä¸‹é¢çš„@logä¿®é¥°å™¨ï¼Œå¯ä»¥èµ·åˆ°è¾“å‡ºæ—¥å¿—çš„ä½œç”¨ã€‚

class Math {
  @log
  add(a, b) {
    return a + b;
  }
}

function log(target, name, descriptor) {
  var oldValue = descriptor.value;

  descriptor.value = function() {
    console.log(`Calling "${name}" with`, arguments);
    return oldValue.apply(null, arguments);
  };

  return descriptor;
}

const math = new Math();

// passed parameters should get logged now
math.add(2, 4);
ä¸Šé¢ä»£ç ä¸­ï¼Œ@logä¿®é¥°å™¨çš„ä½œç”¨å°±æ˜¯åœ¨æ‰§è¡ŒåŸå§‹çš„æ“ä½œä¹‹å‰ï¼Œæ‰§è¡Œä¸€æ¬¡console.logï¼Œä»è€Œè¾¾åˆ°è¾“å‡ºæ—¥å¿—çš„ç›®çš„ã€‚

ä¿®é¥°å™¨æœ‰æ³¨é‡Šçš„ä½œç”¨ã€‚

@testable
class Person {
  @readonly
  @nonenumerable
  name() { return `${this.first} ${this.last}` }
}
ä»ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±èƒ½çœ‹å‡ºï¼ŒPersonç±»æ˜¯å¯æµ‹è¯•çš„ï¼Œè€Œnameæ–¹æ³•æ˜¯åªè¯»å’Œä¸å¯æšä¸¾çš„ã€‚

å¦‚æœåŒä¸€ä¸ªæ–¹æ³•æœ‰å¤šä¸ªä¿®é¥°å™¨ï¼Œä¼šåƒå‰¥æ´‹è‘±ä¸€æ ·ï¼Œå…ˆä»å¤–åˆ°å†…è¿›å…¥ï¼Œç„¶åç”±å†…å‘å¤–æ‰§è¡Œã€‚

function dec(id){
    console.log('evaluated', id);
    return (target, property, descriptor) => console.log('executed', id);
}

class Example {
    @dec(1)
    @dec(2)
    method(){}
}
// evaluated 1
// evaluated 2
// executed 2
// executed 1
ä¸Šé¢ä»£ç ä¸­ï¼Œå¤–å±‚ä¿®é¥°å™¨@dec(1)å…ˆè¿›å…¥ï¼Œä½†æ˜¯å†…å±‚ä¿®é¥°å™¨@dec(2)å…ˆæ‰§è¡Œã€‚

é™¤äº†æ³¨é‡Šï¼Œä¿®é¥°å™¨è¿˜èƒ½ç”¨æ¥ç±»å‹æ£€æŸ¥ã€‚æ‰€ä»¥ï¼Œå¯¹äºç±»æ¥è¯´ï¼Œè¿™é¡¹åŠŸèƒ½ç›¸å½“æœ‰ç”¨ã€‚ä»é•¿æœŸæ¥çœ‹ï¼Œå®ƒå°†æ˜¯JavaScriptä»£ç é™æ€åˆ†æçš„é‡è¦å·¥å…·ã€‚

ä¸ºä»€ä¹ˆä¿®é¥°å™¨ä¸èƒ½ç”¨äºå‡½æ•°ï¼Ÿ
ä¿®é¥°å™¨åªèƒ½ç”¨äºç±»å’Œç±»çš„æ–¹æ³•ï¼Œä¸èƒ½ç”¨äºå‡½æ•°ï¼Œå› ä¸ºå­˜åœ¨å‡½æ•°æå‡ã€‚

var counter = 0;

var add = function () {
  counter++;
};

@add
function foo() {
}
ä¸Šé¢çš„ä»£ç ï¼Œæ„å›¾æ˜¯æ‰§è¡Œåcounterç­‰äº1ï¼Œä½†æ˜¯å®é™…ä¸Šç»“æœæ˜¯counterç­‰äº0ã€‚å› ä¸ºå‡½æ•°æå‡ï¼Œä½¿å¾—å®é™…æ‰§è¡Œçš„ä»£ç æ˜¯ä¸‹é¢è¿™æ ·ã€‚

var counter;
var add;

@add
function foo() {
}

counter = 0;

add = function () {
  counter++;
};
ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

var readOnly = require("some-decorator");

@readOnly
function foo() {
}
ä¸Šé¢ä»£ç ä¹Ÿæœ‰é—®é¢˜ï¼Œå› ä¸ºå®é™…æ‰§è¡Œæ˜¯ä¸‹é¢è¿™æ ·ã€‚

var readOnly;

@readOnly
function foo() {
}

readOnly = require("some-decorator");
æ€»ä¹‹ï¼Œç”±äºå­˜åœ¨å‡½æ•°æå‡ï¼Œä½¿å¾—ä¿®é¥°å™¨ä¸èƒ½ç”¨äºå‡½æ•°ã€‚ç±»æ˜¯ä¸ä¼šæå‡çš„ï¼Œæ‰€ä»¥å°±æ²¡æœ‰è¿™æ–¹é¢çš„é—®é¢˜ã€‚

core-decorators.js
core-decorators.jsæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæä¾›äº†å‡ ä¸ªå¸¸è§çš„ä¿®é¥°å™¨ï¼Œé€šè¿‡å®ƒå¯ä»¥æ›´å¥½åœ°ç†è§£ä¿®é¥°å™¨ã€‚

ï¼ˆ1ï¼‰@autobind

autobindä¿®é¥°å™¨ä½¿å¾—æ–¹æ³•ä¸­çš„thiså¯¹è±¡ï¼Œç»‘å®šåŸå§‹å¯¹è±¡ã€‚

import { autobind } from 'core-decorators';

class Person {
  @autobind
  getPerson() {
    return this;
  }
}

let person = new Person();
let getPerson = person.getPerson;

getPerson() === person;
// true
ï¼ˆ2ï¼‰@readonly

readonlyä¿®é¥°å™¨ä½¿å¾—å±æ€§æˆ–æ–¹æ³•ä¸å¯å†™ã€‚

import { readonly } from 'core-decorators';

class Meal {
  @readonly
  entree = 'steak';
}

var dinner = new Meal();
dinner.entree = 'salmon';
// Cannot assign to read only property 'entree' of [object Object]
ï¼ˆ3ï¼‰@override

overrideä¿®é¥°å™¨æ£€æŸ¥å­ç±»çš„æ–¹æ³•ï¼Œæ˜¯å¦æ­£ç¡®è¦†ç›–äº†çˆ¶ç±»çš„åŒåæ–¹æ³•ï¼Œå¦‚æœä¸æ­£ç¡®ä¼šæŠ¥é”™ã€‚

import { override } from 'core-decorators';

class Parent {
  speak(first, second) {}
}

class Child extends Parent {
  @override
  speak() {}
  // SyntaxError: Child#speak() does not properly override Parent#speak(first, second)
}

// or

class Child extends Parent {
  @override
  speaks() {}
  // SyntaxError: No descriptor matching Child#speaks() was found on the prototype chain.
  //
  //   Did you mean "speak"?
}
ï¼ˆ4ï¼‰@deprecate (åˆ«å@deprecated)

deprecateæˆ–deprecatedä¿®é¥°å™¨åœ¨æ§åˆ¶å°æ˜¾ç¤ºä¸€æ¡è­¦å‘Šï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•å°†åºŸé™¤ã€‚

import { deprecate } from 'core-decorators';

class Person {
  @deprecate
  facepalm() {}

  @deprecate('We stopped facepalming')
  facepalmHard() {}

  @deprecate('We stopped facepalming', { url: 'http://knowyourmeme.com/memes/facepalm' })
  facepalmHarder() {}
}

let person = new Person();

person.facepalm();
// DEPRECATION Person#facepalm: This function will be removed in future versions.

person.facepalmHard();
// DEPRECATION Person#facepalmHard: We stopped facepalming

person.facepalmHarder();
// DEPRECATION Person#facepalmHarder: We stopped facepalming
//
//     See http://knowyourmeme.com/memes/facepalm for more details.
//
ï¼ˆ5ï¼‰@suppressWarnings

suppressWarningsä¿®é¥°å™¨æŠ‘åˆ¶decoratedä¿®é¥°å™¨å¯¼è‡´çš„console.warn()è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œå¼‚æ­¥ä»£ç å‘å‡ºçš„è°ƒç”¨é™¤å¤–ã€‚

import { suppressWarnings } from 'core-decorators';

class Person {
  @deprecated
  facepalm() {}

  @suppressWarnings
  facepalmWithoutWarning() {
    this.facepalm();
  }
}

let person = new Person();

person.facepalmWithoutWarning();
// no warning is logged
ä½¿ç”¨ä¿®é¥°å™¨å®ç°è‡ªåŠ¨å‘å¸ƒäº‹ä»¶
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¿®é¥°å™¨ï¼Œä½¿å¾—å¯¹è±¡çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè‡ªåŠ¨å‘å‡ºä¸€ä¸ªäº‹ä»¶ã€‚

import postal from "postal/lib/postal.lodash";

export default function publish(topic, channel) {
  return function(target, name, descriptor) {
    const fn = descriptor.value;

    descriptor.value = function() {
      let value = fn.apply(this, arguments);
      postal.channel(channel || target.channel || "/").publish(topic, value);
    };
  };
}
ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªåä¸ºpublishçš„ä¿®é¥°å™¨ï¼Œå®ƒé€šè¿‡æ”¹å†™descriptor.valueï¼Œä½¿å¾—åŸæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨å‘å‡ºä¸€ä¸ªäº‹ä»¶ã€‚å®ƒä½¿ç”¨çš„äº‹ä»¶â€œå‘å¸ƒ/è®¢é˜…â€åº“æ˜¯Postal.jsã€‚

å®ƒçš„ç”¨æ³•å¦‚ä¸‹ã€‚

import publish from "path/to/decorators/publish";

class FooComponent {
  @publish("foo.some.message", "component")
  someMethod() {
    return {
      my: "data"
    };
  }
  @publish("foo.some.other")
  anotherMethod() {
    // ...
  }
}
ä»¥åï¼Œåªè¦è°ƒç”¨someMethodæˆ–è€…anotherMethodï¼Œå°±ä¼šè‡ªåŠ¨å‘å‡ºä¸€ä¸ªäº‹ä»¶ã€‚

let foo = new FooComponent();

foo.someMethod() // åœ¨"component"é¢‘é“å‘å¸ƒ"foo.some.message"äº‹ä»¶ï¼Œé™„å¸¦çš„æ•°æ®æ˜¯{ my: "data" }
foo.anotherMethod() // åœ¨"/"é¢‘é“å‘å¸ƒ"foo.some.other"äº‹ä»¶ï¼Œä¸é™„å¸¦æ•°æ®
Mixin
åœ¨ä¿®é¥°å™¨çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥å®ç°Mixinæ¨¡å¼ã€‚æ‰€è°“Mixinæ¨¡å¼ï¼Œå°±æ˜¯å¯¹è±¡ç»§æ‰¿çš„ä¸€ç§æ›¿ä»£æ–¹æ¡ˆï¼Œä¸­æ–‡è¯‘ä¸ºâ€œæ··å…¥â€ï¼ˆmix inï¼‰ï¼Œæ„ä¸ºåœ¨ä¸€ä¸ªå¯¹è±¡ä¹‹ä¸­æ··å…¥å¦å¤–ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ã€‚

è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

const Foo = {
  foo() { console.log('foo') }
};

class MyClass {}

Object.assign(MyClass.prototype, Foo);

let obj = new MyClass();
obj.foo() // 'foo'
ä¸Šé¢ä»£ç ä¹‹ä¸­ï¼Œå¯¹è±¡Fooæœ‰ä¸€ä¸ªfooæ–¹æ³•ï¼Œé€šè¿‡Object.assignæ–¹æ³•ï¼Œå¯ä»¥å°†fooæ–¹æ³•â€œæ··å…¥â€MyClassç±»ï¼Œå¯¼è‡´MyClassçš„å®ä¾‹objå¯¹è±¡éƒ½å…·æœ‰fooæ–¹æ³•ã€‚è¿™å°±æ˜¯â€œæ··å…¥â€æ¨¡å¼çš„ä¸€ä¸ªç®€å•å®ç°ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªé€šç”¨è„šæœ¬mixins.jsï¼Œå°†mixinå†™æˆä¸€ä¸ªä¿®é¥°å™¨ã€‚

export function mixins(...list) {
  return function (target) {
    Object.assign(target.prototype, ...list);
  };
}
ç„¶åï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸Šé¢è¿™ä¸ªä¿®é¥°å™¨ï¼Œä¸ºç±»â€œæ··å…¥â€å„ç§æ–¹æ³•ã€‚

import { mixins } from './mixins';

const Foo = {
  foo() { console.log('foo') }
};

@mixins(Foo)
class MyClass {}

let obj = new MyClass();
obj.foo() // "foo"
é€šè¿‡mixinsè¿™ä¸ªä¿®é¥°å™¨ï¼Œå®ç°äº†åœ¨MyClassç±»ä¸Šé¢â€œæ··å…¥â€Fooå¯¹è±¡çš„fooæ–¹æ³•ã€‚

ä¸è¿‡ï¼Œä¸Šé¢çš„æ–¹æ³•ä¼šæ”¹å†™MyClassç±»çš„prototypeå¯¹è±¡ï¼Œå¦‚æœä¸å–œæ¬¢è¿™ä¸€ç‚¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç±»çš„ç»§æ‰¿å®ç°mixinã€‚

class MyClass extends MyBaseClass {
  /* ... */
}
ä¸Šé¢ä»£ç ä¸­ï¼ŒMyClassç»§æ‰¿äº†MyBaseClassã€‚å¦‚æœæˆ‘ä»¬æƒ³åœ¨MyClassé‡Œé¢â€œæ··å…¥â€ä¸€ä¸ªfooæ–¹æ³•ï¼Œä¸€ä¸ªåŠæ³•æ˜¯åœ¨MyClasså’ŒMyBaseClassä¹‹é—´æ’å…¥ä¸€ä¸ªæ··å…¥ç±»ï¼Œè¿™ä¸ªç±»å…·æœ‰fooæ–¹æ³•ï¼Œå¹¶ä¸”ç»§æ‰¿äº†MyBaseClassçš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åMyClasså†ç»§æ‰¿è¿™ä¸ªç±»ã€‚

let MyMixin = (superclass) => class extends superclass {
  foo() {
    console.log('foo from MyMixin');
  }
};
ä¸Šé¢ä»£ç ä¸­ï¼ŒMyMixinæ˜¯ä¸€ä¸ªæ··å…¥ç±»ç”Ÿæˆå™¨ï¼Œæ¥å—superclassä½œä¸ºå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªç»§æ‰¿superclassçš„å­ç±»ï¼Œè¯¥å­ç±»åŒ…å«ä¸€ä¸ªfooæ–¹æ³•ã€‚

æ¥ç€ï¼Œç›®æ ‡ç±»å†å»ç»§æ‰¿è¿™ä¸ªæ··å…¥ç±»ï¼Œå°±è¾¾åˆ°äº†â€œæ··å…¥â€fooæ–¹æ³•çš„ç›®çš„ã€‚

class MyClass extends MyMixin(MyBaseClass) {
  /* ... */
}

let c = new MyClass();
c.foo(); // "foo from MyMixin"
å¦‚æœéœ€è¦â€œæ··å…¥â€å¤šä¸ªæ–¹æ³•ï¼Œå°±ç”Ÿæˆå¤šä¸ªæ··å…¥ç±»ã€‚

class MyClass extends Mixin1(Mixin2(MyBaseClass)) {
  /* ... */
}
è¿™ç§å†™æ³•çš„ä¸€ä¸ªå¥½å¤„ï¼Œæ˜¯å¯ä»¥è°ƒç”¨superï¼Œå› æ­¤å¯ä»¥é¿å…åœ¨â€œæ··å…¥â€è¿‡ç¨‹ä¸­è¦†ç›–çˆ¶ç±»çš„åŒåæ–¹æ³•ã€‚

let Mixin1 = (superclass) => class extends superclass {
  foo() {
    console.log('foo from Mixin1');
    if (super.foo) super.foo();
  }
};

let Mixin2 = (superclass) => class extends superclass {
  foo() {
    console.log('foo from Mixin2');
    if (super.foo) super.foo();
  }
};

class S {
  foo() {
    console.log('foo from S');
  }
}

class C extends Mixin1(Mixin2(S)) {
  foo() {
    console.log('foo from C');
    super.foo();
  }
}
ä¸Šé¢ä»£ç ä¸­ï¼Œæ¯ä¸€æ¬¡æ··å…¥å‘ç”Ÿæ—¶ï¼Œéƒ½è°ƒç”¨äº†çˆ¶ç±»çš„super.fooæ–¹æ³•ï¼Œå¯¼è‡´çˆ¶ç±»çš„åŒåæ–¹æ³•æ²¡æœ‰è¢«è¦†ç›–ï¼Œè¡Œä¸ºè¢«ä¿ç•™äº†ä¸‹æ¥ã€‚

new C().foo()
// foo from C
// foo from Mixin1
// foo from Mixin2
// foo from S
Trait
Traitä¹Ÿæ˜¯ä¸€ç§ä¿®é¥°å™¨ï¼Œæ•ˆæœä¸Mixinç±»ä¼¼ï¼Œä½†æ˜¯æä¾›æ›´å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚é˜²æ­¢åŒåæ–¹æ³•çš„å†²çªã€æ’é™¤æ··å…¥æŸäº›æ–¹æ³•ã€ä¸ºæ··å…¥çš„æ–¹æ³•èµ·åˆ«åç­‰ç­‰ã€‚

ä¸‹é¢é‡‡ç”¨traits-decoratorè¿™ä¸ªç¬¬ä¸‰æ–¹æ¨¡å—ä½œä¸ºä¾‹å­ã€‚è¿™ä¸ªæ¨¡å—æä¾›çš„traitsä¿®é¥°å™¨ï¼Œä¸ä»…å¯ä»¥æ¥å—å¯¹è±¡ï¼Œè¿˜å¯ä»¥æ¥å—ES6ç±»ä½œä¸ºå‚æ•°ã€‚

import { traits } from 'traits-decorator';

class TFoo {
  foo() { console.log('foo') }
}

const TBar = {
  bar() { console.log('bar') }
};

@traits(TFoo, TBar)
class MyClass { }

let obj = new MyClass();
obj.foo() // foo
obj.bar() // bar
ä¸Šé¢ä»£ç ä¸­ï¼Œé€šè¿‡traitsä¿®é¥°å™¨ï¼Œåœ¨MyClassç±»ä¸Šé¢â€œæ··å…¥â€äº†TFooç±»çš„fooæ–¹æ³•å’ŒTBarå¯¹è±¡çš„baræ–¹æ³•ã€‚

Traitä¸å…è®¸â€œæ··å…¥â€åŒåæ–¹æ³•ã€‚

import { traits } from 'traits-decorator';

class TFoo {
  foo() { console.log('foo') }
}

const TBar = {
  bar() { console.log('bar') },
  foo() { console.log('foo') }
};

@traits(TFoo, TBar)
class MyClass { }
// æŠ¥é”™
// throw new Error('Method named: ' + methodName + ' is defined twice.');
//        ^
// Error: Method named: foo is defined twice.
ä¸Šé¢ä»£ç ä¸­ï¼ŒTFooå’ŒTBaréƒ½æœ‰fooæ–¹æ³•ï¼Œç»“æœtraitsä¿®é¥°å™¨æŠ¥é”™ã€‚

ä¸€ç§è§£å†³æ–¹æ³•æ˜¯æ’é™¤TBarçš„fooæ–¹æ³•ã€‚

import { traits, excludes } from 'traits-decorator';

class TFoo {
  foo() { console.log('foo') }
}

const TBar = {
  bar() { console.log('bar') },
  foo() { console.log('foo') }
};

@traits(TFoo, TBar::excludes('foo'))
class MyClass { }

let obj = new MyClass();
obj.foo() // foo
obj.bar() // bar
ä¸Šé¢ä»£ç ä½¿ç”¨ç»‘å®šè¿ç®—ç¬¦ï¼ˆ::ï¼‰åœ¨TBarä¸Šæ’é™¤fooæ–¹æ³•ï¼Œæ··å…¥æ—¶å°±ä¸ä¼šæŠ¥é”™äº†ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯ä¸ºTBarçš„fooæ–¹æ³•èµ·ä¸€ä¸ªåˆ«åã€‚

import { traits, alias } from 'traits-decorator';

class TFoo {
  foo() { console.log('foo') }
}

const TBar = {
  bar() { console.log('bar') },
  foo() { console.log('foo') }
};

@traits(TFoo, TBar::alias({foo: 'aliasFoo'}))
class MyClass { }

let obj = new MyClass();
obj.foo() // foo
obj.aliasFoo() // foo
obj.bar() // bar
ä¸Šé¢ä»£ç ä¸ºTBarçš„fooæ–¹æ³•èµ·äº†åˆ«åaliasFooï¼Œäºæ˜¯MyClassä¹Ÿå¯ä»¥æ··å…¥TBarçš„fooæ–¹æ³•äº†ã€‚

aliaså’Œexcludesæ–¹æ³•ï¼Œå¯ä»¥ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚

@traits(TExample::excludes('foo','bar')::alias({baz:'exampleBaz'}))
class MyClass {}
ä¸Šé¢ä»£ç æ’é™¤äº†TExampleçš„fooæ–¹æ³•å’Œbaræ–¹æ³•ï¼Œä¸ºbazæ–¹æ³•èµ·äº†åˆ«åexampleBazã€‚

asæ–¹æ³•åˆ™ä¸ºä¸Šé¢çš„ä»£ç æä¾›äº†å¦ä¸€ç§å†™æ³•ã€‚

@traits(TExample::as({excludes:['foo', 'bar'], alias: {baz: 'exampleBaz'}}))
class MyClass {}
Babelè½¬ç å™¨çš„æ”¯æŒ
ç›®å‰ï¼ŒBabelè½¬ç å™¨å·²ç»æ”¯æŒDecoratorã€‚

é¦–å…ˆï¼Œå®‰è£…babel-coreå’Œbabel-plugin-transform-decoratorsã€‚ç”±äºåè€…åŒ…æ‹¬åœ¨babel-preset-stage-0ä¹‹ä¸­ï¼Œæ‰€ä»¥æ”¹ä¸ºå®‰è£…babel-preset-stage-0äº¦å¯ã€‚

$ npm install babel-core babel-plugin-transform-decorators
ç„¶åï¼Œè®¾ç½®é…ç½®æ–‡ä»¶.babelrcã€‚

{
  "plugins": ["transform-decorators"]
}
è¿™æ—¶ï¼ŒBabelå°±å¯ä»¥å¯¹Decoratorè½¬ç äº†ã€‚

è„šæœ¬ä¸­æ‰“å¼€çš„å‘½ä»¤å¦‚ä¸‹ã€‚

babel.transform("code", {plugins: ["transform-decorators"]})
Babelçš„å®˜æ–¹ç½‘ç«™æä¾›ä¸€ä¸ªåœ¨çº¿è½¬ç å™¨ï¼Œåªè¦å‹¾é€‰Experimentalï¼Œå°±èƒ½æ”¯æŒDecoratorçš„åœ¨çº¿è½¬ç ã€‚

##Module
1.å†å²ä¸Šï¼ŒJavaScript ä¸€ç›´æ²¡æœ‰æ¨¡å—ï¼ˆmoduleï¼‰ä½“ç³»ï¼Œæ— æ³•å°†ä¸€ä¸ªå¤§ç¨‹åºæ‹†åˆ†æˆäº’ç›¸ä¾èµ–çš„å°æ–‡ä»¶ï¼Œå†ç”¨ç®€å•çš„æ–¹æ³•æ‹¼è£…èµ·æ¥ã€‚å…¶ä»–è¯­è¨€éƒ½æœ‰è¿™é¡¹åŠŸèƒ½ï¼Œæ¯”å¦‚ Ruby çš„requireã€Python çš„importï¼Œç”šè‡³å°±è¿ CSS éƒ½æœ‰@importï¼Œä½†æ˜¯ JavaScript ä»»ä½•è¿™æ–¹é¢çš„æ”¯æŒéƒ½æ²¡æœ‰ï¼Œè¿™å¯¹å¼€å‘å¤§å‹çš„ã€å¤æ‚çš„é¡¹ç›®å½¢æˆäº†å·¨å¤§éšœç¢ã€‚

åœ¨ ES6 ä¹‹å‰ï¼Œç¤¾åŒºåˆ¶å®šäº†ä¸€äº›æ¨¡å—åŠ è½½æ–¹æ¡ˆï¼Œæœ€ä¸»è¦çš„æœ‰ CommonJS å’Œ AMD ä¸¤ç§ã€‚å‰è€…ç”¨äºæœåŠ¡å™¨ï¼Œåè€…ç”¨äºæµè§ˆå™¨ã€‚ES6 åœ¨è¯­è¨€æ ‡å‡†çš„å±‚é¢ä¸Šï¼Œå®ç°äº†æ¨¡å—åŠŸèƒ½ï¼Œè€Œä¸”å®ç°å¾—ç›¸å½“ç®€å•ï¼Œå®Œå…¨å¯ä»¥å–ä»£ç°æœ‰çš„ CommonJS å’Œ AMD è§„èŒƒï¼Œæˆä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨é€šç”¨çš„æ¨¡å—è§£å†³æ–¹æ¡ˆã€‚

ES6 æ¨¡å—çš„è®¾è®¡æ€æƒ³ï¼Œæ˜¯å°½é‡çš„é™æ€åŒ–ï¼Œä½¿å¾—ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œä»¥åŠè¾“å…¥å’Œè¾“å‡ºçš„å˜é‡ã€‚CommonJS å’Œ AMD æ¨¡å—ï¼Œéƒ½åªèƒ½åœ¨è¿è¡Œæ—¶ç¡®å®šè¿™äº›ä¸œè¥¿ã€‚æ¯”å¦‚ï¼ŒCommonJS æ¨¡å—å°±æ˜¯å¯¹è±¡ï¼Œè¾“å…¥æ—¶å¿…é¡»æŸ¥æ‰¾å¯¹è±¡å±æ€§ã€‚

// CommonJSæ¨¡å—
let { stat, exists, readFile } = require('fs');

// ç­‰åŒäº
let _fs = require('fs');
let stat = _fs.stat, exists = _fs.exists, readfile = _fs.readfile;
ä¸Šé¢ä»£ç çš„å®è´¨æ˜¯æ•´ä½“åŠ è½½fsæ¨¡å—ï¼ˆå³åŠ è½½fsçš„æ‰€æœ‰æ–¹æ³•ï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼ˆ_fsï¼‰ï¼Œç„¶åå†ä»è¿™ä¸ªå¯¹è±¡ä¸Šé¢è¯»å–3ä¸ªæ–¹æ³•ã€‚è¿™ç§åŠ è½½ç§°ä¸ºâ€œè¿è¡Œæ—¶åŠ è½½â€ï¼Œå› ä¸ºåªæœ‰è¿è¡Œæ—¶æ‰èƒ½å¾—åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œå¯¼è‡´å®Œå…¨æ²¡åŠæ³•åœ¨ç¼–è¯‘æ—¶åšâ€œé™æ€ä¼˜åŒ–â€ã€‚

ES6 æ¨¡å—ä¸æ˜¯å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡exportå‘½ä»¤æ˜¾å¼æŒ‡å®šè¾“å‡ºçš„ä»£ç ï¼Œå†é€šè¿‡importå‘½ä»¤è¾“å…¥ã€‚

// ES6æ¨¡å—
import { stat, exists, readFile } from 'fs';
ä¸Šé¢ä»£ç çš„å®è´¨æ˜¯ä»fsæ¨¡å—åŠ è½½3ä¸ªæ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ä¸åŠ è½½ã€‚è¿™ç§åŠ è½½ç§°ä¸ºâ€œç¼–è¯‘æ—¶åŠ è½½â€æˆ–è€…é™æ€åŠ è½½ï¼Œå³ ES6 å¯ä»¥åœ¨ç¼–è¯‘æ—¶å°±å®Œæˆæ¨¡å—åŠ è½½ï¼Œæ•ˆç‡è¦æ¯” CommonJS æ¨¡å—çš„åŠ è½½æ–¹å¼é«˜ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†æ²¡æ³•å¼•ç”¨ ES6 æ¨¡å—æœ¬èº«ï¼Œå› ä¸ºå®ƒä¸æ˜¯å¯¹è±¡ã€‚

ç”±äº ES6 æ¨¡å—æ˜¯ç¼–è¯‘æ—¶åŠ è½½ï¼Œä½¿å¾—é™æ€åˆ†ææˆä¸ºå¯èƒ½ã€‚æœ‰äº†å®ƒï¼Œå°±èƒ½è¿›ä¸€æ­¥æ‹“å®½ JavaScript çš„è¯­æ³•ï¼Œæ¯”å¦‚å¼•å…¥å®ï¼ˆmacroï¼‰å’Œç±»å‹æ£€éªŒï¼ˆtype systemï¼‰è¿™äº›åªèƒ½é é™æ€åˆ†æå®ç°çš„åŠŸèƒ½ã€‚

é™¤äº†é™æ€åŠ è½½å¸¦æ¥çš„å„ç§å¥½å¤„ï¼ŒES6 æ¨¡å—è¿˜æœ‰ä»¥ä¸‹å¥½å¤„ã€‚

ä¸å†éœ€è¦UMDæ¨¡å—æ ¼å¼äº†ï¼Œå°†æ¥æœåŠ¡å™¨å’Œæµè§ˆå™¨éƒ½ä¼šæ”¯æŒ ES6 æ¨¡å—æ ¼å¼ã€‚ç›®å‰ï¼Œé€šè¿‡å„ç§å·¥å…·åº“ï¼Œå…¶å®å·²ç»åšåˆ°äº†è¿™ä¸€ç‚¹ã€‚
å°†æ¥æµè§ˆå™¨çš„æ–° API å°±èƒ½ç”¨æ¨¡å—æ ¼å¼æä¾›ï¼Œä¸å†å¿…é¡»åšæˆå…¨å±€å˜é‡æˆ–è€…navigatorå¯¹è±¡çš„å±æ€§ã€‚
ä¸å†éœ€è¦å¯¹è±¡ä½œä¸ºå‘½åç©ºé—´ï¼ˆæ¯”å¦‚Mathå¯¹è±¡ï¼‰ï¼Œæœªæ¥è¿™äº›åŠŸèƒ½å¯ä»¥é€šè¿‡æ¨¡å—æä¾›ã€‚
ä¸¥æ ¼æ¨¡å¼
ES6 çš„æ¨¡å—è‡ªåŠ¨é‡‡ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œä¸ç®¡ä½ æœ‰æ²¡æœ‰åœ¨æ¨¡å—å¤´éƒ¨åŠ ä¸Š"use strict";ã€‚

ä¸¥æ ¼æ¨¡å¼ä¸»è¦æœ‰ä»¥ä¸‹é™åˆ¶ã€‚

å˜é‡å¿…é¡»å£°æ˜åå†ä½¿ç”¨
å‡½æ•°çš„å‚æ•°ä¸èƒ½æœ‰åŒåå±æ€§ï¼Œå¦åˆ™æŠ¥é”™
ä¸èƒ½ä½¿ç”¨withè¯­å¥
ä¸èƒ½å¯¹åªè¯»å±æ€§èµ‹å€¼ï¼Œå¦åˆ™æŠ¥é”™
ä¸èƒ½ä½¿ç”¨å‰ç¼€0è¡¨ç¤ºå…«è¿›åˆ¶æ•°ï¼Œå¦åˆ™æŠ¥é”™
ä¸èƒ½åˆ é™¤ä¸å¯åˆ é™¤çš„å±æ€§ï¼Œå¦åˆ™æŠ¥é”™
ä¸èƒ½åˆ é™¤å˜é‡delete propï¼Œä¼šæŠ¥é”™ï¼Œåªèƒ½åˆ é™¤å±æ€§delete global[prop]
evalä¸ä¼šåœ¨å®ƒçš„å¤–å±‚ä½œç”¨åŸŸå¼•å…¥å˜é‡
evalå’Œargumentsä¸èƒ½è¢«é‡æ–°èµ‹å€¼
argumentsä¸ä¼šè‡ªåŠ¨åæ˜ å‡½æ•°å‚æ•°çš„å˜åŒ–
ä¸èƒ½ä½¿ç”¨arguments.callee
ä¸èƒ½ä½¿ç”¨arguments.caller
ç¦æ­¢thisæŒ‡å‘å…¨å±€å¯¹è±¡
ä¸èƒ½ä½¿ç”¨fn.callerå’Œfn.argumentsè·å–å‡½æ•°è°ƒç”¨çš„å †æ ˆ
å¢åŠ äº†ä¿ç•™å­—ï¼ˆæ¯”å¦‚protectedã€staticå’Œinterfaceï¼‰
ä¸Šé¢è¿™äº›é™åˆ¶ï¼Œæ¨¡å—éƒ½å¿…é¡»éµå®ˆã€‚ç”±äºä¸¥æ ¼æ¨¡å¼æ˜¯ ES5 å¼•å…¥çš„ï¼Œä¸å±äº ES6ï¼Œæ‰€ä»¥è¯·å‚é˜…ç›¸å…³ ES5 ä¹¦ç±ï¼Œæœ¬ä¹¦ä¸å†è¯¦ç»†ä»‹ç»äº†ã€‚

export å‘½ä»¤
æ¨¡å—åŠŸèƒ½ä¸»è¦ç”±ä¸¤ä¸ªå‘½ä»¤æ„æˆï¼šexportå’Œimportã€‚exportå‘½ä»¤ç”¨äºè§„å®šæ¨¡å—çš„å¯¹å¤–æ¥å£ï¼Œimportå‘½ä»¤ç”¨äºè¾“å…¥å…¶ä»–æ¨¡å—æä¾›çš„åŠŸèƒ½ã€‚

ä¸€ä¸ªæ¨¡å—å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„æ‰€æœ‰å˜é‡ï¼Œå¤–éƒ¨æ— æ³•è·å–ã€‚å¦‚æœä½ å¸Œæœ›å¤–éƒ¨èƒ½å¤Ÿè¯»å–æ¨¡å—å†…éƒ¨çš„æŸä¸ªå˜é‡ï¼Œå°±å¿…é¡»ä½¿ç”¨exportå…³é”®å­—è¾“å‡ºè¯¥å˜é‡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª JS æ–‡ä»¶ï¼Œé‡Œé¢ä½¿ç”¨exportå‘½ä»¤è¾“å‡ºå˜é‡ã€‚

// profile.js
export var firstName = 'Michael';
export var lastName = 'Jackson';
export var year = 1958;
ä¸Šé¢ä»£ç æ˜¯profile.jsæ–‡ä»¶ï¼Œä¿å­˜äº†ç”¨æˆ·ä¿¡æ¯ã€‚ES6å°†å…¶è§†ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œé‡Œé¢ç”¨exportå‘½ä»¤å¯¹å¤–éƒ¨è¾“å‡ºäº†ä¸‰ä¸ªå˜é‡ã€‚

exportçš„å†™æ³•ï¼Œé™¤äº†åƒä¸Šé¢è¿™æ ·ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§ã€‚

// profile.js
var firstName = 'Michael';
var lastName = 'Jackson';
var year = 1958;

export {firstName, lastName, year};
ä¸Šé¢ä»£ç åœ¨exportå‘½ä»¤åé¢ï¼Œä½¿ç”¨å¤§æ‹¬å·æŒ‡å®šæ‰€è¦è¾“å‡ºçš„ä¸€ç»„å˜é‡ã€‚å®ƒä¸å‰ä¸€ç§å†™æ³•ï¼ˆç›´æ¥æ”¾ç½®åœ¨varè¯­å¥å‰ï¼‰æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯åº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¿™ç§å†™æ³•ã€‚å› ä¸ºè¿™æ ·å°±å¯ä»¥åœ¨è„šæœ¬å°¾éƒ¨ï¼Œä¸€çœ¼çœ‹æ¸…æ¥šè¾“å‡ºäº†å“ªäº›å˜é‡ã€‚

exportå‘½ä»¤é™¤äº†è¾“å‡ºå˜é‡ï¼Œè¿˜å¯ä»¥è¾“å‡ºå‡½æ•°æˆ–ç±»ï¼ˆclassï¼‰ã€‚

export function multiply(x, y) {
  return x * y;
};
ä¸Šé¢ä»£ç å¯¹å¤–è¾“å‡ºä¸€ä¸ªå‡½æ•°multiplyã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œexportè¾“å‡ºçš„å˜é‡å°±æ˜¯æœ¬æ¥çš„åå­—ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨aså…³é”®å­—é‡å‘½åã€‚

function v1() { ... }
function v2() { ... }

export {
  v1 as streamV1,
  v2 as streamV2,
  v2 as streamLatestVersion
};
ä¸Šé¢ä»£ç ä½¿ç”¨aså…³é”®å­—ï¼Œé‡å‘½åäº†å‡½æ•°v1å’Œv2çš„å¯¹å¤–æ¥å£ã€‚é‡å‘½ååï¼Œv2å¯ä»¥ç”¨ä¸åŒçš„åå­—è¾“å‡ºä¸¤æ¬¡ã€‚

éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œexportå‘½ä»¤è§„å®šçš„æ˜¯å¯¹å¤–çš„æ¥å£ï¼Œå¿…é¡»ä¸æ¨¡å—å†…éƒ¨çš„å˜é‡å»ºç«‹ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚

// æŠ¥é”™
export 1;

// æŠ¥é”™
var m = 1;
export m;
ä¸Šé¢ä¸¤ç§å†™æ³•éƒ½ä¼šæŠ¥é”™ï¼Œå› ä¸ºæ²¡æœ‰æä¾›å¯¹å¤–çš„æ¥å£ã€‚ç¬¬ä¸€ç§å†™æ³•ç›´æ¥è¾“å‡º1ï¼Œç¬¬äºŒç§å†™æ³•é€šè¿‡å˜é‡mï¼Œè¿˜æ˜¯ç›´æ¥è¾“å‡º1ã€‚1åªæ˜¯ä¸€ä¸ªå€¼ï¼Œä¸æ˜¯æ¥å£ã€‚æ­£ç¡®çš„å†™æ³•æ˜¯ä¸‹é¢è¿™æ ·ã€‚

// å†™æ³•ä¸€
export var m = 1;

// å†™æ³•äºŒ
var m = 1;
export {m};

// å†™æ³•ä¸‰
var n = 1;
export {n as m};
ä¸Šé¢ä¸‰ç§å†™æ³•éƒ½æ˜¯æ­£ç¡®çš„ï¼Œè§„å®šäº†å¯¹å¤–çš„æ¥å£mã€‚å…¶ä»–è„šæœ¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£ï¼Œå–åˆ°å€¼1ã€‚å®ƒä»¬çš„å®è´¨æ˜¯ï¼Œåœ¨æ¥å£åä¸æ¨¡å—å†…éƒ¨å˜é‡ä¹‹é—´ï¼Œå»ºç«‹äº†ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚

åŒæ ·çš„ï¼Œfunctionå’Œclassçš„è¾“å‡ºï¼Œä¹Ÿå¿…é¡»éµå®ˆè¿™æ ·çš„å†™æ³•ã€‚

// æŠ¥é”™
function f() {}
export f;

// æ­£ç¡®
export function f() {};

// æ­£ç¡®
function f() {}
export {f};
å¦å¤–ï¼Œexportè¯­å¥è¾“å‡ºçš„æ¥å£ï¼Œä¸å…¶å¯¹åº”çš„å€¼æ˜¯åŠ¨æ€ç»‘å®šå…³ç³»ï¼Œå³é€šè¿‡è¯¥æ¥å£ï¼Œå¯ä»¥å–åˆ°æ¨¡å—å†…éƒ¨å®æ—¶çš„å€¼ã€‚

export var foo = 'bar';
setTimeout(() => foo = 'baz', 500);
ä¸Šé¢ä»£ç è¾“å‡ºå˜é‡fooï¼Œå€¼ä¸ºbarï¼Œ500æ¯«ç§’ä¹‹åå˜æˆbazã€‚

è¿™ä¸€ç‚¹ä¸CommonJSè§„èŒƒå®Œå…¨ä¸åŒã€‚CommonJSæ¨¡å—è¾“å‡ºçš„æ˜¯å€¼çš„ç¼“å­˜ï¼Œä¸å­˜åœ¨åŠ¨æ€æ›´æ–°ï¼Œè¯¦è§ä¸‹æ–‡ã€ŠES6æ¨¡å—åŠ è½½çš„å®è´¨ã€‹ä¸€èŠ‚ã€‚

æœ€åï¼Œexportå‘½ä»¤å¯ä»¥å‡ºç°åœ¨æ¨¡å—çš„ä»»ä½•ä½ç½®ï¼Œåªè¦å¤„äºæ¨¡å—é¡¶å±‚å°±å¯ä»¥ã€‚å¦‚æœå¤„äºå—çº§ä½œç”¨åŸŸå†…ï¼Œå°±ä¼šæŠ¥é”™ï¼Œä¸‹ä¸€èŠ‚çš„importå‘½ä»¤ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸ºå¤„äºæ¡ä»¶ä»£ç å—ä¹‹ä¸­ï¼Œå°±æ²¡æ³•åšé™æ€ä¼˜åŒ–äº†ï¼Œè¿èƒŒäº†ES6æ¨¡å—çš„è®¾è®¡åˆè¡·ã€‚

function foo() {
  export default 'bar' // SyntaxError
}
foo()
ä¸Šé¢ä»£ç ä¸­ï¼Œexportè¯­å¥æ”¾åœ¨å‡½æ•°ä¹‹ä¸­ï¼Œç»“æœæŠ¥é”™ã€‚

import å‘½ä»¤
ä½¿ç”¨exportå‘½ä»¤å®šä¹‰äº†æ¨¡å—çš„å¯¹å¤–æ¥å£ä»¥åï¼Œå…¶ä»– JS æ–‡ä»¶å°±å¯ä»¥é€šè¿‡importå‘½ä»¤åŠ è½½è¿™ä¸ªæ¨¡å—ã€‚

// main.js
import {firstName, lastName, year} from './profile';

function setName(element) {
  element.textContent = firstName + ' ' + lastName;
}
ä¸Šé¢ä»£ç çš„importå‘½ä»¤ï¼Œç”¨äºåŠ è½½profile.jsæ–‡ä»¶ï¼Œå¹¶ä»ä¸­è¾“å…¥å˜é‡ã€‚importå‘½ä»¤æ¥å—ä¸€å¯¹å¤§æ‹¬å·ï¼Œé‡Œé¢æŒ‡å®šè¦ä»å…¶ä»–æ¨¡å—å¯¼å…¥çš„å˜é‡åã€‚å¤§æ‹¬å·é‡Œé¢çš„å˜é‡åï¼Œå¿…é¡»ä¸è¢«å¯¼å…¥æ¨¡å—ï¼ˆprofile.jsï¼‰å¯¹å¤–æ¥å£çš„åç§°ç›¸åŒã€‚

å¦‚æœæƒ³ä¸ºè¾“å…¥çš„å˜é‡é‡æ–°å–ä¸€ä¸ªåå­—ï¼Œimportå‘½ä»¤è¦ä½¿ç”¨aså…³é”®å­—ï¼Œå°†è¾“å…¥çš„å˜é‡é‡å‘½åã€‚

import { lastName as surname } from './profile';
importåé¢çš„fromæŒ‡å®šæ¨¡å—æ–‡ä»¶çš„ä½ç½®ï¼Œå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œ.jsè·¯å¾„å¯ä»¥çœç•¥ã€‚å¦‚æœåªæ˜¯æ¨¡å—åï¼Œä¸å¸¦æœ‰è·¯å¾„ï¼Œé‚£ä¹ˆå¿…é¡»æœ‰é…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰ JavaScript å¼•æ“è¯¥æ¨¡å—çš„ä½ç½®ã€‚

import {myMethod} from 'util';
ä¸Šé¢ä»£ç ä¸­ï¼Œutilæ˜¯æ¨¡å—æ–‡ä»¶åï¼Œç”±äºä¸å¸¦æœ‰è·¯å¾„ï¼Œå¿…é¡»é€šè¿‡é…ç½®ï¼Œå‘Šè¯‰å¼•æ“æ€ä¹ˆå–åˆ°è¿™ä¸ªæ¨¡å—ã€‚

æ³¨æ„ï¼Œimportå‘½ä»¤å…·æœ‰æå‡æ•ˆæœï¼Œä¼šæå‡åˆ°æ•´ä¸ªæ¨¡å—çš„å¤´éƒ¨ï¼Œé¦–å…ˆæ‰§è¡Œã€‚

foo();

import { foo } from 'my_module';
ä¸Šé¢çš„ä»£ç ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºimportçš„æ‰§è¡Œæ—©äºfooçš„è°ƒç”¨ã€‚è¿™ç§è¡Œä¸ºçš„æœ¬è´¨æ˜¯ï¼Œimportå‘½ä»¤æ˜¯ç¼–è¯‘é˜¶æ®µæ‰§è¡Œçš„ï¼Œåœ¨ä»£ç è¿è¡Œä¹‹å‰ã€‚

ç”±äºimportæ˜¯é™æ€æ‰§è¡Œï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨è¡¨è¾¾å¼å’Œå˜é‡ï¼Œè¿™äº›åªæœ‰åœ¨è¿è¡Œæ—¶æ‰èƒ½å¾—åˆ°ç»“æœçš„è¯­æ³•ç»“æ„ã€‚

// æŠ¥é”™
import { 'f' + 'oo' } from 'my_module';

// æŠ¥é”™
let module = 'my_module';
import { foo } from module;

// æŠ¥é”™
if (x === 1) {
  import { foo } from 'module1';
} else {
  import { foo } from 'module2';
}
ä¸Šé¢ä¸‰ç§å†™æ³•éƒ½ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒä»¬ç”¨åˆ°äº†è¡¨è¾¾å¼ã€å˜é‡å’Œifç»“æ„ã€‚åœ¨é™æ€åˆ†æé˜¶æ®µï¼Œè¿™äº›è¯­æ³•éƒ½æ˜¯æ²¡æ³•å¾—åˆ°å€¼çš„ã€‚

æœ€åï¼Œimportè¯­å¥ä¼šæ‰§è¡Œæ‰€åŠ è½½çš„æ¨¡å—ï¼Œå› æ­¤å¯ä»¥æœ‰ä¸‹é¢çš„å†™æ³•ã€‚

import 'lodash';
ä¸Šé¢ä»£ç ä»…ä»…æ‰§è¡Œlodashæ¨¡å—ï¼Œä½†æ˜¯ä¸è¾“å…¥ä»»ä½•å€¼ã€‚

å¦‚æœå¤šæ¬¡é‡å¤æ‰§è¡ŒåŒä¸€å¥importè¯­å¥ï¼Œé‚£ä¹ˆåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸ä¼šæ‰§è¡Œå¤šæ¬¡ã€‚

import 'lodash';
import 'lodash';
ä¸Šé¢ä»£ç åŠ è½½äº†ä¸¤æ¬¡lodashï¼Œä½†æ˜¯åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

import { foo } from 'my_module';
import { bar } from 'my_module';

// ç­‰åŒäº
import { foo, bar } from 'my_module';
ä¸Šé¢ä»£ç ä¸­ï¼Œè™½ç„¶fooå’Œbaråœ¨ä¸¤ä¸ªè¯­å¥ä¸­åŠ è½½ï¼Œä½†æ˜¯å®ƒä»¬å¯¹åº”çš„æ˜¯åŒä¸€ä¸ªmy_moduleå®ä¾‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œimportè¯­å¥æ˜¯ Singleton æ¨¡å¼ã€‚

æ¨¡å—çš„æ•´ä½“åŠ è½½
é™¤äº†æŒ‡å®šåŠ è½½æŸä¸ªè¾“å‡ºå€¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ•´ä½“åŠ è½½ï¼Œå³ç”¨æ˜Ÿå·ï¼ˆ*ï¼‰æŒ‡å®šä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€æœ‰è¾“å‡ºå€¼éƒ½åŠ è½½åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šé¢ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªcircle.jsæ–‡ä»¶ï¼Œå®ƒè¾“å‡ºä¸¤ä¸ªæ–¹æ³•areaå’Œcircumferenceã€‚

// circle.js

export function area(radius) {
  return Math.PI * radius * radius;
}

export function circumference(radius) {
  return 2 * Math.PI * radius;
}
ç°åœ¨ï¼ŒåŠ è½½è¿™ä¸ªæ¨¡å—ã€‚

// main.js

import { area, circumference } from './circle';

console.log('åœ†é¢ç§¯ï¼š' + area(4));
console.log('åœ†å‘¨é•¿ï¼š' + circumference(14));
ä¸Šé¢å†™æ³•æ˜¯é€ä¸€æŒ‡å®šè¦åŠ è½½çš„æ–¹æ³•ï¼Œæ•´ä½“åŠ è½½çš„å†™æ³•å¦‚ä¸‹ã€‚

import * as circle from './circle';

console.log('åœ†é¢ç§¯ï¼š' + circle.area(4));
console.log('åœ†å‘¨é•¿ï¼š' + circle.circumference(14));
export default å‘½ä»¤
ä»å‰é¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨importå‘½ä»¤çš„æ—¶å€™ï¼Œç”¨æˆ·éœ€è¦çŸ¥é“æ‰€è¦åŠ è½½çš„å˜é‡åæˆ–å‡½æ•°åï¼Œå¦åˆ™æ— æ³•åŠ è½½ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·è‚¯å®šå¸Œæœ›å¿«é€Ÿä¸Šæ‰‹ï¼Œæœªå¿…æ„¿æ„é˜…è¯»æ–‡æ¡£ï¼Œå»äº†è§£æ¨¡å—æœ‰å“ªäº›å±æ€§å’Œæ–¹æ³•ã€‚

ä¸ºäº†ç»™ç”¨æˆ·æä¾›æ–¹ä¾¿ï¼Œè®©ä»–ä»¬ä¸ç”¨é˜…è¯»æ–‡æ¡£å°±èƒ½åŠ è½½æ¨¡å—ï¼Œå°±è¦ç”¨åˆ°export defaultå‘½ä»¤ï¼Œä¸ºæ¨¡å—æŒ‡å®šé»˜è®¤è¾“å‡ºã€‚

// export-default.js
export default function () {
  console.log('foo');
}
ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªæ¨¡å—æ–‡ä»¶export-default.jsï¼Œå®ƒçš„é»˜è®¤è¾“å‡ºæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚

å…¶ä»–æ¨¡å—åŠ è½½è¯¥æ¨¡å—æ—¶ï¼Œimportå‘½ä»¤å¯ä»¥ä¸ºè¯¥åŒ¿åå‡½æ•°æŒ‡å®šä»»æ„åå­—ã€‚

// import-default.js
import customName from './export-default';
customName(); // 'foo'
ä¸Šé¢ä»£ç çš„importå‘½ä»¤ï¼Œå¯ä»¥ç”¨ä»»æ„åç§°æŒ‡å‘export-default.jsè¾“å‡ºçš„æ–¹æ³•ï¼Œè¿™æ—¶å°±ä¸éœ€è¦çŸ¥é“åŸæ¨¡å—è¾“å‡ºçš„å‡½æ•°åã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ—¶importå‘½ä»¤åé¢ï¼Œä¸ä½¿ç”¨å¤§æ‹¬å·ã€‚

export defaultå‘½ä»¤ç”¨åœ¨éåŒ¿åå‡½æ•°å‰ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

// export-default.js
export default function foo() {
  console.log('foo');
}

// æˆ–è€…å†™æˆ

function foo() {
  console.log('foo');
}

export default foo;
ä¸Šé¢ä»£ç ä¸­ï¼Œfooå‡½æ•°çš„å‡½æ•°åfooï¼Œåœ¨æ¨¡å—å¤–éƒ¨æ˜¯æ— æ•ˆçš„ã€‚åŠ è½½çš„æ—¶å€™ï¼Œè§†åŒåŒ¿åå‡½æ•°åŠ è½½ã€‚

ä¸‹é¢æ¯”è¾ƒä¸€ä¸‹é»˜è®¤è¾“å‡ºå’Œæ­£å¸¸è¾“å‡ºã€‚

// ç¬¬ä¸€ç»„
export default function crc32() { // è¾“å‡º
  // ...
}

import crc32 from 'crc32'; // è¾“å…¥

// ç¬¬äºŒç»„
export function crc32() { // è¾“å‡º
  // ...
};

import {crc32} from 'crc32'; // è¾“å…¥
ä¸Šé¢ä»£ç çš„ä¸¤ç»„å†™æ³•ï¼Œç¬¬ä¸€ç»„æ˜¯ä½¿ç”¨export defaultæ—¶ï¼Œå¯¹åº”çš„importè¯­å¥ä¸éœ€è¦ä½¿ç”¨å¤§æ‹¬å·ï¼›ç¬¬äºŒç»„æ˜¯ä¸ä½¿ç”¨export defaultæ—¶ï¼Œå¯¹åº”çš„importè¯­å¥éœ€è¦ä½¿ç”¨å¤§æ‹¬å·ã€‚

export defaultå‘½ä»¤ç”¨äºæŒ‡å®šæ¨¡å—çš„é»˜è®¤è¾“å‡ºã€‚æ˜¾ç„¶ï¼Œä¸€ä¸ªæ¨¡å—åªèƒ½æœ‰ä¸€ä¸ªé»˜è®¤è¾“å‡ºï¼Œå› æ­¤export defaultå‘½ä»¤åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚æ‰€ä»¥ï¼Œimportå‘½ä»¤åé¢æ‰ä¸ç”¨åŠ å¤§æ‹¬å·ï¼Œå› ä¸ºåªå¯èƒ½å¯¹åº”ä¸€ä¸ªæ–¹æ³•ã€‚

æœ¬è´¨ä¸Šï¼Œexport defaultå°±æ˜¯è¾“å‡ºä¸€ä¸ªå«åšdefaultçš„å˜é‡æˆ–æ–¹æ³•ï¼Œç„¶åç³»ç»Ÿå…è®¸ä½ ä¸ºå®ƒå–ä»»æ„åå­—ã€‚æ‰€ä»¥ï¼Œä¸‹é¢çš„å†™æ³•æ˜¯æœ‰æ•ˆçš„ã€‚

// modules.js
function add(x, y) {
  return x * y;
}
export {add as default};
// ç­‰åŒäº
// export default add;

// app.js
import { default as xxx } from 'modules';
// ç­‰åŒäº
// import xxx from 'modules';
æ­£æ˜¯å› ä¸ºexport defaultå‘½ä»¤å…¶å®åªæ˜¯è¾“å‡ºä¸€ä¸ªå«åšdefaultçš„å˜é‡ï¼Œæ‰€ä»¥å®ƒåé¢ä¸èƒ½è·Ÿå˜é‡å£°æ˜è¯­å¥ã€‚

// æ­£ç¡®
export var a = 1;

// æ­£ç¡®
var a = 1;
export default a;

// é”™è¯¯
export default var a = 1;
ä¸Šé¢ä»£ç ä¸­ï¼Œexport default açš„å«ä¹‰æ˜¯å°†å˜é‡açš„å€¼èµ‹ç»™å˜é‡defaultã€‚æ‰€ä»¥ï¼Œæœ€åä¸€ç§å†™æ³•ä¼šæŠ¥é”™ã€‚

æœ‰äº†export defaultå‘½ä»¤ï¼Œè¾“å…¥æ¨¡å—æ—¶å°±éå¸¸ç›´è§‚äº†ï¼Œä»¥è¾“å…¥ lodash æ¨¡å—ä¸ºä¾‹ã€‚

import _ from 'lodash';
å¦‚æœæƒ³åœ¨ä¸€æ¡importè¯­å¥ä¸­ï¼ŒåŒæ—¶è¾“å…¥é»˜è®¤æ–¹æ³•å’Œå…¶ä»–å˜é‡ï¼Œå¯ä»¥å†™æˆä¸‹é¢è¿™æ ·ã€‚

import _, { each } from 'lodash';
å¯¹åº”ä¸Šé¢ä»£ç çš„exportè¯­å¥å¦‚ä¸‹ã€‚

export default function (obj) {
  // Â·Â·Â·
}
export function each(obj, iterator, context) {
  // Â·Â·Â·
}
export { each as forEach };
ä¸Šé¢ä»£ç çš„æœ€åä¸€è¡Œçš„æ„æ€æ˜¯ï¼Œæš´éœ²å‡ºforEachæ¥å£ï¼Œé»˜è®¤æŒ‡å‘eachæ¥å£ï¼Œå³forEachå’ŒeachæŒ‡å‘åŒä¸€ä¸ªæ–¹æ³•ã€‚

å¦‚æœè¦è¾“å‡ºé»˜è®¤çš„å€¼ï¼Œåªéœ€å°†å€¼è·Ÿåœ¨export defaultä¹‹åå³å¯ã€‚

export default 42;
export defaultä¹Ÿå¯ä»¥ç”¨æ¥è¾“å‡ºç±»ã€‚

// MyClass.js
export default class { ... }

// main.js
import MyClass from 'MyClass';
let o = new MyClass();
export ä¸ import çš„å¤åˆå†™æ³•
å¦‚æœåœ¨ä¸€ä¸ªæ¨¡å—ä¹‹ä¸­ï¼Œå…ˆè¾“å…¥åè¾“å‡ºåŒä¸€ä¸ªæ¨¡å—ï¼Œimportè¯­å¥å¯ä»¥ä¸exportè¯­å¥å†™åœ¨ä¸€èµ·ã€‚

export { foo, bar } from 'my_module';

// ç­‰åŒäº
import { foo, bar } from 'my_module';
export { foo, bar };
ä¸Šé¢ä»£ç ä¸­ï¼Œexportå’Œimportè¯­å¥å¯ä»¥ç»“åˆåœ¨ä¸€èµ·ï¼Œå†™æˆä¸€è¡Œã€‚

æ¨¡å—çš„æ¥å£æ”¹åå’Œæ•´ä½“è¾“å‡ºï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§å†™æ³•ã€‚

// æ¥å£æ”¹å
export { foo as myFoo } from 'my_module';

// æ•´ä½“è¾“å‡º
export * from 'my_module';
é»˜è®¤æ¥å£çš„å†™æ³•å¦‚ä¸‹ã€‚

export { default } from 'foo';
å…·åæ¥å£æ”¹ä¸ºé»˜è®¤æ¥å£çš„å†™æ³•å¦‚ä¸‹ã€‚

export { es6 as default } from './someModule';

// ç­‰åŒäº
import { es6 } from './someModule';
export default es6;
åŒæ ·åœ°ï¼Œé»˜è®¤æ¥å£ä¹Ÿå¯ä»¥æ”¹åä¸ºå…·åæ¥å£ã€‚

export { default as es6 } from './someModule';
å¦å¤–ï¼ŒES7æœ‰ä¸€ä¸ªææ¡ˆï¼Œç®€åŒ–å…ˆè¾“å…¥åè¾“å‡ºçš„å†™æ³•ï¼Œæ‹¿æ‰è¾“å‡ºæ—¶çš„å¤§æ‹¬å·ã€‚

// ç°è¡Œçš„å†™æ³•
export {v} from 'mod';

// ææ¡ˆçš„å†™æ³•
export v from 'mod';
æ¨¡å—çš„ç»§æ‰¿
æ¨¡å—ä¹‹é—´ä¹Ÿå¯ä»¥ç»§æ‰¿ã€‚

å‡è®¾æœ‰ä¸€ä¸ªcircleplusæ¨¡å—ï¼Œç»§æ‰¿äº†circleæ¨¡å—ã€‚

// circleplus.js

export * from 'circle';
export var e = 2.71828182846;
export default function(x) {
  return Math.exp(x);
}
ä¸Šé¢ä»£ç ä¸­çš„export *ï¼Œè¡¨ç¤ºå†è¾“å‡ºcircleæ¨¡å—çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚æ³¨æ„ï¼Œexport *å‘½ä»¤ä¼šå¿½ç•¥circleæ¨¡å—çš„defaultæ–¹æ³•ã€‚ç„¶åï¼Œä¸Šé¢ä»£ç åˆè¾“å‡ºäº†è‡ªå®šä¹‰çš„eå˜é‡å’Œé»˜è®¤æ–¹æ³•ã€‚

è¿™æ—¶ï¼Œä¹Ÿå¯ä»¥å°†circleçš„å±æ€§æˆ–æ–¹æ³•ï¼Œæ”¹ååå†è¾“å‡ºã€‚

// circleplus.js

export { area as circleArea } from 'circle';
ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œåªè¾“å‡ºcircleæ¨¡å—çš„areaæ–¹æ³•ï¼Œä¸”å°†å…¶æ”¹åä¸ºcircleAreaã€‚

åŠ è½½ä¸Šé¢æ¨¡å—çš„å†™æ³•å¦‚ä¸‹ã€‚

// main.js

import * as math from 'circleplus';
import exp from 'circleplus';
console.log(exp(math.e));
ä¸Šé¢ä»£ç ä¸­çš„import expè¡¨ç¤ºï¼Œå°†circleplusæ¨¡å—çš„é»˜è®¤æ–¹æ³•åŠ è½½ä¸ºexpæ–¹æ³•ã€‚

ES6æ¨¡å—åŠ è½½çš„å®è´¨
ES6æ¨¡å—åŠ è½½çš„æœºåˆ¶ï¼Œä¸CommonJSæ¨¡å—å®Œå…¨ä¸åŒã€‚CommonJSæ¨¡å—è¾“å‡ºçš„æ˜¯ä¸€ä¸ªå€¼çš„æ‹·è´ï¼Œè€ŒES6æ¨¡å—è¾“å‡ºçš„æ˜¯å€¼çš„å¼•ç”¨ã€‚

CommonJSæ¨¡å—è¾“å‡ºçš„æ˜¯è¢«è¾“å‡ºå€¼çš„æ‹·è´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦è¾“å‡ºä¸€ä¸ªå€¼ï¼Œæ¨¡å—å†…éƒ¨çš„å˜åŒ–å°±å½±å“ä¸åˆ°è¿™ä¸ªå€¼ã€‚è¯·çœ‹ä¸‹é¢è¿™ä¸ªæ¨¡å—æ–‡ä»¶lib.jsçš„ä¾‹å­ã€‚

// lib.js
var counter = 3;
function incCounter() {
  counter++;
}
module.exports = {
  counter: counter,
  incCounter: incCounter,
};
ä¸Šé¢ä»£ç è¾“å‡ºå†…éƒ¨å˜é‡counterå’Œæ”¹å†™è¿™ä¸ªå˜é‡çš„å†…éƒ¨æ–¹æ³•incCounterã€‚ç„¶åï¼Œåœ¨main.jsé‡Œé¢åŠ è½½è¿™ä¸ªæ¨¡å—ã€‚

// main.js
var mod = require('./lib');

console.log(mod.counter);  // 3
mod.incCounter();
console.log(mod.counter); // 3
ä¸Šé¢ä»£ç è¯´æ˜ï¼Œlib.jsæ¨¡å—åŠ è½½ä»¥åï¼Œå®ƒçš„å†…éƒ¨å˜åŒ–å°±å½±å“ä¸åˆ°è¾“å‡ºçš„mod.counteräº†ã€‚è¿™æ˜¯å› ä¸ºmod.counteræ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹çš„å€¼ï¼Œä¼šè¢«ç¼“å­˜ã€‚é™¤éå†™æˆä¸€ä¸ªå‡½æ•°ï¼Œæ‰èƒ½å¾—åˆ°å†…éƒ¨å˜åŠ¨åçš„å€¼ã€‚

// lib.js
var counter = 3;
function incCounter() {
  counter++;
}
module.exports = {
  get counter() {
    return counter
  },
  incCounter: incCounter,
};
ä¸Šé¢ä»£ç ä¸­ï¼Œè¾“å‡ºçš„counterå±æ€§å®é™…ä¸Šæ˜¯ä¸€ä¸ªå–å€¼å™¨å‡½æ•°ã€‚ç°åœ¨å†æ‰§è¡Œmain.jsï¼Œå°±å¯ä»¥æ­£ç¡®è¯»å–å†…éƒ¨å˜é‡counterçš„å˜åŠ¨äº†ã€‚

$ node main.js
3
4
ES6æ¨¡å—çš„è¿è¡Œæœºåˆ¶ä¸CommonJSä¸ä¸€æ ·ï¼Œå®ƒé‡åˆ°æ¨¡å—åŠ è½½å‘½ä»¤importæ—¶ï¼Œä¸ä¼šå»æ‰§è¡Œæ¨¡å—ï¼Œè€Œæ˜¯åªç”Ÿæˆä¸€ä¸ªåŠ¨æ€çš„åªè¯»å¼•ç”¨ã€‚ç­‰åˆ°çœŸçš„éœ€è¦ç”¨åˆ°æ—¶ï¼Œå†åˆ°æ¨¡å—é‡Œé¢å»å–å€¼ï¼Œæ¢å¥è¯è¯´ï¼ŒES6çš„è¾“å…¥æœ‰ç‚¹åƒUnixç³»ç»Ÿçš„â€œç¬¦å·è¿æ¥â€ï¼ŒåŸå§‹å€¼å˜äº†ï¼Œimportè¾“å…¥çš„å€¼ä¹Ÿä¼šè·Ÿç€å˜ã€‚å› æ­¤ï¼ŒES6æ¨¡å—æ˜¯åŠ¨æ€å¼•ç”¨ï¼Œå¹¶ä¸”ä¸ä¼šç¼“å­˜å€¼ï¼Œæ¨¡å—é‡Œé¢çš„å˜é‡ç»‘å®šå…¶æ‰€åœ¨çš„æ¨¡å—ã€‚

è¿˜æ˜¯ä¸¾ä¸Šé¢çš„ä¾‹å­ã€‚

// lib.js
export let counter = 3;
export function incCounter() {
  counter++;
}

// main.js
import { counter, incCounter } from './lib';
console.log(counter); // 3
incCounter();
console.log(counter); // 4
ä¸Šé¢ä»£ç è¯´æ˜ï¼ŒES6æ¨¡å—è¾“å…¥çš„å˜é‡counteræ˜¯æ´»çš„ï¼Œå®Œå…¨ååº”å…¶æ‰€åœ¨æ¨¡å—lib.jså†…éƒ¨çš„å˜åŒ–ã€‚

å†ä¸¾ä¸€ä¸ªå‡ºç°åœ¨exportä¸€èŠ‚ä¸­çš„ä¾‹å­ã€‚

// m1.js
export var foo = 'bar';
setTimeout(() => foo = 'baz', 500);

// m2.js
import {foo} from './m1.js';
console.log(foo);
setTimeout(() => console.log(foo), 500);
ä¸Šé¢ä»£ç ä¸­ï¼Œm1.jsçš„å˜é‡fooï¼Œåœ¨åˆšåŠ è½½æ—¶ç­‰äºbarï¼Œè¿‡äº†500æ¯«ç§’ï¼Œåˆå˜ä¸ºç­‰äºbazã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ï¼Œm2.jsèƒ½å¦æ­£ç¡®è¯»å–è¿™ä¸ªå˜åŒ–ã€‚

$ babel-node m2.js

bar
baz
ä¸Šé¢ä»£ç è¡¨æ˜ï¼ŒES6æ¨¡å—ä¸ä¼šç¼“å­˜è¿è¡Œç»“æœï¼Œè€Œæ˜¯åŠ¨æ€åœ°å»è¢«åŠ è½½çš„æ¨¡å—å–å€¼ï¼Œå¹¶ä¸”å˜é‡æ€»æ˜¯ç»‘å®šå…¶æ‰€åœ¨çš„æ¨¡å—ã€‚

ç”±äºES6è¾“å…¥çš„æ¨¡å—å˜é‡ï¼Œåªæ˜¯ä¸€ä¸ªâ€œç¬¦å·è¿æ¥â€ï¼Œæ‰€ä»¥è¿™ä¸ªå˜é‡æ˜¯åªè¯»çš„ï¼Œå¯¹å®ƒè¿›è¡Œé‡æ–°èµ‹å€¼ä¼šæŠ¥é”™ã€‚

// lib.js
export let obj = {};

// main.js
import { obj } from './lib';

obj.prop = 123; // OK
obj = {}; // TypeError
ä¸Šé¢ä»£ç ä¸­ï¼Œmain.jsä»lib.jsè¾“å…¥å˜é‡objï¼Œå¯ä»¥å¯¹objæ·»åŠ å±æ€§ï¼Œä½†æ˜¯é‡æ–°èµ‹å€¼å°±ä¼šæŠ¥é”™ã€‚å› ä¸ºå˜é‡objæŒ‡å‘çš„åœ°å€æ˜¯åªè¯»çš„ï¼Œä¸èƒ½é‡æ–°èµ‹å€¼ï¼Œè¿™å°±å¥½æ¯”main.jsåˆ›é€ äº†ä¸€ä¸ªåä¸ºobjçš„constå˜é‡ã€‚

æœ€åï¼Œexporté€šè¿‡æ¥å£ï¼Œè¾“å‡ºçš„æ˜¯åŒä¸€ä¸ªå€¼ã€‚ä¸åŒçš„è„šæœ¬åŠ è½½è¿™ä¸ªæ¥å£ï¼Œå¾—åˆ°çš„éƒ½æ˜¯åŒæ ·çš„å®ä¾‹ã€‚

// mod.js
function C() {
  this.sum = 0;
  this.add = function () {
    this.sum += 1;
  };
  this.show = function () {
    console.log(this.sum);
  };
}

export let c = new C();
ä¸Šé¢çš„è„šæœ¬mod.jsï¼Œè¾“å‡ºçš„æ˜¯ä¸€ä¸ªCçš„å®ä¾‹ã€‚ä¸åŒçš„è„šæœ¬åŠ è½½è¿™ä¸ªæ¨¡å—ï¼Œå¾—åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚

// x.js
import {c} from './mod';
c.add();

// y.js
import {c} from './mod';
c.show();

// main.js
import './x';
import './y';
ç°åœ¨æ‰§è¡Œmain.jsï¼Œè¾“å‡ºçš„æ˜¯1ã€‚

$ babel-node main.js
1
è¿™å°±è¯æ˜äº†x.jså’Œy.jsåŠ è½½çš„éƒ½æ˜¯Cçš„åŒä¸€ä¸ªå®ä¾‹ã€‚

æµè§ˆå™¨çš„æ¨¡å—åŠ è½½
æµè§ˆå™¨ä½¿ç”¨ ES6 æ¨¡å—çš„è¯­æ³•å¦‚ä¸‹ã€‚

<script type="module" src="foo.js"></script>
ä¸Šé¢ä»£ç åœ¨ç½‘é¡µä¸­æ’å…¥ä¸€ä¸ªæ¨¡å—foo.jsï¼Œç”±äºtypeå±æ€§è®¾ä¸ºmoduleï¼Œæ‰€ä»¥æµè§ˆå™¨çŸ¥é“è¿™æ˜¯ä¸€ä¸ª ES6 æ¨¡å—ã€‚

æµè§ˆå™¨å¯¹äºå¸¦æœ‰type="module"çš„<script>ï¼Œéƒ½æ˜¯å¼‚æ­¥åŠ è½½å¤–éƒ¨è„šæœ¬ï¼Œä¸ä¼šé€ æˆå µå¡æµè§ˆå™¨ã€‚

å¯¹äºå¤–éƒ¨çš„æ¨¡å—è„šæœ¬ï¼ˆä¸Šä¾‹æ˜¯foo.jsï¼‰ï¼Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚

è¯¥è„šæœ¬è‡ªåŠ¨é‡‡ç”¨ä¸¥æ ¼æ¨¡å—ã€‚
è¯¥è„šæœ¬å†…éƒ¨çš„é¡¶å±‚å˜é‡ï¼Œéƒ½åªåœ¨è¯¥è„šæœ¬å†…éƒ¨æœ‰æ•ˆï¼Œå¤–éƒ¨ä¸å¯è§ã€‚
è¯¥è„šæœ¬å†…éƒ¨çš„é¡¶å±‚çš„thiså…³é”®å­—ï¼Œè¿”å›undefinedï¼Œè€Œä¸æ˜¯æŒ‡å‘windowã€‚
å¾ªç¯åŠ è½½
â€œå¾ªç¯åŠ è½½â€ï¼ˆcircular dependencyï¼‰æŒ‡çš„æ˜¯ï¼Œaè„šæœ¬çš„æ‰§è¡Œä¾èµ–bè„šæœ¬ï¼Œè€Œbè„šæœ¬çš„æ‰§è¡Œåˆä¾èµ–aè„šæœ¬ã€‚

// a.js
var b = require('b');

// b.js
var a = require('a');
é€šå¸¸ï¼Œâ€œå¾ªç¯åŠ è½½â€è¡¨ç¤ºå­˜åœ¨å¼ºè€¦åˆï¼Œå¦‚æœå¤„ç†ä¸å¥½ï¼Œè¿˜å¯èƒ½å¯¼è‡´é€’å½’åŠ è½½ï¼Œä½¿å¾—ç¨‹åºæ— æ³•æ‰§è¡Œï¼Œå› æ­¤åº”è¯¥é¿å…å‡ºç°ã€‚

ä½†æ˜¯å®é™…ä¸Šï¼Œè¿™æ˜¯å¾ˆéš¾é¿å…çš„ï¼Œå°¤å…¶æ˜¯ä¾èµ–å…³ç³»å¤æ‚çš„å¤§é¡¹ç›®ï¼Œå¾ˆå®¹æ˜“å‡ºç°aä¾èµ–bï¼Œbä¾èµ–cï¼Œcåˆä¾èµ–aè¿™æ ·çš„æƒ…å†µã€‚è¿™æ„å‘³ç€ï¼Œæ¨¡å—åŠ è½½æœºåˆ¶å¿…é¡»è€ƒè™‘â€œå¾ªç¯åŠ è½½â€çš„æƒ…å†µã€‚

å¯¹äºJavaScriptè¯­è¨€æ¥è¯´ï¼Œç›®å‰æœ€å¸¸è§çš„ä¸¤ç§æ¨¡å—æ ¼å¼CommonJSå’ŒES6ï¼Œå¤„ç†â€œå¾ªç¯åŠ è½½â€çš„æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿”å›çš„ç»“æœä¹Ÿä¸ä¸€æ ·ã€‚

CommonJSæ¨¡å—çš„åŠ è½½åŸç†
ä»‹ç»ES6å¦‚ä½•å¤„ç†"å¾ªç¯åŠ è½½"ä¹‹å‰ï¼Œå…ˆä»‹ç»ç›®å‰æœ€æµè¡Œçš„CommonJSæ¨¡å—æ ¼å¼çš„åŠ è½½åŸç†ã€‚

CommonJSçš„ä¸€ä¸ªæ¨¡å—ï¼Œå°±æ˜¯ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ã€‚requireå‘½ä»¤ç¬¬ä¸€æ¬¡åŠ è½½è¯¥è„šæœ¬ï¼Œå°±ä¼šæ‰§è¡Œæ•´ä¸ªè„šæœ¬ï¼Œç„¶ååœ¨å†…å­˜ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ã€‚

{
  id: '...',
  exports: { ... },
  loaded: true,
  ...
}
ä¸Šé¢ä»£ç å°±æ˜¯Nodeå†…éƒ¨åŠ è½½æ¨¡å—åç”Ÿæˆçš„ä¸€ä¸ªå¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„idå±æ€§æ˜¯æ¨¡å—åï¼Œexportså±æ€§æ˜¯æ¨¡å—è¾“å‡ºçš„å„ä¸ªæ¥å£ï¼Œloadedå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥æ¨¡å—çš„è„šæœ¬æ˜¯å¦æ‰§è¡Œå®Œæ¯•ã€‚å…¶ä»–è¿˜æœ‰å¾ˆå¤šå±æ€§ï¼Œè¿™é‡Œéƒ½çœç•¥äº†ã€‚

ä»¥åéœ€è¦ç”¨åˆ°è¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œå°±ä¼šåˆ°exportså±æ€§ä¸Šé¢å–å€¼ã€‚å³ä½¿å†æ¬¡æ‰§è¡Œrequireå‘½ä»¤ï¼Œä¹Ÿä¸ä¼šå†æ¬¡æ‰§è¡Œè¯¥æ¨¡å—ï¼Œè€Œæ˜¯åˆ°ç¼“å­˜ä¹‹ä¸­å–å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCommonJSæ¨¡å—æ— è®ºåŠ è½½å¤šå°‘æ¬¡ï¼Œéƒ½åªä¼šåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶è¿è¡Œä¸€æ¬¡ï¼Œä»¥åå†åŠ è½½ï¼Œå°±è¿”å›ç¬¬ä¸€æ¬¡è¿è¡Œçš„ç»“æœï¼Œé™¤éæ‰‹åŠ¨æ¸…é™¤ç³»ç»Ÿç¼“å­˜ã€‚

CommonJSæ¨¡å—çš„å¾ªç¯åŠ è½½
CommonJSæ¨¡å—çš„é‡è¦ç‰¹æ€§æ˜¯åŠ è½½æ—¶æ‰§è¡Œï¼Œå³è„šæœ¬ä»£ç åœ¨requireçš„æ—¶å€™ï¼Œå°±ä¼šå…¨éƒ¨æ‰§è¡Œã€‚ä¸€æ—¦å‡ºç°æŸä¸ªæ¨¡å—è¢«"å¾ªç¯åŠ è½½"ï¼Œå°±åªè¾“å‡ºå·²ç»æ‰§è¡Œçš„éƒ¨åˆ†ï¼Œè¿˜æœªæ‰§è¡Œçš„éƒ¨åˆ†ä¸ä¼šè¾“å‡ºã€‚

è®©æˆ‘ä»¬æ¥çœ‹ï¼ŒNodeå®˜æ–¹æ–‡æ¡£é‡Œé¢çš„ä¾‹å­ã€‚è„šæœ¬æ–‡ä»¶a.jsä»£ç å¦‚ä¸‹ã€‚

exports.done = false;
var b = require('./b.js');
console.log('åœ¨ a.js ä¹‹ä¸­ï¼Œb.done = %j', b.done);
exports.done = true;
console.log('a.js æ‰§è¡Œå®Œæ¯•');
ä¸Šé¢ä»£ç ä¹‹ä¸­ï¼Œa.jsè„šæœ¬å…ˆè¾“å‡ºä¸€ä¸ªdoneå˜é‡ï¼Œç„¶ååŠ è½½å¦ä¸€ä¸ªè„šæœ¬æ–‡ä»¶b.jsã€‚æ³¨æ„ï¼Œæ­¤æ—¶a.jsä»£ç å°±åœåœ¨è¿™é‡Œï¼Œç­‰å¾…b.jsæ‰§è¡Œå®Œæ¯•ï¼Œå†å¾€ä¸‹æ‰§è¡Œã€‚

å†çœ‹b.jsçš„ä»£ç ã€‚

exports.done = false;
var a = require('./a.js');
console.log('åœ¨ b.js ä¹‹ä¸­ï¼Œa.done = %j', a.done);
exports.done = true;
console.log('b.js æ‰§è¡Œå®Œæ¯•');
ä¸Šé¢ä»£ç ä¹‹ä¸­ï¼Œb.jsæ‰§è¡Œåˆ°ç¬¬äºŒè¡Œï¼Œå°±ä¼šå»åŠ è½½a.jsï¼Œè¿™æ—¶ï¼Œå°±å‘ç”Ÿäº†â€œå¾ªç¯åŠ è½½â€ã€‚ç³»ç»Ÿä¼šå»a.jsæ¨¡å—å¯¹åº”å¯¹è±¡çš„exportså±æ€§å–å€¼ï¼Œå¯æ˜¯å› ä¸ºa.jsè¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä»exportså±æ€§åªèƒ½å–å›å·²ç»æ‰§è¡Œçš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æœ€åçš„å€¼ã€‚

a.jså·²ç»æ‰§è¡Œçš„éƒ¨åˆ†ï¼Œåªæœ‰ä¸€è¡Œã€‚

exports.done = false;
å› æ­¤ï¼Œå¯¹äºb.jsæ¥è¯´ï¼Œå®ƒä»a.jsåªè¾“å…¥ä¸€ä¸ªå˜é‡doneï¼Œå€¼ä¸ºfalseã€‚

ç„¶åï¼Œb.jsæ¥ç€å¾€ä¸‹æ‰§è¡Œï¼Œç­‰åˆ°å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œå†æŠŠæ‰§è¡Œæƒäº¤è¿˜ç»™a.jsã€‚äºæ˜¯ï¼Œa.jsæ¥ç€å¾€ä¸‹æ‰§è¡Œï¼Œç›´åˆ°æ‰§è¡Œå®Œæ¯•ã€‚æˆ‘ä»¬å†™ä¸€ä¸ªè„šæœ¬main.jsï¼ŒéªŒè¯è¿™ä¸ªè¿‡ç¨‹ã€‚

var a = require('./a.js');
var b = require('./b.js');
console.log('åœ¨ main.js ä¹‹ä¸­, a.done=%j, b.done=%j', a.done, b.done);
æ‰§è¡Œmain.jsï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ã€‚

$ node main.js

åœ¨ b.js ä¹‹ä¸­ï¼Œa.done = false
b.js æ‰§è¡Œå®Œæ¯•
åœ¨ a.js ä¹‹ä¸­ï¼Œb.done = true
a.js æ‰§è¡Œå®Œæ¯•
åœ¨ main.js ä¹‹ä¸­, a.done=true, b.done=true
ä¸Šé¢çš„ä»£ç è¯æ˜äº†ä¸¤ä»¶äº‹ã€‚ä¸€æ˜¯ï¼Œåœ¨b.jsä¹‹ä¸­ï¼Œa.jsæ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåªæ‰§è¡Œäº†ç¬¬ä¸€è¡Œã€‚äºŒæ˜¯ï¼Œmain.jsæ‰§è¡Œåˆ°ç¬¬äºŒè¡Œæ—¶ï¼Œä¸ä¼šå†æ¬¡æ‰§è¡Œb.jsï¼Œè€Œæ˜¯è¾“å‡ºç¼“å­˜çš„b.jsçš„æ‰§è¡Œç»“æœï¼Œå³å®ƒçš„ç¬¬å››è¡Œã€‚

exports.done = true;
æ€»ä¹‹ï¼ŒCommonJSè¾“å…¥çš„æ˜¯è¢«è¾“å‡ºå€¼çš„æ‹·è´ï¼Œä¸æ˜¯å¼•ç”¨ã€‚

å¦å¤–ï¼Œç”±äºCommonJSæ¨¡å—é‡åˆ°å¾ªç¯åŠ è½½æ—¶ï¼Œè¿”å›çš„æ˜¯å½“å‰å·²ç»æ‰§è¡Œçš„éƒ¨åˆ†çš„å€¼ï¼Œè€Œä¸æ˜¯ä»£ç å…¨éƒ¨æ‰§è¡Œåçš„å€¼ï¼Œä¸¤è€…å¯èƒ½ä¼šæœ‰å·®å¼‚ã€‚æ‰€ä»¥ï¼Œè¾“å…¥å˜é‡çš„æ—¶å€™ï¼Œå¿…é¡»éå¸¸å°å¿ƒã€‚

var a = require('a'); // å®‰å…¨çš„å†™æ³•
var foo = require('a').foo; // å±é™©çš„å†™æ³•

exports.good = function (arg) {
  return a.foo('good', arg); // ä½¿ç”¨çš„æ˜¯ a.foo çš„æœ€æ–°å€¼
};

exports.bad = function (arg) {
  return foo('bad', arg); // ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªéƒ¨åˆ†åŠ è½½æ—¶çš„å€¼
};
ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœå‘ç”Ÿå¾ªç¯åŠ è½½ï¼Œrequire('a').fooçš„å€¼å¾ˆå¯èƒ½åé¢ä¼šè¢«æ”¹å†™ï¼Œæ”¹ç”¨require('a')ä¼šæ›´ä¿é™©ä¸€ç‚¹ã€‚

ES6æ¨¡å—çš„å¾ªç¯åŠ è½½
ES6å¤„ç†â€œå¾ªç¯åŠ è½½â€ä¸CommonJSæœ‰æœ¬è´¨çš„ä¸åŒã€‚ES6æ¨¡å—æ˜¯åŠ¨æ€å¼•ç”¨ï¼Œå¦‚æœä½¿ç”¨importä»ä¸€ä¸ªæ¨¡å—åŠ è½½å˜é‡ï¼ˆå³import foo from 'foo'ï¼‰ï¼Œé‚£äº›å˜é‡ä¸ä¼šè¢«ç¼“å­˜ï¼Œè€Œæ˜¯æˆä¸ºä¸€ä¸ªæŒ‡å‘è¢«åŠ è½½æ¨¡å—çš„å¼•ç”¨ï¼Œéœ€è¦å¼€å‘è€…è‡ªå·±ä¿è¯ï¼ŒçœŸæ­£å–å€¼çš„æ—¶å€™èƒ½å¤Ÿå–åˆ°å€¼ã€‚

è¯·çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚

// a.jså¦‚ä¸‹
import {bar} from './b.js';
console.log('a.js');
console.log(bar);
export let foo = 'foo';

// b.js
import {foo} from './a.js';
console.log('b.js');
console.log(foo);
export let bar = 'bar';
ä¸Šé¢ä»£ç ä¸­ï¼Œa.jsåŠ è½½b.jsï¼Œb.jsåˆåŠ è½½a.jsï¼Œæ„æˆå¾ªç¯åŠ è½½ã€‚æ‰§è¡Œa.jsï¼Œç»“æœå¦‚ä¸‹ã€‚

$ babel-node a.js
b.js
undefined
a.js
bar
ä¸Šé¢ä»£ç ä¸­ï¼Œç”±äºa.jsçš„ç¬¬ä¸€è¡Œæ˜¯åŠ è½½b.jsï¼Œæ‰€ä»¥å…ˆæ‰§è¡Œçš„æ˜¯b.jsã€‚è€Œb.jsçš„ç¬¬ä¸€è¡Œåˆæ˜¯åŠ è½½a.jsï¼Œè¿™æ—¶ç”±äºa.jså·²ç»å¼€å§‹æ‰§è¡Œäº†ï¼Œæ‰€ä»¥ä¸ä¼šé‡å¤æ‰§è¡Œï¼Œè€Œæ˜¯ç»§ç»­å¾€ä¸‹æ‰§è¡Œb.jsï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œè¾“å‡ºçš„æ˜¯b.jsã€‚

æ¥ç€ï¼Œb.jsè¦æ‰“å°å˜é‡fooï¼Œè¿™æ—¶a.jsè¿˜æ²¡æ‰§è¡Œå®Œï¼Œå–ä¸åˆ°fooçš„å€¼ï¼Œå¯¼è‡´æ‰“å°å‡ºæ¥æ˜¯undefinedã€‚b.jsæ‰§è¡Œå®Œï¼Œå¼€å§‹æ‰§è¡Œa.jsï¼Œè¿™æ—¶å°±ä¸€åˆ‡æ­£å¸¸äº†ã€‚

å†çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚çš„ä¾‹å­ï¼ˆæ‘˜è‡ª Dr. Axel Rauschmayer çš„ã€ŠExploring ES6ã€‹ï¼‰ã€‚

// a.js
import {bar} from './b.js';
export function foo() {
  console.log('foo');
  bar();
  console.log('æ‰§è¡Œå®Œæ¯•');
}
foo();

// b.js
import {foo} from './a.js';
export function bar() {
  console.log('bar');
  if (Math.random() > 0.5) {
    foo();
  }
}
æŒ‰ç…§CommonJSè§„èŒƒï¼Œä¸Šé¢çš„ä»£ç æ˜¯æ²¡æ³•æ‰§è¡Œçš„ã€‚aå…ˆåŠ è½½bï¼Œç„¶åbåˆåŠ è½½aï¼Œè¿™æ—¶aè¿˜æ²¡æœ‰ä»»ä½•æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥è¾“å‡ºç»“æœä¸ºnullï¼Œå³å¯¹äºb.jsæ¥è¯´ï¼Œå˜é‡fooçš„å€¼ç­‰äºnullï¼Œåé¢çš„foo()å°±ä¼šæŠ¥é”™ã€‚

ä½†æ˜¯ï¼ŒES6å¯ä»¥æ‰§è¡Œä¸Šé¢çš„ä»£ç ã€‚

$ babel-node a.js
foo
bar
æ‰§è¡Œå®Œæ¯•

// æ‰§è¡Œç»“æœä¹Ÿæœ‰å¯èƒ½æ˜¯
foo
bar
foo
bar
æ‰§è¡Œå®Œæ¯•
æ‰§è¡Œå®Œæ¯•
ä¸Šé¢ä»£ç ä¸­ï¼Œa.jsä¹‹æ‰€ä»¥èƒ½å¤Ÿæ‰§è¡Œï¼ŒåŸå› å°±åœ¨äºES6åŠ è½½çš„å˜é‡ï¼Œéƒ½æ˜¯åŠ¨æ€å¼•ç”¨å…¶æ‰€åœ¨çš„æ¨¡å—ã€‚åªè¦å¼•ç”¨å­˜åœ¨ï¼Œä»£ç å°±èƒ½æ‰§è¡Œã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†æè¿™æ®µä»£ç çš„è¿è¡Œè¿‡ç¨‹ã€‚

// a.js

// è¿™ä¸€è¡Œå»ºç«‹ä¸€ä¸ªå¼•ç”¨ï¼Œ
// ä»`b.js`å¼•ç”¨`bar`
import {bar} from './b.js';

export function foo() {
  // æ‰§è¡Œæ—¶ç¬¬ä¸€è¡Œè¾“å‡º foo
  console.log('foo');
  // åˆ° b.js æ‰§è¡Œ bar
  bar();
  console.log('æ‰§è¡Œå®Œæ¯•');
}
foo();

// b.js

// å»ºç«‹`a.js`çš„`foo`å¼•ç”¨
import {foo} from './a.js';

export function bar() {
  // æ‰§è¡Œæ—¶ï¼Œç¬¬äºŒè¡Œè¾“å‡º bar
  console.log('bar');
  // é€’å½’æ‰§è¡Œ fooï¼Œä¸€æ—¦éšæœºæ•°
  // å°äºç­‰äº0.5ï¼Œå°±åœæ­¢æ‰§è¡Œ
  if (Math.random() > 0.5) {
    foo();
  }
}
æˆ‘ä»¬å†æ¥çœ‹ES6æ¨¡å—åŠ è½½å™¨SystemJSç»™å‡ºçš„ä¸€ä¸ªä¾‹å­ã€‚

// even.js
import { odd } from './odd'
export var counter = 0;
export function even(n) {
  counter++;
  return n == 0 || odd(n - 1);
}

// odd.js
import { even } from './even';
export function odd(n) {
  return n != 0 && even(n - 1);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œeven.jsé‡Œé¢çš„å‡½æ•°evenæœ‰ä¸€ä¸ªå‚æ•°nï¼Œåªè¦ä¸ç­‰äº0ï¼Œå°±ä¼šå‡å»1ï¼Œä¼ å…¥åŠ è½½çš„odd()ã€‚odd.jsä¹Ÿä¼šåšç±»ä¼¼æ“ä½œã€‚

è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ï¼Œç»“æœå¦‚ä¸‹ã€‚

$ babel-node
> import * as m from './even.js';
> m.even(10);
true
> m.counter
6
> m.even(20)
true
> m.counter
17
ä¸Šé¢ä»£ç ä¸­ï¼Œå‚æ•°nä»10å˜ä¸º0çš„è¿‡ç¨‹ä¸­ï¼Œeven()ä¸€å…±ä¼šæ‰§è¡Œ6æ¬¡ï¼Œæ‰€ä»¥å˜é‡counterç­‰äº6ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨even()æ—¶ï¼Œå‚æ•°nä»20å˜ä¸º0ï¼Œeven()ä¸€å…±ä¼šæ‰§è¡Œ11æ¬¡ï¼ŒåŠ ä¸Šå‰é¢çš„6æ¬¡ï¼Œæ‰€ä»¥å˜é‡counterç­‰äº17ã€‚

è¿™ä¸ªä¾‹å­è¦æ˜¯æ”¹å†™æˆCommonJSï¼Œå°±æ ¹æœ¬æ— æ³•æ‰§è¡Œï¼Œä¼šæŠ¥é”™ã€‚

// even.js
var odd = require('./odd');
var counter = 0;
exports.counter = counter;
exports.even = function(n) {
  counter++;
  return n == 0 || odd(n - 1);
}

// odd.js
var even = require('./even').even;
module.exports = function(n) {
  return n != 0 && even(n - 1);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œeven.jsåŠ è½½odd.jsï¼Œè€Œodd.jsåˆå»åŠ è½½even.jsï¼Œå½¢æˆâ€œå¾ªç¯åŠ è½½â€ã€‚è¿™æ—¶ï¼Œæ‰§è¡Œå¼•æ“å°±ä¼šè¾“å‡ºeven.jså·²ç»æ‰§è¡Œçš„éƒ¨åˆ†ï¼ˆä¸å­˜åœ¨ä»»ä½•ç»“æœï¼‰ï¼Œæ‰€ä»¥åœ¨odd.jsä¹‹ä¸­ï¼Œå˜é‡evenç­‰äºnullï¼Œç­‰åˆ°åé¢è°ƒç”¨even(n-1)å°±ä¼šæŠ¥é”™ã€‚

$ node
> var m = require('./even');
> m.even(10)
TypeError: even is not a function
è·¨æ¨¡å—å¸¸é‡
æœ¬ä¹¦ä»‹ç»constå‘½ä»¤çš„æ—¶å€™è¯´è¿‡ï¼Œconstå£°æ˜çš„å¸¸é‡åªåœ¨å½“å‰ä»£ç å—æœ‰æ•ˆã€‚å¦‚æœæƒ³è®¾ç½®è·¨æ¨¡å—çš„å¸¸é‡ï¼ˆå³è·¨å¤šä¸ªæ–‡ä»¶ï¼‰ï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚

// constants.js æ¨¡å—
export const A = 1;
export const B = 3;
export const C = 4;

// test1.js æ¨¡å—
import * as constants from './constants';
console.log(constants.A); // 1
console.log(constants.B); // 3

// test2.js æ¨¡å—
import {A, B} from './constants';
console.log(A); // 1
console.log(B); // 3
å¦‚æœè¦ä½¿ç”¨çš„å¸¸é‡éå¸¸å¤šï¼Œå¯ä»¥å»ºä¸€ä¸ªä¸“é—¨çš„constantsç›®å½•ï¼Œå°†å„ç§å¸¸é‡å†™åœ¨ä¸åŒçš„æ–‡ä»¶é‡Œé¢ï¼Œä¿å­˜åœ¨è¯¥ç›®å½•ä¸‹ã€‚

// constants/db.js
export const db = {
  url: 'http://my.couchdbserver.local:5984',
  admin_username: 'admin',
  admin_password: 'admin password'
};

// constants/user.js
export const users = ['root', 'admin', 'staff', 'ceo', 'chief', 'moderator'];
ç„¶åï¼Œå°†è¿™äº›æ–‡ä»¶è¾“å‡ºçš„å¸¸é‡ï¼Œåˆå¹¶åœ¨index.jsé‡Œé¢ã€‚

// constants/index.js
export {db} from './db';
export {users} from './users';
ä½¿ç”¨çš„æ—¶å€™ï¼Œç›´æ¥åŠ è½½index.jså°±å¯ä»¥äº†ã€‚

// script.js
import {db, users} from './constants';
import()
ä¸Šé¢è¯´è¿‡äº†ï¼Œimportè¯­å¥ä¼šè¢«JavaScriptå¼•æ“é™æ€åˆ†æï¼Œå…ˆäºæ¨¡å—å†…çš„å…¶ä»–æ¨¡å—æ‰§è¡Œï¼ˆå«åšâ€è¿æ¥â€œæ›´åˆé€‚ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸‹é¢çš„ä»£ç ä¼šæŠ¥é”™ã€‚

// æŠ¥é”™
if (x === 2) {
  import MyModual from './myModual';
}
ä¸Šé¢ä»£ç ä¸­ï¼Œå¼•æ“å¤„ç†importè¯­å¥æ˜¯åœ¨æ‰§è¡Œä¹‹å‰ï¼Œæ‰€ä»¥importè¯­å¥æ”¾åœ¨ifä»£ç å—ä¹‹ä¸­æ¯«æ— æ„ä¹‰ï¼Œå› æ­¤ä¼šæŠ¥å¥æ³•é”™è¯¯ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ—¶é”™è¯¯ã€‚

è¿™æ ·çš„è®¾è®¡ï¼Œå›ºç„¶æœ‰åˆ©äºç¼–è¯‘å™¨æé«˜æ•ˆç‡ï¼Œä½†ä¹Ÿå¯¼è‡´æ— æ³•åœ¨è¿è¡Œæ—¶åŠ è½½æ¨¡å—ã€‚ä»é•¿è¿œæ¥çœ‹ï¼Œimportè¯­å¥ä¼šå–ä»£ Node çš„requireæ–¹æ³•ï¼Œä½†æ˜¯requireæ˜¯è¿è¡Œæ—¶åŠ è½½æ¨¡å—ï¼Œimportè¯­å¥æ˜¾ç„¶æ— æ³•å–ä»£è¿™ç§åŠ¨æ€åŠ è½½åŠŸèƒ½ã€‚

const path = './' + fileName;
const myModual = require(path);
ä¸Šé¢çš„è¯­å¥å°±æ˜¯åŠ¨æ€åŠ è½½ï¼Œrequireåˆ°åº•åŠ è½½å“ªä¸€ä¸ªæ¨¡å—ï¼Œåªæœ‰è¿è¡Œæ—¶æ‰çŸ¥é“ã€‚importè¯­å¥åšä¸åˆ°è¿™ä¸€ç‚¹ã€‚

å› æ­¤ï¼Œæœ‰ä¸€ä¸ªææ¡ˆï¼Œå»ºè®®å¼•å…¥import()å‡½æ•°ï¼Œå®ŒæˆåŠ¨æ€åŠ è½½ã€‚

import(specifier)
ä¸Šé¢ä»£ç ä¸­ï¼Œimportå‡½æ•°çš„å‚æ•°specifierï¼ŒæŒ‡å®šæ‰€è¦åŠ è½½çš„æ¨¡å—çš„ä½ç½®ã€‚importè¯­å¥èƒ½å¤Ÿæ¥å—ä»€ä¹ˆå‚æ•°ï¼Œimport()å‡½æ•°å°±èƒ½æ¥å—ä»€ä¹ˆå‚æ•°ï¼Œä¸¤è€…åŒºåˆ«ä¸»è¦æ˜¯åè€…ä¸ºåŠ¨æ€åŠ è½½ã€‚

import()è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

const main = document.querySelector('main');

import(`./section-modules/${someVariable}.js`)
  .then(module => {
    module.loadPageInto(main);
  })
  .catch(err => {
    main.textContent = err.message;
  });
import()å‡½æ•°å¯ä»¥ç”¨åœ¨ä»»ä½•åœ°æ–¹ï¼Œä¸ä»…ä»…æ˜¯æ¨¡å—ï¼Œéæ¨¡å—çš„è„šæœ¬ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚å®ƒæ˜¯è¿è¡Œæ—¶æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»€ä¹ˆæ—¶å€™è¿è¡Œåˆ°è¿™ä¸€å¥ï¼Œä¹Ÿä¼šåŠ è½½æŒ‡å®šçš„æ¨¡å—ã€‚å¦å¤–ï¼Œimport()å‡½æ•°ä¸æ‰€åŠ è½½çš„æ¨¡å—æ²¡æœ‰é™æ€è¿æ¥å…³ç³»ï¼Œè¿™ç‚¹ä¹Ÿæ˜¯ä¸importè¯­å¥ä¸ç›¸åŒã€‚

import()ç±»ä¼¼äº Node çš„requireæ–¹æ³•ï¼ŒåŒºåˆ«ä¸»è¦æ˜¯å‰è€…æ˜¯å¼‚æ­¥åŠ è½½ï¼Œåè€…æ˜¯åŒæ­¥åŠ è½½ã€‚

ES6æ¨¡å—çš„è½¬ç 
æµè§ˆå™¨ç›®å‰è¿˜ä¸æ”¯æŒES6æ¨¡å—ï¼Œä¸ºäº†ç°åœ¨å°±èƒ½ä½¿ç”¨ï¼Œå¯ä»¥å°†è½¬ä¸ºES5çš„å†™æ³•ã€‚é™¤äº†Babelå¯ä»¥ç”¨æ¥è½¬ç ä¹‹å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥è½¬ç ã€‚

ES6 module transpiler
ES6 module transpileræ˜¯ square å…¬å¸å¼€æºçš„ä¸€ä¸ªè½¬ç å™¨ï¼Œå¯ä»¥å°† ES6 æ¨¡å—è½¬ä¸º CommonJS æ¨¡å—æˆ– AMD æ¨¡å—çš„å†™æ³•ï¼Œä»è€Œåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ã€‚

é¦–å…ˆï¼Œå®‰è£…è¿™ä¸ªè½¬ç›å™¨ã€‚

$ npm install -g es6-module-transpiler
ç„¶åï¼Œä½¿ç”¨compile-modules convertå‘½ä»¤ï¼Œå°† ES6 æ¨¡å—æ–‡ä»¶è½¬ç ã€‚

$ compile-modules convert file1.js file2.js
-oå‚æ•°å¯ä»¥æŒ‡å®šè½¬ç åçš„æ–‡ä»¶åã€‚

$ compile-modules convert -o out.js file1.js
SystemJS
å¦ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ SystemJSã€‚å®ƒæ˜¯ä¸€ä¸ªå«ç‰‡åº“ï¼ˆpolyfillï¼‰ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨å†…åŠ è½½ ES6 æ¨¡å—ã€AMD æ¨¡å—å’Œ CommonJS æ¨¡å—ï¼Œå°†å…¶è½¬ä¸º ES5 æ ¼å¼ã€‚å®ƒåœ¨åå°è°ƒç”¨çš„æ˜¯ Google çš„ Traceur è½¬ç å™¨ã€‚

ä½¿ç”¨æ—¶ï¼Œå…ˆåœ¨ç½‘é¡µå†…è½½å…¥system.jsæ–‡ä»¶ã€‚

<script src="system.js"></script>
ç„¶åï¼Œä½¿ç”¨System.importæ–¹æ³•åŠ è½½æ¨¡å—æ–‡ä»¶ã€‚

<script>
  System.import('./app.js');
</script>
ä¸Šé¢ä»£ç ä¸­çš„./appï¼ŒæŒ‡çš„æ˜¯å½“å‰ç›®å½•ä¸‹çš„app.jsæ–‡ä»¶ã€‚å®ƒå¯ä»¥æ˜¯ES6æ¨¡å—æ–‡ä»¶ï¼ŒSystem.importä¼šè‡ªåŠ¨å°†å…¶è½¬ç ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSystem.importä½¿ç”¨å¼‚æ­¥åŠ è½½ï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¯ä»¥é’ˆå¯¹è¿™ä¸ªå¯¹è±¡ç¼–ç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡å—æ–‡ä»¶ã€‚

// app/es6-file.js:

export class q {
  constructor() {
    this.es6 = 'hello';
  }
}
ç„¶åï¼Œåœ¨ç½‘é¡µå†…åŠ è½½è¿™ä¸ªæ¨¡å—æ–‡ä»¶ã€‚

<script>

System.import('app/es6-file').then(function(m) {
  console.log(new m.q().es6); // hello
});

</script>
ä¸Šé¢ä»£ç ä¸­ï¼ŒSystem.importæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ç”¨thenæ–¹æ³•æŒ‡å®šå›è°ƒå‡½æ•°ã€‚

##ç¼–ç¨‹é£æ ¼
1.å—çº§ä½œç”¨åŸŸ
ï¼ˆ1ï¼‰let å–ä»£ var

ES6æå‡ºäº†ä¸¤ä¸ªæ–°çš„å£°æ˜å˜é‡çš„å‘½ä»¤ï¼šletå’Œconstã€‚å…¶ä¸­ï¼Œletå®Œå…¨å¯ä»¥å–ä»£varï¼Œå› ä¸ºä¸¤è€…è¯­ä¹‰ç›¸åŒï¼Œè€Œä¸”letæ²¡æœ‰å‰¯ä½œç”¨ã€‚

'use strict';

if (true) {
  let x = 'hello';
}

for (let i = 0; i < 10; i++) {
  console.log(i);
}
ä¸Šé¢ä»£ç å¦‚æœç”¨varæ›¿ä»£letï¼Œå®é™…ä¸Šå°±å£°æ˜äº†ä¸¤ä¸ªå…¨å±€å˜é‡ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æœ¬æ„ã€‚å˜é‡åº”è¯¥åªåœ¨å…¶å£°æ˜çš„ä»£ç å—å†…æœ‰æ•ˆï¼Œvarå‘½ä»¤åšä¸åˆ°è¿™ä¸€ç‚¹ã€‚

varå‘½ä»¤å­˜åœ¨å˜é‡æå‡æ•ˆç”¨ï¼Œletå‘½ä»¤æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚

'use strict';

if(true) {
  console.log(x); // ReferenceError
  let x = 'hello';
}
ä¸Šé¢ä»£ç å¦‚æœä½¿ç”¨varæ›¿ä»£letï¼Œconsole.logé‚£ä¸€è¡Œå°±ä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯ä¼šè¾“å‡ºundefinedï¼Œå› ä¸ºå˜é‡å£°æ˜æå‡åˆ°ä»£ç å—çš„å¤´éƒ¨ã€‚è¿™è¿åäº†å˜é‡å…ˆå£°æ˜åä½¿ç”¨çš„åŸåˆ™ã€‚

æ‰€ä»¥ï¼Œå»ºè®®ä¸å†ä½¿ç”¨varå‘½ä»¤ï¼Œè€Œæ˜¯ä½¿ç”¨letå‘½ä»¤å–ä»£ã€‚

ï¼ˆ2ï¼‰å…¨å±€å¸¸é‡å’Œçº¿ç¨‹å®‰å…¨

åœ¨letå’Œconstä¹‹é—´ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨constï¼Œå°¤å…¶æ˜¯åœ¨å…¨å±€ç¯å¢ƒï¼Œä¸åº”è¯¥è®¾ç½®å˜é‡ï¼Œåªåº”è®¾ç½®å¸¸é‡ã€‚

constä¼˜äºletæœ‰å‡ ä¸ªåŸå› ã€‚ä¸€ä¸ªæ˜¯constå¯ä»¥æé†’é˜…è¯»ç¨‹åºçš„äººï¼Œè¿™ä¸ªå˜é‡ä¸åº”è¯¥æ”¹å˜ï¼›å¦ä¸€ä¸ªæ˜¯constæ¯”è¾ƒç¬¦åˆå‡½æ•°å¼ç¼–ç¨‹æ€æƒ³ï¼Œè¿ç®—ä¸æ”¹å˜å€¼ï¼Œåªæ˜¯æ–°å»ºå€¼ï¼Œè€Œä¸”è¿™æ ·ä¹Ÿæœ‰åˆ©äºå°†æ¥çš„åˆ†å¸ƒå¼è¿ç®—ï¼›æœ€åä¸€ä¸ªåŸå› æ˜¯ JavaScript ç¼–è¯‘å™¨ä¼šå¯¹constè¿›è¡Œä¼˜åŒ–ï¼Œæ‰€ä»¥å¤šä½¿ç”¨constï¼Œæœ‰åˆ©äºæä¾›ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œä¹Ÿå°±æ˜¯è¯´letå’Œconstçš„æœ¬è´¨åŒºåˆ«ï¼Œå…¶å®æ˜¯ç¼–è¯‘å™¨å†…éƒ¨çš„å¤„ç†ä¸åŒã€‚

// bad
var a = 1, b = 2, c = 3;

// good
const a = 1;
const b = 2;
const c = 3;

// best
const [a, b, c] = [1, 2, 3];
constå£°æ˜å¸¸é‡è¿˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œä¸€æ˜¯é˜…è¯»ä»£ç çš„äººç«‹åˆ»ä¼šæ„è¯†åˆ°ä¸åº”è¯¥ä¿®æ”¹è¿™ä¸ªå€¼ï¼ŒäºŒæ˜¯é˜²æ­¢äº†æ— æ„é—´ä¿®æ”¹å˜é‡å€¼æ‰€å¯¼è‡´çš„é”™è¯¯ã€‚

æ‰€æœ‰çš„å‡½æ•°éƒ½åº”è¯¥è®¾ç½®ä¸ºå¸¸é‡ã€‚

é•¿è¿œæ¥çœ‹ï¼ŒJavaScriptå¯èƒ½ä¼šæœ‰å¤šçº¿ç¨‹çš„å®ç°ï¼ˆæ¯”å¦‚Intelçš„River Trailé‚£ä¸€ç±»çš„é¡¹ç›®ï¼‰ï¼Œè¿™æ—¶letè¡¨ç¤ºçš„å˜é‡ï¼Œåªåº”å‡ºç°åœ¨å•çº¿ç¨‹è¿è¡Œçš„ä»£ç ä¸­ï¼Œä¸èƒ½æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ï¼Œè¿™æ ·æœ‰åˆ©äºä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

å­—ç¬¦ä¸²
é™æ€å­—ç¬¦ä¸²ä¸€å¾‹ä½¿ç”¨å•å¼•å·æˆ–åå¼•å·ï¼Œä¸ä½¿ç”¨åŒå¼•å·ã€‚åŠ¨æ€å­—ç¬¦ä¸²ä½¿ç”¨åå¼•å·ã€‚

// bad
const a = "foobar";
const b = 'foo' + a + 'bar';

// acceptable
const c = `foobar`;

// good
const a = 'foobar';
const b = `foo${a}bar`;
const c = 'foobar';
è§£æ„èµ‹å€¼
ä½¿ç”¨æ•°ç»„æˆå‘˜å¯¹å˜é‡èµ‹å€¼æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨è§£æ„èµ‹å€¼ã€‚

const arr = [1, 2, 3, 4];

// bad
const first = arr[0];
const second = arr[1];

// good
const [first, second] = arr;
å‡½æ•°çš„å‚æ•°å¦‚æœæ˜¯å¯¹è±¡çš„æˆå‘˜ï¼Œä¼˜å…ˆä½¿ç”¨è§£æ„èµ‹å€¼ã€‚

// bad
function getFullName(user) {
  const firstName = user.firstName;
  const lastName = user.lastName;
}

// good
function getFullName(obj) {
  const { firstName, lastName } = obj;
}

// best
function getFullName({ firstName, lastName }) {
}
å¦‚æœå‡½æ•°è¿”å›å¤šä¸ªå€¼ï¼Œä¼˜å…ˆä½¿ç”¨å¯¹è±¡çš„è§£æ„èµ‹å€¼ï¼Œè€Œä¸æ˜¯æ•°ç»„çš„è§£æ„èµ‹å€¼ã€‚è¿™æ ·ä¾¿äºä»¥åæ·»åŠ è¿”å›å€¼ï¼Œä»¥åŠæ›´æ”¹è¿”å›å€¼çš„é¡ºåºã€‚

// bad
function processInput(input) {
  return [left, right, top, bottom];
}

// good
function processInput(input) {
  return { left, right, top, bottom };
}

const { left, right } = processInput(input);
å¯¹è±¡
å•è¡Œå®šä¹‰çš„å¯¹è±¡ï¼Œæœ€åä¸€ä¸ªæˆå‘˜ä¸ä»¥é€—å·ç»“å°¾ã€‚å¤šè¡Œå®šä¹‰çš„å¯¹è±¡ï¼Œæœ€åä¸€ä¸ªæˆå‘˜ä»¥é€—å·ç»“å°¾ã€‚

// bad
const a = { k1: v1, k2: v2, };
const b = {
  k1: v1,
  k2: v2
};

// good
const a = { k1: v1, k2: v2 };
const b = {
  k1: v1,
  k2: v2,
};
å¯¹è±¡å°½é‡é™æ€åŒ–ï¼Œä¸€æ—¦å®šä¹‰ï¼Œå°±ä¸å¾—éšæ„æ·»åŠ æ–°çš„å±æ€§ã€‚å¦‚æœæ·»åŠ å±æ€§ä¸å¯é¿å…ï¼Œè¦ä½¿ç”¨Object.assignæ–¹æ³•ã€‚

// bad
const a = {};
a.x = 3;

// if reshape unavoidable
const a = {};
Object.assign(a, { x: 3 });

// good
const a = { x: null };
a.x = 3;
å¦‚æœå¯¹è±¡çš„å±æ€§åæ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥åœ¨åˆ›é€ å¯¹è±¡çš„æ—¶å€™ï¼Œä½¿ç”¨å±æ€§è¡¨è¾¾å¼å®šä¹‰ã€‚

// bad
const obj = {
  id: 5,
  name: 'San Francisco',
};
obj[getKey('enabled')] = true;

// good
const obj = {
  id: 5,
  name: 'San Francisco',
  [getKey('enabled')]: true,
};
ä¸Šé¢ä»£ç ä¸­ï¼Œå¯¹è±¡objçš„æœ€åä¸€ä¸ªå±æ€§åï¼Œéœ€è¦è®¡ç®—å¾—åˆ°ã€‚è¿™æ—¶æœ€å¥½é‡‡ç”¨å±æ€§è¡¨è¾¾å¼ï¼Œåœ¨æ–°å»ºobjçš„æ—¶å€™ï¼Œå°†è¯¥å±æ€§ä¸å…¶ä»–å±æ€§å®šä¹‰åœ¨ä¸€èµ·ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰å±æ€§å°±åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰äº†ã€‚

å¦å¤–ï¼Œå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ï¼Œå°½é‡é‡‡ç”¨ç®€æ´è¡¨è¾¾æ³•ï¼Œè¿™æ ·æ˜“äºæè¿°å’Œä¹¦å†™ã€‚

var ref = 'some value';

// bad
const atom = {
  ref: ref,

  value: 1,

  addValue: function (value) {
    return atom.value + value;
  },
};

// good
const atom = {
  ref,

  value: 1,

  addValue(value) {
    return atom.value + value;
  },
};
æ•°ç»„
ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼ˆ...ï¼‰æ‹·è´æ•°ç»„ã€‚

// bad
const len = items.length;
const itemsCopy = [];
let i;

for (i = 0; i < len; i++) {
  itemsCopy[i] = items[i];
}

// good
const itemsCopy = [...items];
ä½¿ç”¨Array.fromæ–¹æ³•ï¼Œå°†ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡è½¬ä¸ºæ•°ç»„ã€‚

const foo = document.querySelectorAll('.foo');
const nodes = Array.from(foo);
å‡½æ•°
ç«‹å³æ‰§è¡Œå‡½æ•°å¯ä»¥å†™æˆç®­å¤´å‡½æ•°çš„å½¢å¼ã€‚

(() => {
  console.log('Welcome to the Internet.');
})();
é‚£äº›éœ€è¦ä½¿ç”¨å‡½æ•°è¡¨è¾¾å¼çš„åœºåˆï¼Œå°½é‡ç”¨ç®­å¤´å‡½æ•°ä»£æ›¿ã€‚å› ä¸ºè¿™æ ·æ›´ç®€æ´ï¼Œè€Œä¸”ç»‘å®šäº†thisã€‚

// bad
[1, 2, 3].map(function (x) {
  return x * x;
});

// good
[1, 2, 3].map((x) => {
  return x * x;
});

// best
[1, 2, 3].map(x => x * x);
ç®­å¤´å‡½æ•°å–ä»£Function.prototype.bindï¼Œä¸åº”å†ç”¨self/_this/thatç»‘å®š thisã€‚

// bad
const self = this;
const boundMethod = function(...params) {
  return method.apply(self, params);
}

// acceptable
const boundMethod = method.bind(this);

// best
const boundMethod = (...params) => method.apply(this, params);
ç®€å•çš„ã€å•è¡Œçš„ã€ä¸ä¼šå¤ç”¨çš„å‡½æ•°ï¼Œå»ºè®®é‡‡ç”¨ç®­å¤´å‡½æ•°ã€‚å¦‚æœå‡½æ•°ä½“è¾ƒä¸ºå¤æ‚ï¼Œè¡Œæ•°è¾ƒå¤šï¼Œè¿˜æ˜¯åº”è¯¥é‡‡ç”¨ä¼ ç»Ÿçš„å‡½æ•°å†™æ³•ã€‚

æ‰€æœ‰é…ç½®é¡¹éƒ½åº”è¯¥é›†ä¸­åœ¨ä¸€ä¸ªå¯¹è±¡ï¼Œæ”¾åœ¨æœ€åä¸€ä¸ªå‚æ•°ï¼Œå¸ƒå°”å€¼ä¸å¯ä»¥ç›´æ¥ä½œä¸ºå‚æ•°ã€‚

// bad
function divide(a, b, option = false ) {
}

// good
function divide(a, b, { option = false } = {}) {
}
ä¸è¦åœ¨å‡½æ•°ä½“å†…ä½¿ç”¨argumentså˜é‡ï¼Œä½¿ç”¨restè¿ç®—ç¬¦ï¼ˆ...ï¼‰ä»£æ›¿ã€‚å› ä¸ºrestè¿ç®—ç¬¦æ˜¾å¼è¡¨æ˜ä½ æƒ³è¦è·å–å‚æ•°ï¼Œè€Œä¸”argumentsæ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œè€Œrestè¿ç®—ç¬¦å¯ä»¥æä¾›ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ã€‚

// bad
function concatenateAll() {
  const args = Array.prototype.slice.call(arguments);
  return args.join('');
}

// good
function concatenateAll(...args) {
  return args.join('');
}
ä½¿ç”¨é»˜è®¤å€¼è¯­æ³•è®¾ç½®å‡½æ•°å‚æ•°çš„é»˜è®¤å€¼ã€‚

// bad
function handleThings(opts) {
  opts = opts || {};
}

// good
function handleThings(opts = {}) {
  // ...
}
Mapç»“æ„
æ³¨æ„åŒºåˆ†Objectå’ŒMapï¼Œåªæœ‰æ¨¡æ‹Ÿç°å®ä¸–ç•Œçš„å®ä½“å¯¹è±¡æ—¶ï¼Œæ‰ä½¿ç”¨Objectã€‚å¦‚æœåªæ˜¯éœ€è¦key: valueçš„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨Mapç»“æ„ã€‚å› ä¸ºMapæœ‰å†…å»ºçš„éå†æœºåˆ¶ã€‚

let map = new Map(arr);

for (let key of map.keys()) {
  console.log(key);
}

for (let value of map.values()) {
  console.log(value);
}

for (let item of map.entries()) {
  console.log(item[0], item[1]);
}
Class
æ€»æ˜¯ç”¨Classï¼Œå–ä»£éœ€è¦prototypeçš„æ“ä½œã€‚å› ä¸ºClassçš„å†™æ³•æ›´ç®€æ´ï¼Œæ›´æ˜“äºç†è§£ã€‚

// bad
function Queue(contents = []) {
  this._queue = [...contents];
}
Queue.prototype.pop = function() {
  const value = this._queue[0];
  this._queue.splice(0, 1);
  return value;
}

// good
class Queue {
  constructor(contents = []) {
    this._queue = [...contents];
  }
  pop() {
    const value = this._queue[0];
    this._queue.splice(0, 1);
    return value;
  }
}
ä½¿ç”¨extendså®ç°ç»§æ‰¿ï¼Œå› ä¸ºè¿™æ ·æ›´ç®€å•ï¼Œä¸ä¼šæœ‰ç ´åinstanceofè¿ç®—çš„å±é™©ã€‚

// bad
const inherits = require('inherits');
function PeekableQueue(contents) {
  Queue.apply(this, contents);
}
inherits(PeekableQueue, Queue);
PeekableQueue.prototype.peek = function() {
  return this._queue[0];
}

// good
class PeekableQueue extends Queue {
  peek() {
    return this._queue[0];
  }
}
æ¨¡å—
é¦–å…ˆï¼ŒModuleè¯­æ³•æ˜¯JavaScriptæ¨¡å—çš„æ ‡å‡†å†™æ³•ï¼ŒåšæŒä½¿ç”¨è¿™ç§å†™æ³•ã€‚ä½¿ç”¨importå–ä»£requireã€‚

// bad
const moduleA = require('moduleA');
const func1 = moduleA.func1;
const func2 = moduleA.func2;

// good
import { func1, func2 } from 'moduleA';
ä½¿ç”¨exportå–ä»£module.exportsã€‚

// commonJSçš„å†™æ³•
var React = require('react');

var Breadcrumbs = React.createClass({
  render() {
    return <nav />;
  }
});

module.exports = Breadcrumbs;

// ES6çš„å†™æ³•
import React from 'react';

const Breadcrumbs = React.createClass({
  render() {
    return <nav />;
  }
});

export default Breadcrumbs
å¦‚æœæ¨¡å—åªæœ‰ä¸€ä¸ªè¾“å‡ºå€¼ï¼Œå°±ä½¿ç”¨export defaultï¼Œå¦‚æœæ¨¡å—æœ‰å¤šä¸ªè¾“å‡ºå€¼ï¼Œå°±ä¸ä½¿ç”¨export defaultï¼Œä¸è¦export defaultä¸æ™®é€šçš„exportåŒæ—¶ä½¿ç”¨ã€‚

ä¸è¦åœ¨æ¨¡å—è¾“å…¥ä¸­ä½¿ç”¨é€šé…ç¬¦ã€‚å› ä¸ºè¿™æ ·å¯ä»¥ç¡®ä¿ä½ çš„æ¨¡å—ä¹‹ä¸­ï¼Œæœ‰ä¸€ä¸ªé»˜è®¤è¾“å‡ºï¼ˆexport defaultï¼‰ã€‚

// bad
import * as myObject './importModule';

// good
import myObject from './importModule';
å¦‚æœæ¨¡å—é»˜è®¤è¾“å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°åçš„é¦–å­—æ¯åº”è¯¥å°å†™ã€‚

function makeStyleGuide() {
}

export default makeStyleGuide;
å¦‚æœæ¨¡å—é»˜è®¤è¾“å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡åçš„é¦–å­—æ¯åº”è¯¥å¤§å†™ã€‚

const StyleGuide = {
  es6: {
  }
};

export default StyleGuide;
ESLintçš„ä½¿ç”¨
ESLintæ˜¯ä¸€ä¸ªè¯­æ³•è§„åˆ™å’Œä»£ç é£æ ¼çš„æ£€æŸ¥å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥ä¿è¯å†™å‡ºè¯­æ³•æ­£ç¡®ã€é£æ ¼ç»Ÿä¸€çš„ä»£ç ã€‚

é¦–å…ˆï¼Œå®‰è£…ESLintã€‚

$ npm i -g eslint
ç„¶åï¼Œå®‰è£…Airbnbè¯­æ³•è§„åˆ™ã€‚

$ npm i -g eslint-config-airbnb
æœ€åï¼Œåœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª.eslintrcæ–‡ä»¶ï¼Œé…ç½®ESLintã€‚

{
  "extends": "eslint-config-airbnb"
}
ç°åœ¨å°±å¯ä»¥æ£€æŸ¥ï¼Œå½“å‰é¡¹ç›®çš„ä»£ç æ˜¯å¦ç¬¦åˆé¢„è®¾çš„è§„åˆ™ã€‚

index.jsæ–‡ä»¶çš„ä»£ç å¦‚ä¸‹ã€‚

var unusued = 'I have no purpose!';

function greet() {
    var message = 'Hello, World!';
    alert(message);
}

greet();
ä½¿ç”¨ESLintæ£€æŸ¥è¿™ä¸ªæ–‡ä»¶ã€‚

$ eslint index.js
index.js
  1:5  error  unusued is defined but never used                 no-unused-vars
  4:5  error  Expected indentation of 2 characters but found 4  indent
  5:5  error  Expected indentation of 2 characters but found 4  indent

âœ– 3 problems (3 errors, 0 warnings)
ä¸Šé¢ä»£ç è¯´æ˜ï¼ŒåŸæ–‡ä»¶æœ‰ä¸‰ä¸ªé”™è¯¯ï¼Œä¸€ä¸ªæ˜¯å®šä¹‰äº†å˜é‡ï¼Œå´æ²¡æœ‰ä½¿ç”¨ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯è¡Œé¦–ç¼©è¿›ä¸º4ä¸ªç©ºæ ¼ï¼Œè€Œä¸æ˜¯è§„å®šçš„2ä¸ªç©ºæ ¼ã€‚

##è¯»æ‡‚ ECMAScript è§„æ ¼
1.æ¦‚è¿°
è§„æ ¼æ–‡ä»¶æ˜¯è®¡ç®—æœºè¯­è¨€çš„å®˜æ–¹æ ‡å‡†ï¼Œè¯¦ç»†æè¿°è¯­æ³•è§„åˆ™å’Œå®ç°æ–¹æ³•ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæ²¡æœ‰å¿…è¦é˜…è¯»è§„æ ¼ï¼Œé™¤éä½ è¦å†™ç¼–è¯‘å™¨ã€‚å› ä¸ºè§„æ ¼å†™å¾—éå¸¸æŠ½è±¡å’Œç²¾ç‚¼ï¼Œåˆç¼ºä¹å®ä¾‹ï¼Œä¸å®¹æ˜“ç†è§£ï¼Œè€Œä¸”å¯¹äºè§£å†³å®é™…çš„åº”ç”¨é—®é¢˜ï¼Œå¸®åŠ©ä¸å¤§ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ é‡åˆ°ç–‘éš¾çš„è¯­æ³•é—®é¢˜ï¼Œå®åœ¨æ‰¾ä¸åˆ°ç­”æ¡ˆï¼Œè¿™æ—¶å¯ä»¥å»æŸ¥çœ‹è§„æ ¼æ–‡ä»¶ï¼Œäº†è§£è¯­è¨€æ ‡å‡†æ˜¯æ€ä¹ˆè¯´çš„ã€‚è§„æ ¼æ˜¯è§£å†³é—®é¢˜çš„â€œæœ€åä¸€æ‹›â€ã€‚

è¿™å¯¹JavaScriptè¯­è¨€å¾ˆæœ‰å¿…è¦ã€‚å› ä¸ºå®ƒçš„ä½¿ç”¨åœºæ™¯å¤æ‚ï¼Œè¯­æ³•è§„åˆ™ä¸ç»Ÿä¸€ï¼Œä¾‹å¤–å¾ˆå¤šï¼Œå„ç§è¿è¡Œç¯å¢ƒçš„è¡Œä¸ºä¸ä¸€è‡´ï¼Œå¯¼è‡´å¥‡æ€ªçš„è¯­æ³•é—®é¢˜å±‚å‡ºä¸ç©·ï¼Œä»»ä½•è¯­æ³•ä¹¦éƒ½ä¸å¯èƒ½å›Šæ‹¬æ‰€æœ‰æƒ…å†µã€‚æŸ¥çœ‹è§„æ ¼ï¼Œä¸å¤±ä¸ºä¸€ç§è§£å†³è¯­æ³•é—®é¢˜çš„æœ€å¯é ã€æœ€æƒå¨çš„ç»ˆææ–¹æ³•ã€‚

æœ¬ç« ä»‹ç»å¦‚ä½•è¯»æ‡‚ECMAScript 6çš„è§„æ ¼æ–‡ä»¶ã€‚

ECMAScript 6çš„è§„æ ¼ï¼Œå¯ä»¥åœ¨ECMAå›½é™…æ ‡å‡†ç»„ç»‡çš„å®˜æ–¹ç½‘ç«™ï¼ˆwww.ecma-international.org/ecma-262/6.0/ï¼‰å…è´¹ä¸‹è½½å’Œåœ¨çº¿é˜…è¯»ã€‚

è¿™ä¸ªè§„æ ¼æ–‡ä»¶ç›¸å½“åºå¤§ï¼Œä¸€å…±æœ‰26ç« ï¼ŒA4æ‰“å°çš„è¯ï¼Œè¶³è¶³æœ‰545é¡µã€‚å®ƒçš„ç‰¹ç‚¹å°±æ˜¯è§„å®šå¾—éå¸¸ç»†è‡´ï¼Œæ¯ä¸€ä¸ªè¯­æ³•è¡Œä¸ºã€æ¯ä¸€ä¸ªå‡½æ•°çš„å®ç°éƒ½åšäº†è¯¦å°½çš„æ¸…æ™°çš„æè¿°ã€‚åŸºæœ¬ä¸Šï¼Œç¼–è¯‘å™¨ä½œè€…åªè¦æŠŠæ¯ä¸€æ­¥ç¿»è¯‘æˆä»£ç å°±å¯ä»¥äº†ã€‚è¿™å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œä¿è¯äº†æ‰€æœ‰ES6å®ç°éƒ½æœ‰ä¸€è‡´çš„è¡Œä¸ºã€‚

ECMAScript 6è§„æ ¼çš„26ç« ä¹‹ä¸­ï¼Œç¬¬1ç« åˆ°ç¬¬3ç« æ˜¯å¯¹æ–‡ä»¶æœ¬èº«çš„ä»‹ç»ï¼Œä¸è¯­è¨€å…³ç³»ä¸å¤§ã€‚ç¬¬4ç« æ˜¯å¯¹è¿™é—¨è¯­è¨€æ€»ä½“è®¾è®¡çš„æè¿°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è¯»ä¸€ä¸‹ã€‚ç¬¬5ç« åˆ°ç¬¬8ç« æ˜¯è¯­è¨€å®è§‚å±‚é¢çš„æè¿°ã€‚ç¬¬5ç« æ˜¯è§„æ ¼çš„åè¯è§£é‡Šå’Œå†™æ³•çš„ä»‹ç»ï¼Œç¬¬6ç« ä»‹ç»æ•°æ®ç±»å‹ï¼Œç¬¬7ç« ä»‹ç»è¯­è¨€å†…éƒ¨ç”¨åˆ°çš„æŠ½è±¡æ“ä½œï¼Œç¬¬8ç« ä»‹ç»ä»£ç å¦‚ä½•è¿è¡Œã€‚ç¬¬9ç« åˆ°ç¬¬26ç« ä»‹ç»å…·ä½“çš„è¯­æ³•ã€‚

å¯¹äºä¸€èˆ¬ç”¨æˆ·æ¥è¯´ï¼Œé™¤äº†ç¬¬4ç« ï¼Œå…¶ä»–ç« èŠ‚éƒ½æ¶‰åŠæŸä¸€æ–¹é¢çš„ç»†èŠ‚ï¼Œä¸ç”¨é€šè¯»ï¼Œåªè¦åœ¨ç”¨åˆ°çš„æ—¶å€™ï¼ŒæŸ¥é˜…ç›¸å…³ç« èŠ‚å³å¯ã€‚ä¸‹é¢é€šè¿‡ä¸€äº›ä¾‹å­ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™ä»½è§„æ ¼ã€‚

ç›¸ç­‰è¿ç®—ç¬¦
ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ==ï¼‰æ˜¯ä¸€ä¸ªå¾ˆè®©äººå¤´ç—›çš„è¿ç®—ç¬¦ï¼Œå®ƒçš„è¯­æ³•è¡Œä¸ºå¤šå˜ï¼Œä¸ç¬¦åˆç›´è§‰ã€‚è¿™ä¸ªå°èŠ‚å°±çœ‹çœ‹è§„æ ¼æ€ä¹ˆè§„å®šå®ƒçš„è¡Œä¸ºã€‚

è¯·çœ‹ä¸‹é¢è¿™ä¸ªè¡¨è¾¾å¼ï¼Œè¯·é—®å®ƒçš„å€¼æ˜¯å¤šå°‘ã€‚

0 == null
å¦‚æœä½ ä¸ç¡®å®šç­”æ¡ˆï¼Œæˆ–è€…æƒ³çŸ¥é“è¯­è¨€å†…éƒ¨æ€ä¹ˆå¤„ç†ï¼Œå°±å¯ä»¥å»æŸ¥çœ‹è§„æ ¼ï¼Œ7.2.12å°èŠ‚æ˜¯å¯¹ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ==ï¼‰çš„æè¿°ã€‚

è§„æ ¼å¯¹æ¯ä¸€ç§è¯­æ³•è¡Œä¸ºçš„æè¿°ï¼Œéƒ½åˆ†æˆä¸¤éƒ¨åˆ†ï¼šå…ˆæ˜¯æ€»ä½“çš„è¡Œä¸ºæè¿°ï¼Œç„¶åæ˜¯å®ç°çš„ç®—æ³•ç»†èŠ‚ã€‚ç›¸ç­‰è¿ç®—ç¬¦çš„æ€»ä½“æè¿°ï¼Œåªæœ‰ä¸€å¥è¯ã€‚

â€œThe comparison x == y, where x and y are values, produces true or false.â€

ä¸Šé¢è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œç›¸ç­‰è¿ç®—ç¬¦ç”¨äºæ¯”è¾ƒä¸¤ä¸ªå€¼ï¼Œè¿”å›trueæˆ–falseã€‚

ä¸‹é¢æ˜¯ç®—æ³•ç»†èŠ‚ã€‚

ReturnIfAbrupt(x).
ReturnIfAbrupt(y).
If Type(x) is the same as Type(y), then
Return the result of performing Strict Equality Comparison x === y.
If x is null and y is undefined, return true.
If x is undefined and y is null, return true.
If Type(x) is Number and Type(y) is String,
return the result of the comparison x == ToNumber(y).
If Type(x) is String and Type(y) is Number,
return the result of the comparison ToNumber(x) == y.
If Type(x) is Boolean, return the result of the comparison ToNumber(x) == y.
If Type(y) is Boolean, return the result of the comparison x == ToNumber(y).
If Type(x) is either String, Number, or Symbol and Type(y) is Object, then
return the result of the comparison x == ToPrimitive(y).
If Type(x) is Object and Type(y) is either String, Number, or Symbol, then
return the result of the comparison ToPrimitive(x) == y.
Return false.
ä¸Šé¢è¿™æ®µç®—æ³•ï¼Œä¸€å…±æœ‰12æ­¥ï¼Œç¿»è¯‘å¦‚ä¸‹ã€‚

å¦‚æœxä¸æ˜¯æ­£å¸¸å€¼ï¼ˆæ¯”å¦‚æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼‰ï¼Œä¸­æ–­æ‰§è¡Œã€‚
å¦‚æœyä¸æ˜¯æ­£å¸¸å€¼ï¼Œä¸­æ–­æ‰§è¡Œã€‚
å¦‚æœType(x)ä¸Type(y)ç›¸åŒï¼Œæ‰§è¡Œä¸¥æ ¼ç›¸ç­‰è¿ç®—x === yã€‚
å¦‚æœxæ˜¯nullï¼Œyæ˜¯undefinedï¼Œè¿”å›trueã€‚
å¦‚æœxæ˜¯undefinedï¼Œyæ˜¯nullï¼Œè¿”å›trueã€‚
å¦‚æœType(x)æ˜¯æ•°å€¼ï¼ŒType(y)æ˜¯å­—ç¬¦ä¸²ï¼Œè¿”å›x == ToNumber(y)çš„ç»“æœã€‚
å¦‚æœType(x)æ˜¯å­—ç¬¦ä¸²ï¼ŒType(y)æ˜¯æ•°å€¼ï¼Œè¿”å›ToNumber(x) == yçš„ç»“æœã€‚
å¦‚æœType(x)æ˜¯å¸ƒå°”å€¼ï¼Œè¿”å›ToNumber(x) == yçš„ç»“æœã€‚
å¦‚æœType(y)æ˜¯å¸ƒå°”å€¼ï¼Œè¿”å›x == ToNumber(y)çš„ç»“æœã€‚
å¦‚æœType(x)æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å€¼æˆ–Symbolå€¼ï¼ŒType(y)æ˜¯å¯¹è±¡ï¼Œè¿”å›x == ToPrimitive(y)çš„ç»“æœã€‚
å¦‚æœType(x)æ˜¯å¯¹è±¡ï¼ŒType(y)æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å€¼æˆ–Symbolå€¼ï¼Œè¿”å›ToPrimitive(x) == yçš„ç»“æœã€‚
è¿”å›falseã€‚
ç”±äº0çš„ç±»å‹æ˜¯æ•°å€¼ï¼Œnullçš„ç±»å‹æ˜¯Nullï¼ˆè¿™æ˜¯è§„æ ¼4.3.13å°èŠ‚çš„è§„å®šï¼Œæ˜¯å†…éƒ¨Typeè¿ç®—çš„ç»“æœï¼Œè·Ÿtypeofè¿ç®—ç¬¦æ— å…³ï¼‰ã€‚å› æ­¤ä¸Šé¢çš„å‰11æ­¥éƒ½å¾—ä¸åˆ°ç»“æœï¼Œè¦åˆ°ç¬¬12æ­¥æ‰èƒ½å¾—åˆ°falseã€‚

0 == null // false
æ•°ç»„çš„ç©ºä½
ä¸‹é¢å†çœ‹å¦ä¸€ä¸ªä¾‹å­ã€‚

const a1 = [undefined, undefined, undefined];
const a2 = [, , ,];

a1.length // 3
a2.length // 3

a1[0] // undefined
a2[0] // undefined

a1[0] === a2[0] // true
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„a1çš„æˆå‘˜æ˜¯ä¸‰ä¸ªundefinedï¼Œæ•°ç»„a2çš„æˆå‘˜æ˜¯ä¸‰ä¸ªç©ºä½ã€‚è¿™ä¸¤ä¸ªæ•°ç»„å¾ˆç›¸ä¼¼ï¼Œé•¿åº¦éƒ½æ˜¯3ï¼Œæ¯ä¸ªä½ç½®çš„æˆå‘˜è¯»å–å‡ºæ¥éƒ½æ˜¯undefinedã€‚

ä½†æ˜¯ï¼Œå®ƒä»¬å®é™…ä¸Šå­˜åœ¨é‡å¤§å·®å¼‚ã€‚

0 in a1 // true
0 in a2 // false

a1.hasOwnProperty(0) // true
a2.hasOwnProperty(0) // false

Object.keys(a1) // ["0", "1", "2"]
Object.keys(a2) // []

a1.map(n => 1) // [1, 1, 1]
a2.map(n => 1) // [, , ,]
ä¸Šé¢ä»£ç ä¸€å…±åˆ—å‡ºäº†å››ç§è¿ç®—ï¼Œæ•°ç»„a1å’Œa2çš„ç»“æœéƒ½ä¸ä¸€æ ·ã€‚å‰ä¸‰ç§è¿ç®—ï¼ˆinè¿ç®—ç¬¦ã€æ•°ç»„çš„hasOwnPropertyæ–¹æ³•ã€Object.keysæ–¹æ³•ï¼‰éƒ½è¯´æ˜ï¼Œæ•°ç»„a2å–ä¸åˆ°å±æ€§åã€‚æœ€åä¸€ç§è¿ç®—ï¼ˆæ•°ç»„çš„mapæ–¹æ³•ï¼‰è¯´æ˜ï¼Œæ•°ç»„a2æ²¡æœ‰å‘ç”Ÿéå†ã€‚

ä¸ºä»€ä¹ˆa1ä¸a2æˆå‘˜çš„è¡Œä¸ºä¸ä¸€è‡´ï¼Ÿæ•°ç»„çš„æˆå‘˜æ˜¯undefinedæˆ–ç©ºä½ï¼Œåˆ°åº•æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

è§„æ ¼çš„12.2.5å°èŠ‚ã€Šæ•°ç»„çš„åˆå§‹åŒ–ã€‹ç»™å‡ºäº†ç­”æ¡ˆã€‚

â€œArray elements may be elided at the beginning, middle or end of the element list. Whenever a comma in the element list is not preceded by an AssignmentExpression (i.e., a comma at the beginning or after another comma), the missing array element contributes to the length of the Array and increases the index of subsequent elements. Elided array elements are not defined. If an element is elided at the end of an array, that element does not contribute to the length of the Array.â€

ç¿»è¯‘å¦‚ä¸‹ã€‚

"æ•°ç»„æˆå‘˜å¯ä»¥çœç•¥ã€‚åªè¦é€—å·å‰é¢æ²¡æœ‰ä»»ä½•è¡¨è¾¾å¼ï¼Œæ•°ç»„çš„lengthå±æ€§å°±ä¼šåŠ 1ï¼Œå¹¶ä¸”ç›¸åº”å¢åŠ å…¶åæˆå‘˜çš„ä½ç½®ç´¢å¼•ã€‚è¢«çœç•¥çš„æˆå‘˜ä¸ä¼šè¢«å®šä¹‰ã€‚å¦‚æœè¢«çœç•¥çš„æˆå‘˜æ˜¯æ•°ç»„æœ€åä¸€ä¸ªæˆå‘˜ï¼Œåˆ™ä¸ä¼šå¯¼è‡´æ•°ç»„lengthå±æ€§å¢åŠ ã€‚â€

ä¸Šé¢çš„è§„æ ¼è¯´å¾—å¾ˆæ¸…æ¥šï¼Œæ•°ç»„çš„ç©ºä½ä¼šåæ˜ åœ¨lengthå±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ç©ºä½æœ‰è‡ªå·±çš„ä½ç½®ï¼Œä½†æ˜¯è¿™ä¸ªä½ç½®çš„å€¼æ˜¯æœªå®šä¹‰ï¼Œå³è¿™ä¸ªå€¼æ˜¯ä¸å­˜åœ¨çš„ã€‚å¦‚æœä¸€å®šè¦è¯»å–ï¼Œç»“æœå°±æ˜¯undefinedï¼ˆå› ä¸ºundefinedåœ¨JavaScriptè¯­è¨€ä¸­è¡¨ç¤ºä¸å­˜åœ¨ï¼‰ã€‚

è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆinè¿ç®—ç¬¦ã€æ•°ç»„çš„hasOwnPropertyæ–¹æ³•ã€Object.keysæ–¹æ³•ï¼Œéƒ½å–ä¸åˆ°ç©ºä½çš„å±æ€§åã€‚å› ä¸ºè¿™ä¸ªå±æ€§åæ ¹æœ¬å°±ä¸å­˜åœ¨ï¼Œè§„æ ¼é‡Œé¢æ²¡è¯´è¦ä¸ºç©ºä½åˆ†é…å±æ€§å(ä½ç½®ç´¢å¼•ï¼‰ï¼Œåªè¯´è¦ä¸ºä¸‹ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ç´¢å¼•åŠ 1ã€‚

è‡³äºä¸ºä»€ä¹ˆæ•°ç»„çš„mapæ–¹æ³•ä¼šè·³è¿‡ç©ºä½ï¼Œè¯·çœ‹ä¸‹ä¸€èŠ‚ã€‚

æ•°ç»„çš„mapæ–¹æ³•
è§„æ ¼çš„22.1.3.15å°èŠ‚å®šä¹‰äº†æ•°ç»„çš„mapæ–¹æ³•ã€‚è¯¥å°èŠ‚å…ˆæ˜¯æ€»ä½“æè¿°mapæ–¹æ³•çš„è¡Œä¸ºï¼Œé‡Œé¢æ²¡æœ‰æåˆ°æ•°ç»„ç©ºä½ã€‚

åé¢çš„ç®—æ³•æè¿°æ˜¯è¿™æ ·çš„ã€‚

Let O be ToObject(this value).
ReturnIfAbrupt(O).
Let len be ToLength(Get(O, "length")).
ReturnIfAbrupt(len).
If IsCallable(callbackfn) is false, throw a TypeError exception.
If thisArg was supplied, let T be thisArg; else let T be undefined.
Let A be ArraySpeciesCreate(O, len).
ReturnIfAbrupt(A).
Let k be 0.
Repeat, while k < len
a. Let Pk be ToString(k).
b. Let kPresent be HasProperty(O, Pk).
c. ReturnIfAbrupt(kPresent).
d. If kPresent is true, then
d-1. Let kValue be Get(O, Pk).
d-2. ReturnIfAbrupt(kValue).
d-3. Let mappedValue be Call(callbackfn, T, Â«kValue, k, OÂ»).
d-4. ReturnIfAbrupt(mappedValue).
d-5. Let status be CreateDataPropertyOrThrow (A, Pk, mappedValue).
d-6. ReturnIfAbrupt(status).
e. Increase k by 1.
Return A.
ç¿»è¯‘å¦‚ä¸‹ã€‚

å¾—åˆ°å½“å‰æ•°ç»„çš„thiså¯¹è±¡
å¦‚æœæŠ¥é”™å°±è¿”å›
æ±‚å‡ºå½“å‰æ•°ç»„çš„lengthå±æ€§
å¦‚æœæŠ¥é”™å°±è¿”å›
å¦‚æœmapæ–¹æ³•çš„å‚æ•°callbackfnä¸å¯æ‰§è¡Œï¼Œå°±æŠ¥é”™
å¦‚æœmapæ–¹æ³•çš„å‚æ•°ä¹‹ä¸­ï¼ŒæŒ‡å®šäº†thisï¼Œå°±è®©Tç­‰äºè¯¥å‚æ•°ï¼Œå¦åˆ™Tä¸ºundefined
ç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°ç»„Aï¼Œè·Ÿå½“å‰æ•°ç»„çš„lengthå±æ€§ä¿æŒä¸€è‡´
å¦‚æœæŠ¥é”™å°±è¿”å›
è®¾å®škç­‰äº0
åªè¦kå°äºå½“å‰æ•°ç»„çš„lengthå±æ€§ï¼Œå°±é‡å¤ä¸‹é¢æ­¥éª¤
a. è®¾å®šPkç­‰äºToString(k)ï¼Œå³å°†Kè½¬ä¸ºå­—ç¬¦ä¸²
b. è®¾å®škPresentç­‰äºHasProperty(O, Pk)ï¼Œå³æ±‚å½“å‰æ•°ç»„æœ‰æ²¡æœ‰æŒ‡å®šå±æ€§
c. å¦‚æœæŠ¥é”™å°±è¿”å›
d. å¦‚æœkPresentç­‰äºtrueï¼Œåˆ™è¿›è¡Œä¸‹é¢æ­¥éª¤
d-1. è®¾å®škValueç­‰äºGet(O, Pk)ï¼Œå–å‡ºå½“å‰æ•°ç»„çš„æŒ‡å®šå±æ€§
d-2. å¦‚æœæŠ¥é”™å°±è¿”å›
d-3. è®¾å®šmappedValueç­‰äºCall(callbackfn, T, Â«kValue, k, OÂ»)ï¼Œå³æ‰§è¡Œå›è°ƒå‡½æ•°
d-4. å¦‚æœæŠ¥é”™å°±è¿”å›
d-5. è®¾å®šstatusç­‰äºCreateDataPropertyOrThrow (A, Pk, mappedValue)ï¼Œå³å°†å›è°ƒå‡½æ•°çš„å€¼æ”¾å…¥Aæ•°ç»„çš„æŒ‡å®šä½ç½®
d-6. å¦‚æœæŠ¥é”™å°±è¿”å›
e. kå¢åŠ 1
è¿”å›A
ä»”ç»†æŸ¥çœ‹ä¸Šé¢çš„ç®—æ³•ï¼Œå¯ä»¥å‘ç°ï¼Œå½“å¤„ç†ä¸€ä¸ªå…¨æ˜¯ç©ºä½çš„æ•°ç»„æ—¶ï¼Œå‰é¢æ­¥éª¤éƒ½æ²¡æœ‰é—®é¢˜ã€‚è¿›å…¥ç¬¬10æ­¥çš„bæ—¶ï¼Œkpresentä¼šæŠ¥é”™ï¼Œå› ä¸ºç©ºä½å¯¹åº”çš„å±æ€§åï¼Œå¯¹äºæ•°ç»„æ¥è¯´æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤å°±ä¼šè¿”å›ï¼Œä¸ä¼šè¿›è¡Œåé¢çš„æ­¥éª¤ã€‚

const arr = [, , ,];
arr.map(n => {
  console.log(n);
  return 1;
}) // [, , ,]
ä¸Šé¢ä»£ç ä¸­ï¼Œarræ˜¯ä¸€ä¸ªå…¨æ˜¯ç©ºä½çš„æ•°ç»„ï¼Œmapæ–¹æ³•éå†æˆå‘˜æ—¶ï¼Œå‘ç°æ˜¯ç©ºä½ï¼Œå°±ç›´æ¥è·³è¿‡ï¼Œä¸ä¼šè¿›å…¥å›è°ƒå‡½æ•°ã€‚å› æ­¤ï¼Œå›è°ƒå‡½æ•°é‡Œé¢çš„console.logè¯­å¥æ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼Œæ•´ä¸ªmapæ–¹æ³•è¿”å›ä¸€ä¸ªå…¨æ˜¯ç©ºä½çš„æ–°æ•°ç»„ã€‚

V8å¼•æ“å¯¹mapæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è·Ÿè§„æ ¼çš„ç®—æ³•æè¿°å®Œå…¨ä¸€è‡´ã€‚

function ArrayMap(f, receiver) {
  CHECK_OBJECT_COERCIBLE(this, "Array.prototype.map");

  // Pull out the length so that modifications to the length in the
  // loop will not affect the looping and side effects are visible.
  var array = TO_OBJECT(this);
  var length = TO_LENGTH_OR_UINT32(array.length);
  return InnerArrayMap(f, receiver, array, length);
}

function InnerArrayMap(f, receiver, array, length) {
  if (!IS_CALLABLE(f)) throw MakeTypeError(kCalledNonCallable, f);

  var accumulator = new InternalArray(length);
  var is_array = IS_ARRAY(array);
  var stepping = DEBUG_IS_STEPPING(f);
  for (var i = 0; i < length; i++) {
    if (HAS_INDEX(array, i, is_array)) {
      var element = array[i];
      // Prepare break slots for debugger step in.
      if (stepping) %DebugPrepareStepInIfStepping(f);
      accumulator[i] = %_Call(f, receiver, element, i, array);
    }
  }
  var result = new GlobalArray();
  %MoveArrayContents(accumulator, result);
  return result;
}

##äºŒè¿›åˆ¶æ•°ç»„
1.äºŒè¿›åˆ¶æ•°ç»„ï¼ˆArrayBufferå¯¹è±¡ã€TypedArrayè§†å›¾å’ŒDataViewè§†å›¾ï¼‰æ˜¯JavaScriptæ“ä½œäºŒè¿›åˆ¶æ•°æ®çš„ä¸€ä¸ªæ¥å£ã€‚è¿™äº›å¯¹è±¡æ—©å°±å­˜åœ¨ï¼Œå±äºç‹¬ç«‹çš„è§„æ ¼ï¼ˆ2011å¹´2æœˆå‘å¸ƒï¼‰ï¼ŒES6å°†å®ƒä»¬çº³å…¥äº†ECMAScriptè§„æ ¼ï¼Œå¹¶ä¸”å¢åŠ äº†æ–°çš„æ–¹æ³•ã€‚

è¿™ä¸ªæ¥å£çš„åŸå§‹è®¾è®¡ç›®çš„ï¼Œä¸WebGLé¡¹ç›®æœ‰å…³ã€‚æ‰€è°“WebGLï¼Œå°±æ˜¯æŒ‡æµè§ˆå™¨ä¸æ˜¾å¡ä¹‹é—´çš„é€šä¿¡æ¥å£ï¼Œä¸ºäº†æ»¡è¶³JavaScriptä¸æ˜¾å¡ä¹‹é—´å¤§é‡çš„ã€å®æ—¶çš„æ•°æ®äº¤æ¢ï¼Œå®ƒä»¬ä¹‹é—´çš„æ•°æ®é€šä¿¡å¿…é¡»æ˜¯äºŒè¿›åˆ¶çš„ï¼Œè€Œä¸èƒ½æ˜¯ä¼ ç»Ÿçš„æ–‡æœ¬æ ¼å¼ã€‚æ–‡æœ¬æ ¼å¼ä¼ é€’ä¸€ä¸ª32ä½æ•´æ•°ï¼Œä¸¤ç«¯çš„JavaScriptè„šæœ¬ä¸æ˜¾å¡éƒ½è¦è¿›è¡Œæ ¼å¼è½¬åŒ–ï¼Œå°†éå¸¸è€—æ—¶ã€‚è¿™æ—¶è¦æ˜¯å­˜åœ¨ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥åƒCè¯­è¨€é‚£æ ·ï¼Œç›´æ¥æ“ä½œå­—èŠ‚ï¼Œå°†4ä¸ªå­—èŠ‚çš„32ä½æ•´æ•°ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼åŸå°ä¸åŠ¨åœ°é€å…¥æ˜¾å¡ï¼Œè„šæœ¬çš„æ€§èƒ½å°±ä¼šå¤§å¹…æå‡ã€‚

äºŒè¿›åˆ¶æ•°ç»„å°±æ˜¯åœ¨è¿™ç§èƒŒæ™¯ä¸‹è¯ç”Ÿçš„ã€‚å®ƒå¾ˆåƒCè¯­è¨€çš„æ•°ç»„ï¼Œå…è®¸å¼€å‘è€…ä»¥æ•°ç»„ä¸‹æ ‡çš„å½¢å¼ï¼Œç›´æ¥æ“ä½œå†…å­˜ï¼Œå¤§å¤§å¢å¼ºäº†JavaScriptå¤„ç†äºŒè¿›åˆ¶æ•°æ®çš„èƒ½åŠ›ï¼Œä½¿å¾—å¼€å‘è€…æœ‰å¯èƒ½é€šè¿‡JavaScriptä¸æ“ä½œç³»ç»Ÿçš„åŸç”Ÿæ¥å£è¿›è¡ŒäºŒè¿›åˆ¶é€šä¿¡ã€‚

äºŒè¿›åˆ¶æ•°ç»„ç”±ä¸‰ç±»å¯¹è±¡ç»„æˆã€‚

ï¼ˆ1ï¼‰ArrayBufferå¯¹è±¡ï¼šä»£è¡¨å†…å­˜ä¹‹ä¸­çš„ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯ä»¥é€šè¿‡â€œè§†å›¾â€è¿›è¡Œæ“ä½œã€‚â€œè§†å›¾â€éƒ¨ç½²äº†æ•°ç»„æ¥å£ï¼Œè¿™æ„å‘³ç€ï¼Œå¯ä»¥ç”¨æ•°ç»„çš„æ–¹æ³•æ“ä½œå†…å­˜ã€‚

ï¼ˆ2ï¼‰TypedArrayè§†å›¾ï¼šå…±åŒ…æ‹¬9ç§ç±»å‹çš„è§†å›¾ï¼Œæ¯”å¦‚Uint8Arrayï¼ˆæ— ç¬¦å·8ä½æ•´æ•°ï¼‰æ•°ç»„è§†å›¾, Int16Arrayï¼ˆ16ä½æ•´æ•°ï¼‰æ•°ç»„è§†å›¾, Float32Arrayï¼ˆ32ä½æµ®ç‚¹æ•°ï¼‰æ•°ç»„è§†å›¾ç­‰ç­‰ã€‚

ï¼ˆ3ï¼‰DataViewè§†å›¾ï¼šå¯ä»¥è‡ªå®šä¹‰å¤åˆæ ¼å¼çš„è§†å›¾ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯Uint8ï¼ˆæ— ç¬¦å·8ä½æ•´æ•°ï¼‰ã€ç¬¬äºŒã€ä¸‰ä¸ªå­—èŠ‚æ˜¯Int16ï¼ˆ16ä½æ•´æ•°ï¼‰ã€ç¬¬å››ä¸ªå­—èŠ‚å¼€å§‹æ˜¯Float32ï¼ˆ32ä½æµ®ç‚¹æ•°ï¼‰ç­‰ç­‰ï¼Œæ­¤å¤–è¿˜å¯ä»¥è‡ªå®šä¹‰å­—èŠ‚åºã€‚

ç®€å•è¯´ï¼ŒArrayBufferå¯¹è±¡ä»£è¡¨åŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒTypedArrayè§†å›¾ç”¨æ¥è¯»å†™ç®€å•ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒDataViewè§†å›¾ç”¨æ¥è¯»å†™å¤æ‚ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®ã€‚

TypedArrayè§†å›¾æ”¯æŒçš„æ•°æ®ç±»å‹ä¸€å…±æœ‰9ç§ï¼ˆDataViewè§†å›¾æ”¯æŒé™¤Uint8Cä»¥å¤–çš„å…¶ä»–8ç§ï¼‰ã€‚

æ•°æ®ç±»å‹	å­—èŠ‚é•¿åº¦	å«ä¹‰	å¯¹åº”çš„Cè¯­è¨€ç±»å‹
Int8	1	8ä½å¸¦ç¬¦å·æ•´æ•°	signed char
Uint8	1	8ä½ä¸å¸¦ç¬¦å·æ•´æ•°	unsigned char
Uint8C	1	8ä½ä¸å¸¦ç¬¦å·æ•´æ•°ï¼ˆè‡ªåŠ¨è¿‡æ»¤æº¢å‡ºï¼‰	unsigned char
Int16	2	16ä½å¸¦ç¬¦å·æ•´æ•°	short
Uint16	2	16ä½ä¸å¸¦ç¬¦å·æ•´æ•°	unsigned short
Int32	4	32ä½å¸¦ç¬¦å·æ•´æ•°	int
Uint32	4	32ä½ä¸å¸¦ç¬¦å·çš„æ•´æ•°	unsigned int
Float32	4	32ä½æµ®ç‚¹æ•°	float
Float64	8	64ä½æµ®ç‚¹æ•°	double
æ³¨æ„ï¼ŒäºŒè¿›åˆ¶æ•°ç»„å¹¶ä¸æ˜¯çœŸæ­£çš„æ•°ç»„ï¼Œè€Œæ˜¯ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚

å¾ˆå¤šæµè§ˆå™¨æ“ä½œçš„APIï¼Œç”¨åˆ°äº†äºŒè¿›åˆ¶æ•°ç»„æ“ä½œäºŒè¿›åˆ¶æ•°æ®ï¼Œä¸‹é¢æ˜¯å…¶ä¸­çš„å‡ ä¸ªã€‚

File API
XMLHttpRequest
Fetch API
Canvas
WebSockets
ArrayBufferå¯¹è±¡
æ¦‚è¿°
ArrayBufferå¯¹è±¡ä»£è¡¨å‚¨å­˜äºŒè¿›åˆ¶æ•°æ®çš„ä¸€æ®µå†…å­˜ï¼Œå®ƒä¸èƒ½ç›´æ¥è¯»å†™ï¼Œåªèƒ½é€šè¿‡è§†å›¾ï¼ˆTypedArrayè§†å›¾å’ŒDataViewè§†å›¾)æ¥è¯»å†™ï¼Œè§†å›¾çš„ä½œç”¨æ˜¯ä»¥æŒ‡å®šæ ¼å¼è§£è¯»äºŒè¿›åˆ¶æ•°æ®ã€‚

ArrayBufferä¹Ÿæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä»¥åˆ†é…ä¸€æ®µå¯ä»¥å­˜æ”¾æ•°æ®çš„è¿ç»­å†…å­˜åŒºåŸŸã€‚

var buf = new ArrayBuffer(32);
ä¸Šé¢ä»£ç ç”Ÿæˆäº†ä¸€æ®µ32å­—èŠ‚çš„å†…å­˜åŒºåŸŸï¼Œæ¯ä¸ªå­—èŠ‚çš„å€¼é»˜è®¤éƒ½æ˜¯0ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒArrayBufferæ„é€ å‡½æ•°çš„å‚æ•°æ˜¯æ‰€éœ€è¦çš„å†…å­˜å¤§å°ï¼ˆå•ä½å­—èŠ‚ï¼‰ã€‚

ä¸ºäº†è¯»å†™è¿™æ®µå†…å®¹ï¼Œéœ€è¦ä¸ºå®ƒæŒ‡å®šè§†å›¾ã€‚DataViewè§†å›¾çš„åˆ›å»ºï¼Œéœ€è¦æä¾›ArrayBufferå¯¹è±¡å®ä¾‹ä½œä¸ºå‚æ•°ã€‚

var buf = new ArrayBuffer(32);
var dataView = new DataView(buf);
dataView.getUint8(0) // 0
ä¸Šé¢ä»£ç å¯¹ä¸€æ®µ32å­—èŠ‚çš„å†…å­˜ï¼Œå»ºç«‹DataViewè§†å›¾ï¼Œç„¶åä»¥ä¸å¸¦ç¬¦å·çš„8ä½æ•´æ•°æ ¼å¼ï¼Œè¯»å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç»“æœå¾—åˆ°0ï¼Œå› ä¸ºåŸå§‹å†…å­˜çš„ArrayBufferå¯¹è±¡ï¼Œé»˜è®¤æ‰€æœ‰ä½éƒ½æ˜¯0ã€‚

å¦ä¸€ç§TypedArrayè§†å›¾ï¼Œä¸DataViewè§†å›¾çš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ç»„æ„é€ å‡½æ•°ï¼Œä»£è¡¨ä¸åŒçš„æ•°æ®æ ¼å¼ã€‚

var buffer = new ArrayBuffer(12);

var x1 = new Int32Array(buffer);
x1[0] = 1;
var x2 = new Uint8Array(buffer);
x2[0]  = 2;

x1[0] // 2
ä¸Šé¢ä»£ç å¯¹åŒä¸€æ®µå†…å­˜ï¼Œåˆ†åˆ«å»ºç«‹ä¸¤ç§è§†å›¾ï¼š32ä½å¸¦ç¬¦å·æ•´æ•°ï¼ˆInt32Arrayæ„é€ å‡½æ•°ï¼‰å’Œ8ä½ä¸å¸¦ç¬¦å·æ•´æ•°ï¼ˆUint8Arrayæ„é€ å‡½æ•°ï¼‰ã€‚ç”±äºä¸¤ä¸ªè§†å›¾å¯¹åº”çš„æ˜¯åŒä¸€æ®µå†…å­˜ï¼Œä¸€ä¸ªè§†å›¾ä¿®æ”¹åº•å±‚å†…å­˜ï¼Œä¼šå½±å“åˆ°å¦ä¸€ä¸ªè§†å›¾ã€‚

TypedArrayè§†å›¾çš„æ„é€ å‡½æ•°ï¼Œé™¤äº†æ¥å—ArrayBufferå®ä¾‹ä½œä¸ºå‚æ•°ï¼Œè¿˜å¯ä»¥æ¥å—æ™®é€šæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œç›´æ¥åˆ†é…å†…å­˜ç”Ÿæˆåº•å±‚çš„ArrayBufferå®ä¾‹ï¼Œå¹¶åŒæ—¶å®Œæˆå¯¹è¿™æ®µå†…å­˜çš„èµ‹å€¼ã€‚

var typedArray = new Uint8Array([0,1,2]);
typedArray.length // 3

typedArray[0] = 5;
typedArray // [5, 1, 2]
ä¸Šé¢ä»£ç ä½¿ç”¨TypedArrayè§†å›¾çš„Uint8Arrayæ„é€ å‡½æ•°ï¼Œæ–°å»ºä¸€ä¸ªä¸å¸¦ç¬¦å·çš„8ä½æ•´æ•°è§†å›¾ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒUint8Arrayç›´æ¥ä½¿ç”¨æ™®é€šæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œå¯¹åº•å±‚å†…å­˜çš„èµ‹å€¼åŒæ—¶å®Œæˆã€‚

ArrayBuffer.prototype.byteLength
ArrayBufferå®ä¾‹çš„byteLengthå±æ€§ï¼Œè¿”å›æ‰€åˆ†é…çš„å†…å­˜åŒºåŸŸçš„å­—èŠ‚é•¿åº¦ã€‚

var buffer = new ArrayBuffer(32);
buffer.byteLength
// 32
å¦‚æœè¦åˆ†é…çš„å†…å­˜åŒºåŸŸå¾ˆå¤§ï¼Œæœ‰å¯èƒ½åˆ†é…å¤±è´¥ï¼ˆå› ä¸ºæ²¡æœ‰é‚£ä¹ˆå¤šçš„è¿ç»­ç©ºä½™å†…å­˜ï¼‰ï¼Œæ‰€ä»¥æœ‰å¿…è¦æ£€æŸ¥æ˜¯å¦åˆ†é…æˆåŠŸã€‚

if (buffer.byteLength === n) {
  // æˆåŠŸ
} else {
  // å¤±è´¥
}
ArrayBuffer.prototype.slice()
ArrayBufferå®ä¾‹æœ‰ä¸€ä¸ªsliceæ–¹æ³•ï¼Œå…è®¸å°†å†…å­˜åŒºåŸŸçš„ä¸€éƒ¨åˆ†ï¼Œæ‹·è´ç”Ÿæˆä¸€ä¸ªæ–°çš„ArrayBufferå¯¹è±¡ã€‚

var buffer = new ArrayBuffer(8);
var newBuffer = buffer.slice(0, 3);
ä¸Šé¢ä»£ç æ‹·è´bufferå¯¹è±¡çš„å‰3ä¸ªå­—èŠ‚ï¼ˆä»0å¼€å§‹ï¼Œåˆ°ç¬¬3ä¸ªå­—èŠ‚å‰é¢ç»“æŸï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ArrayBufferå¯¹è±¡ã€‚sliceæ–¹æ³•å…¶å®åŒ…å«ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯å…ˆåˆ†é…ä¸€æ®µæ–°å†…å­˜ï¼Œç¬¬äºŒæ­¥æ˜¯å°†åŸæ¥é‚£ä¸ªArrayBufferå¯¹è±¡æ‹·è´è¿‡å»ã€‚

sliceæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ‹·è´å¼€å§‹çš„å­—èŠ‚åºå·ï¼ˆå«è¯¥å­—èŠ‚ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ‹·è´æˆªæ­¢çš„å­—èŠ‚åºå·ï¼ˆä¸å«è¯¥å­—èŠ‚ï¼‰ã€‚å¦‚æœçœç•¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œåˆ™é»˜è®¤åˆ°åŸArrayBufferå¯¹è±¡çš„ç»“å°¾ã€‚

é™¤äº†sliceæ–¹æ³•ï¼ŒArrayBufferå¯¹è±¡ä¸æä¾›ä»»ä½•ç›´æ¥è¯»å†™å†…å­˜çš„æ–¹æ³•ï¼Œåªå…è®¸åœ¨å…¶ä¸Šæ–¹å»ºç«‹è§†å›¾ï¼Œç„¶åé€šè¿‡è§†å›¾è¯»å†™ã€‚

ArrayBuffer.isView()
ArrayBufferæœ‰ä¸€ä¸ªé™æ€æ–¹æ³•isViewï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°æ˜¯å¦ä¸ºArrayBufferçš„è§†å›¾å®ä¾‹ã€‚è¿™ä¸ªæ–¹æ³•å¤§è‡´ç›¸å½“äºåˆ¤æ–­å‚æ•°ï¼Œæ˜¯å¦ä¸ºTypedArrayå®ä¾‹æˆ–DataViewå®ä¾‹ã€‚

var buffer = new ArrayBuffer(8);
ArrayBuffer.isView(buffer) // false

var v = new Int32Array(buffer);
ArrayBuffer.isView(v) // true
TypedArrayè§†å›¾
æ¦‚è¿°
ArrayBufferå¯¹è±¡ä½œä¸ºå†…å­˜åŒºåŸŸï¼Œå¯ä»¥å­˜æ”¾å¤šç§ç±»å‹çš„æ•°æ®ã€‚åŒä¸€æ®µå†…å­˜ï¼Œä¸åŒæ•°æ®æœ‰ä¸åŒçš„è§£è¯»æ–¹å¼ï¼Œè¿™å°±å«åšâ€œè§†å›¾â€ï¼ˆviewï¼‰ã€‚ArrayBufferæœ‰ä¸¤ç§è§†å›¾ï¼Œä¸€ç§æ˜¯TypedArrayè§†å›¾ï¼Œå¦ä¸€ç§æ˜¯DataViewè§†å›¾ã€‚å‰è€…çš„æ•°ç»„æˆå‘˜éƒ½æ˜¯åŒä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œåè€…çš„æ•°ç»„æˆå‘˜å¯ä»¥æ˜¯ä¸åŒçš„æ•°æ®ç±»å‹ã€‚

ç›®å‰ï¼ŒTypedArrayè§†å›¾ä¸€å…±åŒ…æ‹¬9ç§ç±»å‹ï¼Œæ¯ä¸€ç§è§†å›¾éƒ½æ˜¯ä¸€ç§æ„é€ å‡½æ•°ã€‚

Int8Arrayï¼š8ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦1ä¸ªå­—èŠ‚ã€‚
Uint8Arrayï¼š8ä½æ— ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦1ä¸ªå­—èŠ‚ã€‚
Uint8ClampedArrayï¼š8ä½æ— ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦1ä¸ªå­—èŠ‚ï¼Œæº¢å‡ºå¤„ç†ä¸åŒã€‚
Int16Arrayï¼š16ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦2ä¸ªå­—èŠ‚ã€‚
Uint16Arrayï¼š16ä½æ— ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦2ä¸ªå­—èŠ‚ã€‚
Int32Arrayï¼š32ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦4ä¸ªå­—èŠ‚ã€‚
Uint32Arrayï¼š32ä½æ— ç¬¦å·æ•´æ•°ï¼Œé•¿åº¦4ä¸ªå­—èŠ‚ã€‚
Float32Arrayï¼š32ä½æµ®ç‚¹æ•°ï¼Œé•¿åº¦4ä¸ªå­—èŠ‚ã€‚
Float64Arrayï¼š64ä½æµ®ç‚¹æ•°ï¼Œé•¿åº¦8ä¸ªå­—èŠ‚ã€‚
è¿™9ä¸ªæ„é€ å‡½æ•°ç”Ÿæˆçš„æ•°ç»„ï¼Œç»Ÿç§°ä¸ºTypedArrayè§†å›¾ã€‚å®ƒä»¬å¾ˆåƒæ™®é€šæ•°ç»„ï¼Œéƒ½æœ‰lengthå±æ€§ï¼Œéƒ½èƒ½ç”¨æ–¹æ‹¬å·è¿ç®—ç¬¦ï¼ˆ[]ï¼‰è·å–å•ä¸ªå…ƒç´ ï¼Œæ‰€æœ‰æ•°ç»„çš„æ–¹æ³•ï¼Œåœ¨å®ƒä»¬ä¸Šé¢éƒ½èƒ½ä½¿ç”¨ã€‚æ™®é€šæ•°ç»„ä¸TypedArrayæ•°ç»„çš„å·®å¼‚ä¸»è¦åœ¨ä»¥ä¸‹æ–¹é¢ã€‚

TypedArrayæ•°ç»„çš„æ‰€æœ‰æˆå‘˜ï¼Œéƒ½æ˜¯åŒä¸€ç§ç±»å‹ã€‚
TypedArrayæ•°ç»„çš„æˆå‘˜æ˜¯è¿ç»­çš„ï¼Œä¸ä¼šæœ‰ç©ºä½ã€‚
TypedArrayæ•°ç»„æˆå‘˜çš„é»˜è®¤å€¼ä¸º0ã€‚æ¯”å¦‚ï¼Œnew Array(10)è¿”å›ä¸€ä¸ªæ™®é€šæ•°ç»„ï¼Œé‡Œé¢æ²¡æœ‰ä»»ä½•æˆå‘˜ï¼Œåªæ˜¯10ä¸ªç©ºä½ï¼›new Uint8Array(10)è¿”å›ä¸€ä¸ªTypedArrayæ•°ç»„ï¼Œé‡Œé¢10ä¸ªæˆå‘˜éƒ½æ˜¯0ã€‚
TypedArrayæ•°ç»„åªæ˜¯ä¸€å±‚è§†å›¾ï¼Œæœ¬èº«ä¸å‚¨å­˜æ•°æ®ï¼Œå®ƒçš„æ•°æ®éƒ½å‚¨å­˜åœ¨åº•å±‚çš„ArrayBufferå¯¹è±¡ä¹‹ä¸­ï¼Œè¦è·å–åº•å±‚å¯¹è±¡å¿…é¡»ä½¿ç”¨bufferå±æ€§ã€‚
æ„é€ å‡½æ•°
TypedArrayæ•°ç»„æä¾›9ç§æ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”Ÿæˆç›¸åº”ç±»å‹çš„æ•°ç»„å®ä¾‹ã€‚

æ„é€ å‡½æ•°æœ‰å¤šç§ç”¨æ³•ã€‚

ï¼ˆ1ï¼‰TypedArray(buffer, byteOffset=0, length?)

åŒä¸€ä¸ªArrayBufferå¯¹è±¡ä¹‹ä¸Šï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå»ºç«‹å¤šä¸ªè§†å›¾ã€‚

// åˆ›å»ºä¸€ä¸ª8å­—èŠ‚çš„ArrayBuffer
var b = new ArrayBuffer(8);

// åˆ›å»ºä¸€ä¸ªæŒ‡å‘bçš„Int32è§†å›¾ï¼Œå¼€å§‹äºå­—èŠ‚0ï¼Œç›´åˆ°ç¼“å†²åŒºçš„æœ«å°¾
var v1 = new Int32Array(b);

// åˆ›å»ºä¸€ä¸ªæŒ‡å‘bçš„Uint8è§†å›¾ï¼Œå¼€å§‹äºå­—èŠ‚2ï¼Œç›´åˆ°ç¼“å†²åŒºçš„æœ«å°¾
var v2 = new Uint8Array(b, 2);

// åˆ›å»ºä¸€ä¸ªæŒ‡å‘bçš„Int16è§†å›¾ï¼Œå¼€å§‹äºå­—èŠ‚2ï¼Œé•¿åº¦ä¸º2
var v3 = new Int16Array(b, 2, 2);
ä¸Šé¢ä»£ç åœ¨ä¸€æ®µé•¿åº¦ä¸º8ä¸ªå­—èŠ‚çš„å†…å­˜ï¼ˆbï¼‰ä¹‹ä¸Šï¼Œç”Ÿæˆäº†ä¸‰ä¸ªè§†å›¾ï¼šv1ã€v2å’Œv3ã€‚

è§†å›¾çš„æ„é€ å‡½æ•°å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š

ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¿…éœ€ï¼‰ï¼šè§†å›¾å¯¹åº”çš„åº•å±‚ArrayBufferå¯¹è±¡ã€‚
ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼šè§†å›¾å¼€å§‹çš„å­—èŠ‚åºå·ï¼Œé»˜è®¤ä»0å¼€å§‹ã€‚
ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼šè§†å›¾åŒ…å«çš„æ•°æ®ä¸ªæ•°ï¼Œé»˜è®¤ç›´åˆ°æœ¬æ®µå†…å­˜åŒºåŸŸç»“æŸã€‚
å› æ­¤ï¼Œv1ã€v2å’Œv3æ˜¯é‡å çš„ï¼šv1[0]æ˜¯ä¸€ä¸ª32ä½æ•´æ•°ï¼ŒæŒ‡å‘å­—èŠ‚0ï½å­—èŠ‚3ï¼›v2[0]æ˜¯ä¸€ä¸ª8ä½æ— ç¬¦å·æ•´æ•°ï¼ŒæŒ‡å‘å­—èŠ‚2ï¼›v3[0]æ˜¯ä¸€ä¸ª16ä½æ•´æ•°ï¼ŒæŒ‡å‘å­—èŠ‚2ï½å­—èŠ‚3ã€‚åªè¦ä»»ä½•ä¸€ä¸ªè§†å›¾å¯¹å†…å­˜æœ‰æ‰€ä¿®æ”¹ï¼Œå°±ä¼šåœ¨å¦å¤–ä¸¤ä¸ªè§†å›¾ä¸Šååº”å‡ºæ¥ã€‚

æ³¨æ„ï¼ŒbyteOffsetå¿…é¡»ä¸æ‰€è¦å»ºç«‹çš„æ•°æ®ç±»å‹ä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

var buffer = new ArrayBuffer(8);
var i16 = new Int16Array(buffer, 1);
// Uncaught RangeError: start offset of Int16Array should be a multiple of 2
ä¸Šé¢ä»£ç ä¸­ï¼Œæ–°ç”Ÿæˆä¸€ä¸ª8ä¸ªå­—èŠ‚çš„ArrayBufferå¯¹è±¡ï¼Œç„¶ååœ¨è¿™ä¸ªå¯¹è±¡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå»ºç«‹å¸¦ç¬¦å·çš„16ä½æ•´æ•°è§†å›¾ï¼Œç»“æœæŠ¥é”™ã€‚å› ä¸ºï¼Œå¸¦ç¬¦å·çš„16ä½æ•´æ•°éœ€è¦ä¸¤ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥byteOffsetå‚æ•°å¿…é¡»èƒ½å¤Ÿè¢«2æ•´é™¤ã€‚

å¦‚æœæƒ³ä»ä»»æ„å­—èŠ‚å¼€å§‹è§£è¯»ArrayBufferå¯¹è±¡ï¼Œå¿…é¡»ä½¿ç”¨DataViewè§†å›¾ï¼Œå› ä¸ºTypedArrayè§†å›¾åªæä¾›9ç§å›ºå®šçš„è§£è¯»æ ¼å¼ã€‚

ï¼ˆ2ï¼‰TypedArray(length)

è§†å›¾è¿˜å¯ä»¥ä¸é€šè¿‡ArrayBufferå¯¹è±¡ï¼Œç›´æ¥åˆ†é…å†…å­˜è€Œç”Ÿæˆã€‚

var f64a = new Float64Array(8);
f64a[0] = 10;
f64a[1] = 20;
f64a[2] = f64a[0] + f64a[1];
ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ª8ä¸ªæˆå‘˜çš„Float64Arrayæ•°ç»„ï¼ˆå…±64å­—èŠ‚ï¼‰ï¼Œç„¶åä¾æ¬¡å¯¹æ¯ä¸ªæˆå‘˜èµ‹å€¼ã€‚è¿™æ—¶ï¼Œè§†å›¾æ„é€ å‡½æ•°çš„å‚æ•°å°±æ˜¯æˆå‘˜çš„ä¸ªæ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè§†å›¾æ•°ç»„çš„èµ‹å€¼æ“ä½œä¸æ™®é€šæ•°ç»„çš„æ“ä½œæ¯«æ— ä¸¤æ ·ã€‚

ï¼ˆ3ï¼‰TypedArray(typedArray)

TypedArrayæ•°ç»„çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥æ¥å—å¦ä¸€ä¸ªTypedArrayå®ä¾‹ä½œä¸ºå‚æ•°ã€‚

var typedArray = new Int8Array(new Uint8Array(4));
ä¸Šé¢ä»£ç ä¸­ï¼ŒInt8Arrayæ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªUint8Arrayå®ä¾‹ä½œä¸ºå‚æ•°ã€‚

æ³¨æ„ï¼Œæ­¤æ—¶ç”Ÿæˆçš„æ–°æ•°ç»„ï¼Œåªæ˜¯å¤åˆ¶äº†å‚æ•°æ•°ç»„çš„å€¼ï¼Œå¯¹åº”çš„åº•å±‚å†…å­˜æ˜¯ä¸ä¸€æ ·çš„ã€‚æ–°æ•°ç»„ä¼šå¼€è¾Ÿä¸€æ®µæ–°çš„å†…å­˜å‚¨å­˜æ•°æ®ï¼Œä¸ä¼šåœ¨åŸæ•°ç»„çš„å†…å­˜ä¹‹ä¸Šå»ºç«‹è§†å›¾ã€‚

var x = new Int8Array([1, 1]);
var y = new Int8Array(x);
x[0] // 1
y[0] // 1

x[0] = 2;
y[0] // 1
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„yæ˜¯ä»¥æ•°ç»„xä¸ºæ¨¡æ¿è€Œç”Ÿæˆçš„ï¼Œå½“xå˜åŠ¨çš„æ—¶å€™ï¼Œyå¹¶æ²¡æœ‰å˜åŠ¨ã€‚

å¦‚æœæƒ³åŸºäºåŒä¸€æ®µå†…å­˜ï¼Œæ„é€ ä¸åŒçš„è§†å›¾ï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚

var x = new Int8Array([1, 1]);
var y = new Int8Array(x.buffer);
x[0] // 1
y[0] // 1

x[0] = 2;
y[0] // 2
ï¼ˆ4ï¼‰TypedArray(arrayLikeObject)

æ„é€ å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šæ•°ç»„ï¼Œç„¶åç›´æ¥ç”ŸæˆTypedArrayå®ä¾‹ã€‚

var typedArray = new Uint8Array([1, 2, 3, 4]);
æ³¨æ„ï¼Œè¿™æ—¶TypedArrayè§†å›¾ä¼šé‡æ–°å¼€è¾Ÿå†…å­˜ï¼Œä¸ä¼šåœ¨åŸæ•°ç»„çš„å†…å­˜ä¸Šå»ºç«‹è§†å›¾ã€‚

ä¸Šé¢ä»£ç ä»ä¸€ä¸ªæ™®é€šçš„æ•°ç»„ï¼Œç”Ÿæˆä¸€ä¸ª8ä½æ— ç¬¦å·æ•´æ•°çš„TypedArrayå®ä¾‹ã€‚

TypedArrayæ•°ç»„ä¹Ÿå¯ä»¥è½¬æ¢å›æ™®é€šæ•°ç»„ã€‚

var normalArray = Array.prototype.slice.call(typedArray);
æ•°ç»„æ–¹æ³•
æ™®é€šæ•°ç»„çš„æ“ä½œæ–¹æ³•å’Œå±æ€§ï¼Œå¯¹TypedArrayæ•°ç»„å®Œå…¨é€‚ç”¨ã€‚

TypedArray.prototype.copyWithin(target, start[, end = this.length])
TypedArray.prototype.entries()
TypedArray.prototype.every(callbackfn, thisArg?)
TypedArray.prototype.fill(value, start=0, end=this.length)
TypedArray.prototype.filter(callbackfn, thisArg?)
TypedArray.prototype.find(predicate, thisArg?)
TypedArray.prototype.findIndex(predicate, thisArg?)
TypedArray.prototype.forEach(callbackfn, thisArg?)
TypedArray.prototype.indexOf(searchElement, fromIndex=0)
TypedArray.prototype.join(separator)
TypedArray.prototype.keys()
TypedArray.prototype.lastIndexOf(searchElement, fromIndex?)
TypedArray.prototype.map(callbackfn, thisArg?)
TypedArray.prototype.reduce(callbackfn, initialValue?)
TypedArray.prototype.reduceRight(callbackfn, initialValue?)
TypedArray.prototype.reverse()
TypedArray.prototype.slice(start=0, end=this.length)
TypedArray.prototype.some(callbackfn, thisArg?)
TypedArray.prototype.sort(comparefn)
TypedArray.prototype.toLocaleString(reserved1?, reserved2?)
TypedArray.prototype.toString()
TypedArray.prototype.values()
ä¸Šé¢æ‰€æœ‰æ–¹æ³•çš„ç”¨æ³•ï¼Œè¯·å‚é˜…æ•°ç»„æ–¹æ³•çš„ä»‹ç»ï¼Œè¿™é‡Œä¸å†é‡å¤äº†ã€‚

æ³¨æ„ï¼ŒTypedArrayæ•°ç»„æ²¡æœ‰concatæ–¹æ³•ã€‚å¦‚æœæƒ³è¦åˆå¹¶å¤šä¸ªTypedArrayæ•°ç»„ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ã€‚

function concatenate(resultConstructor, ...arrays) {
  let totalLength = 0;
  for (let arr of arrays) {
    totalLength += arr.length;
  }
  let result = new resultConstructor(totalLength);
  let offset = 0;
  for (let arr of arrays) {
    result.set(arr, offset);
    offset += arr.length;
  }
  return result;
}

concatenate(Uint8Array, Uint8Array.of(1, 2), Uint8Array.of(3, 4))
// Uint8Array [1, 2, 3, 4]
å¦å¤–ï¼ŒTypedArrayæ•°ç»„ä¸æ™®é€šæ•°ç»„ä¸€æ ·ï¼Œéƒ¨ç½²äº†Iteratoræ¥å£ï¼Œæ‰€ä»¥å¯ä»¥è¢«éå†ã€‚

let ui8 = Uint8Array.of(0, 1, 2);
for (let byte of ui8) {
  console.log(byte);
}
// 0
// 1
// 2
å­—èŠ‚åº
å­—èŠ‚åºæŒ‡çš„æ˜¯æ•°å€¼åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºæ–¹å¼ã€‚

var buffer = new ArrayBuffer(16);
var int32View = new Int32Array(buffer);

for (var i = 0; i < int32View.length; i++) {
  int32View[i] = i * 2;
}
ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ª16å­—èŠ‚çš„ArrayBufferå¯¹è±¡ï¼Œç„¶ååœ¨å®ƒçš„åŸºç¡€ä¸Šï¼Œå»ºç«‹äº†ä¸€ä¸ª32ä½æ•´æ•°çš„è§†å›¾ã€‚ç”±äºæ¯ä¸ª32ä½æ•´æ•°å æ®4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸€å…±å¯ä»¥å†™å…¥4ä¸ªæ•´æ•°ï¼Œä¾æ¬¡ä¸º0ï¼Œ2ï¼Œ4ï¼Œ6ã€‚

å¦‚æœåœ¨è¿™æ®µæ•°æ®ä¸Šæ¥ç€å»ºç«‹ä¸€ä¸ª16ä½æ•´æ•°çš„è§†å›¾ï¼Œåˆ™å¯ä»¥è¯»å‡ºå®Œå…¨ä¸ä¸€æ ·çš„ç»“æœã€‚

var int16View = new Int16Array(buffer);

for (var i = 0; i < int16View.length; i++) {
  console.log("Entry " + i + ": " + int16View[i]);
}
// Entry 0: 0
// Entry 1: 0
// Entry 2: 2
// Entry 3: 0
// Entry 4: 4
// Entry 5: 0
// Entry 6: 6
// Entry 7: 0
ç”±äºæ¯ä¸ª16ä½æ•´æ•°å æ®2ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ•´ä¸ªArrayBufferå¯¹è±¡ç°åœ¨åˆ†æˆ8æ®µã€‚ç„¶åï¼Œç”±äºx86ä½“ç³»çš„è®¡ç®—æœºéƒ½é‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼ˆlittle endianï¼‰ï¼Œç›¸å¯¹é‡è¦çš„å­—èŠ‚æ’åœ¨åé¢çš„å†…å­˜åœ°å€ï¼Œç›¸å¯¹ä¸é‡è¦å­—èŠ‚æ’åœ¨å‰é¢çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥å°±å¾—åˆ°äº†ä¸Šé¢çš„ç»“æœã€‚

æ¯”å¦‚ï¼Œä¸€ä¸ªå æ®å››ä¸ªå­—èŠ‚çš„16è¿›åˆ¶æ•°0x12345678ï¼Œå†³å®šå…¶å¤§å°çš„æœ€é‡è¦çš„å­—èŠ‚æ˜¯â€œ12â€ï¼Œæœ€ä¸é‡è¦çš„æ˜¯â€œ78â€ã€‚å°ç«¯å­—èŠ‚åºå°†æœ€ä¸é‡è¦çš„å­—èŠ‚æ’åœ¨å‰é¢ï¼Œå‚¨å­˜é¡ºåºå°±æ˜¯78563412ï¼›å¤§ç«¯å­—èŠ‚åºåˆ™å®Œå…¨ç›¸åï¼Œå°†æœ€é‡è¦çš„å­—èŠ‚æ’åœ¨å‰é¢ï¼Œå‚¨å­˜é¡ºåºå°±æ˜¯12345678ã€‚ç›®å‰ï¼Œæ‰€æœ‰ä¸ªäººç”µè„‘å‡ ä¹éƒ½æ˜¯å°ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥TypedArrayæ•°ç»„å†…éƒ¨ä¹Ÿé‡‡ç”¨å°ç«¯å­—èŠ‚åºè¯»å†™æ•°æ®ï¼Œæˆ–è€…æ›´å‡†ç¡®çš„è¯´ï¼ŒæŒ‰ç…§æœ¬æœºæ“ä½œç³»ç»Ÿè®¾å®šçš„å­—èŠ‚åºè¯»å†™æ•°æ®ã€‚

è¿™å¹¶ä¸æ„å‘³å¤§ç«¯å­—èŠ‚åºä¸é‡è¦ï¼Œäº‹å®ä¸Šï¼Œå¾ˆå¤šç½‘ç»œè®¾å¤‡å’Œç‰¹å®šçš„æ“ä½œç³»ç»Ÿé‡‡ç”¨çš„æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚è¿™å°±å¸¦æ¥ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼šå¦‚æœä¸€æ®µæ•°æ®æ˜¯å¤§ç«¯å­—èŠ‚åºï¼ŒTypedArrayæ•°ç»„å°†æ— æ³•æ­£ç¡®è§£æï¼Œå› ä¸ºå®ƒåªèƒ½å¤„ç†å°ç«¯å­—èŠ‚åºï¼ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaScriptå¼•å…¥DataViewå¯¹è±¡ï¼Œå¯ä»¥è®¾å®šå­—èŠ‚åºï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

// å‡å®šæŸæ®µbufferåŒ…å«å¦‚ä¸‹å­—èŠ‚ [0x02, 0x01, 0x03, 0x07]
var buffer = new ArrayBuffer(4);
var v1 = new Uint8Array(buffer);
v1[0] = 2;
v1[1] = 1;
v1[2] = 3;
v1[3] = 7;

var uInt16View = new Uint16Array(buffer);

// è®¡ç®—æœºé‡‡ç”¨å°ç«¯å­—èŠ‚åº
// æ‰€ä»¥å¤´ä¸¤ä¸ªå­—èŠ‚ç­‰äº258
if (uInt16View[0] === 258) {
  console.log('OK'); // "OK"
}

// èµ‹å€¼è¿ç®—
uInt16View[0] = 255;    // å­—èŠ‚å˜ä¸º[0xFF, 0x00, 0x03, 0x07]
uInt16View[0] = 0xff05; // å­—èŠ‚å˜ä¸º[0x05, 0xFF, 0x03, 0x07]
uInt16View[1] = 0x0210; // å­—èŠ‚å˜ä¸º[0x05, 0xFF, 0x10, 0x02]
ä¸‹é¢çš„å‡½æ•°å¯ä»¥ç”¨æ¥åˆ¤æ–­ï¼Œå½“å‰è§†å›¾æ˜¯å°ç«¯å­—èŠ‚åºï¼Œè¿˜æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚

const BIG_ENDIAN = Symbol('BIG_ENDIAN');
const LITTLE_ENDIAN = Symbol('LITTLE_ENDIAN');

function getPlatformEndianness() {
  let arr32 = Uint32Array.of(0x12345678);
  let arr8 = new Uint8Array(arr32.buffer);
  switch ((arr8[0]*0x1000000) + (arr8[1]*0x10000) + (arr8[2]*0x100) + (arr8[3])) {
    case 0x12345678:
      return BIG_ENDIAN;
    case 0x78563412:
      return LITTLE_ENDIAN;
    default:
      throw new Error('Unknown endianness');
  }
}
æ€»ä¹‹ï¼Œä¸æ™®é€šæ•°ç»„ç›¸æ¯”ï¼ŒTypedArrayæ•°ç»„çš„æœ€å¤§ä¼˜ç‚¹å°±æ˜¯å¯ä»¥ç›´æ¥æ“ä½œå†…å­˜ï¼Œä¸éœ€è¦æ•°æ®ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥é€Ÿåº¦å¿«å¾—å¤šã€‚

BYTES_PER_ELEMENTå±æ€§
æ¯ä¸€ç§è§†å›¾çš„æ„é€ å‡½æ•°ï¼Œéƒ½æœ‰ä¸€ä¸ªBYTES_PER_ELEMENTå±æ€§ï¼Œè¡¨ç¤ºè¿™ç§æ•°æ®ç±»å‹å æ®çš„å­—èŠ‚æ•°ã€‚

Int8Array.BYTES_PER_ELEMENT // 1
Uint8Array.BYTES_PER_ELEMENT // 1
Int16Array.BYTES_PER_ELEMENT // 2
Uint16Array.BYTES_PER_ELEMENT // 2
Int32Array.BYTES_PER_ELEMENT // 4
Uint32Array.BYTES_PER_ELEMENT // 4
Float32Array.BYTES_PER_ELEMENT // 4
Float64Array.BYTES_PER_ELEMENT // 8
è¿™ä¸ªå±æ€§åœ¨TypedArrayå®ä¾‹ä¸Šä¹Ÿèƒ½è·å–ï¼Œå³æœ‰TypedArray.prototype.BYTES_PER_ELEMENTã€‚

ArrayBufferä¸å­—ç¬¦ä¸²çš„äº’ç›¸è½¬æ¢
ArrayBufferè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œæˆ–è€…å­—ç¬¦ä¸²è½¬ä¸ºArrayBufferï¼Œæœ‰ä¸€ä¸ªå‰æï¼Œå³å­—ç¬¦ä¸²çš„ç¼–ç æ–¹æ³•æ˜¯ç¡®å®šçš„ã€‚å‡å®šå­—ç¬¦ä¸²é‡‡ç”¨UTF-16ç¼–ç ï¼ˆJavaScriptçš„å†…éƒ¨ç¼–ç æ–¹å¼ï¼‰ï¼Œå¯ä»¥è‡ªå·±ç¼–å†™è½¬æ¢å‡½æ•°ã€‚

// ArrayBufferè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå‚æ•°ä¸ºArrayBufferå¯¹è±¡
function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}

// å­—ç¬¦ä¸²è½¬ä¸ºArrayBufferå¯¹è±¡ï¼Œå‚æ•°ä¸ºå­—ç¬¦ä¸²
function str2ab(str) {
  var buf = new ArrayBuffer(str.length * 2); // æ¯ä¸ªå­—ç¬¦å ç”¨2ä¸ªå­—èŠ‚
  var bufView = new Uint16Array(buf);
  for (var i = 0, strLen = str.length; i < strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return buf;
}
æº¢å‡º
ä¸åŒçš„è§†å›¾ç±»å‹ï¼Œæ‰€èƒ½å®¹çº³çš„æ•°å€¼èŒƒå›´æ˜¯ç¡®å®šçš„ã€‚è¶…å‡ºè¿™ä¸ªèŒƒå›´ï¼Œå°±ä¼šå‡ºç°æº¢å‡ºã€‚æ¯”å¦‚ï¼Œ8ä½è§†å›¾åªèƒ½å®¹çº³ä¸€ä¸ª8ä½çš„äºŒè¿›åˆ¶å€¼ï¼Œå¦‚æœæ”¾å…¥ä¸€ä¸ª9ä½çš„å€¼ï¼Œå°±ä¼šæº¢å‡ºã€‚

TypedArrayæ•°ç»„çš„æº¢å‡ºå¤„ç†è§„åˆ™ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠ›å¼ƒæº¢å‡ºçš„ä½ï¼Œç„¶åæŒ‰ç…§è§†å›¾ç±»å‹è¿›è¡Œè§£é‡Šã€‚

var uint8 = new Uint8Array(1);

uint8[0] = 256;
uint8[0] // 0

uint8[0] = -1;
uint8[0] // 255
ä¸Šé¢ä»£ç ä¸­ï¼Œuint8æ˜¯ä¸€ä¸ª8ä½è§†å›¾ï¼Œè€Œ256çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯ä¸€ä¸ª9ä½çš„å€¼100000000ï¼Œè¿™æ—¶å°±ä¼šå‘ç”Ÿæº¢å‡ºã€‚æ ¹æ®è§„åˆ™ï¼Œåªä¼šä¿ç•™å8ä½ï¼Œå³00000000ã€‚uint8è§†å›¾çš„è§£é‡Šè§„åˆ™æ˜¯æ— ç¬¦å·çš„8ä½æ•´æ•°ï¼Œæ‰€ä»¥00000000å°±æ˜¯0ã€‚

è´Ÿæ•°åœ¨è®¡ç®—æœºå†…éƒ¨é‡‡ç”¨â€œ2çš„è¡¥ç â€è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°†å¯¹åº”çš„æ­£æ•°å€¼è¿›è¡Œå¦è¿ç®—ï¼Œç„¶ååŠ 1ã€‚æ¯”å¦‚ï¼Œ-1å¯¹åº”çš„æ­£å€¼æ˜¯1ï¼Œè¿›è¡Œå¦è¿ç®—ä»¥åï¼Œå¾—åˆ°11111110ï¼Œå†åŠ ä¸Š1å°±æ˜¯è¡¥ç å½¢å¼11111111ã€‚uint8æŒ‰ç…§æ— ç¬¦å·çš„8ä½æ•´æ•°è§£é‡Š11111111ï¼Œè¿”å›ç»“æœå°±æ˜¯255ã€‚

ä¸€ä¸ªç®€å•è½¬æ¢è§„åˆ™ï¼Œå¯ä»¥è¿™æ ·è¡¨ç¤ºã€‚

æ­£å‘æº¢å‡ºï¼ˆoverflowï¼‰ï¼šå½“è¾“å…¥å€¼å¤§äºå½“å‰æ•°æ®ç±»å‹çš„æœ€å¤§å€¼ï¼Œç»“æœç­‰äºå½“å‰æ•°æ®ç±»å‹çš„æœ€å°å€¼åŠ ä¸Šä½™å€¼ï¼Œå†å‡å»1ã€‚
è´Ÿå‘æº¢å‡ºï¼ˆunderflowï¼‰ï¼šå½“è¾“å…¥å€¼å°äºå½“å‰æ•°æ®ç±»å‹çš„æœ€å°å€¼ï¼Œç»“æœç­‰äºå½“å‰æ•°æ®ç±»å‹çš„æœ€å¤§å€¼å‡å»ä½™å€¼ï¼Œå†åŠ ä¸Š1ã€‚
è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

var int8 = new Int8Array(1);

int8[0] = 128;
int8[0] // -128

int8[0] = -129;
int8[0] // 127
ä¸Šé¢ä¾‹å­ä¸­ï¼Œint8æ˜¯ä¸€ä¸ªå¸¦ç¬¦å·çš„8ä½æ•´æ•°è§†å›¾ï¼Œå®ƒçš„æœ€å¤§å€¼æ˜¯127ï¼Œæœ€å°å€¼æ˜¯-128ã€‚è¾“å…¥å€¼ä¸º128æ—¶ï¼Œç›¸å½“äºæ­£å‘æº¢å‡º1ï¼Œæ ¹æ®â€œæœ€å°å€¼åŠ ä¸Šä½™å€¼ï¼Œå†å‡å»1â€çš„è§„åˆ™ï¼Œå°±ä¼šè¿”å›-128ï¼›è¾“å…¥å€¼ä¸º-129æ—¶ï¼Œç›¸å½“äºè´Ÿå‘æº¢å‡º1ï¼Œæ ¹æ®â€œæœ€å¤§å€¼å‡å»ä½™å€¼ï¼Œå†åŠ ä¸Š1â€çš„è§„åˆ™ï¼Œå°±ä¼šè¿”å›127ã€‚

Uint8ClampedArrayè§†å›¾çš„æº¢å‡ºè§„åˆ™ï¼Œä¸ä¸Šé¢çš„è§„åˆ™ä¸åŒã€‚å®ƒè§„å®šï¼Œå‡¡æ˜¯å‘ç”Ÿæ­£å‘æº¢å‡ºï¼Œè¯¥å€¼ä¸€å¾‹ç­‰äºå½“å‰æ•°æ®ç±»å‹çš„æœ€å¤§å€¼ï¼Œå³255ï¼›å¦‚æœå‘ç”Ÿè´Ÿå‘æº¢å‡ºï¼Œè¯¥å€¼ä¸€å¾‹ç­‰äºå½“å‰æ•°æ®ç±»å‹çš„æœ€å°å€¼ï¼Œå³0ã€‚

var uint8c = new Uint8ClampedArray(1);

uint8c[0] = 256;
uint8c[0] // 255

uint8c[0] = -1;
uint8c[0] // 0
ä¸Šé¢ä¾‹å­ä¸­ï¼Œuint8Cæ˜¯ä¸€ä¸ªUint8ClampedArrayè§†å›¾ï¼Œæ­£å‘æº¢å‡ºæ—¶éƒ½è¿”å›255ï¼Œè´Ÿå‘æº¢å‡ºéƒ½è¿”å›0ã€‚

TypedArray.prototype.buffer
TypedArrayå®ä¾‹çš„bufferå±æ€§ï¼Œè¿”å›æ•´æ®µå†…å­˜åŒºåŸŸå¯¹åº”çš„ArrayBufferå¯¹è±¡ã€‚è¯¥å±æ€§ä¸ºåªè¯»å±æ€§ã€‚

var a = new Float32Array(64);
var b = new Uint8Array(a.buffer);
ä¸Šé¢ä»£ç çš„aè§†å›¾å¯¹è±¡å’Œbè§†å›¾å¯¹è±¡ï¼Œå¯¹åº”åŒä¸€ä¸ªArrayBufferå¯¹è±¡ï¼Œå³åŒä¸€æ®µå†…å­˜ã€‚

TypedArray.prototype.byteLengthï¼ŒTypedArray.prototype.byteOffset
byteLengthå±æ€§è¿”å›TypedArrayæ•°ç»„å æ®çš„å†…å­˜é•¿åº¦ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚byteOffsetå±æ€§è¿”å›TypedArrayæ•°ç»„ä»åº•å±‚ArrayBufferå¯¹è±¡çš„å“ªä¸ªå­—èŠ‚å¼€å§‹ã€‚è¿™ä¸¤ä¸ªå±æ€§éƒ½æ˜¯åªè¯»å±æ€§ã€‚

var b = new ArrayBuffer(8);

var v1 = new Int32Array(b);
var v2 = new Uint8Array(b, 2);
var v3 = new Int16Array(b, 2, 2);

v1.byteLength // 8
v2.byteLength // 6
v3.byteLength // 4

v1.byteOffset // 0
v2.byteOffset // 2
v3.byteOffset // 2
TypedArray.prototype.length
lengthå±æ€§è¡¨ç¤ºTypedArrayæ•°ç»„å«æœ‰å¤šå°‘ä¸ªæˆå‘˜ã€‚æ³¨æ„å°†byteLengthå±æ€§å’Œlengthå±æ€§åŒºåˆ†ï¼Œå‰è€…æ˜¯å­—èŠ‚é•¿åº¦ï¼Œåè€…æ˜¯æˆå‘˜é•¿åº¦ã€‚

var a = new Int16Array(8);

a.length // 8
a.byteLength // 16
TypedArray.prototype.set()
TypedArrayæ•°ç»„çš„setæ–¹æ³•ç”¨äºå¤åˆ¶æ•°ç»„ï¼ˆæ™®é€šæ•°ç»„æˆ–TypedArrayæ•°ç»„ï¼‰ï¼Œä¹Ÿå°±æ˜¯å°†ä¸€æ®µå†…å®¹å®Œå…¨å¤åˆ¶åˆ°å¦ä¸€æ®µå†…å­˜ã€‚

var a = new Uint8Array(8);
var b = new Uint8Array(8);

b.set(a);
ä¸Šé¢ä»£ç å¤åˆ¶aæ•°ç»„çš„å†…å®¹åˆ°bæ•°ç»„ï¼Œå®ƒæ˜¯æ•´æ®µå†…å­˜çš„å¤åˆ¶ï¼Œæ¯”ä¸€ä¸ªä¸ªæ‹·è´æˆå‘˜çš„é‚£ç§å¤åˆ¶å¿«å¾—å¤šã€‚

setæ–¹æ³•è¿˜å¯ä»¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¡¨ç¤ºä»bå¯¹è±¡çš„å“ªä¸€ä¸ªæˆå‘˜å¼€å§‹å¤åˆ¶aå¯¹è±¡ã€‚

var a = new Uint16Array(8);
var b = new Uint16Array(10);

b.set(a, 2)
ä¸Šé¢ä»£ç çš„bæ•°ç»„æ¯”aæ•°ç»„å¤šä¸¤ä¸ªæˆå‘˜ï¼Œæ‰€ä»¥ä»b[2]å¼€å§‹å¤åˆ¶ã€‚

TypedArray.prototype.subarray()
subarrayæ–¹æ³•æ˜¯å¯¹äºTypedArrayæ•°ç»„çš„ä¸€éƒ¨åˆ†ï¼Œå†å»ºç«‹ä¸€ä¸ªæ–°çš„è§†å›¾ã€‚

var a = new Uint16Array(8);
var b = a.subarray(2,3);

a.byteLength // 16
b.byteLength // 2
subarrayæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯èµ·å§‹çš„æˆå‘˜åºå·ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç»“æŸçš„æˆå‘˜åºå·ï¼ˆä¸å«è¯¥æˆå‘˜ï¼‰ï¼Œå¦‚æœçœç•¥åˆ™åŒ…å«å‰©ä½™çš„å…¨éƒ¨æˆå‘˜ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çš„a.subarray(2,3)ï¼Œæ„å‘³ç€båªåŒ…å«a[2]ä¸€ä¸ªæˆå‘˜ï¼Œå­—èŠ‚é•¿åº¦ä¸º2ã€‚

TypedArray.prototype.slice()
TypeArrayå®ä¾‹çš„sliceæ–¹æ³•ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªæŒ‡å®šä½ç½®çš„æ–°çš„TypedArrayå®ä¾‹ã€‚

let ui8 = Uint8Array.of(0, 1, 2);
ui8.slice(-1)
// Uint8Array [ 2 ]
ä¸Šé¢ä»£ç ä¸­ï¼Œui8æ˜¯8ä½æ— ç¬¦å·æ•´æ•°æ•°ç»„è§†å›¾çš„ä¸€ä¸ªå®ä¾‹ã€‚å®ƒçš„sliceæ–¹æ³•å¯ä»¥ä»å½“å‰è§†å›¾ä¹‹ä¸­ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„è§†å›¾å®ä¾‹ã€‚

sliceæ–¹æ³•çš„å‚æ•°ï¼Œè¡¨ç¤ºåŸæ•°ç»„çš„å…·ä½“ä½ç½®ï¼Œå¼€å§‹ç”Ÿæˆæ–°æ•°ç»„ã€‚è´Ÿå€¼è¡¨ç¤ºé€†å‘çš„ä½ç½®ï¼Œå³-1ä¸ºå€’æ•°ç¬¬ä¸€ä¸ªä½ç½®ï¼Œ-2è¡¨ç¤ºå€’æ•°ç¬¬äºŒä¸ªä½ç½®ï¼Œä»¥æ­¤ç±»æ¨ã€‚

TypedArray.of()
TypedArrayæ•°ç»„çš„æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œéƒ½æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ofï¼Œç”¨äºå°†å‚æ•°è½¬ä¸ºä¸€ä¸ªTypedArrayå®ä¾‹ã€‚

Float32Array.of(0.151, -8, 3.7)
// Float32Array [ 0.151, -8, 3.7 ]
ä¸‹é¢ä¸‰ç§æ–¹æ³•éƒ½ä¼šç”ŸæˆåŒæ ·ä¸€ä¸ªTypedArrayæ•°ç»„ã€‚

// æ–¹æ³•ä¸€
let tarr = new Uint8Array([1,2,3]);

// æ–¹æ³•äºŒ
let tarr = Uint8Array.of(1,2,3);

// æ–¹æ³•ä¸‰
let tarr = new Uint8Array(3);
tarr[0] = 1;
tarr[1] = 2;
tarr[2] = 3;
TypedArray.from()
é™æ€æ–¹æ³•fromæ¥å—ä¸€ä¸ªå¯éå†çš„æ•°æ®ç»“æ„ï¼ˆæ¯”å¦‚æ•°ç»„ï¼‰ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªåŸºäºè¿™ä¸ªç»“æ„çš„TypedArrayå®ä¾‹ã€‚

Uint16Array.from([0, 1, 2])
// Uint16Array [ 0, 1, 2 ]
è¿™ä¸ªæ–¹æ³•è¿˜å¯ä»¥å°†ä¸€ç§TypedArrayå®ä¾‹ï¼Œè½¬ä¸ºå¦ä¸€ç§ã€‚

var ui16 = Uint16Array.from(Uint8Array.of(0, 1, 2));
ui16 instanceof Uint16Array // true
fromæ–¹æ³•è¿˜å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œéå†ï¼ŒåŠŸèƒ½ç±»ä¼¼mapæ–¹æ³•ã€‚

Int8Array.of(127, 126, 125).map(x => 2 * x)
// Int8Array [ -2, -4, -6 ]

Int16Array.from(Int8Array.of(127, 126, 125), x => 2 * x)
// Int16Array [ 254, 252, 250 ]
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œfromæ–¹æ³•æ²¡æœ‰å‘ç”Ÿæº¢å‡ºï¼Œè¿™è¯´æ˜éå†ä¸æ˜¯é’ˆå¯¹åŸæ¥çš„8ä½æ•´æ•°æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œfromä¼šå°†ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šçš„TypedArrayæ•°ç»„ï¼Œæ‹·è´åˆ°å¦ä¸€æ®µå†…å­˜ä¹‹ä¸­ï¼Œå¤„ç†ä¹‹åå†å°†ç»“æœè½¬æˆæŒ‡å®šçš„æ•°ç»„æ ¼å¼ã€‚

å¤åˆè§†å›¾
ç”±äºè§†å›¾çš„æ„é€ å‡½æ•°å¯ä»¥æŒ‡å®šèµ·å§‹ä½ç½®å’Œé•¿åº¦ï¼Œæ‰€ä»¥åœ¨åŒä¸€æ®µå†…å­˜ä¹‹ä¸­ï¼Œå¯ä»¥ä¾æ¬¡å­˜æ”¾ä¸åŒç±»å‹çš„æ•°æ®ï¼Œè¿™å«åšâ€œå¤åˆè§†å›¾â€ã€‚

var buffer = new ArrayBuffer(24);

var idView = new Uint32Array(buffer, 0, 1);
var usernameView = new Uint8Array(buffer, 4, 16);
var amountDueView = new Float32Array(buffer, 20, 1);
ä¸Šé¢ä»£ç å°†ä¸€ä¸ª24å­—èŠ‚é•¿åº¦çš„ArrayBufferå¯¹è±¡ï¼Œåˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼š

å­—èŠ‚0åˆ°å­—èŠ‚3ï¼š1ä¸ª32ä½æ— ç¬¦å·æ•´æ•°
å­—èŠ‚4åˆ°å­—èŠ‚19ï¼š16ä¸ª8ä½æ•´æ•°
å­—èŠ‚20åˆ°å­—èŠ‚23ï¼š1ä¸ª32ä½æµ®ç‚¹æ•°
è¿™ç§æ•°æ®ç»“æ„å¯ä»¥ç”¨å¦‚ä¸‹çš„Cè¯­è¨€æè¿°ï¼š

struct someStruct {
  unsigned long id;
  char username[16];
  float amountDue;
};
DataViewè§†å›¾
å¦‚æœä¸€æ®µæ•°æ®åŒ…æ‹¬å¤šç§ç±»å‹ï¼ˆæ¯”å¦‚æœåŠ¡å™¨ä¼ æ¥çš„HTTPæ•°æ®ï¼‰ï¼Œè¿™æ—¶é™¤äº†å»ºç«‹ArrayBufferå¯¹è±¡çš„å¤åˆè§†å›¾ä»¥å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡DataViewè§†å›¾è¿›è¡Œæ“ä½œã€‚

DataViewè§†å›¾æä¾›æ›´å¤šæ“ä½œé€‰é¡¹ï¼Œè€Œä¸”æ”¯æŒè®¾å®šå­—èŠ‚åºã€‚æœ¬æ¥ï¼Œåœ¨è®¾è®¡ç›®çš„ä¸Šï¼ŒArrayBufferå¯¹è±¡çš„å„ç§TypedArrayè§†å›¾ï¼Œæ˜¯ç”¨æ¥å‘ç½‘å¡ã€å£°å¡ä¹‹ç±»çš„æœ¬æœºè®¾å¤‡ä¼ é€æ•°æ®ï¼Œæ‰€ä»¥ä½¿ç”¨æœ¬æœºçš„å­—èŠ‚åºå°±å¯ä»¥äº†ï¼›è€ŒDataViewè§†å›¾çš„è®¾è®¡ç›®çš„ï¼Œæ˜¯ç”¨æ¥å¤„ç†ç½‘ç»œè®¾å¤‡ä¼ æ¥çš„æ•°æ®ï¼Œæ‰€ä»¥å¤§ç«¯å­—èŠ‚åºæˆ–å°ç«¯å­—èŠ‚åºæ˜¯å¯ä»¥è‡ªè¡Œè®¾å®šçš„ã€‚

DataViewè§†å›¾æœ¬èº«ä¹Ÿæ˜¯æ„é€ å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªArrayBufferå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œç”Ÿæˆè§†å›¾ã€‚

DataView(ArrayBuffer buffer [, å­—èŠ‚èµ·å§‹ä½ç½® [, é•¿åº¦]]);
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

var buffer = new ArrayBuffer(24);
var dv = new DataView(buffer);
DataViewå®ä¾‹æœ‰ä»¥ä¸‹å±æ€§ï¼Œå«ä¹‰ä¸TypedArrayå®ä¾‹çš„åŒåæ–¹æ³•ç›¸åŒã€‚

DataView.prototype.bufferï¼šè¿”å›å¯¹åº”çš„ArrayBufferå¯¹è±¡
DataView.prototype.byteLengthï¼šè¿”å›å æ®çš„å†…å­˜å­—èŠ‚é•¿åº¦
DataView.prototype.byteOffsetï¼šè¿”å›å½“å‰è§†å›¾ä»å¯¹åº”çš„ArrayBufferå¯¹è±¡çš„å“ªä¸ªå­—èŠ‚å¼€å§‹
DataViewå®ä¾‹æä¾›8ä¸ªæ–¹æ³•è¯»å–å†…å­˜ã€‚

getInt8ï¼šè¯»å–1ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ª8ä½æ•´æ•°ã€‚
getUint8ï¼šè¯»å–1ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ªæ— ç¬¦å·çš„8ä½æ•´æ•°ã€‚
getInt16ï¼šè¯»å–2ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ª16ä½æ•´æ•°ã€‚
getUint16ï¼šè¯»å–2ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ªæ— ç¬¦å·çš„16ä½æ•´æ•°ã€‚
getInt32ï¼šè¯»å–4ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ª32ä½æ•´æ•°ã€‚
getUint32ï¼šè¯»å–4ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ªæ— ç¬¦å·çš„32ä½æ•´æ•°ã€‚
getFloat32ï¼šè¯»å–4ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ª32ä½æµ®ç‚¹æ•°ã€‚
getFloat64ï¼šè¯»å–8ä¸ªå­—èŠ‚ï¼Œè¿”å›ä¸€ä¸ª64ä½æµ®ç‚¹æ•°ã€‚
è¿™ä¸€ç³»åˆ—getæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚åºå·ï¼ˆä¸èƒ½æ˜¯è´Ÿæ•°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰ï¼Œè¡¨ç¤ºä»å“ªä¸ªå­—èŠ‚å¼€å§‹è¯»å–ã€‚

var buffer = new ArrayBuffer(24);
var dv = new DataView(buffer);

// ä»ç¬¬1ä¸ªå­—èŠ‚è¯»å–ä¸€ä¸ª8ä½æ— ç¬¦å·æ•´æ•°
var v1 = dv.getUint8(0);

// ä»ç¬¬2ä¸ªå­—èŠ‚è¯»å–ä¸€ä¸ª16ä½æ— ç¬¦å·æ•´æ•°
var v2 = dv.getUint16(1);

// ä»ç¬¬4ä¸ªå­—èŠ‚è¯»å–ä¸€ä¸ª16ä½æ— ç¬¦å·æ•´æ•°
var v3 = dv.getUint16(3);
ä¸Šé¢ä»£ç è¯»å–äº†ArrayBufferå¯¹è±¡çš„å‰5ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª8ä½æ•´æ•°å’Œä¸¤ä¸ªåå…­ä½æ•´æ•°ã€‚

å¦‚æœä¸€æ¬¡è¯»å–ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå­—èŠ‚ï¼Œå°±å¿…é¡»æ˜ç¡®æ•°æ®çš„å­˜å‚¨æ–¹å¼ï¼Œåˆ°åº•æ˜¯å°ç«¯å­—èŠ‚åºè¿˜æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDataViewçš„getæ–¹æ³•ä½¿ç”¨å¤§ç«¯å­—èŠ‚åºè§£è¯»æ•°æ®ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å°ç«¯å­—èŠ‚åºè§£è¯»ï¼Œå¿…é¡»åœ¨getæ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®štrueã€‚

// å°ç«¯å­—èŠ‚åº
var v1 = dv.getUint16(1, true);

// å¤§ç«¯å­—èŠ‚åº
var v2 = dv.getUint16(3, false);

// å¤§ç«¯å­—èŠ‚åº
var v3 = dv.getUint16(3);
DataViewè§†å›¾æä¾›8ä¸ªæ–¹æ³•å†™å…¥å†…å­˜ã€‚

setInt8ï¼šå†™å…¥1ä¸ªå­—èŠ‚çš„8ä½æ•´æ•°ã€‚
setUint8ï¼šå†™å…¥1ä¸ªå­—èŠ‚çš„8ä½æ— ç¬¦å·æ•´æ•°ã€‚
setInt16ï¼šå†™å…¥2ä¸ªå­—èŠ‚çš„16ä½æ•´æ•°ã€‚
setUint16ï¼šå†™å…¥2ä¸ªå­—èŠ‚çš„16ä½æ— ç¬¦å·æ•´æ•°ã€‚
setInt32ï¼šå†™å…¥4ä¸ªå­—èŠ‚çš„32ä½æ•´æ•°ã€‚
setUint32ï¼šå†™å…¥4ä¸ªå­—èŠ‚çš„32ä½æ— ç¬¦å·æ•´æ•°ã€‚
setFloat32ï¼šå†™å…¥4ä¸ªå­—èŠ‚çš„32ä½æµ®ç‚¹æ•°ã€‚
setFloat64ï¼šå†™å…¥8ä¸ªå­—èŠ‚çš„64ä½æµ®ç‚¹æ•°ã€‚
è¿™ä¸€ç³»åˆ—setæ–¹æ³•ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—èŠ‚åºå·ï¼Œè¡¨ç¤ºä»å“ªä¸ªå­—èŠ‚å¼€å§‹å†™å…¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†™å…¥çš„æ•°æ®ã€‚å¯¹äºé‚£äº›å†™å…¥ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå­—èŠ‚çš„æ–¹æ³•ï¼Œéœ€è¦æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œfalseæˆ–è€…undefinedè¡¨ç¤ºä½¿ç”¨å¤§ç«¯å­—èŠ‚åºå†™å…¥ï¼Œtrueè¡¨ç¤ºä½¿ç”¨å°ç«¯å­—èŠ‚åºå†™å…¥ã€‚

// åœ¨ç¬¬1ä¸ªå­—èŠ‚ï¼Œä»¥å¤§ç«¯å­—èŠ‚åºå†™å…¥å€¼ä¸º25çš„32ä½æ•´æ•°
dv.setInt32(0, 25, false);

// åœ¨ç¬¬5ä¸ªå­—èŠ‚ï¼Œä»¥å¤§ç«¯å­—èŠ‚åºå†™å…¥å€¼ä¸º25çš„32ä½æ•´æ•°
dv.setInt32(4, 25);

// åœ¨ç¬¬9ä¸ªå­—èŠ‚ï¼Œä»¥å°ç«¯å­—èŠ‚åºå†™å…¥å€¼ä¸º2.5çš„32ä½æµ®ç‚¹æ•°
dv.setFloat32(8, 2.5, true);
å¦‚æœä¸ç¡®å®šæ­£åœ¨ä½¿ç”¨çš„è®¡ç®—æœºçš„å­—èŠ‚åºï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„åˆ¤æ–­æ–¹å¼ã€‚

var littleEndian = (function() {
  var buffer = new ArrayBuffer(2);
  new DataView(buffer).setInt16(0, 256, true);
  return new Int16Array(buffer)[0] === 256;
})();
å¦‚æœè¿”å›trueï¼Œå°±æ˜¯å°ç«¯å­—èŠ‚åºï¼›å¦‚æœè¿”å›falseï¼Œå°±æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚

äºŒè¿›åˆ¶æ•°ç»„çš„åº”ç”¨
å¤§é‡çš„Web APIç”¨åˆ°äº†ArrayBufferå¯¹è±¡å’Œå®ƒçš„è§†å›¾å¯¹è±¡ã€‚

AJAX
ä¼ ç»Ÿä¸Šï¼ŒæœåŠ¡å™¨é€šè¿‡AJAXæ“ä½œåªèƒ½è¿”å›æ–‡æœ¬æ•°æ®ï¼Œå³responseTypeå±æ€§é»˜è®¤ä¸ºtextã€‚XMLHttpRequestç¬¬äºŒç‰ˆXHR2å…è®¸æœåŠ¡å™¨è¿”å›äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿™æ—¶åˆ†æˆä¸¤ç§æƒ…å†µã€‚å¦‚æœæ˜ç¡®çŸ¥é“è¿”å›çš„äºŒè¿›åˆ¶æ•°æ®ç±»å‹ï¼Œå¯ä»¥æŠŠè¿”å›ç±»å‹ï¼ˆresponseTypeï¼‰è®¾ä¸ºarraybufferï¼›å¦‚æœä¸çŸ¥é“ï¼Œå°±è®¾ä¸ºblobã€‚

var xhr = new XMLHttpRequest();
xhr.open('GET', someUrl);
xhr.responseType = 'arraybuffer';

xhr.onload = function () {
  let arrayBuffer = xhr.response;
  // Â·Â·Â·
};

xhr.send();
å¦‚æœçŸ¥é“ä¼ å›æ¥çš„æ˜¯32ä½æ•´æ•°ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å¤„ç†ã€‚

xhr.onreadystatechange = function () {
  if (req.readyState === 4 ) {
    var arrayResponse = xhr.response;
    var dataView = new DataView(arrayResponse);
    var ints = new Uint32Array(dataView.byteLength / 4);

    xhrDiv.style.backgroundColor = "#00FF00";
    xhrDiv.innerText = "Array is " + ints.length + "uints long";
  }
}
Canvas
ç½‘é¡µCanvaså…ƒç´ è¾“å‡ºçš„äºŒè¿›åˆ¶åƒç´ æ•°æ®ï¼Œå°±æ˜¯TypedArrayæ•°ç»„ã€‚

var canvas = document.getElementById('myCanvas');
var ctx = canvas.getContext('2d');

var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
var uint8ClampedArray = imageData.data;
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢ä»£ç çš„uint8ClampedArrayè™½ç„¶æ˜¯ä¸€ä¸ªTypedArrayæ•°ç»„ï¼Œä½†æ˜¯å®ƒçš„è§†å›¾ç±»å‹æ˜¯ä¸€ç§é’ˆå¯¹Canvaså…ƒç´ çš„ä¸“æœ‰ç±»å‹Uint8ClampedArrayã€‚è¿™ä¸ªè§†å›¾ç±»å‹çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯ä¸“é—¨é’ˆå¯¹é¢œè‰²ï¼ŒæŠŠæ¯ä¸ªå­—èŠ‚è§£è¯»ä¸ºæ— ç¬¦å·çš„8ä½æ•´æ•°ï¼Œå³åªèƒ½å–å€¼0ï½255ï¼Œè€Œä¸”å‘ç”Ÿè¿ç®—çš„æ—¶å€™è‡ªåŠ¨è¿‡æ»¤é«˜ä½æº¢å‡ºã€‚è¿™ä¸ºå›¾åƒå¤„ç†å¸¦æ¥äº†å·¨å¤§çš„æ–¹ä¾¿ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæŠŠåƒç´ çš„é¢œè‰²å€¼è®¾ä¸ºUint8Arrayç±»å‹ï¼Œé‚£ä¹ˆä¹˜ä»¥ä¸€ä¸ªgammaå€¼çš„æ—¶å€™ï¼Œå°±å¿…é¡»è¿™æ ·è®¡ç®—ï¼š

u8[i] = Math.min(255, Math.max(0, u8[i] * gamma));
å› ä¸ºUint8Arrayç±»å‹å¯¹äºå¤§äº255çš„è¿ç®—ç»“æœï¼ˆæ¯”å¦‚0xFF+1ï¼‰ï¼Œä¼šè‡ªåŠ¨å˜ä¸º0x00ï¼Œæ‰€ä»¥å›¾åƒå¤„ç†å¿…é¡»è¦åƒä¸Šé¢è¿™æ ·ç®—ã€‚è¿™æ ·åšå¾ˆéº»çƒ¦ï¼Œè€Œä¸”å½±å“æ€§èƒ½ã€‚å¦‚æœå°†é¢œè‰²å€¼è®¾ä¸ºUint8ClampedArrayç±»å‹ï¼Œè®¡ç®—å°±ç®€åŒ–è®¸å¤šã€‚

pixels[i] *= gamma;
Uint8ClampedArrayç±»å‹ç¡®ä¿å°†å°äº0çš„å€¼è®¾ä¸º0ï¼Œå°†å¤§äº255çš„å€¼è®¾ä¸º255ã€‚æ³¨æ„ï¼ŒIE 10ä¸æ”¯æŒè¯¥ç±»å‹ã€‚

WebSocket
WebSocketå¯ä»¥é€šè¿‡ArrayBufferï¼Œå‘é€æˆ–æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®ã€‚

var socket = new WebSocket('ws://127.0.0.1:8081');
socket.binaryType = 'arraybuffer';

// Wait until socket is open
socket.addEventListener('open', function (event) {
  // Send binary data
  var typedArray = new Uint8Array(4);
  socket.send(typedArray.buffer);
});

// Receive binary data
socket.addEventListener('message', function (event) {
  var arrayBuffer = event.data;
  // Â·Â·Â·
});
Fetch API
Fetch APIå–å›çš„æ•°æ®ï¼Œå°±æ˜¯ArrayBufferå¯¹è±¡ã€‚

fetch(url)
.then(function(request){
  return request.arrayBuffer()
})
.then(function(arrayBuffer){
  // ...
});
File API
å¦‚æœçŸ¥é“ä¸€ä¸ªæ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥å°†è¿™ä¸ªæ–‡ä»¶è¯»å–ä¸ºArrayBufferå¯¹è±¡ã€‚

var fileInput = document.getElementById('fileInput');
var file = fileInput.files[0];
var reader = new FileReader();
reader.readAsArrayBuffer(file);
reader.onload = function () {
  var arrayBuffer = reader.result;
  // Â·Â·Â·
};
ä¸‹é¢ä»¥å¤„ç†bmpæ–‡ä»¶ä¸ºä¾‹ã€‚å‡å®šfileå˜é‡æ˜¯ä¸€ä¸ªæŒ‡å‘bmpæ–‡ä»¶çš„æ–‡ä»¶å¯¹è±¡ï¼Œé¦–å…ˆè¯»å–æ–‡ä»¶ã€‚

var reader = new FileReader();
reader.addEventListener("load", processimage, false);
reader.readAsArrayBuffer(file);
ç„¶åï¼Œå®šä¹‰å¤„ç†å›¾åƒçš„å›è°ƒå‡½æ•°ï¼šå…ˆåœ¨äºŒè¿›åˆ¶æ•°æ®ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªDataViewè§†å›¾ï¼Œå†å»ºç«‹ä¸€ä¸ªbitmapå¯¹è±¡ï¼Œç”¨äºå­˜æ”¾å¤„ç†åçš„æ•°æ®ï¼Œæœ€åå°†å›¾åƒå±•ç¤ºåœ¨Canvaså…ƒç´ ä¹‹ä¸­ã€‚

function processimage(e) {
  var buffer = e.target.result;
  var datav = new DataView(buffer);
  var bitmap = {};
  // å…·ä½“çš„å¤„ç†æ­¥éª¤
}
å…·ä½“å¤„ç†å›¾åƒæ•°æ®æ—¶ï¼Œå…ˆå¤„ç†bmpçš„æ–‡ä»¶å¤´ã€‚å…·ä½“æ¯ä¸ªæ–‡ä»¶å¤´çš„æ ¼å¼å’Œå®šä¹‰ï¼Œè¯·å‚é˜…æœ‰å…³èµ„æ–™ã€‚

bitmap.fileheader = {};
bitmap.fileheader.bfType = datav.getUint16(0, true);
bitmap.fileheader.bfSize = datav.getUint32(2, true);
bitmap.fileheader.bfReserved1 = datav.getUint16(6, true);
bitmap.fileheader.bfReserved2 = datav.getUint16(8, true);
bitmap.fileheader.bfOffBits = datav.getUint32(10, true);
æ¥ç€å¤„ç†å›¾åƒå…ƒä¿¡æ¯éƒ¨åˆ†ã€‚

bitmap.infoheader = {};
bitmap.infoheader.biSize = datav.getUint32(14, true);
bitmap.infoheader.biWidth = datav.getUint32(18, true);
bitmap.infoheader.biHeight = datav.getUint32(22, true);
bitmap.infoheader.biPlanes = datav.getUint16(26, true);
bitmap.infoheader.biBitCount = datav.getUint16(28, true);
bitmap.infoheader.biCompression = datav.getUint32(30, true);
bitmap.infoheader.biSizeImage = datav.getUint32(34, true);
bitmap.infoheader.biXPelsPerMeter = datav.getUint32(38, true);
bitmap.infoheader.biYPelsPerMeter = datav.getUint32(42, true);
bitmap.infoheader.biClrUsed = datav.getUint32(46, true);
bitmap.infoheader.biClrImportant = datav.getUint32(50, true);
æœ€åå¤„ç†å›¾åƒæœ¬èº«çš„åƒç´ ä¿¡æ¯ã€‚

var start = bitmap.fileheader.bfOffBits;
bitmap.pixels = new Uint8Array(buffer, start);
è‡³æ­¤ï¼Œå›¾åƒæ–‡ä»¶çš„æ•°æ®å…¨éƒ¨å¤„ç†å®Œæˆã€‚ä¸‹ä¸€æ­¥ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè¿›è¡Œå›¾åƒå˜å½¢ï¼Œæˆ–è€…è½¬æ¢æ ¼å¼ï¼Œæˆ–è€…å±•ç¤ºåœ¨Canvasç½‘é¡µå…ƒç´ ä¹‹ä¸­ã€‚

SharedArrayBuffer
ç›®å‰æœ‰ä¸€ç§åœºæ™¯ï¼Œéœ€è¦å¤šä¸ªè¿›ç¨‹å…±äº«æ•°æ®ï¼šæµè§ˆå™¨å¯åŠ¨å¤šä¸ªWebWorkerã€‚

var w = new Worker('myworker.js');
ä¸Šé¢ä»£ç ä¸­ï¼Œä¸»çª—å£æ–°å»ºäº†ä¸€ä¸ª Worker è¿›ç¨‹ã€‚è¯¥è¿›ç¨‹ä¸ä¸»çª—å£ä¹‹é—´ä¼šæœ‰ä¸€ä¸ªé€šä¿¡æ¸ é“ï¼Œä¸»çª—å£é€šè¿‡w.postMessageå‘ Worker è¿›ç¨‹å‘æ¶ˆæ¯ï¼ŒåŒæ—¶é€šè¿‡messageäº‹ä»¶ç›‘å¬ Worker è¿›ç¨‹çš„å›åº”ã€‚

w.postMessage('hi');
w.onmessage = function (ev) {
  console.log(ev.data);
}
ä¸Šé¢ä»£ç ä¸­ï¼Œä¸»çª—å£å…ˆå‘ä¸€ä¸ªæ¶ˆæ¯hiï¼Œç„¶ååœ¨ç›‘å¬åˆ° Worker è¿›ç¨‹çš„å›åº”åï¼Œå°±å°†å…¶æ‰“å°å‡ºæ¥ã€‚

Worker è¿›ç¨‹ä¹Ÿæ˜¯é€šè¿‡ç›‘å¬messageäº‹ä»¶ï¼Œæ¥è·å–ä¸»çª—å£å‘æ¥çš„æ¶ˆæ¯ï¼Œå¹¶ä½œå‡ºååº”ã€‚

onmessage = function (ev) {
  console.log(ev.data);
  postMessage('ho');
}
ä¸»çª—å£ä¸ Worker è¿›ç¨‹ä¹‹é—´ï¼Œå¯ä»¥ä¼ é€å„ç§æ•°æ®ï¼Œä¸ä»…ä»…æ˜¯å­—ç¬¦ä¸²ï¼Œè¿˜å¯ä»¥ä¼ é€äºŒè¿›åˆ¶æ•°æ®ã€‚å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå¦‚æœæœ‰å¤§é‡æ•°æ®è¦ä¼ é€ï¼Œç•™å‡ºä¸€å—å†…å­˜åŒºåŸŸï¼Œä¸»çª—å£ä¸ Worker è¿›ç¨‹å…±äº«ï¼Œä¸¤æ–¹éƒ½å¯ä»¥è¯»å†™ï¼Œé‚£ä¹ˆå°±ä¼šå¤§å¤§æé«˜æ•ˆç‡ã€‚

ç°åœ¨ï¼Œæœ‰ä¸€ä¸ªSharedArrayBufferææ¡ˆï¼Œå…è®¸å¤šä¸ª Worker è¿›ç¨‹ä¸ä¸»çª—å£å…±äº«å†…å­˜ã€‚è¿™ä¸ªå¯¹è±¡çš„ API ä¸ArrayBufferä¸€æ¨¡ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åè€…æ— æ³•å…±äº«ã€‚

// æ–°å»º 1KB å…±äº«å†…å­˜
var sab = new SharedArrayBuffer(1024);

// ä¸»çª—å£å‘é€æ•°æ®
w.postMessage(sab, [sab])
ä¸Šé¢ä»£ç ä¸­ï¼ŒpostMessageæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯SharedArrayBufferå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦å†™å…¥å…±äº«å†…å­˜çš„æ•°æ®ã€‚

Worker è¿›ç¨‹ä»äº‹ä»¶çš„dataå±æ€§ä¸Šé¢å–åˆ°æ•°æ®ã€‚

var sab;
onmessage = function (ev) {
   sab = ev.data;  // 1KB çš„å…±äº«å†…å­˜ï¼Œå°±æ˜¯ä¸»çª—å£å…±äº«å‡ºæ¥çš„é‚£å—å†…å­˜
};
å…±äº«å†…å­˜ä¹Ÿå¯ä»¥åœ¨ Worker è¿›ç¨‹åˆ›å»ºï¼Œå‘ç»™ä¸»çª—å£ã€‚

SharedArrayBufferä¸SharedArrayä¸€æ ·ï¼Œæœ¬èº«æ˜¯æ— æ³•è¯»å†™ï¼Œå¿…é¡»åœ¨ä¸Šé¢å»ºç«‹è§†å›¾ï¼Œç„¶åé€šè¿‡è§†å›¾è¯»å†™ã€‚

// åˆ†é… 10 ä¸‡ä¸ª 32 ä½æ•´æ•°å æ®çš„å†…å­˜ç©ºé—´
var sab = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT * 100000);

// å»ºç«‹ 32 ä½æ•´æ•°è§†å›¾
var ia = new Int32Array(sab);  // ia.length == 100000

// æ–°å»ºä¸€ä¸ªè´¨æ•°ç”Ÿæˆå™¨
var primes = new PrimeGenerator();

// å°† 10 ä¸‡ä¸ªè´¨æ•°ï¼Œå†™å…¥è¿™æ®µå†…å­˜ç©ºé—´
for ( let i=0 ; i < ia.length ; i++ )
  ia[i] = primes.next();

// å‘ Worker è¿›ç¨‹å‘é€è¿™æ®µå…±äº«å†…å­˜
w.postMessage(ia, [ia.buffer]);
Worker æ”¶åˆ°æ•°æ®åçš„å¤„ç†å¦‚ä¸‹ã€‚

var ia;
onmessage = function (ev) {
  ia = ev.data;
  console.log(ia.length); // 100000
  console.log(ia[37]); // è¾“å‡º 163ï¼Œå› ä¸ºè¿™æ˜¯ç¬¬138ä¸ªè´¨æ•°
};

##SIMD
1.æ¦‚è¿°
SIMDï¼ˆå‘éŸ³/sim-dee/ï¼‰æ˜¯â€œSingle Instruction/Multiple Dataâ€çš„ç¼©å†™ï¼Œæ„ä¸ºâ€œå•æŒ‡ä»¤ï¼Œå¤šæ•°æ®â€ã€‚å®ƒæ˜¯JavaScriptæ“ä½œCPUå¯¹åº”æŒ‡ä»¤çš„æ¥å£ï¼Œä½ å¯ä»¥çœ‹åšè¿™æ˜¯ä¸€ç§ä¸åŒçš„è¿ç®—æ‰§è¡Œæ¨¡å¼ã€‚ä¸å®ƒç›¸å¯¹çš„æ˜¯SISDï¼ˆâ€œSingle Instruction/Single Dataâ€ï¼‰ï¼Œå³â€œå•æŒ‡ä»¤ï¼Œå•æ•°æ®â€ã€‚

SIMDçš„å«ä¹‰æ˜¯ä½¿ç”¨ä¸€ä¸ªæŒ‡ä»¤ï¼Œå®Œæˆå¤šä¸ªæ•°æ®çš„è¿ç®—ï¼›SISDçš„å«ä¹‰æ˜¯ä½¿ç”¨ä¸€ä¸ªæŒ‡ä»¤ï¼Œå®Œæˆå•ä¸ªæ•°æ®çš„è¿ç®—ï¼Œè¿™æ˜¯JavaScriptçš„é»˜è®¤è¿ç®—æ¨¡å¼ã€‚æ˜¾è€Œæ˜“è§ï¼ŒSIMDçš„æ‰§è¡Œæ•ˆç‡è¦é«˜äºSISDï¼Œæ‰€ä»¥è¢«å¹¿æ³›ç”¨äº3Då›¾å½¢è¿ç®—ã€ç‰©ç†æ¨¡æ‹Ÿç­‰è¿ç®—é‡è¶…å¤§çš„é¡¹ç›®ä¹‹ä¸­ã€‚

ä¸ºäº†ç†è§£SIMDï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

var a = [1, 2, 3, 4];
var b = [5, 6, 7, 8];
var c = [];

c[0] = a[0] + b[0];
c[1] = a[1] + b[1];
c[2] = a[2] + b[2];
c[3] = a[3] + b[3];
c // Array[6, 8, 10, 12]
ä¸Šé¢ä»£ç ä¸­ï¼Œæ•°ç»„aå’Œbçš„å¯¹åº”æˆå‘˜ç›¸åŠ ï¼Œç»“æœæ”¾å…¥æ•°ç»„cã€‚å®ƒçš„è¿ç®—æ¨¡å¼æ˜¯ä¾æ¬¡å¤„ç†æ¯ä¸ªæ•°ç»„æˆå‘˜ï¼Œä¸€å…±æœ‰å››ä¸ªæ•°ç»„æˆå‘˜ï¼Œæ‰€ä»¥éœ€è¦è¿ç®—4æ¬¡ã€‚

å¦‚æœé‡‡ç”¨SIMDæ¨¡å¼ï¼Œåªè¦è¿ç®—ä¸€æ¬¡å°±å¤Ÿäº†ã€‚

var a = SIMD.Float32x4(1, 2, 3, 4);
var b = SIMD.Float32x4(5, 6, 7, 8);
var c = SIMD.Float32x4.add(a, b); // Float32x4[6, 8, 10, 12]
ä¸Šé¢ä»£ç ä¹‹ä¸­ï¼Œæ•°ç»„aå’Œbçš„å››ä¸ªæˆå‘˜çš„å„è‡ªç›¸åŠ ï¼Œåªç”¨ä¸€æ¡æŒ‡ä»¤å°±å®Œæˆäº†ã€‚å› æ­¤ï¼Œé€Ÿåº¦æ¯”ä¸Šä¸€ç§å†™æ³•æé«˜äº†4å€ã€‚

ä¸€æ¬¡SIMDè¿ç®—ï¼Œå¯ä»¥å¤„ç†å¤šä¸ªæ•°æ®ï¼Œè¿™äº›æ•°æ®è¢«ç§°ä¸ºâ€œé€šé“â€ï¼ˆlaneï¼‰ã€‚ä¸Šé¢ä»£ç ä¸­ï¼Œä¸€æ¬¡è¿ç®—äº†å››ä¸ªæ•°æ®ï¼Œå› æ­¤å°±æ˜¯å››ä¸ªé€šé“ã€‚

SIMDé€šå¸¸ç”¨äºçŸ¢é‡è¿ç®—ã€‚

v + w    = âŒ©v1, â€¦, vnâŒª+ âŒ©w1, â€¦, wnâŒª
      = âŒ©v1+w1, â€¦, vn+wnâŒª
ä¸Šé¢ä»£ç ä¸­ï¼Œvå’Œwæ˜¯ä¸¤ä¸ªå¤šå…ƒçŸ¢é‡ã€‚å®ƒä»¬çš„åŠ è¿ç®—ï¼Œåœ¨SIMDä¸‹æ˜¯ä¸€ä¸ªæŒ‡ä»¤ã€è€Œä¸æ˜¯nä¸ªæŒ‡ä»¤å®Œæˆçš„ï¼Œè¿™å°±å¤§å¤§æé«˜äº†æ•ˆç‡ã€‚è¿™å¯¹äº3DåŠ¨ç”»ã€å›¾åƒå¤„ç†ã€ä¿¡å·å¤„ç†ã€æ•°å€¼å¤„ç†ã€åŠ å¯†ç­‰è¿ç®—æ˜¯éå¸¸é‡è¦çš„ã€‚æ¯”å¦‚ï¼ŒCanvasçš„getImageData()ä¼šå°†å›¾åƒæ–‡ä»¶è¯»æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ï¼ŒSIMDå°±å¾ˆé€‚åˆå¯¹äºè¿™ç§æ•°ç»„çš„å¤„ç†ã€‚

æ€»å¾—æ¥è¯´ï¼ŒSIMDæ˜¯æ•°æ®å¹¶è¡Œå¤„ç†ï¼ˆparallelismï¼‰çš„ä¸€ç§æ‰‹æ®µï¼Œå¯ä»¥åŠ é€Ÿä¸€äº›è¿ç®—å¯†é›†å‹æ“ä½œçš„é€Ÿåº¦ã€‚

æ•°æ®ç±»å‹
SIMDæä¾›12ç§æ•°æ®ç±»å‹ï¼Œæ€»é•¿åº¦éƒ½æ˜¯128ä¸ªäºŒè¿›åˆ¶ä½ã€‚

Float32x4ï¼šå››ä¸ª32ä½æµ®ç‚¹æ•°
Float64x2ï¼šä¸¤ä¸ª64ä½æµ®ç‚¹æ•°
Int32x4ï¼šå››ä¸ª32ä½æ•´æ•°
Int16x8ï¼šå…«ä¸ª16ä½æ•´æ•°
Int8x16ï¼šåå…­ä¸ª8ä½æ•´æ•°
Uint32x4ï¼šå››ä¸ªæ— ç¬¦å·çš„32ä½æ•´æ•°
Uint16x8ï¼šå…«ä¸ªæ— ç¬¦å·çš„16ä½æ•´æ•°
Uint8x16ï¼šåå…­ä¸ªæ— ç¬¦å·çš„8ä½æ•´æ•°
Bool32x4ï¼šå››ä¸ª32ä½å¸ƒå°”å€¼
Bool16x8ï¼šå…«ä¸ª16ä½å¸ƒå°”å€¼
Bool8x16ï¼šåå…­ä¸ª8ä½å¸ƒå°”å€¼
Bool64x2ï¼šä¸¤ä¸ª64ä½å¸ƒå°”å€¼
æ¯ç§æ•°æ®ç±»å‹è¢«xç¬¦å·åˆ†éš”æˆä¸¤éƒ¨åˆ†ï¼Œåé¢çš„éƒ¨åˆ†è¡¨ç¤ºé€šé“æ•°ï¼Œå‰é¢çš„éƒ¨åˆ†è¡¨ç¤ºæ¯ä¸ªé€šé“çš„å®½åº¦å’Œç±»å‹ã€‚æ¯”å¦‚ï¼ŒFloat32x4å°±è¡¨ç¤ºè¿™ä¸ªå€¼æœ‰4ä¸ªé€šé“ï¼Œæ¯ä¸ªé€šé“æ˜¯ä¸€ä¸ª32ä½æµ®ç‚¹æ•°ã€‚

æ¯ä¸ªé€šé“ä¹‹ä¸­ï¼Œå¯ä»¥æ”¾ç½®å››ç§æ•°æ®ã€‚

æµ®ç‚¹æ•°ï¼ˆfloatï¼Œæ¯”å¦‚1.0ï¼‰
å¸¦ç¬¦å·çš„æ•´æ•°ï¼ˆIntï¼Œæ¯”å¦‚-1ï¼‰
æ— ç¬¦å·çš„æ•´æ•°ï¼ˆUintï¼Œæ¯”å¦‚1ï¼‰
å¸ƒå°”å€¼ï¼ˆBoolï¼ŒåŒ…å«trueå’Œfalseä¸¤ç§å€¼ï¼‰
æ¯ç§SIMDçš„æ•°æ®ç±»å‹éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°æ–¹æ³•ï¼Œå¯ä»¥ä¼ å…¥å‚æ•°ï¼Œç”Ÿæˆå¯¹åº”çš„å€¼ã€‚

var a = SIMD.Float32x4(1.0, 2.0, 3.0, 4.0);
ä¸Šé¢ä»£ç ä¸­ï¼Œå˜é‡aå°±æ˜¯ä¸€ä¸ª128ä½ã€åŒ…å«å››ä¸ª32ä½æµ®ç‚¹æ•°ï¼ˆå³å››ä¸ªé€šé“ï¼‰çš„å€¼ã€‚

æ³¨æ„ï¼Œè¿™äº›æ•°æ®ç±»å‹æ–¹æ³•éƒ½ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œå‰é¢ä¸èƒ½åŠ newï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

var v = new SIMD.Float32x4(0, 1, 2, 3);
// TypeError: SIMD.Float32x4 is not a constructor
é™æ€æ–¹æ³•ï¼šæ•°å­¦è¿ç®—
æ¯ç§æ•°æ®ç±»å‹éƒ½æœ‰ä¸€ç³»åˆ—è¿ç®—ç¬¦ï¼Œæ”¯æŒåŸºæœ¬çš„æ•°å­¦è¿ç®—ã€‚

SIMD.%type%.abs()ï¼ŒSIMD.%type%.neg()
absæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒçš„æ¯ä¸ªé€šé“éƒ½è½¬æˆç»å¯¹å€¼ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(-1, -2, 0, NaN);
SIMD.Float32x4.abs(a)
// Float32x4[1, 2, 0, NaN]
negæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒçš„æ¯ä¸ªé€šé“éƒ½è½¬æˆè´Ÿå€¼ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(-1, -2, 3, 0);
SIMD.Float32x4.neg(a)
// Float32x4[1, 2, -3, -0]

var b = SIMD.Float64x2(NaN, Infinity);
SIMD.Float64x2.neg(b)
// Float64x2[NaN, -Infinity]
SIMD.%type%.add()ï¼ŒSIMD.%type%.addSaturate()
addæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒä»¬çš„æ¯ä¸ªé€šé“ç›¸åŠ ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(1.0, 2.0, 3.0, 4.0);
var b = SIMD.Float32x4(5.0, 10.0, 15.0, 20.0);
var c = SIMD.Float32x4.add(a, b);
ä¸Šé¢ä»£ç ä¸­ï¼Œç»è¿‡åŠ æ³•è¿ç®—ï¼Œæ–°çš„SIMDå€¼ä¸º(6.0, 12.0, 18.0. 24.0)ã€‚

addSaturateæ–¹æ³•è·Ÿaddæ–¹æ³•çš„ä½œç”¨ç›¸åŒï¼Œéƒ½æ˜¯ä¸¤ä¸ªé€šé“ç›¸åŠ ï¼Œä½†æ˜¯æº¢å‡ºçš„å¤„ç†ä¸ä¸€è‡´ã€‚å¯¹äºaddæ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªå€¼ç›¸åŠ å‘ç”Ÿæº¢å‡ºï¼Œæº¢å‡ºçš„äºŒè¿›åˆ¶ä½ä¼šè¢«ä¸¢å¼ƒ; addSaturateæ–¹æ³•åˆ™æ˜¯è¿”å›è¯¥æ•°æ®ç±»å‹çš„æœ€å¤§å€¼ã€‚

var a = SIMD.Uint16x8(65533, 65534, 65535, 65535, 1, 1, 1, 1);
var b = SIMD.Uint16x8(1, 1, 1, 5000, 1, 1, 1, 1);
SIMD.Uint16x8.addSaturate(a, b);
// Uint16x8[65534, 65535, 65535, 65535, 2, 2, 2, 2]

var c = SIMD.Int16x8(32765, 32766, 32767, 32767, 1, 1, 1, 1);
var d = SIMD.Int16x8(1, 1, 1, 5000, 1, 1, 1, 1);
SIMD.Int16x8.addSaturate(c, d);
// Int16x8[32766, 32767, 32767, 32767, 2, 2, 2, 2]
ä¸Šé¢ä»£ç ä¸­ï¼ŒUint16çš„æœ€å¤§å€¼æ˜¯65535ï¼ŒInt16çš„æœ€å¤§å€¼æ˜¯32767ã€‚ä¸€æ—¦å‘ç”Ÿæº¢å‡ºï¼Œå°±è¿”å›è¿™ä¸¤ä¸ªå€¼ã€‚

æ³¨æ„ï¼ŒUint32x4å’ŒInt32x4è¿™ä¸¤ç§æ•°æ®ç±»å‹æ²¡æœ‰addSaturateæ–¹æ³•ã€‚

SIMD.%type%.sub()ï¼ŒSIMD.%type%.subSaturate()
subæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒä»¬çš„æ¯ä¸ªé€šé“ç›¸å‡ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(-1, -2, 3, 4);
var b = SIMD.Float32x4(3, 3, 3, 3);
SIMD.Float32x4.sub(a, b)
// Float32x4[-4, -5, 0, 1]
subSaturateæ–¹æ³•è·Ÿsubæ–¹æ³•çš„ä½œç”¨ç›¸åŒï¼Œéƒ½æ˜¯ä¸¤ä¸ªé€šé“ç›¸å‡ï¼Œä½†æ˜¯æº¢å‡ºçš„å¤„ç†ä¸ä¸€è‡´ã€‚å¯¹äºsubæ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªå€¼ç›¸å‡å‘ç”Ÿæº¢å‡ºï¼Œæº¢å‡ºçš„äºŒè¿›åˆ¶ä½ä¼šè¢«ä¸¢å¼ƒ; subSaturateæ–¹æ³•åˆ™æ˜¯è¿”å›è¯¥æ•°æ®ç±»å‹çš„æœ€å°å€¼ã€‚

var a = SIMD.Uint16x8(5, 1, 1, 1, 1, 1, 1, 1);
var b = SIMD.Uint16x8(10, 1, 1, 1, 1, 1, 1, 1);
SIMD.Uint16x8.subSaturate(a, b)
// Uint16x8[0, 0, 0, 0, 0, 0, 0, 0]

var c = SIMD.Int16x8(-100, 0, 0, 0, 0, 0, 0, 0);
var d = SIMD.Int16x8(32767, 0, 0, 0, 0, 0, 0, 0);
SIMD.Int16x8.subSaturate(c, d)
// Int16x8[-32768, 0, 0, 0, 0, 0, 0, 0, 0]
ä¸Šé¢ä»£ç ä¸­ï¼ŒUint16çš„æœ€å°å€¼æ˜¯0ï¼ŒsubSaturateçš„æœ€å°å€¼æ˜¯-32678ã€‚ä¸€æ—¦è¿ç®—å‘ç”Ÿæº¢å‡ºï¼Œå°±è¿”å›æœ€å°å€¼ã€‚

SIMD.%type%.mul()ï¼ŒSIMD.%type%.div()ï¼ŒSIMD.%type%.sqrt()
mulæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒä»¬çš„æ¯ä¸ªé€šé“ç›¸ä¹˜ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(-1, -2, 3, 4);
var b = SIMD.Float32x4(3, 3, 3, 3);
SIMD.Float32x4.mul(a, b)
// Float32x4[-3, -6, 9, 12]
divæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒä»¬çš„æ¯ä¸ªé€šé“ç›¸é™¤ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(2, 2, 2, 2);
var b = SIMD.Float32x4(4, 4, 4, 4);
SIMD.Float32x4.div(a, b)
// Float32x4[0.5, 0.5, 0.5, 0.5]
sqrtæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œæ±‚å‡ºæ¯ä¸ªé€šé“çš„å¹³æ–¹æ ¹ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var b = SIMD.Float64x2(4, 8);
SIMD.Float64x2.sqrt(b)
// Float64x2[2, 2.8284271247461903]
SIMD.%FloatType%.reciprocalApproximation()ï¼ŒSIMD.%type%.reciprocalSqrtApproximation()
reciprocalApproximationæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œæ±‚å‡ºæ¯ä¸ªé€šé“çš„å€’æ•°ï¼ˆ1 / xï¼‰ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(1, 2, 3, 4);
SIMD.Float32x4.reciprocalApproximation(a);
// Float32x4[1, 0.5, 0.3333333432674408, 0.25]
reciprocalSqrtApproximationæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œæ±‚å‡ºæ¯ä¸ªé€šé“çš„å¹³æ–¹æ ¹çš„å€’æ•°ï¼ˆ1 / (x^0.5)ï¼‰ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(1, 2, 3, 4);
SIMD.Float32x4.reciprocalSqrtApproximation(a)
// Float32x4[1, 0.7071067690849304, 0.5773502588272095, 0.5]
æ³¨æ„ï¼Œåªæœ‰æµ®ç‚¹æ•°çš„æ•°æ®ç±»å‹æ‰æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

SIMD.%IntegerType%.shiftLeftByScalar()
shiftLeftByScalaræ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œç„¶åå°†æ¯ä¸ªé€šé“çš„å€¼å·¦ç§»æŒ‡å®šçš„ä½æ•°ï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Int32x4(1, 2, 4, 8);
SIMD.Int32x4.shiftLeftByScalar(a, 1);
// Int32x4[2, 4, 8, 16]
å¦‚æœå·¦ç§»åï¼Œæ–°çš„å€¼è¶…å‡ºäº†å½“å‰æ•°æ®ç±»å‹çš„ä½æ•°ï¼Œæº¢å‡ºçš„éƒ¨åˆ†ä¼šè¢«ä¸¢å¼ƒã€‚

var ix4 = SIMD.Int32x4(1, 2, 3, 4);
var jx4 = SIMD.Int32x4.shiftLeftByScalar(ix4, 32);
// Int32x4[0, 0, 0, 0]
æ³¨æ„ï¼Œåªæœ‰æ•´æ•°çš„æ•°æ®ç±»å‹æ‰æœ‰è¿™ä¸ªæ–¹æ³•ã€‚

SIMD.%IntegerType%.shiftRightByScalar()
shiftRightByScalaræ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œç„¶åå°†æ¯ä¸ªé€šé“çš„å€¼å³ç§»æŒ‡å®šçš„ä½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„SIMDå€¼ã€‚

var a = SIMD.Int32x4(1, 2, 4, -8);
SIMD.Int32x4.shiftRightByScalar(a, 1);
// Int32x4[0, 1, 2, -4]
å¦‚æœåŸæ¥é€šé“çš„å€¼æ˜¯å¸¦ç¬¦å·çš„å€¼ï¼Œåˆ™ç¬¦å·ä½ä¿æŒä¸å˜ï¼Œä¸å—å³ç§»å½±å“ã€‚å¦‚æœæ˜¯ä¸å¸¦ç¬¦å·ä½çš„å€¼ï¼Œåˆ™å³ç§»åå¤´éƒ¨ä¼šè¡¥0ã€‚

var a = SIMD.Uint32x4(1, 2, 4, -8);
SIMD.Uint32x4.shiftRightByScalar(a, 1);
// Uint32x4[0, 1, 2, 2147483644]
ä¸Šé¢ä»£ç ä¸­ï¼Œ-8å³ç§»ä¸€ä½å˜æˆäº†2147483644ï¼Œæ˜¯å› ä¸ºå¯¹äº32ä½æ— ç¬¦å·æ•´æ•°æ¥è¯´ï¼Œ-8çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯11111111111111111111111111111000ï¼Œå³ç§»ä¸€ä½å°±å˜æˆäº†01111111111111111111111111111100ï¼Œç›¸å½“äº2147483644ã€‚

æ³¨æ„ï¼Œåªæœ‰æ•´æ•°çš„æ•°æ®ç±»å‹æ‰æœ‰è¿™ä¸ªæ–¹æ³•ã€‚

é™æ€æ–¹æ³•ï¼šé€šé“å¤„ç†
SIMD.%type%.check()
checkæ–¹æ³•ç”¨äºæ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦ä¸ºå½“å‰ç±»å‹çš„SIMDå€¼ã€‚å¦‚æœæ˜¯çš„ï¼Œå°±è¿”å›è¿™ä¸ªå€¼ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚

var a = SIMD.Float32x4(1, 2, 3, 9);

SIMD.Float32x4.check(a);
// Float32x4[1, 2, 3, 9]

SIMD.Float32x4.check([1,2,3,4]) // æŠ¥é”™
SIMD.Int32x4.check(a) // æŠ¥é”™
SIMD.Int32x4.check('hello world') // æŠ¥é”™
SIMD.%type%.extractLane()ï¼ŒSIMD.%type%.replaceLane()
extractLaneæ–¹æ³•ç”¨äºè¿”å›ç»™å®šé€šé“çš„å€¼ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯SIMDå€¼å’Œé€šé“ç¼–å·ã€‚

var t = SIMD.Float32x4(1, 2, 3, 4);
SIMD.Float32x4.extractLane(t, 2) // 3
replaceLaneæ–¹æ³•ç”¨äºæ›¿æ¢æŒ‡å®šé€šé“çš„å€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„SIMDå€¼ã€‚å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯åŸæ¥çš„SIMDå€¼ã€é€šé“ç¼–å·å’Œæ–°çš„é€šé“å€¼ã€‚

var t = SIMD.Float32x4(1, 2, 3, 4);
SIMD.Float32x4.replaceLane(t, 2, 42)
// Float32x4[1, 2, 42, 4]
SIMD.%type%.load()
loadæ–¹æ³•ç”¨äºä»äºŒè¿›åˆ¶æ•°ç»„è¯»å…¥æ•°æ®ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„SIMDå€¼ã€‚

var a = new Int32Array([1,2,3,4,5,6,7,8]);
SIMD.Int32x4.load(a, 0);
// Int32x4[1, 2, 3, 4]

var b = new Int32Array([1,2,3,4,5,6,7,8]);
SIMD.Int32x4.load(a, 2);
// Int32x4[3, 4, 5, 6]
loadæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„å’Œå¼€å§‹è¯»å–çš„ä½ç½®ï¼ˆä»0å¼€å§‹ï¼‰ã€‚å¦‚æœä½ç½®ä¸åˆæ³•ï¼ˆæ¯”å¦‚-1æˆ–è€…è¶…å‡ºäºŒè¿›åˆ¶æ•°ç»„çš„å¤§å°ï¼‰ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

è¿™ä¸ªæ–¹æ³•è¿˜æœ‰ä¸‰ä¸ªå˜ç§load1()ã€load2()ã€load3()ï¼Œè¡¨ç¤ºä»æŒ‡å®šä½ç½®å¼€å§‹ï¼ŒåªåŠ è½½ä¸€ä¸ªé€šé“ã€äºŒä¸ªé€šé“ã€ä¸‰ä¸ªé€šé“çš„å€¼ã€‚

// æ ¼å¼
SIMD.Int32x4.load(tarray, index)
SIMD.Int32x4.load1(tarray, index)
SIMD.Int32x4.load2(tarray, index)
SIMD.Int32x4.load3(tarray, index)

// å®ä¾‹
var a = new Int32Array([1,2,3,4,5,6,7,8]);
SIMD.Int32x4.load1(a, 0);
// Int32x4[1, 0, 0, 0]
SIMD.Int32x4.load2(a, 0);
// Int32x4[1, 2, 0, 0]
SIMD.Int32x4.load3(a, 0);
// Int32x4[1, 2, 3,0]
SIMD.%type%.store()
storeæ–¹æ³•ç”¨äºå°†ä¸€ä¸ªSIMDå€¼ï¼Œå†™å…¥ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ã€‚å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯äºŒè¿›åˆ¶æ•°ç»„ã€å¼€å§‹å†™å…¥çš„æ•°ç»„ä½ç½®ã€SIMDå€¼ã€‚å®ƒè¿”å›å†™å…¥å€¼ä»¥åçš„äºŒè¿›åˆ¶æ•°ç»„ã€‚

var t1 = new Int32Array(8);
var v1 = SIMD.Int32x4(1, 2, 3, 4);
SIMD.Int32x4.store(t1, 0, v1)
// Int32Array[1, 2, 3, 4, 0, 0, 0, 0]

var t2 = new Int32Array(8);
var v2 = SIMD.Int32x4(1, 2, 3, 4);
SIMD.Int32x4.store(t2, 2, v2)
// Int32Array[0, 0, 1, 2, 3, 4, 0, 0]
ä¸Šé¢ä»£ç ä¸­ï¼Œt1æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ï¼Œv1æ˜¯ä¸€ä¸ªSIMDå€¼ï¼Œåªæœ‰å››ä¸ªé€šé“ã€‚æ‰€ä»¥å†™å…¥t1ä»¥åï¼Œåªæœ‰å‰å››ä¸ªä½ç½®æœ‰å€¼ï¼Œåå››ä¸ªä½ç½®éƒ½æ˜¯0ã€‚è€Œt2æ˜¯ä»2å·ä½ç½®å¼€å§‹å†™å…¥ï¼Œæ‰€ä»¥å‰ä¸¤ä¸ªä½ç½®å’Œåä¸¤ä¸ªä½ç½®éƒ½æ˜¯0ã€‚

è¿™ä¸ªæ–¹æ³•è¿˜æœ‰ä¸‰ä¸ªå˜ç§store1()ã€store2()å’Œstore3()ï¼Œè¡¨ç¤ºåªå†™å…¥ä¸€ä¸ªé€šé“ã€äºŒä¸ªé€šé“å’Œä¸‰ä¸ªé€šé“çš„å€¼ã€‚

var tarray = new Int32Array(8);
var value = SIMD.Int32x4(1, 2, 3, 4);
SIMD.Int32x4.store1(tarray, 0, value);
// Int32Array[1, 0, 0, 0, 0, 0, 0, 0]
SIMD.%type%.splat()
splatæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„SIMDå€¼ï¼Œè¯¥å€¼çš„æ‰€æœ‰é€šé“éƒ½ä¼šè®¾æˆåŒä¸€ä¸ªé¢„å…ˆç»™å®šçš„å€¼ã€‚

SIMD.Float32x4.splat(3);
// Float32x4[3, 3, 3, 3]
SIMD.Float64x2.splat(3);
// Float64x2[3, 3]
å¦‚æœçœç•¥å‚æ•°ï¼Œæ‰€æœ‰æ•´æ•°å‹çš„SIMDå€¼éƒ½ä¼šè®¾å®š0ï¼Œæµ®ç‚¹å‹çš„SIMDå€¼éƒ½ä¼šè®¾æˆNaNã€‚

SIMD.%type%.swizzle()
swizzleæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„SIMDå€¼ï¼Œé‡æ–°æ’åˆ—åŸæœ‰çš„SIMDå€¼çš„é€šé“é¡ºåºã€‚

var t = SIMD.Float32x4(1, 2, 3, 4);
SIMD.Float32x4.swizzle(t, 1, 2, 0, 3);
// Float32x4[2,3,1,4]
ä¸Šé¢ä»£ç ä¸­ï¼Œswizzleæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŸæœ‰çš„SIMDå€¼ï¼Œåé¢çš„å‚æ•°å¯¹åº”å°†è¦è¿”å›çš„SIMDå€¼çš„å››ä¸ªé€šé“ã€‚å®ƒçš„æ„æ€æ˜¯æ–°çš„SIMDçš„å››ä¸ªé€šé“ï¼Œä¾æ¬¡æ˜¯åŸæ¥SIMDå€¼çš„1å·é€šé“ã€2å·é€šé“ã€0å·é€šé“ã€3å·é€šé“ã€‚ç”±äºSIMDå€¼æœ€å¤šå¯ä»¥æœ‰16ä¸ªé€šé“ï¼Œæ‰€ä»¥swizzleæ–¹æ³•é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°ä»¥å¤–ï¼Œæœ€å¤šè¿˜å¯ä»¥æ¥å—16ä¸ªå‚æ•°ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­ã€‚

var a = SIMD.Float32x4(1.0, 2.0, 3.0, 4.0);
// Float32x4[1.0, 2.0, 3.0, 4.0]

var b = SIMD.Float32x4.swizzle(a, 0, 0, 1, 1);
// Float32x4[1.0, 1.0, 2.0, 2.0]

var c = SIMD.Float32x4.swizzle(a, 3, 3, 3, 3);
// Float32x4[4.0, 4.0, 4.0, 4.0]

var d = SIMD.Float32x4.swizzle(a, 3, 2, 1, 0);
// Float32x4[4.0, 3.0, 2.0, 1.0]
SIMD.%type%.shuffle()
shuffleæ–¹æ³•ä»ä¸¤ä¸ªSIMDå€¼ä¹‹ä¸­å–å‡ºæŒ‡å®šé€šé“ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„SIMDå€¼ã€‚

var a = SIMD.Float32x4(1, 2, 3, 4);
var b = SIMD.Float32x4(5, 6, 7, 8);

SIMD.Float32x4.shuffle(a, b, 1, 5, 7, 2);
// Float32x4[2, 6, 8, 3]
ä¸Šé¢ä»£ç ä¸­ï¼Œaå’Œbä¸€å…±æœ‰8ä¸ªé€šé“ï¼Œä¾æ¬¡ç¼–å·ä¸º0åˆ°7ã€‚shuffleæ ¹æ®ç¼–å·ï¼Œå–å‡ºç›¸åº”çš„é€šé“ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„SIMDå€¼ã€‚

é™æ€æ–¹æ³•ï¼šæ¯”è¾ƒè¿ç®—
SIMD.%type%.equal()ï¼ŒSIMD.%type%.notEqual()
equalæ–¹æ³•ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªSIMDå€¼aå’Œbçš„æ¯ä¸€ä¸ªé€šé“ï¼Œæ ¹æ®ä¸¤è€…æ˜¯å¦ç²¾ç¡®ç›¸ç­‰ï¼ˆa === bï¼‰ï¼Œå¾—åˆ°ä¸€ä¸ªå¸ƒå°”å€¼ã€‚æœ€åï¼Œæ‰€æœ‰é€šé“çš„æ¯”è¾ƒç»“æœï¼Œç»„æˆä¸€ä¸ªæ–°çš„SIMDå€¼ï¼Œä½œä¸ºæ©ç è¿”å›ã€‚notEqualæ–¹æ³•åˆ™æ˜¯æ¯”è¾ƒä¸¤ä¸ªé€šé“æ˜¯å¦ä¸ç›¸ç­‰ï¼ˆa !== bï¼‰ã€‚

var a = SIMD.Float32x4(1, 2, 3, 9);
var b = SIMD.Float32x4(1, 4, 7, 9);

SIMD.Float32x4.equal(a,b)
// Bool32x4[true, false, false, true]

SIMD.Float32x4.notEqual(a,b);
// Bool32x4[false, true, true, false]
SIMD.%type%.greaterThan()ï¼ŒSIMD.%type%.greaterThanOrEqual()
greatThanæ–¹æ³•ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªSIMDå€¼aå’Œbçš„æ¯ä¸€ä¸ªé€šé“ï¼Œå¦‚æœåœ¨è¯¥é€šé“ä¸­ï¼Œaè¾ƒå¤§å°±å¾—åˆ°trueï¼Œå¦åˆ™å¾—åˆ°falseã€‚æœ€åï¼Œæ‰€æœ‰é€šé“çš„æ¯”è¾ƒç»“æœï¼Œç»„æˆä¸€ä¸ªæ–°çš„SIMDå€¼ï¼Œä½œä¸ºæ©ç è¿”å›ã€‚greaterThanOrEqualåˆ™æ˜¯æ¯”è¾ƒaæ˜¯å¦å¤§äºç­‰äºbã€‚

var a = SIMD.Float32x4(1, 6, 3, 11);
var b = SIMD.Float32x4(1, 4, 7, 9);

SIMD.Float32x4.greaterThan(a, b)
// Bool32x4[false, true, false, true]

SIMD.Float32x4.greaterThanOrEqual(a, b)
// Bool32x4[true, true, false, true]
SIMD.%type%.lessThan()ï¼ŒSIMD.%type%.lessThanOrEqual()
lessThanæ–¹æ³•ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªSIMDå€¼aå’Œbçš„æ¯ä¸€ä¸ªé€šé“ï¼Œå¦‚æœåœ¨è¯¥é€šé“ä¸­ï¼Œaè¾ƒå°å°±å¾—åˆ°trueï¼Œå¦åˆ™å¾—åˆ°falseã€‚æœ€åï¼Œæ‰€æœ‰é€šé“çš„æ¯”è¾ƒç»“æœï¼Œä¼šç»„æˆä¸€ä¸ªæ–°çš„SIMDå€¼ï¼Œä½œä¸ºæ©ç è¿”å›ã€‚lessThanOrEqualæ–¹æ³•åˆ™æ˜¯æ¯”è¾ƒaæ˜¯å¦ç­‰äºbã€‚

var a = SIMD.Float32x4(1, 2, 3, 11);
var b = SIMD.Float32x4(1, 4, 7, 9);

SIMD.Float32x4.lessThan(a, b)
// Bool32x4[false, true, true, false]

SIMD.Float32x4.lessThanOrEqual(a, b)
// Bool32x4[true, true, true, false]
SIMD.%type%.select()
selectæ–¹æ³•é€šè¿‡æ©ç ç”Ÿæˆä¸€ä¸ªæ–°çš„SIMDå€¼ã€‚å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯æ©ç å’Œä¸¤ä¸ªSIMDå€¼ã€‚

var a = SIMD.Float32x4(1, 2, 3, 4);
var b = SIMD.Float32x4(5, 6, 7, 8);

var mask = SIMD.Bool32x4(true, false, false, true);

SIMD.Float32x4.select(mask, a, b);
// Float32x4[1, 6, 7, 4]
ä¸Šé¢ä»£ç ä¸­ï¼Œselectæ–¹æ³•æ¥å—æ©ç å’Œä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ã€‚å½“æŸä¸ªé€šé“å¯¹åº”çš„æ©ç ä¸ºtrueæ—¶ï¼Œä¼šé€‰æ‹©ç¬¬ä¸€ä¸ªSIMDå€¼çš„å¯¹åº”é€šé“ï¼Œå¦åˆ™é€‰æ‹©ç¬¬äºŒä¸ªSIMDå€¼çš„å¯¹åº”é€šé“ã€‚

è¿™ä¸ªæ–¹æ³•é€šå¸¸ä¸æ¯”è¾ƒè¿ç®—ç¬¦ç»“åˆä½¿ç”¨ã€‚

var a = SIMD.Float32x4(0, 12, 3, 4);
var b = SIMD.Float32x4(0, 6, 7, 50);

var mask = SIMD.Float32x4.lessThan(a,b);
// Bool32x4[false, false, true, true]

var result = SIMD.Float32x4.select(mask, a, b);
// Float32x4[0, 6, 3, 4]
ä¸Šé¢ä»£ç ä¸­ï¼Œå…ˆé€šè¿‡lessThanæ–¹æ³•ç”Ÿæˆä¸€ä¸ªæ©ç ï¼Œç„¶åé€šè¿‡selectæ–¹æ³•ç”Ÿæˆä¸€ä¸ªç”±æ¯ä¸ªé€šé“çš„è¾ƒå°å€¼ç»„æˆçš„æ–°çš„SIMDå€¼ã€‚

SIMD.%BooleanType%.allTrue()ï¼ŒSIMD.%BooleanType%.anyTrue()
allTrueæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥SIMDå€¼çš„æ‰€æœ‰é€šé“æ˜¯å¦éƒ½ä¸ºtrueã€‚

var a = SIMD.Bool32x4(true, true, true, true);
var b = SIMD.Bool32x4(true, false, true, true);

SIMD.Bool32x4.allTrue(a); // true
SIMD.Bool32x4.allTrue(b); // false
anyTrueæ–¹æ³•åˆ™æ˜¯åªè¦æœ‰ä¸€ä¸ªé€šé“ä¸ºtrueï¼Œå°±è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚

var a = SIMD.Bool32x4(false, false, false, false);
var b = SIMD.Bool32x4(false, false, true, false);

SIMD.Bool32x4.anyTrue(a); // false
SIMD.Bool32x4.anyTrue(b); // true
æ³¨æ„ï¼Œåªæœ‰å››ç§å¸ƒå°”å€¼æ•°æ®ç±»å‹ï¼ˆBool32x4ã€Bool16x8ã€Bool8x16ã€Bool64x2ï¼‰æ‰æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

è¿™ä¸¤ä¸ªæ–¹æ³•é€šå¸¸ä¸æ¯”è¾ƒè¿ç®—ç¬¦ç»“åˆä½¿ç”¨ã€‚

var ax4    = SIMD.Float32x4(1.0, 2.0, 3.0, 4.0);
var bx4    = SIMD.Float32x4(0.0, 6.0, 7.0, 8.0);
var ix4    = SIMD.Float32x4.lessThan(ax4, bx4);
var b1     = SIMD.Int32x4.allTrue(ix4); // false
var b2     = SIMD.Int32x4.anyTrue(ix4); // true
SIMD.%type%.min()ï¼ŒSIMD.%type%.minNum()
minæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†ä¸¤è€…çš„å¯¹åº”é€šé“çš„è¾ƒå°å€¼ï¼Œç»„æˆä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(-1, -2, 3, 5.2);
var b = SIMD.Float32x4(0, -4, 6, 5.5);
SIMD.Float32x4.min(a, b);
// Float32x4[-1, -4, 3, 5.2]
å¦‚æœæœ‰ä¸€ä¸ªé€šé“çš„å€¼æ˜¯NaNï¼Œåˆ™ä¼šä¼˜å…ˆè¿”å›NaNã€‚

var c = SIMD.Float64x2(NaN, Infinity)
var d = SIMD.Float64x2(1337, 42);
SIMD.Float64x2.min(c, d);
// Float64x2[NaN, 42]
minNumæ–¹æ³•ä¸minçš„ä½œç”¨ä¸€æ¨¡ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å¦‚æœæœ‰ä¸€ä¸ªé€šé“çš„å€¼æ˜¯NaNï¼Œåˆ™ä¼šä¼˜å…ˆè¿”å›å¦ä¸€ä¸ªé€šé“çš„å€¼ã€‚

var ax4 = SIMD.Float32x4(1.0, 2.0, NaN, NaN);
var bx4 = SIMD.Float32x4(2.0, 1.0, 3.0, NaN);
var cx4 = SIMD.Float32x4.min(ax4, bx4);
// Float32x4[1.0, 1.0, NaN, NaN]
var dx4 = SIMD.Float32x4.minNum(ax4, bx4);
// Float32x4[1.0, 1.0, 3.0, NaN]
SIMD.%type%.max()ï¼ŒSIMD.%type%.maxNum()
maxæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œå°†ä¸¤è€…çš„å¯¹åº”é€šé“çš„è¾ƒå¤§å€¼ï¼Œç»„æˆä¸€ä¸ªæ–°çš„SIMDå€¼è¿”å›ã€‚

var a = SIMD.Float32x4(-1, -2, 3, 5.2);
var b = SIMD.Float32x4(0, -4, 6, 5.5);
SIMD.Float32x4.max(a, b);
// Float32x4[0, -2, 6, 5.5]
å¦‚æœæœ‰ä¸€ä¸ªé€šé“çš„å€¼æ˜¯NaNï¼Œåˆ™ä¼šä¼˜å…ˆè¿”å›NaNã€‚

var c = SIMD.Float64x2(NaN, Infinity)
var d = SIMD.Float64x2(1337, 42);
SIMD.Float64x2.max(c, d)
// Float64x2[NaN, Infinity]
maxNumæ–¹æ³•ä¸maxçš„ä½œç”¨ä¸€æ¨¡ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å¦‚æœæœ‰ä¸€ä¸ªé€šé“çš„å€¼æ˜¯NaNï¼Œåˆ™ä¼šä¼˜å…ˆè¿”å›å¦ä¸€ä¸ªé€šé“çš„å€¼ã€‚

var c = SIMD.Float64x2(NaN, Infinity)
var d = SIMD.Float64x2(1337, 42);
SIMD.Float64x2.maxNum(c, d)
// Float64x2[1337, Infinity]
é™æ€æ–¹æ³•ï¼šä½è¿ç®—
SIMD.%type%.and()ï¼ŒSIMD.%type%.or()ï¼ŒSIMD.%type%.xor()ï¼ŒSIMD.%type%.not()
andæ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸¤è€…å¯¹åº”çš„é€šé“è¿›è¡ŒäºŒè¿›åˆ¶ANDè¿ç®—ï¼ˆ&ï¼‰åå¾—åˆ°çš„æ–°çš„SIMDå€¼ã€‚

var a = SIMD.Int32x4(1, 2, 4, 8);
var b = SIMD.Int32x4(5, 5, 5, 5);
SIMD.Int32x4.and(a, b)
// Int32x4[1, 0, 4, 0]
ä¸Šé¢ä»£ç ä¸­ï¼Œä»¥é€šé“0ä¸ºä¾‹ï¼Œ1çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯0001ï¼Œ5çš„äºŒè¿›åˆ¶å½¢å¼æ˜¯01001ï¼Œæ‰€ä»¥è¿›è¡ŒANDè¿ç®—ä»¥åï¼Œå¾—åˆ°0001ã€‚

oræ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸¤è€…å¯¹åº”çš„é€šé“è¿›è¡ŒäºŒè¿›åˆ¶ORè¿ç®—ï¼ˆ|ï¼‰åå¾—åˆ°çš„æ–°çš„SIMDå€¼ã€‚

var a = SIMD.Int32x4(1, 2, 4, 8);
var b = SIMD.Int32x4(5, 5, 5, 5);
SIMD.Int32x4.or(a, b)
// Int32x4[5, 7, 5, 13]
xoræ–¹æ³•æ¥å—ä¸¤ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸¤è€…å¯¹åº”çš„é€šé“è¿›è¡ŒäºŒè¿›åˆ¶â€å¼‚æˆ–â€œè¿ç®—ï¼ˆ^ï¼‰åå¾—åˆ°çš„æ–°çš„SIMDå€¼ã€‚

var a = SIMD.Int32x4(1, 2, 4, 8);
var b = SIMD.Int32x4(5, 5, 5, 5);
SIMD.Int32x4.xor(a, b)
// Int32x4[4, 7, 1, 13]
notæ–¹æ³•æ¥å—ä¸€ä¸ªSIMDå€¼ä½œä¸ºå‚æ•°ï¼Œè¿”å›æ¯ä¸ªé€šé“è¿›è¡ŒäºŒè¿›åˆ¶â€å¦â€œè¿ç®—ï¼ˆ~ï¼‰åå¾—åˆ°çš„æ–°çš„SIMDå€¼ã€‚

var a = SIMD.Int32x4(1, 2, 4, 8);
SIMD.Int32x4.not(a)
// Int32x4[-2, -3, -5, -9]
ä¸Šé¢ä»£ç ä¸­ï¼Œ1çš„å¦è¿ç®—ä¹‹æ‰€ä»¥å¾—åˆ°-2ï¼Œæ˜¯å› ä¸ºåœ¨è®¡ç®—æœºå†…éƒ¨ï¼Œè´Ÿæ•°é‡‡ç”¨â€2çš„è¡¥ç â€œè¿™ç§å½¢å¼è¿›è¡Œè¡¨ç¤ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´æ•°nçš„è´Ÿæ•°å½¢å¼-nï¼Œæ˜¯å¯¹æ¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½å–åä»¥åï¼Œå†åŠ ä¸Š1ã€‚å› æ­¤ï¼Œç›´æ¥å–åå°±ç›¸å½“äºè´Ÿæ•°å½¢å¼å†å‡å»1ï¼Œæ¯”å¦‚1çš„è´Ÿæ•°å½¢å¼æ˜¯-1ï¼Œå†å‡å»1ï¼Œå°±å¾—åˆ°äº†-2ã€‚

é™æ€æ–¹æ³•ï¼šæ•°æ®ç±»å‹è½¬æ¢
SIMDæä¾›ä»¥ä¸‹æ–¹æ³•ï¼Œç”¨æ¥å°†ä¸€ç§æ•°æ®ç±»å‹è½¬ä¸ºå¦ä¸€ç§æ•°æ®ç±»å‹ã€‚

SIMD.%type%.fromFloat32x4()
SIMD.%type%.fromFloat32x4Bits()
SIMD.%type%.fromFloat64x2Bits()
SIMD.%type%.fromInt32x4()
SIMD.%type%.fromInt32x4Bits()
SIMD.%type%.fromInt16x8Bits()
SIMD.%type%.fromInt8x16Bits()
SIMD.%type%.fromUint32x4()
SIMD.%type%.fromUint32x4Bits()
SIMD.%type%.fromUint16x8Bits()
SIMD.%type%.fromUint8x16Bits()
å¸¦æœ‰Bitsåç¼€çš„æ–¹æ³•ï¼Œä¼šåŸå°ä¸åŠ¨åœ°å°†äºŒè¿›åˆ¶ä½æ‹·è´åˆ°æ–°çš„æ•°æ®ç±»å‹ï¼›ä¸å¸¦åç¼€çš„æ–¹æ³•ï¼Œåˆ™ä¼šè¿›è¡Œæ•°æ®ç±»å‹è½¬æ¢ã€‚

var t = SIMD.Float32x4(1.0, 2.0, 3.0, 4.0);
SIMD.Int32x4.fromFloat32x4(t);
// Int32x4[1, 2, 3, 4]

SIMD.Int32x4.fromFloat32x4Bits(t);
// Int32x4[1065353216, 1073741824, 1077936128, 1082130432]
ä¸Šé¢ä»£ç ä¸­ï¼ŒfromFloat32x4æ˜¯å°†æµ®ç‚¹æ•°è½¬ä¸ºæ•´æ•°ï¼Œç„¶åå­˜å…¥æ–°çš„æ•°æ®ç±»å‹ï¼›fromFloat32x4Bitsåˆ™æ˜¯å°†äºŒè¿›åˆ¶ä½åŸå°ä¸åŠ¨åœ°æ‹·è´è¿›å…¥æ–°çš„æ•°æ®ç±»å‹ï¼Œç„¶åè¿›è¡Œè§£è¯»ã€‚

Bitsåç¼€çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥ç”¨äºé€šé“æ•°ç›®ä¸å¯¹ç­‰çš„æ‹·è´ã€‚

var t = SIMD.Float32x4(1.0, 2.0, 3.0, 4.0);
SIMD.Int16x8.fromFloat32x4Bits(t);
// Int16x8[0, 16256, 0, 16384, 0, 16448, 0, 16512]
ä¸Šé¢ä»£ç ä¸­ï¼ŒåŸå§‹SIMDå€¼tæ˜¯4é€šé“çš„ï¼Œè€Œç›®æ ‡å€¼æ˜¯8é€šé“çš„ã€‚

å¦‚æœæ•°æ®è½¬æ¢æ—¶ï¼ŒåŸé€šé“çš„æ•°æ®å¤§å°ï¼Œè¶…è¿‡äº†ç›®æ ‡é€šé“çš„æœ€å¤§å®½åº¦ï¼Œå°±ä¼šæŠ¥é”™ã€‚

å®ä¾‹æ–¹æ³•
SIMD.%type%.prototype.toString()
toStringæ–¹æ³•è¿”å›ä¸€ä¸ªSIMDå€¼çš„å­—ç¬¦ä¸²å½¢å¼ã€‚

var a = SIMD.Float32x4(11, 22, 33, 44);
a.toString() // "SIMD.Float32x4(11, 22, 33, 44)"
å®ä¾‹ï¼šæ±‚å¹³å‡å€¼
æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œè®¡ç®—nä¸ªå€¼çš„å¹³å‡å€¼ï¼Œéœ€è¦è¿ç®—næ¬¡ã€‚

function average(list) {
  var n = list.length;
  var sum = 0.0;
  for (var i = 0; i < n; i++) {
    sum += list[i];
  }
  return sum / n;
}
ä½¿ç”¨SIMDï¼Œå¯ä»¥å°†è®¡ç®—æ¬¡æ•°å‡å°‘åˆ°næ¬¡çš„å››åˆ†ä¹‹ä¸€ã€‚

function average(list) {
  var n = list.length;
  var sum = SIMD.Float32x4.splat(0.0);
  for (var i = 0; i < n; i += 4) {
    sum = SIMD.Float32x4.add(
      sum,
      SIMD.Float32x4.load(list, i)
    );
  }
  var total = SIMD.Float32x4.extractLane(sum, 0) +
              SIMD.Float32x4.extractLane(sum, 1) +
              SIMD.Float32x4.extractLane(sum, 2) +
              SIMD.Float32x4.extractLane(sum, 3);
  return total / n;
}
ä¸Šé¢ä»£ç å…ˆæ˜¯æ¯éš”å››ä½ï¼Œå°†æ‰€æœ‰çš„å€¼è¯»å…¥ä¸€ä¸ªSIMDï¼Œç„¶åç«‹åˆ»ç´¯åŠ ã€‚ç„¶åï¼Œå¾—åˆ°ç´¯åŠ å€¼å››ä¸ªé€šé“çš„æ€»å’Œï¼Œå†é™¤ä»¥nå°±å¯ä»¥äº†ã€‚



